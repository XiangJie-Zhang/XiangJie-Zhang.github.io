<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>HBase介绍 | zxj</title><meta name="keywords" content="Hadoop"><meta name="author" content="Xiangjie"><meta name="copyright" content="Xiangjie"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="HBase简介什么是HBaseHBase的原型是Google的BigTable论文，受到了该论文思想的启发，目前作为Hadoop的子项目来开发维护，用于支持结构化的数据存储。 HBase是一个高可靠性、高性能、面向列、可伸缩的分布式存储系统，利用HBASE技术可在廉价PC Server上搭建起大规模结构化存储集群。  高可靠性：分布式有崩溃恢复，不是直接挂掉没有后续的 高性能：通过水平拆表、垂直拆">
<meta property="og:type" content="article">
<meta property="og:title" content="HBase介绍">
<meta property="og:url" content="https://awslzhang.top/2020/07/08/Hbase%E4%BB%8B%E7%BB%8D/index.html">
<meta property="og:site_name" content="zxj">
<meta property="og:description" content="HBase简介什么是HBaseHBase的原型是Google的BigTable论文，受到了该论文思想的启发，目前作为Hadoop的子项目来开发维护，用于支持结构化的数据存储。 HBase是一个高可靠性、高性能、面向列、可伸缩的分布式存储系统，利用HBASE技术可在廉价PC Server上搭建起大规模结构化存储集群。  高可靠性：分布式有崩溃恢复，不是直接挂掉没有后续的 高性能：通过水平拆表、垂直拆">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Hbase-cover.png">
<meta property="article:published_time" content="2020-07-08T01:06:51.000Z">
<meta property="article:modified_time" content="2021-01-01T05:49:59.942Z">
<meta property="article:author" content="Xiangjie">
<meta property="article:tag" content="Hadoop">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Hbase-cover.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://awslzhang.top/2020/07/08/Hbase%E4%BB%8B%E7%BB%8D/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Xiangjie","link":"链接: ","source":"来源: zxj","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}

// https://stackoverflow.com/questions/16839698/jquery-getscript-alternative-in-native-javascript
const getScript = url => new Promise((resolve, reject) => {
  const script = document.createElement('script')
  script.src = url
  script.async = true
  script.onerror = reject
  script.onload = script.onreadystatechange = function() {
    const loadState = this.readyState
    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
    script.onload = script.onreadystatechange = null
    resolve()
  }
  document.head.appendChild(script)
})</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2021-01-01 13:49:59'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.0.2"><link rel="alternate" href="/atom.xml" title="zxj" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/null" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">85</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">43</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">25</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 目录</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Hbase-cover.png)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">zxj</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 目录</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">HBase介绍</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-07-08T01:06:51.000Z" title="发表于 2020-07-08 09:06:51">2020-07-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-01-01T05:49:59.942Z" title="更新于 2021-01-01 13:49:59">2021-01-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">15.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>59分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="HBase简介"><a href="#HBase简介" class="headerlink" title="HBase简介"></a>HBase简介</h1><h2 id="什么是HBase"><a href="#什么是HBase" class="headerlink" title="什么是HBase"></a>什么是HBase</h2><p>HBase的原型是Google的BigTable论文，受到了该论文思想的启发，目前作为Hadoop的子项目来开发维护，用于支持结构化的数据存储。</p>
<p><strong>HBase</strong>是一个<strong>高可靠性、高性能、面向列、可伸缩的分布式存储系统</strong>，利用HBASE技术可在廉价PC Server上搭建起大规模结构化存储集群。</p>
<ul>
<li>高可靠性：分布式有崩溃恢复，不是直接挂掉没有后续的</li>
<li>高性能：通过水平拆表、垂直拆表、动态列来提高性能</li>
<li>面向列：列式存储</li>
<li>可伸缩的：处理节点可动态增减</li>
</ul>
<hr>
<p>HBase是Google Bigtable的开源实现，但是也有很多不同之处。比如：Google Bigtable利用GFS作为其文件存储系统，HBase利用Hadoop HDFS作为其文件存储系统；Google运行MAPREDUCE来处理Bigtable中的海量数据，HBase同样利用Hadoop MapReduce来处理HBase中的海量数据；Google Bigtable利用Chubby作为协同服务，HBase利用Zookeeper作为对应。</p>
<h2 id="HBase特点"><a href="#HBase特点" class="headerlink" title="HBase特点"></a>HBase特点</h2><ol>
<li><p>海量存储</p>
<p>Hbase适合存储PB级别的海量数据，在PB级别的数据以及采用廉价PC存储的情况下，能在几十到百毫秒内返回数据。这与Hbase的极易扩展性息息相关。正式因为Hbase良好的扩展性，才为海量数据的存储提供了便利。</p>
</li>
<li><p><strong>列式存储</strong></p>
<p>这里的列式存储其实说的是<strong>列族(ColumnFamily)存储</strong>，Hbase是根据列族来存储数据的。列族下面可以有非常多的列，列族在创建表的时候就必须指定。</p>
</li>
<li><p><strong>极易扩展</strong></p>
<p>Hbase的扩展性主要体现在两个方面，一个是基于上层处理能力(RegionServer,处理节点)的扩展，一个是基于存储的扩展(HDFS)。<br> 通过横向添加RegionSever的机器，进行水平扩展，提升Hbase上层的处理能力，提升Hbsae服务更多Region的能力。</p>
</li>
<li><p><strong>高并发</strong></p>
<p>由于目前大部分使用Hbase的架构，都是采用的廉价PC，因此单个IO的延迟其实并不小，一般在几十到上百ms之间。这里说的高并发，主要是在并发的情况下，Hbase的单个IO延迟下降并不多。能获得高并发、低延迟的服务。</p>
</li>
<li><p><strong>稀疏</strong></p>
<p>稀疏主要是针对Hbase列的灵活性，在列族中，你可以指定任意多的列，在列数据为空的情况下，是<strong>不会占用存储空间的</strong>。</p>
</li>
</ol>
<h2 id="为什么提出HBase"><a href="#为什么提出HBase" class="headerlink" title="为什么提出HBase"></a>为什么提出HBase</h2><p><code>HBase</code>是面向列簇的<strong>分布式存储数据库</strong>。它不同于Kafka、Flume，它们是主要作用传输的，数据也只是临时存储，而<code>HBase</code>则是真正的存储数据。但它既然是存储数据库，那它有什么区别于关系型数据库(例：MySQL)和分布式文件系统HDFS呢？</p>
<hr>
<p><strong>HDFS</strong></p>
<p>HDFS存放文件<strong>杂乱无章，没有结构</strong>上传什么就存什么，无法快速高效的定位数据。所以它只适合做存储，而不是数据库。</p>
<p><strong>MySQL</strong></p>
<p>一句话，就限制了它与HBase的抗衡。MySQL<strong>存储数据有限</strong>，虽然有MySQL集群但是它的扩展性没有HBase好，不能做到成百上千的节点。而HBase的扩展性是基于HDFS的，HBase可以做到。</p>
<p>MySQL数据有限，它有两个引擎：<code>InnoDB</code>、<code>MyIsam</code></p>
<ul>
<li><code>InnoDB</code>：表空间(可认为是全表)最大64TB</li>
<li><code>MyIsam</code>：理论单表最大256TB</li>
</ul>
<p>但是这样也没有HBase存储的多，HBase是PB级别数据存储数据库。PB=1024TB</p>
<h3 id="MySQL优化🔺"><a href="#MySQL优化🔺" class="headerlink" title="MySQL优化🔺"></a>MySQL优化🔺</h3><p>优化，如果<strong>不考虑MySQL的存储数据量的因素</strong>，那么它对于大数据量的查询该怎么优化呢？</p>
<p>首先，指出MySQL的几个问题？宽表、高表、列添加等…</p>
<hr>
<p><strong>宽表</strong></p>
<p>如果一张表的列过多，会影响MySQL的查询速率，因为MySQL是行式存储数据库，<font color="pink">查询时会把每行数据全部拿出，在对比查询的列，舍去其他列</font>，这样速率慢。这样的表称为<code>宽表</code>。</p>
<p><strong>解决方法</strong></p>
<p><strong>垂直拆分数据库表，将多个列的数据库表拆分成多个列不多的数据库表。</strong>就是将一张表垂直切分成多块，并且要保证每块(切分后的表)之间的联系。这里举个例子，只为了展示垂直切分，没有什么实际意义：</p>
<p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/HBase-vertical_spilt_example.png" alt="HBase-vertical_spilt_example"></p>
<hr>
<p><strong>高表</strong></p>
<p>如果一张数据库表有太多的行，而我们正常写SQL查询时指定<code>where</code>条件，先不考虑索引，<font color='yellow'>它会全表扫描来匹配第一个条件，然后对第一个条件的结果进行全部扫描进行第二个条件的匹配，以此类推…。</font>这样也会降低查询效率。</p>
<p><strong>解决方法</strong></p>
<p>水平拆分数据库表，假设一个表有10w数据，将它水平截断为2张5w数据的表，2张表的列是一致的。它们公共组成之前表的全部数据。</p>
<p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/HBase-horizontally_spilt_example.png" alt="HBase-horizontally_spilt_example"></p>
<hr>
<p><strong>动态列问题</strong></p>
<p>一个已经有数据的表如果要增加一个新的列的话，在SQL中是很容易的直接<code>alert</code>就可以，但是在MySQL的实现中是费劲的。因为MySQL是行式存储数据库，它的表在磁盘中每一行都紧凑在一起，如果要添加新的一列，那么它需要定位到每一行的结尾来开辟一个列的位置。下面假设文件是这样存储的，然后以;分割，这里只是假设，只为展示：</p>
<p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/HBase-dy-colums.png" alt="HBase-dy-colums"></p>
<p><strong>这里需要找到每一行的结尾，添加新列，效率挺慢的；</strong></p>
<p>然后，<font color="yellow">这种添加列的行为是不能更改以前数据的新列，所以这个新列只对新数据有效</font>，新数据插入时指定。</p>
<p>总结：使用alert添加新列的缺点</p>
<ul>
<li>效率不高</li>
<li>影响数据结构，只对新数据有效</li>
</ul>
<p><strong>解决办法</strong></p>
<p>使用动态列，将某些不确定的列，在数据结构中只放一列，列中存储json，当想扩展列时，而此列又不是所有人都需要时，只需要修改需要修改的行的这一列中json的内容，不需要添加列。<font color="pink">这样添加列灵活，但是修改不方便。</font></p>
<p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/HBase-dy-colums1.png" alt="HBase-dy-colums1"></p>
<hr>
<h4 id="同时优化上述三个问题"><a href="#同时优化上述三个问题" class="headerlink" title="同时优化上述三个问题"></a>同时优化上述三个问题</h4><ol>
<li>首先因为宽表，直接把表拆分为table1,talbe2</li>
<li>又因为列的扩展(添加列)，所以表中存数据时使用json存数据放在一列中，如果想增加列，直接修改json的属性</li>
<li>又因为高表，我们又需要将table1,table2分别水平分为table1-row1,table1-row2,table2-row1,table2-row2</li>
</ol>
<p><font color="yellow">但是，数据量更大时，还是慢。</font>我们可以通过增加缓存来加快查询。</p>
<p>插入数据时，我们也需要使用到cache直接返回结果，而由一些机制自动的把数据写入表中。我们查询刚插入的数据时，可以直接从cache中查询，这样很快。</p>
<p><font color="yellow">又因为我们使用了cache，就有宕机数据丢失的风险。</font>我们在写入cache时，还需要将数据预写数据到日志，那既然要预写到日志中和写到表中有什么区别吗？写入到表需要按照格式，样式按条插入，慢；写入到日志没有格式，结构直接将数据顺序写到日志(顺序写也不慢的)。这样，当节点挂掉，这个cache数据丢失的时候，会根据日志来恢复数据。</p>
<p><strong>最后优化为</strong></p>
<p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/HBase_principle.png" alt="HBase_principle"></p>
<p><strong><font color="red">ps：这跟HBase的原理相似。</font></strong></p>
<h3 id="MySQL与HBase"><a href="#MySQL与HBase" class="headerlink" title="MySQL与HBase"></a>MySQL与HBase</h3><p>mysql行式存储数据库，每行放在一起；它注重于数据本身，查询数据直接显示数据。</p>
<p>HBase列式存储数据库，每列放在一起；它注重于数据统计、分析。</p>
<p>例如，如果对一列进行分析求和。</p>
<p>在MYSQL中需要通过取出所有的行(行式存储，列的存储不连续)，得到这一列求和</p>
<p>在HBase中直接找到这一列(列的存储是连续的)，取出全部，不需要取出其他字段，直接运算。</p>
<h1 id="HBase结构🔺"><a href="#HBase结构🔺" class="headerlink" title="HBase结构🔺"></a>HBase结构🔺</h1><p>其实上面所说的MySQL优化和HBase结构已经差不多了。</p>
<p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/HBase-jiagou.png" alt="HBase-jiagou"></p>
<ul>
<li>一个<code>HRegionServer</code>是一个HBase节点，<code>HRegionServer</code>可以包含多个<code>HRegion</code>，它实际上就是一个分区</li>
<li><code>HRegion</code>中可以包含多个<code>Store</code>，它是一个列簇<code>Colum Family</code>一个的，一一对应</li>
<li><strong><code>HRegion</code>中还包含一块<code>block cache</code>，是存放读数据的内容的，下次读相同的数据，可以查询这里，加快速率</strong></li>
<li>其中<code>Mem Store</code>是在<code>Sotre</code>中的，又称为写缓存。写入数据时会将写的数据缓存下来。</li>
<li><code>HFile</code>是要写入HDFS的形式</li>
<li><code>HLog</code>又称为<code>Write Ahead Log</code>，WAL预写日志；在写入数据时同时写入<code>HLog</code>、<code>Mem Store</code>才算写入成功；它是一个<code>HRegionServer</code>有一个</li>
<li><code>HLog</code>、<code>HFile</code>是写入到HDFS的文件</li>
</ul>
<hr>
<p><strong>存在位置</strong></p>
<ul>
<li>Hlog、Write Ahead Log存在一RegionServer中</li>
<li>block cache、写缓存在于Region</li>
<li>mem cache存在于store</li>
</ul>
<p>从图中可以看出Hbase是由Client、Zookeeper、Master、HRegionServer、HDFS等几个组件组成，下面来介绍一下几个组件的相关功能：</p>
<h2 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h2><p>Client包含了访问Hbase的接口，另外Client还维护了对应的cache来加速Hbase的访问，比如cache的<code>META</code>元数据的信息。</p>
<h2 id="Zookeeper"><a href="#Zookeeper" class="headerlink" title="Zookeeper"></a><strong>Zookeeper</strong></h2><p>HBase通过Zookeeper来做master的高可用、RegionServer的监控、元数据的入口以及集群配置的维护等工作。具体工作如下：</p>
<ol>
<li><p>通过Zoopkeeper来保证集群中只有1个master在运行，如果master异常，会通过竞争机制产生新的master提供服务</p>
</li>
<li><p>通过Zoopkeeper来监控RegionServer的状态，当RegionSevrer有异常的时候，通过回调的形式通知Master RegionServer上下线的信息</p>
</li>
<li><p>通过Zoopkeeper存储元数据的统一入口地址</p>
</li>
</ol>
<h2 id="HMaster"><a href="#HMaster" class="headerlink" title="HMaster"></a>HMaster</h2><p>master节点的主要职责如下：</p>
<ol>
<li>为RegionServer分配Region</li>
<li>维护整个集群的负载均衡</li>
<li>通过Zookeeper发布自己的位置给客户端</li>
<li>维护集群的元数据信息</li>
<li> 发现失效的Region，并将失效的Region分配到正常的RegionServer上</li>
<li> 处理RegionServer故障转移</li>
</ol>
<h2 id="HRegionServer"><a href="#HRegionServer" class="headerlink" title="HRegionServer"></a><strong>HRegionServer</strong></h2><p><font color="red"><strong>HregionServer直接对接用户的读写请求</strong></font>，是真正的“干活”的节点。它的功能概括如下：</p>
<ol>
<li>管理master为其分配的Region</li>
<li>负责存储HBase的实际数据</li>
<li>处理来自客户端的读写请求</li>
<li>负责和底层HDFS的交互，存储数据到HDFS</li>
<li>负责Region变大以后的拆分</li>
<li>负责<code>Storefile</code>的合并工作</li>
<li>维护Hlog</li>
</ol>
<h2 id="其他组件"><a href="#其他组件" class="headerlink" title="其他组件"></a>其他组件</h2><h3 id="Write-Ahead-logs"><a href="#Write-Ahead-logs" class="headerlink" title="Write-Ahead logs"></a>Write-Ahead logs</h3><p>又称为<code>HLog</code>，HBase的修改记录，当对HBase读写数据的时候，数据不是直接写进磁盘，它会在内存中保留一段时间（时间以及数据量阈值可以设定）。但把数据保存在内存中可能有更高的概率引起数据丢失，为了解决这个问题，数据会先写在一个叫做Write-Ahead logfile的文件中，然后再写入内存中。所以在系统出现故障的时候，数据可以通过这个日志文件重建。</p>
<p>它是一个<code>HRegionServer</code>有一个</p>
<h3 id="Region"><a href="#Region" class="headerlink" title="Region"></a>Region</h3><p>Hbase表的分片<strong>，HBase表会根据RowKey值被切分成不同的region存储在RegionServer中</strong>，在一个RegionServer中可以有多个不同的region。</p>
<p>既然是表的分片，所以表和region的关系是一对多。</p>
<h3 id="Store"><a href="#Store" class="headerlink" title="Store"></a>Store</h3><p>一个Store对应HBase表中的一个列族(列簇， Column Family)。</p>
<h3 id="MemStore"><a href="#MemStore" class="headerlink" title="MemStore"></a>MemStore</h3><p>存在于每个<code>Store</code>中又称写内存，顾名思义，就是内存存储，位于内存中，用来保存当前的数据操作，所以当数据保存在WAL(HLog)中之后，RegsionServer会在内存中存储键值对。</p>
<h3 id="HFile"><a href="#HFile" class="headerlink" title="HFile"></a>HFile</h3><p>这是在磁盘上保存原始数据的实际的物理文件，是实际的存储文件。StoreFile是以Hfile的形式存储在HDFS的。</p>
<h1 id="HBase数据结构🔺"><a href="#HBase数据结构🔺" class="headerlink" title="HBase数据结构🔺"></a>HBase数据结构🔺</h1><h2 id="rowkey"><a href="#rowkey" class="headerlink" title="rowkey"></a>rowkey</h2><p>rowkey是一行数据的标记，如果一个表有多个列簇，每个列簇存在于不同的store中，rowkey就是关联不同列簇中的数据的关联关系，通过列簇能查询到这一条记录的所有列簇的值。</p>
<p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/HBase-rowkey.png" alt="HBase-rowkey"></p>
<p>与nosql数据库们一样,RowKey是用来检索记录的主键。访问HBASE table中的行，只有三种方式：</p>
<ol>
<li>通过单个RowKey访问(get)</li>
<li>通过RowKey的range（正则）(like)</li>
<li>全表扫描(scan)</li>
</ol>
<p>RowKey行键 (RowKey)可以是<strong>任意字符串</strong>(最大长度是64KB，实际应用中长度一般为 10-100bytes)，在HBASE内部，RowKey保存为字节数组。存储时，<strong>数据按照RowKey的字典序(byte order)排序存储</strong>。设计RowKey时，要充分排序存储这个特性，将经常一起读取的行存储放到一起。(位置相关性)</p>
<p><strong>rowkey存储为字节数组，因为它可以压缩且压缩比例达。</strong></p>
<h2 id="Colum-Family"><a href="#Colum-Family" class="headerlink" title="Colum Family"></a>Colum Family</h2><p>列族：HBASE表中的每个列，都归属于某个列族。列族是表的schema的一部 分(而列不是)，必须在使用表之前定义。列名都以列族作为前缀。例如 courses:history，courses:math都属于courses 这个列族。</p>
<h2 id="Cell"><a href="#Cell" class="headerlink" title="Cell"></a>Cell</h2><p>由{rowkey, column Family:columu, version} 唯一确定的单元。cell中的数据是没有类型的，全部是字节码形式存贮。</p>
<p>关键字：无类型、字节码</p>
<h2 id="Time-Stamp"><a href="#Time-Stamp" class="headerlink" title="Time Stamp"></a>Time Stamp</h2><p>HBASE 中通过rowkey和columns确定的为一个存贮单元称为cell。每个 cell都保存 着同一份数据的多个版本。版本通过时间戳来索引。时间戳的类型是 64位整型。时间戳可以由HBASE(在数据写入时自动 )赋值，此时时间戳是精确到毫秒 的当前系统时间。时间戳也可以由客户显式赋值。如果应用程序要避免数据版 本冲突，就必须自己生成具有唯一性的时间戳。每个 cell中，不同版本的数据按照时间倒序排序，即最新的数据排在最前面。</p>
<p>为了避免数据存在过多版本造成的的管理 (包括存贮和索引)负担，HBASE提供 了两种数据版本回收方式。一是保存数据的最后n个版本，二是保存最近一段 时间内的版本（比如最近七天）。用户可以针对每个列族进行设置。</p>
<h2 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/HBase-namespace.png" alt="HBase-namespace"></p>
<ol>
<li><strong>Table</strong>：表，所有的表都是命名空间的成员，即表必属于某个命名空间，如果没有指定，则在default默认的命名空间中。</li>
<li><strong>RegionServer group</strong>：一个命名空间包含了默认的RegionServer Group。</li>
<li><strong>Permission</strong>：权限，命名空间能够让我们来定义访问控制列表ACL（Access Control List）。例如，创建表，读取表，删除，更新等等操作。</li>
<li><strong>Quota：</strong>限额，可以强制一个命名空间可包含的region的数量。</li>
</ol>
<h1 id="HBase原理🔺"><a href="#HBase原理🔺" class="headerlink" title="HBase原理🔺"></a>HBase原理🔺</h1><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/HBase-jiagou_my.png" alt="HBase-jiagou_my"></p>
<h2 id="读流程"><a href="#读流程" class="headerlink" title="读流程"></a>读流程</h2><p>client如果想读取数据例如<code>get &#39;student&#39;,&#39;1001&#39;</code>，因为HBase是分布式存储，每个地方存放的数据都不相同，如果想读数据，<strong>就先必须知道想要获取数据的Region在哪？</strong>其实在HBase中有一个内置的命名空间<code>hbase</code>这里面存放着一张<code>meta</code>的表，它存储者各个表的元数据，我们可以通过这张表得到我们要查询的表存储在的服务器、Region。<strong>所以如果我们想要获取数据的Region位置，就必须先知道<code>hbase</code>的<code>meta</code>表在哪，通过<code>meta</code>找到<code>student</code>的存储位置。</strong>因为Zookeeper协助管理着HBase集群，当然Zookeeper中也保存着meta表的存储位置，在Zookeeper中的<code>get /hbase/meta-region-server</code>中获取。<strong>当我们获取到<code>student</code>的位置后，就开始向该节点联系读取数据。</strong></p>
<p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/HBase-readfile1.png" alt="HBase-readfile1"></p>
<p><strong>首先，我们先梳理一下获取被读取数据的位置的流程</strong></p>
<ol>
<li>Client先访问zookeeper，获取到meta表所在的位置信息</li>
<li>查询上述返回的位置信息，连接到meta节点根据namespace、表名和rowkey在meta表中找到对应的region信息</li>
<li>获取到最终数据存放的RegionServer,Region后，再次连接这个RegionServer并且查找对应的region</li>
</ol>
<p><strong>这样就获取到了数据的位置。接下来是读取的流程：</strong></p>
<p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/HBase-readfile2.png" alt="HBase-readfile2"></p>
<ol>
<li>client连接到指定的RegionServer</li>
<li>连接到指定的region，最终数据就存在放这个region中(RegionServer有多个region)，RegionServer和region是在meta表中就获取到的</li>
<li>根据读取命令中的列簇，来找到对应的store(store与列簇一一对应)</li>
<li>先从MemStore找数据，如果没有，再到BlockCache里面读。MemStore是在store中的，BlockCache(读缓存，为了快速读)是在region中的</li>
<li>BlockCache还没有，再到StoreFile上读(为了读取的效率)；如果有返回数据</li>
<li><font color="red"><strong>如果是从StoreFile里面读取的数据，不是直接返回给客户端，而是先写入BlockCache，再返回给客户端。</strong></font></li>
</ol>
<h2 id="写流程"><a href="#写流程" class="headerlink" title="写流程"></a>写流程</h2><p>client如果想写数据，<strong>首先需要知道被写的表存在的Region</strong>，其实在HBase中有一个内置的命名空间<code>hbase</code>这里面存放着一张<code>meta</code>的表，它存储者各个表的元数据，我们可以通过这张表得到我们要查询的表存储在的服务器、Region。<strong>所以如果我们想要获取数据的Region位置，就必须先知道<code>hbase</code>的<code>meta</code>表在哪，通过<code>meta</code>找到<code>student</code>的Region。因为Zookeeper协助管理着HBase集群，当然Zookeeper中也保存着meta表的存储位置，在Zookeeper中的<code>get /hbase/meta-region-server</code>中获取。</strong>当我们获取到表存储的位置后，就开始向该节点联系读取数据</p>
<p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/HBase-writefile.png" alt="HBase-writefile"></p>
<p><strong>首先，我们先梳理一下获取被写表的位置的流程</strong></p>
<ol>
<li>Client先访问zookeeper，获取到meta表所在的位置信息</li>
<li>查询上述返回的位置信息，连接到meta节点根据namespace、表名和rowkey在meta表中找到对应的region信息</li>
<li>获取到最终数据存放的RegionServer,Region后，再次连接这个RegionServer并且查找对应的region</li>
</ol>
<p><strong>写数据的流程</strong></p>
<ol>
<li>HregionServer将数据写到HLog（write ahead log）。为了数据的持久化和恢复；</li>
<li>HregionServer将数据写到内存（MemStore）</li>
<li>反馈Client写成功。</li>
</ol>
<p>如果写入内存失败，则写入失败，并且把HLog中数据删除</p>
<p><strong>然后</strong>，待MemStore数据满了(默认是128M，老版本是64M)之后，开始<a href="#%E6%95%B0%E6%8D%AEflush%E8%BF%87%E7%A8%8B">数据flush过程</a></p>
<h2 id="数据flush过程"><a href="#数据flush过程" class="headerlink" title="数据flush过程"></a>数据flush过程</h2><ol>
<li>当MemStore数据达到阈值（默认是128M，老版本是64M），将数据刷到硬盘(Store File)，将内存中的数据删除，同时删除HLog中的历史数据</li>
<li>并将数据存储到HDFS中；</li>
<li>在HLog中做标记点。</li>
</ol>
<h2 id="数据合并过程"><a href="#数据合并过程" class="headerlink" title="数据合并过程"></a>数据合并过程</h2><p>当遇到某些情况，比如因为硬件资源原因，mem store没有128M只有50M，所以每次写到磁盘的store file都不足128M，此时：</p>
<ol>
<li>当数据块达到3块，Hmaster触发合并操作，Region将数据块加载到本地，进行合并；</li>
<li>当合并的数据超过256M，进行拆分(Region切分2个Region)，将拆分后的Region分配给不同的HregionServer管理；</li>
<li>当HregionServer宕机后，将HregionServer上的hlog拆分，然后分配给不同的HregionServer加载，修改.META.</li>
<li>注意：HLog会同步到HDFS</li>
</ol>
<p><strong>compact的用途是什么，什么时候触发，分为哪两种，有什么区别。</strong></p>
<p>在HBase中，每当memstore的数据flush到磁盘后，就形成一个storefile，当storefile的数量越来越大时，会严重影响HBase的读性能 ，HBase内部的compact处理流程是为了解决MemStore Flush之后，文件数目太多，导致读数据性能大大下降的一种自我调节手段，它会将文件按照某种策略进行合并，大大提升HBase的数据读性能。</p>
<p><strong>作用</strong></p>
<ul>
<li>合并文件</li>
<li>清除删除、过期、多余版本的数据</li>
<li>提高读写数据的效率</li>
</ul>
<p><strong>HBase中实现了两种compaction的方式</strong>：minor and major</p>
<p><strong>这两种compaction方式的区别是</strong></p>
<ul>
<li>Minor操作只用来做部分文件的合并操作以及包括minVersion=0并且设置ttl的过期版本清理，不做任何删除数据、多版本数据的清理工作</li>
<li>Major操作是对Region下的HStore下的所有StoreFile执行合并操作，最终的结果是整理合并出一个文件。</li>
</ul>
<hr>
<p><font color="red"><strong>ps：由数据最后存储在HDFS可得知，HBase其实是一个管理工具，最后存储还是依靠于HDFS。</strong></font></p>
<p><font color="red"><strong>HBase中所有存储都是以字节存储的。。</strong></font></p>
<h1 id="HBase安装"><a href="#HBase安装" class="headerlink" title="HBase安装"></a>HBase安装</h1><p>HBase需要zookeeper，请先安装zookeeper、Java、Hadoop后再安装HBase</p>
<p><strong>HBase官网</strong></p>
<p><a target="_blank" rel="noopener" href="https://hbase.apache.org/">https://hbase.apache.org/</a></p>
<p><strong>下载链接</strong></p>
<p><a target="_blank" rel="noopener" href="https://archive.apache.org/dist/hbase/">https://archive.apache.org/dist/hbase/</a></p>
<h2 id="HBase配置文件"><a href="#HBase配置文件" class="headerlink" title="HBase配置文件"></a>HBase配置文件</h2><p><strong>下载后解压</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop201 ~]$ tar -zxf /opt/softwares/hbase-1.3.1-bin.tar.gz  -C /opt/modules/</span><br><span class="line">[hadoop@hadoop201 ~]$ cd /opt/modules/</span><br><span class="line">[hadoop@hadoop201 modules]$ mv hbase-1.3.1/ hbase/</span><br><span class="line">[hadoop@hadoop201 modules]$</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>修改配置文件</strong></p>
<p><code>hbase-env.sh</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 添加</span></span><br><span class="line">export JAVA_HOME=/opt/module/jdk1.8.0_144</span><br><span class="line">export HBASE_MANAGES_ZK=false</span><br><span class="line"><span class="meta">#</span><span class="bash"> jdk8需要注释掉原有内容</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">export</span> HBASE_MASTER_OPTS=<span class="string">&quot;<span class="variable">$HBASE_MASTER_OPTS</span> -XX:PermSize=128m -XX:MaxPermSize=128m&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">export</span> HBASE_REGIONSERVER_OPTS=<span class="string">&quot;<span class="variable">$HBASE_REGIONSERVER_OPTS</span> -XX:PermSize=128m -XX:MaxPermSize=128m&quot;</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>hbase-site.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--HA--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span>     </span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.rootdir<span class="tag">&lt;/<span class="name">name</span>&gt;</span>     </span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://mycluster/hbase<span class="tag">&lt;/<span class="name">value</span>&gt;</span>   </span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--单节点--&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--&lt;property&gt;     </span></span><br><span class="line"><span class="comment">        &lt;name&gt;hbase.rootdir&lt;/name&gt;     </span></span><br><span class="line"><span class="comment">        &lt;value&gt;hdfs://hadoop201:9000/hbase&lt;/value&gt;   </span></span><br><span class="line"><span class="comment">    &lt;/property&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span>   </span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.cluster.distributed<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">&lt;!-- 0.98后的新变动，之前版本没有.port,默认端口为60000 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.master.port<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>16000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span>   </span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.quorum<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">value</span>&gt;</span>hadoop201:2181,hadoop202:2181,hadoop203:2181<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span>   </span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.property.dataDir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">value</span>&gt;</span>/opt/modules/zookeeper-3.4.10/zkdata<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>regionservers</code>：添加RegionServer的节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hadoop201</span><br><span class="line">hadoop203</span><br><span class="line">hadoop202</span><br></pre></td></tr></table></figure>

<p><strong>软连接hadoop配置文件到hbase</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop201 conf]$ ln -s /opt/modules/hadoop-2.7.2/etc/hadoop/core-site.xml /opt/modules/hbase/conf/core-site.xml</span><br><span class="line">[hadoop@hadoop201 conf]$ ln -s /opt/modules/hadoop-2.7.2/etc/hadoop/h</span><br><span class="line">hadoop-env.cmd              hadoop-metrics2.properties  hadoop-policy.xml           httpfs-env.sh               httpfs-signature.secret</span><br><span class="line">hadoop-env.sh               hadoop-metrics.properties   hdfs-site.xml               httpfs-log4j.properties     httpfs-site.xml</span><br><span class="line">[hadoop@hadoop201 conf]$ ln -s /opt/modules/hadoop-2.7.2/etc/hadoop/hdfs-site.xml /opt/modules/hbase/conf/hdfs-site.xml</span><br><span class="line">[hadoop@hadoop201 conf]$</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>分发到其他节点</strong></p>
<p><strong>启动服务器</strong></p>
<p><code>bin/start-hbase.sh</code></p>
<p><strong>访问</strong></p>
<p><a target="_blank" rel="noopener" href="http://hadoop201:16010/">http://hadoop201:16010/</a></p>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">master.HMaster: Failed to become active master</span><br><span class="line">org.apache.hadoop.ipc.RemoteException(org.apache.hadoop.ipc.StandbyException): Operation category READ is not supported in state standby</span><br></pre></td></tr></table></figure>

<p>如果你是HDFS HA的话，<code>hbase-site.xml</code>中指定hdfs地址不应该上面那样写，如果这个节点恰好是standby就是上面的错误</p>
<p>你应该这样写，mycluster是你的集群名</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.rootdir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://mycluster/hbase<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<p>提示：如果集群之间的节点时间不同步，会导致regionserver无法启动，抛出ClockOutOfSyncException异常。</p>
<p>修复提示：同步时间服务</p>
<h1 id="HBase-Shell"><a href="#HBase-Shell" class="headerlink" title="HBase Shell"></a>HBase Shell</h1><h2 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h2><p><strong>shell</strong></p>
<p><code>bin/hbase shell</code>进入操作</p>
<p><strong>回退</strong></p>
<p>shell中回退不能删除，需要同时按上Ctrl键</p>
<p><strong>查看当前数据库中有哪些表</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hbase(main):001:0&gt; list</span><br><span class="line">TABLE</span><br><span class="line">0 row(s) in 0.1620 seconds</span><br><span class="line"></span><br><span class="line">=&gt; []</span><br></pre></td></tr></table></figure>

<h2 id="表的操作🔺"><a href="#表的操作🔺" class="headerlink" title="表的操作🔺"></a>表的操作🔺</h2><p><strong>创建表</strong>：<code>create ‘&lt;table name&gt;’,’&lt;column family&gt;’ </code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create &#x27;student&#x27;,&#x27;basic&#x27;,&#x27;info&#x27;</span><br></pre></td></tr></table></figure>

<p><strong>创建表，指定命名空间</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create &#x27;zxj:student&#x27;,&#x27;basic&#x27;,&#x27;info&#x27;</span><br></pre></td></tr></table></figure>

<p><strong>查看表结构</strong>：<code>describe  &#39;table&#39;</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">describe &#x27;student&#x27;</span><br></pre></td></tr></table></figure>

<p><strong>插入数据</strong>：<code>put ’&lt;table name&gt;’,’row1’,’&lt;colfamily:colname&gt;’,’&lt;value&gt;’</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">put &#x27;student&#x27;,&#x27;1001&#x27;,&#x27;basic:name&#x27;,&#x27;zxj&#x27;</span><br></pre></td></tr></table></figure>

<p><strong>扫描数据</strong>：<code>scan &#39;table&#39;</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hbase(main):008:0&gt; scan &#x27;student&#x27;</span><br><span class="line">hbase(main):009:0&gt; scan &#x27;student&#x27;,&#123;STARTROW =&gt; &#x27;1001&#x27;, STOPROW  =&gt; &#x27;1001&#x27;&#125;</span><br><span class="line">hbase(main):010:0&gt; scan &#x27;student&#x27;,&#123;STARTROW =&gt; &#x27;1001&#x27;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>获取指定行/列数据</strong>：<code>get ’&lt;table name&gt;’,’row1’,&#39;cloum&#39; </code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">hbase(main):016:0&gt; get &#x27;student&#x27;,&#x27;1001&#x27;</span><br><span class="line">COLUMN                               CELL</span><br><span class="line"> basic:name                          timestamp=1594212032713, value=zxj</span><br><span class="line"> info:qq                             timestamp=1594212148477, value=1044</span><br><span class="line">1 row(s) in 0.0100 seconds</span><br><span class="line"></span><br><span class="line">hbase(main):017:0&gt; get &#x27;student&#x27;,&#x27;1001&#x27;,&#x27;info:qq&#x27;</span><br><span class="line">COLUMN                               CELL</span><br><span class="line"> info:qq                             timestamp=1594212148477, value=1044</span><br><span class="line">1 row(s) in 0.0040 seconds</span><br><span class="line"></span><br><span class="line">hbase(main):018:0&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>更新表的指定字段，其实就是插入数据指令，一摸一样</strong>🔺</p>
<p>其实，不是覆盖。HBase同行同列可有多个版本，如果版本大于1，多个版本同时存在。如果版本只有1，最新的会替代之前的版本。</p>
<p><strong>统计行</strong>：<code>count &#39;table&#39;</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">count &#x27;student&#x27;</span><br></pre></td></tr></table></figure>

<p><strong>删除数据一行</strong>：<code>deleteall &#39;table&#39;,&#39;rowkey&#39;</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deleteall &#x27;student&#x27;,&#x27;1001&#x27;</span><br></pre></td></tr></table></figure>

<p><strong>删除某rowkey的某一列数据</strong>：<code>delete &#39;table&#39;,&#39;rowkey&#39;,&#39;cloum&#39;</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete &#x27;student&#x27;,&#x27;1001&#x27;,&#x27;info:qq&#x27;</span><br></pre></td></tr></table></figure>

<p><strong>清空表数据</strong>：<code>truncate &#39;table&#39;</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">truncate &#x27;student&#x27;</span><br></pre></td></tr></table></figure>

<p>ps：清空表的操作顺序为先disable，然后再truncate。</p>
<p><strong>删除表</strong></p>
<p>首先需要先让该表为disable状态：<code>disable &#39;student&#39;</code></p>
<p>然后才能drop这个表：<code>drop &#39;student&#39;</code></p>
<p>ps：如果直接drop表，会报错：ERROR: Table student is enabled. Disable it first.</p>
<p><strong>变更表信息</strong></p>
<p>将info列族中的数据存放3个版本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter &#x27;student&#x27;,&#123;NAME=&gt;&#x27;info&#x27;,VERSIONS=&gt;3&#125;</span><br></pre></td></tr></table></figure>



<h2 id="命名空间-1"><a href="#命名空间-1" class="headerlink" title="命名空间"></a>命名空间</h2><p><strong>创建命名空间</strong></p>
<p><code>create_namespace &#39;name&#39; </code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hbase(main):005:0&gt; create_namespace &#x27;zxj&#x27;</span><br><span class="line">0 row(s) in 0.8800 seconds</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="HBase程序"><a href="#HBase程序" class="headerlink" title="HBase程序"></a>HBase程序</h1><h2 id="HBase-API"><a href="#HBase-API" class="headerlink" title="HBase API"></a>HBase API</h2><h3 id="依赖pom"><a href="#依赖pom" class="headerlink" title="依赖pom"></a>依赖pom</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hbase<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hbase-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hbase<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hbase-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="操作类🔺"><a href="#操作类🔺" class="headerlink" title="操作类🔺"></a>操作类🔺</h3><p><strong>先提供整体的操作文件，然后单个说明：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HBaseUtils</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ThreadLocal是为了避免某的线程关闭HBase连接，导致其他线程的连接被关闭</span></span><br><span class="line">    <span class="comment">// ThreadLocal将连接放入线程的私有区域</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Connection&gt; connectionThreadLocal = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 为调用此方法的线程创建单独连接，并存储在调用者线程的内部</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">makeConnection</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = connectionThreadLocal.get();</span><br><span class="line">        <span class="keyword">if</span> (connection == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 创建HBase连接，默认读取classpath下的hbase-site.xml文件来访问各种参数</span></span><br><span class="line">            <span class="comment">// 或者你可以手动指定，这里采用配置文件形式</span></span><br><span class="line">            <span class="comment">// 注意如果你hbase.rootdir写的不是ip:port而是集群名，还需要拉取hdfs-site.xml</span></span><br><span class="line">            connection = ConnectionFactory.createConnection(HBaseConfiguration.create());</span><br><span class="line">            <span class="comment">// 如果刚开始创建连接，连接肯定为空，手动创建，之后使用这个就可以</span></span><br><span class="line">            connectionThreadLocal.set(connection);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断表是否存在</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableName 表名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true存在；false不存在</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">tableExists</span><span class="params">(String tableName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Admin admin = getManagerObject();</span><br><span class="line">        TableName table = TableName.valueOf(tableName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> b = admin.tableExists(table);</span><br><span class="line">        admin.close();</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建新表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableName    表明</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ColumnFamily 列簇可变参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createTable</span><span class="params">(String tableName, String... ColumnFamily)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Admin admin = getManagerObject();</span><br><span class="line">        TableName creatTable = TableName.valueOf(tableName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 不存在则创建</span></span><br><span class="line">        <span class="keyword">if</span> (!admin.tableExists(creatTable)) &#123;</span><br><span class="line">            HTableDescriptor tableDescriptor = <span class="keyword">new</span> HTableDescriptor(creatTable);</span><br><span class="line">            <span class="keyword">for</span> (String s : ColumnFamily) &#123;</span><br><span class="line">                tableDescriptor.addFamily(<span class="keyword">new</span> HColumnDescriptor(s));</span><br><span class="line">            &#125;</span><br><span class="line">            admin.createTable(tableDescriptor);</span><br><span class="line">            admin.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableName 表名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dropTable</span><span class="params">(String tableName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Admin admin = getManagerObject();</span><br><span class="line">        TableName dropTable = TableName.valueOf(tableName);</span><br><span class="line">        <span class="comment">// 存在则删除</span></span><br><span class="line">        <span class="keyword">if</span> (admin.tableExists(dropTable)) &#123;</span><br><span class="line">            <span class="comment">// 删除需先禁用表</span></span><br><span class="line">            admin.disableTable(dropTable);</span><br><span class="line">            <span class="comment">// 删除表</span></span><br><span class="line">            admin.deleteTable(dropTable);</span><br><span class="line">            admin.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除表的多行</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> table   表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rowKeys 被删除的所有行(可变参数)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deleteRowsTable</span><span class="params">(String table, String... rowKeys)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Table queryObject = getQueryObject(table);</span><br><span class="line">        List&lt;Delete&gt; deletes = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (tableExists(table)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String rowKey : rowKeys) &#123;</span><br><span class="line">                deletes.add(<span class="keyword">new</span> Delete(Bytes.toBytes(rowKey)));</span><br><span class="line">            &#125;</span><br><span class="line">            queryObject.delete(deletes);</span><br><span class="line">            queryObject.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除表的多行</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> table   表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rowKeys 被删除的所有行(可变参数)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deleteRowsTable</span><span class="params">(String table, List&lt;String&gt; rowKeys)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Table queryObject = getQueryObject(table);</span><br><span class="line">        List&lt;Delete&gt; deletes = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (tableExists(table)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String rowKey : rowKeys) &#123;</span><br><span class="line">                deletes.add(<span class="keyword">new</span> Delete(Bytes.toBytes(rowKey)));</span><br><span class="line">            &#125;</span><br><span class="line">            queryObject.delete(deletes);</span><br><span class="line">            queryObject.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tableName    表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rowKey       唯一键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> columnFamily 列簇</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> columns      列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value        值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">putData</span><span class="params">(String tableName, String rowKey, String columnFamily,</span></span></span><br><span class="line"><span class="function"><span class="params">                               String columns, String value)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Table table = getQueryObject(tableName);</span><br><span class="line">        <span class="comment">// Bytes.toBytes(rowKey)变为字节数组，使用自带方法进行UTF-8的编码，也可以自己编码。</span></span><br><span class="line">        <span class="comment">// 必须指定编码，否则相同的字符不同的编码会有不同的字节码</span></span><br><span class="line">        Put put = <span class="keyword">new</span> Put(Bytes.toBytes(rowKey));</span><br><span class="line">        put.addColumn(Bytes.toBytes(columnFamily), Bytes.toBytes(columns), Bytes.toBytes(value));</span><br><span class="line">        table.put(put);</span><br><span class="line">        table.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取表中所有数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name 表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 数据，如果表不存在返回null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ResultScanner <span class="title">scanAll</span><span class="params">(String name)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (tableExists(name)) &#123;</span><br><span class="line">            Table table = getQueryObject(name);</span><br><span class="line">            ResultScanner scanner = table.getScanner(<span class="keyword">new</span> Scan());</span><br><span class="line">            table.close();</span><br><span class="line">            <span class="keyword">return</span> scanner;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据rowKey范围获取表中数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name     表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> startRow 开始的行，字典顺序比较</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> endRow   结束的行，字典顺序比较</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 数据，表不存在为null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ResultScanner <span class="title">scanRowRange</span><span class="params">(String name, String startRow, String endRow)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (tableExists(name)) &#123;</span><br><span class="line">            Table table = getQueryObject(name);</span><br><span class="line">            Scan scan = <span class="keyword">new</span> Scan();</span><br><span class="line">            scan.setStartRow(Bytes.toBytes(startRow));</span><br><span class="line">            scan.setStopRow(Bytes.toBytes(endRow));</span><br><span class="line">            ResultScanner scanner = table.getScanner(scan);</span><br><span class="line">            table.close();</span><br><span class="line">            <span class="keyword">return</span> scanner;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据列簇来获取表中数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name   表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> family 列簇</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 数据，表不存在为null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ResultScanner <span class="title">scanByFamily</span><span class="params">(String name, String family)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (tableExists(name)) &#123;</span><br><span class="line">            Scan scan = <span class="keyword">new</span> Scan();</span><br><span class="line">            scan.addFamily(Bytes.toBytes(family));</span><br><span class="line">            Table queryObject = getQueryObject(name);</span><br><span class="line">            ResultScanner scanner = queryObject.getScanner(scan);</span><br><span class="line">            queryObject.close();</span><br><span class="line">            <span class="keyword">return</span> scanner;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据列来获取表中数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name   表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> family 列簇</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> column 列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 数据，表不存在为null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ResultScanner <span class="title">scanByColumn</span><span class="params">(String name, String family, String column)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (tableExists(name)) &#123;</span><br><span class="line">            Scan scan = <span class="keyword">new</span> Scan();</span><br><span class="line">            scan.addColumn(Bytes.toBytes(family), Bytes.toBytes(column));</span><br><span class="line">            Table queryObject = getQueryObject(name);</span><br><span class="line">            ResultScanner scanner = queryObject.getScanner(scan);</span><br><span class="line">            queryObject.close();</span><br><span class="line">            <span class="keyword">return</span> scanner;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询根据正则匹配到的rowKey的数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name 表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> regex 正则</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 数据，表不存在为null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ResultScanner <span class="title">scanByRowKeyReg</span><span class="params">(String name, String regex)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (tableExists(name)) &#123;</span><br><span class="line">            <span class="comment">// 使用Filter过滤器，来对rowKey进行筛选</span></span><br><span class="line">            Scan scan = <span class="keyword">new</span> Scan();</span><br><span class="line">            <span class="comment">// Filter是一个抽象类，它有众多的实现类，而对rowKey进行筛选的是RowFilter</span></span><br><span class="line">            <span class="comment">// RowFilter的两个参数分别为过滤rowKey的比较符(=,&gt;=...)和比较器ByteArrayComparable</span></span><br><span class="line">            <span class="comment">// ByteArrayComparable又是一个抽象类，其中它的子类RegexStringComparator就是用来使用正则的</span></span><br><span class="line">            RowFilter rowFilter = <span class="keyword">new</span> RowFilter(CompareFilter.CompareOp.EQUAL,</span><br><span class="line">                    <span class="keyword">new</span> RegexStringComparator(regex));</span><br><span class="line">            <span class="comment">// scan条件中加入过滤器</span></span><br><span class="line">            scan.setFilter(rowFilter);</span><br><span class="line"></span><br><span class="line">            Table queryObject = getQueryObject(name);</span><br><span class="line">            ResultScanner scanner = queryObject.getScanner(scan);</span><br><span class="line">            queryObject.close();</span><br><span class="line">            <span class="keyword">return</span> scanner;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ResultScanner <span class="title">scanByFilters</span><span class="params">(String name, String regex, String notHas)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (tableExists(name)) &#123;</span><br><span class="line">            <span class="comment">// 使用多个Filter过滤器，来对rowKey进行筛选</span></span><br><span class="line">            Scan scan = <span class="keyword">new</span> Scan();</span><br><span class="line">            <span class="comment">// Filter是一个抽象类，它有众多的实现类，而对rowKey进行筛选的是RowFilter</span></span><br><span class="line">            <span class="comment">// RowFilter的两个参数分别为过滤rowKey的比较符(=,&gt;=...)和比较器ByteArrayComparable</span></span><br><span class="line">            <span class="comment">// ByteArrayComparable又是一个抽象类，其中它的子类RegexStringComparator就是用来使用正则的</span></span><br><span class="line">            RowFilter rowFilter = <span class="keyword">new</span> RowFilter(CompareFilter.CompareOp.EQUAL,</span><br><span class="line">                    <span class="keyword">new</span> RegexStringComparator(regex));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// BinaryComparator是ByteArrayComparable的子类，用于比较二进制</span></span><br><span class="line">            RowFilter rowFilter1 = <span class="keyword">new</span> RowFilter(CompareFilter.CompareOp.NOT_EQUAL,</span><br><span class="line">                    <span class="keyword">new</span> BinaryComparator(Bytes.toBytes(notHas)));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// FilterList.Operator.MUST_PASS_ALL==and</span></span><br><span class="line">            <span class="comment">// FilterList.Operator.MUST_PASS_ONE==or</span></span><br><span class="line">            FilterList filterList = <span class="keyword">new</span> FilterList(FilterList.Operator.MUST_PASS_ALL);</span><br><span class="line">            filterList.addFilter(rowFilter);</span><br><span class="line">            filterList.addFilter(rowFilter1);</span><br><span class="line">            <span class="comment">// scan条件中加入过滤器</span></span><br><span class="line">            scan.setFilter(filterList);</span><br><span class="line"></span><br><span class="line">            Table queryObject = getQueryObject(name);</span><br><span class="line">            ResultScanner scanner = queryObject.getScanner(scan);</span><br><span class="line">            queryObject.close();</span><br><span class="line">            <span class="keyword">return</span> scanner;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 获取指定rowKey的数据</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> name   表</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> rowKey 主键</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> 数据，表不存在返回null</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> IOException 异常</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Result <span class="title">getByRowKey</span><span class="params">(String name, String rowKey)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (tableExists(name)) &#123;</span><br><span class="line">            Table queryObject = getQueryObject(name);</span><br><span class="line">            Result result = queryObject.get(<span class="keyword">new</span> Get(Bytes.toBytes(rowKey)));</span><br><span class="line">            queryObject.close();</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取指定rowKey的指定列簇的数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name         表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rowKey       键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> columnFamily 列簇</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 数据，表不存在返回null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Result <span class="title">getByRowKeyAndFamily</span><span class="params">(String name, String rowKey,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              String columnFamily)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (tableExists(name)) &#123;</span><br><span class="line">            Table table = getQueryObject(name);</span><br><span class="line">            Get get = <span class="keyword">new</span> Get(Bytes.toBytes(rowKey));</span><br><span class="line">            get.addFamily(Bytes.toBytes(columnFamily));</span><br><span class="line">            Result result = table.get(get);</span><br><span class="line">            table.close();</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取指定rowKey的指定列簇的指定列的数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name         表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rowKey       键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> columnFamily 列簇</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> column       列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 数据，表不存在返回null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Result <span class="title">getByRowKeyAndColumn</span><span class="params">(String name, String rowKey,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              String columnFamily, String column)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (tableExists(name)) &#123;</span><br><span class="line">            Table table = getQueryObject(name);</span><br><span class="line">            Get get = <span class="keyword">new</span> Get(Bytes.toBytes(rowKey));</span><br><span class="line">            get.addColumn(Bytes.toBytes(columnFamily), Bytes.toBytes(column));</span><br><span class="line">            Result result = table.get(get);</span><br><span class="line">            table.close();</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从connectionThreadLocal中获取连接</span></span><br><span class="line"><span class="comment">     * 并从连接中获取管理数据库表的对象，只能进行DDL操作</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Admin DDL操作对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Admin <span class="title">getManagerObject</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = connectionThreadLocal.get();</span><br><span class="line">        <span class="keyword">return</span> connection.getAdmin();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从connectionThreadLocal中获取连接</span></span><br><span class="line"><span class="comment">     * 并从连接中获取查询数据库表的对象，只能进行DQL操作</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Admin DQL操作对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Table <span class="title">getQueryObject</span><span class="params">(String tableName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = connectionThreadLocal.get();</span><br><span class="line">        <span class="keyword">return</span> connection.getTable(TableName.valueOf(tableName));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭调用者线程HBase的连接，不响应其他调用此类的线程，因为连接存在于别调用者内存</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 错误</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = connectionThreadLocal.get();</span><br><span class="line">        <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!connection.isClosed()) &#123;</span><br><span class="line">                connection.close();</span><br><span class="line">                <span class="comment">// 关闭线程的存储区域</span></span><br><span class="line">                connectionThreadLocal.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><ol>
<li><font color="red"><strong>使用<code>ThreadLocal</code>将与HBase的连接放入调用者线程的内存中，将线程间的HBase连接区分开来</strong>，操作线程存储。<strong>它解决了线程内部的数据共享问题</strong>，如果能保证每个线程内部存放在ThreadLocal中的对象不同，它可以避免线程安全问题。</font></li>
<li>HBase连接参数采用HBase的配置文件<code>HBase-site.xml</code>，如果<code>hbase.rootdir</code>写的不是ip:port而是hdfs集群名，还需要加入配置文件<code>hdfs-site.xml</code></li>
<li>管理对象admin用于表的增删(DDL)</li>
<li>表对象table用于查询，插入(DQL)</li>
<li><font color="yellow">其中包含使用<code>Filter</code>查询数据，这种方式比较灵活。但是效率不高。</font></li>
</ol>
<hr>
<p><strong>Scan Filter查询</strong></p>
<p>过滤器<code>Filter</code>是一个抽象类，不同内容的过滤使用的子类不同：</p>
<p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/HBase-rowkeyfilter.png" alt="HBase-rowkeyfilter"></p>
<p><code>RowFilter</code>的参数分别为：</p>
<ol>
<li>过滤rowKey的比较符(=,&gt;=…)</li>
<li>ByteArrayComparable，值的类型</li>
</ol>
<p>ByteArrayComparable又是一个抽象类，可用于不同值的比较：</p>
<p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/HBase-com.png" alt="HBase-com"></p>
<p>过滤器可以指定多个，可以通过放入<code>FilterList</code>，通过它的参数来指定逻辑：</p>
<ol>
<li>FilterList.Operator.MUST_PASS_ONE==or</li>
<li>FilterList.Operator.MUST_PASS_ALL==and</li>
</ol>
<h2 id="HBase集成MapReduce🔺"><a href="#HBase集成MapReduce🔺" class="headerlink" title="HBase集成MapReduce🔺"></a>HBase集成MapReduce🔺</h2><h3 id="环境设置"><a href="#环境设置" class="headerlink" title="环境设置"></a>环境设置</h3><p>mapReduce 默认是没有添加HBase的依赖包的，<strong>你可以通过添加HBase-site这个配置文件到hadoop配置目录下，但是这样要复制到整个集群</strong>；或者你可以编辑<strong>Hadoop的CLASSPATH，但这样又会使得你的Hadoop环境受到污染。而且需要重启Hadoop集群才能生效</strong>。<br>因此，最好的方法是让HBase自己添加自己的依赖包到Hadoop的CLASSPATH，然后再使用程序。</p>
<ol>
<li><p>设置好Hadoop和HBase的环境变量</p>
</li>
<li><p><code>bin/hbase mapredcp</code>，输出MapReduce与HBase集成时候需要的HBase依赖包</p>
</li>
<li><p>然后每次运行任务时，将HBase的依赖包告诉世界 (空格) 然后执行mapreduce程序；例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> HADOOP_CLASSPATH=`<span class="variable">$HBASE_HOME</span>/bin/hbase mapredcp` <span class="variable">$HADOOP_HOME</span>/bin/hadoop jar <span class="variable">$HBASE_HOME</span>/lib/hbase-server-1.2.0-cdh5.12.0.jar</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="代码开发"><a href="#代码开发" class="headerlink" title="代码开发"></a>代码开发</h3><p>使用HBase集成MapReduce开发MapReduce程序，和直接开发Map Reduce程序有些不同，也有些相似。</p>
<p><strong>编写步骤</strong></p>
<ol>
<li>首先HBase的MR程序也需要是Mapper、Reducer、Driver三部分。</li>
<li>编写Mapper时不是继承<code>Mapper</code>而是继承<code>TableMapper</code>，而<code>public abstract class TableMapper&lt;KEYOUT, VALUEOUT&gt; extends Mapper&lt;ImmutableBytesWritable, Result, KEYOUT, VALUEOUT&gt;</code>，可得知后者是前者的字类，并确定死了K-V，因为HBase集成MR，输入数据源肯定是HBase的表，输入MapTask被确定的Key、Value分别是rowKey和表中此行所有的值</li>
<li>编写Reduce时不是继承<code>Reducer</code>而是继承<code>TableReducer</code>，而<code>public abstract class TableReducer&lt;KEYIN, VALUEIN, KEYOUT&gt; extends Reducer&lt;KEYIN, VALUEIN, KEYOUT, Mutation&gt; </code>，可得知后者是前者的字类，并确定好了最后输出的Value，因为输出尽头是HBase，所以它固定了最后的Value(Mutation)，Mutation是一个抽象类它的子类Put可以存储每一行的信息，用于插入数据。</li>
<li>Mutation类型有很多子类，对应多种不同操作：<code>put</code>，<code>delete</code></li>
<li>设置Driver时，设置Map Task、Reducer Task时可以使用HBase工具来简化开发，只需要放入表名、kv、job即可。</li>
</ol>
<h3 id="案例一"><a href="#案例一" class="headerlink" title="案例一"></a>案例一</h3><p><strong>目标：将from表中的数据，通过MR迁入到to表中。</strong></p>
<p><strong>Mapper</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ImmutableBytesWritable是rowkey，Put将结果数据放入PUT</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Mapper</span> <span class="keyword">extends</span> <span class="title">TableMapper</span>&lt;<span class="title">ImmutableBytesWritable</span>, <span class="title">Put</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ImmutableBytesWritable是rowKey</span></span><br><span class="line">    <span class="comment">// Result是这一行所有的结果值，columnFamily,column,value....</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(ImmutableBytesWritable key, Result value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        Put put = <span class="keyword">new</span> Put(key.get());</span><br><span class="line">        <span class="keyword">for</span> (Cell listCell : value.listCells()) &#123;</span><br><span class="line">            put.addColumn(CellUtil.cloneFamily(listCell), CellUtil.cloneQualifier(listCell),</span><br><span class="line">                    CellUtil.cloneValue(listCell));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 最后将rowkey-和这一行所有的数据输出给Reduce</span></span><br><span class="line">        context.write(key, put);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Reducer</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 泛型的意义分别为MapTask的Key、Value和最后输出的K。</span></span><br><span class="line"><span class="comment">// 最后输出的Value已经被定死，因为是HBase结合MR，所以输入输出全是HBase</span></span><br><span class="line"><span class="comment">// Value被确定为Mutation，它是PUT的父类，是能把数据放入表的类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Reducer</span> <span class="keyword">extends</span> <span class="title">TableReducer</span>&lt;<span class="title">ImmutableBytesWritable</span>, <span class="title">Put</span>, <span class="title">NullWritable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// reducer将Map的数据分组，所以它的参数是MapTask的Key和可迭代的Value</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(ImmutableBytesWritable key, Iterable&lt;Put&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 因为要把每一条数据放入新的表中</span></span><br><span class="line">        <span class="comment">// 所以要遍历values，取得每一个PUT，每一个PUT就是一个rowKey对应的全部数据</span></span><br><span class="line">        <span class="keyword">for</span> (Put value : values) &#123;</span><br><span class="line">            context.write(NullWritable.get(), value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Driver</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataMigrationApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ToolRunner.run(<span class="keyword">new</span> DataMigrationTool(), args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataMigrationTool</span> <span class="keyword">implements</span> <span class="title">Tool</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(String[] strings)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException,</span></span><br><span class="line"><span class="function">            InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 1. 初始化JOB对象</span></span><br><span class="line">        Job job = Job.getInstance();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 设置Jar路径</span></span><br><span class="line">        job.setJarByClass(DataMigrationTool.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 因为使用HBase做为MR的输入输出，所以可以直接使用HBase的工具类</span></span><br><span class="line">        <span class="comment">// 来简化Map、Reduce的配置</span></span><br><span class="line">        <span class="comment">// 3. 设置MapTask</span></span><br><span class="line">        TableMapReduceUtil.initTableMapperJob(<span class="string">&quot;from&quot;</span>, <span class="keyword">new</span> Scan(), Mapper.class,</span><br><span class="line">                ImmutableBytesWritable.class, Put.class, job);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 设置ReduceTask</span></span><br><span class="line">        TableMapReduceUtil.initTableReducerJob(<span class="string">&quot;to&quot;</span>, Reducer.class, job);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. job执行</span></span><br><span class="line">        <span class="keyword">boolean</span> b = job.waitForCompletion(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> b ? JobStatus.State.SUCCEEDED.getValue() : JobStatus.State.FAILED.getValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConf</span><span class="params">(Configuration configuration)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Configuration <span class="title">getConf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试运行</strong></p>
<p><code>HADOOP_CLASSPATH=&#39;$HBASE_HOME/bin/hbase mapredcp&#39; yarn jar xxx.jar</code></p>
<h3 id="案例二"><a href="#案例二" class="headerlink" title="案例二"></a>案例二</h3><p><strong>HDFS文件内容通过MR迁移到HBase表中</strong></p>
<p>与<a href="#%E6%A1%88%E4%BE%8B%E4%B8%80">案例一</a>相比，这次案例的输入是HDFS、输出是HBase。所以Mapper的设置不能使用util了，需要正常设置：<strong>输入文件路径、Mapper类、Mapper输出的k和v</strong>，并且Mapper类不能继承tablemapper了，需要正常的继承Mapper</p>
<p><strong>需要额外添加依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>被处理文件内容格式</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">123,zxj</span><br><span class="line">1234,ddd</span><br><span class="line">124,klj</span><br></pre></td></tr></table></figure>

<p><strong>Mapper</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HDFS2HBaseMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">ImmutableBytesWritable</span>, <span class="title">Put</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">final</span> ImmutableBytesWritable immutableBytesWritable = <span class="keyword">new</span> ImmutableBytesWritable();</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span> <span class="keyword">throws</span> IOException,</span></span><br><span class="line"><span class="function">            InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 文件中数据：rowKey,name</span></span><br><span class="line">        String[] split = value.toString().split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        immutableBytesWritable.set(Bytes.toBytes(split[<span class="number">0</span>]));</span><br><span class="line">        Put put = <span class="keyword">new</span> Put(immutableBytesWritable.get());</span><br><span class="line">        put.addColumn(Bytes.toBytes(<span class="string">&quot;info&quot;</span>), Bytes.toBytes(<span class="string">&quot;name&quot;</span>), Bytes.toBytes(split[<span class="number">1</span>]));</span><br><span class="line">        context.write(immutableBytesWritable, put);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Reducer</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HDFS2HBaseReducer</span> <span class="keyword">extends</span> <span class="title">TableReducer</span>&lt;<span class="title">ImmutableBytesWritable</span>, <span class="title">Put</span>, <span class="title">NullWritable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(ImmutableBytesWritable key, Iterable&lt;Put&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Put value : values) &#123;</span><br><span class="line">            context.write(NullWritable.get(), value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>Driver</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HDFSHBaseApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ToolRunner.run(<span class="keyword">new</span> HDFS2HBaseTool(), args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HDFS2HBaseTool</span> <span class="keyword">implements</span> <span class="title">Tool</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(String[] strings)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// job</span></span><br><span class="line">        Job job = Job.getInstance();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// jar</span></span><br><span class="line">        job.setJarByClass(HDFS2HBaseTool.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// mapper设置</span></span><br><span class="line">        job.setMapperClass(HDFS2HBaseMapper.class);</span><br><span class="line">        job.setMapOutputKeyClass(ImmutableBytesWritable.class);</span><br><span class="line">        job.setMapOutputValueClass(Put.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// input</span></span><br><span class="line">        FileInputFormat.setInputPaths(job, <span class="string">&quot;E:\\input&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// reducer</span></span><br><span class="line">        TableMapReduceUtil.initTableReducerJob(<span class="string">&quot;to&quot;</span>, HDFS2HBaseReducer.class, job);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> b = job.waitForCompletion(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> b ? JobStatus.State.SUCCEEDED.getValue() : JobStatus.State.FAILED.getValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConf</span><span class="params">(Configuration configuration)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Configuration <span class="title">getConf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="案例三"><a href="#案例三" class="headerlink" title="案例三"></a>案例三</h3><p>将HBase的结果放入到Mysql</p>
<p>与案例二一样的思路，但是要单独的设置输出到Mysql，而MR默认没有，所以我们要自己定义<code>OutputFormat</code>ji将数据插入到MySQL</p>
<p>要单独的添加MySQL连接依赖(要根据自己MySQL服务端的版本来引用)s</p>
<p>输出到关系型数据库，<a href="/2020/07/14/Sqoop%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" title="可使用Sqoop实现下面功能">可使用Sqoop实现下面功能</a>。下面只是个案例。</p>
<p>处理流程如下：</p>
<p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/HBase-mysql.png" alt="HBase-mysql"></p>
<p>列簇：info，列：name。数据结构。</p>
<p><strong>MR</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HBase2MySqlMapper</span> <span class="keyword">extends</span> <span class="title">TableMapper</span>&lt;<span class="title">Text</span>, <span class="title">TransferBean</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(ImmutableBytesWritable key, Result value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Cell listCell : value.listCells()) &#123;</span><br><span class="line">            TransferBean transferBean = <span class="keyword">new</span> TransferBean();</span><br><span class="line">            transferBean.setCount(<span class="number">1</span>);</span><br><span class="line">            transferBean.setName(Bytes.toString(CellUtil.cloneValue(listCell)));</span><br><span class="line">            context.write(<span class="keyword">new</span> Text(transferBean.getName()), transferBean);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HBase2MySqlReducer</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Text</span>, <span class="title">TransferBean</span>, <span class="title">NullWritable</span>, <span class="title">TransferBean</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;TransferBean&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> count=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (TransferBean value : values) &#123;</span><br><span class="line">            count += value.getCount();</span><br><span class="line">        &#125;</span><br><span class="line">        TransferBean transferBean = <span class="keyword">new</span> TransferBean();</span><br><span class="line">        transferBean.setName(key.toString());</span><br><span class="line">        transferBean.setCount(count);</span><br><span class="line">        context.write(NullWritable.get(), transferBean);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HBase2MySqlTool</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ToolRunner.run(<span class="keyword">new</span> HBase2MySqlApplication(), args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HBase2MySqlApplication</span> <span class="keyword">implements</span> <span class="title">Tool</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(String[] strings)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Job instance = Job.getInstance();</span><br><span class="line"></span><br><span class="line">        TableMapReduceUtil.initTableMapperJob(<span class="string">&quot;student&quot;</span>, <span class="keyword">new</span> Scan(), HBase2MySqlMapper.class</span><br><span class="line">                , Text.class, TransferBean.class, instance);</span><br><span class="line"></span><br><span class="line">        instance.setReducerClass(HBase2MySqlReducer.class);</span><br><span class="line">        instance.setOutputKeyClass(NullWritable.class);</span><br><span class="line">        instance.setOutputValueClass(TransferBean.class);</span><br><span class="line"></span><br><span class="line">        instance.setOutputFormatClass(MySqlOutputFormat.class);</span><br><span class="line">        <span class="comment">// 5. job执行</span></span><br><span class="line">        <span class="keyword">boolean</span> b = instance.waitForCompletion(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> b ? JobStatus.State.SUCCEEDED.getValue() : JobStatus.State.FAILED.getValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConf</span><span class="params">(Configuration configuration)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Configuration <span class="title">getConf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>Bean</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransferBean</span> <span class="keyword">implements</span> <span class="title">WritableComparable</span>&lt;<span class="title">TransferBean</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer count;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCount</span><span class="params">(Integer count)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.count = count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(TransferBean o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name.compareTo(o.getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutput dataOutput)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        dataOutput.writeUTF(name);</span><br><span class="line">        dataOutput.writeInt(count);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFields</span><span class="params">(DataInput dataInput)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        name = dataInput.readUTF();</span><br><span class="line">        count = dataInput.readInt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>OutputFormat</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySqlOutputFormat</span> <span class="keyword">extends</span> <span class="title">FileOutputFormat</span>&lt;<span class="title">NullWritable</span>, <span class="title">TransferBean</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RecordWriter&lt;NullWritable, TransferBean&gt; <span class="title">getRecordWriter</span><span class="params">(TaskAttemptContext taskAttemptContext)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MySqlRecordWriter();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySqlRecordWriter</span> <span class="keyword">extends</span> <span class="title">RecordWriter</span>&lt;<span class="title">NullWritable</span>, <span class="title">TransferBean</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(NullWritable nullWritable, TransferBean transferBean)</span> <span class="keyword">throws</span> IOException,</span></span><br><span class="line"><span class="function">            InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        String sql = <span class="string">&quot;insert into test(id,name,count) values (?,?,?)&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> (Connection connection = JDBCUtils.getConnection();</span><br><span class="line">             PreparedStatement preparedStatement = connection.prepareStatement(sql);) &#123;</span><br><span class="line">            preparedStatement.setObject(<span class="number">1</span>, System.currentTimeMillis());</span><br><span class="line">            preparedStatement.setObject(<span class="number">2</span>, transferBean.getName());</span><br><span class="line">            preparedStatement.setObject(<span class="number">3</span>, transferBean.getCount());</span><br><span class="line">            preparedStatement.execute();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException throwables) &#123;</span><br><span class="line">            throwables.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(TaskAttemptContext taskAttemptContext)</span> <span class="keyword">throws</span> IOException,</span></span><br><span class="line"><span class="function">            InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>JDBC</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JDBCUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DRIVER_CLASS;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String USERNAME;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PASSWORD;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;Connection&gt; threadLocal = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">// 加载属性文件并解析：</span></span><br><span class="line">        Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">        <span class="comment">// 使用类的加载器的方式获取属性文件的输入流</span></span><br><span class="line">        InputStream is = JDBCUtils.class.getClassLoader().getResourceAsStream(<span class="string">&quot;jdbc.properties&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            props.load(is);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;数据库配置文件 jdbc.properties 读取失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        DRIVER_CLASS = props.getProperty(<span class="string">&quot;DRIVER_CLASS&quot;</span>);</span><br><span class="line">        URL = props.getProperty(<span class="string">&quot;URL&quot;</span>);</span><br><span class="line">        USERNAME = props.getProperty(<span class="string">&quot;USERNAME&quot;</span>);</span><br><span class="line">        PASSWORD = props.getProperty(<span class="string">&quot;PASSWORD&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册驱动</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadDriver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class.forName(DRIVER_CLASS);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;驱动类&quot;</span> + DRIVER_CLASS + <span class="string">&quot;加载失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 建立数据库连接</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Connection 数据库连接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="comment">// 得到当前线程上绑定的连接</span></span><br><span class="line">        Connection connection = threadLocal.get();</span><br><span class="line">        <span class="comment">// 如果有事务，返回当前事务的连接</span></span><br><span class="line">        <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> connection;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果没有事务，创建新的链接</span></span><br><span class="line">        loadDriver(); <span class="comment">// 加载驱动</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> DriverManager.getConnection(URL, USERNAME, PASSWORD);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开启事务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">startTransaction</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        Connection connection = threadLocal.get(); <span class="comment">// 获取当前线程的事务连接</span></span><br><span class="line">        <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(<span class="string">&quot;事务已开启，不能重复开启&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        loadDriver(); <span class="comment">// 加载驱动</span></span><br><span class="line">        connection = DriverManager.getConnection(URL, USERNAME, PASSWORD);</span><br><span class="line">        connection.setAutoCommit(<span class="keyword">false</span>); <span class="comment">// 设置手动提交</span></span><br><span class="line">        threadLocal.set(connection); <span class="comment">// 把当前事务连接放到线程中</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提交事务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> SQLException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        Connection connection = threadLocal.get(); <span class="comment">// 获取当前线程的事务连接</span></span><br><span class="line">        <span class="keyword">if</span> (connection == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(<span class="string">&quot;没有事务不能提交！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        connection.commit();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 回滚事务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> SQLException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        Connection connection = threadLocal.get(); <span class="comment">// 获取当前线程的事务连接</span></span><br><span class="line">        <span class="keyword">if</span> (connection == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(<span class="string">&quot;没有事务不能提交！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        connection.rollback();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 释放资源</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> obj</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != obj) &#123;</span><br><span class="line">            <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> ResultSet) &#123;</span><br><span class="line">                ResultSet rs = (ResultSet) obj;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    rs.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;释放结果集资源出错，&quot;</span> + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Statement) &#123;</span><br><span class="line">                Statement stmt = (Statement) obj;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    stmt.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;释放 statement 资源出错，&quot;</span> + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Connection) &#123;</span><br><span class="line">                Connection connection = threadLocal.get(); <span class="comment">// 获取当前线程的事务连接</span></span><br><span class="line">                Connection conn = (Connection) obj; <span class="comment">// 普通连接</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 如果是事务连接</span></span><br><span class="line">                    <span class="keyword">if</span> (connection == conn) &#123;</span><br><span class="line">                        threadLocal.remove();</span><br><span class="line">                    &#125;</span><br><span class="line">                    conn.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;释放连接资源出错，&quot;</span> + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="HBase协处理器🔺"><a href="#HBase协处理器🔺" class="headerlink" title="HBase协处理器🔺"></a>HBase协处理器🔺</h1><p>上述说的<a href="#%E6%A1%88%E4%BE%8B%E4%B8%80">表数据迁移</a>，不怎么好？原因如下：</p>
<ol>
<li>表数据迁移，意思就是两个表数据要同步，如果同步之后原始表又新增数据了，迁移表该怎么做？</li>
<li>这时应该增量导入？但是也无从得知哪些是新的数据</li>
<li>应该全量导入？数据量更大，浪费</li>
</ol>
<p>ps：全量导入还是增量导入还是看需求，增量导入需要保证老数据没有被修改。</p>
<p><strong>那么该怎么设置一个同步的表呢？</strong></p>
<p>我们可以将迁移表和原始表进行插入动作绑定，当原始表插入数据时，我们也给迁移表插入。但是这个操作肯定不是我们手动操作，这样来插入两张表很麻烦。</p>
<p>这个问题在关系型数据库中有实现，它就是<code>trigger</code>触发器，它监听到原始表的操作，然后根据<code>trigger</code>的定义，来对其他表做出操作。</p>
<p>HBase也有相似的概念：<code>Coprocessor</code>协处理器，它能提供上面一样的功能</p>
<h2 id="协处理器的使用"><a href="#协处理器的使用" class="headerlink" title="协处理器的使用"></a>协处理器的使用</h2><p>基于我们提出的痛点，我们可以在新建原始表的时候指定协处理器，来完成对迁移表数据的更新。</p>
<p>协处理器要谨慎操作，如果逻辑错误会造成集群无法启动的问题。</p>
<p>步骤如下：</p>
<ol>
<li>创建协处理器类，继承<code>BaseRegionObserver</code></li>
<li>重写方法</li>
<li>实现逻辑</li>
<li>项目打包，依赖jar包就行(不包含第三方依赖)</li>
<li>上传至<code>$HBASE_HOME/lib</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BaseRegionObserver有很多方法可以重写</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCoprocessor</span> <span class="keyword">extends</span> <span class="title">BaseRegionObserver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// post是指源表执行完后执行</span></span><br><span class="line">    <span class="comment">// put指的是put操作(add,modify)</span></span><br><span class="line">    <span class="comment">// 最好不要写全局Coprocessor,这样任意一个表put数据后，都会触发此函数给to加数据，to加了数据后，又会触发这个函数，死循环</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postPut</span><span class="params">(ObserverContext&lt;RegionCoprocessorEnvironment&gt; e, Put put, WALEdit edit, Durability durability)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Table to = e.getEnvironment().getTable(TableName.valueOf(<span class="string">&quot;to&quot;</span>));</span><br><span class="line">        to.put(put);</span><br><span class="line">        to.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> tableDescriptor.addCoprocessor(<span class="string">&quot;top.awslzhang.hbase.mr.MyCoprocessor&quot;</span>);</span><br><span class="line"><span class="comment">// 创建表时，声明协处理器。</span></span><br></pre></td></tr></table></figure>

<h1 id="HBase集成Hive🔺"><a href="#HBase集成Hive🔺" class="headerlink" title="HBase集成Hive🔺"></a>HBase集成Hive🔺</h1><p>HBase 虽然可以存储数亿或数十亿行数据，但是对于数据分析来说，不太友好，<strong>只提供了简单的基于 Key 值的快速查询能力，没法进行大量的条件查询。</strong></p>
<p>不过，Hive 与 HBase 的整合可以实现我们的这个目标。不仅如此，还能通过 Hive 将数据批量地导入到 HBase 中。</p>
<p>Hive 与 HBase 整合的实现是利用两者本身对外的 API 接口互相通信来完成的，其具体工作交由 Hive 的 lib 目录中的 hive-hbase-handler-xxx.jar 工具类来实现对 HBase 数据的读取。</p>
<h2 id="HBase与Hive的对比"><a href="#HBase与Hive的对比" class="headerlink" title="HBase与Hive的对比"></a>HBase与Hive的对比</h2><p><strong>hive</strong></p>
<ul>
<li>数据仓库：Hive的本质其实就相当于将HDFS中已经存储的文件在Mysql中做了一个双射关系，以方便使用HQL去管理查询。</li>
<li>用于数据分析、清洗：Hive适用于离线的数据分析和清洗，延迟较高。</li>
<li>基于HDFS、MapReduce：Hive存储的数据依旧在DataNode上，编写的HQL语句终将是转换为MapReduce代码执行。</li>
</ul>
<p><strong>hbase</strong></p>
<ul>
<li>数据库：是一种面向列存储的非关系型数据库。</li>
<li> 用于存储结构化和非结构化的数据：适用于单表非关系型数据的存储，不适合做关联查询，类似JOIN等操作</li>
<li>基于HDFS：数据持久化存储的体现形式是Hfile，存放于DataNode中，被ResionServer以region的形式进行管理</li>
<li>延迟较低，接入在线业务使用：面对大量的企业数据，HBase可以直线单表大量数据的存储，同时提供了高效的数据访问速度。</li>
</ul>
<h2 id="版本冲突"><a href="#版本冲突" class="headerlink" title="版本冲突"></a>版本冲突</h2><p>当我们想整合hadoop，hbase，hive，zookeeper的时候，如果刚入门，可能认为这是比较简单的问题。但是当你自己真正想整合的时候，却会遇到很多的问题。1.hadoop与hbase哪些版本兼容？2.hadoop与hive哪些版本兼容？3.hbase与hive哪些版本兼容？4.hbase与zookeeper哪些版本兼容？所以当我们真正想做整合的时候，我们需要解决上面四个问题，有些同学，忽略上面问题，直接部署，导致产生各种问题。所以我们现在就要解决上面问题。第一个问题，hadoop与hbase哪些版本兼容。 这里的每一个问题，当然我们需要引用官网的内容。</p>
<p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/HBase-hiveversion.png" alt="HBase-hiveversion"></p>
<p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/HBase-hadoop.png" alt="HBase-hadoop"></p>
<p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/HBase-hbase.png" alt="HBase-hbase"></p>
<h2 id="集成使用"><a href="#集成使用" class="headerlink" title="集成使用"></a>集成使用</h2><h3 id="hive的修改"><a href="#hive的修改" class="headerlink" title="hive的修改"></a>hive的修改</h3><p><strong>修改hive-site.xml配置文件，添加配置属性</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.quorum<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>server01:2181,server02:2181,server03:2181<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>修改hive-env.sh文件</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export HIVE_CLASSPATH=$HIVE_CLASSPATH:/hadoop/hbase/lib/*</span><br></pre></td></tr></table></figure>

<h3 id="hive绑定hbase"><a href="#hive绑定hbase" class="headerlink" title="hive绑定hbase"></a>hive绑定hbase</h3><p><strong>目标：</strong>建立Hive表，<strong>关联</strong>HBase表，插入数据到Hive表的同时能够影响HBase表。</p>
<p><strong>分步实现：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> hive_hbase_emp_table(</span><br><span class="line">empno <span class="built_in">int</span>,</span><br><span class="line">ename <span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">STORED</span> <span class="keyword">BY</span> <span class="string">&#x27;org.apache.hadoop.hive.hbase.HBaseStorageHandler&#x27;</span></span><br><span class="line"><span class="keyword">WITH</span> SERDEPROPERTIES (<span class="string">&quot;hbase.columns.mapping&quot;</span> = <span class="string">&quot;:key,info:ename&quot;</span>)</span><br><span class="line">TBLPROPERTIES (<span class="string">&quot;hbase.table.name&quot;</span> = <span class="string">&quot;hbase_emp_table&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>提示：完成之后，可以分别进入Hive和HBase查看，都生成了对应的表</p>
<p><strong>2.在Hive中创建临时中间表，用于load文件中的数据</strong></p>
<p><font color="red"><strong>提示：不能将数据直接load进Hive所关联HBase的那张表中</strong></font></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> emp(</span><br><span class="line">empno <span class="built_in">int</span>,</span><br><span class="line">ename <span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">hive&gt;</span><span class="bash"> load data <span class="built_in">local</span> inpath <span class="string">&#x27;/home/admin/softwares/data/emp.txt&#x27;</span> into table emp;</span></span><br></pre></td></tr></table></figure>

<p><strong>3.通过tmp插入数据</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">hive&gt;</span><span class="bash"> insert into table hive_hbase_emp_table select * from emp;</span></span><br></pre></td></tr></table></figure>

<p><strong>4.分别查看hbase和hive的数据</strong></p>
<hr>
<h3 id="hive分析hbase"><a href="#hive分析hbase" class="headerlink" title="hive分析hbase"></a>hive分析hbase</h3><p><strong>hbase该表必须存在，否则报错(内部表不必在hbase中先创建)</strong></p>
<p><strong>1. 在Hive中创建外部表</strong></p>
<p>为什么是外部表，因为此时两张表绑定了，如果是普通表hive删除hbase也没了。所以使用外部表的特性，来避免一些误删。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">EXTERNAL</span> <span class="keyword">TABLE</span> relevance_hbase_emp(</span><br><span class="line">empno <span class="built_in">int</span>,</span><br><span class="line">ename <span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">STORED</span> <span class="keyword">BY</span> </span><br><span class="line"><span class="string">&#x27;org.apache.hadoop.hive.hbase.HBaseStorageHandler&#x27;</span></span><br><span class="line"><span class="keyword">WITH</span> SERDEPROPERTIES (<span class="string">&quot;hbase.columns.mapping&quot;</span> = </span><br><span class="line"><span class="string">&quot;:key,info:ename&quot;</span>) </span><br><span class="line">TBLPROPERTIES (<span class="string">&quot;hbase.table.name&quot;</span> = <span class="string">&quot;hbase_emp_table&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>2. 关联后就可以使用Hive函数进行一些分析操作了</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (default)&gt; select * from relevance_hbase_emp;</span><br></pre></td></tr></table></figure>

<h1 id="HBase优化"><a href="#HBase优化" class="headerlink" title="HBase优化"></a>HBase优化</h1><h2 id="高可用"><a href="#高可用" class="headerlink" title="高可用"></a>高可用</h2><p>在HBase中Hmaster负责监控RegionServer的生命周期，均衡RegionServer的负载。<strong>如果Hmaster挂掉了，那么整个HBase集群将陷入不健康的状态，并且此时的工作状态并不会维持太久。</strong>所以HBase支持对Hmaster的高可用配置。</p>
<p>陷入不健康的状态之后一些操作还可以正常运行，例如：<code>scan</code>、<code>put</code>，因为这些命令一般不需要HMaster参与，除非Region过大拆分时，需要HMaster参与。</p>
<p>持对Hmaster的高可用配置。就是设置多个HMaster节点，待Avtice挂了后，后面的补上。</p>
<p><strong>操作步骤</strong></p>
<ol>
<li>关闭Hbase集群</li>
<li>在conf目录下创建<code>backup-masters</code>文件</li>
<li>在<code>backup-masters</code>文件中配置高可用HMaster节点</li>
<li>分发到其他节点</li>
<li>开启HBase集群</li>
</ol>
<h2 id="预分区🔺"><a href="#预分区🔺" class="headerlink" title="预分区🔺"></a>预分区🔺</h2><p><strong>提出</strong></p>
<p>当创建一个表的时候默认会把表的数据全部存储在一个region中，这个region存储rowkey的范围是负无穷到正无穷。当不断的向这个region中存储数据达到一定地步时(第一次默认256M)，会将这个region根据当前数据计算出middle key切分成2个region，这2个region分别存储负无穷-middle key和middle key-正无穷的数据。</p>
<p>这样当数据撑满时在切分性能不好。我们可以在新建表的时候就对数据进行分析，来决定它占用多少个Region(分区)</p>
<hr>
<p>每一个region维护着startRow与endRowKey，如果加入的数据符合某个region维护的rowKey范围，则该数据交给这个region维护。那么依照这个原则，我们可以将数据所要投放的分区提前大致的规划好，以提高HBase性能。</p>
<p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/HBase-partiton.png" alt="HBase-partiton"></p>
<h3 id="指定分区"><a href="#指定分区" class="headerlink" title="指定分区"></a>指定分区</h3><p>指定分区不需要直接直接分区的个数，只需要指出分区键(以哪些rowkey分区)，例如上图中bcd就是分区键，它将rowkey范围划分成了两段。</p>
<p><strong>shell</strong></p>
<p>例如，使用以下命令来手动设定预分区</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create &#x27;staff1&#x27;,&#x27;info&#x27;,&#x27;partition1&#x27;,SPLITS =&gt; [&#x27;1000&#x27;,&#x27;2000&#x27;,&#x27;3000&#x27;,&#x27;4000&#x27;]</span><br></pre></td></tr></table></figure>

<p>通过分区键：1000、2000、3000、4000创建了5个region，他们的region范围分别为：</p>
<p>。。。</p>
<p><strong>按照文件中设置的规则预分区</strong></p>
<p>创建splits.txt文件内容如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">aaaa</span><br><span class="line">bbbb</span><br><span class="line">cccc</span><br><span class="line">dddd</span><br></pre></td></tr></table></figure>

<p>然后执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create &#x27;staff3&#x27;,&#x27;partition3&#x27;,SPLITS_FILE =&gt; &#x27;splits.txt&#x27;</span><br></pre></td></tr></table></figure>

<p>即可，如果文件中不是有序的，程序会自动排序然后分区的</p>
<p><strong>使用API创建预分区</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//自定义算法，产生一系列Hash散列值存储在二维数组中</span></span><br><span class="line"><span class="keyword">byte</span>[][] splitKeys = 某个散列值函数</span><br><span class="line"><span class="comment">//创建HBaseAdmin实例</span></span><br><span class="line">HBaseAdmin hAdmin = <span class="keyword">new</span> HBaseAdmin(HBaseConfiguration.create());</span><br><span class="line"><span class="comment">//创建HTableDescriptor实例</span></span><br><span class="line">HTableDescriptor tableDesc = <span class="keyword">new</span> HTableDescriptor(tableName);</span><br><span class="line"><span class="comment">//通过HTableDescriptor实例和散列值二维数组创建带有预分区的HBase表</span></span><br><span class="line">hAdmin.createTable(tableDesc, splitKeys);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="分区案例"><a href="#分区案例" class="headerlink" title="分区案例"></a>分区案例</h3><p>分区键的预分区中每个分区存储的rowkey范围要和rowkey的设计要对应的。假如，我们想分三个区：0，1，2。<font color="red">然后将大量的rowkey打散后均匀的放入到这三个分区之中，0开头的rowkey要放入0分区，其余的也是如此。</font></p>
<p><strong>分区</strong></p>
<p>首先，我们应该先开始建表，创建预分区。此时应该想分区键应该如何设置，因为最终想要三个分区，所以我们需要两个分区键。乍一想我们可以用0,1作为分区键。</p>
<p>但是这样形成的分区分别分：负无穷-0，0-1，1-正无穷。可得知0开头的rowkey是放入不到0分区的，因为我们rowkey是通过字典顺序来进行匹配的，这时候我们在分区键012后面加上一个很大的ascii 码<code>|</code>表示的字符就可以满足0开头的rowkey放入0分区(需保证0开头的rowkey的第二个字符小于<code>|</code>)。</p>
<p>所以最终决定我们的分区键分别为：0|、1|、2|。</p>
<p><strong>rowkey设计</strong></p>
<p>因为要把rowkey加上0或1或2的前缀，又要保证rowkey的数据均匀的分布在三个分区之中，所以我们要根据rowkey本身的值来确定它的前缀(属于哪个分区)。</p>
<p>这就是分区策略。</p>
<p>分区策略有很多地方可以参考：<code>Kafka</code>的生产者分区策略、HashMap的数据存放。</p>
<ul>
<li>Kafka的topic分区是可以手动设置个数的</li>
<li>HashMap的容量是固定死的，开始16。然后每次扩容为之前的两倍。<strong>2的n次方</strong></li>
</ul>
<p>我们可以同时参考下面的分区方式。当分区数为2的n次方时，采用按位与；不是时，采用取余数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">genRowKeyNum</span><span class="params">(String rowKey, <span class="keyword">int</span> regionNum)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> hashCode = rowKey.hashCode();</span><br><span class="line">    <span class="keyword">int</span> region;</span><br><span class="line">    <span class="keyword">if</span> (regionNum &gt; <span class="number">0</span> &amp;&amp; (regionNum &amp; (regionNum - <span class="number">1</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">        region = hashCode &amp; (regionNum - <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        region = hashCode % regionNum;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> region + <span class="string">&quot;_&quot;</span> + rowKey;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="HashMapd的分区策略"><a href="#HashMapd的分区策略" class="headerlink" title="HashMapd的分区策略"></a>HashMapd的分区策略</h4><p>当初始化一个HashMap时，默认容量是16。众所周知，HashMap的本质就是数据+链表/红黑树。向其中添加数据时，数据添加到数组的哪一个位置。这就是一个分区问题。</p>
<p>HashMap是使用hash算法+位运算来实现的。通过Hash算法将值算出一个唯一的码，然后将这个码和（容量-1）来进行位运算，得出的结果肯定是0-15之间的一个数据，这样分区就完成了。</p>
<p>位运算的计算</p>
<p>因为15的二进制为<code>00001111</code>，这样如果一个其他数据和15按位与，<strong>只有最低四位有可能不为0</strong>，所以最后的答案肯定是0-15之间</p>
<p>如果不是15是其他的数子，例如10：<code>0001010</code>这样只有2，4位的数字有可能不为0，这样最后的结果只有4个答案。这样不行，太浪费位置了，假如有10的容量，最后只能用到4个格子。</p>
<p>所以如果使用按位与来计算分区的话，容量-1必须是最后几位是连续的1，这就导致它的十进制必须是2的n次方。<font color="red">所以为什么HashMap的容量必须是2的n次方，因为它用按位与来计算分区。同时位运算比较快。</font></p>
<hr>
<p><strong>同时记录一下如何判断一个数是不是2的n次方？</strong></p>
<p>思路一：</p>
<p>递归除以2，最终结果为1。效率太低</p>
<p>思路二：</p>
<p>将值打成二进制，查看有几个1位</p>
<p>思路三：推荐</p>
<p>2的n次方的所有值的二进制的特点<code>...000100...</code></p>
<p>而2的n次方-1的值的二进制特点<code>....00000111111...</code></p>
<p>如果两者按位与，答案肯定是0。所以这就是判断方法。</p>
<h4 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h4><p>分区原则：</p>
<ol>
<li>指明 partition 的情况下，直接将指明的值直接作为 partiton 值</li>
<li>没有指明 partition 值但有 key 的情况下，将 key 的 hash 值与 topic 的 partition 数进行取余得到 partition 值；</li>
<li>既没有 partition 值又没有 key 值的情况下，第一次调用时随机生成一个整数（后面每次调用在这个整数上自增），将这个值与 topic 可用的 partition 总数取余得到 partition 值，**也就是常说的 round-robin 算法(轮询)**。</li>
</ol>
<p>由此得知，因为Kafka的分区数是手动指定的，不是2的n次方，所以不能使用位运算。所以它使用的是取余数。</p>
<h2 id="RowKey设计🔺"><a href="#RowKey设计🔺" class="headerlink" title="RowKey设计🔺"></a>RowKey设计🔺</h2><p>一条数据的唯一标识就是rowkey，那么这条数据存储于哪个分区，取决于rowkey处于哪个一个预分区的区间内，<strong>设计rowkey的主要目的 ，就是让数据均匀的分布于所有的region中</strong>，<strong>在一定程度上防止数据倾斜</strong>。接下来我们就谈一谈rowkey常用的设计方案。</p>
<p><strong>Rowkey设计时需要遵循三大原则</strong></p>
<h3 id="唯一性"><a href="#唯一性" class="headerlink" title="唯一性"></a>唯一性</h3><p>rowkey在设计上保证其唯一性。rowkey是按照字典顺序排序存储的，因此，设计rowkey的时候，要充分利用这个排序的特点，<strong>将经常读取的数据存储到一块，将最近可能会被访问的数据放到一块。</strong></p>
<p>这时就要看业务了，有时需要<strong>将经常读取的数据存储到一块，将最近可能会被访问的数据放到一块。</strong>；有时需要<strong>让数据均匀的分布于所有的region中</strong>，<strong>在一定程度上防止数据倾斜</strong></p>
<h3 id="长度原则"><a href="#长度原则" class="headerlink" title="长度原则"></a>长度原则</h3><p>rowkey是一个二进制码流，可以是任意字符串，最大长度 64kb ，实际应用中一般为10-100bytes，以byte[] 形式保存，一般设计成定长。<strong>建议越短越好，不要超过16个字节</strong>，原因如下：数据的持久化文件HFile中是按照KeyValue存储的，如果rowkey过长，比如超过100字节，1000w行数据，光rowkey就要占用100*1000w=10亿个字节，将近1G数据，这样会极大影响HFile的存储效率；MemStore将缓存部分数据到内存，如果rowkey字段过长，内存的有效利用率就会降低，系统不能缓存更多的数据，这样会降低检索效率。</p>
<h3 id="散列原则"><a href="#散列原则" class="headerlink" title="散列原则"></a>散列原则</h3><p>如果rowkey按照时间戳的方式递增，不要将时间放在二进制码的前面，建议将rowkey的高位作为散列字段，由程序随机生成，低位放时间字段，这样将提高数据均衡分布在每个RegionServer，以实现负载均衡的几率。如果没有散列字段，首字段直接是时间信息，所有的数据都会集中在一个RegionServer上，这样在数据检索的时候负载会集中在个别的RegionServer上，造成热点问题，会降低查询效率</p>
<p>可以使用的方式有：加盐、哈希、时间戳反转</p>
<h2 id="基础优化"><a href="#基础优化" class="headerlink" title="基础优化"></a>基础优化</h2><p><strong>允许在HDFS的文件中追加内容</strong></p>
<p>hdfs-site.xml、hbase-site.xml</p>
<p>属性：dfs.support.append</p>
<p>解释：开启HDFS追加同步，可以优秀的配合HBase的数据同步和持久化。默认值为true。</p>
<p><strong>优化DataNode允许的最大文件打开数</strong></p>
<p>hdfs-site.xml</p>
<p>属性：dfs.datanode.max.transfer.threads</p>
<p>解释：HBase一般都会同一时间操作大量的文件，根据集群的数量和规模以及数据动作，设置为4096或者更高。默认值：4096</p>
<p><strong>优化延迟高的数据操作的等待时间</strong></p>
<p>hdfs-site.xml</p>
<p>属性：dfs.image.transfer.timeout  解释：如果对于某一次数据操作来讲，延迟非常高，socket需要等待更长的时间，建议把该值设置为更大的值（默认60000毫秒），以确保socket不会被timeout掉。  </p>
<p><strong>优化数据的写入效率</strong></p>
<p>mapred-site.xml</p>
<p> 属性：  mapreduce.map.output.compress  mapreduce.map.output.compress.codec  解释：开启这两个数据可以大大提高文件的写入效率，减少写入时间。第一个属性值修改为true，第二个属性值修改为：org.apache.hadoop.io.compress.GzipCodec或者其他压缩方式。  </p>
<p><strong>设置RPC监听数量</strong></p>
<p>hbase-site.xml</p>
<p>属性：hbase.regionserver.handler.count  解释：默认值为30，用于指定RPC监听的数量，可以根据客户端的请求数进行调整，读写请求较多时，增加此值。  </p>
<p><strong>优化HStore文件大小</strong></p>
<p>hbase-site.xml</p>
<p>属性：hbase.hregion.max.filesize  解释：默认值10737418240（10GB），如果需要运行HBase的MR任务，可以减小此值，因为一个region对应一个map任务，如果单个region过大，会导致map任务执行时间过长。该值的意思就是，如果HFile的大小达到这个数值，则这个region会被切分为两个Hfile。  </p>
<p><strong>指定scan.next扫描HBase所获取的行数</strong></p>
<p>hbase-site.xml</p>
<p>属性：hbase.client.scanner.caching  解释：用于指定scan.next方法获取的默认行数，值越大，消耗内存越大。  </p>
<p><strong>flush、compact、split机制🔺</strong></p>
<p>当MemStore达到阈值，将Memstore中的数据Flush进Storefile；compact机制则是把flush出来的小文件合并成大的Storefile文件。split则是当Region达到阈值，会把过大的Region一分为二。</p>
<p><strong>涉及属性：</strong></p>
<p>即：128M就是Memstore的默认阈值</p>
<p><code>hbase.hregion.memstore.flush.size：134217728  </code></p>
<p>即：这个参数的作用是当单个HRegion内所有的Memstore大小总和超过指定值时，flush该HRegion的所有memstore。RegionServer的flush是通过将请求添加一个队列，模拟生产消费模型来异步处理的。那这里就有一个问题，当队列来不及消费，产生大量积压请求时，可能会导致内存陡增，最坏的情况是触发OOM。</p>
<p> <code>hbase.regionserver.global.memstore.upperLimit：0.4  hbase.regionserver.global.memstore.lowerLimit：0.38 </code></p>
<p>即：当MemStore使用内存<strong>总量达到</strong>hbase.regionserver.global.memstore.upperLimit指定值时，将会有多个MemStores flush到文件中，MemStore flush 顺序是按照大小降序执行的，直到刷新到MemStore使用内存略小于lowerLimit</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p><strong>Hbase,hive和redis的区别</strong></p>
<p>Hive基于MR程序，将HQL转换为MR执行。效率比较低，不适合实时数据访问</p>
<p>Hbase基于Hadoop数据存储，存储海量数据，而且拥有自己的查询操作应用场景</p>
<p>Redis是一个基于内存的缓存数据库</p>
<p><strong>scan和get功能以及实现的异同</strong></p>
<p>都是查询数据，一个扫描所有RowKey(指定条件)、一个单独找一个rowKey</p>
<hr>
<p><a target="_blank" rel="noopener" href="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/word/HBase-word.docx">HBase-word</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Xiangjie</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://awslzhang.top/2020/07/08/Hbase%E4%BB%8B%E7%BB%8D/">https://awslzhang.top/2020/07/08/Hbase%E4%BB%8B%E7%BB%8D/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://awslzhang.top" target="_blank">zxj</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Hadoop/">Hadoop</a></div><div class="post_share"><div class="social-share" data-image="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Hbase-cover.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/07/14/Sqoop%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/"><img class="prev-cover" src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/sqoop-logo.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Sqoop的简单使用</div></div></a></div><div class="next-post pull-right"><a href="/2020/07/05/Kafka%E8%AF%A6%E8%A7%A3/"><img class="next-cover" src="https://i.loli.net/2020/07/05/Xc9mzHTwqQO2J1L.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Kafka详解</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/07/15/Oozie调度/" title="Oozie调度"><img class="cover" src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Oozie-logo.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-15</div><div class="title">Oozie调度</div></div></a></div><div><a href="/2020/07/14/Sqoop的简单使用/" title="Sqoop的简单使用"><img class="cover" src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/sqoop-logo.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-14</div><div class="title">Sqoop的简单使用</div></div></a></div><div><a href="/2020/07/04/Flume基本使用/" title="Flume基本使用"><img class="cover" src="https://i.loli.net/2020/07/04/FjyZ6DdUigWebJn.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-04</div><div class="title">Flume基本使用</div></div></a></div><div><a href="/2020/06/22/HDFS概述/" title="HDFS概述"><img class="cover" src="https://i.loli.net/2020/06/22/xIQlAhrgUHqSa27.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-06-22</div><div class="title">HDFS概述</div></div></a></div><div><a href="/2020/06/22/Hadoop编译安装/" title="Hadoop编译安装"><img class="cover" src="https://i.loli.net/2020/06/22/Wb7kUVafmZSOudC.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-06-22</div><div class="title">Hadoop编译安装</div></div></a></div><div><a href="/2020/06/26/MapReduce原理/" title="MapReduce原理"><img class="cover" src="https://i.loli.net/2020/06/27/2xbLZqNQKHGoUu1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-06-26</div><div class="title">MapReduce原理</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/null" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Xiangjie</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">85</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">43</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">25</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/XiangJie-Zhang" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:qluzxj@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#HBase%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">HBase简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFHBase"><span class="toc-number">1.1.</span> <span class="toc-text">什么是HBase</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HBase%E7%89%B9%E7%82%B9"><span class="toc-number">1.2.</span> <span class="toc-text">HBase特点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E6%8F%90%E5%87%BAHBase"><span class="toc-number">1.3.</span> <span class="toc-text">为什么提出HBase</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL%E4%BC%98%E5%8C%96%F0%9F%94%BA"><span class="toc-number">1.3.1.</span> <span class="toc-text">MySQL优化🔺</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E6%97%B6%E4%BC%98%E5%8C%96%E4%B8%8A%E8%BF%B0%E4%B8%89%E4%B8%AA%E9%97%AE%E9%A2%98"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">同时优化上述三个问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL%E4%B8%8EHBase"><span class="toc-number">1.3.2.</span> <span class="toc-text">MySQL与HBase</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HBase%E7%BB%93%E6%9E%84%F0%9F%94%BA"><span class="toc-number">2.</span> <span class="toc-text">HBase结构🔺</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Client"><span class="toc-number">2.1.</span> <span class="toc-text">Client</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Zookeeper"><span class="toc-number">2.2.</span> <span class="toc-text">Zookeeper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HMaster"><span class="toc-number">2.3.</span> <span class="toc-text">HMaster</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HRegionServer"><span class="toc-number">2.4.</span> <span class="toc-text">HRegionServer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E7%BB%84%E4%BB%B6"><span class="toc-number">2.5.</span> <span class="toc-text">其他组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Write-Ahead-logs"><span class="toc-number">2.5.1.</span> <span class="toc-text">Write-Ahead logs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Region"><span class="toc-number">2.5.2.</span> <span class="toc-text">Region</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Store"><span class="toc-number">2.5.3.</span> <span class="toc-text">Store</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MemStore"><span class="toc-number">2.5.4.</span> <span class="toc-text">MemStore</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HFile"><span class="toc-number">2.5.5.</span> <span class="toc-text">HFile</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HBase%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%F0%9F%94%BA"><span class="toc-number">3.</span> <span class="toc-text">HBase数据结构🔺</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#rowkey"><span class="toc-number">3.1.</span> <span class="toc-text">rowkey</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Colum-Family"><span class="toc-number">3.2.</span> <span class="toc-text">Colum Family</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Cell"><span class="toc-number">3.3.</span> <span class="toc-text">Cell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Time-Stamp"><span class="toc-number">3.4.</span> <span class="toc-text">Time Stamp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="toc-number">3.5.</span> <span class="toc-text">命名空间</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HBase%E5%8E%9F%E7%90%86%F0%9F%94%BA"><span class="toc-number">4.</span> <span class="toc-text">HBase原理🔺</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BB%E6%B5%81%E7%A8%8B"><span class="toc-number">4.1.</span> <span class="toc-text">读流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E6%B5%81%E7%A8%8B"><span class="toc-number">4.2.</span> <span class="toc-text">写流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AEflush%E8%BF%87%E7%A8%8B"><span class="toc-number">4.3.</span> <span class="toc-text">数据flush过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%90%88%E5%B9%B6%E8%BF%87%E7%A8%8B"><span class="toc-number">4.4.</span> <span class="toc-text">数据合并过程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HBase%E5%AE%89%E8%A3%85"><span class="toc-number">5.</span> <span class="toc-text">HBase安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#HBase%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">5.1.</span> <span class="toc-text">HBase配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">5.2.</span> <span class="toc-text">遇到的问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HBase-Shell"><span class="toc-number">6.</span> <span class="toc-text">HBase Shell</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-number">6.1.</span> <span class="toc-text">基本操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A8%E7%9A%84%E6%93%8D%E4%BD%9C%F0%9F%94%BA"><span class="toc-number">6.2.</span> <span class="toc-text">表的操作🔺</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4-1"><span class="toc-number">6.3.</span> <span class="toc-text">命名空间</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HBase%E7%A8%8B%E5%BA%8F"><span class="toc-number">7.</span> <span class="toc-text">HBase程序</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#HBase-API"><span class="toc-number">7.1.</span> <span class="toc-text">HBase API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96pom"><span class="toc-number">7.1.1.</span> <span class="toc-text">依赖pom</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E7%B1%BB%F0%9F%94%BA"><span class="toc-number">7.1.2.</span> <span class="toc-text">操作类🔺</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E"><span class="toc-number">7.1.3.</span> <span class="toc-text">说明</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HBase%E9%9B%86%E6%88%90MapReduce%F0%9F%94%BA"><span class="toc-number">7.2.</span> <span class="toc-text">HBase集成MapReduce🔺</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E8%AE%BE%E7%BD%AE"><span class="toc-number">7.2.1.</span> <span class="toc-text">环境设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%BC%80%E5%8F%91"><span class="toc-number">7.2.2.</span> <span class="toc-text">代码开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%B8%80"><span class="toc-number">7.2.3.</span> <span class="toc-text">案例一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%BA%8C"><span class="toc-number">7.2.4.</span> <span class="toc-text">案例二</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%B8%89"><span class="toc-number">7.2.5.</span> <span class="toc-text">案例三</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HBase%E5%8D%8F%E5%A4%84%E7%90%86%E5%99%A8%F0%9F%94%BA"><span class="toc-number">8.</span> <span class="toc-text">HBase协处理器🔺</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%8F%E5%A4%84%E7%90%86%E5%99%A8%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">8.1.</span> <span class="toc-text">协处理器的使用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HBase%E9%9B%86%E6%88%90Hive%F0%9F%94%BA"><span class="toc-number">9.</span> <span class="toc-text">HBase集成Hive🔺</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#HBase%E4%B8%8EHive%E7%9A%84%E5%AF%B9%E6%AF%94"><span class="toc-number">9.1.</span> <span class="toc-text">HBase与Hive的对比</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%88%E6%9C%AC%E5%86%B2%E7%AA%81"><span class="toc-number">9.2.</span> <span class="toc-text">版本冲突</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E6%88%90%E4%BD%BF%E7%94%A8"><span class="toc-number">9.3.</span> <span class="toc-text">集成使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#hive%E7%9A%84%E4%BF%AE%E6%94%B9"><span class="toc-number">9.3.1.</span> <span class="toc-text">hive的修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hive%E7%BB%91%E5%AE%9Ahbase"><span class="toc-number">9.3.2.</span> <span class="toc-text">hive绑定hbase</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hive%E5%88%86%E6%9E%90hbase"><span class="toc-number">9.3.3.</span> <span class="toc-text">hive分析hbase</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HBase%E4%BC%98%E5%8C%96"><span class="toc-number">10.</span> <span class="toc-text">HBase优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">10.1.</span> <span class="toc-text">高可用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%84%E5%88%86%E5%8C%BA%F0%9F%94%BA"><span class="toc-number">10.2.</span> <span class="toc-text">预分区🔺</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E5%88%86%E5%8C%BA"><span class="toc-number">10.2.1.</span> <span class="toc-text">指定分区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%8C%BA%E6%A1%88%E4%BE%8B"><span class="toc-number">10.2.2.</span> <span class="toc-text">分区案例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#HashMapd%E7%9A%84%E5%88%86%E5%8C%BA%E7%AD%96%E7%95%A5"><span class="toc-number">10.2.2.1.</span> <span class="toc-text">HashMapd的分区策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Kafka"><span class="toc-number">10.2.2.2.</span> <span class="toc-text">Kafka</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RowKey%E8%AE%BE%E8%AE%A1%F0%9F%94%BA"><span class="toc-number">10.3.</span> <span class="toc-text">RowKey设计🔺</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%94%AF%E4%B8%80%E6%80%A7"><span class="toc-number">10.3.1.</span> <span class="toc-text">唯一性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%95%BF%E5%BA%A6%E5%8E%9F%E5%88%99"><span class="toc-number">10.3.2.</span> <span class="toc-text">长度原则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%A3%E5%88%97%E5%8E%9F%E5%88%99"><span class="toc-number">10.3.3.</span> <span class="toc-text">散列原则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E4%BC%98%E5%8C%96"><span class="toc-number">10.4.</span> <span class="toc-text">基础优化</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">11.</span> <span class="toc-text">总结</span></a></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/01/10/Api%E5%92%8CSQL/" title="Api和SQL"><img src="https://flink.apache.org/img/flink-header-logo.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Api和SQL"/></a><div class="content"><a class="title" href="/2021/01/10/Api%E5%92%8CSQL/" title="Api和SQL">Api和SQL</a><time datetime="2021-01-10T03:51:40.000Z" title="发表于 2021-01-10 11:51:40">2021-01-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/01/02/Flink%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/" title="Flink状态编程和容错机制"><img src="https://flink.apache.org/img/flink-header-logo.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Flink状态编程和容错机制"/></a><div class="content"><a class="title" href="/2021/01/02/Flink%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/" title="Flink状态编程和容错机制">Flink状态编程和容错机制</a><time datetime="2021-01-02T10:06:02.000Z" title="发表于 2021-01-02 18:06:02">2021-01-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/23/Flink%E6%97%B6%E9%97%B4%E8%AF%AD%E4%B9%89%E5%92%8CWaterMark/" title="Flink的时间语义和watermark"><img src="https://flink.apache.org/img/flink-header-logo.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Flink的时间语义和watermark"/></a><div class="content"><a class="title" href="/2020/12/23/Flink%E6%97%B6%E9%97%B4%E8%AF%AD%E4%B9%89%E5%92%8CWaterMark/" title="Flink的时间语义和watermark">Flink的时间语义和watermark</a><time datetime="2020-12-23T10:59:07.000Z" title="发表于 2020-12-23 18:59:07">2020-12-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/17/Flink-API/" title="Flink Api学习"><img src="https://flink.apache.org/img/flink-header-logo.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Flink Api学习"/></a><div class="content"><a class="title" href="/2020/12/17/Flink-API/" title="Flink Api学习">Flink Api学习</a><time datetime="2020-12-17T12:36:28.000Z" title="发表于 2020-12-17 20:36:28">2020-12-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/17/ready/" title="ready!"><img src="https://images.pexels.com/photos/924824/pexels-photo-924824.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ready!"/></a><div class="content"><a class="title" href="/2020/12/17/ready/" title="ready!">ready!</a><time datetime="2020-12-16T16:02:06.000Z" title="发表于 2020-12-17 00:02:06">2020-12-17</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Xiangjie</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script></div></body></html>