<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>记一次调用FFmpeg处理视频 | zxj</title><meta name="keywords" content="FFmpeg"><meta name="author" content="Xiangjie"><meta name="copyright" content="Xiangjie"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="前言最近我司要做一个课程培训管理系统，其中有一项是对视频添加水印的功能。当我们提到与视频处理相关的操作时，想到的肯定是通过软件，例如Adobe Premiere Pro来手动实现视频编辑。但是，要实现将使用者上传的无水印视频变为含水印视频，是得借助代码的实现的。这时就要依靠开源工具FFmpeg了。">
<meta property="og:type" content="article">
<meta property="og:title" content="记一次调用FFmpeg处理视频">
<meta property="og:url" content="https://awslzhang.top/2020/05/23/%E8%AE%B0%E4%B8%80%E6%AC%A1%E8%B0%83%E7%94%A8FFmpeg%E5%A4%84%E7%90%86%E8%A7%86%E9%A2%91/index.html">
<meta property="og:site_name" content="zxj">
<meta property="og:description" content="前言最近我司要做一个课程培训管理系统，其中有一项是对视频添加水印的功能。当我们提到与视频处理相关的操作时，想到的肯定是通过软件，例如Adobe Premiere Pro来手动实现视频编辑。但是，要实现将使用者上传的无水印视频变为含水印视频，是得借助代码的实现的。这时就要依靠开源工具FFmpeg了。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2020/06/09/RO5Fb9ac84fBIlJ.jpg">
<meta property="article:published_time" content="2020-05-23T13:30:17.000Z">
<meta property="article:modified_time" content="2021-01-01T05:50:00.108Z">
<meta property="article:author" content="Xiangjie">
<meta property="article:tag" content="FFmpeg">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/06/09/RO5Fb9ac84fBIlJ.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://awslzhang.top/2020/05/23/%E8%AE%B0%E4%B8%80%E6%AC%A1%E8%B0%83%E7%94%A8FFmpeg%E5%A4%84%E7%90%86%E8%A7%86%E9%A2%91/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Xiangjie","link":"链接: ","source":"来源: zxj","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}

// https://stackoverflow.com/questions/16839698/jquery-getscript-alternative-in-native-javascript
const getScript = url => new Promise((resolve, reject) => {
  const script = document.createElement('script')
  script.src = url
  script.async = true
  script.onerror = reject
  script.onload = script.onreadystatechange = function() {
    const loadState = this.readyState
    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
    script.onload = script.onreadystatechange = null
    resolve()
  }
  document.head.appendChild(script)
})</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2021-01-01 13:50:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.0.2"><link rel="alternate" href="/atom.xml" title="zxj" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/null" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">84</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">43</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">25</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 目录</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://i.loli.net/2020/06/09/RO5Fb9ac84fBIlJ.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">zxj</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 目录</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">记一次调用FFmpeg处理视频</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-05-23T13:30:17.000Z" title="发表于 2020-05-23 21:30:17">2020-05-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-01-01T05:50:00.108Z" title="更新于 2021-01-01 13:50:00">2021-01-01</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">3.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>13分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近我司要做一个课程培训管理系统，其中有一项是对视频添加水印的功能。当我们提到与视频处理相关的操作时，想到的肯定是通过软件，例如<code>Adobe Premiere Pro</code>来手动实现视频编辑。但是，要实现将使用者上传的无水印视频变为含水印视频，是得借助代码的实现的。这时就要依靠开源工具<code>FFmpeg</code>了。</p>
<a id="more"></a>

<p>以下来自于Wiki百科</p>
<p><strong>FFmpeg</strong> is a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Free_and_open-source_software">free and open-source</a> project consisting of a vast software suite of <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Library_(computing)">libraries</a> and <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Computer_program">programs</a> for handling video, audio, and other <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Multimedia">multimedia</a> files and streams. At its core is the FFmpeg program itself, designed for <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Command-line_interface">command-line</a>-based processing of video and audio files, and widely used for format <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Transcoding">transcoding</a>, basic editing (trimming and <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Concatenation">concatenation</a>), <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Video_scaler">video scaling</a>, video <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Post-production">post-production</a> effects, and standards compliance (<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Society_of_Motion_Picture_and_Television_Engineers">SMPTE</a>, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/International_Telecommunication_Union">ITU</a>).</p>
<p>FFmpeg是一个免费的开源项目，由大量的库和程序组成，用于处理视频、音频和其他多媒体文件和流。其核心是FFmpeg程序本身，设计用于基于命令行的视频和音频文件处理，广泛用于格式转换、基本编辑(修剪和连接)、视频缩放、视频后期制作效果和标准遵从性(SMPTE、ITU)。</p>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><p>在我在百度上的初步了解之后，<code>FFmpeg</code>可以在视频中直接添加文字水印、或者添加图片水印。它还支持在特定是的时间段添加。由于我的需求是添加水印(为了追责)，所以我需要的是一直存在的水印。</p>
<p>通过在命令行执行<code>FFmpeg</code>的特定命令就可以实现我需要的操作。首先我在<code>cmd</code>命令行中测验了一下命令的有效性。然后就是怎么通过程序调用的问题了。</p>
<p>通过百度得知，可以使用Java的<code>java.lang.Process</code>类实现：</p>
<p><code>ProcessBuilder.start()</code> 和 <code>Runtime.exec</code> 方法创建一个本机进程，并返回 <code>Process</code> 子类的一个实例，该实例可用来控制进程并获得相关信息。<code>Process</code> 类提供了执行从进程输入、执行输出到进程、等待进程完成、检查进程的退出状态以及销毁（杀掉）进程的方法。<br>创建进程的方法可能无法针对某些本机平台上的特定进程很好地工作，比如，本机窗口进程，守护进程，Microsoft Windows 上的 Win16/DOS 进程，或者 shell 脚本。创建的子进程没有自己的终端或控制台。它的所有标准 io（即 stdin、stdout 和 stderr）操作都将通过三个流 (<code>getOutputStream()</code>、<code>getInputStream()</code> 和 <code>getErrorStream()</code>) 重定向到父进程。父进程使用这些流来提供到子进程的输入和获得从子进程的输出。因为有些本机平台仅针对标准输入和输出流提供有限的缓冲区大小，如果读写子进程的输出流或输入流迅速出现失败，则可能导致子进程阻塞，甚至产生死锁。<br>当没有 <code>Process</code> 对象的更多引用时，不是删掉子进程，而是继续异步执行子进程。<br>对于带有 <code>Process</code> 对象的 Java 进程，没有必要异步或并发执行由 <code>Process</code> 对象表示的进程。</p>
<h2 id="文字水印"><a href="#文字水印" class="headerlink" title="文字水印"></a>文字水印</h2><p>一开始我想要的格式就是这种，简单明了。</p>
<p><img src="https://i.loli.net/2020/05/23/lTVKZiUfk1WIMwP.png" alt="Snipaste_2020-05-23_22-09-50"></p>
<h3 id="FFmpeg命令"><a href="#FFmpeg命令" class="headerlink" title="FFmpeg命令"></a>FFmpeg命令</h3><p>于是我就直接开始实现了，首先贴出可以执行的<code>FFmpeg</code>代码</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input.mp4 -vf &quot;drawtext=fontfile=simhei.ttf: text=‘技术是第一生产力’:x=<span class="number">10</span>:y=<span class="number">10</span>:fontsize=<span class="number">24</span>:fontcolor=white:shadowy=<span class="number">2</span>&quot; output.mp4</span><br></pre></td></tr></table></figure>

<p>参数解析：</p>
<ol>
<li><code>-i</code>：一般表示输入</li>
<li><code>-vf </code>：滤镜相关，视频裁剪，水印等等操作都需要它完成</li>
<li><code>drawtext</code>：文字水印相关内容</li>
<li><code>output.mp4</code>：视频输出</li>
</ol>
<h3 id="Java调用"><a href="#Java调用" class="headerlink" title="Java调用"></a>Java调用</h3><p>通过上述简单描述的<code>java.lang.Process</code>来实现调用<code>FFmpeg</code>来执行命令，代码如下(是放在Linux中执行的)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoUtils</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addWaterToVideo</span><span class="params">(String ffmpegExePath, String inputFilePath, String outputFilePath, String waterMark)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 构造命令</span></span><br><span class="line">        List&lt;String&gt; commond = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        commond.add(ffmpegExePath); <span class="comment">// &quot;/usr/local/ffmpeg2/bin/./ffmpeg&quot;</span></span><br><span class="line">        commond.add(<span class="string">&quot;-i&quot;</span>);</span><br><span class="line">        commond.add(inputFilePath); <span class="comment">// .../input.mp4</span></span><br><span class="line">        commond.add(<span class="string">&quot;-vf&quot;</span>);</span><br><span class="line">        commond.add(String.format(<span class="string">&quot;drawtext=fontfile=simhei.ttf: &quot;</span> +</span><br><span class="line">                <span class="string">&quot;text=‘%s’:x=10:y=10:fontsize=24:fontcolor=white:shadowy=2&quot;</span>, waterMark));</span><br><span class="line">        commond.add(outputFilePath); <span class="comment">// output.mp4</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Process videoProcess = <span class="keyword">new</span> ProcessBuilder(commond).start();</span><br><span class="line">            dealStream(videoProcess);</span><br><span class="line">            videoProcess.waitFor();<span class="comment">// 使用后，在FFmpeg命令执行完毕前，此主线程一直阻塞。垦局需求调用</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;视频转换成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开启线程处理Ffmpeg处理流，防止资源死锁</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> process</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dealStream</span><span class="params">(Process process)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (process == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 处理InputStream的线程</span></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            BufferedReader in = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(process.getInputStream()));</span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> ((line = in.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    log.warn(<span class="string">&quot;output: &quot;</span> + line);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    in.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="comment">// 处理ErrorStream的线程</span></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            BufferedReader err = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(process.getErrorStream()));</span><br><span class="line">            String line = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> ((line = err.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    log.warn(<span class="string">&quot;output: &quot;</span> + line);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    err.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过上面的程序我们可以看出：</p>
<ol>
<li>通过<code>List</code>来构造命令，不需要空格</li>
<li>通过<code>Process</code>来执行命令</li>
<li>通过<code>dealStream</code>来处理命令返回值</li>
</ol>
<p>这个为视频添加水印的功能就完成了。</p>
<hr>
<p>然而，给客户爸爸看的时候，他们嫌弃这种水印太简单了，想要那种全屏水印，类似于下面这种：</p>
<p><img src="https://i.loli.net/2020/05/23/8hzIsEQmX3jZRaV.png" alt="Snipaste_2020-05-23_22-56-29"></p>
<p>这样可难道我了，因为文字水印<code>drawtext</code>，我查了一下他可以设置的有：</p>
<ol>
<li>fontcolor：文字颜色</li>
<li>fontsize：字体大小</li>
<li>fontfile：字体文件</li>
<li>text：加入文字的内容(text and textfile不能同时存在)</li>
<li>textfile：加入文字的文件(text and textfile不能同时存在)</li>
<li>x=0:y=100 在什么坐标加文字</li>
</ol>
<p>已知，没有使字体倾斜的方法。所以，<strong>文字水印，OUT！！！</strong></p>
<h2 id="图片水印"><a href="#图片水印" class="headerlink" title="图片水印"></a>图片水印</h2><p>上面讲到文字水印不能实现效果，所以我想设置一张比较大的图片，通过Java程序将图片修改为含有大部分倾斜水印的形式，这样通过Java还是很好实现的。然后，通过图片水印的方式加入到视频，就能实现以上效果！</p>
<h3 id="FFmpeg命令-1"><a href="#FFmpeg命令-1" class="headerlink" title="FFmpeg命令"></a>FFmpeg命令</h3><p><code>ffmpeg -i input.mp4 -i logo.png -filter_complex overlay=5:5 output.mp4</code></p>
<h3 id="Java实现"><a href="#Java实现" class="headerlink" title="Java实现"></a>Java实现</h3><h4 id="处理图片"><a href="#处理图片" class="headerlink" title="处理图片"></a>处理图片</h4><p>首先，我们需要一些东西：一张纯白背景图片(1920*1080，因为大部分电脑是这个分辨率)、纯白色图片去背景后形成的无背景图片。</p>
<p>如果没懂的话，请看白色背景图片和无背景图片的对比：</p>
<p><img src="https://i.loli.net/2020/05/23/lHAJRBtIVskzrQN.png" alt="Snipaste_2020-05-23_23-19-55"></p>
<p>通过以下代码实现将无背景图片变为指定水印格式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageUtils</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Integer DEGRE = <span class="number">45</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Float ALPHA = <span class="number">0.8F</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 给图片添加水印文字、可设置水印文字的旋转角度</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> waterMark    要写入的文字</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> srcImgPath   源图片路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newImagePath 新图片路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fontsize     字体大小</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> color        字体颜色</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileExt      图片后缀</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">markImageByText</span><span class="params">(String srcImgPath, String newImagePath, Integer fontsize,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       Color color, String fileExt, String waterMark)</span> </span>&#123;</span><br><span class="line">        InputStream is = <span class="keyword">null</span>;</span><br><span class="line">        OutputStream os = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1、源图片</span></span><br><span class="line">            java.awt.Image srcImg = ImageIO.read(<span class="keyword">new</span> File(srcImgPath));</span><br><span class="line">            BufferedImage buffImg = <span class="keyword">new</span> BufferedImage(srcImg.getWidth(<span class="keyword">null</span>),</span><br><span class="line">                    srcImg.getHeight(<span class="keyword">null</span>), BufferedImage.TYPE_INT_RGB);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2、得到画笔对象</span></span><br><span class="line">            <span class="comment">// 有效的解决背景发生变化的问题----------------</span></span><br><span class="line">            Graphics2D g = buffImg.createGraphics();</span><br><span class="line">            buffImg = g.getDeviceConfiguration().createCompatibleImage(srcImg.getWidth(<span class="keyword">null</span>),</span><br><span class="line">                    srcImg.getHeight(<span class="keyword">null</span>), Transparency.TRANSLUCENT);</span><br><span class="line">            g.dispose();</span><br><span class="line">            g = buffImg.createGraphics();</span><br><span class="line">            <span class="comment">// 解决背景发生变化的问题----------------</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3、设置对线段的锯齿状边缘处理</span></span><br><span class="line">            g.setRenderingHint(RenderingHints.KEY_INTERPOLATION,</span><br><span class="line">                    RenderingHints.VALUE_INTERPOLATION_BILINEAR);</span><br><span class="line">            <span class="comment">// 4、把原图画到新画板上</span></span><br><span class="line">            g.drawImage(srcImg.getScaledInstance(srcImg.getWidth(<span class="keyword">null</span>), srcImg.getHeight(<span class="keyword">null</span>),</span><br><span class="line">                    java.awt.Image.SCALE_SMOOTH), <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">// 5、设置水印文字颜色</span></span><br><span class="line">            g.setColor(color);</span><br><span class="line">            <span class="comment">// 6、设置水印文字Font</span></span><br><span class="line">            Font font = <span class="keyword">new</span> Font(<span class="string">&quot;新宋体&quot;</span>, Font.BOLD, fontsize);</span><br><span class="line">            g.setFont(font);</span><br><span class="line">            <span class="comment">// 7、设置水印文字透明度  必须要用AlphaComposite.SRC_OVER</span></span><br><span class="line">            g.rotate(Math.toRadians(DEGRE));<span class="comment">//设置水印旋转</span></span><br><span class="line">            g.setComposite(AlphaComposite.getInstance(AlphaComposite.SRC_OVER, ALPHA));</span><br><span class="line">            <span class="comment">// 8、循环打上多个水印</span></span><br><span class="line">            JLabel jLabel = <span class="keyword">new</span> JLabel(waterMark);</span><br><span class="line">            FontMetrics fontMetrics = jLabel.getFontMetrics(font);</span><br><span class="line">            <span class="keyword">int</span> width = fontMetrics.stringWidth(jLabel.getText()); <span class="comment">// 文字水印宽度</span></span><br><span class="line">            <span class="keyword">int</span> rowsNum = srcImg.getHeight(<span class="keyword">null</span>) / width; <span class="comment">// 图片的高/文字水印宽度，得到打印多少行水印</span></span><br><span class="line">            <span class="keyword">int</span> columnsNum = srcImg.getWidth(<span class="keyword">null</span>) / width;</span><br><span class="line">            <span class="comment">// 防止图片太小水印太长，保证至少打印一次</span></span><br><span class="line">            <span class="keyword">if</span> (rowsNum &lt; <span class="number">1</span>) &#123;</span><br><span class="line">                rowsNum = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (columnsNum &lt; <span class="number">1</span>) &#123;</span><br><span class="line">                columnsNum = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> m = <span class="number">0</span>; m &lt; rowsNum; m++) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>; p &lt; columnsNum; p++) &#123;</span><br><span class="line">                    g.drawString(waterMark, m * width + p * width, -p * width + m * width);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 9、释放资源</span></span><br><span class="line">            g.dispose();</span><br><span class="line">            <span class="comment">// 10、生成图片</span></span><br><span class="line">            os = <span class="keyword">new</span> FileOutputStream(newImagePath);</span><br><span class="line">            ImageIO.write(buffImg, fileExt, os);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != is)</span><br><span class="line">                    is.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != os)</span><br><span class="line">                    os.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        markImageByText(<span class="string">&quot;K:\\1.png&quot;</span>, <span class="string">&quot;K:\\2.png&quot;</span>, <span class="number">35</span>, Color.red, <span class="string">&quot;png&quot;</span></span><br><span class="line">        , <span class="string">&quot;全拼水印&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果为：</p>
<p><img src="https://i.loli.net/2020/05/23/PKbpF675qz3EIWo.png" alt="Snipaste_2020-05-23_23-34-31"></p>
<h4 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h4><p>相应的将上面的执行命令的代码的<code>List</code>变为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构造命令</span></span><br><span class="line">      List&lt;String&gt; commond = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">      commond.add(ffmpegExePath); <span class="comment">// &quot;/usr/local/ffmpeg2/bin/./ffmpeg&quot;</span></span><br><span class="line">      commond.add(<span class="string">&quot;-i&quot;</span>);</span><br><span class="line">      commond.add(inputFilePath); <span class="comment">// .../input.mp4</span></span><br><span class="line">commond.add(<span class="string">&quot;-i&quot;</span>);</span><br><span class="line">commond.add(<span class="string">&quot;logo.png&quot;</span>);</span><br><span class="line">      commond.add(<span class="string">&quot;-filter_complex&quot;</span>);</span><br><span class="line">      commond.add(<span class="string">&quot;overlay=5:5&quot;</span>);</span><br><span class="line">      commond.add(outputFilePath); <span class="comment">// output.mp4</span></span><br></pre></td></tr></table></figure>

<p>这样就可以了</p>
<h1 id="进度导出"><a href="#进度导出" class="headerlink" title="进度导出"></a>进度导出</h1><p>客户希望的是，他们在下载一个视频时手动指定水印的内容，然后制定好后直接加水印，要返回水印添加进度。</p>
<p>额，有点难受…</p>
<p>但还是硬着头皮去做了，基本思路是在命令行执行<code>FFmpeg</code>程序时，会有一些信息的打印：</p>
<p><img src="https://i.loli.net/2020/05/24/EiapX8HDAb354oL.png" alt="Snipaste_2020-05-24_00-11-22"></p>
<p><img src="https://i.loli.net/2020/05/24/6cYQCZfJuToRt4N.png" alt="Snipaste_2020-05-24_00-11-50"></p>
<p>根据上面的图，我们只需要获取一次待处理视频的总长度(注意要掠过图片的这个属性)<code>Duration</code>，然后第二张图片上的<code>time</code>是当前已经处理的时间，我们不断获取这个时间，将这个时间与总长度相除得到当前进度。</p>
<p>由于我做的是web项目，然后通过<code>WebSocks</code>技术不断向用户界面推送进度，这样就实现了功能。</p>
<p>进度代码展示(在<code>dealStream</code>方法上修改)，因为此方法就是获取命令的返回信息，不知为什么命令返回信息在err流中，我没研究。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dealStream</span><span class="params">(Process process)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (process == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 处理InputStream的线程</span></span><br><span class="line">        <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                BufferedReader in =</span><br><span class="line">                        <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(process.getInputStream()));</span><br><span class="line">                String line = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">while</span> ((line = in.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        log.info(<span class="string">&quot;output: &quot;</span> + line);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        in.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理ErrorStream的线程</span></span><br><span class="line">        <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                BufferedReader err =</span><br><span class="line">                        <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(process.getErrorStream()));</span><br><span class="line">                String line = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//language=RegExp</span></span><br><span class="line">                    String regex = <span class="string">&quot;frame=\\s*\\w+.+&quot;</span>;</span><br><span class="line">                    String Duration;</span><br><span class="line">                    Long AllTime=<span class="number">0L</span>;</span><br><span class="line">                    Long currentTime;</span><br><span class="line">                    <span class="keyword">boolean</span> isVideo = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="comment">// 创建一个数值格式化对象</span></span><br><span class="line">                    NumberFormat numberFormat = NumberFormat.getInstance();</span><br><span class="line">                    <span class="comment">// 设置精确到小数点后2位</span></span><br><span class="line">                    numberFormat.setMaximumFractionDigits(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span> ((line = err.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (line.contains(<span class="string">&quot;Duration:&quot;</span>)&amp;&amp;isVideo)&#123;</span><br><span class="line">                            <span class="keyword">int</span> end = line.indexOf(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                            <span class="keyword">int</span> start = line.indexOf(<span class="string">&quot;Duration: &quot;</span>)+<span class="string">&quot;Duration: &quot;</span>.length();</span><br><span class="line">                            Duration = line.substring(start, end);</span><br><span class="line">                            AllTime = getTimestampOfDateTime(timeParse(Duration));</span><br><span class="line">                            isVideo = <span class="keyword">false</span>;</span><br><span class="line">                        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (Pattern.matches(regex, line))&#123;</span><br><span class="line">                            <span class="keyword">int</span> start = line.indexOf(<span class="string">&quot;time=&quot;</span>);</span><br><span class="line">                            <span class="keyword">int</span> end = line.indexOf(<span class="string">&quot; bit&quot;</span>);</span><br><span class="line">                            String substring = line.substring(start + <span class="string">&quot;time=&quot;</span>.length, end);</span><br><span class="line">                            currentTime =</span><br><span class="line">                                    getTimestampOfDateTime(timeParse(substring));</span><br><span class="line">                            <span class="keyword">double</span> v = currentTime * <span class="number">1.0</span> / AllTime * <span class="number">100</span>;</span><br><span class="line">                            String format = numberFormat.format(v);</span><br><span class="line">                            <span class="comment">// 这就是进度，具体怎么操作看业务</span></span><br><span class="line">                            System.out.println((format + <span class="string">&quot;%&quot;</span>));</span><br><span class="line">                        &#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        err.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="问题汇总"><a href="#问题汇总" class="headerlink" title="问题汇总"></a>问题汇总</h1><p>可能是，但不一定是；我只是把我遇到的问题以及解决方法说出来了</p>
<h2 id="生成输出视频，大小为0"><a href="#生成输出视频，大小为0" class="headerlink" title="生成输出视频，大小为0"></a>生成输出视频，大小为0</h2><p>文字水印：</p>
<p>与直接执行<code>FFmpeg</code>不同的是，<code>FFmpeg</code>命令中<code>drawtext</code>是带引号的，但是在Java中的<code>List</code>不能添加双引号，即使是转义也不行(总之，不能出现<code>\&quot;</code>)，否则虽然在Linux会执行成功，但是生成的视频没有大小，是个失败的输入视频。</p>
<h2 id="中文成为□"><a href="#中文成为□" class="headerlink" title="中文成为□"></a>中文成为□</h2><p>原因是<code>FFmpeg</code>找不到字体库文件</p>
<p>文字水印：</p>
<ol>
<li>将字体库文件放到项目里，指定时使用绝对路径</li>
<li>或者将字体库文件放入命令文件夹中</li>
</ol>
<p>图片水印：</p>
<p>因为图片水印我直接使用Linux环境来测试的，当出现□时，证明你Linux没有你指定的中文字体，例如上面代码制定了<code>新宋体</code>字体，那么只需要在window的<code>C:\Windows\Fonts</code>中找到新宋体，复制到Linux中，然后安装此字体就可以，不会安装的可以自行百度。</p>
<h2 id="清晰度明显降低"><a href="#清晰度明显降低" class="headerlink" title="清晰度明显降低"></a>清晰度明显降低</h2><p>我在window环境(外网)操作时，没有这个问题；当我使用Linux(内网)操作时，清晰度明显下降。网上有的说是缺少参数，我加上也没用。</p>
<p>此时我对比了一下两个环境安装的<code>FFmpeg</code>的区别，此时发现</p>
<ol>
<li>Window系统安装的是官方编译好的版本，内容很全</li>
<li>而Linux是通过源码手动编译安装的，而自己<code>./configure</code>几乎没有带参数，这导致我Linux版本安装的<code>FFmpeg</code>少很多内容</li>
</ol>
<p>然后我更换了Linux的<code>FFmpeg</code>的版本，也是下载了一个官方编译好的版本，直接运行就没有问题了！具体缺了什么东西，由于什么导致清晰度下降，我没有研究，感兴趣的可以自己试试！</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Xiangjie</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://awslzhang.top/2020/05/23/%E8%AE%B0%E4%B8%80%E6%AC%A1%E8%B0%83%E7%94%A8FFmpeg%E5%A4%84%E7%90%86%E8%A7%86%E9%A2%91/">https://awslzhang.top/2020/05/23/%E8%AE%B0%E4%B8%80%E6%AC%A1%E8%B0%83%E7%94%A8FFmpeg%E5%A4%84%E7%90%86%E8%A7%86%E9%A2%91/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://awslzhang.top" target="_blank">zxj</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/FFmpeg/">FFmpeg</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/06/09/RO5Fb9ac84fBIlJ.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/06/14/%E4%BB%80%E4%B9%88%E6%98%AFJVM/"><img class="prev-cover" src="https://i.loli.net/2020/06/14/fGXnluFNIw3hgZj.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">什么是JVM</div></div></a></div><div class="next-post pull-right"><a href="/2020/05/07/Redis%E7%90%90%E7%A2%8E%E7%9F%A5%E8%AF%86%E7%82%B9/"><img class="next-cover" src="https://i.loli.net/2020/06/09/bp9DlYjrGi2q8oE.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Redis琐碎知识点</div></div></a></div></nav></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/null" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Xiangjie</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">84</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">43</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">25</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/XiangJie-Zhang" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:qluzxj@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E5%AD%97%E6%B0%B4%E5%8D%B0"><span class="toc-number">2.1.</span> <span class="toc-text">文字水印</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FFmpeg%E5%91%BD%E4%BB%A4"><span class="toc-number">2.1.1.</span> <span class="toc-text">FFmpeg命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java%E8%B0%83%E7%94%A8"><span class="toc-number">2.1.2.</span> <span class="toc-text">Java调用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%BE%E7%89%87%E6%B0%B4%E5%8D%B0"><span class="toc-number">2.2.</span> <span class="toc-text">图片水印</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FFmpeg%E5%91%BD%E4%BB%A4-1"><span class="toc-number">2.2.1.</span> <span class="toc-text">FFmpeg命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.2.2.</span> <span class="toc-text">Java实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%9B%BE%E7%89%87"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">处理图片</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">命令执行</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E5%BA%A6%E5%AF%BC%E5%87%BA"><span class="toc-number">3.</span> <span class="toc-text">进度导出</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB"><span class="toc-number">4.</span> <span class="toc-text">问题汇总</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E8%BE%93%E5%87%BA%E8%A7%86%E9%A2%91%EF%BC%8C%E5%A4%A7%E5%B0%8F%E4%B8%BA0"><span class="toc-number">4.1.</span> <span class="toc-text">生成输出视频，大小为0</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E6%96%87%E6%88%90%E4%B8%BA%E2%96%A1"><span class="toc-number">4.2.</span> <span class="toc-text">中文成为□</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%85%E6%99%B0%E5%BA%A6%E6%98%8E%E6%98%BE%E9%99%8D%E4%BD%8E"><span class="toc-number">4.3.</span> <span class="toc-text">清晰度明显降低</span></a></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/01/02/Flink%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/" title="Flink状态编程和容错机制"><img src="https://flink.apache.org/img/flink-header-logo.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Flink状态编程和容错机制"/></a><div class="content"><a class="title" href="/2021/01/02/Flink%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/" title="Flink状态编程和容错机制">Flink状态编程和容错机制</a><time datetime="2021-01-02T10:06:02.000Z" title="发表于 2021-01-02 18:06:02">2021-01-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/23/Flink%E6%97%B6%E9%97%B4%E8%AF%AD%E4%B9%89%E5%92%8CWaterMark/" title="Flink的时间语义和watermark"><img src="https://flink.apache.org/img/flink-header-logo.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Flink的时间语义和watermark"/></a><div class="content"><a class="title" href="/2020/12/23/Flink%E6%97%B6%E9%97%B4%E8%AF%AD%E4%B9%89%E5%92%8CWaterMark/" title="Flink的时间语义和watermark">Flink的时间语义和watermark</a><time datetime="2020-12-23T10:59:07.000Z" title="发表于 2020-12-23 18:59:07">2020-12-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/17/Flink-API/" title="Flink Api学习"><img src="https://flink.apache.org/img/flink-header-logo.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Flink Api学习"/></a><div class="content"><a class="title" href="/2020/12/17/Flink-API/" title="Flink Api学习">Flink Api学习</a><time datetime="2020-12-17T12:36:28.000Z" title="发表于 2020-12-17 20:36:28">2020-12-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/17/ready/" title="ready!"><img src="https://images.pexels.com/photos/924824/pexels-photo-924824.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ready!"/></a><div class="content"><a class="title" href="/2020/12/17/ready/" title="ready!">ready!</a><time datetime="2020-12-16T16:02:06.000Z" title="发表于 2020-12-17 00:02:06">2020-12-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/16/Flink%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Flink学习笔记"><img src="https://flink.apache.org/img/flink-header-logo.svg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Flink学习笔记"/></a><div class="content"><a class="title" href="/2020/12/16/Flink%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Flink学习笔记">Flink学习笔记</a><time datetime="2020-12-16T12:29:56.000Z" title="发表于 2020-12-16 20:29:56">2020-12-16</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Xiangjie</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script></div></body></html>