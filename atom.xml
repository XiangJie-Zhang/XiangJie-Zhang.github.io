<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>zxj</title>
  
  <subtitle>Viva La Vida</subtitle>
  <link href="https://awslzhang.top/atom.xml" rel="self"/>
  
  <link href="https://awslzhang.top/"/>
  <updated>2021-02-02T13:36:45.848Z</updated>
  <id>https://awslzhang.top/</id>
  
  <author>
    <name>Xiangjie</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Apiå’ŒSQL</title>
    <link href="https://awslzhang.top/2021/01/10/Api%E5%92%8CSQL/"/>
    <id>https://awslzhang.top/2021/01/10/Api%E5%92%8CSQL/</id>
    <published>2021-01-10T03:51:40.000Z</published>
    <updated>2021-02-02T13:36:45.848Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ•´ä½“ä»‹ç»"><a href="#æ•´ä½“ä»‹ç»" class="headerlink" title="æ•´ä½“ä»‹ç»"></a>æ•´ä½“ä»‹ç»</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110115741903.png" alt="image-20210110115741903"></p><p>Flinkæœ‰ä¸‰å±‚APIï¼Œè¶Šé¡¶å±‚è¶ŠæŠ½è±¡ï¼ˆæ–¹ä¾¿ï¼‰ï¼Œä½†ä¸çµæ´»</p><h2 id="ä»€ä¹ˆæ˜¯Table-APIå’ŒFlink-SQL"><a href="#ä»€ä¹ˆæ˜¯Table-APIå’ŒFlink-SQL" class="headerlink" title="ä»€ä¹ˆæ˜¯Table APIå’ŒFlink SQL"></a>ä»€ä¹ˆæ˜¯Table APIå’ŒFlink SQL</h2><p>Flink æœ¬èº«æ˜¯æ‰¹æµç»Ÿä¸€çš„å¤„ç†æ¡†æ¶ï¼Œæ‰€ä»¥ Table API å’Œ SQLï¼Œå°±æ˜¯<strong>æ‰¹æµç»Ÿä¸€çš„ä¸Šå±‚å¤„ç† API</strong>ã€‚ ç›®å‰åŠŸèƒ½å°šæœªå®Œå–„ï¼Œå¤„äºæ´»è·ƒçš„å¼€å‘é˜¶æ®µã€‚ </p><p>Table API æ˜¯ä¸€å¥—å†…åµŒåœ¨ Java å’Œ Scala è¯­è¨€ä¸­çš„æŸ¥è¯¢ APIï¼Œå®ƒå…è®¸æˆ‘ä»¬ä»¥éå¸¸ç›´è§‚çš„æ–¹å¼ï¼Œ ç»„åˆæ¥è‡ªä¸€äº›å…³ç³»è¿ç®—ç¬¦çš„æŸ¥è¯¢ï¼ˆæ¯”å¦‚ selectã€filter å’Œ joinï¼‰ã€‚è€Œå¯¹äº Flink SQLï¼Œå°±æ˜¯ç›´æ¥å¯ ä»¥åœ¨ä»£ç ä¸­å†™ SQLï¼Œæ¥å®ç°ä¸€äº›æŸ¥è¯¢ï¼ˆQueryï¼‰æ“ä½œã€‚Flink çš„ SQL æ”¯æŒï¼ŒåŸºäºå®ç°äº† SQL æ ‡ å‡†çš„ Apache Calciteï¼ˆApache å¼€æº SQL è§£æå·¥å…·ï¼‰ã€‚</p><p> æ— è®ºè¾“å…¥æ˜¯æ‰¹è¾“å…¥è¿˜æ˜¯æµå¼è¾“å…¥ï¼Œåœ¨è¿™ä¸¤å¥— API ä¸­ï¼ŒæŒ‡å®šçš„æŸ¥è¯¢éƒ½å…·æœ‰ç›¸åŒçš„è¯­ä¹‰ï¼Œå¾— åˆ°ç›¸åŒçš„ç»“æœã€‚</p><blockquote><p>Flink SQLåœ¨1.10ç‰ˆæœ¬æ‰ç¨³å®šä¸‹æ¥ï¼Œ1.11ç‰ˆæœ¬</p></blockquote><h2 id="éœ€è¦å¼•å…¥çš„ä¾èµ–"><a href="#éœ€è¦å¼•å…¥çš„ä¾èµ–" class="headerlink" title="éœ€è¦å¼•å…¥çš„ä¾èµ–"></a>éœ€è¦å¼•å…¥çš„ä¾èµ–</h2><p>Table APIå’ŒSQLéœ€è¦å¼•å…¥çš„ä¾èµ–æœ‰ä¸¤ä¸ªï¼šplannerå’Œbridgeã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-table-planner_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-table-planner_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>flink-table-plannerï¼šplannerè®¡åˆ’å™¨ï¼Œæ˜¯table APIæœ€ä¸»è¦çš„éƒ¨åˆ†ï¼Œæä¾›äº†è¿è¡Œæ—¶ç¯å¢ƒå’Œç”Ÿæˆç¨‹åºæ‰§è¡Œè®¡åˆ’çš„plannerï¼›</li><li>flink-table-api-scala-bridgeï¼šbridgeæ¡¥æ¥å™¨ï¼Œä¸»è¦è´Ÿè´£table APIå’Œ DataStream/DataSet APIçš„è¿æ¥æ”¯æŒï¼ŒæŒ‰ç…§è¯­è¨€åˆ†javaå’Œscalaã€‚</li></ul><blockquote><p>planneré‡ŒåŒ…å«bridgeåŒ…ã€‚</p><p>è€ŒFlinkæœ‰ä¸¤ç§ç‰ˆæœ¬çš„planner</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110130012436.png" alt="image-20210110130012436"></p><h2 id="ä¸åŒç‰ˆæœ¬çš„PlannerğŸ”º"><a href="#ä¸åŒç‰ˆæœ¬çš„PlannerğŸ”º" class="headerlink" title="ä¸åŒç‰ˆæœ¬çš„PlannerğŸ”º"></a>ä¸åŒç‰ˆæœ¬çš„PlannerğŸ”º</h2><p>è€ŒFlinkæœ‰ä¸¤ç§ç‰ˆæœ¬çš„plannerï¼š</p><ol><li>planner</li><li>planner-blink</li></ol><blockquote><p>plannerå’Œplanner-blinkçš„æ¶æ„éƒ½ä¸ç›¸åŒï¼Œplanner-blinkçœŸæ­£çš„å®ç°äº†æµæ‰¹ç»Ÿä¸€ã€‚</p></blockquote><p>å¿…é¡»é€‰æ‹©ä¸€ç§ä½¿ç”¨ï¼Œä¸¤è€…ä¸å…¼å®¹ã€‚</p><ol><li>æ‰¹æµç»Ÿä¸€ï¼š<strong>Blinkå°†æ‰¹å¤„ç†ä½œä¸šï¼Œè§†ä¸ºæµå¼å¤„ç†çš„ç‰¹æ®Šæƒ…å†µã€‚</strong>æ‰€ä»¥ï¼Œblinkä¸æ”¯æŒè¡¨å’ŒDataSetä¹‹é—´çš„è½¬æ¢ï¼Œæ‰¹å¤„ç†ä½œä¸šå°†ä¸è½¬æ¢ä¸ºDataSetåº”ç”¨ç¨‹åºï¼Œè€Œæ˜¯è·Ÿæµå¤„ç†ä¸€æ ·ï¼Œè½¬æ¢ä¸ºDataStreamç¨‹åºæ¥å¤„ç†ã€‚</li><li>å› ä¸ºæ‰¹æµç»Ÿä¸€ï¼ŒBlink plannerä¹Ÿä¸æ”¯æŒBatchTableSourceï¼Œè€Œä½¿ç”¨æœ‰ç•Œçš„StreamTableSourceä»£æ›¿ã€‚</li><li>Blink planneråªæ”¯æŒå…¨æ–°çš„ç›®å½•ï¼Œä¸æ”¯æŒå·²å¼ƒç”¨çš„ExternalCatalogã€‚</li><li>æ—§plannerå’ŒBlink plannerçš„FilterableTableSourceå®ç°ä¸å…¼å®¹ã€‚æ—§çš„plannerä¼šæŠŠPlannerExpressionsä¸‹æ¨åˆ°filterableTableSourceä¸­ï¼Œè€Œblink planneråˆ™ä¼šæŠŠExpressionsä¸‹æ¨ã€‚</li><li>åŸºäºå­—ç¬¦ä¸²çš„é”®å€¼é…ç½®é€‰é¡¹ä»…é€‚ç”¨äºBlink plannerã€‚</li><li>PlannerConfigåœ¨ä¸¤ä¸ªplannerä¸­çš„å®ç°ä¸åŒ</li><li>Blink plannerä¼šå°†å¤šä¸ªsinkä¼˜åŒ–åœ¨ä¸€ä¸ªDAGä¸­ï¼ˆä»…åœ¨TableEnvironmentä¸Šå—æ”¯æŒï¼Œè€Œåœ¨StreamTableEnvironmentä¸Šä¸å—æ”¯æŒï¼‰ã€‚è€Œæ—§plannerçš„ä¼˜åŒ–æ€»æ˜¯å°†æ¯ä¸€ä¸ªsinkæ”¾åœ¨ä¸€ä¸ªæ–°çš„DAGä¸­ï¼Œå…¶ä¸­æ‰€æœ‰DAGå½¼æ­¤ç‹¬ç«‹ã€‚</li><li>æ—§çš„plannerä¸æ”¯æŒç›®å½•ç»Ÿè®¡ï¼Œè€ŒBlink planneræ”¯æŒã€‚</li></ol><h1 id="APIè°ƒç”¨"><a href="#APIè°ƒç”¨" class="headerlink" title="APIè°ƒç”¨"></a>APIè°ƒç”¨</h1><h2 id="è¡¨ç¯å¢ƒåˆ›å»ºğŸ”º"><a href="#è¡¨ç¯å¢ƒåˆ›å»ºğŸ”º" class="headerlink" title="è¡¨ç¯å¢ƒåˆ›å»ºğŸ”º"></a>è¡¨ç¯å¢ƒåˆ›å»ºğŸ”º</h2><p>é€šè¿‡ä¸‹é¢ä½¿ç”¨ä¸åŒçš„planneråˆ›å»ºè¡¨ç¯å¢ƒæ•‘æ©é‚£ä¸ªç†è§£1ï¼Œ2ç‚¹çš„ä¸åŒã€‚ï¼ˆçœŸæ­£å®ç°æµæ‰¹ç»Ÿä¸€ï¼‰</p><h3 id="é»˜è®¤ğŸ”º"><a href="#é»˜è®¤ğŸ”º" class="headerlink" title="é»˜è®¤ğŸ”º"></a>é»˜è®¤ğŸ”º</h3><p>1.10é»˜è®¤plannerï¼Œ1.11ä»¥åŠä»¥åé»˜è®¤blinkã€‚</p><p>åˆ›å»ºè¡¨ç¯å¢ƒæœ€ç®€å•çš„æ–¹å¼ï¼Œå°±æ˜¯åŸºäºæµå¤„ç†æ‰§è¡Œç¯å¢ƒï¼Œè°ƒcreateæ–¹æ³•ç›´æ¥åˆ›å»ºï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line"><span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶åˆ›å»ºå‡ºæ¥çš„æ˜¯æµå¤„ç†çš„ç¯å¢ƒ</p><blockquote><p>æˆ‘ä½¿ç”¨çš„ç‰ˆæœ¬æ˜¯1.12.0ï¼ˆflinkï¼‰</p></blockquote><h3 id="planner"><a href="#planner" class="headerlink" title="planner"></a>planner</h3><p>ä¸»è¦åŸºäº<code>def create(executionEnvironment : org.apache.flink.streaming.api.scala.StreamExecutionEnvironment, settings : org.apache.flink.table.api.EnvironmentSettings) : org.apache.flink.table.api.bridge.scala.StreamTableEnvironment</code>æ–¹æ³•</p><h4 id="æ‰¹å¤„ç†ç¯å¢ƒ"><a href="#æ‰¹å¤„ç†ç¯å¢ƒ" class="headerlink" title="æ‰¹å¤„ç†ç¯å¢ƒ"></a>æ‰¹å¤„ç†ç¯å¢ƒ</h4><p>åŸºäºè€ç‰ˆæœ¬çš„æ‰¹å¤„ç†ï¼Œå› ä¸ºè€ç‰ˆæœ¬ä¸æ˜¯æµæ‰¹ç»Ÿä¸€ï¼Œæ‰€ä»¥åˆ›å»ºæ‰¹å¤„ç†ç¯å¢ƒä¸å¾—ä½¿ç”¨<code>StreamTableEnvironment</code>ã€‚è€Œä¸”å®ƒçš„å‚æ•°ä¹Ÿä¸èƒ½æ˜¯æµå¤„ç†çš„ç¯å¢ƒ<code>StreamExecutionEnvironment</code>ï¼Œå¾—æ˜¯æ‰¹å¤„ç†çš„ç¯å¢ƒï¼š<code>ExecutionEnvironment</code></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">TableEnvCreate</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> batchEnv: <span class="type">ExecutionEnvironment</span> = <span class="type">ExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    <span class="keyword">val</span> batchTableEnv: <span class="type">BatchTableEnvironment</span> = <span class="type">BatchTableEnvironment</span>.create(batchEnv)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æµå¤„ç†ç¯å¢ƒ"><a href="#æµå¤„ç†ç¯å¢ƒ" class="headerlink" title="æµå¤„ç†ç¯å¢ƒ"></a>æµå¤„ç†ç¯å¢ƒ</h4><p>åŸºäºè€ç‰ˆæœ¬çš„æµå¤„ç†</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">TableEnvCreate</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    </span><br><span class="line">   </span><br><span class="line">    <span class="keyword">val</span> settings: <span class="type">EnvironmentSettings</span> = <span class="type">EnvironmentSettings</span>.newInstance()</span><br><span class="line">      .useOldPlanner()</span><br><span class="line">      .inStreamingMode()</span><br><span class="line">      .build()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> environment: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env, settings)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="blinkğŸ”º"><a href="#blinkğŸ”º" class="headerlink" title="blinkğŸ”º"></a>blinkğŸ”º</h3><h4 id="æ‰¹å¤„ç†ç¯å¢ƒ-1"><a href="#æ‰¹å¤„ç†ç¯å¢ƒ-1" class="headerlink" title="æ‰¹å¤„ç†ç¯å¢ƒ"></a>æ‰¹å¤„ç†ç¯å¢ƒ</h4><p>å› ä¸ºFlinkçš„blink planneræ˜¯æµæ‰¹ç»Ÿä¸€çš„ï¼Œæ‰€ä»¥å®ƒä¸éœ€è¦ä½¿ç”¨<code>BatchTableEnvironment</code>æ¥åˆ›å»ºç¯å¢ƒï¼Œå®ƒåªéœ€è¦é€šè¿‡ç»Ÿä¸€çš„ç¯å¢ƒ<code>TableEnvironment</code>æ¥åˆ›å»ºï¼Œåªéœ€è¦å°†å‚æ•°å£°æ˜ä¸ºæµå¤„ç†è¿˜æ˜¯æ‰¹å¤„ç†å³å¯</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">TableEnvCreate</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> settings: <span class="type">EnvironmentSettings</span> = <span class="type">EnvironmentSettings</span>.newInstance()</span><br><span class="line">      .useBlinkPlanner()</span><br><span class="line">      .inBatchMode()</span><br><span class="line">      .build()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> environment: <span class="type">TableEnvironment</span> = <span class="type">TableEnvironment</span>.create(settings)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="æµå¤„ç†ç¯å¢ƒ-1"><a href="#æµå¤„ç†ç¯å¢ƒ-1" class="headerlink" title="æµå¤„ç†ç¯å¢ƒ"></a>æµå¤„ç†ç¯å¢ƒ</h4><p>åŸºäºæ–°ç‰ˆæœ¬çš„æµå¤„ç†</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">TableEnvCreate</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> settings: <span class="type">EnvironmentSettings</span> = <span class="type">EnvironmentSettings</span>.newInstance()</span><br><span class="line">      .useBlinkPlanner()</span><br><span class="line">      .inStreamingMode()</span><br><span class="line">      .build()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> environment: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env, settings)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åŸºæœ¬ç¨‹åºç»“æ„"><a href="#åŸºæœ¬ç¨‹åºç»“æ„" class="headerlink" title="åŸºæœ¬ç¨‹åºç»“æ„"></a>åŸºæœ¬ç¨‹åºç»“æ„</h2><p>Table API å’Œ SQL çš„ç¨‹åºç»“æ„ï¼Œä¸æµå¼å¤„ç†çš„ç¨‹åºç»“æ„ç±»ä¼¼ï¼›ä¹Ÿå¯ä»¥è¿‘ä¼¼åœ°è®¤ä¸ºæœ‰è¿™ä¹ˆå‡ æ­¥ï¼šé¦–å…ˆåˆ›å»ºæ‰§è¡Œç¯å¢ƒï¼Œç„¶åå®šä¹‰sourceã€transformå’Œsinkã€‚</p><p>å…·ä½“æ“ä½œæµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> tableEnv = ...  <span class="comment">// åˆ›å»ºè¡¨çš„æ‰§è¡Œç¯å¢ƒ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€å¼ è¡¨ï¼Œç”¨äºè¯»å–æ•°æ®</span></span><br><span class="line">tableEnv.connect(...).createTemporaryTable(<span class="string">&quot;inputTable&quot;</span>)</span><br><span class="line"><span class="comment">// æ³¨å†Œä¸€å¼ è¡¨ï¼Œç”¨äºæŠŠè®¡ç®—ç»“æœè¾“å‡º</span></span><br><span class="line">tableEnv.connect(...).createTemporaryTable(<span class="string">&quot;outputTable&quot;</span>)</span><br><span class="line"><span class="comment">// é€šè¿‡ Table API æŸ¥è¯¢ç®—å­ï¼Œå¾—åˆ°ä¸€å¼ ç»“æœè¡¨</span></span><br><span class="line"><span class="keyword">val</span> result = tableEnv.from(<span class="string">&quot;inputTable&quot;</span>).select(...)</span><br><span class="line"><span class="comment">// é€šè¿‡ SQLæŸ¥è¯¢è¯­å¥ï¼Œå¾—åˆ°ä¸€å¼ ç»“æœè¡¨</span></span><br><span class="line"><span class="keyword">val</span> sqlResult  = tableEnv.sqlQuery(<span class="string">&quot;SELECT ... FROM inputTable ...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†ç»“æœè¡¨å†™å…¥è¾“å‡ºè¡¨ä¸­</span></span><br><span class="line">result.insertInto(<span class="string">&quot;outputTable&quot;</span>)</span><br></pre></td></tr></table></figure><ol><li>åˆ›å»ºè¡¨æ‰§è¡Œç¯å¢ƒ</li><li>åˆ›å»ºä¸€å¼ è¡¨ï¼Œç”¨äºè¯»å–æ•°æ®</li><li>æ³¨å†Œä¸€å¼ è¡¨ï¼Œç”¨äºæŠŠè®¡ç®—ç»“æœè¾“å‡º</li><li>é€šè¿‡ Table API æŸ¥è¯¢ç®—å­ï¼Œå¾—åˆ°ä¸€å¼ ç»“æœè¡¨ || é€šè¿‡ SQLæŸ¥è¯¢è¯­å¥ï¼Œå¾—åˆ°ä¸€å¼ ç»“æœè¡¨</li><li>å°†ç»“æœè¡¨å†™å…¥è¾“å‡ºè¡¨ä¸­</li></ol><blockquote><p>å¦‚æœä½¿ç”¨Table APIçš„è¯ï¼Œå¿…é¡»å¾—é€šè¿‡envåˆ›å»ºä¸€ä¸ªTableç±»å‹çš„å¯¹è±¡ï¼Œé€šè¿‡å…¶æ‰èƒ½æ‰§è¡ŒAPIæ“ä½œ</p><p>å¦‚æœä½¿ç”¨SQLå¯¹è±¡çš„è¯ï¼Œå¿…é¡»é€šè¿‡envåˆ›å»º<code>createTemporaryTable</code>ä¸´æ—¶è¡¨åˆ°ç¯å¢ƒä¸­ï¼Œæ‰èƒ½ä½¿ç”¨SQLå¼€å§‹è®¡ç®—</p></blockquote><h2 id="åœ¨-Catalog-ä¸­æ³¨å†Œè¡¨"><a href="#åœ¨-Catalog-ä¸­æ³¨å†Œè¡¨" class="headerlink" title="åœ¨ Catalog ä¸­æ³¨å†Œè¡¨"></a>åœ¨ Catalog ä¸­æ³¨å†Œè¡¨</h2><h3 id="è¡¨ï¼ˆTableï¼‰çš„æ¦‚å¿µ"><a href="#è¡¨ï¼ˆTableï¼‰çš„æ¦‚å¿µ" class="headerlink" title="è¡¨ï¼ˆTableï¼‰çš„æ¦‚å¿µ"></a>è¡¨ï¼ˆTableï¼‰çš„æ¦‚å¿µ</h3><p>TableEnvironment å¯ä»¥æ³¨å†Œç›®å½• Catalogï¼Œå¹¶å¯ä»¥åŸºäº Catalog æ³¨å†Œè¡¨ã€‚å®ƒä¼šç»´æŠ¤ä¸€ä¸ª Catalog-Table è¡¨ä¹‹é—´çš„ mapã€‚</p><p>è¡¨ï¼ˆTableï¼‰æ˜¯ç”±ä¸€ä¸ªâ€œæ ‡è¯†ç¬¦â€æ¥æŒ‡å®šçš„ï¼Œç”± 3 éƒ¨åˆ†ç»„æˆï¼š<strong>Catalog åã€æ•°æ®åº“ï¼ˆdatabaseï¼‰ åå’Œå¯¹è±¡åï¼ˆè¡¨åï¼‰</strong>ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šç›®å½•æˆ–æ•°æ®åº“ï¼Œå°±ä½¿ç”¨å½“å‰çš„é»˜è®¤å€¼ã€‚</p><p>è¡¨å¯ä»¥æ˜¯å¸¸è§„çš„ï¼ˆTableï¼Œè¡¨ï¼‰ï¼Œæˆ–è€…è™šæ‹Ÿçš„ï¼ˆViewï¼Œè§†å›¾ï¼‰ã€‚</p><ul><li>å¸¸è§„è¡¨ï¼ˆTableï¼‰ä¸€èˆ¬å¯ä»¥ ç”¨æ¥æè¿°å¤–éƒ¨æ•°æ®ï¼Œæ¯”å¦‚æ–‡ä»¶ã€æ•°æ®åº“è¡¨æˆ–æ¶ˆæ¯é˜Ÿåˆ—çš„æ•°æ®ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä» DataStream è½¬ æ¢è€Œæ¥ã€‚ï¼ˆç”¨äºSourceã€Sinkçš„è¡¨ï¼‰</li><li>è§†å›¾å¯ä»¥ä»ç°æœ‰çš„è¡¨ä¸­åˆ›å»ºï¼Œé€šå¸¸æ˜¯ table API æˆ–è€… SQL æŸ¥è¯¢çš„ä¸€ä¸ªç»“æœï¼ˆ<code>createTemporaryTable</code>ï¼‰</li></ul><h3 id="åˆ›å»ºè¡¨ğŸ”º"><a href="#åˆ›å»ºè¡¨ğŸ”º" class="headerlink" title="åˆ›å»ºè¡¨ğŸ”º"></a>åˆ›å»ºè¡¨ğŸ”º</h3><h4 id="å¤–éƒ¨ç³»ç»Ÿåˆ›å»º"><a href="#å¤–éƒ¨ç³»ç»Ÿåˆ›å»º" class="headerlink" title="å¤–éƒ¨ç³»ç»Ÿåˆ›å»º"></a>å¤–éƒ¨ç³»ç»Ÿåˆ›å»º</h4><p>ç°åœ¨1.12æ–¹æ³•<code>connect</code>å¥½åƒå·²ç»è¢«åºŸå¼ƒï¼Œä½†æ˜¯è¿˜èƒ½ç”¨ã€‚</p><p>æºç ä¸­éå¸¸æ¸…æ™°çš„å‘Šè¯‰æˆ‘ä»¬åº”è¯¥ä½¿ç”¨CREATE TABLE DDLæ¥æ„å»ºSOURCE TABLEã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¼˜å…ˆä½¿ç”¨DDLæ–¹å¼æ¥æ„å»ºTABLEã€‚è€Œä¸”ï¼Œå®˜æ–¹çš„å„ç§APIå¼€å§‹éƒ½æ˜¯ä»¥DDLæ¥æ„å»ºäº†ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110142836238.png" alt="image-20210110142836238"></p><p>å…·ä½“ä½¿ç”¨æ–¹æ³•è¯·æŸ¥çœ‹å®˜æ–¹ï¼š<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/filesystem.html">Apache Flink 1.12 Documentation: FileSystem SQL Connector</a></p><hr><p><del>ç›´æ¥è°ƒç”¨ tableEnv.connect()å°±å¯ä»¥ï¼Œé‡Œé¢å‚æ•°è¦ä¼  å…¥ä¸€ä¸ª ConnectorDescriptorï¼Œä¹Ÿå°±æ˜¯ connector æè¿°å™¨ã€‚å¯¹äºæ–‡ä»¶ç³»ç»Ÿçš„ connector è€Œè¨€ï¼Œflink å†…éƒ¨å·²ç»æä¾›äº†ï¼Œå°±å«åš FileSystem()ã€‚å¹¶è°ƒç”¨<code>createTemporaryTable</code>æ–¹æ³•ï¼Œåœ¨Catalogæ³¨å†Œè¡¨</del></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110141247564.png" alt="image-20210110141247564"></p><h5 id="æ–‡ä»¶ç³»ç»Ÿ"><a href="#æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="æ–‡ä»¶ç³»ç»Ÿ"></a>æ–‡ä»¶ç³»ç»Ÿ</h5><p><strong>ä¸¾ä¾‹ï¼Œè¯»å–æœ¬åœ°æ–‡ä»¶ç³»ç»ŸCSVæ ¼å¼æ–‡ä»¶</strong></p><p>éœ€è¦é¢å¤–å¯¼å…¥åŒ…</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-csv<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.table</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.<span class="type">Expressions</span>.$</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.<span class="type">Table</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.bridge.scala.<span class="type">StreamTableEnvironment</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">FromFileSystemByDdl</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileSystemSql: <span class="type">String</span> = <span class="string">&quot;CREATE TABLE fs_table &quot;</span> +</span><br><span class="line">      <span class="string">&quot;(id STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot; ts STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;  temp DOUBLE) &quot;</span> +</span><br><span class="line">      <span class="string">&quot; WITH (&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;connector&#x27;=&#x27;filesystem&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;path&#x27;=&#x27;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;format&#x27;=&#x27;csv&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//    å¯ä»¥ä½¿ç”¨ TableEnvironment ä¸­çš„ executeSql() æ–¹æ³•æ‰§è¡Œ CREATE è¯­å¥ã€‚ è‹¥ CREATE æ“ä½œæ‰§è¡ŒæˆåŠŸï¼ŒexecuteSql() æ–¹æ³•è¿”å› â€˜OKâ€™ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    ä»¥ä¸‹çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•åœ¨ TableEnvironment ä¸­æ‰§è¡Œä¸€ä¸ª CREATE è¯­å¥ã€‚</span></span><br><span class="line">    tableEnv.executeSql(fileSystemSql)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tableå¯¹è±¡æ²¡æœ‰æ–¹æ³•toAppendStreamçš„ï¼Œ åªæœ‰é€šè¿‡å¯¼å…¥éšå¼è½¬æ¢çš„åŒ…æ‰å¯ä»¥å®ç°æ­¤åŠŸèƒ½</span></span><br><span class="line">    <span class="keyword">import</span> org.apache.flink.table.api.bridge.scala.tableConversions</span><br><span class="line">    <span class="comment">// SQLå½¢å¼</span></span><br><span class="line">    tableEnv.sqlQuery(<span class="string">&quot;select * from fs_table&quot;</span>).toAppendStream[(<span class="type">String</span>, <span class="type">String</span>, <span class="type">Double</span>)].print()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Table APIå½¢å¼</span></span><br><span class="line">    <span class="keyword">val</span> table: <span class="type">Table</span> = tableEnv.from(<span class="string">&quot;fs_table&quot;</span>)</span><br><span class="line">    table.select($(<span class="string">&quot;id&quot;</span>), $(<span class="string">&quot;ts&quot;</span>), $(<span class="string">&quot;temp&quot;</span>)).toAppendStream[(<span class="type">String</span>, <span class="type">String</span>, <span class="type">Double</span>)].print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p><strong>éœ€è¦æ³¨æ„çš„ç‚¹</strong></p><ol><li>ä½¿ç”¨ TableEnvironment ä¸­çš„ executeSql() æ–¹æ³•æ‰§è¡Œ CREATE è¯­å¥ã€‚ è‹¥ CREATE æ“ä½œæ‰§è¡ŒæˆåŠŸï¼ŒexecuteSql() æ–¹æ³•è¿”å› â€˜OKâ€™ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</li><li>åœ¨è®¡ç®—Tableè¾“å‡ºæ—¶ï¼Œ<strong>Tableæ²¡æœ‰æ‰“å°åˆ°æ§åˆ¶å°çš„æ–¹æ³•ï¼Œå¿…é¡»è½¬æ¢ä¸ºæµæ‰èƒ½è¾“å‡º</strong></li><li>Tableå¯¹è±¡æ²¡æœ‰æ–¹æ³•toAppendStreamçš„ï¼Œ åªæœ‰é€šè¿‡å¯¼å…¥éšå¼è½¬æ¢çš„åŒ…æ‰å¯ä»¥å®ç°æ­¤åŠŸèƒ½</li><li>Table APIå·²ç»ä¸çŸ¥é“å‚æ•°ä¸ºStringçš„æ–¹æ³•ï¼Œéœ€è¦é€šè¿‡<code>($(&quot;id&quot;)</code>å½¢å¼ä½¿ç”¨</li></ol></blockquote><h4 id="DataStreamè½¬æ¢"><a href="#DataStreamè½¬æ¢" class="headerlink" title="DataStreamè½¬æ¢"></a>DataStreamè½¬æ¢</h4><p>ä¸€èˆ¬éƒ½é€šè¿‡DATa Streamè½¬æ¢è€Œæ¥ï¼š</p><p>åŒ…ä¸è¦åˆ°å¯¼é”™</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.&#123;<span class="type">DataStream</span>, <span class="type">StreamExecutionEnvironment</span>, createTypeInformation&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.<span class="type">Expressions</span>.$</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.<span class="type">Table</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.bridge.scala._</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">FromDataStreamByFileSystem</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–æµï¼Œæœ¬åœ°æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">val</span> inputStream: <span class="type">DataStream</span>[(<span class="type">String</span>, <span class="type">String</span>, <span class="type">String</span>)] = env.readTextFile(<span class="string">&quot;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&quot;</span>, <span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">      .map(r =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> strings: <span class="type">Array</span>[<span class="type">String</span>] = r.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        (strings(<span class="number">0</span>), strings(<span class="number">1</span>), strings(<span class="number">2</span>))</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æµè½¬æ¢ä¸ºè¡¨</span></span><br><span class="line">    <span class="keyword">val</span> inputTable: <span class="type">Table</span> = tableEnv.fromDataStream(inputStream, $(<span class="string">&quot;id&quot;</span>), $(<span class="string">&quot;ts&quot;</span>), $(<span class="string">&quot;temp&quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sql,å¿…é¡»åœ¨ç¯å¢ƒä¸­åˆ›å»ºäº†è¡¨ä¹‹åæ‰èƒ½ç”¨</span></span><br><span class="line">    tableEnv.createTemporaryView(<span class="string">&quot;myTable&quot;</span>, inputTable)</span><br><span class="line">    tableEnv.sqlQuery(<span class="string">&quot;select * from myTable&quot;</span>)</span><br><span class="line">        .toAppendStream[(<span class="type">String</span>, <span class="type">String</span>, <span class="type">String</span>)].print(<span class="string">&quot;sql&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// table api</span></span><br><span class="line">    inputTable.select($(<span class="string">&quot;id&quot;</span>), $(<span class="string">&quot;ts&quot;</span>), $(<span class="string">&quot;temp&quot;</span>)).toAppendStream[(<span class="type">String</span>, <span class="type">String</span>, <span class="type">String</span>)].print(<span class="string">&quot;tableApi&quot;</span>)</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>æ•°æ®ç±»å‹å’ŒSchemaçš„å¯¹åº”å…³ç³»</em></p><p>åŸºäºä½ç½®ï¼š</p><p><code> tableEnv.fromDataStream(inputStream, $(&quot;id&quot;), $(&quot;ts&quot;), $(&quot;temp&quot;))</code></p><h3 id="åˆ›å»ºä¸´æ—¶è§†å›¾"><a href="#åˆ›å»ºä¸´æ—¶è§†å›¾" class="headerlink" title="åˆ›å»ºä¸´æ—¶è§†å›¾"></a>åˆ›å»ºä¸´æ—¶è§†å›¾</h3><p><strong>åŸºäºDataStream</strong></p><p><code>def createTemporaryView[T](path : scala.Predef.String, dataStream : org.apache.flink.streaming.api.scala.DataStream[T]) : scala.Unit</code></p><p><strong>åŸºäºè¡¨</strong></p><p><code>void createTemporaryView(String path, Table view);</code></p><h3 id="è¾“å‡ºè¡¨ğŸ”º"><a href="#è¾“å‡ºè¡¨ğŸ”º" class="headerlink" title="è¾“å‡ºè¡¨ğŸ”º"></a>è¾“å‡ºè¡¨ğŸ”º</h3><p>å¯¹äºç»‘å®šå¤–éƒ¨ç³»ç»Ÿçš„ä¸¤ä¸ªè¡¨è¿›è¡Œä¸€ä¸‹æ“ä½œå³å¯è¾“å‡ºï¼š</p><p><code>inputTable.executeInsert(&quot;table_other&quot;)</code></p><p>ä½†æ˜¯å»ºè®®ä»¥ä¸‹é¢çš„æµç¨‹è¾“å‡ºï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110161619800.png" alt="image-20210110161619800"></p><h1 id="æ›´æ–°æ¨¡å¼ğŸ”º"><a href="#æ›´æ–°æ¨¡å¼ğŸ”º" class="headerlink" title="æ›´æ–°æ¨¡å¼ğŸ”º"></a>æ›´æ–°æ¨¡å¼ğŸ”º</h1><p>åœ¨æµå¤„ç†è¿‡ç¨‹ä¸­ï¼Œè¡¨çš„å¤„ç†å¹¶ä¸åƒä¼ ç»Ÿå®šä¹‰çš„é‚£æ ·ç®€å•ã€‚ç”±ä¸Šé¢çš„æè¿°å¯çŸ¥Tableå¯¹è±¡å¹¶æ²¡æœ‰è¾“å‡ºåˆ°æ§åˆ¶å°çš„æ–¹æ³•ï¼Œå®ƒåªèƒ½é€šè¿‡è½¬æ¢ä¸ºæµæ‰å¯ä»¥è¾“å‡ºåˆ°æ§åˆ¶å°ã€‚</p><p>å¯¹äºæµå¼æŸ¥è¯¢ï¼ˆStreaming Queriesï¼‰ï¼Œéœ€è¦å£°æ˜å¦‚ä½•åœ¨ï¼ˆåŠ¨æ€ï¼‰è¡¨å’Œå¤–éƒ¨è¿æ¥å™¨ä¹‹é—´æ‰§è¡Œè½¬æ¢ã€‚ä¸å¤–éƒ¨ç³»ç»Ÿäº¤æ¢çš„æ¶ˆæ¯ç±»å‹ï¼Œç”±æ›´æ–°æ¨¡å¼ï¼ˆupdate modeï¼‰æŒ‡å®šã€‚</p><p><strong>Flink Table APIä¸­çš„æ›´æ–°æ¨¡å¼æœ‰ä»¥ä¸‹ä¸‰ç§ï¼š</strong></p><ol><li>è¿½åŠ æ¨¡å¼ï¼ˆAppend Modeï¼‰ï¼šåœ¨è¿½åŠ æ¨¡å¼ä¸‹ï¼Œè¡¨ï¼ˆåŠ¨æ€è¡¨ï¼‰å’Œå¤–éƒ¨è¿æ¥å™¨åªäº¤æ¢æ’å…¥ï¼ˆInsertï¼‰æ¶ˆæ¯ã€‚å³ï¼Œtableçš„ä¸€æ¡ä¿¡æ¯å‘é€åå°±ä¸ä¼šæ›´å˜</li><li>æ’¤å›æ¨¡å¼ï¼ˆRetract Modeï¼‰ï¼šåœ¨æ’¤å›æ¨¡å¼ä¸‹ï¼Œè¡¨å’Œå¤–éƒ¨è¿æ¥å™¨äº¤æ¢çš„æ˜¯ï¼šæ·»åŠ ï¼ˆAddï¼‰å’Œæ’¤å›ï¼ˆRetractï¼‰æ¶ˆæ¯ã€‚å³ï¼šä¸€èˆ¬èšåˆæ“ä½œæ—¶ï¼ˆæœªå¼€çª—æ—¶ï¼‰æ˜¯ä¸€æ¡è®°å½•æ¥äº†å°±èšåˆä¸€æ¬¡ï¼Œå½“å†æ¬¡æ¥ä¸€ä¸ªå·²ç»èšåˆè¿‡çš„æ•°æ®æ—¶å°±ä¼šå¯¹ä»¥å‰çš„æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œè€Œå®ƒæ˜¯é€šè¿‡æ’¤å›ä¹‹å‰çš„ç»“æœå’Œæ’å…¥æœ€æ–°çš„ç»“æœå®ç°æœ€æ–°çš„èšåˆç»“æœçš„ã€‚</li><li>Upsertï¼ˆæ›´æ–°æ’å…¥ï¼‰æ¨¡å¼ï¼šåœ¨Upsertæ¨¡å¼ä¸‹ï¼ŒåŠ¨æ€è¡¨å’Œå¤–éƒ¨è¿æ¥å™¨äº¤æ¢Upsertå’ŒDeleteæ¶ˆæ¯ã€‚</li></ol><p><em>Upsertæ¨¡å¼</em></p><p>è¿™ä¸ªæ¨¡å¼éœ€è¦ä¸€ä¸ªå”¯ä¸€çš„keyï¼Œé€šè¿‡è¿™ä¸ªkeyå¯ä»¥ä¼ é€’æ›´æ–°æ¶ˆæ¯ã€‚ä¸ºäº†æ­£ç¡®åº”ç”¨æ¶ˆæ¯ï¼Œå¤–éƒ¨è¿æ¥å™¨éœ€è¦çŸ¥é“è¿™ä¸ªå”¯ä¸€keyçš„å±æ€§</p><p>å³ï¼šä¸€èˆ¬èšåˆæ“ä½œæ—¶ï¼ˆæœªå¼€çª—æ—¶ï¼‰æ˜¯ä¸€æ¡è®°å½•æ¥äº†å°±èšåˆä¸€æ¬¡ï¼Œå½“å†æ¬¡æ¥ä¸€ä¸ªå·²ç»èšåˆè¿‡çš„æ•°æ®æ—¶å°±ä¼šå¯¹ä»¥å‰çš„æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œè€Œå®ƒæ˜¯é€šè¿‡keyå”¯ä¸€ç¡®å®šæ˜¯æ›´æ–°è¿˜æ˜¯æ’å…¥çš„ï¼›è¿˜èƒ½åˆ é™¤ï¼ˆDeleteï¼‰ç¼–ç ä¸ºDeleteä¿¡æ¯ã€‚</p><hr><p>å„ä¸ªæ¨¡å¼æ”¯æŒçš„å¤–éƒ¨ç³»ç»Ÿï¼š</p><ol><li>è¿½åŠ æ¨¡å¼ï¼ˆAppend Modeï¼‰ï¼šæ§åˆ¶å°ã€æ–‡ä»¶ã€DBã€Redisã€ElasticSearch</li><li>æ’¤å›æ¨¡å¼ï¼ˆRetract Modeï¼‰ï¼šæ§åˆ¶å°ã€DBã€Redisã€ElasticSearch</li><li>Upsertï¼ˆæ›´æ–°æ’å…¥ï¼‰æ¨¡å¼ï¼šæ§åˆ¶å°ã€DBã€Redisã€ElasticSearch</li></ol><h2 id="å°†è¡¨è½¬ä¸ºDataStream"><a href="#å°†è¡¨è½¬ä¸ºDataStream" class="headerlink" title="å°†è¡¨è½¬ä¸ºDataStream"></a>å°†è¡¨è½¬ä¸ºDataStream</h2><p>æ­¤æ—¶å°±éœ€è¦æ ¹æ®Tableçš„æ“ä½œæ¥é€‰æ‹©ä¸åŒçš„æ›´æ–°æ¨¡å¼</p><p>Table APIä¸­è¡¨åˆ°DataStreamæœ‰ä¸¤ç§æ¨¡å¼ï¼š</p><ol><li>è¿½åŠ æ¨¡å¼ï¼ˆAppend Modeï¼‰</li><li>æ’¤å›æ¨¡å¼ï¼ˆRetract Modeï¼‰<ol><li>å¾—åˆ°çš„æ•°æ®ä¼šå¢åŠ ä¸€ä¸ªBooleanç±»å‹çš„æ ‡è¯†ä½ï¼ˆè¿”å›çš„ç¬¬ä¸€ä¸ªå­—æ®µï¼‰ï¼Œç”¨å®ƒæ¥è¡¨ç¤ºåˆ°åº•æ˜¯æ–°å¢çš„æ•°æ®ï¼ˆInsertï¼‰ï¼Œè¿˜æ˜¯è¢«åˆ é™¤çš„æ•°æ®ï¼ˆè€æ•°æ®ï¼ŒDeleteï¼‰ã€‚</li></ol></li></ol><blockquote><p>åœ¨ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦ä½¿ç”¨æ’¤å›æ¨¡å¼ï¼ˆRetract Modeï¼‰</p><p>ä¸€èˆ¬èšåˆæ“ä½œæ—¶ï¼ˆæœªå¼€çª—æ—¶ï¼‰æ˜¯ä¸€æ¡è®°å½•æ¥äº†å°±èšåˆä¸€æ¬¡ï¼Œå½“å†æ¬¡æ¥ä¸€ä¸ªå·²ç»èšåˆè¿‡çš„æ•°æ®æ—¶å°±ä¼šå¯¹ä»¥å‰çš„æ•°æ®è¿›è¡Œæ›´æ–°</p><p>æ‰€ä»¥æ’¤å›æ¨¡å¼ï¼ˆRetract Modeï¼‰æ˜¯é€šè¿‡æ’¤å›ä¹‹å‰çš„ç»“æœå’Œæ’å…¥æœ€æ–°çš„ç»“æœå®ç°æœ€æ–°çš„èšåˆç»“æœçš„ã€‚</p><p>è€Œæ­¤æ—¶è¿½åŠ æ¨¡å¼ï¼ˆAppend Modeï¼‰åªèƒ½æ·»åŠ ä¸èƒ½æ›´æ”¹ï¼Œæ‰€ä»¥ä¸é€‚åˆæ²¡æœ‰å¼€çª—çš„èšåˆæƒ…å†µçš„</p><p>ä½†æ˜¯ä¸ºä»€ä¹ˆè¦åˆ¶å®šæ²¡æœ‰å¼€çª—ï¼Ÿ</p><p><font color="red">å› ä¸ºæ²¡æœ‰å¼€çª—æ˜¯æ¥ä¸€æ¡èšåˆä¸€æ¡çš„ï¼Œè€Œå¼€çª—æ˜¯æ¥ä¸€æ¡èšåˆä¸€æ¡ï¼Œä½†æ˜¯å¼€åˆ›ç»“æŸåæ‰å¼€å§‹å†™å…¥æµï¼Œæ‰€ä»¥å†™å…¥çš„æµçš„æ•°æ®ä¹Ÿä¸ä¼šå˜ï¼Œæ‰€ä»¥è¿™æ—¶å€™æ”¯æŒè¿½åŠ æ¨¡å¼ï¼ˆAppend Modeï¼‰</font></p></blockquote><p>ä¾‹å­è¯æ˜ï¼š</p><ol><li>æ²¡æœ‰èšåˆæ“ä½œçš„ä½¿ç”¨è¿½åŠ æ¨¡å¼ï¼ˆAppend Modeï¼‰è½¬ä¸º<code>toAppendStream</code></li><li>æœ‰èšåˆæ“ä½œçš„ä½¿ç”¨è¿½åŠ æ¨¡å¼ï¼ˆAppend Modeï¼‰è½¬ä¸º<code>toAppendStream</code>ï¼Œé”™è¯¯</li><li>æœ‰èšåˆæ“ä½œçš„ä½¿ç”¨æ’¤å›æ¨¡å¼ï¼ˆRetract Modeï¼‰è½¬ä¸º<code>toRetractStream</code>ï¼Œæ­£ç¡®</li></ol><p><strong>1.</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">FromDataStreamByFileSystem</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–æµï¼Œæœ¬åœ°æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">val</span> inputStream: <span class="type">DataStream</span>[(<span class="type">String</span>, <span class="type">String</span>, <span class="type">String</span>)] = env.readTextFile(<span class="string">&quot;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&quot;</span>, <span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">      .map(r =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> strings: <span class="type">Array</span>[<span class="type">String</span>] = r.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        (strings(<span class="number">0</span>), strings(<span class="number">1</span>), strings(<span class="number">2</span>))</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æµè½¬æ¢ä¸ºè¡¨</span></span><br><span class="line">    <span class="keyword">val</span> inputTable: <span class="type">Table</span> = tableEnv.fromDataStream(inputStream, $(<span class="string">&quot;id&quot;</span>), $(<span class="string">&quot;ts&quot;</span>), $(<span class="string">&quot;temp&quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sql,å¿…é¡»åœ¨ç¯å¢ƒä¸­åˆ›å»ºäº†è¡¨ä¹‹åæ‰èƒ½ç”¨</span></span><br><span class="line">    tableEnv.createTemporaryView(<span class="string">&quot;myTable&quot;</span>, inputTable)</span><br><span class="line">    tableEnv.sqlQuery(<span class="string">&quot;select * from myTable&quot;</span>)</span><br><span class="line">        .toAppendStream[(<span class="type">String</span>, <span class="type">String</span>, <span class="type">String</span>)].print(<span class="string">&quot;sql&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// table api</span></span><br><span class="line">    inputTable.select($(<span class="string">&quot;id&quot;</span>), $(<span class="string">&quot;ts&quot;</span>), $(<span class="string">&quot;temp&quot;</span>)).toAppendStream[(<span class="type">String</span>, <span class="type">String</span>, <span class="type">String</span>)].print(<span class="string">&quot;tableApi&quot;</span>)</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2.</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">CountExample</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileSystemSql: <span class="type">String</span> = <span class="string">&quot;CREATE TABLE fs_table &quot;</span> +</span><br><span class="line">      <span class="string">&quot;(id STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot; ts STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;  temp DOUBLE) &quot;</span> +</span><br><span class="line">      <span class="string">&quot; WITH (&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;connector&#x27;=&#x27;filesystem&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;path&#x27;=&#x27;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;format&#x27;=&#x27;csv&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//    å¯ä»¥ä½¿ç”¨ TableEnvironment ä¸­çš„ executeSql() æ–¹æ³•æ‰§è¡Œ CREATE è¯­å¥ã€‚ è‹¥ CREATE æ“ä½œæ‰§è¡ŒæˆåŠŸï¼ŒexecuteSql() æ–¹æ³•è¿”å› â€˜OKâ€™ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//    ä»¥ä¸‹çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•åœ¨ TableEnvironment ä¸­æ‰§è¡Œä¸€ä¸ª CREATE è¯­å¥ã€‚</span></span><br><span class="line">    tableEnv.executeSql(fileSystemSql)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tableå¯¹è±¡æ²¡æœ‰æ–¹æ³•toAppendStreamçš„ï¼Œ åªæœ‰é€šè¿‡å¯¼å…¥éšå¼è½¬æ¢çš„åŒ…æ‰å¯ä»¥å®ç°æ­¤åŠŸèƒ½</span></span><br><span class="line">    <span class="keyword">import</span> org.apache.flink.table.api.bridge.scala.tableConversions</span><br><span class="line">    <span class="comment">// SQLå½¢å¼</span></span><br><span class="line">    tableEnv.sqlQuery(<span class="string">&quot;select id,avg(temp) from fs_table group by id&quot;</span>).toAppendStream[(<span class="type">String</span>,</span><br><span class="line">      <span class="type">Double</span>)]</span><br><span class="line">      .print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110163624481.png" alt="image-20210110163624481"></p><blockquote><p>æ„æ€æ˜¯ï¼Œ<code>toAppendStream</code>ä¸æ”¯æŒupdateï¼Œæ‰€ä»¥å¾—ä½¿ç”¨<code>toRetractStream</code></p></blockquote><p><strong>3.</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">CountExample</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileSystemSql: <span class="type">String</span> = <span class="string">&quot;CREATE TABLE fs_table &quot;</span> +</span><br><span class="line">      <span class="string">&quot;(id STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot; ts STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;  temp DOUBLE) &quot;</span> +</span><br><span class="line">      <span class="string">&quot; WITH (&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;connector&#x27;=&#x27;filesystem&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;path&#x27;=&#x27;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;format&#x27;=&#x27;csv&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//    å¯ä»¥ä½¿ç”¨ TableEnvironment ä¸­çš„ executeSql() æ–¹æ³•æ‰§è¡Œ CREATE è¯­å¥ã€‚ è‹¥ CREATE æ“ä½œæ‰§è¡ŒæˆåŠŸï¼ŒexecuteSql() æ–¹æ³•è¿”å› â€˜OKâ€™ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//    ä»¥ä¸‹çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•åœ¨ TableEnvironment ä¸­æ‰§è¡Œä¸€ä¸ª CREATE è¯­å¥ã€‚</span></span><br><span class="line">    tableEnv.executeSql(fileSystemSql)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tableå¯¹è±¡æ²¡æœ‰æ–¹æ³•toAppendStreamçš„ï¼Œ åªæœ‰é€šè¿‡å¯¼å…¥éšå¼è½¬æ¢çš„åŒ…æ‰å¯ä»¥å®ç°æ­¤åŠŸèƒ½</span></span><br><span class="line">    <span class="keyword">import</span> org.apache.flink.table.api.bridge.scala.tableConversions</span><br><span class="line">    <span class="comment">// SQLå½¢å¼</span></span><br><span class="line">    tableEnv.sqlQuery(<span class="string">&quot;select id,avg(temp) from fs_table group by id&quot;</span>).toRetractStream[(<span class="type">String</span>,</span><br><span class="line">      <span class="type">Double</span>)]</span><br><span class="line">      .print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110163733258.png" alt="image-20210110163733258"></p><p>trueå’Œfalseä»£è¡¨æ˜¯æœ¬åˆ†ç»„çš„èšåˆæ˜¯ç¬¬ä¸€æ¬¡æ¥è¿˜æ˜¯ç¬¬næ¬¡æ¥</p><ol><li>ç¬¬ä¸€ä¸ªçº¢æ¡†ä»£è¡¨idä¸ºsensor1çš„æ•°æ®ç¬¬ä¸€ä¸ªèšåˆ</li><li>ç¬¬äºŒä¸ªçº¢æ¡†ä»£è¡¨idä¸ºsensor1çš„æ•°æ®ç¬¬äºŒæ¬¡èšåˆå‰æ’¤å›ä¹‹å‰çš„ç»“æœ</li><li>ç¬¬äºŒä¸ªçº¢æ¡†ä¸‹é¢çš„ç¬¬ä¸€ä¸ªæ•°æ®ä»£è¡¨idä¸ºsensor1çš„æ•°æ®ç¬¬äºŒæ¬¡èšåˆåçš„æ›´æ–°ç»“æœ</li></ol><h1 id="æµå¤„ç†ä¸­çš„ç‰¹æ®Šæ¦‚å¿µğŸ”º"><a href="#æµå¤„ç†ä¸­çš„ç‰¹æ®Šæ¦‚å¿µğŸ”º" class="headerlink" title="æµå¤„ç†ä¸­çš„ç‰¹æ®Šæ¦‚å¿µğŸ”º"></a>æµå¤„ç†ä¸­çš„ç‰¹æ®Šæ¦‚å¿µğŸ”º</h1><p>Table APIå’ŒSQLï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯åŸºäºå…³ç³»å‹è¡¨çš„æ“ä½œæ–¹å¼ï¼›è€Œå…³ç³»å‹è¡¨ã€å…³ç³»ä»£æ•°ï¼Œä»¥åŠSQLæœ¬èº«ï¼Œä¸€èˆ¬æ˜¯æœ‰ç•Œçš„ï¼Œæ›´é€‚åˆæ‰¹å¤„ç†çš„åœºæ™¯ã€‚è¿™å°±å¯¼è‡´åœ¨è¿›è¡Œæµå¤„ç†çš„è¿‡ç¨‹ä¸­ï¼Œç†è§£ä¼šç¨å¾®å¤æ‚ä¸€äº›ï¼Œéœ€è¦å¼•å…¥ä¸€äº›ç‰¹æ®Šæ¦‚å¿µã€‚</p><h2 id="æµå¤„ç†å’Œå…³ç³»ä»£æ•°ï¼ˆè¡¨ï¼ŒåŠ-SQLï¼‰çš„åŒºåˆ«"><a href="#æµå¤„ç†å’Œå…³ç³»ä»£æ•°ï¼ˆè¡¨ï¼ŒåŠ-SQLï¼‰çš„åŒºåˆ«" class="headerlink" title="æµå¤„ç†å’Œå…³ç³»ä»£æ•°ï¼ˆè¡¨ï¼ŒåŠ SQLï¼‰çš„åŒºåˆ«"></a>æµå¤„ç†å’Œå…³ç³»ä»£æ•°ï¼ˆè¡¨ï¼ŒåŠ SQLï¼‰çš„åŒºåˆ«</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110164925069.png" alt="image-20210110164925069"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå…¶å®å…³ç³»ä»£æ•°ï¼ˆä¸»è¦å°±æ˜¯æŒ‡å…³ç³»å‹æ•°æ®åº“ä¸­çš„è¡¨ï¼‰å’Œ SQLï¼Œä¸»è¦å°±æ˜¯é’ˆå¯¹æ‰¹ å¤„ç†çš„ï¼Œè¿™å’Œæµå¤„ç†æœ‰å¤©ç”Ÿçš„éš”é˜‚ã€‚</p><h2 id="åŠ¨æ€è¡¨ï¼ˆDynamic-Tablesï¼‰"><a href="#åŠ¨æ€è¡¨ï¼ˆDynamic-Tablesï¼‰" class="headerlink" title="åŠ¨æ€è¡¨ï¼ˆDynamic Tablesï¼‰"></a>åŠ¨æ€è¡¨ï¼ˆDynamic Tablesï¼‰</h2><p>å› ä¸ºæµå¤„ç†é¢å¯¹çš„æ•°æ®ï¼Œæ˜¯è¿ç»­ä¸æ–­çš„ï¼Œè¿™å’Œæˆ‘ä»¬ç†Ÿæ‚‰çš„å…³ç³»å‹æ•°æ®åº“ä¸­ä¿å­˜çš„â€œè¡¨â€ å®Œå…¨ä¸åŒã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬æŠŠæµæ•°æ®è½¬æ¢æˆ Tableï¼Œç„¶åæ‰§è¡Œç±»ä¼¼äº table çš„ select æ“ä½œï¼Œç»“ æœå°±ä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œè€Œæ˜¯éšç€æ–°æ•°æ®çš„åˆ°æ¥ï¼Œä¼šä¸åœæ›´æ–°ã€‚ </p><p>æˆ‘ä»¬å¯ä»¥éšç€æ–°æ•°æ®çš„åˆ°æ¥ï¼Œä¸åœåœ°åœ¨ä¹‹å‰çš„åŸºç¡€ä¸Šæ›´æ–°ç»“æœã€‚è¿™æ ·å¾—åˆ°çš„è¡¨ï¼Œåœ¨ Flink Table API æ¦‚å¿µé‡Œï¼Œå°±å«åš<strong>â€œåŠ¨æ€è¡¨â€ï¼ˆDynamic Tablesï¼‰</strong>ã€‚</p><p>åŠ¨æ€è¡¨æ˜¯ Flink å¯¹æµæ•°æ®çš„ Table API å’Œ SQL æ”¯æŒçš„æ ¸å¿ƒæ¦‚å¿µã€‚ä¸è¡¨ç¤ºæ‰¹å¤„ç†æ•°æ®çš„é™æ€ è¡¨ä¸åŒï¼ŒåŠ¨æ€è¡¨æ˜¯éšæ—¶é—´å˜åŒ–çš„ã€‚åŠ¨æ€è¡¨å¯ä»¥åƒé™æ€çš„æ‰¹å¤„ç†è¡¨ä¸€æ ·è¿›è¡ŒæŸ¥è¯¢ï¼ŒæŸ¥è¯¢ä¸€ä¸ªåŠ¨ æ€è¡¨ä¼šäº§ç”ŸæŒç»­æŸ¥è¯¢ï¼ˆContinuous Queryï¼‰ã€‚è¿ç»­æŸ¥è¯¢æ°¸è¿œä¸ä¼šç»ˆæ­¢ï¼Œå¹¶ä¼šç”Ÿæˆå¦ä¸€ä¸ªåŠ¨æ€è¡¨ã€‚ æŸ¥è¯¢ï¼ˆQueryï¼‰ä¼šä¸æ–­æ›´æ–°å…¶åŠ¨æ€ç»“æœè¡¨ï¼Œä»¥åæ˜ å…¶åŠ¨æ€è¾“å…¥è¡¨ä¸Šçš„æ›´æ”¹ã€‚</p><h2 id="æµå¼æŒç»­æŸ¥è¯¢çš„è¿‡ç¨‹"><a href="#æµå¼æŒç»­æŸ¥è¯¢çš„è¿‡ç¨‹" class="headerlink" title="æµå¼æŒç»­æŸ¥è¯¢çš„è¿‡ç¨‹"></a>æµå¼æŒç»­æŸ¥è¯¢çš„è¿‡ç¨‹</h2><p>ä¸‹å›¾æ˜¾ç¤ºäº†æµã€åŠ¨æ€è¡¨å’Œè¿ç»­æŸ¥è¯¢çš„å…³ç³»ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110165032290.png" alt="image-20210110165032290"></p><p>æµå¼æŒç»­æŸ¥è¯¢çš„è¿‡ç¨‹ä¸ºï¼š </p><ol><li>æµè¢«è½¬æ¢ä¸ºåŠ¨æ€è¡¨ã€‚</li><li>å¯¹åŠ¨æ€è¡¨è®¡ç®—è¿ç»­æŸ¥è¯¢ï¼Œç”Ÿæˆæ–°çš„åŠ¨æ€è¡¨ã€‚</li><li>ç”Ÿæˆçš„åŠ¨æ€è¡¨è¢«è½¬æ¢å›æµ</li></ol><h3 id="å°†æµè½¬æ¢æˆè¡¨ï¼ˆTableï¼‰"><a href="#å°†æµè½¬æ¢æˆè¡¨ï¼ˆTableï¼‰" class="headerlink" title="å°†æµè½¬æ¢æˆè¡¨ï¼ˆTableï¼‰"></a>å°†æµè½¬æ¢æˆè¡¨ï¼ˆTableï¼‰</h3><p>ä¸ºäº†å¤„ç†å¸¦æœ‰å…³ç³»æŸ¥è¯¢çš„æµï¼Œå¿…é¡»å…ˆå°†å…¶è½¬æ¢ä¸ºè¡¨ã€‚ </p><p>ä»æ¦‚å¿µä¸Šè®²ï¼Œæµçš„æ¯ä¸ªæ•°æ®è®°å½•ï¼Œéƒ½è¢«è§£é‡Šä¸ºå¯¹ç»“æœè¡¨çš„æ’å…¥ï¼ˆInsertï¼‰ä¿®æ”¹ã€‚å› ä¸ºæµ å¼æŒç»­ä¸æ–­çš„ï¼Œè€Œä¸”ä¹‹å‰çš„è¾“å‡ºç»“æœæ— æ³•æ”¹å˜ã€‚æœ¬è´¨ä¸Šï¼Œæˆ‘ä»¬å…¶å®æ˜¯ä»ä¸€ä¸ªã€åªæœ‰æ’å…¥æ“ä½œ çš„ changelogï¼ˆæ›´æ–°æ—¥å¿—ï¼‰æµï¼Œæ¥æ„å»ºä¸€ä¸ªè¡¨ã€‚ </p><p>ä¸ºäº†æ›´å¥½åœ°è¯´æ˜åŠ¨æ€è¡¨å’ŒæŒç»­æŸ¥è¯¢çš„æ¦‚å¿µï¼Œæˆ‘ä»¬æ¥ä¸¾ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ã€‚ æ¯”å¦‚ï¼Œæˆ‘ä»¬ç°åœ¨çš„è¾“å…¥æ•°æ®ï¼Œå°±æ˜¯ç”¨æˆ·åœ¨ç½‘ç«™ä¸Šçš„è®¿é—®è¡Œä¸ºï¼Œæ•°æ®ç±»å‹ï¼ˆSchemaï¼‰å¦‚ ä¸‹ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line"> user: VARCHAR, <span class="comment">// ç”¨æˆ·å</span></span><br><span class="line"> cTime: TIMESTAMP, <span class="comment">// è®¿é—®æŸä¸ª URL çš„æ—¶é—´æˆ³</span></span><br><span class="line"> url: VARCHAR <span class="comment">// ç”¨æˆ·è®¿é—®çš„ URL</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>ä¸‹å›¾æ˜¾ç¤ºäº†å¦‚ä½•å°†è®¿é—® URL äº‹ä»¶æµï¼Œæˆ–è€…å«ç‚¹å‡»äº‹ä»¶æµï¼ˆå·¦ä¾§ï¼‰è½¬æ¢ä¸ºè¡¨ï¼ˆå³ä¾§ï¼‰ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110165202118.png" alt="image-20210110165202118"></p><p>éšç€æ’å…¥æ›´å¤šçš„è®¿é—®äº‹ä»¶æµè®°å½•ï¼Œç”Ÿæˆçš„è¡¨å°†ä¸æ–­å¢é•¿ã€‚</p><h3 id="æŒç»­æŸ¥è¯¢ï¼ˆContinuous-Queryï¼‰"><a href="#æŒç»­æŸ¥è¯¢ï¼ˆContinuous-Queryï¼‰" class="headerlink" title="æŒç»­æŸ¥è¯¢ï¼ˆContinuous Queryï¼‰"></a>æŒç»­æŸ¥è¯¢ï¼ˆContinuous Queryï¼‰</h3><p>æŒç»­æŸ¥è¯¢ï¼Œä¼šåœ¨åŠ¨æ€è¡¨ä¸Šåšè®¡ç®—å¤„ç†ï¼Œå¹¶ä½œä¸ºç»“æœç”Ÿæˆæ–°çš„åŠ¨æ€è¡¨ã€‚ä¸æ‰¹å¤„ç†æŸ¥è¯¢ä¸åŒï¼Œ è¿ç»­æŸ¥è¯¢ä»ä¸ç»ˆæ­¢ï¼Œå¹¶æ ¹æ®è¾“å…¥è¡¨ä¸Šçš„æ›´æ–°æ›´æ–°å…¶ç»“æœè¡¨ã€‚ </p><p>åœ¨ä»»ä½•æ—¶é—´ç‚¹ï¼Œè¿ç»­æŸ¥è¯¢çš„ç»“æœåœ¨è¯­ä¹‰ä¸Šï¼Œç­‰åŒäºåœ¨è¾“å…¥è¡¨çš„å¿«ç…§ä¸Šï¼Œä»¥æ‰¹å¤„ç†æ¨¡å¼æ‰§ è¡Œçš„åŒä¸€æŸ¥è¯¢çš„ç»“æœã€‚</p><p> åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å±•ç¤ºäº†å¯¹ç‚¹å‡»äº‹ä»¶æµä¸­çš„ä¸€ä¸ªæŒç»­æŸ¥è¯¢ã€‚</p><p> è¿™ä¸ª Query å¾ˆç®€å•ï¼Œæ˜¯ä¸€ä¸ªåˆ†ç»„èšåˆåš count ç»Ÿè®¡çš„æŸ¥è¯¢ã€‚å®ƒå°†ç”¨æˆ·å­—æ®µä¸Šçš„ clicks è¡¨ åˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡è®¿é—®çš„ url æ•°ã€‚å›¾ä¸­æ˜¾ç¤ºäº†éšç€æ—¶é—´çš„æ¨ç§»ï¼Œå½“ clicks è¡¨è¢«å…¶ä»–è¡Œæ›´æ–°æ—¶å¦‚ä½• è®¡ç®—æŸ¥è¯¢ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110165244001.png" alt="image-20210110165244001"></p><blockquote><p>è¾“å…¥çš„è¡¨å’Œè®¡ç®—åçš„è¡¨éƒ½æ˜¯åŠ¨æ€è¡¨</p></blockquote><h3 id="å°†åŠ¨æ€è¡¨è½¬æ¢æˆæµ"><a href="#å°†åŠ¨æ€è¡¨è½¬æ¢æˆæµ" class="headerlink" title="å°†åŠ¨æ€è¡¨è½¬æ¢æˆæµ"></a>å°†åŠ¨æ€è¡¨è½¬æ¢æˆæµ</h3><p>ä¸å¸¸è§„çš„æ•°æ®åº“è¡¨ä¸€æ ·ï¼ŒåŠ¨æ€è¡¨å¯ä»¥é€šè¿‡æ’å…¥ï¼ˆInsertï¼‰ã€æ›´æ–°ï¼ˆUpdateï¼‰å’Œåˆ é™¤ï¼ˆDeleteï¼‰ æ›´æ”¹ï¼Œè¿›è¡ŒæŒç»­çš„ä¿®æ”¹ã€‚å°†åŠ¨æ€è¡¨è½¬æ¢ä¸ºæµæˆ–å°†å…¶å†™å…¥å¤–éƒ¨ç³»ç»Ÿæ—¶ï¼Œéœ€è¦å¯¹è¿™äº›æ›´æ”¹è¿›è¡Œç¼– ç ã€‚</p><p>Flink çš„ Table API å’Œ SQL æ”¯æŒä¸‰ç§æ–¹å¼å¯¹åŠ¨æ€è¡¨çš„æ›´æ”¹è¿›è¡Œç¼–ç ï¼š</p><p><strong>ä»…è¿½åŠ ï¼ˆAppend-onlyï¼‰æµ</strong></p><p>ä»…é€šè¿‡æ’å…¥ï¼ˆInsertï¼‰æ›´æ”¹ï¼Œæ¥ä¿®æ”¹çš„åŠ¨æ€è¡¨ï¼Œå¯ä»¥ç›´æ¥è½¬æ¢ä¸ºâ€œä»…è¿½åŠ â€æµã€‚è¿™ä¸ªæµ ä¸­å‘å‡ºçš„æ•°æ®ï¼Œå°±æ˜¯åŠ¨æ€è¡¨ä¸­æ–°å¢çš„æ¯ä¸€è¡Œã€‚</p><p><strong>æ’¤å›ï¼ˆRetractï¼‰æµ</strong></p><p>Retract æµæ˜¯åŒ…å«ä¸¤ç±»æ¶ˆæ¯çš„æµï¼Œæ·»åŠ ï¼ˆAddï¼‰æ¶ˆæ¯å’Œæ’¤å›ï¼ˆRetractï¼‰æ¶ˆæ¯ã€‚</p><p>åŠ¨æ€è¡¨é€šè¿‡å°† INSERT ç¼–ç ä¸º add æ¶ˆæ¯ã€DELETE ç¼–ç ä¸º retract æ¶ˆæ¯ã€UPDATE ç¼–ç ä¸ºè¢« æ›´æ”¹è¡Œï¼ˆå‰ä¸€è¡Œï¼‰çš„ retract æ¶ˆæ¯å’Œæ›´æ–°åè¡Œï¼ˆæ–°è¡Œï¼‰çš„ add æ¶ˆæ¯ï¼Œè½¬æ¢ä¸º retract æµã€‚</p><p>ä¸‹å›¾æ˜¾ç¤ºäº†å°†åŠ¨æ€è¡¨è½¬æ¢ä¸º Retract æµçš„è¿‡ç¨‹ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110165516501.png" alt="image-20210110165516501"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110165545721.png" alt="image-20210110165545721"></p><p><strong>Upsertï¼ˆæ›´æ–°æ’å…¥ï¼‰æµ</strong></p><p>Upsert æµåŒ…å«ä¸¤ç§ç±»å‹çš„æ¶ˆæ¯ï¼šUpsert æ¶ˆæ¯å’Œ delete æ¶ˆæ¯ã€‚è½¬æ¢ä¸º upsert æµçš„åŠ¨æ€è¡¨ï¼Œ éœ€è¦æœ‰å”¯ä¸€çš„é”®ï¼ˆkeyï¼‰ã€‚</p><p>é€šè¿‡å°† INSERT å’Œ UPDATE æ›´æ”¹ç¼–ç ä¸º upsert æ¶ˆæ¯ï¼Œå°† DELETE æ›´æ”¹ç¼–ç ä¸º DELETE æ¶ˆæ¯ï¼Œ å°±å¯ä»¥å°†å…·æœ‰å”¯ä¸€é”®ï¼ˆUnique Keyï¼‰çš„åŠ¨æ€è¡¨è½¬æ¢ä¸ºæµã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110165603473.png" alt="image-20210110165603473"></p><p>è¿™äº›æ¦‚å¿µæˆ‘ä»¬ä¹‹å‰éƒ½å·²æåˆ°è¿‡ã€‚<font color="red">éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä»£ç é‡Œå°†åŠ¨æ€è¡¨è½¬æ¢ä¸º DataStream æ—¶ï¼Œä»…æ”¯æŒ Append å’Œ Retract æµã€‚</font>è€Œå‘å¤–éƒ¨ç³»ç»Ÿè¾“å‡ºåŠ¨æ€è¡¨çš„ TableSink æ¥å£ï¼Œåˆ™å¯ä»¥æœ‰ä¸ åŒçš„å®ç°ï¼Œ<strong>æ¯”å¦‚ä¹‹å‰æˆ‘ä»¬è®²åˆ°çš„ ESï¼Œå°±å¯ä»¥æœ‰ Upsert æ¨¡å¼</strong></p><h2 id="æ—¶é—´ç‰¹æ€§ğŸ”º"><a href="#æ—¶é—´ç‰¹æ€§ğŸ”º" class="headerlink" title="æ—¶é—´ç‰¹æ€§ğŸ”º"></a>æ—¶é—´ç‰¹æ€§ğŸ”º</h2><p>åŸºäºæ—¶é—´çš„æ“ä½œï¼ˆæ¯”å¦‚ Table API å’Œ SQL ä¸­çª—å£æ“ä½œï¼‰ï¼Œéœ€è¦å®šä¹‰ç›¸å…³çš„æ—¶é—´è¯­ä¹‰å’Œæ—¶é—´ æ•°æ®æ¥æºçš„ä¿¡æ¯ã€‚æ‰€ä»¥ï¼ŒTable å¯ä»¥æä¾›ä¸€ä¸ªé€»è¾‘ä¸Šçš„æ—¶é—´å­—æ®µï¼Œç”¨äºåœ¨è¡¨å¤„ç†ç¨‹åºä¸­ï¼ŒæŒ‡ ç¤ºæ—¶é—´å’Œè®¿é—®ç›¸åº”çš„æ—¶é—´æˆ³ã€‚ </p><p>æ—¶é—´å±æ€§ï¼Œå¯ä»¥æ˜¯æ¯ä¸ªè¡¨ schema çš„ä¸€éƒ¨åˆ†ã€‚ä¸€æ—¦å®šä¹‰äº†æ—¶é—´å±æ€§ï¼Œå®ƒå°±å¯ä»¥ä½œä¸ºä¸€ä¸ª å­—æ®µå¼•ç”¨ï¼Œå¹¶ä¸”å¯ä»¥åœ¨åŸºäºæ—¶é—´çš„æ“ä½œä¸­ä½¿ç”¨ã€‚</p><p> æ—¶é—´å±æ€§çš„è¡Œä¸ºç±»ä¼¼äºå¸¸è§„æ—¶é—´æˆ³ï¼Œå¯ä»¥è®¿é—®ï¼Œå¹¶ä¸”è¿›è¡Œè®¡ç®—ã€‚</p><h3 id="å¤„ç†æ—¶é—´ï¼ˆProcessing-Timeï¼‰"><a href="#å¤„ç†æ—¶é—´ï¼ˆProcessing-Timeï¼‰" class="headerlink" title="å¤„ç†æ—¶é—´ï¼ˆProcessing Timeï¼‰"></a>å¤„ç†æ—¶é—´ï¼ˆProcessing Timeï¼‰</h3><p>å¤„ç†æ—¶é—´è¯­ä¹‰ä¸‹ï¼Œå…è®¸è¡¨å¤„ç†ç¨‹åºæ ¹æ®æœºå™¨çš„æœ¬åœ°æ—¶é—´ç”Ÿæˆç»“æœã€‚å®ƒæ˜¯æ—¶é—´çš„æœ€ç®€å•æ¦‚ å¿µã€‚å®ƒæ—¢ä¸éœ€è¦æå–æ—¶é—´æˆ³ï¼Œä¹Ÿä¸éœ€è¦ç”Ÿæˆ watermarkã€‚</p><p> å®šä¹‰å¤„ç†æ—¶é—´å±æ€§æœ‰ä¸‰ç§æ–¹æ³•ï¼š</p><ol><li>åœ¨ DataStream è½¬åŒ–æ—¶ç›´æ¥æŒ‡å®šï¼›</li><li><del>åœ¨å®šä¹‰ Table Schema æ—¶æŒ‡å®šï¼›å·²ç»åºŸå¼ƒconnectæ–¹æ³•</del></li><li>åœ¨åˆ›å»ºè¡¨çš„ DDL ä¸­æŒ‡å®š</li></ol><h4 id="DataStream-è½¬åŒ–æˆ-Table-æ—¶æŒ‡å®š"><a href="#DataStream-è½¬åŒ–æˆ-Table-æ—¶æŒ‡å®š" class="headerlink" title="DataStream è½¬åŒ–æˆ Table æ—¶æŒ‡å®š"></a>DataStream è½¬åŒ–æˆ Table æ—¶æŒ‡å®š</h4><p>ç”± DataStream è½¬æ¢æˆè¡¨æ—¶ï¼Œå¯ä»¥åœ¨åé¢æŒ‡å®šå­—æ®µåæ¥å®šä¹‰ Schemaã€‚åœ¨å®šä¹‰ Schema æœŸ é—´ï¼Œå¯ä»¥ç”¨.proctimeï¼Œå®šä¹‰å¤„ç†æ—¶é—´å­—æ®µã€‚</p><p> æ³¨æ„ï¼Œè¿™ä¸ª proctime å±æ€§åªèƒ½é€šè¿‡<strong>é™„åŠ é€»è¾‘å­—æ®µ</strong>ï¼Œæ¥æ‰©å±•ç‰©ç† schemaã€‚å› æ­¤ï¼Œåªèƒ½åœ¨ schema å®šä¹‰çš„æœ«å°¾å®šä¹‰å®ƒã€‚</p><blockquote><p>å³ï¼šproctime å±æ€§ä¸èƒ½ä½¿ç”¨å·²æœ‰çš„å­—æ®µ</p></blockquote><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">ProcessTimeForDataStream</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–æµï¼Œæœ¬åœ°æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">val</span> inputStream: <span class="type">DataStream</span>[(<span class="type">String</span>, <span class="type">String</span>, <span class="type">String</span>)] = env.readTextFile(<span class="string">&quot;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&quot;</span>, <span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">      .map(r =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> strings: <span class="type">Array</span>[<span class="type">String</span>] = r.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        (strings(<span class="number">0</span>), strings(<span class="number">1</span>), strings(<span class="number">2</span>))</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æµè½¬æ¢ä¸ºè¡¨</span></span><br><span class="line">    <span class="keyword">val</span> inputTable: <span class="type">Table</span> = tableEnv.fromDataStream(inputStream, $(<span class="string">&quot;id&quot;</span>), $(<span class="string">&quot;ts&quot;</span>), $(<span class="string">&quot;temp&quot;</span>), $(<span class="string">&quot;pt&quot;</span>).proctime())</span><br><span class="line"></span><br><span class="line">    inputTable.toAppendStream[(<span class="type">String</span>, <span class="type">String</span>, <span class="type">String</span>, <span class="type">Timestamp</span>)].print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºè¡¨çš„-DDL-ä¸­æŒ‡å®š"><a href="#åˆ›å»ºè¡¨çš„-DDL-ä¸­æŒ‡å®š" class="headerlink" title="åˆ›å»ºè¡¨çš„ DDL ä¸­æŒ‡å®š"></a>åˆ›å»ºè¡¨çš„ DDL ä¸­æŒ‡å®š</h4><p>åœ¨åˆ›å»ºè¡¨çš„ DDL ä¸­ï¼Œå¢åŠ ä¸€ä¸ªå­—æ®µå¹¶æŒ‡å®šæˆ proctimeï¼Œä¹Ÿå¯ä»¥æŒ‡å®šå½“å‰çš„æ—¶é—´å­—æ®µã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">ProcessTimeForDdl</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileSystemSql: <span class="type">String</span> = <span class="string">&quot;CREATE TABLE fs_table &quot;</span> +</span><br><span class="line">      <span class="string">&quot;(id STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot; ts STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;  temp DOUBLE, &quot;</span> +</span><br><span class="line">      <span class="string">&quot; pt AS PROCTIME()) &quot;</span> +</span><br><span class="line">      <span class="string">&quot; WITH (&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;connector&#x27;=&#x27;filesystem&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;path&#x27;=&#x27;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;format&#x27;=&#x27;csv&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//    å¯ä»¥ä½¿ç”¨ TableEnvironment ä¸­çš„ executeSql() æ–¹æ³•æ‰§è¡Œ CREATE è¯­å¥ã€‚ è‹¥ CREATE æ“ä½œæ‰§è¡ŒæˆåŠŸï¼ŒexecuteSql() æ–¹æ³•è¿”å› â€˜OKâ€™ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//    ä»¥ä¸‹çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•åœ¨ TableEnvironment ä¸­æ‰§è¡Œä¸€ä¸ª CREATE è¯­å¥ã€‚</span></span><br><span class="line">    tableEnv.executeSql(fileSystemSql)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tableå¯¹è±¡æ²¡æœ‰æ–¹æ³•toAppendStreamçš„ï¼Œ åªæœ‰é€šè¿‡å¯¼å…¥éšå¼è½¬æ¢çš„åŒ…æ‰å¯ä»¥å®ç°æ­¤åŠŸèƒ½</span></span><br><span class="line">    <span class="keyword">import</span> org.apache.flink.table.api.bridge.scala.tableConversions</span><br><span class="line">    <span class="comment">// SQLå½¢å¼</span></span><br><span class="line">    tableEnv.sqlQuery(<span class="string">&quot;select * from fs_table&quot;</span>).toAppendStream[(<span class="type">String</span>, <span class="type">String</span>, <span class="type">Double</span>, <span class="type">Timestamp</span>)]</span><br><span class="line">      .print()</span><br><span class="line">    </span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›´æ¥åœ¨å®šä¹‰è¡¨å­—æ®µçš„æ—¶å€™ï¼Œå¤šåŠ ä¸€åˆ—å³å¯ï¼š<code>pt AS PROCTIME()</code></p><blockquote><p>æ³¨æ„ï¼šè¿è¡Œè¿™æ®µ DDLï¼Œå¿…é¡»ä½¿ç”¨ Blink Plannerã€‚</p></blockquote><h3 id="äº‹ä»¶æ—¶é—´ï¼ˆEvent-Timeï¼‰"><a href="#äº‹ä»¶æ—¶é—´ï¼ˆEvent-Timeï¼‰" class="headerlink" title="äº‹ä»¶æ—¶é—´ï¼ˆEvent Timeï¼‰"></a>äº‹ä»¶æ—¶é—´ï¼ˆEvent Timeï¼‰</h3><p>äº‹ä»¶æ—¶é—´è¯­ä¹‰ï¼Œå…è®¸è¡¨å¤„ç†ç¨‹åºæ ¹æ®æ¯ä¸ªè®°å½•ä¸­åŒ…å«çš„æ—¶é—´ç”Ÿæˆç»“æœã€‚è¿™æ ·å³ä½¿åœ¨æœ‰ä¹± åºäº‹ä»¶æˆ–è€…å»¶è¿Ÿäº‹ä»¶æ—¶ï¼Œä¹Ÿå¯ä»¥è·å¾—æ­£ç¡®çš„ç»“æœã€‚ </p><p>ä¸ºäº†å¤„ç†æ— åºäº‹ä»¶ï¼Œå¹¶åŒºåˆ†æµä¸­çš„å‡†æ—¶å’Œè¿Ÿåˆ°äº‹ä»¶ï¼›Flink éœ€è¦ä»äº‹ä»¶æ•°æ®ä¸­ï¼Œæå–æ—¶ é—´æˆ³ï¼Œå¹¶ç”¨æ¥æ¨è¿›äº‹ä»¶æ—¶é—´çš„è¿›å±•ï¼ˆwatermarkï¼‰ã€‚</p><h4 id="DataStream-è½¬åŒ–æˆ-Table-æ—¶æŒ‡å®š-1"><a href="#DataStream-è½¬åŒ–æˆ-Table-æ—¶æŒ‡å®š-1" class="headerlink" title="DataStream è½¬åŒ–æˆ Table æ—¶æŒ‡å®š"></a>DataStream è½¬åŒ–æˆ Table æ—¶æŒ‡å®š</h4><p>åœ¨å£°æ˜DataSteamæ—¶ç›´æ¥æŒ‡å®šWaterMarkå’Œæ—¶é—´æˆ³ã€‚ç„¶ååœ¨è½¬æ¢ä¸ºTableæ—¶ï¼Œæ·»åŠ æ–°çš„å­—æ®µæˆ–è€…è¦†ç›–å·²æœ‰å­—æ®µ</p><p>åœ¨DataStreamè½¬æ¢æˆTableï¼Œschemaçš„å®šä¹‰æœŸé—´ï¼Œä½¿ç”¨.rowtimeå¯ä»¥å®šä¹‰äº‹ä»¶æ—¶é—´å±æ€§ã€‚ <strong>æ³¨æ„ï¼Œå¿…é¡»åœ¨è½¬æ¢çš„æ•°æ®æµä¸­åˆ†é…æ—¶é—´æˆ³å’Œ watermarkã€‚</strong> </p><p>åœ¨å°†æ•°æ®æµè½¬æ¢ä¸ºè¡¨æ—¶ï¼Œæœ‰ä¸¤ç§å®šä¹‰æ—¶é—´å±æ€§çš„æ–¹æ³•ã€‚æ ¹æ®æŒ‡å®šçš„<code>.rowtime </code>å­—æ®µåæ˜¯å¦ å­˜åœ¨äºæ•°æ®æµçš„æ¶æ„ä¸­ï¼Œtimestamp å­—æ®µå¯ä»¥ï¼š </p><ul><li><p>ä½œä¸ºæ–°å­—æ®µè¿½åŠ åˆ° schema </p></li><li><p>æ›¿æ¢ç°æœ‰å­—æ®µ</p></li></ul><p>åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œå®šä¹‰çš„äº‹ä»¶æ—¶é—´æˆ³å­—æ®µï¼Œéƒ½å°†ä¿å­˜ DataStream ä¸­äº‹ä»¶æ—¶é—´æˆ³çš„å€¼ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">EventTimeForDataStream</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">// é»˜è®¤äº‹ä»¶æ—¶é—´ï¼Œä¸æŒ‡å®š</span></span><br><span class="line">    println(env.getStreamTimeCharacteristic)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–æµï¼Œæœ¬åœ°æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">val</span> inputStream: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = env.addSource(<span class="keyword">new</span> <span class="type">SensorSource</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®æ°´ä½çº¿</span></span><br><span class="line"><span class="comment">//    val watermark: DataStream[SensorReading] = inputStream.assignAscendingTimestamps(_.timestamp)</span></span><br><span class="line">    <span class="keyword">val</span> value: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = inputStream.assignTimestampsAndWatermarks(<span class="type">WatermarkStrategy</span>.forMonotonousTimestamps()</span><br><span class="line">      .withTimestampAssigner(<span class="keyword">new</span> <span class="type">SerializableTimestampAssigner</span>[<span class="type">SensorReading</span>] &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(t: <span class="type">SensorReading</span>, l: <span class="type">Long</span>): <span class="type">Long</span> = t.timestamp</span><br><span class="line">      &#125;))</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æµè½¬æ¢ä¸ºè¡¨</span></span><br><span class="line">    <span class="keyword">val</span> inputTable: <span class="type">Table</span> = tableEnv</span><br><span class="line">      .fromDataStream(value,</span><br><span class="line">        $<span class="string">&quot;id&quot;</span>, $<span class="string">&quot;temperature&quot;</span>, $<span class="string">&quot;timestamp&quot;</span>, $<span class="string">&quot;rt&quot;</span>.rowtime())</span><br><span class="line"></span><br><span class="line">    inputTable.printSchema()</span><br><span class="line">    inputTable.toAppendStream[<span class="type">Row</span>].print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210111201410740.png" alt="image-20210111201410740"></p><p>åœ¨æˆ‘ä»¬æ›´æ”¹äº†Flink1.12ç‰ˆæœ¬åï¼Œè®¾ç½®æ—¶é—´æ—¶é—´æ–¹æ³•è¢«åºŸå¼ƒï¼ŒåŸå› æ˜¯ï¼ŒFlink1.12ç‰ˆæœ¬é»˜è®¤æ˜¯äº‹ä»¶æ—¶é—´ï¼Œå¦‚æœæƒ³è¦é‡‘åº¸çš„è¯è¯·ä½¿ç”¨<code>org.apache.flink.api.common.ExecutionConfig#setAutoWatermarkInterval(long</code></p><hr><p>åŒæ—¶å‘ç°è®¾ç½®æ°´ä½çº¿çš„æ–¹æ³•ä¹Ÿè¿‡æœŸäº†ï¼Œè¿™æ˜¯æœ€æ–°çš„è¯´æ³•ã€‚<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/event_timestamps_watermarks.html">Apache Flink 1.12 Documentation: ç”Ÿæˆ Watermark</a></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> setting: <span class="type">WatermarkStrategy</span>[(<span class="type">String</span>, <span class="type">Long</span>, <span class="type">String</span>)] = <span class="type">WatermarkStrategy</span></span><br><span class="line">.forBoundedOutOfOrderness[(<span class="type">String</span>, <span class="type">Long</span>, <span class="type">String</span>)](<span class="type">Duration</span>.ofSeconds(<span class="number">20</span>))</span><br><span class="line">.withTimestampAssigner(<span class="keyword">new</span> <span class="type">SerializableTimestampAssigner</span>[(<span class="type">String</span>, <span class="type">Long</span>, <span class="type">String</span>)] &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(element: (<span class="type">String</span>, <span class="type">Long</span>, <span class="type">String</span>), recordTimestamp: <span class="type">Long</span>): <span class="type">Long</span> = element._2 * <span class="number">1000</span></span><br><span class="line">&#125;)</span><br><span class="line">inputStream.assignTimestampsAndWatermarks(setting)</span><br></pre></td></tr></table></figure><p><strong>é‡è¦ï¼š</strong></p><p>å¦‚æœç¼–è¯‘æ—¶æç¤ºä»¥ä¸‹ä¿¡æ¯ï¼š<code>Static methods in interface require -target:jvm-1.8</code></p><p>åˆ™å¯ä»¥é€šè¿‡ä¿®æ”¹pomæ–‡ä»¶ä¸­çš„scala Compilerå‚æ•°æ¥ä¿®æ”¹æ­¤é—®é¢˜ï¼ŒåŠ å…¥<code>-target:jvm-1.8</code>ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Scala Compiler --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.alchim31.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>scala-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>testCompile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">args</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-nobootcp<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-target:jvm-1.8<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">args</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åˆæˆ–è€…åœ¨</p><p>In Intellij IDEA (15 CE) add this scalac compiler option:</p><p><em>Build, Execution, Deployment</em> -&gt; <em>Compiler</em> -&gt; <em>Scala Compiler</em> -&gt; <em>Your Project</em></p><p><em>Additional compiler options</em>: <code>-target:jvm-1.8</code> (was empty).</p><h4 id="å®šä¹‰-Table-Schema-æ—¶æŒ‡å®š"><a href="#å®šä¹‰-Table-Schema-æ—¶æŒ‡å®š" class="headerlink" title="å®šä¹‰ Table Schema æ—¶æŒ‡å®š"></a><del>å®šä¹‰ Table Schema æ—¶æŒ‡å®š</del></h4><p><del>è¿™ç§æ–¹</del>æ³•åªè¦åœ¨connectåå®šä¹‰ Schema çš„æ—¶å€™ï¼Œå°†äº‹ä»¶æ—¶é—´å­—æ®µï¼Œå¹¶æŒ‡å®šæˆ rowtime å°±å¯ä»¥äº†ã€‚connectå·²åºŸå¼ƒ</p><h4 id="åˆ›å»ºè¡¨çš„-DDL-ä¸­æŒ‡å®š-1"><a href="#åˆ›å»ºè¡¨çš„-DDL-ä¸­æŒ‡å®š-1" class="headerlink" title="åˆ›å»ºè¡¨çš„ DDL ä¸­æŒ‡å®š"></a>åˆ›å»ºè¡¨çš„ DDL ä¸­æŒ‡å®š</h4><p>äº‹ä»¶æ—¶é—´å±æ€§ï¼Œæ˜¯ä½¿ç”¨ CREATE TABLE DDL ä¸­çš„ WARDMARK è¯­å¥å®šä¹‰çš„ã€‚watermark è¯­ å¥ï¼Œå®šä¹‰ç°æœ‰äº‹ä»¶æ—¶é—´å­—æ®µä¸Šçš„ watermark ç”Ÿæˆè¡¨è¾¾å¼ï¼Œè¯¥è¡¨è¾¾å¼å°†äº‹ä»¶æ—¶é—´å­—æ®µæ ‡è®°ä¸ºäº‹ ä»¶æ—¶é—´å±æ€§ã€‚</p><p><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/sql/create.html#watermark">Apache Flink 1.12 Documentation: CREATE è¯­å¥</a></p><blockquote><p><code>WATERMARK</code> å®šä¹‰äº†è¡¨çš„äº‹ä»¶æ—¶é—´å±æ€§ï¼Œå…¶å½¢å¼ä¸º <code>WATERMARK FOR rowtime_column_name AS watermark_strategy_expression</code> ã€‚</p><p><code>rowtime_column_name</code> æŠŠä¸€ä¸ªç°æœ‰çš„åˆ—å®šä¹‰ä¸ºä¸€ä¸ªä¸ºè¡¨æ ‡è®°äº‹ä»¶æ—¶é—´çš„å±æ€§ã€‚è¯¥åˆ—çš„ç±»å‹å¿…é¡»ä¸º <code>TIMESTAMP(3)</code>ï¼Œä¸”æ˜¯ schema ä¸­çš„é¡¶å±‚åˆ—ï¼Œå®ƒä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªè®¡ç®—åˆ—ã€‚</p><p><code>watermark_strategy_expression</code> å®šä¹‰äº† watermark çš„ç”Ÿæˆç­–ç•¥ã€‚å®ƒå…è®¸ä½¿ç”¨åŒ…æ‹¬è®¡ç®—åˆ—åœ¨å†…çš„ä»»æ„éæŸ¥è¯¢è¡¨è¾¾å¼æ¥è®¡ç®— watermark ï¼›è¡¨è¾¾å¼çš„è¿”å›ç±»å‹å¿…é¡»æ˜¯ <code>TIMESTAMP(3)</code>ï¼Œè¡¨ç¤ºäº†ä» Epoch ä»¥æ¥çš„ç»è¿‡çš„æ—¶é—´ã€‚ è¿”å›çš„ watermark åªæœ‰å½“å…¶ä¸ä¸ºç©ºä¸”å…¶å€¼å¤§äºä¹‹å‰å‘å‡ºçš„æœ¬åœ° watermark æ—¶æ‰ä¼šè¢«å‘å‡ºï¼ˆä»¥ä¿è¯ watermark é€’å¢ï¼‰ã€‚æ¯æ¡è®°å½•çš„ watermark ç”Ÿæˆè¡¨è¾¾å¼è®¡ç®—éƒ½ä¼šç”±æ¡†æ¶å®Œæˆã€‚ æ¡†æ¶ä¼šå®šæœŸå‘å‡ºæ‰€ç”Ÿæˆçš„æœ€å¤§çš„ watermark ï¼Œå¦‚æœå½“å‰ watermark ä»ç„¶ä¸å‰ä¸€ä¸ª watermark ç›¸åŒã€ä¸ºç©ºã€æˆ–è¿”å›çš„ watermark çš„å€¼å°äºæœ€åä¸€ä¸ªå‘å‡ºçš„ watermark ï¼Œåˆ™æ–°çš„ watermark ä¸ä¼šè¢«å‘å‡ºã€‚ Watermark æ ¹æ® <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/config.html#pipeline-auto-watermark-interval"><code>pipeline.auto-watermark-interval</code></a> ä¸­æ‰€é…ç½®çš„é—´éš”å‘å‡ºã€‚ è‹¥ watermark çš„é—´éš”æ˜¯ <code>0ms</code> ï¼Œé‚£ä¹ˆæ¯æ¡è®°å½•éƒ½ä¼šäº§ç”Ÿä¸€ä¸ª watermarkï¼Œä¸” watermark ä¼šåœ¨ä¸ä¸ºç©ºå¹¶å¤§äºä¸Šä¸€ä¸ªå‘å‡ºçš„ watermark æ—¶å‘å‡ºã€‚</p><p>ä½¿ç”¨äº‹ä»¶æ—¶é—´è¯­ä¹‰æ—¶ï¼Œè¡¨å¿…é¡»åŒ…å«äº‹ä»¶æ—¶é—´å±æ€§å’Œ watermark ç­–ç•¥ã€‚</p><p>Flink æä¾›äº†å‡ ç§å¸¸ç”¨çš„ watermark ç­–ç•¥ã€‚</p><ul><li><p>ä¸¥æ ¼é€’å¢æ—¶é—´æˆ³ï¼š <code>WATERMARK FOR rowtime_column AS rowtime_column</code>ã€‚</p><p>å‘å‡ºåˆ°ç›®å‰ä¸ºæ­¢å·²è§‚å¯Ÿåˆ°çš„æœ€å¤§æ—¶é—´æˆ³çš„ watermark ï¼Œæ—¶é—´æˆ³å¤§äºæœ€å¤§æ—¶é—´æˆ³çš„è¡Œè¢«è®¤ä¸ºæ²¡æœ‰è¿Ÿåˆ°ã€‚</p></li><li><p>é€’å¢æ—¶é—´æˆ³ï¼š <code>WATERMARK FOR rowtime_column AS rowtime_column - INTERVAL &#39;0.001&#39; SECOND</code>ã€‚</p><p>å‘å‡ºåˆ°ç›®å‰ä¸ºæ­¢å·²è§‚å¯Ÿåˆ°çš„æœ€å¤§æ—¶é—´æˆ³å‡ 1 çš„ watermark ï¼Œæ—¶é—´æˆ³å¤§äºæˆ–ç­‰äºæœ€å¤§æ—¶é—´æˆ³çš„è¡Œè¢«è®¤ä¸ºæ²¡æœ‰è¿Ÿåˆ°ã€‚</p></li><li><p>æœ‰ç•Œä¹±åºæ—¶é—´æˆ³ï¼š <code>WATERMARK FOR rowtime_column AS rowtime_column - INTERVAL &#39;string&#39; timeUnit</code>ã€‚</p><p>å‘å‡ºåˆ°ç›®å‰ä¸ºæ­¢å·²è§‚å¯Ÿåˆ°çš„æœ€å¤§æ—¶é—´æˆ³å‡å»æŒ‡å®šå»¶è¿Ÿçš„ watermark ï¼Œä¾‹å¦‚ï¼Œ <code>WATERMARK FOR rowtime_column AS rowtime_column - INTERVAL &#39;5&#39; SECOND</code> æ˜¯ä¸€ä¸ª 5 ç§’å»¶è¿Ÿçš„ watermark ç­–ç•¥ã€‚</p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Orders (</span><br><span class="line">    <span class="string">`user`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">    product <span class="keyword">STRING</span>,</span><br><span class="line">    order_time <span class="built_in">TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">    WATERMARK <span class="keyword">FOR</span> order_time <span class="keyword">AS</span> order_time - <span class="built_in">INTERVAL</span> <span class="string">&#x27;5&#x27;</span> <span class="keyword">SECOND</span></span><br><span class="line">) <span class="keyword">WITH</span> ( . . . );</span><br></pre></td></tr></table></figure><p>æ³¨æ„ç‚¹ï¼šè¢«ä½œä¸ºæ—¶é—´æˆ³çš„å­—æ®µéœ€è¦æ˜¯<code>TIMESTAMP</code>ç±»å‹ï¼Œä¸”åœ¨å£°æ˜WATERMARKæ—¶çš„å­—æ®µä¹Ÿéœ€è¦æ˜¯<code>TIMESTAMP</code></p></blockquote><p>ä¾‹å¦‚ï¼šè¯»å–æœ¬åœ°æ–‡ä»¶ä¿¡æ¯æ—¶ç›´æ¥æŒ‡å®šWatermarkï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.table</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.eventtime._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.bridge.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.types.<span class="type">Row</span></span><br><span class="line"><span class="keyword">import</span> org.example.source.&#123;<span class="type">SensorReading</span>, <span class="type">SensorSource</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">EventTimeForDdl</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">// é»˜è®¤äº‹ä»¶æ—¶é—´ï¼Œä¸æŒ‡å®š</span></span><br><span class="line">    println(env.getStreamTimeCharacteristic)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileSystemSql: <span class="type">String</span> = <span class="string">&quot;CREATE TABLE fs_table &quot;</span> +</span><br><span class="line">      <span class="string">&quot;(id STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;ts BIGINT,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;  temp DOUBLE, &quot;</span> +</span><br><span class="line">      <span class="string">&quot; order_time as  TO_TIMESTAMP( FROM_UNIXTIME(ts) ) ,&quot;</span> +</span><br><span class="line">      <span class="string">&quot; WATERMARK FOR order_time AS order_time - INTERVAL &#x27;5&#x27; SECOND) &quot;</span> +</span><br><span class="line">      <span class="string">&quot; WITH (&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;connector&#x27;=&#x27;filesystem&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;path&#x27;=&#x27;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;format&#x27;=&#x27;csv&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">    tableEnv.executeSql(fileSystemSql)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> table: <span class="type">Table</span> = tableEnv.from(<span class="string">&quot;fs_table&quot;</span>)</span><br><span class="line">    table.printSchema()</span><br><span class="line">    table.toAppendStream[<span class="type">Row</span>].print()</span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210112223123100.png" alt="image-20210112223123100"></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sensor_1,1547718199,35.8</span><br><span class="line">sensor_6,1547718201,15.4</span><br><span class="line">sensor_7,1547718202,6.7</span><br><span class="line">sensor_10,1547718205,38.1</span><br><span class="line">sensor_1,1547718207,36.3</span><br><span class="line">sensor_1,1547718209,32.8</span><br><span class="line">sensor_1,1547718212,37.1</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„</p><p><font color="red">åœ¨å£°æ˜Watermarkæ—¶éœ€è¦è®¾ç½®çš„æ˜¯æ—¶é—´æˆ³çš„ç±»å‹ï¼Œå¦‚æœæºæ•°æ®ä¸æ˜¯æ—¶é—´æˆ³ç±»å‹ï¼Œéœ€è¦æ–°å¢ä¸€ä¸ªé€»è¾‘åˆ—ï¼Œæ¥å°†å…¶ä»–çš„æ—¶é—´åˆ—è½¬æ¢ä¸ºæ—¶é—´æˆ³ç±»å‹ï¼Œå†ç»™è®¾ç½®WaterMark</font></p><p>è¿™é‡Œ FROM_UNIXTIME æ˜¯ç³»ç»Ÿå†…ç½®çš„æ—¶é—´å‡½æ•°ï¼Œç”¨æ¥å°†ä¸€ä¸ªæ•´æ•°ï¼ˆç§’æ•°ï¼‰è½¬æ¢æˆ â€œYYYY-MM-DD hh:mm:ssâ€æ ¼å¼ï¼ˆé»˜è®¤ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºç¬¬äºŒä¸ª String å‚æ•°ä¼ å…¥ï¼‰çš„æ—¥æœŸæ—¶é—´ å­—ç¬¦ä¸²ï¼ˆdate time stringï¼‰ï¼›ç„¶åå†ç”¨ TO_TIMESTAMP å°†å…¶è½¬æ¢æˆ Timestampã€‚</p></blockquote><h1 id="çª—å£ğŸ”º"><a href="#çª—å£ğŸ”º" class="headerlink" title="çª—å£ğŸ”º"></a>çª—å£ğŸ”º</h1><p>æ—¶é—´è¯­ä¹‰ï¼Œè¦é…åˆçª—å£æ“ä½œæ‰èƒ½å‘æŒ¥ä½œç”¨ã€‚æœ€ä¸»è¦çš„ç”¨é€”ï¼Œå½“ç„¶å°±æ˜¯å¼€çª—å£ã€æ ¹æ®æ—¶é—´ æ®µåšè®¡ç®—äº†ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹ Table API å’Œ SQL ä¸­ï¼Œæ€ä¹ˆåˆ©ç”¨æ—¶é—´å­—æ®µåšçª—å£æ“ä½œã€‚ åœ¨ Table API å’Œ SQL ä¸­ï¼Œä¸»è¦æœ‰ä¸¤ç§çª—å£ï¼š</p><ol><li>Group Windows ï¼šåˆ†ç»„çª—å£</li><li>Over Windowsï¼šOverçª—å£ï¼Œå’Œæˆ‘ä»¬åœ¨RDBMSè¯´çš„å¼€çª—å‡½æ•°æ˜¯ä¸€æ ·çš„</li></ol><h2 id="åˆ†ç»„çª—å£ï¼ˆGroup-Windowsï¼‰"><a href="#åˆ†ç»„çª—å£ï¼ˆGroup-Windowsï¼‰" class="headerlink" title="åˆ†ç»„çª—å£ï¼ˆGroup Windowsï¼‰"></a>åˆ†ç»„çª—å£ï¼ˆGroup Windowsï¼‰</h2><p>åˆ†ç»„çª—å£ï¼ˆGroup Windowsï¼‰ä¼šæ ¹æ®æ—¶é—´æˆ–è¡Œè®¡æ•°é—´éš”ï¼Œå°†è¡Œèšåˆåˆ°æœ‰é™çš„ç»„ï¼ˆGroupï¼‰ ä¸­ï¼Œå¹¶å¯¹æ¯ä¸ªç»„çš„æ•°æ®æ‰§è¡Œä¸€æ¬¡èšåˆå‡½æ•°ã€‚</p><p> Table API ä¸­çš„ Group Windows éƒ½æ˜¯ä½¿ç”¨.windowï¼ˆw:GroupWindowï¼‰å­å¥å®šä¹‰çš„ï¼Œå¹¶ä¸” å¿…é¡»ç”± as å­å¥æŒ‡å®šä¸€ä¸ªåˆ«åã€‚ä¸ºäº†æŒ‰çª—å£å¯¹è¡¨è¿›è¡Œåˆ†ç»„ï¼Œçª—å£çš„åˆ«åå¿…é¡»åœ¨ group by å­å¥ ä¸­ï¼Œåƒå¸¸è§„çš„åˆ†ç»„å­—æ®µä¸€æ ·å¼•ç”¨ã€‚</p><p>Table API æä¾›äº†ä¸€ç»„å…·æœ‰ç‰¹å®šè¯­ä¹‰çš„é¢„å®šä¹‰ Window ç±»ï¼Œè¿™äº›ç±»ä¼šè¢«è½¬æ¢ä¸ºåº•å±‚ DataStream æˆ– DataSet çš„çª—å£æ“ä½œã€‚ </p><p>Table API æ”¯æŒçš„çª—å£å®šä¹‰ï¼Œå’Œæˆ‘ä»¬ç†Ÿæ‚‰çš„ä¸€æ ·ï¼Œä¸»è¦ä¹Ÿæ˜¯ä¸‰ç§ï¼šæ»šåŠ¨ï¼ˆTumblingï¼‰ã€æ»‘ åŠ¨ï¼ˆSlidingï¼‰å’Œä¼šè¯ï¼ˆSessionï¼‰ã€‚</p><blockquote><p>æ³¨æ„çš„æ˜¯ï¼Œåˆ†ç»„èšåˆåçš„Tableå¯ä»¥è½¬æ¢ä¸ºAppendæµï¼Œå› ä¸ºçª—å£è®¡ç®—å®Œåæ‰ä¼šè¾“å‡ºï¼Œå¹¶ä¸ä¼šæ›´æ”¹å·²ç»å…³é—­çš„çª—å£çš„æ•°å€¼</p></blockquote><h3 id="æ»šåŠ¨çª—å£"><a href="#æ»šåŠ¨çª—å£" class="headerlink" title="æ»šåŠ¨çª—å£"></a>æ»šåŠ¨çª—å£</h3><p><strong><em>Table API</em></strong></p><p>æ»šåŠ¨çª—å£ï¼ˆTumbling windowsï¼‰è¦ç”¨ Tumble ç±»æ¥å®šä¹‰ï¼Œå¦å¤–è¿˜æœ‰ä¸‰ä¸ªæ–¹æ³•ï¼š</p><ul><li>overï¼šå®šä¹‰çª—å£é•¿åº¦</li><li>onï¼šç”¨æ¥åˆ†ç»„ï¼ˆæŒ‰æ—¶é—´é—´éš”ï¼‰æˆ–è€…æ’åºï¼ˆæŒ‰è¡Œæ•°ï¼‰çš„æ—¶é—´å­—æ®µ</li><li>asï¼šåˆ«åï¼Œå¿…é¡»å‡ºç°åœ¨åé¢çš„ groupBy ä¸­</li></ul><p>ä½¿ç”¨Table APIè¿›è¡Œåˆ†ç»„æ—¶ï¼Œä¸DataTreamçš„æ“ä½œæœ‰æ‰€ä¸åŒï¼Œä»–éœ€è¦å…ˆå¼€çª—å½¢æˆä¸€ä¸ªé€»è¾‘å­—æ®µçª—å£wï¼Œä¹‹åä½¿ç”¨<code>group by</code>æ­£å¼å¼€çª—æ ï¼Œæ­¤æ—¶å¿…é¡»åŸºäºçª—å£é€»è¾‘wå’Œå…¶ä»–éœ€è¦åˆ†ç»„çš„å¯¹è±¡æ¥åˆ†ç»„ã€‚</p><p>ä¾‹å¦‚ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.<span class="type">Expressions</span>.lit</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.&#123;$, <span class="type">Table</span>, <span class="type">Tumble</span>, <span class="type">WithOperations</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.bridge.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.types.<span class="type">Row</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">TumbleWindowApi</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">// é»˜è®¤äº‹ä»¶æ—¶é—´ï¼Œä¸æŒ‡å®š</span></span><br><span class="line">    println(env.getStreamTimeCharacteristic)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileSystemSql: <span class="type">String</span> = <span class="string">&quot;CREATE TABLE fs_table &quot;</span> +</span><br><span class="line">      <span class="string">&quot;(id STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;ts BIGINT,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;  temp DOUBLE, &quot;</span> +</span><br><span class="line">      <span class="string">&quot; order_time as  TO_TIMESTAMP( FROM_UNIXTIME(ts) ) ,&quot;</span> +</span><br><span class="line">      <span class="string">&quot; WATERMARK FOR order_time AS order_time - INTERVAL &#x27;5&#x27; SECOND) &quot;</span> +</span><br><span class="line">      <span class="string">&quot; WITH (&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;connector&#x27;=&#x27;filesystem&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;path&#x27;=&#x27;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;format&#x27;=&#x27;csv&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">    tableEnv.executeSql(fileSystemSql)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> table: <span class="type">Table</span> = tableEnv.from(<span class="string">&quot;fs_table&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> table1: <span class="type">Table</span> = table.window(<span class="type">Tumble</span>.over(lit(<span class="number">1</span>).hour()).on($(<span class="string">&quot;order_time&quot;</span>)).as($(<span class="string">&quot;w&quot;</span>)))</span><br><span class="line">      .groupBy($(<span class="string">&quot;w&quot;</span>), $(<span class="string">&quot;id&quot;</span>))</span><br><span class="line">      .select($(<span class="string">&quot;id&quot;</span>), $(<span class="string">&quot;temp&quot;</span>).count, $(<span class="string">&quot;w&quot;</span>).`end`())</span><br><span class="line"></span><br><span class="line">    table1.toAppendStream[<span class="type">Row</span>].print()</span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„çš„æ˜¯ï¼Œåˆ†ç»„èšåˆåçš„Tableå¯ä»¥è½¬æ¢ä¸ºAppendæµï¼Œå› ä¸ºçª—å£è®¡ç®—å®Œåæ‰ä¼šè¾“å‡ºï¼Œå¹¶ä¸ä¼šæ›´æ”¹å·²ç»å…³é—­çš„çª—å£çš„æ•°å€¼.</p><hr><p><strong><em>SQL</em></strong></p><p><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/sql/queries.html#%E5%88%86%E7%BB%84%E7%AA%97%E5%8F%A3">Apache Flink 1.12 Documentation: æŸ¥è¯¢è¯­å¥</a></p><p>SQL æŸ¥è¯¢çš„åˆ†ç»„çª—å£æ˜¯é€šè¿‡ <code>GROUP BY</code> å­å¥å®šä¹‰çš„ã€‚ç±»ä¼¼äºä½¿ç”¨å¸¸è§„ <code>GROUP BY</code> è¯­å¥çš„æŸ¥è¯¢ï¼Œçª—å£åˆ†ç»„è¯­å¥çš„ <code>GROUP BY</code> å­å¥ä¸­å¸¦æœ‰ä¸€ä¸ªçª—å£å‡½æ•°ä¸ºæ¯ä¸ªåˆ†ç»„è®¡ç®—å‡ºä¸€ä¸ªç»“æœã€‚ä»¥ä¸‹æ˜¯æ‰¹å¤„ç†è¡¨å’Œæµå¤„ç†è¡¨æ”¯æŒçš„åˆ†ç»„çª—å£å‡½æ•°ï¼š</p><table><thead><tr><th align="left">åˆ†ç»„çª—å£å‡½æ•°</th><th align="left">æè¿°</th></tr></thead><tbody><tr><td align="left"><code>TUMBLE(time_attr, interval)</code></td><td align="left">å®šä¹‰ä¸€ä¸ªæ»šåŠ¨çª—å£ã€‚æ»šåŠ¨çª—å£æŠŠè¡Œåˆ†é…åˆ°æœ‰å›ºå®šæŒç»­æ—¶é—´ï¼ˆ <code>interval</code> ï¼‰çš„ä¸é‡å çš„è¿ç»­çª—å£ã€‚æ¯”å¦‚ï¼Œ5 åˆ†é’Ÿçš„æ»šåŠ¨çª—å£ä»¥ 5 åˆ†é’Ÿä¸ºé—´éš”å¯¹è¡Œè¿›è¡Œåˆ†ç»„ã€‚æ»šåŠ¨çª—å£å¯ä»¥å®šä¹‰åœ¨äº‹ä»¶æ—¶é—´ï¼ˆæ‰¹å¤„ç†ã€æµå¤„ç†ï¼‰æˆ–å¤„ç†æ—¶é—´ï¼ˆæµå¤„ç†ï¼‰ä¸Šã€‚</td></tr><tr><td align="left"><code>HOP(time_attr, interval, interval)</code></td><td align="left">å®šä¹‰ä¸€ä¸ªè·³è·ƒçš„æ—¶é—´çª—å£ï¼ˆåœ¨ Table API ä¸­ç§°ä¸ºæ»‘åŠ¨çª—å£ï¼‰ã€‚æ»‘åŠ¨çª—å£æœ‰ä¸€ä¸ªå›ºå®šçš„æŒç»­æ—¶é—´ï¼ˆ ç¬¬äºŒä¸ª <code>interval</code> å‚æ•° ï¼‰ä»¥åŠä¸€ä¸ªæ»‘åŠ¨çš„é—´éš”ï¼ˆç¬¬ä¸€ä¸ª <code>interval</code> å‚æ•° ï¼‰ã€‚è‹¥æ»‘åŠ¨é—´éš”å°äºçª—å£çš„æŒç»­æ—¶é—´ï¼Œæ»‘åŠ¨çª—å£åˆ™ä¼šå‡ºç°é‡å ï¼›å› æ­¤ï¼Œè¡Œå°†ä¼šè¢«åˆ†é…åˆ°å¤šä¸ªçª—å£ä¸­ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªå¤§å°ä¸º 15 åˆ†ç»„çš„æ»‘åŠ¨çª—å£ï¼Œå…¶æ»‘åŠ¨é—´éš”ä¸º 5 åˆ†é’Ÿï¼Œå°†ä¼šæŠŠæ¯ä¸€è¡Œæ•°æ®åˆ†é…åˆ° 3 ä¸ª 15 åˆ†é’Ÿçš„çª—å£ä¸­ã€‚æ»‘åŠ¨çª—å£å¯ä»¥å®šä¹‰åœ¨äº‹ä»¶æ—¶é—´ï¼ˆæ‰¹å¤„ç†ã€æµå¤„ç†ï¼‰æˆ–å¤„ç†æ—¶é—´ï¼ˆæµå¤„ç†ï¼‰ä¸Šã€‚</td></tr><tr><td align="left"><code>SESSION(time_attr, interval)</code></td><td align="left">å®šä¹‰ä¸€ä¸ªä¼šè¯æ—¶é—´çª—å£ã€‚ä¼šè¯æ—¶é—´çª—å£æ²¡æœ‰ä¸€ä¸ªå›ºå®šçš„æŒç»­æ—¶é—´ï¼Œä½†æ˜¯å®ƒä»¬çš„è¾¹ç•Œä¼šæ ¹æ® <code>interval</code> æ‰€å®šä¹‰çš„ä¸æ´»è·ƒæ—¶é—´æ‰€ç¡®å®šï¼›å³ä¸€ä¸ªä¼šè¯æ—¶é—´çª—å£åœ¨å®šä¹‰çš„é—´éš”æ—¶é—´å†…æ²¡æœ‰æ—¶é—´å‡ºç°ï¼Œè¯¥çª—å£ä¼šè¢«å…³é—­ã€‚ä¾‹å¦‚æ—¶é—´çª—å£çš„é—´éš”æ—¶é—´æ˜¯ 30 åˆ†é’Ÿï¼Œå½“å…¶ä¸æ´»è·ƒçš„æ—¶é—´è¾¾åˆ°30åˆ†é’Ÿåï¼Œè‹¥è§‚æµ‹åˆ°æ–°çš„è®°å½•ï¼Œåˆ™ä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„ä¼šè¯æ—¶é—´çª—å£ï¼ˆå¦åˆ™è¯¥è¡Œæ•°æ®ä¼šè¢«æ·»åŠ åˆ°å½“å‰çš„çª—å£ï¼‰ï¼Œä¸”è‹¥åœ¨ 30 åˆ†é’Ÿå†…æ²¡æœ‰è§‚æµ‹åˆ°æ–°çºªå½•ï¼Œè¿™ä¸ªçª—å£å°†ä¼šè¢«å…³é—­ã€‚ä¼šè¯æ—¶é—´çª—å£å¯ä»¥ä½¿ç”¨äº‹ä»¶æ—¶é—´ï¼ˆæ‰¹å¤„ç†ã€æµå¤„ç†ï¼‰æˆ–å¤„ç†æ—¶é—´ï¼ˆæµå¤„ç†ï¼‰ã€‚</td></tr></tbody></table><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.<span class="type">Table</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.bridge.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.types.<span class="type">Row</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">TumbleWindowSql</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">// é»˜è®¤äº‹ä»¶æ—¶é—´ï¼Œä¸æŒ‡å®š</span></span><br><span class="line">    println(env.getStreamTimeCharacteristic)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileSystemSql: <span class="type">String</span> = <span class="string">&quot;CREATE TABLE fs_table &quot;</span> +</span><br><span class="line">      <span class="string">&quot;(id STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;ts BIGINT,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;  temp DOUBLE, &quot;</span> +</span><br><span class="line">      <span class="string">&quot; row_time as  TO_TIMESTAMP( FROM_UNIXTIME(ts) ) ,&quot;</span> +</span><br><span class="line">      <span class="string">&quot; WATERMARK FOR row_time AS row_time - INTERVAL &#x27;5&#x27; SECOND) &quot;</span> +</span><br><span class="line">      <span class="string">&quot; WITH (&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;connector&#x27;=&#x27;filesystem&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;path&#x27;=&#x27;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;format&#x27;=&#x27;csv&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">    tableEnv.executeSql(fileSystemSql)</span><br><span class="line"></span><br><span class="line">    tableEnv.from(<span class="string">&quot;fs_table&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> table1: <span class="type">Table</span> = tableEnv.sqlQuery(</span><br><span class="line">      <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">        |SELECT</span></span><br><span class="line"><span class="string">        |  id,</span></span><br><span class="line"><span class="string">        |  TUMBLE_START(row_time, INTERVAL &#x27;1&#x27; HOUR) as wStart,</span></span><br><span class="line"><span class="string">        |  SUM(temp)</span></span><br><span class="line"><span class="string">        | FROM fs_table</span></span><br><span class="line"><span class="string">        | GROUP BY TUMBLE(row_time, INTERVAL &#x27;1&#x27; HOUR), id</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span>.stripMargin)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    table1.toAppendStream[<span class="type">Row</span>].print()</span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ»‘åŠ¨çª—å£"><a href="#æ»‘åŠ¨çª—å£" class="headerlink" title="æ»‘åŠ¨çª—å£"></a>æ»‘åŠ¨çª—å£</h3><p><strong><em>Table API</em></strong></p><p>æ»‘åŠ¨çª—å£ï¼ˆSliding windowsï¼‰è¦ç”¨ Slide ç±»æ¥å®šä¹‰ï¼Œå¦å¤–è¿˜æœ‰å››ä¸ªæ–¹æ³•</p><ol><li>overï¼šå®šä¹‰çª—å£é•¿åº¦</li><li>everyï¼šå®šä¹‰æ»‘åŠ¨æ­¥é•¿</li><li> onï¼šç”¨æ¥åˆ†ç»„ï¼ˆæŒ‰æ—¶é—´é—´éš”ï¼‰æˆ–è€…æ’åºï¼ˆæŒ‰è¡Œæ•°ï¼‰çš„æ—¶é—´å­—æ®µ</li><li> asï¼šåˆ«åï¼Œå¿…é¡»å‡ºç°åœ¨åé¢çš„ groupBy ä¸­</li></ol><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.<span class="type">Expressions</span>.&#123;$, lit&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.&#123;<span class="type">Slide</span>, <span class="type">Table</span>, <span class="type">Tumble</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.bridge.scala.&#123;<span class="type">StreamTableEnvironment</span>, tableConversions&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.types.<span class="type">Row</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">SlideWindowApi</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">// é»˜è®¤äº‹ä»¶æ—¶é—´ï¼Œä¸æŒ‡å®š</span></span><br><span class="line">    println(env.getStreamTimeCharacteristic)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileSystemSql: <span class="type">String</span> = <span class="string">&quot;CREATE TABLE fs_table &quot;</span> +</span><br><span class="line">      <span class="string">&quot;(id STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;ts BIGINT,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;  temp DOUBLE, &quot;</span> +</span><br><span class="line">      <span class="string">&quot; row_time as  TO_TIMESTAMP( FROM_UNIXTIME(ts) ) ,&quot;</span> +</span><br><span class="line">      <span class="string">&quot; WATERMARK FOR row_time AS row_time - INTERVAL &#x27;5&#x27; SECOND) &quot;</span> +</span><br><span class="line">      <span class="string">&quot; WITH (&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;connector&#x27;=&#x27;filesystem&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;path&#x27;=&#x27;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;format&#x27;=&#x27;csv&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">    tableEnv.executeSql(fileSystemSql)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> table: <span class="type">Table</span> = tableEnv.from(<span class="string">&quot;fs_table&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sum0  è®¡ç®—å¼ä¸ºç©ºçš„ç©º  å–0</span></span><br><span class="line">    <span class="keyword">val</span> table1: <span class="type">Table</span> = table.window(<span class="type">Slide</span>.over(lit(<span class="number">1</span>).hour()).every(lit(<span class="number">5</span>).minute()).on($(<span class="string">&quot;row_time&quot;</span>)).as(<span class="string">&quot;w&quot;</span>))</span><br><span class="line">      .groupBy($(<span class="string">&quot;w&quot;</span>), $(<span class="string">&quot;id&quot;</span>))</span><br><span class="line">      .select($(<span class="string">&quot;id&quot;</span>), $(<span class="string">&quot;temp&quot;</span>).sum0(), $(<span class="string">&quot;w&quot;</span>).start(), $(<span class="string">&quot;w&quot;</span>).`end`())</span><br><span class="line"></span><br><span class="line">    table1.toAppendStream[<span class="type">Row</span>].print()</span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><em>SQL</em></strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.<span class="type">Table</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.bridge.scala.&#123;<span class="type">StreamTableEnvironment</span>, tableConversions&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.types.<span class="type">Row</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">SlideWindowSql</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">// é»˜è®¤äº‹ä»¶æ—¶é—´ï¼Œä¸æŒ‡å®š</span></span><br><span class="line">    println(env.getStreamTimeCharacteristic)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileSystemSql: <span class="type">String</span> = <span class="string">&quot;CREATE TABLE fs_table &quot;</span> +</span><br><span class="line">      <span class="string">&quot;(id STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;ts BIGINT,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;  temp DOUBLE, &quot;</span> +</span><br><span class="line">      <span class="string">&quot; row_time as  TO_TIMESTAMP( FROM_UNIXTIME(ts) ) ,&quot;</span> +</span><br><span class="line">      <span class="string">&quot; WATERMARK FOR row_time AS row_time - INTERVAL &#x27;5&#x27; SECOND) &quot;</span> +</span><br><span class="line">      <span class="string">&quot; WITH (&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;connector&#x27;=&#x27;filesystem&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;path&#x27;=&#x27;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;format&#x27;=&#x27;csv&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">    tableEnv.executeSql(fileSystemSql)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> table1: <span class="type">Table</span> = tableEnv.sqlQuery(</span><br><span class="line">      <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">        |SELECT</span></span><br><span class="line"><span class="string">        |  id,</span></span><br><span class="line"><span class="string">        |  HOP_START(row_time, INTERVAL &#x27;1&#x27; MINUTE, INTERVAL &#x27;1&#x27; HOUR) as wStart,</span></span><br><span class="line"><span class="string">        |  HOP_END(row_time, INTERVAL &#x27;1&#x27; MINUTE, INTERVAL &#x27;1&#x27; HOUR) as wStart,</span></span><br><span class="line"><span class="string">        |  SUM(temp)</span></span><br><span class="line"><span class="string">        | FROM fs_table</span></span><br><span class="line"><span class="string">        | GROUP BY HOP(row_time, INTERVAL &#x27;1&#x27; MINUTE, INTERVAL &#x27;1&#x27; HOUR), id</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span>.stripMargin)</span><br><span class="line"></span><br><span class="line">    table1.toAppendStream[<span class="type">Row</span>].print()</span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="ä¼šè¯çª—å£"><a href="#ä¼šè¯çª—å£" class="headerlink" title="ä¼šè¯çª—å£"></a>ä¼šè¯çª—å£</h3><p>ä¼šè¯çª—å£ï¼ˆSession windowsï¼‰è¦ç”¨ Session ç±»æ¥å®šä¹‰ï¼Œå¦å¤–è¿˜æœ‰ä¸‰ä¸ªæ–¹æ³•ï¼š</p><ol><li>withGapï¼šä¼šè¯æ—¶é—´é—´éš” </li><li>onï¼šç”¨æ¥åˆ†ç»„ï¼ˆæŒ‰æ—¶é—´é—´éš”ï¼‰æˆ–è€…æ’åºï¼ˆæŒ‰è¡Œæ•°ï¼‰çš„æ—¶é—´å­—æ®µ </li><li>asï¼šåˆ«åï¼Œå¿…é¡»å‡ºç°åœ¨åé¢çš„ groupBy ä¸­</li></ol><p><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/sql/queries.html#%E5%88%86%E7%BB%84%E7%AA%97%E5%8F%A3">Apache Flink 1.12 Documentation: æŸ¥è¯¢è¯­å¥</a></p><h2 id="Over-Windows"><a href="#Over-Windows" class="headerlink" title="Over Windows"></a>Over Windows</h2><p>ç”±äº Over æœ¬æ¥å°±æ˜¯ SQL å†…ç½®æ”¯æŒçš„è¯­æ³•ï¼Œæ‰€ä»¥è¿™åœ¨ SQL ä¸­å±äºåŸºæœ¬çš„èšåˆæ“ä½œã€‚</p><p>æ‰€æœ‰ èšåˆå¿…é¡»åœ¨åŒä¸€çª—å£ä¸Šå®šä¹‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¿…é¡»æ˜¯ç›¸åŒçš„åˆ†åŒºã€æ’åºå’ŒèŒƒå›´ã€‚ç›®å‰ä»…æ”¯æŒåœ¨å½“ å‰è¡ŒèŒƒå›´ä¹‹å‰çš„çª—å£ï¼ˆæ— è¾¹ç•Œå’Œæœ‰è¾¹ç•Œï¼‰ã€‚</p><p>æ³¨æ„ï¼ŒORDER BY å¿…é¡»åœ¨å•ä¸€çš„æ—¶é—´å±æ€§ä¸ŠæŒ‡å®šã€‚</p><blockquote><p>å’Œå¸¸è§æ•°æ®åº“çš„å¼€åˆ›å‡½æ•°ä¸€æ ·ï¼Œå¯¹æœ€åçš„ç»“æœè¿›è¡ŒæŒ‡å®šèŒƒå›´å†…çš„å¼€çª—ï¼Œè®¡ç®—åçš„ç»“æœå½¢æˆæ–°çš„é€»è¾‘åˆ—ã€‚å’Œåˆ†ç»„å¼€çª—èšåˆçš„åŒºåˆ«æ˜¯å¹¶ä¸æ”¹å˜ä¹‹é—´çš„ç»“æœè¡Œæ•°ã€‚</p></blockquote><p>å¼€çª—å¯ä»¥æ˜¯æœ‰ç•Œçš„ä¹Ÿå¯ä»¥æ˜¯æ— ç•Œçš„ï¼š</p><ul><li>æ— ç•Œï¼šä¸å¯¹è¡Œæ•°è¿›è¡Œé™åˆ¶</li><li>æœ‰ç•Œï¼šæ’åºå¥½çš„åŸºç¡€ä¸Šè¿›è¡Œè¡Œæ•°çš„æˆªå–ï¼Œç›®å‰åªæ”¯æŒåˆ°æœ¬è¡Œï¼Œå› ä¸ºæ˜¯æµå¤„ç†ï¼Œä¸å¯èƒ½ç­‰ä¸‹ä¸€æ¡ç»“æœåˆ°äº†ä¹‹åæ‰å¼€çª—è®¡ç®—<ul><li> <code>ROWS BETWEEN 2 PRECEDING AND CURRENT ROW</code></li></ul></li></ul><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(amount) <span class="keyword">OVER</span> (</span><br><span class="line"> <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">user</span></span><br><span class="line"> <span class="keyword">ORDER</span> <span class="keyword">BY</span> proctime</span><br><span class="line"> <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">2</span> <span class="keyword">PRECEDING</span> <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="keyword">ROW</span>)</span><br><span class="line"><span class="keyword">FROM</span> Orders</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ä¹Ÿå¯ä»¥åšå¤šä¸ªèšåˆ</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(amount) <span class="keyword">OVER</span> w, <span class="keyword">SUM</span>(amount) <span class="keyword">OVER</span> w</span><br><span class="line"><span class="keyword">FROM</span> Orders</span><br><span class="line"><span class="keyword">WINDOW</span> w <span class="keyword">AS</span> (</span><br><span class="line"> <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">user</span></span><br><span class="line"> <span class="keyword">ORDER</span> <span class="keyword">BY</span> proctime</span><br><span class="line"> <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">2</span> <span class="keyword">PRECEDING</span> <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="keyword">ROW</span>)</span><br></pre></td></tr></table></figure><h1 id="å‡½æ•°"><a href="#å‡½æ•°" class="headerlink" title="å‡½æ•°"></a>å‡½æ•°</h1><p>Flink Table å’Œ SQL å†…ç½®äº†å¾ˆå¤š SQL ä¸­æ”¯æŒçš„å‡½æ•°ï¼›å¦‚æœæœ‰æ— æ³•æ»¡è¶³çš„éœ€è¦ï¼Œåˆ™å¯ä»¥å® ç°ç”¨æˆ·è‡ªå®šä¹‰çš„å‡½æ•°ï¼ˆUDFï¼‰æ¥è§£å†³ã€‚</p><h2 id="å†…ç½®å‡½æ•°"><a href="#å†…ç½®å‡½æ•°" class="headerlink" title="å†…ç½®å‡½æ•°"></a>å†…ç½®å‡½æ•°</h2><p>Flink Table API å’Œ SQL ä¸ºç”¨æˆ·æä¾›äº†ä¸€ç»„ç”¨äºæ•°æ®è½¬æ¢çš„å†…ç½®å‡½æ•°ã€‚SQL ä¸­æ”¯æŒçš„å¾ˆå¤š å‡½æ•°ï¼ŒTable API å’Œ SQL éƒ½å·²ç»åšäº†å®ç°ï¼Œå…¶å®ƒè¿˜åœ¨å¿«é€Ÿå¼€å‘æ‰©å±•ä¸­ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€äº›å…¸å‹å‡½æ•°çš„ä¸¾ä¾‹ï¼Œå…¨éƒ¨çš„å†…ç½®å‡½æ•°ï¼Œå¯ä»¥å‚è€ƒå®˜ç½‘ä»‹ç»ã€‚<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/functions/systemFunctions.html">Apache Flink 1.12 Documentation: ç³»ç»Ÿï¼ˆå†…ç½®ï¼‰å‡½æ•°</a></p><p><strong><em>æ¯”è¾ƒå‡½æ•°</em></strong></p><p>SQL</p><ul><li> value1 = value2 </li><li>value1 &gt; value2 </li></ul><p>Table APIï¼š </p><ul><li>ANY1 === ANY2</li><li>ANY1 &gt; ANY2</li></ul><p><strong><em>é€»è¾‘å‡½æ•°</em></strong></p><p>SQLï¼š </p><ul><li>boolean1 OR boolean2</li><li> boolean IS FALSE </li><li>NOT boolean </li></ul><p>Table APIï¼š</p><ul><li> BOOLEAN1 || BOOLEAN2 </li><li>OOLEAN.isFalse </li><li>!BOOLEAN</li></ul><p><strong><em>ç®—æœ¯å‡½æ•°</em></strong></p><p>SQLï¼š </p><ul><li><p>numeric1 + numeric2 </p></li><li><p>POWER(numeric1, numeric2)</p><p>Table APIï¼š</p></li><li><p>NUMERIC1 + NUMERIC2 </p></li><li><p>NUMERIC1.power(NUMERIC2)</p></li></ul><p><strong><em>å­—ç¬¦ä¸²å‡½æ•°</em></strong></p><p>SQLï¼š </p><ul><li>string1 || string2 </li><li>UPPER(string)</li><li> CHAR_LENGTH(string) </li></ul><p>Table APIï¼š</p><ul><li>STRING1 + STRING2 </li><li>STRING.upperCase() </li><li>STRING.charLength()</li></ul><p><strong><em>æ—¶é—´å‡½æ•°</em></strong></p><p>SQLï¼š </p><ul><li>DATE string </li><li>TIMESTAMP string </li><li>CURRENT_TIME </li><li>INTERVAL string range </li></ul><p>Table APIï¼š </p><ul><li>STRING.toDate </li><li>STRING.toTimestamp </li><li>currentTime() </li><li>NUMERIC.days </li><li>NUMERIC.minutes</li></ul><p><strong><em>èšåˆå‡½æ•°</em></strong></p><p>SQLï¼š</p><ul><li>COUNT(*) </li><li>SUM([ ALL | DISTINCT ] expression) </li><li>RANK() </li><li>ROW_NUMBER() </li></ul><p>Table APIï¼š </p><ul><li>FIELD.count </li><li>FIELD.sum0 </li></ul><h2 id="UDF"><a href="#UDF" class="headerlink" title="UDF"></a>UDF</h2><p><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/functions/udfs.html">Apache Flink 1.12 Documentation: è‡ªå®šä¹‰å‡½æ•°</a></p><p>ç”¨æˆ·å®šä¹‰å‡½æ•°ï¼ˆUser-defined Functionsï¼ŒUDFï¼‰æ˜¯ä¸€ä¸ªé‡è¦çš„ç‰¹æ€§ï¼Œå› ä¸ºå®ƒä»¬æ˜¾è‘—åœ°æ‰© å±•äº†æŸ¥è¯¢ï¼ˆQueryï¼‰çš„è¡¨è¾¾èƒ½åŠ›ã€‚ä¸€äº›ç³»ç»Ÿå†…ç½®å‡½æ•°æ— æ³•è§£å†³çš„éœ€æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ UDF æ¥è‡ª å®šä¹‰å®ç°ã€‚</p><p><font color="red">åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç”¨æˆ·å®šä¹‰çš„å‡½æ•°å¿…é¡»å…ˆæ³¨å†Œï¼Œç„¶åæ‰èƒ½åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨ã€‚</font></p><p>ä¸éœ€è¦ä¸“é—¨ä¸º Scala çš„ Table API æ³¨å†Œå‡½æ•°ã€‚ å‡½æ•°é€šè¿‡è°ƒç”¨ registerFunctionï¼ˆï¼‰æ–¹æ³•åœ¨ TableEnvironment ä¸­æ³¨å†Œã€‚å½“ç”¨æˆ·å®šä¹‰çš„å‡½æ•° è¢«æ³¨å†Œæ—¶ï¼Œå®ƒè¢«æ’å…¥åˆ° TableEnvironment çš„å‡½æ•°ç›®å½•ä¸­ï¼Œè¿™æ · Table API æˆ– SQL è§£æå™¨å°±å¯ ä»¥è¯†åˆ«å¹¶æ­£ç¡®åœ°è§£é‡Šå®ƒã€‚</p><p>å½“å‰ Flink æœ‰å¦‚ä¸‹å‡ ç§å‡½æ•°ï¼š</p><ul><li><em>æ ‡é‡å‡½æ•°</em> å°†æ ‡é‡å€¼è½¬æ¢æˆä¸€ä¸ªæ–°æ ‡é‡å€¼ï¼›</li><li><em>è¡¨å€¼å‡½æ•°</em> å°†æ ‡é‡å€¼è½¬æ¢æˆæ–°çš„è¡Œæ•°æ®ï¼›</li><li><em>èšåˆå‡½æ•°</em> å°†å¤šè¡Œæ•°æ®é‡Œçš„æ ‡é‡å€¼è½¬æ¢æˆä¸€ä¸ªæ–°æ ‡é‡å€¼ï¼›</li><li><em>è¡¨å€¼èšåˆå‡½æ•°</em> å°†å¤šè¡Œæ•°æ®é‡Œçš„æ ‡é‡å€¼è½¬æ¢æˆæ–°çš„è¡Œæ•°æ®ï¼›</li><li><em>å¼‚æ­¥è¡¨å€¼å‡½æ•°</em> æ˜¯å¼‚æ­¥æŸ¥è¯¢å¤–éƒ¨æ•°æ®ç³»ç»Ÿçš„ç‰¹æ®Šå‡½æ•°ã€‚</li></ul><h3 id="æ ‡é‡å‡½æ•°ï¼ˆScalar-Functionsï¼‰"><a href="#æ ‡é‡å‡½æ•°ï¼ˆScalar-Functionsï¼‰" class="headerlink" title="æ ‡é‡å‡½æ•°ï¼ˆScalar Functionsï¼‰"></a>æ ‡é‡å‡½æ•°ï¼ˆScalar Functionsï¼‰</h3><p>è‡ªå®šä¹‰æ ‡é‡å‡½æ•°å¯ä»¥æŠŠ 0 åˆ°å¤šä¸ªæ ‡é‡å€¼æ˜ å°„æˆ 1 ä¸ªæ ‡é‡å€¼ï¼Œ<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/types.html">æ•°æ®ç±»å‹</a>é‡Œåˆ—å‡ºçš„ä»»ä½•æ•°æ®ç±»å‹éƒ½å¯ä½œä¸ºæ±‚å€¼æ–¹æ³•çš„å‚æ•°å’Œè¿”å›å€¼ç±»å‹ã€‚</p><p>æƒ³è¦å®ç°è‡ªå®šä¹‰æ ‡é‡å‡½æ•°ï¼Œä½ éœ€è¦æ‰©å±• <code>org.apache.flink.table.functions</code> é‡Œé¢çš„ <code>ScalarFunction</code> å¹¶ä¸”å®ç°ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ±‚å€¼æ–¹æ³•ã€‚æ ‡é‡å‡½æ•°çš„è¡Œä¸ºå–å†³äºä½ å†™çš„æ±‚å€¼æ–¹æ³•ã€‚æ±‚å€¼æ–¹æ³•å¿…é¡»æ˜¯ <code>public</code> çš„ï¼Œè€Œä¸”åå­—å¿…é¡»æ˜¯ <code>eval</code>ã€‚</p><p>ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•å®ç°ä¸€ä¸ªæ±‚å“ˆå¸Œå€¼çš„å‡½æ•°å¹¶åœ¨æŸ¥è¯¢é‡Œè°ƒç”¨å®ƒï¼Œè¯¦æƒ…å¯å‚è€ƒ<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/functions/udfs.html#%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97">å¼€å‘æŒ‡å—</a>ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.bridge.scala.&#123;<span class="type">StreamTableEnvironment</span>, tableConversions&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.&#123;<span class="type">FieldExpression</span>, call&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.functions.<span class="type">ScalarFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.types.<span class="type">Row</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">MyScalarFunction</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">// é»˜è®¤äº‹ä»¶æ—¶é—´ï¼Œä¸æŒ‡å®š</span></span><br><span class="line">    println(env.getStreamTimeCharacteristic)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileSystemSql: <span class="type">String</span> = <span class="string">&quot;CREATE TABLE fs_table &quot;</span> +</span><br><span class="line">      <span class="string">&quot;(id STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;ts BIGINT,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;  temp DOUBLE, &quot;</span> +</span><br><span class="line">      <span class="string">&quot; row_time as  TO_TIMESTAMP( FROM_UNIXTIME(ts) ) ,&quot;</span> +</span><br><span class="line">      <span class="string">&quot; WATERMARK FOR row_time AS row_time - INTERVAL &#x27;5&#x27; SECOND) &quot;</span> +</span><br><span class="line">      <span class="string">&quot; WITH (&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;connector&#x27;=&#x27;filesystem&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;path&#x27;=&#x27;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;format&#x27;=&#x27;csv&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">    tableEnv.executeSql(fileSystemSql)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. åœ¨ Table API é‡Œä¸ç»æ³¨å†Œç›´æ¥â€œå†…è”â€è°ƒç”¨å‡½æ•°</span></span><br><span class="line">    tableEnv.from(<span class="string">&quot;fs_table&quot;</span>).select($<span class="string">&quot;id&quot;</span>, call(classOf[<span class="type">HashFunction</span>], $<span class="string">&quot;id&quot;</span>))</span><br><span class="line">      .toAppendStream[<span class="type">Row</span>].print()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. æ³¨å†Œå‡½æ•°</span></span><br><span class="line">    tableEnv.createTemporarySystemFunction(<span class="string">&quot;HashFunction&quot;</span>, classOf[<span class="type">HashFunction</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.1 åœ¨ Table API é‡Œè°ƒç”¨æ³¨å†Œå¥½çš„å‡½æ•°</span></span><br><span class="line">    tableEnv.from(<span class="string">&quot;fs_table&quot;</span>).select($<span class="string">&quot;id&quot;</span>, call(<span class="string">&quot;HashFunction&quot;</span>, $<span class="string">&quot;id&quot;</span>))</span><br><span class="line">      .toAppendStream[<span class="type">Row</span>].print()</span><br><span class="line">    <span class="comment">// 2.2 åœ¨ SQL é‡Œè°ƒç”¨æ³¨å†Œå¥½çš„å‡½æ•°</span></span><br><span class="line">    tableEnv.sqlQuery(<span class="string">&quot;SELECT id, HashFunction(id) FROM fs_table&quot;</span>)</span><br><span class="line">      .toAppendStream[<span class="type">Row</span>].print()</span><br><span class="line">    </span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">HashFunction</span> <span class="keyword">extends</span> <span class="title">ScalarFunction</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">eval</span></span>(a: <span class="type">String</span>): <span class="type">Int</span> = &#123;</span><br><span class="line">      a.hashCode</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è¡¨å‡½æ•°ï¼ˆTable-Functionsï¼‰"><a href="#è¡¨å‡½æ•°ï¼ˆTable-Functionsï¼‰" class="headerlink" title="è¡¨å‡½æ•°ï¼ˆTable Functionsï¼‰"></a>è¡¨å‡½æ•°ï¼ˆTable Functionsï¼‰</h3><p>è·Ÿè‡ªå®šä¹‰æ ‡é‡å‡½æ•°ä¸€æ ·ï¼Œè‡ªå®šä¹‰è¡¨å€¼å‡½æ•°çš„è¾“å…¥å‚æ•°ä¹Ÿå¯ä»¥æ˜¯ 0 åˆ°å¤šä¸ªæ ‡é‡ã€‚<font color="red">ä½†æ˜¯è·Ÿæ ‡é‡å‡½æ•°åªèƒ½è¿”å›ä¸€ä¸ªå€¼ä¸åŒçš„æ˜¯ï¼Œå®ƒå¯ä»¥è¿”å›ä»»æ„å¤šè¡Œã€‚è¿”å›çš„æ¯ä¸€è¡Œå¯ä»¥åŒ…å« 1 åˆ°å¤šåˆ—</font>ï¼Œå¦‚æœè¾“å‡ºè¡ŒåªåŒ…å« 1 åˆ—ï¼Œä¼šçœç•¥ç»“æ„åŒ–ä¿¡æ¯å¹¶ç”Ÿæˆæ ‡é‡å€¼ï¼Œè¿™ä¸ªæ ‡é‡å€¼åœ¨è¿è¡Œé˜¶æ®µä¼šéšå¼åœ°åŒ…è£…è¿›è¡Œé‡Œã€‚</p><p>è¦å®šä¹‰ä¸€ä¸ªè¡¨å€¼å‡½æ•°ï¼Œä½ éœ€è¦æ‰©å±• <code>org.apache.flink.table.functions</code> ä¸‹çš„ <code>TableFunction</code>ï¼Œå¯ä»¥é€šè¿‡å®ç°å¤šä¸ªåä¸º <code>eval</code> çš„æ–¹æ³•å¯¹æ±‚å€¼æ–¹æ³•è¿›è¡Œé‡è½½ã€‚åƒå…¶ä»–å‡½æ•°ä¸€æ ·ï¼Œè¾“å…¥å’Œè¾“å‡ºç±»å‹ä¹Ÿå¯ä»¥é€šè¿‡åå°„è‡ªåŠ¨æå–å‡ºæ¥ã€‚è¡¨å€¼å‡½æ•°è¿”å›çš„è¡¨çš„ç±»å‹å–å†³äº <code>TableFunction</code> ç±»çš„æ³›å‹å‚æ•° <code>T</code>ï¼Œä¸åŒäºæ ‡é‡å‡½æ•°ï¼Œè¡¨å€¼å‡½æ•°çš„æ±‚å€¼æ–¹æ³•æœ¬èº«ä¸åŒ…å«è¿”å›ç±»å‹ï¼Œè€Œæ˜¯é€šè¿‡ <code>collect(T)</code> æ–¹æ³•æ¥å‘é€è¦è¾“å‡ºçš„è¡Œã€‚</p><p>åœ¨ Table API ä¸­ï¼Œè¡¨å€¼å‡½æ•°æ˜¯é€šè¿‡ <code>.joinLateral(...)</code> æˆ–è€… <code>.leftOuterJoinLateral(...)</code> æ¥ä½¿ç”¨çš„ã€‚<code>joinLateral</code> ç®—å­ä¼šæŠŠå¤–è¡¨ï¼ˆç®—å­å·¦ä¾§çš„è¡¨ï¼‰çš„æ¯ä¸€è¡Œè·Ÿè·Ÿè¡¨å€¼å‡½æ•°è¿”å›çš„æ‰€æœ‰è¡Œï¼ˆä½äºç®—å­å³ä¾§ï¼‰è¿›è¡Œ ï¼ˆcrossï¼‰joinã€‚<code>leftOuterJoinLateral</code> ç®—å­ä¹Ÿæ˜¯æŠŠå¤–è¡¨ï¼ˆç®—å­å·¦ä¾§çš„è¡¨ï¼‰çš„æ¯ä¸€è¡Œè·Ÿè¡¨å€¼å‡½æ•°è¿”å›çš„æ‰€æœ‰è¡Œï¼ˆä½äºç®—å­å³ä¾§ï¼‰è¿›è¡Œï¼ˆcrossï¼‰joinï¼Œ<strong>å¹¶ä¸”å¦‚æœè¡¨å€¼å‡½æ•°è¿”å› 0 è¡Œä¹Ÿä¼šä¿ç•™å¤–è¡¨çš„è¿™ä¸€è¡Œã€‚</strong></p><blockquote><p>å³<code>leftOuterJoinLateral</code> ï¼Œåœ¨è¡¨å‡½æ•°è¿”å›0è¡Œæ—¶ï¼ŒåŸè¡¨çš„æ­¤è¡Œä¹Ÿä¼šä¿ç•™ï¼Œè€Œ<code>joinLateral</code>ä¸ä¼š</p></blockquote><p>åœ¨ SQL é‡Œé¢ç”¨ <code>JOIN</code> æˆ–è€… ä»¥ <code>ON TRUE</code> ä¸ºæ¡ä»¶çš„ <code>LEFT JOIN</code> æ¥é…åˆ <code>LATERAL TABLE(&lt;TableFunction&gt;)</code> çš„ä½¿ç”¨ã€‚</p><blockquote><p>LEFT JOIN LATERAL TABLEå’Œ FROM MyTable, LATERAL TABLEå’Œä¸Šé¢ä¸€ä¸ªæ„æ€ã€‚LEFT JOINå½“è¡¨å‡½æ•°ä¸è¿”å›å€¼æ—¶ï¼Œè¡Œä¼šè¢«ä¿ç•™ï¼Œè¡¨å‡½æ•°æœ¬è¯¥è¿”å›çš„å€¼ä¸ºnullï¼Œè€Œ FROM MyTable, LATERALç›´æ¥ä¸ä¿ç•™è¡¨å‡½æ•°æ²¡æœ‰è¿”å›å€¼è¡Œ</p></blockquote><blockquote><p>Table API ä¸ºä»€ä¹ˆéœ€è¦Lateralï¼ŒSQLä¸ºä»€ä¹ˆéœ€è¦<code>JOIN</code> ã€‚å› ä¸ºå¦‚æœä½ å°†ä¸€åˆ—ç»è¿‡è¡¨å‡½æ•°å½¢æˆäº†å¤šè¡Œï¼Œé‚£ä¹ˆæ²¡æœ‰ç»è¿‡æ­¤æ“ä½œçš„åˆ—è¿˜æ˜¯åŸæ¥çš„è¡Œï¼Œä¸ºäº†å¡«å……è¿™äº›åˆ—çš„å€¼ï¼Œéœ€è¦å’Œä»¥å‰çš„æ•°æ®è¿›è¡Œjoin</p></blockquote><p>ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•å®ç°ä¸€ä¸ªåˆ†éš”å‡½æ•°å¹¶åœ¨æŸ¥è¯¢é‡Œè°ƒç”¨å®ƒï¼Œå°†idå­—æ®µä»¥_åˆ†å‰²ï¼Œè¾“å‡ºæ¯ä¸ªè¢«åˆ†å‰²çš„å€¼å’Œé•¿åº¦ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.table.udf</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.annotation.&#123;<span class="type">DataTypeHint</span>, <span class="type">FunctionHint</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.bridge.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.functions.<span class="type">TableFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.types.<span class="type">Row</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">MyTableFunction</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">// é»˜è®¤äº‹ä»¶æ—¶é—´ï¼Œä¸æŒ‡å®š</span></span><br><span class="line">    println(env.getStreamTimeCharacteristic)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileSystemSql: <span class="type">String</span> = <span class="string">&quot;CREATE TABLE MyTable &quot;</span> +</span><br><span class="line">      <span class="string">&quot;(id STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;ts BIGINT,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;  temp DOUBLE, &quot;</span> +</span><br><span class="line">      <span class="string">&quot; row_time as  TO_TIMESTAMP( FROM_UNIXTIME(ts) ) ,&quot;</span> +</span><br><span class="line">      <span class="string">&quot; WATERMARK FOR row_time AS row_time - INTERVAL &#x27;5&#x27; SECOND) &quot;</span> +</span><br><span class="line">      <span class="string">&quot; WITH (&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;connector&#x27;=&#x27;filesystem&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;path&#x27;=&#x27;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;format&#x27;=&#x27;csv&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">    tableEnv.executeSql(fileSystemSql)</span><br><span class="line">    <span class="keyword">val</span> table: <span class="type">Table</span> = tableEnv.from(<span class="string">&quot;MyTable&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. åœ¨ Table API é‡Œä¸ç»æ³¨å†Œç›´æ¥â€œå†…è”â€è°ƒç”¨å‡½æ•°</span></span><br><span class="line"><span class="comment">//    å³`leftOuterJoinLateral` ï¼Œåœ¨è¡¨å‡½æ•°è¿”å›0è¡Œæ—¶ï¼ŒåŸè¡¨çš„æ­¤è¡Œä¹Ÿä¼šä¿ç•™ï¼Œè€Œ`joinLateral`ä¸ä¼š</span></span><br><span class="line">    table</span><br><span class="line">      .joinLateral(call(classOf[<span class="type">SplitFunction</span>], $<span class="string">&quot;id&quot;</span>))</span><br><span class="line">      .select($<span class="string">&quot;id&quot;</span>, $<span class="string">&quot;word&quot;</span>, $<span class="string">&quot;length&quot;</span>)</span><br><span class="line">      .toAppendStream[<span class="type">Row</span>].print()</span><br><span class="line"></span><br><span class="line">    table</span><br><span class="line">      .leftOuterJoinLateral(call(classOf[<span class="type">SplitFunction</span>], $<span class="string">&quot;myField&quot;</span>))</span><br><span class="line">      .select($<span class="string">&quot;myField&quot;</span>, $<span class="string">&quot;word&quot;</span>, $<span class="string">&quot;length&quot;</span>)</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">    <span class="comment">// ä¸‹é¢çš„è°ƒç”¨æ–¹å¼éƒ½éœ€è¦æ³¨å†Œä¹‹å</span></span><br><span class="line">    tableEnv.createTemporarySystemFunction(<span class="string">&quot;SplitFunction&quot;</span>, classOf[<span class="type">SplitFunction</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. åœ¨ Table API é‡Œè°ƒç”¨æ³¨å†Œå¥½çš„å‡½æ•°</span></span><br><span class="line">    table</span><br><span class="line">      .joinLateral(call(<span class="string">&quot;SplitFunction&quot;</span>, $<span class="string">&quot;myField&quot;</span>))</span><br><span class="line">      .select($<span class="string">&quot;myField&quot;</span>, $<span class="string">&quot;word&quot;</span>, $<span class="string">&quot;length&quot;</span>)</span><br><span class="line">    table</span><br><span class="line">      .leftOuterJoinLateral(call(<span class="string">&quot;SplitFunction&quot;</span>, $<span class="string">&quot;myField&quot;</span>))</span><br><span class="line">      .select($<span class="string">&quot;myField&quot;</span>, $<span class="string">&quot;word&quot;</span>, $<span class="string">&quot;length&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//     3.åœ¨ SQL é‡Œè°ƒç”¨æ³¨å†Œå¥½çš„å‡½æ•°// åœ¨ SQL é‡Œè°ƒç”¨æ³¨å†Œå¥½çš„å‡½æ•°</span></span><br><span class="line">    tableEnv.sqlQuery(<span class="string">&quot;SELECT id, word, length &quot;</span> + <span class="string">&quot;FROM MyTable, LATERAL TABLE(SplitFunction&quot;</span> +</span><br><span class="line">      <span class="string">&quot;(id))&quot;</span>).toAppendStream[<span class="type">Row</span>].print()</span><br><span class="line">    tableEnv.sqlQuery(<span class="string">&quot;SELECT id, word, length &quot;</span> + <span class="string">&quot;FROM MyTable &quot;</span> + <span class="string">&quot;LEFT JOIN LATERAL TABLE&quot;</span> +</span><br><span class="line">      <span class="string">&quot;(SplitFunction(id)) ON TRUE&quot;</span>).toAppendStream[<span class="type">Row</span>].print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å‡½æ•°ç±»çš„æ‰€æœ‰æ±‚å€¼æ–¹æ³•æŒ‡å®šåŒä¸€ä¸ªè¾“å‡ºç±»å‹</span></span><br><span class="line">  <span class="meta">@FunctionHint</span>(output = <span class="keyword">new</span> <span class="type">DataTypeHint</span>(<span class="string">&quot;ROW&lt;word STRING, length INT&gt;&quot;</span>))</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">SplitFunction</span> <span class="keyword">extends</span> <span class="title">TableFunction</span>[<span class="type">Row</span>] </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">eval</span></span>(str: <span class="type">String</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="comment">// use collect(...) to emit a row</span></span><br><span class="line">      str.split(<span class="string">&quot;_&quot;</span>).foreach(s =&gt; collect(<span class="type">Row</span>.of(s, <span class="type">Int</span>.box(s.length))))</span><br><span class="line"><span class="comment">//      if (!str.equalsIgnoreCase(&quot;sensor_6&quot;))&#123;</span></span><br><span class="line"><span class="comment">//        str.split(&quot;_&quot;).foreach(s =&gt; collect(Row.of(s, Int.box(s.length))))</span></span><br><span class="line"><span class="comment">//      &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="èšåˆå‡½æ•°ï¼ˆAggregate-Functionsï¼‰"><a href="#èšåˆå‡½æ•°ï¼ˆAggregate-Functionsï¼‰" class="headerlink" title="èšåˆå‡½æ•°ï¼ˆAggregate Functionsï¼‰"></a>èšåˆå‡½æ•°ï¼ˆAggregate Functionsï¼‰</h3><p>è‡ªå®šä¹‰èšåˆå‡½æ•°ï¼ˆUDAGGï¼‰æ˜¯æŠŠä¸€ä¸ªè¡¨ï¼ˆä¸€è¡Œæˆ–è€…å¤šè¡Œï¼Œæ¯è¡Œå¯ä»¥æœ‰ä¸€åˆ—æˆ–è€…å¤šåˆ—ï¼‰èšåˆæˆä¸€ä¸ªæ ‡é‡å€¼ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210113212645785.png" alt="image-20210113212645785"></p><p>ä¸Šé¢çš„å›¾ç‰‡å±•ç¤ºäº†ä¸€ä¸ªèšåˆçš„ä¾‹å­ã€‚å‡è®¾ä½ æœ‰ä¸€ä¸ªå…³äºé¥®æ–™çš„è¡¨ã€‚è¡¨é‡Œé¢æœ‰ä¸‰ä¸ªå­—æ®µï¼Œåˆ†åˆ«æ˜¯ <code>id</code>ã€<code>name</code>ã€<code>price</code>ï¼Œè¡¨é‡Œæœ‰ 5 è¡Œæ•°æ®ã€‚å‡è®¾ä½ éœ€è¦æ‰¾åˆ°æ‰€æœ‰é¥®æ–™é‡Œæœ€è´µçš„é¥®æ–™çš„ä»·æ ¼ï¼Œå³æ‰§è¡Œä¸€ä¸ª <code>max()</code> èšåˆã€‚ä½ éœ€è¦éå†æ‰€æœ‰ 5 è¡Œæ•°æ®ï¼Œè€Œç»“æœå°±åªæœ‰ä¸€ä¸ªæ•°å€¼ã€‚</p><p>è‡ªå®šä¹‰èšåˆå‡½æ•°æ˜¯é€šè¿‡æ‰©å±• <code>AggregateFunction</code> æ¥å®ç°çš„ã€‚<code>AggregateFunction</code> çš„å·¥ä½œè¿‡ç¨‹å¦‚ä¸‹ã€‚é¦–å…ˆï¼Œå®ƒéœ€è¦ä¸€ä¸ª <code>accumulator</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå­˜å‚¨äº†èšåˆçš„ä¸­é—´ç»“æœã€‚é€šè¿‡è°ƒç”¨ <code>AggregateFunction</code> çš„ <code>createAccumulator()</code> æ–¹æ³•åˆ›å»ºä¸€ä¸ªç©ºçš„ accumulatorã€‚æ¥ä¸‹æ¥ï¼Œå¯¹äºæ¯ä¸€è¡Œæ•°æ®ï¼Œä¼šè°ƒç”¨ <code>accumulate()</code> æ–¹æ³•æ¥æ›´æ–° accumulatorã€‚å½“æ‰€æœ‰çš„æ•°æ®éƒ½å¤„ç†å®Œäº†ä¹‹åï¼Œé€šè¿‡è°ƒç”¨ <code>getValue</code> æ–¹æ³•æ¥è®¡ç®—å’Œè¿”å›æœ€ç»ˆçš„ç»“æœã€‚</p><p><strong>ä¸‹é¢å‡ ä¸ªæ–¹æ³•æ˜¯æ¯ä¸ª <code>AggregateFunction</code> å¿…é¡»è¦å®ç°çš„ï¼š</strong></p><ul><li><code>createAccumulator()</code></li><li><code>accumulate()</code></li><li><code>getValue()</code></li></ul><p>Flink çš„ç±»å‹æ¨å¯¼åœ¨é‡åˆ°å¤æ‚ç±»å‹çš„æ—¶å€™å¯èƒ½ä¼šæ¨å¯¼å‡ºé”™è¯¯çš„ç»“æœï¼Œæ¯”å¦‚é‚£äº›éåŸºæœ¬ç±»å‹å’Œæ™®é€šçš„ POJO ç±»å‹çš„å¤æ‚ç±»å‹ã€‚æ‰€ä»¥è·Ÿ <code>ScalarFunction</code> å’Œ <code>TableFunction</code> ä¸€æ ·ï¼Œ<code>AggregateFunction</code> ä¹Ÿæä¾›äº† <code>AggregateFunction#getResultType()</code> å’Œ <code>AggregateFunction#getAccumulatorType()</code> æ¥åˆ†åˆ«æŒ‡å®šè¿”å›å€¼ç±»å‹å’Œ accumulator çš„ç±»å‹ï¼Œä¸¤ä¸ªå‡½æ•°çš„è¿”å›å€¼ç±»å‹ä¹Ÿéƒ½æ˜¯ <code>TypeInformation</code>ã€‚</p><p>é™¤äº†ä¸Šé¢çš„æ–¹æ³•ï¼Œè¿˜æœ‰å‡ ä¸ªæ–¹æ³•å¯ä»¥é€‰æ‹©å®ç°ã€‚è¿™äº›æ–¹æ³•æœ‰äº›å¯ä»¥è®©æŸ¥è¯¢æ›´åŠ é«˜æ•ˆï¼Œè€Œæœ‰äº›æ˜¯åœ¨æŸäº›ç‰¹å®šåœºæ™¯ä¸‹å¿…é¡»è¦å®ç°çš„ã€‚ä¾‹å¦‚ï¼Œ<font color="red">å¦‚æœèšåˆå‡½æ•°ç”¨åœ¨ä¼šè¯çª—å£ï¼ˆå½“ä¸¤ä¸ªä¼šè¯çª—å£åˆå¹¶çš„æ—¶å€™éœ€è¦ merge ä»–ä»¬çš„ accumulatorï¼‰çš„è¯ï¼Œ<code>merge()</code> æ–¹æ³•å°±æ˜¯å¿…é¡»è¦å®ç°çš„ã€‚</font></p><p><strong><code>AggregateFunction</code> çš„ä»¥ä¸‹æ–¹æ³•åœ¨æŸäº›åœºæ™¯ä¸‹æ˜¯å¿…é¡»å®ç°çš„ï¼š</strong></p><ul><li><code>retract()</code> åœ¨ bounded <code>OVER</code> çª—å£ä¸­æ˜¯å¿…é¡»å®ç°çš„ã€‚</li><li><code>merge()</code> åœ¨è®¸å¤šæ‰¹å¼èšåˆå’Œä¼šè¯ä»¥åŠæ»šåŠ¨çª—å£èšåˆä¸­æ˜¯å¿…é¡»å®ç°çš„ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿™ä¸ªæ–¹æ³•å¯¹äºä¼˜åŒ–ä¹Ÿå¾ˆå¤šå¸®åŠ©ã€‚ä¾‹å¦‚ï¼Œä¸¤é˜¶æ®µèšåˆä¼˜åŒ–å°±éœ€è¦æ‰€æœ‰çš„ <code>AggregateFunction</code> éƒ½å®ç° <code>merge</code> æ–¹æ³•ã€‚</li><li><code>resetAccumulator()</code> åœ¨è®¸å¤šæ‰¹å¼èšåˆä¸­æ˜¯å¿…é¡»å®ç°çš„ã€‚</li></ul><p><code>AggregateFunction</code> çš„æ‰€æœ‰æ–¹æ³•éƒ½å¿…é¡»æ˜¯ <code>public</code> çš„ï¼Œä¸èƒ½æ˜¯ <code>static</code> çš„ï¼Œè€Œä¸”åå­—å¿…é¡»è·Ÿä¸Šé¢å†™çš„ä¸€æ ·ã€‚<code>createAccumulator</code>ã€<code>getValue</code>ã€<code>getResultType</code> ä»¥åŠ <code>getAccumulatorType</code> è¿™å‡ ä¸ªå‡½æ•°æ˜¯åœ¨æŠ½è±¡ç±» <code>AggregateFunction</code> ä¸­å®šä¹‰çš„ï¼Œè€Œå…¶ä»–å‡½æ•°éƒ½æ˜¯çº¦å®šçš„æ–¹æ³•ã€‚å¦‚æœè¦å®šä¹‰ä¸€ä¸ªèšåˆå‡½æ•°ï¼Œä½ éœ€è¦æ‰©å±• <code>org.apache.flink.table.functions.AggregateFunction</code>ï¼Œå¹¶ä¸”å®ç°ä¸€ä¸ªï¼ˆæˆ–è€…å¤šä¸ªï¼‰<code>accumulate</code> æ–¹æ³•ã€‚<code>accumulate</code> æ–¹æ³•å¯ä»¥é‡è½½ï¼Œæ¯ä¸ªæ–¹æ³•çš„å‚æ•°ç±»å‹ä¸åŒï¼Œå¹¶ä¸”æ”¯æŒå˜é•¿å‚æ•°ã€‚</p><hr><p>è‡ªå®šä¹‰å®ç°avgèšåˆï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.table.udf</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.annotation.&#123;<span class="type">DataTypeHint</span>, <span class="type">FunctionHint</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.<span class="type">Expressions</span>.lit</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.bridge.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.&#123;$, <span class="type">Table</span>, <span class="type">Tumble</span>, <span class="type">WithOperations</span>, call&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.functions.<span class="type">AggregateFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.types.<span class="type">Row</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">MyAggregateFunction</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">// é»˜è®¤äº‹ä»¶æ—¶é—´ï¼Œä¸æŒ‡å®š</span></span><br><span class="line">    println(env.getStreamTimeCharacteristic)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileSystemSql: <span class="type">String</span> = <span class="string">&quot;CREATE TABLE MyTable &quot;</span> +</span><br><span class="line">      <span class="string">&quot;(id STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;ts BIGINT,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;  temp DOUBLE, &quot;</span> +</span><br><span class="line">      <span class="string">&quot; row_time as  TO_TIMESTAMP( FROM_UNIXTIME(ts) ) ,&quot;</span> +</span><br><span class="line">      <span class="string">&quot; WATERMARK FOR row_time AS row_time - INTERVAL &#x27;5&#x27; SECOND) &quot;</span> +</span><br><span class="line">      <span class="string">&quot; WITH (&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;connector&#x27;=&#x27;filesystem&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;path&#x27;=&#x27;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;format&#x27;=&#x27;csv&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">    tableEnv.executeSql(fileSystemSql)</span><br><span class="line">    <span class="keyword">val</span> table: <span class="type">Table</span> = tableEnv.from(<span class="string">&quot;MyTable&quot;</span>)</span><br><span class="line"></span><br><span class="line">    tableEnv.createTemporarySystemFunction(<span class="string">&quot;myavg&quot;</span>, classOf[<span class="type">MyAvg</span>])</span><br><span class="line">    table.window(<span class="type">Tumble</span>.over(lit(<span class="number">1</span>).hour()).on($(<span class="string">&quot;row_time&quot;</span>)).as(<span class="string">&quot;w&quot;</span>))</span><br><span class="line">      .groupBy($(<span class="string">&quot;w&quot;</span>), $(<span class="string">&quot;id&quot;</span>))</span><br><span class="line">      .select($(<span class="string">&quot;id&quot;</span>).as(<span class="string">&quot;test&quot;</span>), call(<span class="string">&quot;myavg&quot;</span>, $(<span class="string">&quot;temp&quot;</span>)).as(<span class="string">&quot;avg&quot;</span>))</span><br><span class="line">      .toAppendStream[<span class="type">Row</span>].print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">CountAccumulator</span>(<span class="params">var count: <span class="type">Long</span>, var sum: <span class="type">Double</span></span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MyAvg</span> <span class="keyword">extends</span> <span class="title">AggregateFunction</span>[<span class="type">Double</span>, <span class="type">CountAccumulator</span>] </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸åŠ æŠ¥é”™</span></span><br><span class="line">    <span class="meta">@FunctionHint</span>(</span><br><span class="line">      input = <span class="type">Array</span>(<span class="keyword">new</span> <span class="type">DataTypeHint</span>(<span class="string">&quot;DOUBLE&quot;</span>)),</span><br><span class="line">      output = <span class="keyword">new</span> <span class="type">DataTypeHint</span>(<span class="string">&quot;DOUBLE&quot;</span>)</span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">accumulate</span></span>(acc: <span class="type">CountAccumulator</span>, param: <span class="type">Double</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">      acc.sum = acc.sum + param</span><br><span class="line">      acc.count = acc.count + <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getValue</span></span>(accumulator: <span class="type">CountAccumulator</span>): <span class="type">Double</span> = accumulator.sum / accumulator.count</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">createAccumulator</span></span>(): <span class="type">CountAccumulator</span> = <span class="type">CountAccumulator</span>(<span class="number">0</span>L, <span class="number">0.0</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è¡¨èšåˆå‡½æ•°ï¼ˆTable-Aggregate-Functionsï¼‰"><a href="#è¡¨èšåˆå‡½æ•°ï¼ˆTable-Aggregate-Functionsï¼‰" class="headerlink" title="è¡¨èšåˆå‡½æ•°ï¼ˆTable Aggregate Functionsï¼‰"></a>è¡¨èšåˆå‡½æ•°ï¼ˆTable Aggregate Functionsï¼‰</h3><p>= è¡¨å‡½æ•° + èšåˆå‡½æ•°</p><p>ç•¥ã€‚</p><hr><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@FunctionHint(output &#x3D; new DataTypeHint(&quot;ROW&lt;word STRING, length INT&gt;&quot;))</span><br></pre></td></tr></table></figure><p>æŒºé‡è¦çš„</p><p><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/functions/udfs.html#%E7%B1%BB%E5%9E%8B%E6%8E%A8%E5%AF%BC">Apache Flink 1.12 Documentation: è‡ªå®šä¹‰å‡½æ•°</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;æ•´ä½“ä»‹ç»&quot;&gt;&lt;a href=&quot;#æ•´ä½“ä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;æ•´ä½“ä»‹ç»&quot;&gt;&lt;/a&gt;æ•´ä½“ä»‹ç»&lt;/h1&gt;&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h</summary>
      
    
    
    
    <category term="Flink" scheme="https://awslzhang.top/categories/Flink/"/>
    
    
    <category term="Flink" scheme="https://awslzhang.top/tags/Flink/"/>
    
  </entry>
  
  <entry>
    <title>FlinkçŠ¶æ€ç¼–ç¨‹å’Œå®¹é”™æœºåˆ¶</title>
    <link href="https://awslzhang.top/2021/01/02/Flink%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/"/>
    <id>https://awslzhang.top/2021/01/02/Flink%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/</id>
    <published>2021-01-02T10:06:02.000Z</published>
    <updated>2021-01-04T14:06:37.882Z</updated>
    
    <content type="html"><![CDATA[<h1 id="FlinkçŠ¶æ€ç®¡ç†"><a href="#FlinkçŠ¶æ€ç®¡ç†" class="headerlink" title="FlinkçŠ¶æ€ç®¡ç†"></a>FlinkçŠ¶æ€ç®¡ç†</h1><p>æµå¼è®¡ç®—åˆ†ä¸º<strong>æ— çŠ¶æ€å’Œæœ‰çŠ¶æ€</strong>ä¸¤ç§æƒ…å†µã€‚æ— çŠ¶æ€çš„è®¡ç®—è§‚å¯Ÿæ¯ä¸ªç‹¬ç«‹äº‹ä»¶ï¼Œå¹¶æ ¹æ®æœ€åä¸€ä¸ªäº‹ä»¶è¾“å‡ºç»“æœã€‚ä¾‹å¦‚ï¼Œæµå¤„ç†åº”ç”¨ç¨‹åºä»ä¼ æ„Ÿå™¨æ¥æ”¶æ¸©åº¦è¯»æ•°ï¼Œå¹¶åœ¨æ¸©åº¦è¶…è¿‡90åº¦æ—¶å‘å‡ºè­¦å‘Šã€‚æœ‰çŠ¶æ€çš„è®¡ç®—åˆ™ä¼šåŸºäºå¤šä¸ªäº‹ä»¶è¾“å‡ºç»“æœã€‚ä»¥ä¸‹æ˜¯ä¸€äº›ä¾‹å­ã€‚</p><ul><li>æ‰€æœ‰ç±»å‹çš„çª—å£ã€‚ä¾‹å¦‚ï¼Œè®¡ç®—è¿‡å»ä¸€å°æ—¶çš„å¹³å‡æ¸©åº¦ï¼Œå°±æ˜¯æœ‰çŠ¶æ€çš„è®¡ç®—ã€‚</li><li>æ‰€æœ‰ç”¨äºå¤æ‚äº‹ä»¶å¤„ç†çš„çŠ¶æ€æœºã€‚ä¾‹å¦‚ï¼Œè‹¥åœ¨ä¸€åˆ†é’Ÿå†…æ”¶åˆ°ä¸¤ä¸ªç›¸å·®20åº¦ä»¥ä¸Šçš„æ¸©åº¦è¯»æ•°ï¼Œåˆ™å‘å‡ºè­¦å‘Šï¼Œè¿™æ˜¯æœ‰çŠ¶æ€çš„è®¡ç®—ã€‚</li><li>æµä¸æµä¹‹é—´çš„æ‰€æœ‰å…³è”æ“ä½œï¼Œä»¥åŠæµä¸é™æ€è¡¨æˆ–åŠ¨æ€è¡¨ä¹‹é—´çš„å…³è”æ“ä½œï¼Œéƒ½æ˜¯æœ‰çŠ¶æ€çš„è®¡ç®—ã€‚</li></ul><p>ä¸‹å›¾å±•ç¤ºäº†æ— çŠ¶æ€æµå¤„ç†å’Œæœ‰çŠ¶æ€æµå¤„ç†çš„ä¸»è¦åŒºåˆ«ã€‚æ— çŠ¶æ€æµå¤„ç†åˆ†åˆ«æ¥æ”¶æ¯æ¡æ•°æ®è®°å½•(å›¾ä¸­çš„é»‘æ¡)ï¼Œ<font color="red">ç„¶åæ ¹æ®æœ€æ–°è¾“å…¥çš„æ•°æ®ç”Ÿæˆè¾“å‡ºæ•°æ®(ç™½æ¡)</font>ã€‚æœ‰çŠ¶æ€æµå¤„ç†ä¼šç»´æŠ¤çŠ¶æ€(æ ¹æ®æ¯æ¡è¾“å…¥è®°å½•è¿›è¡Œæ›´æ–°)ï¼Œ<font color="red">å¹¶åŸºäºæœ€æ–°è¾“å…¥çš„è®°å½•å’Œå½“å‰çš„çŠ¶æ€å€¼ç”Ÿæˆè¾“å‡ºè®°å½•(ç°æ¡)ã€‚</font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210103155758486.png" alt="image-20210103155758486"></p><p>ä¸Šå›¾ä¸­è¾“å…¥æ•°æ®ç”±é»‘æ¡è¡¨ç¤ºã€‚æ— çŠ¶æ€æµå¤„ç†æ¯æ¬¡åªè½¬æ¢ä¸€æ¡è¾“å…¥è®°å½•ï¼Œå¹¶ä¸”ä»…æ ¹æ®æœ€æ–°çš„è¾“å…¥è®°å½•è¾“å‡ºç»“æœ(ç™½æ¡)ã€‚æœ‰çŠ¶æ€ æµå¤„ç†ç»´æŠ¤æ‰€æœ‰å·²å¤„ç†è®°å½•çš„çŠ¶æ€å€¼ï¼Œå¹¶æ ¹æ®æ¯æ¡æ–°è¾“å…¥çš„è®°å½•æ›´æ–°çŠ¶æ€ï¼Œå› æ­¤è¾“å‡ºè®°å½•(ç°æ¡)åæ˜ çš„æ˜¯ç»¼åˆè€ƒè™‘å¤šä¸ªäº‹ä»¶ä¹‹åçš„ç»“æœã€‚</p><p>å°½ç®¡æ— çŠ¶æ€çš„è®¡ç®—å¾ˆé‡è¦ï¼Œä½†æ˜¯æµå¤„ç†å¯¹æœ‰çŠ¶æ€çš„è®¡ç®—æ›´æ„Ÿå…´è¶£ã€‚äº‹å®ä¸Šï¼Œæ­£ç¡®åœ°å®ç°æœ‰çŠ¶æ€çš„è®¡ç®—æ¯”å®ç°æ— çŠ¶æ€çš„è®¡ç®—éš¾å¾—å¤šã€‚æ—§çš„æµå¤„ç†ç³»ç»Ÿå¹¶ä¸æ”¯æŒæœ‰çŠ¶æ€çš„è®¡ç®—ï¼Œè€Œæ–°ä¸€ä»£çš„æµå¤„ç†ç³»ç»Ÿåˆ™å°†çŠ¶æ€åŠå…¶æ­£ç¡®æ€§è§†ä¸ºé‡ä¸­ä¹‹é‡.</p><h2 id="æœ‰çŠ¶æ€çš„ç®—å­å’Œåº”ç”¨ç¨‹åº"><a href="#æœ‰çŠ¶æ€çš„ç®—å­å’Œåº”ç”¨ç¨‹åº" class="headerlink" title="æœ‰çŠ¶æ€çš„ç®—å­å’Œåº”ç”¨ç¨‹åº"></a>æœ‰çŠ¶æ€çš„ç®—å­å’Œåº”ç”¨ç¨‹åº</h2><p>Flinkå†…ç½®çš„å¾ˆå¤šç®—å­ï¼Œæ•°æ®æºsourceï¼Œæ•°æ®å­˜å‚¨sinkéƒ½æ˜¯æœ‰çŠ¶æ€çš„ï¼Œæµä¸­çš„æ•°æ®éƒ½æ˜¯buffer recordsï¼Œä¼šä¿å­˜ä¸€å®šçš„å…ƒç´ æˆ–è€…å…ƒæ•°æ®ã€‚ä¾‹å¦‚: ProcessWindowFunctionä¼šç¼“å­˜è¾“å…¥æµçš„æ•°æ®ï¼ŒProcessFunctionä¼šä¿å­˜è®¾ç½®çš„å®šæ—¶å™¨ä¿¡æ¯ç­‰ç­‰ã€‚</p><p>åœ¨Flinkä¸­ï¼Œ<font color="red"><strong>çŠ¶æ€å§‹ç»ˆä¸ç‰¹å®šç®—å­ç›¸å…³è”</strong></font>ã€‚æ€»çš„æ¥è¯´ï¼Œæœ‰ä¸¤ç§ç±»å‹çš„çŠ¶æ€ï¼š</p><ol><li>ç®—å­çŠ¶æ€ï¼ˆoperator stateï¼‰</li><li>é”®æ§çŠ¶æ€ï¼ˆkeyed stateï¼‰</li></ol><blockquote><p>å³Flinkçš„çŠ¶æ€æ˜¯ç”±ç®—å­ç»´æŠ¤çš„ï¼Œæ¯ä¸ªç®—å­çš„çŠ¶æ€éƒ½æ˜¯æœ¬ç®—å­çš„ï¼Œå…¶ä»–ç®—å­è®¿é—®ä¸åˆ°æœ¬ç®—å­çš„ã€‚</p><p>ç®—å­çŠ¶æ€å’Œé”®æ§çŠ¶æ€çš„åŒºåˆ«å°±æ˜¯ï¼š</p><ol><li>ç®—å­çŠ¶æ€çš„çŠ¶æ€æ˜¯å’Œç®—å­ç»‘å®šçš„ï¼Œç®—å­çš„çŠ¶æ€çš„è®¿é—®æƒé™æ˜¯æ­¤ç®—å­å¤„ç†çš„æ‰€æœ‰æ•°æ®ã€‚ä¸€ä¸ªç®—å­ä¸€ä¸ªçŠ¶æ€ã€‚å¹¶è¡Œåº¦å¢åŠ ï¼Œç®—å­å°±å¢åŠ ï¼ŒçŠ¶æ€å°±å¢åŠ </li><li>é”®æ§çŠ¶æ€çš„çŠ¶æ€æ˜¯å’Œkeyç»‘å®šçš„ï¼Œè®¿é—®æƒé™æ˜¯ç›¸åº”keyçš„æ•°æ®æ‰èƒ½è®¿é—®åˆ°å¯¹åº”keyçš„çŠ¶æ€ã€‚</li></ol></blockquote><hr><p>Flinkçš„çŠ¶æ€è¯´ç™½äº†å°±ç›¸å½“äºæœ¬åœ°å˜é‡ï¼Œä½†æ˜¯Flinkæä¾›äº†å¯¹å®ƒçš„ç®¡ç†ï¼šä¸€è‡´æ€§ã€æ•…éšœã€é«˜æ•ˆç‡å­˜å‚¨è®¿é—®ã€‚æ‰€ä»¥å½“ç¨‹åºæ•…éšœæ—¶ï¼ŒFlinkçš„ç®¡ç†æœºåˆ¶å¯ä»¥å®ç°ä»è¿œç¨‹è¯»å–ä¹‹å‰ä¿å­˜çš„çŠ¶æ€ç»§ç»­å¼€å§‹è®¡ç®—ï¼Œè€Œä¸æ˜¯çŠ¶æ€ä¸¢å¤±é‡æ–°è®¡ç®—ã€‚</p><h3 id="ç®—å­çŠ¶æ€ï¼ˆoperator-stateï¼‰"><a href="#ç®—å­çŠ¶æ€ï¼ˆoperator-stateï¼‰" class="headerlink" title="ç®—å­çŠ¶æ€ï¼ˆoperator stateï¼‰"></a>ç®—å­çŠ¶æ€ï¼ˆoperator stateï¼‰</h3><p>ç®—å­çŠ¶æ€çš„ä½œç”¨èŒƒå›´é™å®šä¸ºç®—å­ä»»åŠ¡ã€‚è¿™æ„å‘³ç€ç”±<strong>åŒä¸€å¹¶è¡Œä»»åŠ¡æ‰€å¤„ç†çš„æ‰€æœ‰æ•°æ®éƒ½å¯ä»¥è®¿é—®åˆ°ç›¸åŒçš„çŠ¶æ€</strong>ï¼ŒçŠ¶æ€å¯¹äºåŒä¸€ä»»åŠ¡è€Œè¨€æ˜¯å…±äº«çš„ã€‚ç®—å­çŠ¶æ€ä¸èƒ½ç”±ç›¸åŒæˆ–ä¸åŒç®—å­çš„å¦ä¸€ä¸ªä»»åŠ¡è®¿é—®ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210103161006283.png" alt="image-20210103161006283"></p><p>ç»“åˆå›¾æ¥è®²å°±æ˜¯å› ä¸ºå¹¶è¡Œåº¦taskçš„å¤šä¸ªä»»åŠ¡ï¼Œä¸åŒçš„ä»»åŠ¡ä¹‹é—´çš„çŠ¶æ€ä¸èƒ½è®¿é—®ã€‚è€Œç›¸åŒä»»åŠ¡ã€åˆ†åŒºä¸­è¢«å¤„ç†çš„æ•°æ®éƒ½å¯ä»¥è®¿é—®æœ¬ä»»åŠ¡ã€åˆ†åŒºä¸­çš„çŠ¶æ€ã€‚</p><h4 id="çŠ¶æ€æ•°æ®ç»“æ„"><a href="#çŠ¶æ€æ•°æ®ç»“æ„" class="headerlink" title="çŠ¶æ€æ•°æ®ç»“æ„"></a>çŠ¶æ€æ•°æ®ç»“æ„</h4><p>Flinkä¸ºç®—å­çŠ¶æ€æä¾›ä¸‰ç§åŸºæœ¬æ•°æ®ç»“æ„ï¼š</p><ol><li>åˆ—è¡¨çŠ¶æ€ï¼ˆList stateï¼‰ï¼šå°†çŠ¶æ€è¡¨ç¤ºä¸ºä¸€ç»„æ•°æ®çš„åˆ—è¡¨</li><li>è”åˆåˆ—è¡¨çŠ¶æ€ï¼ˆUnion list stateï¼‰ä¹Ÿå°†çŠ¶æ€è¡¨ç¤ºä¸ºæ•°æ®çš„åˆ—è¡¨ã€‚å®ƒä¸å¸¸è§„åˆ—è¡¨çŠ¶æ€çš„åŒºåˆ«åœ¨äºï¼Œåœ¨å‘ç”Ÿæ•…éšœæ—¶ï¼Œæˆ–è€…ä»ä¿å­˜ç‚¹ï¼ˆsavepointï¼‰å¯åŠ¨åº”ç”¨ç¨‹åºæ—¶å¦‚ä½•æ¢å¤ã€‚</li><li>å¹¿æ’­çŠ¶æ€ï¼ˆBroadcast stateï¼‰ï¼šå¦‚æœä¸€ä¸ªç®—å­æœ‰å¤šé¡¹ä»»åŠ¡ï¼Œè€Œå®ƒçš„æ¯é¡¹ä»»åŠ¡çŠ¶æ€åˆéƒ½ç›¸åŒï¼Œé‚£ä¹ˆè¿™ç§ç‰¹æ®Šæƒ…å†µæœ€é€‚åˆåº”ç”¨å¹¿æ’­çŠ¶æ€ã€‚</li></ol><h4 id="å¦‚ä½•ä½¿ç”¨"><a href="#å¦‚ä½•ä½¿ç”¨" class="headerlink" title="å¦‚ä½•ä½¿ç”¨"></a>å¦‚ä½•ä½¿ç”¨</h4><p>åªéœ€è¦å®ç°<code>ListCheckpointed</code>æ¥å£å³å¯ï¼Œå¹¶å®ç°å¿«ç…§å­˜å‚¨å’Œæ•…éšœæ¢å¤çš„æ–¹æ³•ã€‚å…¶ä½™å°±æ˜¯å’Œä½¿ç”¨æ­£å¸¸æœ¬åœ°å˜é‡ä¸€è‡´ã€‚</p><hr><p>ä¸€èˆ¬æ¥è®²ï¼ŒMapç®—å­è¿›è¡Œçš„éƒ½æ˜¯æ— çŠ¶æ€çš„è®¡ç®—ï¼Œè¿™æ¬¡æˆ‘ä»¬é€šè¿‡çŠ¶æ€å˜é‡é€šè¿‡mapçš„æ–¹å¼æ¥å±•ç°ï¼Œé€šè¿‡è®¡ç®—å…ƒç´ ä¸ªæ•°ï¼Œè¿™ä¸ªè®¡ç®—å’Œä¹‹å‰çš„æ•°æ®æœ‰è”ç³»ï¼Œæ‰€ä»¥éœ€è¦FlinkçŠ¶æ€å˜é‡</p><p>å½“ç„¶å¯ä»¥ç›´æ¥ä½¿ç”¨æœ¬åœ°å˜é‡ï¼Œç®—å­çŠ¶æ€çš„çŠ¶æ€å˜é‡å’Œæœ¬åœ°å˜é‡æœ¬èº«å‡ ä¹æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨çŠ¶æ€å˜é‡çš„è¯ï¼Œå¯¹äºç¨‹åºçš„checkpointä¿å­˜çš„å¼‚å¸¸æ¢å¤æœ‰æ•ˆæœï¼Œæ‰€ä»¥è¯·çœ‹ä¾‹å­ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.flink.transform</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util</span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Collections</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.<span class="type">MapFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.checkpoint.<span class="type">ListCheckpointed</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.example.flink.source.&#123;<span class="type">SensorReading</span>, <span class="type">SensorSource</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">OperatorState</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> value: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = env.addSource(<span class="keyword">new</span> <span class="type">SensorSource</span>)</span><br><span class="line">    value.map(<span class="keyword">new</span> <span class="type">MyMap</span>).print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MyMap</span> <span class="keyword">extends</span> <span class="title">MapFunction</span>[<span class="type">SensorReading</span>, <span class="type">Integer</span>] <span class="keyword">with</span> <span class="title">ListCheckpointed</span>[<span class="type">Integer</span>] </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> count: <span class="type">Integer</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">map</span></span>(t: <span class="type">SensorReading</span>): <span class="type">Integer</span> = &#123;</span><br><span class="line">      count = count + <span class="number">1</span></span><br><span class="line">      count</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®¹é”™æ¢å¤æ—¶ï¼Œæ‰¾åˆ°ä¹‹å‰å­˜å‚¨çš„å˜é‡</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">restoreState</span></span>(list: util.<span class="type">List</span>[<span class="type">Integer</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="keyword">import</span> collection.<span class="type">JavaConverters</span>._</span><br><span class="line">      list.asScala.foreach(count += _)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯¹çŠ¶æ€å˜é‡è¿›è¡Œå¿«ç…§å­˜å‚¨</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">snapshotState</span></span>(l: <span class="type">Long</span>, l1: <span class="type">Long</span>): util.<span class="type">List</span>[<span class="type">Integer</span>] = <span class="type">Collections</span>.singletonList(count)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é”®æ§çŠ¶æ€ï¼ˆkeyed-stateï¼‰"><a href="#é”®æ§çŠ¶æ€ï¼ˆkeyed-stateï¼‰" class="headerlink" title="é”®æ§çŠ¶æ€ï¼ˆkeyed stateï¼‰"></a>é”®æ§çŠ¶æ€ï¼ˆkeyed stateï¼‰</h3><p>é”®æ§çŠ¶æ€æ˜¯æ ¹æ®è¾“å…¥æ•°æ®æµä¸­<strong>å®šä¹‰çš„é”®ï¼ˆkeyï¼‰æ¥ç»´æŠ¤å’Œè®¿é—®çš„</strong>ã€‚<strong>Flinkä¸ºæ¯ä¸ªé”®å€¼ç»´æŠ¤ä¸€ä¸ªçŠ¶æ€å®ä¾‹ï¼Œå¹¶å°†å…·æœ‰ç›¸åŒé”®çš„æ‰€æœ‰æ•°æ®ï¼Œéƒ½åˆ†åŒºåˆ°åŒä¸€ä¸ªç®—å­ä»»åŠ¡ä¸­ï¼Œè¿™ä¸ªä»»åŠ¡ä¼šç»´æŠ¤å’Œå¤„ç†è¿™ä¸ªkeyå¯¹åº”çš„çŠ¶æ€ã€‚</strong>å½“ä»»åŠ¡å¤„ç†ä¸€æ¡æ•°æ®æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨å°†çŠ¶æ€çš„è®¿é—®èŒƒå›´é™å®šä¸ºå½“å‰æ•°æ®çš„keyã€‚<strong>å› æ­¤ï¼Œå…·æœ‰ç›¸åŒkeyçš„æ‰€æœ‰æ•°æ®éƒ½ä¼šè®¿é—®ç›¸åŒçš„çŠ¶æ€</strong>ã€‚Keyed Stateå¾ˆç±»ä¼¼äºä¸€ä¸ªåˆ†å¸ƒå¼çš„key-value mapæ•°æ®ç»“æ„ï¼Œ<font color="red"><strong>åªèƒ½ç”¨äºKeyedStreamï¼ˆkeyByç®—å­å¤„ç†ä¹‹åï¼‰ã€‚</strong></font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210103161339404.png" alt="image-20210103161339404"></p><h4 id="çŠ¶æ€æ•°æ®ç»“æ„-1"><a href="#çŠ¶æ€æ•°æ®ç»“æ„-1" class="headerlink" title="çŠ¶æ€æ•°æ®ç»“æ„"></a>çŠ¶æ€æ•°æ®ç»“æ„</h4><p>Flinkçš„Keyed Stateæ”¯æŒä»¥ä¸‹æ•°æ®ç±»å‹ï¼š</p><ol><li>ValueState[T]ä¿å­˜å•ä¸ªçš„å€¼ï¼Œå€¼çš„ç±»å‹ä¸ºTã€‚</li><li>ListState[T]ä¿å­˜ä¸€ä¸ªåˆ—è¡¨ï¼Œåˆ—è¡¨é‡Œçš„å…ƒç´ çš„æ•°æ®ç±»å‹ä¸ºTã€‚åŸºæœ¬æ“ä½œå¦‚ä¸‹ï¼š</li><li> MapState[K, V]ä¿å­˜Key-Valueå¯¹ã€‚</li><li>ReducingState[T]</li><li>AggregatingState[I, O]</li></ol><h4 id="å¦‚ä½•ä½¿ç”¨-1"><a href="#å¦‚ä½•ä½¿ç”¨-1" class="headerlink" title="å¦‚ä½•ä½¿ç”¨"></a>å¦‚ä½•ä½¿ç”¨</h4><p>å…¶å®åœ¨Flinkæ—¶é—´è¯­ä¹‰ä¸€æ–‡ä¸­å·²ç»ä½¿ç”¨äº†é”®æ§çŠ¶æ€ï¼Œå³1Så†…æ¸©åº¦è¿ç»­ä¸Šå‡æŠ¥è­¦ç¤ºä¾‹ã€‚</p><p>åœ¨ä»£ç ä¸­è¿™æ ·ä½¿ç”¨ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210103163621295.png" alt="image-20210103163621295"></p><p>å¤§å®¶å¯èƒ½æ³¨æ„åˆ°ï¼š</p><ol><li><code>getRuntimeContext</code>æ–¹æ³•ï¼Œå³å¦‚æœä½¿ç”¨é”®æ§çŠ¶æ€çš„è¯ï¼Œ<strong>å¿…é¡»ç»§æ‰¿å¯Œå‡½æ•°</strong></li><li>é”®æ§çŠ¶æ€çš„å£°æ˜å’Œèµ‹å€¼ä¸æ˜¯åœ¨ä¸€èµ·çš„ï¼Œè¿™æ˜¯å› ä¸ºå¦‚æœå£°æ˜å’Œèµ‹å€¼åœ¨ä¸€èµ·ï¼Œé‚£ä¹ˆå˜é‡åˆå§‹åŒ–æ—¶å°±è¦è°ƒç”¨<code>getRuntimeContext</code>ï¼Œä½†æ˜¯åœ¨æ²¡æœ‰è¿è¡Œåˆ°è¿™é‡Œæ—¶ï¼Œ<code>getRuntimeContext</code>æ˜¯æ²¡æœ‰å€¼çš„ï¼Œæ‰€ä»¥è¿™æ—¶æœ‰ä¸¤ç§è§£å†³åŠæ³•ï¼š<ol><li>ä½¿ç”¨scalaçš„lazyæ‡’åŠ è½½</li><li>èµ‹å€¼å†…å®¹å†™åœ¨open()æ–¹æ³•ä¸­</li></ol></li></ol><p>ç»§ä¸Šé¢çš„ä¾‹å­ï¼Œé€šè¿‡é”®æ§çŠ¶æ€å®ç°ï¼Œ<strong>è¿™æ—¶è®¡ç®—çš„æ˜¯æ¯ä¸ªkeyçš„æ•°é‡</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.flink.transform</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.<span class="type">RichMapFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.&#123;<span class="type">ValueState</span>, <span class="type">ValueStateDescriptor</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.scala.typeutils.<span class="type">Types</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.example.flink.source.&#123;<span class="type">SensorReading</span>, <span class="type">SensorSource</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">KeyedState</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> value: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = env.addSource(<span class="keyword">new</span> <span class="type">SensorSource</span>).keyBy(_.id)</span><br><span class="line">    value.map(<span class="keyword">new</span> <span class="type">MyMap</span>).print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MyMap</span> <span class="keyword">extends</span> <span class="title">RichMapFunction</span>[<span class="type">SensorReading</span>, <span class="type">Integer</span>] </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">lazy</span> <span class="keyword">private</span> <span class="keyword">val</span> count: <span class="type">ValueState</span>[<span class="type">Integer</span>] = getRuntimeContext.getState(<span class="keyword">new</span> <span class="type">ValueStateDescriptor</span>[<span class="type">Integer</span>](<span class="string">&quot;count&quot;</span>, <span class="type">Types</span>.of[<span class="type">Integer</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">map</span></span>(t: <span class="type">SensorReading</span>): <span class="type">Integer</span> = &#123;</span><br><span class="line">      <span class="keyword">if</span> (count.value()==<span class="literal">null</span>) count.update(<span class="number">0</span>)</span><br><span class="line">      <span class="keyword">val</span> integer: <span class="type">Integer</span> = count.value() + <span class="number">1</span></span><br><span class="line">      count.update(integer)</span><br><span class="line">      integer</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="çŠ¶æ€åç«¯"><a href="#çŠ¶æ€åç«¯" class="headerlink" title="çŠ¶æ€åç«¯"></a>çŠ¶æ€åç«¯</h2><p>çŠ¶æ€çš„å­˜å‚¨ã€è®¿é—®ä»¥åŠç»´æŠ¤ï¼Œç”±ä¸€ä¸ªå¯æ’å…¥çš„ç»„ä»¶å†³å®šï¼Œè¿™ä¸ªç»„ä»¶å°± å«åšçŠ¶æ€åç«¯ï¼ˆstate backendï¼‰</p><p>çŠ¶æ€åç«¯ä¸»è¦è´Ÿè´£ä¸¤ä»¶äº‹ï¼šæœ¬åœ°çš„çŠ¶æ€ç®¡ç†ï¼Œä»¥åŠå°†æ£€æŸ¥ç‚¹ ï¼ˆcheckpointï¼‰çŠ¶æ€å†™å…¥è¿œç¨‹å­˜å‚¨</p><p>ç”±äºæœ‰æ•ˆçš„çŠ¶æ€è®¿é—®å¯¹äºå¤„ç†æ•°æ®çš„ä½å»¶è¿Ÿè‡³å…³é‡è¦ï¼Œ<strong>å› æ­¤æ¯ä¸ªå¹¶è¡Œ ä»»åŠ¡éƒ½ä¼šåœ¨æœ¬åœ°ç»´æŠ¤å…¶çŠ¶æ€</strong>ï¼Œä»¥ç¡®ä¿å¿«é€Ÿçš„çŠ¶æ€è®¿é—®</p><h3 id="é€‰æ‹©ä¸€ä¸ªçŠ¶æ€åç«¯"><a href="#é€‰æ‹©ä¸€ä¸ªçŠ¶æ€åç«¯" class="headerlink" title="é€‰æ‹©ä¸€ä¸ªçŠ¶æ€åç«¯"></a><strong>é€‰æ‹©ä¸€ä¸ªçŠ¶æ€åç«¯</strong></h3><h4 id="MemoryStateBackend"><a href="#MemoryStateBackend" class="headerlink" title="MemoryStateBackend"></a><em>MemoryStateBackend</em></h4><p>å†…å­˜çº§çš„çŠ¶æ€åç«¯ï¼Œä¼šå°†é”®æ§çŠ¶æ€ä½œä¸ºå†…å­˜ä¸­çš„å¯¹è±¡è¿›è¡Œç®¡ç†ï¼Œå°†å®ƒä»¬å­˜å‚¨åœ¨ TaskManager çš„ å†…å­˜ä¸Šï¼Œè€Œå°† checkpoint å­˜å‚¨åœ¨ JobManager çš„å†…å­˜ ä¸­ </p><p>ç‰¹ç‚¹ï¼šå¿«é€Ÿã€ä½å»¶è¿Ÿï¼Œä½†ä¸ç¨³å®š</p><h4 id="FsStateBackend"><a href="#FsStateBackend" class="headerlink" title="FsStateBackend"></a><em>FsStateBackend</em></h4><p>å°† checkpoint å­˜åˆ°è¿œç¨‹çš„æŒä¹…åŒ–æ–‡ä»¶ç³»ç»Ÿï¼ˆFileSystemï¼‰ä¸Šï¼Œè€Œå¯¹äºæœ¬åœ°çŠ¶ æ€ï¼Œè·Ÿ MemoryStateBackend ä¸€æ ·ï¼Œä¹Ÿä¼šå­˜åœ¨ TaskManager çš„å†…å­˜ä¸Š</p><p> åŒæ—¶æ‹¥æœ‰å†…å­˜çº§çš„æœ¬åœ°è®¿é—®é€Ÿåº¦ï¼Œå’Œæ›´å¥½çš„å®¹é”™ä¿è¯</p><h4 id="RocksDBStateBackend"><a href="#RocksDBStateBackend" class="headerlink" title="RocksDBStateBackend"></a><em>RocksDBStateBackend</em></h4><p>å°†æ‰€æœ‰çŠ¶æ€åºåˆ—åŒ–åï¼Œå­˜å…¥æœ¬åœ°çš„ RocksDB ä¸­å­˜å‚¨</p><p>TaskManagerçš„çŠ¶æ€åªæ˜¯è¿›è¡Œç¼“å­˜ï¼Œå¹¶ä¸çœŸæ­£çš„å­˜åœ¨äºå†…å­˜</p><h3 id="å¦‚ä½•ä½¿ç”¨-2"><a href="#å¦‚ä½•ä½¿ç”¨-2" class="headerlink" title="å¦‚ä½•ä½¿ç”¨"></a>å¦‚ä½•ä½¿ç”¨</h3><p><code>env.setStateBackend(new FsStateBackend(&quot;&quot;))</code></p><p>Flinkå®˜æ–¹å¯ä»¥æ”¯æŒ<em>FsStateBackend</em>ã€<em>MemoryStateBackend</em>ï¼Œç¬¬ä¸‰ä¸ªä¹Ÿæ”¯æŒï¼Œä¸è¿‡éœ€è¦å¯¼åŒ…</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-statebackend-rocksdb_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="çŠ¶æ€ä¸€è‡´æ€§"><a href="#çŠ¶æ€ä¸€è‡´æ€§" class="headerlink" title="çŠ¶æ€ä¸€è‡´æ€§"></a>çŠ¶æ€ä¸€è‡´æ€§</h2><p>å½“åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¼•å…¥çŠ¶æ€æ—¶ï¼Œè‡ªç„¶ä¹Ÿå¼•å…¥äº†ä¸€è‡´æ€§é—®é¢˜ã€‚åªå¬çŠ¶æ€ä¸€è‡´æ€§æœ‰ç‚¹éš¾å¬æ‡‚ï¼Œå®ƒæœ¬è´¨å°±æ˜¯<font color="red"><strong>æˆåŠŸå¤„ç†æ•…éšœå¹¶æ¢å¤å‰åçš„ç»“æœçš„æ­£ç¡®æ€§çº§åˆ«</strong></font>ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´åœ¨æˆåŠŸå¤„ç†æ•…éšœå¹¶æ¢å¤ä¹‹åå¾—åˆ°çš„ç»“æœï¼Œä¸æ²¡æœ‰å‘ç”Ÿä»»ä½•æ•…éšœæ—¶å¾—åˆ°çš„ç»“æœç›¸æ¯”ï¼Œå‰è€…åˆ°åº•æœ‰å¤šæ­£ç¡®ï¼Ÿä¸¾ä¾‹æ¥è¯´ï¼Œå‡è®¾è¦å¯¹æœ€è¿‘ä¸€å°æ—¶ç™»å½•çš„ç”¨æˆ·è®¡æ•°ã€‚åœ¨ç³»ç»Ÿç»å†æ•…éšœä¹‹åï¼Œè®¡æ•°ç»“æœæ˜¯å¤šå°‘ï¼Ÿå¦‚æœæœ‰åå·®ï¼Œæ˜¯æœ‰æ¼æ‰çš„è®¡æ•°ï¼ˆæœ€å¤šä¸€æ¬¡ï¼‰è¿˜æ˜¯é‡å¤è®¡æ•°ï¼ˆæœ€å°‘ä¸€æ¬¡ï¼‰ï¼Ÿ</p><h3 id="ä¸€è‡´æ€§çº§åˆ«"><a href="#ä¸€è‡´æ€§çº§åˆ«" class="headerlink" title="ä¸€è‡´æ€§çº§åˆ«"></a>ä¸€è‡´æ€§çº§åˆ«</h3><p>åœ¨æµå¤„ç†ä¸­ï¼Œä¸€è‡´æ€§å¯ä»¥åˆ†ä¸º3ä¸ªçº§åˆ«ï¼š</p><ol><li><code>at-most-once</code>: è¿™å…¶å®æ˜¯æ²¡æœ‰æ­£ç¡®æ€§ä¿éšœçš„å§”å©‰è¯´æ³•â€”â€”æ•…éšœå‘ç”Ÿä¹‹åï¼Œè®¡æ•°ç»“æœå¯èƒ½ä¸¢å¤±ã€‚åŒæ ·çš„è¿˜æœ‰udpã€‚</li><li><code>at-least-once</code>: è¿™è¡¨ç¤ºè®¡æ•°ç»“æœå¯èƒ½å¤§äºæ­£ç¡®å€¼ï¼Œä½†ç»ä¸ä¼šå°äºæ­£ç¡®å€¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè®¡æ•°ç¨‹åºåœ¨å‘ç”Ÿæ•…éšœåå¯èƒ½å¤šç®—ï¼Œä½†æ˜¯ç»ä¸ä¼šå°‘ç®—ã€‚</li><li><code>exactly-once</code>: è¿™æŒ‡çš„æ˜¯ç³»ç»Ÿä¿è¯åœ¨å‘ç”Ÿæ•…éšœåå¾—åˆ°çš„è®¡æ•°ç»“æœä¸æ­£ç¡®å€¼ä¸€è‡´ã€‚</li></ol><p>Flinkçš„ä¸€ä¸ªé‡å¤§ä»·å€¼åœ¨äºï¼Œ<strong>å®ƒæ—¢ä¿è¯äº†exactly-onceï¼Œä¹Ÿå…·æœ‰ä½å»¶è¿Ÿå’Œé«˜ååçš„å¤„ç†èƒ½åŠ›ã€‚</strong></p><h3 id="ç«¯åˆ°ç«¯çš„ä¸€è‡´æ€§ğŸ”º"><a href="#ç«¯åˆ°ç«¯çš„ä¸€è‡´æ€§ğŸ”º" class="headerlink" title="ç«¯åˆ°ç«¯çš„ä¸€è‡´æ€§ğŸ”º"></a>ç«¯åˆ°ç«¯çš„ä¸€è‡´æ€§ğŸ”º</h3><p>ç›®å‰æˆ‘ä»¬çœ‹åˆ°çš„ä¸€è‡´æ€§ä¿è¯éƒ½æ˜¯ç”±æµå¤„ç†å™¨å®ç°çš„ï¼Œ<strong>ä¹Ÿå°±æ˜¯è¯´éƒ½æ˜¯åœ¨ Flink æµå¤„ç†å™¨å†…éƒ¨ä¿è¯çš„</strong>ï¼›è€Œåœ¨çœŸå®åº”ç”¨ä¸­ï¼Œæµå¤„ç†åº”ç”¨é™¤äº†æµå¤„ç†å™¨ä»¥å¤–è¿˜åŒ…å«äº†æ•°æ®æºï¼ˆä¾‹å¦‚ Kafkaï¼‰å’Œè¾“å‡ºåˆ°æŒä¹…åŒ–ç³»ç»Ÿã€‚</p><p>å³ç«¯åˆ°ç«¯ä¸€è‡´æ€§æŒ‡çš„æ˜¯ä»Source-Flinkå†…éƒ¨ç¨‹åº-SinkæŒä¹…åŒ–ç³»ç»Ÿï¼ŒçŠ¶æ€çš„ä¸€è‡´æ€§å³ç»“æœçš„æ­£ç¡®æ€§è´¯ç©¿äº†æ•´ä¸ªæµå¤„ç†åº”ç”¨çš„å§‹ç»ˆã€‚</p><p>æ¯ä¸€ä¸ªç»„ä»¶éƒ½ä¿è¯äº†å®ƒè‡ªå·±çš„ä¸€è‡´æ€§ï¼Œ<font color="red">æ•´ä¸ªç«¯åˆ°ç«¯çš„ä¸€è‡´æ€§çº§åˆ«å–å†³äºæ‰€æœ‰ç»„ä»¶ä¸­ä¸€è‡´æ€§æœ€å¼±çš„ç»„ä»¶</font>ã€‚å…·ä½“å¯ä»¥åˆ’åˆ†å¦‚ä¸‹ï¼š</p><ul><li>å†…éƒ¨ä¿è¯ â€”â€” <strong>ä¾èµ–checkpoint</strong></li><li>source ç«¯ â€”â€” éœ€è¦å¤–éƒ¨æº<strong>å¯é‡è®¾æ•°æ®çš„è¯»å–ä½ç½®</strong></li><li>sink ç«¯ â€”â€” éœ€è¦ä¿è¯ä»æ•…éšœæ¢å¤æ—¶ï¼Œ<strong>æ•°æ®ä¸ä¼šé‡å¤å†™å…¥å¤–éƒ¨ç³»ç»Ÿ</strong></li></ul><p>è€Œå¯¹äºsinkç«¯ï¼Œåˆæœ‰ä¸¤ç§å…·ä½“çš„å®ç°æ–¹å¼ï¼š</p><ol><li>å¹‚ç­‰ï¼ˆIdempotentï¼‰å†™å…¥ã€‚</li><li>äº‹åŠ¡æ€§ï¼ˆTransactionalï¼‰å†™å…¥ã€‚</li></ol><h4 id="å¹‚ç­‰å†™å…¥"><a href="#å¹‚ç­‰å†™å…¥" class="headerlink" title="å¹‚ç­‰å†™å…¥"></a>å¹‚ç­‰å†™å…¥</h4><p>æ‰€è°“å¹‚ç­‰æ“ä½œï¼Œæ˜¯è¯´ä¸€ä¸ªæ“ä½œï¼Œå¯ä»¥é‡å¤æ‰§è¡Œå¾ˆå¤šæ¬¡ï¼Œä½†åªå¯¼è‡´ä¸€æ¬¡ç»“æœæ›´æ”¹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåé¢å†é‡å¤æ‰§è¡Œå°±ä¸èµ·ä½œç”¨äº†ã€‚</p><p>ä½†æ˜¯å®ƒçš„ç»“æœä¼šæœ‰ä¸€ä¸ªæ¸å˜çš„æµç¨‹ï¼Œä¾‹å¦‚æ±‚æœ€å¤§æ¸©åº¦ï¼š</p><p>1-&gt;2-&gt;10ï¼Œæ­¤æ—¶æ•…éšœä»ä¸Šä¸€æ£€æŸ¥ç‚¹å¤„é‡æ–°è®¡ç®—ï¼Œ2-&gt;10-&gt;12ã€‚æœ€ç»ˆçš„SInkæ•°æ®æµä¸º1-&gt;2-&gt;10-&gt;2-&gt;10-&gt;12ã€‚è™½ç„¶æœ€ç»ˆç»“æœæ— è¯¯ï¼Œä½†æ˜¯æµç¨‹çœ‹èµ·æ¥ä¸å¥½ï¼Œå¦‚æœè¿™äº›æ•°æ®è¦å®æ—¶å±•ç¤ºï¼Œåˆ™ä¼šç»™äººè¯¯è§£ã€‚</p><h4 id="äº‹åŠ¡æ€§å†™å…¥ğŸ”º"><a href="#äº‹åŠ¡æ€§å†™å…¥ğŸ”º" class="headerlink" title="äº‹åŠ¡æ€§å†™å…¥ğŸ”º"></a>äº‹åŠ¡æ€§å†™å…¥ğŸ”º</h4><p>éœ€è¦æ„å»ºäº‹åŠ¡æ¥å†™å…¥å¤–éƒ¨ç³»ç»Ÿï¼Œæ„å»ºçš„äº‹åŠ¡å¯¹åº”ç€ checkpointï¼Œç­‰åˆ° checkpoint çœŸæ­£å®Œæˆçš„æ—¶å€™ï¼Œæ‰æŠŠæ‰€æœ‰å¯¹åº”çš„ç»“æœå†™å…¥ sink ç³»ç»Ÿä¸­ã€‚</p><p>å¯¹äºäº‹åŠ¡æ€§å†™å…¥ï¼Œå…·ä½“åˆæœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼šé¢„å†™æ—¥å¿—ï¼ˆWALï¼‰å’Œä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰ã€‚DataStream API æä¾›äº†<code>GenericWriteAheadSink</code>æ¨¡æ¿ç±»å’Œ<code>TwoPhaseCommitSinkFunction </code>æ¥å£ï¼Œå¯ä»¥æ–¹ä¾¿åœ°å®ç°è¿™ä¸¤ç§æ–¹å¼çš„äº‹åŠ¡æ€§å†™å…¥ã€‚</p><blockquote><p>é¢„å†™æ—¥å¿—ï¼ˆWALï¼‰å¹¶ä¸æ˜¯çœŸæ­£çš„<code>exactly-once</code>ï¼Œå½“æ‰¹é‡å†™å…¥Sinkæ—¶ï¼Œå¦‚æœä¸­é€”å‡ºé”™ï¼Œä»checkpointå›æ”¾æ•°æ®ï¼Œåˆ™ä¼šå¯¼è‡´æ•°æ®é‡å¤æ’å…¥</p><p>ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰æ‰æ˜¯çœŸæ­£çš„<code>exactly-once</code>ï¼Œä½†æ˜¯å®ƒéœ€è¦å†™å…¥çš„ç³»ç»Ÿæ”¯æŒäº‹åŠ¡ï¼Œå¹¶ä¸”äº‹åŠ¡çš„è¶…æ—¶æ—¶é—´æœ€å¥½å’Œcheckpointçš„è¶…æ—¶æ—¶é—´ä¸€è‡´ã€‚</p><p>[ä¸¤é˜¶æ®µæäº¤ä¿è¯ExactlyOnce](#Exactly-once ä¸¤é˜¶æ®µæäº¤)</p></blockquote><p><strong>ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰</strong></p><ul><li>å¯¹äºæ¯ä¸ª checkpointï¼Œsink ä»»åŠ¡ä¼šå¯åŠ¨ä¸€ä¸ªäº‹åŠ¡ï¼Œå¹¶å°†æ¥ä¸‹æ¥æ‰€æœ‰ æ¥æ”¶çš„æ•°æ®æ·»åŠ åˆ°äº‹åŠ¡é‡Œ</li><li>ç„¶åå°†è¿™äº›æ•°æ®å†™å…¥å¤–éƒ¨ sink ç³»ç»Ÿï¼Œä½†ä¸æäº¤å®ƒä»¬ â€”â€” è¿™æ—¶åªæ˜¯ â€œé¢„æäº¤â€</li><li>å½“å®ƒæ”¶åˆ° checkpoint å®Œæˆçš„é€šçŸ¥æ—¶ï¼Œå®ƒæ‰æ­£å¼æäº¤äº‹åŠ¡ï¼Œå®ç°ç»“æœ çš„çœŸæ­£å†™å…¥</li><li>è¿™ç§æ–¹å¼çœŸæ­£å®ç°äº† exactly-onceï¼Œå®ƒéœ€è¦ä¸€ä¸ªæä¾›äº‹åŠ¡æ”¯æŒçš„å¤–éƒ¨ sink ç³»ç»Ÿã€‚Flink æä¾›äº† TwoPhaseCommitSinkFunction æ¥å£</li></ul><h3 id="ä¸åŒ-Source-å’Œ-Sink-çš„ä¸€è‡´æ€§ä¿è¯"><a href="#ä¸åŒ-Source-å’Œ-Sink-çš„ä¸€è‡´æ€§ä¿è¯" class="headerlink" title="ä¸åŒ Source å’Œ Sink çš„ä¸€è‡´æ€§ä¿è¯"></a>ä¸åŒ Source å’Œ Sink çš„ä¸€è‡´æ€§ä¿è¯</h3><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210104211430912.png" alt="image-20210104211430912"></p><h3 id="Flink-Kafka-ç«¯åˆ°ç«¯çŠ¶æ€ä¸€è‡´æ€§çš„ä¿è¯"><a href="#Flink-Kafka-ç«¯åˆ°ç«¯çŠ¶æ€ä¸€è‡´æ€§çš„ä¿è¯" class="headerlink" title="Flink+Kafka ç«¯åˆ°ç«¯çŠ¶æ€ä¸€è‡´æ€§çš„ä¿è¯"></a>Flink+Kafka ç«¯åˆ°ç«¯çŠ¶æ€ä¸€è‡´æ€§çš„ä¿è¯</h3><ul><li>å†…éƒ¨ â€”â€” åˆ©ç”¨ checkpoint æœºåˆ¶ï¼ŒæŠŠçŠ¶æ€å­˜ç›˜ï¼Œå‘ç”Ÿæ•…éšœçš„æ—¶å€™ä»¥æ¢ å¤ï¼Œä¿è¯å†…éƒ¨çš„çŠ¶æ€ä¸€è‡´æ€§</li><li>source â€”â€” kafka consumer ä½œä¸º sourceï¼Œå¯ä»¥å°†åç§»é‡ä¿å­˜ä¸‹æ¥ï¼Œ å¦‚æœåç»­ä»»åŠ¡å‡ºç°äº†æ•…éšœï¼Œæ¢å¤çš„æ—¶å€™å¯ä»¥ç”±è¿æ¥å™¨é‡ç½®åç§»é‡ï¼Œé‡æ–° æ¶ˆè´¹æ•°æ®ï¼Œä¿è¯ä¸€è‡´æ€§</li><li>sink â€”â€” kafka producer ä½œä¸ºsinkï¼Œé‡‡ç”¨ä¸¤é˜¶æ®µæäº¤ sinkï¼Œéœ€è¦å®ç° ä¸€ä¸ª TwoPhaseCommitSinkFunction</li></ul><h1 id="å®¹é”™æœºåˆ¶"><a href="#å®¹é”™æœºåˆ¶" class="headerlink" title="å®¹é”™æœºåˆ¶"></a>å®¹é”™æœºåˆ¶</h1><p>Flinkå…·ä½“å¦‚ä½•ä¿è¯exactly-onceå‘¢? å®ƒä½¿ç”¨ä¸€ç§è¢«ç§°ä¸ºâ€æ£€æŸ¥ç‚¹â€ï¼ˆcheckpointï¼‰çš„ç‰¹æ€§ï¼Œåœ¨å‡ºç°æ•…éšœæ—¶å°†ç³»ç»Ÿé‡ç½®å›æ­£ç¡®çŠ¶æ€ã€‚</p><p>è¯´åˆ°å®¹é”™æœºåˆ¶ï¼Œå°±æ˜¯Flinkåº”ç”¨ç¨‹åºåœ¨é‡åˆ°é—®é¢˜æ—¶çš„è®¡ç®—ç»“æœæ˜¯å¦è¿˜æ­£ç¡®çš„é—®é¢˜ã€‚</p><p><strong>Flinkå®¹é”™æœºåˆ¶çš„æ ¸å¿ƒå°±æ˜¯åº”ç”¨çŠ¶æ€çš„ä¸€è‡´æ€§æ£€æŸ¥ç‚¹</strong>ï¼Œå®ƒæ˜¯é€šè¿‡åº”ç”¨çŠ¶æ€çš„ä¸€è‡´æ€§æ£€æŸ¥ç‚¹æ¥å®ç°æ•…éšœæ¢å¤çš„ï¼</p><p>æœ‰çŠ¶æ€æµåº”ç”¨çš„ä¸€è‡´æ£€æŸ¥ç‚¹ï¼Œå…¶å®å°±æ˜¯æ‰€æœ‰ä»»åŠ¡çš„çŠ¶æ€ï¼Œåœ¨æŸä¸ªæ—¶é—´ç‚¹çš„ä¸€ä»½ æ‹·è´ï¼ˆä¸€ä»½å¿«ç…§ï¼‰ï¼›<font color="red"><strong>è¿™ä¸ªæ—¶é—´ç‚¹ï¼Œåº”è¯¥æ˜¯æ‰€æœ‰ä»»åŠ¡éƒ½æ°å¥½å¤„ç†å®Œä¸€ä¸ªç›¸åŒçš„è¾“ å…¥æ•°æ®çš„æ—¶å€™</strong>ï¼Œè€Œä¸æ˜¯åŒä¸€æ—¶åˆ»åŒæ—¶å­˜å‚¨å„ä¸ªç®—å­çš„çŠ¶æ€</font>ã€‚</p><blockquote><p>å¦‚æœä¸æ˜¯è¿™æ ·å¿…ç„¶ä¼šå¯¼è‡´æ•…éšœæ—¶æœ‰çš„ç®—å­è®¡ç®—äº†æ•°æ®næœ‰çš„æ²¡æœ‰è®¡ç®—ï¼Œé‚£ä¹ˆæ•…éšœæ¢å¤æ—¶æ•°æ®nè¿˜è¦è¢«é‡æ”¾å—ï¼Œè¡¥å……æ”¾ä¹‹å‰æ²¡æœ‰è®¡ç®—çš„ç®—å­ä¸¢å¤±äº†æ­¤æ•°æ®ï¼Œé‡æ”¾çš„è¯ä¹‹å‰è®¡ç®—äº†æ­¤æ•°æ®çš„ç®—å­é‡å¤è®¡ç®—äº†æ­¤æ•°æ®ã€‚</p></blockquote><h2 id="ä»æ£€æŸ¥ç‚¹æ¢å¤çŠ¶æ€"><a href="#ä»æ£€æŸ¥ç‚¹æ¢å¤çŠ¶æ€" class="headerlink" title="ä»æ£€æŸ¥ç‚¹æ¢å¤çŠ¶æ€"></a>ä»æ£€æŸ¥ç‚¹æ¢å¤çŠ¶æ€</h2><p>åœ¨æ‰§è¡Œæµåº”ç”¨ç¨‹åºæœŸé—´ï¼ŒFlink ä¼šå®šæœŸä¿å­˜çŠ¶æ€çš„ä¸€è‡´æ£€æŸ¥ç‚¹</p><p>å¦‚æœå‘ç”Ÿæ•…éšœï¼Œ Flink å°†ä¼šä½¿ç”¨æœ€è¿‘çš„æ£€æŸ¥ç‚¹æ¥ä¸€è‡´æ¢å¤åº”ç”¨ç¨‹åºçš„çŠ¶æ€ï¼Œå¹¶ é‡æ–°å¯åŠ¨å¤„ç†æµç¨‹ï¼š</p><blockquote><p>é‡åˆ°æ•…éšœä¹‹åï¼Œç¬¬ä¸€æ­¥å°±æ˜¯é‡å¯åº”ç”¨</p></blockquote><blockquote><p>ç¬¬äºŒæ­¥æ˜¯ä» checkpoint ä¸­è¯»å–çŠ¶æ€ï¼Œå°†çŠ¶æ€é‡ç½®</p><p>ä»æ£€æŸ¥ç‚¹é‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åºåï¼Œå…¶å†…éƒ¨çŠ¶æ€ä¸æ£€æŸ¥ç‚¹å®Œæˆæ—¶çš„çŠ¶æ€å®Œå…¨ç›¸åŒ</p></blockquote><blockquote><p>ç¬¬ä¸‰æ­¥ï¼šå¼€å§‹æ¶ˆè´¹å¹¶å¤„ç†æ£€æŸ¥ç‚¹åˆ°å‘ç”Ÿæ•…éšœä¹‹é—´çš„æ‰€æœ‰æ•°æ®</p><p>è¿™ç§æ£€æŸ¥ç‚¹çš„ä¿å­˜å’Œæ¢å¤æœºåˆ¶å¯ä»¥ä¸ºåº”ç”¨ç¨‹åºçŠ¶æ€æä¾›<strong>â€œç²¾ç¡®ä¸€æ¬¡â€ ï¼ˆexactly-onceï¼‰çš„ä¸€è‡´æ€§</strong>ï¼Œå› ä¸ºæ‰€æœ‰ç®—å­éƒ½ä¼šä¿å­˜æ£€æŸ¥ç‚¹å¹¶æ¢å¤å…¶æ‰€æœ‰çŠ¶ æ€ï¼Œè¿™æ ·ä¸€æ¥æ‰€æœ‰çš„è¾“å…¥æµå°±éƒ½ä¼šè¢«é‡ç½®åˆ°æ£€æŸ¥ç‚¹å®Œæˆæ—¶çš„ä½ç½®ï¼ˆä½†æ˜¯éœ€è¦Sourceçš„ç»„ä»¶æ”¯æŒæ•°æ®å›æ”¾ï¼Œå¦‚æœæ˜¯sockæµçš„è¯å°±GGäº†ï¼‰</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210104212513441.png" alt="image-20210104212513441"></p><h2 id="æ£€æŸ¥ç‚¹çš„å®ç°ç®—æ³•ğŸ”º"><a href="#æ£€æŸ¥ç‚¹çš„å®ç°ç®—æ³•ğŸ”º" class="headerlink" title="æ£€æŸ¥ç‚¹çš„å®ç°ç®—æ³•ğŸ”º"></a>æ£€æŸ¥ç‚¹çš„å®ç°ç®—æ³•ğŸ”º</h2><p>æ£€æŸ¥ç‚¹çš„å®ç°ç®—æ³•æœ‰ï¼š</p><ol><li>æš‚åœåº”ç”¨ï¼Œä¿å­˜çŠ¶æ€åˆ°æ£€æŸ¥ç‚¹ï¼Œå†é‡æ–°æ¢å¤åº”ç”¨ï¼ˆFlinkä¸æ˜¯è¿™ä¸€ç§ï¼‰</li><li>å¼‚æ­¥ï¼ŒåŸºäº Chandy-Lamport ç®—æ³•çš„åˆ†å¸ƒå¼å¿«ç…§ï¼Œå°†æ£€æŸ¥ç‚¹çš„ä¿å­˜å’Œæ•°æ®å¤„ç†åˆ†ç¦»å¼€ï¼Œä¸æš‚åœæ•´ä¸ªåº”ç”¨ï¼ˆFlinkï¼‰</li></ol><blockquote><p>å³æ¯ä¸ªç®—å­éƒ½å•ç‹¬çš„å»ä¿å­˜çŠ¶æ€åˆ°çŠ¶æ€åç«¯ï¼Œåœ¨ç®—å­åœ¨è·å–åˆ°æ£€æŸ¥ç‚¹å±éšœæ—¶ï¼Œç›´æ¥å°†çŠ¶æ€æ›´æ–°åˆ°çŠ¶æ€åç«¯ï¼Œç„¶åç»§ç»­è®¡ç®—åé¢çš„æ•°æ®ï¼Œè€Œæ£€æŸ¥ç‚¹å±éšœä¹Ÿå‘é€ç»™åé¢çš„ç®—å­ï¼Œåé¢çš„ç®—å­ä¹Ÿå’Œå‰é¢ç®—å­çš„å¤„ç†é€»è¾‘ä¸€æ ·ï¼Œæ‰€ä»¥åŒä¸€æ£€æŸ¥ç‚¹çš„å„ä¸ªç®—å­çš„çŠ¶æ€å¹¶ä¸æ˜¯åŒä¸€æ—¶åˆ»ä¿å­˜åˆ°çŠ¶æ€åç«¯çš„ã€‚</p></blockquote><p><strong>Flink æ£€æŸ¥ç‚¹ç®—æ³•</strong></p><p>æ£€æŸ¥ç‚¹åˆ†ç•Œçº¿ï¼ˆCheckpoint Barrierï¼‰</p><ul><li>Flink çš„æ£€æŸ¥ç‚¹ç®—æ³•ç”¨åˆ°äº†ä¸€ç§ç§°ä¸º<strong>åˆ†ç•Œçº¿ï¼ˆbarrierï¼‰</strong>çš„ç‰¹æ®Šæ•°æ®å½¢å¼ï¼ˆç±»ä¼¼äºWaterMarkï¼‰ï¼Œ ç”¨æ¥æŠŠä¸€æ¡æµä¸Š<strong>æ•°æ®æŒ‰ç…§ä¸åŒçš„æ£€æŸ¥ç‚¹åˆ†å¼€</strong></li><li><strong>åˆ†ç•Œçº¿ä¹‹å‰åˆ°æ¥çš„æ•°æ®å¯¼è‡´çš„çŠ¶æ€æ›´æ”¹ï¼Œéƒ½ä¼šè¢«åŒ…å«åœ¨å½“å‰åˆ†ç•Œçº¿æ‰€å± çš„æ£€æŸ¥ç‚¹ä¸­ï¼›è€ŒåŸºäºåˆ†ç•Œçº¿ä¹‹åçš„æ•°æ®å¯¼è‡´çš„æ‰€æœ‰æ›´æ”¹ï¼Œå°±ä¼šè¢«åŒ…å«åœ¨ ä¹‹åçš„æ£€æŸ¥ç‚¹ä¸­</strong></li></ul><h3 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h3><p>ç°åœ¨æ˜¯ä¸€ä¸ªæœ‰ä¸¤ä¸ªè¾“å…¥æµçš„åº”ç”¨ç¨‹åºï¼Œç”¨å¹¶è¡Œçš„ä¸¤ä¸ª Source ä»»åŠ¡æ¥è¯»å–</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210104213222043.png" alt="image-20210104213222043"></p><p>ç„¶åç”±JobManageråè°ƒå‘å‡ºç»™æ‰€æœ‰å¹¶è¡Œçš„Sourceä»»åŠ¡å‘é€ä¸€æ¡å¸¦æœ‰æ–°æ£€æŸ¥ç‚¹ ID çš„æ¶ˆæ¯ï¼Œé€šè¿‡è¿™ ç§æ–¹å¼æ¥å¯åŠ¨æ£€æŸ¥ç‚¹</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210104213323571.png" alt="image-20210104213323571"></p><p>æ•°æ®æºå°†å®ƒä»¬çš„çŠ¶æ€å†™å…¥æ£€æŸ¥ç‚¹ï¼Œå¹¶å‘å‡ºä¸€ä¸ªæ£€æŸ¥ç‚¹ barrierã€‚çŠ¶æ€åç«¯åœ¨çŠ¶æ€å­˜å…¥æ£€æŸ¥ç‚¹ä¹‹åï¼Œä¼šè¿”å›é€šçŸ¥ç»™ source ä»»åŠ¡ï¼Œsource ä»»åŠ¡å°±ä¼š å‘ JobManager ç¡®è®¤æ£€æŸ¥ç‚¹å®Œæˆã€‚</p><p>ä¾‹å¦‚ä¸‹å›¾ï¼ŒSource1ã€Source2åœ¨ç»è¿‡Barrieråï¼Œç›´æ¥å°†çŠ¶æ€å‘é€åˆ°çŠ¶æ€åç«¯ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210104213517551.png" alt="image-20210104213517551"></p><p>ä½†æ˜¯ï¼Œç”±äºå¹¶è¡Œåº¦ï¼ŒBarrierçš„ä¼ é€’ä¹Ÿæ˜¯å’ŒWaterMarkç±»ä¼¼çš„ï¼Œ<font color="red">éƒ½æ˜¯å¹¿æ’­çš„æ–¹å¼å‘é€ç»™ä¸‹æ¸¸æ‰€æœ‰ç®—å­</font>ã€‚<font color="red">ä¸‹æ¸¸ç®—å­æ¥æ”¶åˆ°ä¸Šæ¸¸æ‰€æœ‰çš„Barrierå</font>æ‰å¼€å§‹å°†å½“å‰çŠ¶æ€å‘é€ç»™StateBackendã€‚<strong>è¿™è¢«ç§°ä¸ºåˆ†ç•Œçº¿å¯¹é½</strong></p><p>æ—¢ç„¶ä¸‹æ¸¸ç®—å­æ¥æ”¶åˆ°ä¸Šæ¸¸çš„æ‰€æœ‰Barrieråæ‰å¼€å§‹ä¿å­˜çŠ¶æ€ï¼Œé‚£å°±å¿…ç„¶é¢ä¸´ç€Barrieråˆ°è¾¾å…ˆåçš„é—®é¢˜ï¼Œå¦‚ä¸‹å›¾<code>Sum Even</code>éœ€è¦æ¥æ”¶åˆ°è“2ä¸é»„2æ‰èƒ½ä¿å­˜çŠ¶æ€ã€‚</p><ol><li>ä½†æ˜¯å¦‚æœæ­¤æ—¶çš„åˆ°è¾¾é¡ºåºä¸ºè“2ï¼ŒSource1çš„æ•°æ®4ï¼Œé»„2ï¼›åˆ™Source1çš„æ•°æ®4ä¸ä¼šè¢«åŠ å…¥çŠ¶æ€è€Œæ˜¯è¢«ç¼“å­˜</li><li>ä½†æ˜¯å¦‚æœæ­¤æ—¶çš„åˆ°è¾¾é¡ºåºä¸ºè“2ï¼ŒSource2çš„æ•°æ®4ï¼Œé»„2ï¼›åˆ™Source2çš„æ•°æ®4ä¼šè¢«åŠ å…¥çŠ¶æ€</li></ol><blockquote><p>å¯¹äºbarrierå·²ç»åˆ°è¾¾çš„åˆ†åŒºï¼Œç»§ç»­åˆ°è¾¾çš„æ•°æ®ä¼šè¢«ç¼“å­˜</p><p>è€Œbarrierå°šæœªåˆ°è¾¾çš„åˆ†åŒºï¼Œæ•°æ®ä¼šè¢«æ­£å¸¸å¤„ç†</p><hr><p>å› ä¸ºå¯¹äºbarrierå·²ç»åˆ°è¾¾çš„åˆ†åŒºï¼Œå¦‚æœç»§ç»­è®¡ç®—åŠ å…¥çŠ¶æ€çš„è¯ï¼Œå½“æ£€æŸ¥ç‚¹æ•…éšœæ¢å¤æ—¶ç»§ç»­åŠ å…¥çš„æ•°æ®ä¼šè¢«é‡æ”¾ï¼Œå†æ¬¡åŠ å…¥çŠ¶æ€ï¼Œå°±å¯¼è‡´äº†è¿™ä¸ªæ•°æ®è¢«è®¡ç®—äº†2æ¬¡ï¼Œå°±ä¸æ˜¯exactly onceäº†</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210104214139282.png" alt="image-20210104214139282"></p><p>å½“æ”¶åˆ°æ‰€æœ‰è¾“å…¥åˆ†åŒºçš„ barrier æ—¶ï¼Œä»»åŠ¡å°±å°†å…¶çŠ¶æ€ä¿å­˜åˆ°çŠ¶æ€åç«¯çš„æ£€æŸ¥ç‚¹ä¸­ï¼Œ ç„¶åå°† barrier ç»§ç»­å‘ä¸‹æ¸¸è½¬å‘ã€‚å‘ä¸‹æ¸¸è½¬å‘æ£€æŸ¥ç‚¹ barrier åï¼Œä»»åŠ¡ç»§ç»­æ­£å¸¸çš„æ•°æ®å¤„ç†</p><p>Sink ä»»åŠ¡å‘ JobManager ç¡®è®¤çŠ¶æ€ä¿å­˜åˆ° checkpoint å®Œæ¯•</p><p>å½“æ‰€æœ‰ä»»åŠ¡éƒ½ç¡®è®¤å·²æˆåŠŸå°†çŠ¶æ€ä¿å­˜åˆ°æ£€æŸ¥ç‚¹æ—¶ï¼Œæ£€æŸ¥ç‚¹å°±çœŸæ­£å®Œæˆäº†</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210104214755905.png" alt="image-20210104214755905"></p><h2 id="ä¿å­˜ç‚¹"><a href="#ä¿å­˜ç‚¹" class="headerlink" title="ä¿å­˜ç‚¹"></a>ä¿å­˜ç‚¹</h2><p>æ˜¯Flinkç‰¹æœ‰çš„åŠŸèƒ½ï¼Œå®ƒä¸æ£€æŸ¥ç‚¹çš„åŒºåˆ«å°±æ˜¯ä¸€ä¸ªæ˜¯æ‰‹åŠ¨è§¦å‘çš„ï¼›ä¸€ä¸ªæ˜¯JobManagerå‘¨æœŸæ€§è§¦å‘çš„ã€‚</p><p>ä¿å­˜ç‚¹å°±æ˜¯è‡ªå®šä¹‰çš„é•œåƒä¿å­˜åŠŸèƒ½ï¼Œå°†æ•°æ®ä¿å­˜åˆ°æŒ‡å®šåœ°æ–¹ã€‚å¯ä»¥é€šè¿‡æ•°æ®å¯åŠ¨ç¨‹åº</p><p><strong>ç‰¹ç‚¹ï¼š</strong></p><ol><li>åŸåˆ™ä¸Šï¼Œåˆ›å»ºä¿å­˜ç‚¹ä½¿ç”¨çš„ç®—æ³•ä¸æ£€æŸ¥ç‚¹å®Œå…¨ç›¸åŒï¼Œå› æ­¤ä¿å­˜ç‚¹å¯ä»¥è®¤ ä¸ºå°±æ˜¯å…·æœ‰ä¸€äº›é¢å¤–å…ƒæ•°æ®çš„æ£€æŸ¥ç‚¹</li><li>Flinkä¸ä¼šè‡ªåŠ¨åˆ›å»ºä¿å­˜ç‚¹ï¼Œå› æ­¤ç”¨æˆ·ï¼ˆæˆ–è€…å¤–éƒ¨è°ƒåº¦ç¨‹åºï¼‰å¿…é¡»æ˜ç¡®åœ° è§¦å‘åˆ›å»ºæ“ä½œ</li></ol><h3 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h3><p><strong>1. æœ‰è®¡åˆ’çš„å¤‡ä»½</strong></p><p><strong>2. Flinkç‰ˆæœ¬è¿ç§»</strong></p><p>Flinkå‡çº§æ—¶ï¼Œä¹‹å‰çš„Flinkç¨‹åºä¸å¯èƒ½é‡å¯ï¼Œè¿™æ ·ä»¥å‰è®¡ç®—çš„æ•°æ®è¢«ä¸¢å¤±æ˜¯ä¸è¢«å…è®¸çš„ï¼Œåœ¨Flinkå‡çº§å‰è®¾ç½®ä¸€ä¸ªä¿å­˜ç‚¹ï¼Œç„¶åFLinkç‰ˆæœ¬æ›´æ–°åï¼Œä½¿ç”¨æ–°ç‰ˆFlinkå‘½ä»¤å¼€å¯Flinkåº”ç”¨ç¨‹åºé€šè¿‡ä¿å­˜ç‚¹åŠ è½½æ•°æ®ï¼Œåšåˆ°æ•°æ®ä¸ä¸¢å¤±</p><p><strong>3. æš‚åœå’Œé‡å¯åº”ç”¨</strong></p><p>èµ„æºä¸å……è¶³æ—¶ï¼Œåœè°ƒä¸é‡è¦çš„ä»»åŠ¡å¹¶æ·»åŠ ä¿å­˜ç‚¹ã€‚å¾…èµ„æºå……è¶³æ—¶å†æ¬¡å¼€å§‹å¹¶åŠ è½½ä¹‹å‰æ•°æ®ã€‚</p><h2 id="å®¹é”™æœºåˆ¶çš„å¼€å¯ğŸ”º"><a href="#å®¹é”™æœºåˆ¶çš„å¼€å¯ğŸ”º" class="headerlink" title="å®¹é”™æœºåˆ¶çš„å¼€å¯ğŸ”º"></a>å®¹é”™æœºåˆ¶çš„å¼€å¯ğŸ”º</h2><p><strong>1. æ£€æŸ¥ç‚¹é»˜è®¤ä¸å¼€å¯ï¼Œæ‰‹åŠ¨å¼€å¯</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env.enableCheckpointing(<span class="number">5000</span>)</span><br></pre></td></tr></table></figure><p>å‚æ•°ä¸ºæ£€æŸ¥ç‚¹çš„é—´éš”ï¼Œæ¯5000msäº§ç”Ÿä¸€ä¸ªæ£€æŸ¥ç‚¹</p><p><strong>2. æ·»åŠ çŠ¶æ€åç«¯ç»„ä»¶ï¼ŒæŒ‡å®šæ£€æŸ¥ç‚¹ä¿å­˜ä½ç½®</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env.setStateBackend(<span class="keyword">new</span> <span class="type">FsStateBackend</span>(<span class="string">&quot;file:///ã€‚ã€‚ã€‚ã€‚&quot;</span>))</span><br></pre></td></tr></table></figure><hr><p>Checkpointçš„è®¾ç½®ï¼š</p><ol><li><code>env.getCheckpointConfig.setCheckpointTimeout(60000)</code>ï¼šæ£€æŸ¥ç‚¹è¶…æ—¶æ—¶é—´</li><li><code>env.getCheckpointConfig.setMaxConcurrentCheckpoints(2)</code>ï¼šåŒæ—¶å­˜åœ¨çš„ä¿å­˜ç‚¹</li><li><code>env.getCheckpointConfig.setMinPauseBetweenCheckpoints(100)</code>ï¼šä¸Šä¸€æ£€æŸ¥ç‚¹ç»“æŸåå’Œä¸‹ä¸€æ£€æŸ¥ç‚¹äº§ç”Ÿå‰çš„æœ€å°ç­‰å¾…æ—¶é—´ï¼›<strong>å¦‚æœåœ¨æ­¤ç­‰å¾…æ—¶é—´å†…æ­£å¥½ç”±äºæ£€æŸ¥ç‚¹æ—¶é—´é—´éš”è¯¥äº§ç”Ÿä¸‹ä¸€æ£€æŸ¥ç‚¹äº†ï¼Œåˆ™ä¸‹ä¸€æ£€æŸ¥ç‚¹çš„äº§ç”Ÿæ—¶é—´å˜æ›´ä¸ºæœ€å°ç­‰å¾…æ—¶é—´è¿‡å»ä¹‹åã€‚</strong></li></ol><h2 id="é‡å¯ç­–ç•¥"><a href="#é‡å¯ç­–ç•¥" class="headerlink" title="é‡å¯ç­–ç•¥"></a>é‡å¯ç­–ç•¥</h2><p>Flinkç¨‹åºæ•…éšœæ—¶ï¼Œé‡å¯å¹¶ä¸èƒ½è§£å†³ä¸€åˆ‡é—®é¢˜ã€‚é‚£ä¹ˆæœ‰æ•ˆçš„é‡å¯ç­–ç•¥å°±æ˜¯æœ‰å¿…è¦çš„ã€‚</p><p>è®¾ç½®é‡å¯ç­–ç•¥ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env.setRestartStrategy()</span><br></pre></td></tr></table></figure><p>æœ‰ä¸‹é¢å‡ ä¸ªç­–ç•¥ï¼š</p><ol><li>ä¸é‡å¯</li><li>å›æ»šé‡å¯ï¼šç”±èµ„æºç®¡ç†å™¨å†³å®š</li><li>å›ºå®šå»¶è¿Ÿé‡å¯ï¼šå¯è®¾ç½®é‡å¯æ¬¡æ•°å’Œé‡å¯é—´éš”</li><li>å¤±è´¥ç‡é‡å¯ï¼šå¯è®¾ç½®é‡å¯æ¬¡æ•°ã€é‡å¯é—´éš”ã€æŒ‡å®šçš„æ—¶é—´ä¹‹å†…</li></ol><h1 id="Exactly-once-ä¸¤é˜¶æ®µæäº¤"><a href="#Exactly-once-ä¸¤é˜¶æ®µæäº¤" class="headerlink" title="Exactly-once ä¸¤é˜¶æ®µæäº¤"></a>Exactly-once ä¸¤é˜¶æ®µæäº¤</h1><p>JobManager åè°ƒå„ä¸ª TaskManager è¿›è¡Œ checkpoint å­˜å‚¨</p><p>checkpointä¿å­˜åœ¨ StateBackendä¸­ï¼Œé»˜è®¤StateBackendæ˜¯å†…å­˜çº§çš„ï¼Œä¹Ÿå¯ä»¥æ”¹ ä¸ºæ–‡ä»¶çº§çš„è¿›è¡ŒæŒä¹…åŒ–ä¿å­˜</p><p>å½“ checkpoint å¯åŠ¨æ—¶ï¼ŒJobManager ä¼šå°†æ£€æŸ¥ç‚¹åˆ†ç•Œçº¿ï¼ˆbarrierï¼‰æ³¨å…¥æ•°æ®æµ</p><p>barrierä¼šåœ¨ç®—å­é—´ä¼ é€’ä¸‹å»</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210104211640764.png" alt="image-20210104211640764"></p><p>æ¯ä¸ªç®—å­ä¼šå¯¹å½“å‰çš„çŠ¶æ€åšä¸ªå¿«ç…§ï¼Œä¿å­˜åˆ°çŠ¶æ€åç«¯</p><p>checkpoint æœºåˆ¶å¯ä»¥ä¿è¯å†…éƒ¨çš„çŠ¶æ€ä¸€è‡´æ€§</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210104211739784.png" alt="image-20210104211739784"></p><p>æ¯ä¸ªå†…éƒ¨çš„ transform ä»»åŠ¡é‡åˆ° barrier æ—¶ï¼Œéƒ½ä¼šæŠŠçŠ¶æ€å­˜åˆ° checkpoint é‡Œ</p><p>sink ä»»åŠ¡é¦–å…ˆæŠŠæ•°æ®å†™å…¥å¤–éƒ¨ kafkaï¼Œè¿™äº›æ•°æ®éƒ½å±äº<strong>é¢„æäº¤çš„äº‹åŠ¡</strong>ï¼›é‡åˆ° barrier æ—¶ï¼Œ<strong>æŠŠçŠ¶æ€ä¿å­˜åˆ°çŠ¶æ€åç«¯ï¼Œå¹¶å¼€å¯æ–°çš„é¢„æäº¤äº‹åŠ¡</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210104211815182.png" alt="image-20210104211815182"></p><p>å½“æ‰€æœ‰ç®—å­ä»»åŠ¡çš„å¿«ç…§å®Œæˆï¼Œä¹Ÿå°±æ˜¯è¿™æ¬¡çš„ checkpoint å®Œæˆæ—¶ï¼ŒJobManager ä¼šå‘æ‰€æœ‰ä»»åŠ¡å‘é€šçŸ¥ï¼Œç¡®è®¤è¿™æ¬¡ checkpoint å®Œæˆ</p><p>sink ä»»åŠ¡æ”¶åˆ°ç¡®è®¤é€šçŸ¥ï¼Œæ­£å¼æäº¤ä¹‹å‰çš„äº‹åŠ¡ï¼Œkafka ä¸­æœªç¡®è®¤æ•°æ®æ”¹ä¸ºâ€œå·²ç¡® è®¤â€</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210104211830889.png" alt="image-20210104211830889"></p><p><strong>Exactly-once ä¸¤é˜¶æ®µæäº¤æ­¥éª¤</strong></p><ol><li>ç¬¬ä¸€æ¡æ•°æ®æ¥äº†ä¹‹åï¼Œå¼€å¯ä¸€ä¸ª kafka çš„äº‹åŠ¡ï¼ˆtransactionï¼‰ï¼Œæ­£å¸¸å†™å…¥ kafka åˆ† åŒºæ—¥å¿—ä½†æ ‡è®°ä¸ºæœªæäº¤ï¼Œè¿™å°±æ˜¯â€œé¢„æäº¤â€ </li><li>jobmanager è§¦å‘ checkpoint æ“ä½œï¼Œbarrier ä» source å¼€å§‹å‘ä¸‹ä¼ é€’ï¼Œé‡åˆ° barrier çš„ç®—å­å°†çŠ¶æ€å­˜å…¥çŠ¶æ€åç«¯ï¼Œå¹¶é€šçŸ¥ jobmanager </li><li>sink è¿æ¥å™¨æ”¶åˆ° barrierï¼Œä¿å­˜å½“å‰çŠ¶æ€ï¼Œå­˜å…¥ checkpointï¼Œé€šçŸ¥ jobmanagerï¼Œ å¹¶å¼€å¯ä¸‹ä¸€é˜¶æ®µçš„äº‹åŠ¡ï¼Œç”¨äºæäº¤ä¸‹ä¸ªæ£€æŸ¥ç‚¹çš„æ•°æ®</li><li>jobmanager æ”¶åˆ°æ‰€æœ‰ä»»åŠ¡çš„é€šçŸ¥ï¼Œå‘å‡ºç¡®è®¤ä¿¡æ¯ï¼Œè¡¨ç¤º checkpoint å®Œæˆ</li><li> sink ä»»åŠ¡æ”¶åˆ° jobmanager çš„ç¡®è®¤ä¿¡æ¯ï¼Œæ­£å¼æäº¤è¿™æ®µæ—¶é—´çš„æ•°æ®</li><li> å¤–éƒ¨kafkaå…³é—­äº‹åŠ¡ï¼Œæäº¤çš„æ•°æ®å¯ä»¥æ­£å¸¸æ¶ˆè´¹äº†ã€‚</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;FlinkçŠ¶æ€ç®¡ç†&quot;&gt;&lt;a href=&quot;#FlinkçŠ¶æ€ç®¡ç†&quot; class=&quot;headerlink&quot; title=&quot;FlinkçŠ¶æ€ç®¡ç†&quot;&gt;&lt;/a&gt;FlinkçŠ¶æ€ç®¡ç†&lt;/h1&gt;&lt;p&gt;æµå¼è®¡ç®—åˆ†ä¸º&lt;strong&gt;æ— çŠ¶æ€å’Œæœ‰çŠ¶æ€&lt;/strong&gt;ä¸¤ç§æƒ…å†µã€‚æ— çŠ¶æ€çš„è®¡ç®—è§‚</summary>
      
    
    
    
    <category term="Flink" scheme="https://awslzhang.top/categories/Flink/"/>
    
    
    <category term="Flink" scheme="https://awslzhang.top/tags/Flink/"/>
    
  </entry>
  
  <entry>
    <title>Flinkçš„æ—¶é—´è¯­ä¹‰å’Œwatermark</title>
    <link href="https://awslzhang.top/2020/12/23/Flink%E6%97%B6%E9%97%B4%E8%AF%AD%E4%B9%89%E5%92%8CWaterMark/"/>
    <id>https://awslzhang.top/2020/12/23/Flink%E6%97%B6%E9%97%B4%E8%AF%AD%E4%B9%89%E5%92%8CWaterMark/</id>
    <published>2020-12-23T10:59:07.000Z</published>
    <updated>2021-01-03T06:54:32.814Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æˆ‘ä»¬å°†ä»‹ç»æ—¶é—´è¯­ä¹‰ï¼Œå¹¶æè¿°æµä¸­ä¸åŒçš„æ—¶é—´æ¦‚å¿µã€‚æˆ‘ä»¬å°†è®¨è®ºæµå¤„ç†å™¨åœ¨ä¹±åºäº‹ä»¶æµçš„æƒ…å†µä¸‹å¦‚ä½•æä¾›å‡†ç¡®çš„è®¡ç®—ç»“æœï¼Œä»¥åŠæˆ‘ä»¬å¦‚ä½•å¤„ç†å†å²äº‹ä»¶æµï¼Œå¦‚ä½•åœ¨æµä¸­è¿›è¡Œæ—¶é—´æ—…è¡Œã€‚</p><blockquote><p>æ—¶é—´æ—…è¡Œã€‚ä¹±åºäº‹ä»¶æµï¼Œæ›´æœ‰å¤è€æ•°æ®çš„äº‹ä»¶ã€‚</p></blockquote><h2 id="ä¸åŒçš„æ—¶é—´è¯­ä¹‰"><a href="#ä¸åŒçš„æ—¶é—´è¯­ä¹‰" class="headerlink" title="ä¸åŒçš„æ—¶é—´è¯­ä¹‰"></a>ä¸åŒçš„æ—¶é—´è¯­ä¹‰</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-23_19-05-44.png" alt="Snipaste_2020-12-23_19-05-44"></p><ul><li>Event Timeï¼šäº‹ä»¶çš„åˆ›å»ºäº‹ä»¶ã€‚ï¼ˆé™¤äº†æœªå¼€æºçš„Google DataFlowå¤–ï¼ŒFlinkæ˜¯å”¯ä¸€æ”¯æŒäº‹ä»¶æ—¶é—´çš„ï¼‰</li><li>Ingestion Timeï¼šæ•°æ®è¿›å…¥Flinkçš„æ—¶é—´</li><li>Processing Timeï¼šæ‰§è¡Œæ“ä½œç®—å­çš„<strong>æœ¬åœ°ç³»ç»Ÿæ—¶é—´</strong>ï¼Œä¸æœºå™¨ç›¸å…³</li></ul><h2 id="æ›´åŠ å½¢è±¡çš„äº‹ä»¶æ—¶é—´"><a href="#æ›´åŠ å½¢è±¡çš„äº‹ä»¶æ—¶é—´" class="headerlink" title="æ›´åŠ å½¢è±¡çš„äº‹ä»¶æ—¶é—´"></a>æ›´åŠ å½¢è±¡çš„äº‹ä»¶æ—¶é—´</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-23_19-07-29.png" alt="Snipaste_2020-12-23_19-07-29"></p><p>1977-2015æ˜¯å¤„ç†æ—¶é—´ã€æ˜Ÿçƒå¤§æˆ˜1-æ˜Ÿçƒå¤§æˆ˜7æ˜¯äº‹ä»¶æ—¶é—´ã€‚</p><ul><li>ä¸åŒçš„æ—¶é—´è¯­ä¹‰æœ‰ä¸åŒçš„åº”ç”¨åœºåˆ</li><li>æˆ‘ä»¬å¾€å¾€æ›´å…³å¿ƒäº‹ä»¶æ—¶é—´ï¼ˆEvent Timeï¼‰</li></ul><hr><h1 id="äº‹ä»¶æ—¶é—´"><a href="#äº‹ä»¶æ—¶é—´" class="headerlink" title="äº‹ä»¶æ—¶é—´"></a>äº‹ä»¶æ—¶é—´</h1><p>äº‹ä»¶æ—¶é—´æ˜¯æµä¸­çš„äº‹ä»¶å®é™…å‘ç”Ÿçš„æ—¶é—´ã€‚äº‹ä»¶æ—¶é—´åŸºäºæµä¸­çš„äº‹ä»¶æ‰€åŒ…å«çš„æ—¶é—´æˆ³ã€‚<font color="red">é€šå¸¸æƒ…å†µä¸‹ï¼Œåœ¨äº‹ä»¶è¿›å…¥æµå¤„ç†ç¨‹åºå‰ï¼Œäº‹ä»¶æ•°æ®å°±å·²ç»åŒ…å«äº†æ—¶é—´æˆ³</font>ã€‚ä¸‹å›¾å±•ç¤ºäº†äº‹ä»¶æ—¶é—´çª—å£å°†ä¼šæ­£ç¡®çš„å°†äº‹ä»¶åˆ†å‘åˆ°çª—å£ä¸­å»ã€‚å¯ä»¥å¦‚å®ååº”äº‹æƒ…æ˜¯æ€ä¹ˆå‘ç”Ÿçš„ã€‚å³ä½¿äº‹ä»¶å¯èƒ½å­˜åœ¨å»¶è¿Ÿã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/spaf_0213.png"></p><p>äº‹ä»¶æ—¶é—´ä½¿å¾—è®¡ç®—ç»“æœçš„è¿‡ç¨‹ä¸éœ€è¦ä¾èµ–å¤„ç†æ•°æ®çš„é€Ÿåº¦ã€‚åŸºäºäº‹ä»¶æ—¶é—´çš„æ“ä½œæ˜¯å¯ä»¥é¢„æµ‹çš„ï¼Œè€Œè®¡ç®—ç»“æœä¹Ÿæ˜¯ç¡®å®šçš„ã€‚æ— è®ºæµå¤„ç†ç¨‹åºå¤„ç†æµæ•°æ®çš„é€Ÿåº¦å¿«æˆ–æ˜¯æ…¢ï¼Œæ— è®ºäº‹ä»¶åˆ°è¾¾æµå¤„ç†ç¨‹åºçš„é€Ÿåº¦å¿«æˆ–æ˜¯æ…¢ï¼Œäº‹ä»¶æ—¶é—´çª—å£çš„è®¡ç®—ç»“æœéƒ½æ˜¯ä¸€æ ·çš„ã€‚å› ä¸ºå®ƒé‡‡ç”¨çš„æ˜¯äº‹ä»¶ä¸­çš„æ—¶é—´</p><p><font color="red">å¦‚æœä½¿ç”¨äº‹ä»¶æ—¶é—´ï¼Œå³ä½¿ç¢°åˆ°äº†äº‹ä»¶ä¹±åºåˆ°è¾¾çš„æƒ…å†µï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¿è¯ç»“æœçš„æ­£ç¡®æ€§</font>ã€‚è¿˜æœ‰ï¼Œå½“æˆ‘ä»¬åœ¨å¤„ç†å¯ä»¥é‡æ’­çš„æµæ•°æ®æ—¶ï¼Œç”±äºæ—¶é—´æˆ³çš„ç¡®å®šæ€§ï¼Œæˆ‘ä»¬å¯ä»¥å¿«è¿›è¿‡å»ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥é‡æ’­ä¸€æ¡æµï¼Œç„¶ååˆ†æå†å²æ•°æ®ï¼Œå°±å¥½åƒæµä¸­çš„äº‹ä»¶æ˜¯å®æ—¶å‘ç”Ÿä¸€æ ·ã€‚å¦å¤–ï¼Œæˆ‘ä»¬å¯ä»¥å¿«è¿›å†å²æ•°æ®æ¥ä½¿æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºè¿½ä¸Šç°åœ¨çš„äº‹ä»¶ï¼Œç„¶ååº”ç”¨ç¨‹åºä»ç„¶æ˜¯ä¸€ä¸ªå®æ—¶å¤„ç†ç¨‹åºï¼Œè€Œä¸”ä¸šåŠ¡é€»è¾‘ä¸éœ€è¦æ”¹å˜ã€‚</p><h2 id="ä»£ç ä¸­è®¾ç½®äº‹ä»¶æ—¶é—´"><a href="#ä»£ç ä¸­è®¾ç½®äº‹ä»¶æ—¶é—´" class="headerlink" title="ä»£ç ä¸­è®¾ç½®äº‹ä»¶æ—¶é—´"></a>ä»£ç ä¸­è®¾ç½®äº‹ä»¶æ—¶é—´</h2><p>æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ä»£ç ä¸­ï¼Œå¯¹æ‰§è¡Œç¯å¢ƒè°ƒç”¨<code>setStreamTimeCharacteristic</code>æ–¹æ³•ï¼Œè®¾ç½®æµçš„æ—¶é—´ç‰¹æ€§ï¼›å…·ä½“çš„æ—¶é—´ï¼Œ<strong>è¿˜éœ€è¦ä»æ•°æ®ä¸­æå–æ—¶é—´æˆ³ï¼ˆtimestampï¼‰</strong>ï¼ˆ<font color="red">å¿…é¡»</font>ï¼‰</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line"><span class="comment">// è®¾ç½®æµçš„æ—¶é—´ç‰¹å¾</span></span><br><span class="line">env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">EventTime</span>)</span><br></pre></td></tr></table></figure><p><strong>æå–æ—¶é—´æˆ³+è®¾ç½®æ°´ä½çº¿</strong></p><p><a href="#%E6%B0%B4%E4%BD%8D%E7%BA%BF%E7%9A%84%E5%BC%95%E5%85%A5">æŸ¥çœ‹</a></p><h2 id="äº‹ä»¶æ—¶é—´æ€ä¹ˆè§£å†³ä¹±åºæ•°æ®"><a href="#äº‹ä»¶æ—¶é—´æ€ä¹ˆè§£å†³ä¹±åºæ•°æ®" class="headerlink" title="äº‹ä»¶æ—¶é—´æ€ä¹ˆè§£å†³ä¹±åºæ•°æ®"></a>äº‹ä»¶æ—¶é—´æ€ä¹ˆè§£å†³ä¹±åºæ•°æ®</h2><p>ä¹±åºæ•°æ®ä¼šè®©çª—å£è®¡ç®—ä¸å‡†ç¡®</p><p>å¦‚å›¾ï¼Œè¢«åœ†åœˆåœˆä½å¾—æ•°æ®æ˜¯å½“å‰äº‹ä»¶å¾—äº‹ä»¶æ—¶é—´ï¼ˆå‘ç”Ÿäº‹ä»¶å¾—æ—¶é—´ï¼‰ï¼Œè€Œäº‹ä»¶å¾—é¡ºåºå°±æ˜¯äº‹ä»¶åˆ°è¾¾Flinkå¾—é¡ºåºã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-23_19-34-40.png" alt="Snipaste_2020-12-23_19-34-40"></p><p>å‡å¦‚ï¼Œæˆ‘ä»¬å¼€äº†ä¸€ä¸ªæ—¶é—´é•¿åº¦ä¸º5så¾—äº‹ä»¶æ—¶é—´çª—å£ã€‚å› ä¸ºæ˜¯äº‹ä»¶æ—¶é—´çª—å£ï¼Œå½“äº‹ä»¶æ—¶é—´ä¸º5så¾—äº‹ä»¶åˆ°è¾¾æ—¶ï¼Œæˆ‘ä»¬è¿™ä¸ª0-5å¾—æ—¶é—´çª—å£å°±èƒ½å…³é—­äº†å—ï¼Œå°±èƒ½è®¤ä¸ºè¿™ä¸ªçª—å£å¾—æ•°æ®éƒ½åˆ°è¾¾äº†å—ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ä¸èƒ½çš„ï¼Œå¦‚æœæ˜¯å¤„ç†æ—¶é—´çš„çª—å£ï¼Œé‚£ä¹ˆè¿‡äº†5Sçª—å£å°±ç›´æ¥å…³é—­äº†ï¼Œå®ƒä½¿ç”¨æœºå™¨æ—¶é—´ã€‚ä½†æ˜¯äº‹ä»¶æ—¶é—´çª—å£ä½¿ç”¨çš„æ˜¯äº‹ä»¶çš„æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´ä»–åœ¨æ•°æ®é‡Œï¼Œè™½ç„¶ç¬¬5sçš„æ•°æ®åˆ°äº†ï¼Œä½†æ²¡äººèƒ½ä¿è¯5Sä¹‹å‰çš„æ•°æ®ä¼šä¸ä¼šç”±äºç½‘ç»œã€åˆ†å¸ƒå¼ç­‰åŸå› è¿Ÿåˆ°ï¼Œä¼šå¯¼è‡´ä¹±åºæ•°æ®çš„äº§ç”Ÿï¼Œæˆ–è€…ç¬¬5sæœ‰æ²¡æœ‰å¤šæ¡æ•°æ®ã€‚</p><p>é‚£ä¹ˆå¦‚æœæ˜¯äº‹ä»¶äº‹ä»¶çª—å£å¾—è¯ï¼Œè¿™ä¸ªçª—å£å°±æ°¸ä¹…ä¸å…³é—­å—ï¼Œè¿™æ ·å¤§é‡çª—å£åœ¨å¤„ç†ï¼Œä¼šæ‹–å®ç¨‹åºçš„ã€‚</p><p><font color="red"><strong>è¿™æ—¶å€™æå‡ºäº†æ°´ä½çº¿çš„æ¦‚å¿µï¼Œæ¥ä»£è¡¨äº‹ä»¶æ—¶é—´æ•°æ®æµçš„æ—¶é—´æµåŠ¨è¿›åº¦ã€‚</strong></font></p><h1 id="æ°´ä½çº¿ï¼ˆWaterMarkï¼‰ğŸ”º"><a href="#æ°´ä½çº¿ï¼ˆWaterMarkï¼‰ğŸ”º" class="headerlink" title="æ°´ä½çº¿ï¼ˆWaterMarkï¼‰ğŸ”º"></a>æ°´ä½çº¿ï¼ˆWaterMarkï¼‰ğŸ”º</h1><p>æå‡ºæ°´ä½çº¿ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥åˆ—ä¸¾å‡ ä¸ªäº‹ä»¶æ—¶é—´çª—å£å¾—é—®é¢˜ï¼š</p><ul><li>æ€æ ·é¿å…ä¹±åºæ•°æ®å¸¦æ¥è®¡ç®—ä¸æ­£ç¡®ï¼Ÿ<ul><li>Watermark æ˜¯ç”¨äºå¤„ç†ä¹±åºäº‹ä»¶çš„ï¼Œè€Œæ­£ç¡®çš„å¤„ç†ä¹±åºäº‹ä»¶ï¼Œé€šå¸¸ç”¨Watermark æœºåˆ¶ç»“åˆ window æ¥å®ç°ï¼›</li></ul></li><li>æˆ‘ä»¬åº”è¯¥æ€æ ·å»å†³å®šä½•æ—¶è§¦å‘äº‹ä»¶æ—¶é—´çª—å£çš„è®¡ç®—ï¼Ÿï¼ˆæ€ä¹ˆå…³é—­æ—¶é—´çª—å£ï¼‰</li></ul><p><strong>watermark ç”¨æ¥è®©ç¨‹åºè‡ªå·±å¹³è¡¡å»¶è¿Ÿå’Œç»“æœæ­£ç¡®æ€§</strong></p><p>åœ¨æœ¬å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä¼šçœ‹åˆ°å¦‚ä½•ä½¿ç”¨æ°´ä½çº¿æ¥è®¾ç½®äº‹ä»¶æ—¶é—´çª—å£çš„è¡Œä¸ºã€‚</p><hr><p>æ°´ä½çº¿æ˜¯æ—¶é—´å…¨å±€è¿›åº¦çš„åº¦é‡æ ‡å‡†ã€‚<strong>ç³»ç»Ÿå¯ä»¥ç¡®ä¿¡åœ¨ä¸€ä¸ªæ—¶é—´ç‚¹ä¹‹åï¼Œä¸ä¼šæœ‰æ—©äºè¿™ä¸ªæ—¶é—´ç‚¹å‘ç”Ÿçš„äº‹ä»¶åˆ°æ¥äº†ã€‚</strong>æœ¬è´¨ä¸Šï¼Œæ°´ä½çº¿æä¾›äº†ä¸€ä¸ªé€»è¾‘æ—¶é’Ÿï¼Œè¿™ä¸ªé€»è¾‘æ—¶é’Ÿå‘Šè¯‰ç³»ç»Ÿå½“å‰çš„äº‹ä»¶æ—¶é—´ã€‚å½“ä¸€ä¸ªè¿ç®—ç¬¦æ¥æ”¶åˆ°å«æœ‰æ—¶é—´Tçš„æ°´ä½çº¿æ—¶ï¼Œè¿™ä¸ªè¿ç®—ç¬¦ä¼šè®¤ä¸ºæ—©äºæ—¶é—´Tçš„å‘ç”Ÿçš„äº‹ä»¶å·²ç»å…¨éƒ¨éƒ½åˆ°è¾¾äº†ã€‚<strong>å¯¹äºäº‹ä»¶æ—¶é—´çª—å£å’Œä¹±åºäº‹ä»¶çš„å¤„ç†ï¼Œæ°´ä½çº¿éå¸¸é‡è¦ã€‚</strong><font color="red">è¿ç®—ç¬¦ä¸€æ—¦æ¥æ”¶åˆ°æ°´ä½çº¿ï¼Œè¿ç®—ç¬¦ä¼šè®¤ä¸ºä¸€æ®µæ—¶é—´å†…å‘ç”Ÿçš„æ‰€æœ‰äº‹ä»¶éƒ½å·²ç»è§‚å¯Ÿåˆ°ï¼Œå¯ä»¥è§¦å‘é’ˆå¯¹è¿™æ®µæ—¶é—´å†…æ‰€æœ‰äº‹ä»¶çš„è®¡ç®—äº†ã€‚</font></p><blockquote><p><strong>ç³»ç»Ÿå¯ä»¥ç¡®ä¿¡åœ¨ä¸€ä¸ªæ—¶é—´ç‚¹ä¹‹åï¼Œä¸ä¼šæœ‰æ—©äºè¿™ä¸ªæ—¶é—´ç‚¹å‘ç”Ÿçš„äº‹ä»¶åˆ°æ¥äº†ã€‚</strong></p><p>ï¼ˆåªæ˜¯è¿™æ ·è§„å®šçš„ï¼Œå®é™…ä¸Šè¿˜æ˜¯æœ‰å¯èƒ½æœ‰æ—©äºè¿™ä¸ªæ—¶é—´ç‚¹å‘ç”Ÿçš„äº‹ä»¶åˆ°æ¥ï¼Œè¿™æ—¶äº‹ä»¶è¢«ç§°ä¸ºè¿Ÿåˆ°äº‹ä»¶ï¼Œé»˜è®¤è¿Ÿåˆ°äº‹ä»¶è¢«ä¸¢å¼ƒã€‚åé¢æœ‰å•ç‹¬çš„è¿Ÿåˆ°äº‹ä»¶çš„å¤„ç†ç« èŠ‚ï¼‰</p></blockquote><h2 id="æ°´ä½çº¿ä½œç”¨"><a href="#æ°´ä½çº¿ä½œç”¨" class="headerlink" title="æ°´ä½çº¿ä½œç”¨"></a>æ°´ä½çº¿ä½œç”¨</h2><p>æ°´ä½çº¿æä¾›äº†ä¸€ç§<strong>ç»“æœå¯ä¿¡åº¦å’Œå»¶æ—¶ä¹‹é—´çš„å¦¥å</strong>ã€‚æ¿€è¿›çš„æ°´ä½çº¿è®¾ç½®å¯ä»¥ä¿è¯ä½å»¶è¿Ÿï¼Œä½†ç»“æœçš„å‡†ç¡®æ€§ä¸å¤Ÿã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<strong>è¿Ÿåˆ°çš„äº‹ä»¶æœ‰å¯èƒ½æ™šäºæ°´ä½çº¿åˆ°è¾¾ï¼Œæˆ‘ä»¬éœ€è¦ç¼–å†™ä¸€äº›ä»£ç æ¥å¤„ç†è¿Ÿåˆ°äº‹ä»¶</strong>ã€‚å¦ä¸€æ–¹é¢ï¼Œ<strong>å¦‚æœæ°´ä½çº¿è®¾ç½®çš„è¿‡äºå®½æ¾ï¼Œè®¡ç®—çš„ç»“æœå‡†ç¡®æ€§ä¼šå¾ˆé«˜ï¼Œä½†å¯èƒ½ä¼šå¢åŠ æµå¤„ç†ç¨‹åºä¸å¿…è¦çš„å»¶æ—¶</strong>ã€‚</p><blockquote><p>ç™½è¯è®²</p><p><strong>ç»“æœå¯ä¿¡åº¦å’Œå»¶æ—¶ä¹‹é—´çš„å¦¥å</strong>ï¼š</p><p>å°±æ˜¯è¯´æ°´ä½çº¿æ—¶æœ‰ä¸€ä¸ªæœ€å¤§å»¶è¿Ÿæ—¶é—´çš„æ¦‚å¿µï¼ŒåŠ å…¥æœ€å¤§çš„äº‹ä»¶æ—¶é—´åˆ°äº†æ˜¯10Sï¼Œä½†æ˜¯æœ€å¤§å»¶è¿Ÿæ—¶é—´æ˜¯5Sï¼Œé‚£ä¹ˆå½“å‰æ°´ä½çº¿å°±æ˜¯5Sï¼Œé‚£ä¹ˆ0-10Sçš„çª—å£å°±ä¸ä¼šå…³é—­è®¡ç®—ï¼Œå®ƒåœ¨ç­‰å¾…å› ä¸ºæŸäº›åŸå› è¿˜æ²¡æœ‰åˆ°çš„0-10Sçš„äº‹ä»¶ã€‚</p><p>ä¸€æ–¹é¢ï¼š</p><p>å½“æœ€å¤§æ—¶é—´æ—¶é—´åˆ°äº†15Sï¼Œæœ€å¤§å»¶è¿Ÿæ—¶é—´æ˜¯5Sï¼Œé‚£ä¹ˆå½“å‰æ°´ä½çº¿å°±æ˜¯10Sã€‚å³0-10Sçš„çª—å£å·²ç»å…³é—­å¼€å§‹äº†è®¡ç®—ï¼Œé‚£ä¹ˆä¹‹ååˆ°çš„0-10Sçš„äº‹ä»¶äº‹ä»¶æ•°æ®å°±æ˜¯è¿Ÿåˆ°äº‹ä»¶ï¼Œéœ€è¦ç¼–å†™ä¸€äº›ä»£ç æ¥å¤„ç†ï¼ˆé»˜è®¤ä¸¢å¼ƒï¼‰</p><p>å¦ä¸€æ–¹é¢ï¼š</p><p>å¦‚æœå°†æ°´ä½çº¿è®¾ç½®çš„å®½æ¾ï¼Œå‡†ç¡®æ€§å°±ä¼šæé«˜ã€‚ä¾‹å¦‚æ”¾å¤§æœ€å¤§å»¶è¿Ÿæ—¶é—´ï¼Œä½†æ˜¯å¯èƒ½ä¼šå¢åŠ æµå¤„ç†ç¨‹åºä¸å¿…è¦çš„å»¶æ—¶</p></blockquote><p>å¦‚å›¾ï¼Œè®¾æ—¶é—´çª—å£å¤§å°ä¸º10Sï¼Œæœ€å¤§å»¶è¿Ÿäº‹ä»¶ä¸º5Sã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-23_21-13-13.png" alt="Snipaste_2020-12-23_21-13-13"></p><hr><p>åœ¨13Såˆ°è¾¾æ—¶ï¼Œæ°´ä½çº¿ä¸º7Sã€‚</p><ul><li>è¿™æ—¶å¦‚æœæ²¡æœ‰æ›´å¤§çš„äº‹ä»¶æ—¶é—´åˆ°æ¥æ—¶ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶é—´æ®µå†…æ‰€æœ‰0-10Sçš„æ•°æ®éƒ½ä¼šè¿›å…¥çª—å£ã€‚</li><li>å½“15Sçš„äº‹ä»¶æ—¶é—´åˆ°è¾¾æ—¶ï¼Œæ°´ä½çº¿ä¸º10Sã€‚0-10Sçš„çª—å£å°†è¢«è®¡ç®—å¹¶ä¸”å…³é—­ã€‚</li><li>å¦‚æœåœ¨15Sçš„äº‹ä»¶æ—¶é—´åˆ°è¾¾åï¼Œåˆæ¥ä¸´äº†0-10Sçš„äº‹ä»¶æ—¶é—´ã€‚å®ƒä»¬é»˜è®¤å°†è¢«æŠ›å¼ƒï¼Œé™¤äº†å†™äº†ä¸“é—¨å¤„ç†çš„ä»£ç </li></ul><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-23_21-22-39.png" alt="Snipaste_2020-12-23_21-22-39"></p><h2 id="æ°´ä½çº¿ç‰¹ç‚¹ğŸ”º"><a href="#æ°´ä½çº¿ç‰¹ç‚¹ğŸ”º" class="headerlink" title="æ°´ä½çº¿ç‰¹ç‚¹ğŸ”º"></a>æ°´ä½çº¿ç‰¹ç‚¹ğŸ”º</h2><ul><li>watermarké»˜è®¤æ¯200msæ’å…¥ä¸€æ¬¡ï¼Œç”±ç¨‹åºå‘˜ç¼–ç æ’å…¥ã€‚å¯ä»¥ä½¿ç”¨<code>env.getConfig.setAutoWatermarkInterval(5000)</code>æ–¹æ³•è¿›è¡Œè®¾ç½®ã€‚</li><li>Watermark æ˜¯ä¸€ç§è¡¡é‡ Event Time è¿›å±•çš„æœºåˆ¶ï¼Œå¯ä»¥è®¾å®šå»¶è¿Ÿè§¦å‘</li><li>watermark å¿…é¡»å•è°ƒé€’å¢ï¼Œä»¥ç¡®ä¿ä»»åŠ¡çš„äº‹ä»¶æ—¶é—´æ—¶é’Ÿåœ¨å‘å‰æ¨è¿›ï¼Œè€Œä¸æ˜¯åœ¨åé€€</li><li>åªæœ‰äº‹ä»¶æ—¶é—´éœ€è¦æ°´ä½çº¿ï¼Œæ°´ä½çº¿åªæœ‰åœ¨çª—å£è®¡ç®—æ—¶æ‰æœ‰ç”¨ï¼Œäº‹ä»¶æ—¶é—´å¯ä»¥è®¾ç½®æœ€å¤§å»¶è¿Ÿæ—¶é—´</li><li><font color="red">ç³»ç»Ÿè®¤ä¸ºæ—¶é—´æˆ³å°äºæ°´ä½çº¿çš„äº‹ä»¶éƒ½å·²ç»åˆ°è¾¾äº†</font></li><li><font color="red">äº‹ä»¶æ—¶é—´çª—å£çš„é—­åˆè§¦å‘è§„åˆ™ï¼šæ°´ä½çº¿å¤§äºç­‰äºçª—å£ç»“æŸæ—¶é—´</font></li><li><font color="red"><code>watermark  = æœ€å¤§äº‹ä»¶æ—¶é—´ - æœ€å¤§å»¶è¿Ÿæ—¶é—´</code></font></li></ul><blockquote><p>é€šå¸¸ï¼Œå½“æ°´ä½çº¿è¶…è¿‡çª—å£ç»“æŸæ—¶é—´æ—¶ï¼Œçª—å£å°†ä¸å†æ¥æ”¶äº‹ä»¶ï¼Œç„¶åè§¦å‘è®¡ç®—ï¼Œè®¡ç®—å®Œæ¯•ï¼Œçª—å£è¢«é”€æ¯</p></blockquote><hr><blockquote><p> é€šå¸¸éƒ½æ˜¯åœ¨æµä¹‹åç«‹é©¬è®¾ç½®æ°´ä½çº¿ï¼Œå› ä¸ºç»è¿‡åˆ†æµååœ¨è®¾ç½®æ°´ä½çº¿ï¼Œæµä¹‹é—´çš„æ°´ä½çº¿ä¼šå¾ˆä¹±</p></blockquote><h2 id="æ°´ä½çº¿çš„å¼•å…¥"><a href="#æ°´ä½çº¿çš„å¼•å…¥" class="headerlink" title="æ°´ä½çº¿çš„å¼•å…¥"></a>æ°´ä½çº¿çš„å¼•å…¥</h2><h3 id="è‡ªå¸¦"><a href="#è‡ªå¸¦" class="headerlink" title="è‡ªå¸¦"></a>è‡ªå¸¦</h3><p><strong>å¯¹äºæ’å¥½åºçš„æ•°æ®ï¼Œä¸éœ€è¦å»¶è¿Ÿè§¦å‘ï¼Œå¯ä»¥åªæŒ‡å®šæ—¶é—´æˆ³å°±è¡Œäº†</strong></p><p>å½“10Såˆ°è¾¾åï¼Œå› ä¸ºçª—å£æ˜¯å·¦é—­å³å¼€ï¼Œè¿™ä¸ª10Sä¸ä¼šç«‹é©¬åŠ å…¥çª—å£è®¡ç®—ï¼Œ<font color="red">æ‰€ä»¥å½“å‰æ°´ä½çº¿æ˜¯æœ€å¤§äº‹ä»¶æ—¶é—´-1msã€‚</font></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ—¶é—´æˆ³å¿…é¡»æ˜¯msï¼Œæ ¹æ®è‡ªå·±éœ€æ±‚å†™</span></span><br><span class="line">dataStream.assignAscendingTimestamps(_timestamp * <span class="number">1000</span>)</span><br></pre></td></tr></table></figure><p><strong>å¯¹äºä¹±åºæ•°æ®ï¼Œéœ€è¦æ¥è®¾ç½®å»¶è¿Ÿæ—¶é—´ï¼Œæ¥è§£å†³é—®é¢˜</strong></p><p>å³è®¾ç½®æœ€å¤§å»¶è¿Ÿæ—¶é—´</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.assignTimestampsAndWatermarks(</span><br><span class="line">       <span class="comment">// è®¾ç½®æœ€å¤§å»¶è¿Ÿæ—¶é—´ä¸º5S</span></span><br><span class="line">       <span class="keyword">new</span> <span class="type">BoundedOutOfOrdernessTimestampExtractor</span>[(<span class="type">String</span>, <span class="type">Long</span>)](<span class="type">Time</span>.seconds(<span class="number">5</span>)) &#123;</span><br><span class="line">         <span class="comment">// è®¾ç½®é‚£ä¸ªå…ƒç´ æ˜¯äº‹ä»¶è‡ªå¸¦çš„</span></span><br><span class="line">       <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(t: (<span class="type">String</span>, <span class="type">Long</span>)) = t._2</span><br><span class="line">     &#125;)</span><br></pre></td></tr></table></figure><h3 id="è‡ªå®šä¹‰"><a href="#è‡ªå®šä¹‰" class="headerlink" title="è‡ªå®šä¹‰"></a>è‡ªå®šä¹‰</h3><p>æˆ‘ä»¬çŸ¥é“é»˜è®¤çš„æ°´å¹³çº¿è®¡ç®—è§„åˆ™ä¸º<code>æœ€å¤§äº‹ä»¶æ—¶é—´-æœ€å¤§å»¶è¿Ÿæ—¶é—´</code>ï¼Œå³<code>BoundedOutOfOrdernessTimestampExtractor</code>ç±»çš„å®ç°ã€‚è€Œä¸”æ˜¯æ¯éš”200msæ’å…¥ä¸€æ¬¡ã€‚</p><p>Flinkæä¾›äº†æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰å®ç°æ°´å¹³çº¿çš„å®ç°é€»è¾‘ï¼Œå³å®ƒçš„è®¡ç®—è§„åˆ™å¯ä»¥æ›´æ”¹ï¼Œå¹¶ä¸”å®ƒçš„æ’å…¥ä¹Ÿå¯ä»¥æ›´æ”¹ï¼ˆè§„åˆ™æ€§æ’å…¥|ä¸è§„åˆ™æ’å…¥ï¼‰ï¼Œåˆ†åˆ«å¯¹åº”ç€ä¸¤ä¸ªæ¥å£ï¼š</p><ol><li><code>AssignerWithPeriodicWatermarks</code>ï¼š<a href="#%E5%91%A8%E6%9C%9F%E6%80%A7%E7%9A%84%E7%94%9F%E6%88%90%E6%B0%B4%E4%BD%8D%E7%BA%BF">å‘¨æœŸæ€§çš„ç”Ÿæˆæ°´ä½çº¿</a></li><li><code>AssignerWithPunctuatedWatermarks</code>ï¼š<a href="#%E5%A6%82%E4%BD%95%E4%BA%A7%E7%94%9F%E4%B8%8D%E8%A7%84%E5%88%99%E7%9A%84%E6%B0%B4%E4%BD%8D%E7%BA%BF">äº§ç”Ÿä¸è§„åˆ™çš„æ°´ä½çº¿</a></li></ol><h4 id="å‘¨æœŸæ€§çš„ç”Ÿæˆæ°´ä½çº¿"><a href="#å‘¨æœŸæ€§çš„ç”Ÿæˆæ°´ä½çº¿" class="headerlink" title="å‘¨æœŸæ€§çš„ç”Ÿæˆæ°´ä½çº¿"></a>å‘¨æœŸæ€§çš„ç”Ÿæˆæ°´ä½çº¿</h4><p>å‘¨æœŸæ€§çš„ç”Ÿæˆæ°´ä½çº¿ï¼šç³»ç»Ÿä¼šå‘¨æœŸæ€§çš„å°†æ°´ä½çº¿æ’å…¥åˆ°æµä¸­ï¼ˆæ°´ä½çº¿ä¹Ÿæ˜¯ä¸€ç§ç‰¹æ®Šçš„äº‹ä»¶!ï¼‰ã€‚é»˜è®¤å‘¨æœŸæ˜¯200æ¯«ç§’ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç³»ç»Ÿä¼šæ¯éš”200æ¯«ç§’å°±å¾€æµä¸­æ’å…¥ä¸€æ¬¡æ°´ä½çº¿ã€‚</p><blockquote><p>è¿™é‡Œçš„200æ¯«ç§’æ˜¯æœºå™¨æ—¶é—´ï¼</p></blockquote><p>å¯ä»¥ä½¿ç”¨<code>ExecutionConfig.setAutoWatermarkInterval()</code>æ–¹æ³•è¿›è¡Œè®¾ç½®ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">EventTime</span>)</span><br><span class="line"><span class="comment">// æ¯éš”5ç§’äº§ç”Ÿä¸€ä¸ªæ°´ä½çº¿</span></span><br><span class="line">env.getConfig.setAutoWatermarkInterval(<span class="number">5000</span>)</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä¾‹å­äº§ç”Ÿæ°´ä½çº¿çš„é€»è¾‘ï¼šæ¯éš”5ç§’é’Ÿï¼ŒFlinkä¼šè°ƒç”¨AssignerWithPeriodicWatermarksä¸­çš„getCurrentWatermark()æ–¹æ³•ã€‚å¦‚æœæ–¹æ³•è¿”å›çš„æ—¶é—´æˆ³å¤§äºä¹‹å‰æ°´ä½çº¿çš„æ—¶é—´æˆ³ï¼Œæ–°çš„æ°´ä½çº¿ä¼šè¢«æ’å…¥åˆ°æµä¸­ã€‚è¿™ä¸ªæ£€æŸ¥ä¿è¯äº†æ°´ä½çº¿æ˜¯å•è°ƒé€’å¢çš„ã€‚å¦‚æœæ–¹æ³•è¿”å›çš„æ—¶é—´æˆ³å°äºç­‰äºä¹‹å‰æ°´ä½çº¿çš„æ—¶é—´æˆ³ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿæ–°çš„æ°´ä½çº¿ã€‚</p><hr><p>ä¾‹å­ï¼Œè‡ªå®šä¹‰ä¸€ä¸ªå‘¨æœŸæ€§çš„æ—¶é—´æˆ³æŠ½å–</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PeriodicAssigner</span> <span class="keyword">extends</span> <span class="title">AssignerWithPeriodicWatermarks</span>[<span class="type">SensorReading</span>] </span>&#123;</span><br><span class="line">  <span class="keyword">val</span> bound = <span class="number">60</span> * <span class="number">1000</span> <span class="comment">// é»˜è®¤ï¼Œå»¶æ—¶ä¸º1åˆ†é’Ÿ</span></span><br><span class="line">  <span class="keyword">var</span> maxTs = <span class="type">Long</span>.<span class="type">MinValue</span> + bound <span class="comment">// è§‚å¯Ÿåˆ°çš„æœ€å¤§æ—¶é—´æˆ³</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getCurrentWatermark</span></span>: <span class="type">Watermark</span> &#123;</span><br><span class="line">      <span class="comment">// è®¾ç½®æ°´ä½çº¿ï¼Œé»˜è®¤è§„åˆ™</span></span><br><span class="line">    <span class="keyword">new</span> <span class="type">Watermark</span>(maxTs - bound)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¯ä¸ªäº‹ä»¶åˆ°æ¥éƒ½ä¼šæ‰§è¡Œï¼Œæ›´æ–°æœ€å¤§äº‹ä»¶æ—¶é—´æˆ³</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(r: <span class="type">SensorReading</span>, previousTS: <span class="type">Long</span>) &#123;</span><br><span class="line">    maxTs = maxTs.max(r.timestamp)</span><br><span class="line">    r.timestamp</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç çš„é€»è¾‘å°±æ˜¯<code>BoundedOutOfOrdernessTimestampExtractor</code>çš„é€»è¾‘ã€‚</p><h4 id="å¦‚ä½•äº§ç”Ÿä¸è§„åˆ™çš„æ°´ä½çº¿"><a href="#å¦‚ä½•äº§ç”Ÿä¸è§„åˆ™çš„æ°´ä½çº¿" class="headerlink" title="å¦‚ä½•äº§ç”Ÿä¸è§„åˆ™çš„æ°´ä½çº¿"></a><a href="#%E5%A6%82%E4%BD%95%E4%BA%A7%E7%94%9F%E4%B8%8D%E8%A7%84%E5%88%99%E7%9A%84%E6%B0%B4%E4%BD%8D%E7%BA%BF">å¦‚ä½•äº§ç”Ÿä¸è§„åˆ™çš„æ°´ä½çº¿</a></h4><p>æœ‰æ—¶å€™è¾“å…¥æµä¸­ä¼šåŒ…å«ä¸€äº›ç”¨äºæŒ‡ç¤ºç³»ç»Ÿè¿›åº¦çš„ç‰¹æ®Šå…ƒç»„æˆ–æ ‡è®°ã€‚Flinkä¸ºæ­¤ç±»æƒ…å½¢ä»¥åŠå¯æ ¹æ®è¾“å…¥å…ƒç´ ç”Ÿæˆæ°´ä½çº¿çš„æƒ…å½¢æä¾›äº†<code>AssignerWithPunctuatedWatermarks</code>æ¥å£ã€‚è¯¥æ¥å£ä¸­çš„<code>checkAndGetNextWatermark()</code>æ–¹æ³•ä¼šåœ¨é’ˆå¯¹æ¯ä¸ªäº‹ä»¶çš„<code>extractTimestamp()</code>æ–¹æ³•åç«‹å³è°ƒç”¨ã€‚å®ƒå¯ä»¥å†³å®šæ˜¯å¦ç”Ÿæˆä¸€ä¸ªæ–°çš„æ°´ä½çº¿ã€‚<strong>å¦‚æœè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªéç©ºã€ä¸”å¤§äºä¹‹å‰å€¼çš„æ°´ä½çº¿ï¼Œç®—å­å°±ä¼šå°†è¿™ä¸ªæ–°æ°´ä½çº¿å‘å‡ºã€‚</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PunctuatedAssigner</span> <span class="keyword">extends</span> <span class="title">AssignerWithPunctuatedWatermarks</span>[<span class="type">SensorReading</span>] </span>&#123;</span><br><span class="line">  <span class="keyword">val</span> bound = <span class="number">60</span> * <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¯æ¥ä¸€æ¡æ•°æ®å°±è°ƒç”¨ä¸€æ¬¡</span></span><br><span class="line">  <span class="comment">// ç´§è·Ÿ`extractTimestamp`å‡½æ•°è°ƒç”¨</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">checkAndGetNextWatermark</span></span>(r: <span class="type">SensorReading</span>, extractedTS: <span class="type">Long</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (r.id == <span class="string">&quot;sensor_1&quot;</span>) &#123;</span><br><span class="line">      <span class="comment">// æŠ½å–çš„æ—¶é—´æˆ³ - æœ€å¤§å»¶è¿Ÿæ—¶é—´</span></span><br><span class="line">      <span class="keyword">new</span> <span class="type">Watermark</span>(extractedTS - bound)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸äº§ç”Ÿæ—¶é—´æˆ³</span></span><br><span class="line">      <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¯æ¥ä¸€æ¡æ•°æ®å°±è°ƒç”¨ä¸€æ¬¡</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(r: <span class="type">SensorReading</span>, previousTS: <span class="type">Long</span>) &#123;</span><br><span class="line">    r.timestamp</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æœ€å¤§å»¶è¿Ÿæ—¶é—´çš„è®¾ç½®"><a href="#æœ€å¤§å»¶è¿Ÿæ—¶é—´çš„è®¾ç½®" class="headerlink" title="æœ€å¤§å»¶è¿Ÿæ—¶é—´çš„è®¾ç½®"></a>æœ€å¤§å»¶è¿Ÿæ—¶é—´çš„è®¾ç½®</h2><p>å®Œç¾çš„æ°´ä½çº¿æ°¸è¿œä¸ä¼šé”™ï¼šæ—¶é—´æˆ³å°äºæ°´ä½çº¿çš„äº‹ä»¶ä¸ä¼šå†å‡ºç°ã€‚åœ¨ç‰¹æ®Šæƒ…å†µä¸‹(ä¾‹å¦‚éä¹±åºäº‹ä»¶æµ)ï¼Œæœ€è¿‘ä¸€æ¬¡äº‹ä»¶çš„æ—¶é—´æˆ³å°±å¯èƒ½æ˜¯å®Œç¾çš„æ°´ä½çº¿ã€‚å¯å‘å¼æ°´ä½çº¿åˆ™ç›¸åï¼Œå®ƒåªä¼°è®¡æ—¶é—´ï¼Œå› æ­¤æœ‰å¯èƒ½å‡ºé”™ï¼Œå³è¿Ÿåˆ°çš„äº‹ä»¶(å…¶æ—¶é—´æˆ³å°äºæ°´ä½çº¿æ ‡è®°æ—¶é—´)æ™šäºæ°´ä½çº¿å‡ºç°ã€‚é’ˆå¯¹å¯å‘å¼æ°´ä½çº¿ï¼ŒFlinkæä¾›äº†å¤„ç†è¿Ÿåˆ°å…ƒç´ çš„æœºåˆ¶ã€‚</p><p><strong>è®¾å®šæ°´ä½çº¿é€šå¸¸éœ€è¦ç”¨åˆ°é¢†åŸŸçŸ¥è¯†ã€‚</strong>ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœçŸ¥é“äº‹ä»¶çš„è¿Ÿåˆ°æ—¶é—´ä¸ä¼šè¶…è¿‡5ç§’ï¼Œå°±å¯ä»¥å°†æ°´ä½çº¿æ ‡è®°æ—¶é—´è®¾ä¸ºæ”¶åˆ°çš„æœ€å¤§æ—¶é—´æˆ³å‡å»5ç§’ã€‚å¦ä¸€ç§åšæ³•æ˜¯ï¼Œé‡‡ç”¨ä¸€ä¸ªFlinkä½œä¸šç›‘æ§äº‹ä»¶æµï¼Œå­¦ä¹ äº‹ä»¶çš„è¿Ÿåˆ°è§„å¾‹ï¼Œå¹¶ä»¥æ­¤æ„å»ºæ°´ä½çº¿ç”Ÿæˆæ¨¡å‹ã€‚</p><p>å¦‚æœæœ€å¤§å»¶è¿Ÿæ—¶é—´è®¾ç½®çš„å¾ˆå¤§ï¼Œè®¡ç®—å‡ºçš„ç»“æœä¼šæ›´ç²¾ç¡®ï¼Œä½†æ”¶åˆ°è®¡ç®—ç»“æœçš„é€Ÿåº¦ä¼šå¾ˆæ…¢ï¼ŒåŒæ—¶ç³»ç»Ÿä¼šç¼“å­˜å¤§é‡çš„æ•°æ®ï¼Œå¹¶å¯¹ç³»ç»Ÿé€ æˆæ¯”è¾ƒå¤§çš„å‹åŠ›ã€‚å¦‚æœæœ€å¤§å»¶è¿Ÿæ—¶é—´è®¾ç½®çš„å¾ˆå°ï¼Œé‚£ä¹ˆæ”¶åˆ°è®¡ç®—ç»“æœçš„é€Ÿåº¦ä¼šå¾ˆå¿«ï¼Œä½†å¯èƒ½æ”¶åˆ°é”™è¯¯çš„è®¡ç®—ç»“æœã€‚ä¸è¿‡Flinkå¤„ç†è¿Ÿåˆ°æ•°æ®çš„æœºåˆ¶å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä¸Šè¿°é—®é¢˜çœ‹èµ·æ¥å¾ˆå¤æ‚ï¼Œä½†æ˜¯æ°æ°ç¬¦åˆç°å®ä¸–ç•Œçš„è§„å¾‹ï¼šå¤§éƒ¨åˆ†çœŸå®çš„äº‹ä»¶æµéƒ½æ˜¯ä¹±åºçš„ï¼Œå¹¶ä¸”é€šå¸¸æ— æ³•äº†è§£å®ƒä»¬çš„ä¹±åºç¨‹åº¦(å› ä¸ºç†è®ºä¸Šä¸èƒ½é¢„è§æœªæ¥)ã€‚æ°´ä½çº¿æ˜¯å”¯ä¸€è®©æˆ‘ä»¬ç›´é¢ä¹±åºäº‹ä»¶æµå¹¶ä¿è¯æ­£ç¡®æ€§çš„æœºåˆ¶; å¦åˆ™åªèƒ½é€‰æ‹©å¿½è§†äº‹å®ï¼Œå‡è£…é”™è¯¯çš„ç»“æœæ˜¯æ­£ç¡®çš„ã€‚</p><blockquote><ul><li>æ€è€ƒé¢˜ä¸€ï¼šå®æ—¶ç¨‹åºï¼Œè¦æ±‚å®æ—¶æ€§éå¸¸é«˜ï¼Œå¹¶ä¸”ç»“æœå¹¶ä¸ä¸€å®šè¦æ±‚éå¸¸å‡†ç¡®ï¼Œé‚£ä¹ˆåº”è¯¥æ€ä¹ˆåŠï¼Ÿ</li><li>å›ç­”ï¼šç›´æ¥ä½¿ç”¨å¤„ç†æ—¶é—´ã€‚</li><li>æ€è€ƒé¢˜äºŒï¼šå¦‚æœè¦è¿›è¡Œæ—¶é—´æ—…è¡Œï¼Œä¹Ÿå°±æ˜¯è¦è¿˜åŸä»¥å‰çš„æ•°æ®é›†å½“æ—¶çš„æµçš„çŠ¶æ€ï¼Œåº”è¯¥æ€ä¹ˆåŠï¼Ÿ</li><li>å›ç­”ï¼šä½¿ç”¨äº‹ä»¶æ—¶é—´ã€‚ä½¿ç”¨Hiveå°†æ•°æ®é›†å…ˆæŒ‰ç…§æ—¶é—´æˆ³å‡åºæ’åˆ—ï¼Œå†å°†æœ€å¤§å»¶è¿Ÿæ—¶é—´è®¾ç½®ä¸º0ã€‚</li></ul></blockquote><h2 id="æ°´ä½çº¿ã€äº‹ä»¶çª—å£çš„éªŒè¯ğŸ”º"><a href="#æ°´ä½çº¿ã€äº‹ä»¶çª—å£çš„éªŒè¯ğŸ”º" class="headerlink" title="æ°´ä½çº¿ã€äº‹ä»¶çª—å£çš„éªŒè¯ğŸ”º"></a>æ°´ä½çº¿ã€äº‹ä»¶çª—å£çš„éªŒè¯ğŸ”º</h2><p>å› ä¸ºæ˜¯éªŒè¯çª—å£ä¸æ°´ä½çº¿çš„å…³ç³»ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå‡½æ•°èƒ½åŒæ—¶è·å–çª—å£çš„åŸºæœ¬ä¿¡æ¯ï¼ˆå¼€å§‹ç»“æŸæ—¶é—´ï¼‰å’Œæ°´ä½çº¿çš„ã€‚</p><p>è¿™å°±æ˜¯å‰é¢æåˆ°çš„<code>PrcessWindowFunction</code>ï¼Œå› ä¸ºè¦è·å–è·å–çª—å£çš„åŸºæœ¬ä¿¡æ¯ã€‚æ‰€ä»¥ï¼Œå¢é‡èšåˆå‡½æ•°åœ¨è¿™é‡Œè¡Œä¸é€šã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æµ‹è¯• æ°´ä½çº¿å’Œçª—å£ç»“æŸæ—¶é—´ç»“æŸ çš„å…³ç³»</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">EventTime</span>)</span><br><span class="line"></span><br><span class="line">    env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">9000</span>, &#x27;\n&#x27;)</span><br><span class="line">      .map(r =&gt; (r.split(<span class="string">&quot; &quot;</span>)(<span class="number">0</span>), r.split(<span class="string">&quot; &quot;</span>)(<span class="number">1</span>).toLong * <span class="number">1000</span>))</span><br><span class="line">      .assignTimestampsAndWatermarks(</span><br><span class="line">        <span class="comment">// è®¾ç½®æœ€å¤§å»¶è¿Ÿæ—¶é—´ä¸º5S</span></span><br><span class="line">        <span class="keyword">new</span> <span class="type">BoundedOutOfOrdernessTimestampExtractor</span>[(<span class="type">String</span>, <span class="type">Long</span>)](<span class="type">Time</span>.seconds(<span class="number">5</span>)) &#123;</span><br><span class="line">          <span class="comment">// è®¾ç½®é‚£ä¸ªå…ƒç´ æ˜¯äº‹ä»¶è‡ªå¸¦çš„</span></span><br><span class="line">          <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(t: (<span class="type">String</span>, <span class="type">Long</span>)) = t._2</span><br><span class="line">        &#125;)</span><br><span class="line">      .keyBy(r =&gt; r._1)</span><br><span class="line">      <span class="comment">// å¼€çª—10S</span></span><br><span class="line">      .timeWindow(<span class="type">Time</span>.seconds(<span class="number">10</span>))</span><br><span class="line">      .process(<span class="keyword">new</span> <span class="type">MyProcess</span>).print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MyProcess</span> <span class="keyword">extends</span> <span class="title">ProcessWindowFunction</span>[(<span class="type">String</span>, <span class="type">Long</span>), <span class="type">String</span>, <span class="type">String</span>, <span class="type">TimeWindow</span>] </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">process</span></span>(key: <span class="type">String</span>, context: <span class="type">Context</span>, elements: <span class="type">Iterable</span>[(<span class="type">String</span>, <span class="type">Long</span>)], out: <span class="type">Collector</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="keyword">val</span> startTime: <span class="type">String</span> = <span class="keyword">new</span> <span class="type">Timestamp</span>(context.window.getStart).toString</span><br><span class="line">      <span class="keyword">val</span> endTime: <span class="type">String</span> = <span class="keyword">new</span> <span class="type">Timestamp</span>(context.window.getEnd).toString</span><br><span class="line">      out.collect(<span class="string">s&quot;çª—å£çš„å¤§å°ä¸ºï¼š<span class="subst">$startTime</span>-<span class="subst">$endTime</span>\tçª—å£å†…çš„å…ƒç´ ä¸ºï¼š<span class="subst">$elements</span>\tä¸ªæ•°ä¸ºï¼š<span class="subst">$&#123;elements.size&#125;</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>è¾“å…¥2ï¼Œ5ï¼Œ8ï¼Œ9ï¼Œ10ã€‚å‘ç°çª—å£æ²¡æœ‰ååº”ï¼Œå³ç¬¬ä¸€ä¸ªçª—å£æ²¡æœ‰å…³é—­</li><li>è¾“å…¥12ï¼Œ15ã€‚å‘ç°çª—å£å…³é—­äº†ï¼Œå½“è¾“å…¥15æ—¶ï¼Œæ°´å¹³çº¿ä¸º10.æ­£å¥½å¤§äºç­‰äºç¬¬ä¸€ä¸ªçª—å£çš„ç»“æŸæ—¶é—´ï¼Œæ‰€ä»¥çª—å£å¼€å§‹è®¡ç®—</li><li>çœ‹åˆ°æ—¥å¿—ç¬¬ä¸€ä¸ªçª—å£æ²¡æœ‰10Sï¼Œ<strong>å› ä¸ºçª—å£æ˜¯å·¦é—­å³å¼€çš„ã€‚</strong></li></ol><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201224163855851.png" alt="image-20201224163855851"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201224160149977.png" alt="image-20201224160149977"></p><h2 id="æ°´ä½çº¿çš„ä¼ é€’"><a href="#æ°´ä½çº¿çš„ä¼ é€’" class="headerlink" title="æ°´ä½çº¿çš„ä¼ é€’"></a>æ°´ä½çº¿çš„ä¼ é€’</h2><p>æ¯ä¸ªæµéƒ½æœ‰ç€è‡ªå·±çš„æ°´ä½çº¿ï¼Œåœ¨è¿›è¡Œæµåˆå¹¶æ—¶ï¼Œæ°´ä½çº¿æ˜¯æ€ä¹ˆä¼ é€’çš„å‘¢ï¼Ÿ</p><p><font color="red"><strong>ä¸€ä¸ªæµåœ¨ä¸€ä¸ªåˆ†åŒºä¸­å°±æœ‰ä¸€ä¸ªæ°´ä½çº¿</strong></font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210101195833056.png" alt="image-20210101195833056"></p><blockquote><ol><li>åœ¨map_1å’Œmap_2éƒ½æœ‰è‡ªå·±çš„æ°´ä½çº¿</li><li>åœ¨å‘å¾€åˆ†åŒº1ï¼Œ2æ—¶ï¼Œå®ƒä»¬å„è‡ªçš„æ°´ä½çº¿éƒ½å‘é€ï¼Œæ¯ä¸ªåˆ†åŒºåªå°†æœ€å°çš„æ°´ä½çº¿å½“æœ€æ­¤åˆ†åŒºæ­¤æ“ä½œçš„æ°´ä½çº¿</li></ol><p>æ­¤æ—¶ï¼Œå¦‚æœ125æ˜¯çª—å£ç»“æŸæ—¶é—´ï¼Œå¦‚æœæƒ³è¦è§¦å‘ç»“æŸï¼Œåˆ™map_1,map_2éƒ½è¦å¤§äº125çš„æ°´ä½çº¿</p><p><strong>ç»“è®ºï¼Œæ·»åŠ watermarkç¦»Sourceè¶Šè¿‘è¶Šå¥½</strong></p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/spaf_0309.png"></p><hr><h1 id="åº•å±‚çº§å¤„ç†å‡½æ•°ğŸ”º"><a href="#åº•å±‚çº§å¤„ç†å‡½æ•°ğŸ”º" class="headerlink" title="åº•å±‚çº§å¤„ç†å‡½æ•°ğŸ”º"></a>åº•å±‚çº§å¤„ç†å‡½æ•°ğŸ”º</h1><p>æˆ‘ä»¬ä¹‹å‰å­¦ä¹ çš„è½¬æ¢ç®—å­<strong>æ˜¯æ— æ³•è®¿é—®äº‹ä»¶çš„æ—¶é—´æˆ³ä¿¡æ¯å’Œæ°´ä½çº¿ä¿¡æ¯çš„ã€‚</strong>è€Œè¿™åœ¨ä¸€äº›åº”ç”¨åœºæ™¯ä¸‹ï¼Œæä¸ºé‡è¦ã€‚ä¾‹å¦‚MapFunctionè¿™æ ·çš„mapè½¬æ¢ç®—å­å°±æ— æ³•è®¿é—®æ—¶é—´æˆ³æˆ–è€…å½“å‰äº‹ä»¶çš„äº‹ä»¶æ—¶é—´ã€‚</p><p>åŸºäºæ­¤ï¼ŒDataStream APIæä¾›äº†ä¸€ç³»åˆ—çš„<strong>Low-Levelè½¬æ¢ç®—å­ã€‚å¯ä»¥è®¿é—®æ—¶é—´æˆ³ã€æ°´ä½çº¿ä»¥åŠæ³¨å†Œå®šæ—¶äº‹ä»¶ã€‚</strong>è¿˜å¯ä»¥è¾“å‡ºç‰¹å®šçš„ä¸€äº›äº‹ä»¶ï¼Œä¾‹å¦‚è¶…æ—¶äº‹ä»¶ç­‰ã€‚Process Functionç”¨æ¥æ„å»ºäº‹ä»¶é©±åŠ¨çš„åº”ç”¨ä»¥åŠå®ç°è‡ªå®šä¹‰çš„ä¸šåŠ¡é€»è¾‘(ä½¿ç”¨ä¹‹å‰çš„windowå‡½æ•°å’Œè½¬æ¢ç®—å­æ— æ³•å®ç°)ã€‚<strong>ä¾‹å¦‚ï¼ŒFlink-SQLå°±æ˜¯ä½¿ç”¨Process Functionå®ç°çš„ã€‚</strong></p><blockquote><p>Process Functionéƒ½æ˜¯Rich Function</p></blockquote><p><code>Flink</code>æä¾›äº†8ä¸ªProcess Functionï¼š</p><ul><li>ProcessFunctionï¼šå¤„ç†æ²¡æœ‰ç»è¿‡åˆ†ç»„å’Œå¼€çª—çš„æµï¼Œç›´æ¥å¯¹æ•´æ¡æµå¤„ç†ï¼Œæ¯ä¸ªå…ƒç´ è§¦å‘æ‰§è¡Œä¸€æ¬¡</li><li><code>KeyedProcessFunction</code>ï¼šå¤„ç†åˆ†ç»„åæ²¡æœ‰å¼€çª—çš„æµï¼Œæ¯ä¸ªå…ƒç´ è§¦å‘æ‰§è¡Œä¸€æ¬¡</li><li><code>CoProcessFunction</code>ï¼šå¤„ç†connectä¹‹åçš„æµ</li><li>ProcessJoinFunctionï¼šå¤„ç†ä¸¤æ¡æµjoinåçš„æµ </li><li>BroadcastProcessFunction</li><li>KeyedBroadcastProcessFunction</li><li><code>ProcessWindowFunction</code>ï¼šå¤„ç†åˆ†æµå’Œå¼€çª—å£ä»¥åçš„æµï¼Œæ¯ä¸ªçª—å£ç»“æŸæ—¶æ‰§è¡Œä¸€æ¬¡</li><li>ProcessAllWindowFunctionï¼šå¤„ç†æ²¡æœ‰åˆ†æµä½†å¼€äº†çª—çš„æµï¼Œçª—å£ç»“æŸæ—¶æ‰§è¡Œ</li></ul><p>æˆ‘ä»¬è¿™é‡Œè¯¦ç»†ä»‹ç»ä¸€ä¸‹KeyedProcessFunctionã€‚</p><h2 id="KeyedProcessFunction"><a href="#KeyedProcessFunction" class="headerlink" title="KeyedProcessFunction"></a><strong><em>KeyedProcessFunction</em></strong></h2><p>KeyedProcessFunctionç”¨<strong>æ¥æ“ä½œKeyedStream</strong>ã€‚KeyedProcessFunction<strong>ä¼šå¤„ç†æµçš„æ¯ä¸€ä¸ªå…ƒç´ ï¼Œè¾“å‡ºä¸º0ä¸ªã€1ä¸ªæˆ–è€…å¤šä¸ªå…ƒç´ </strong>ã€‚<strong>æ‰€æœ‰çš„Process Functionéƒ½ç»§æ‰¿è‡ªRichFunctionæ¥å£</strong>ï¼Œæ‰€ä»¥éƒ½æœ‰open()ã€close()å’ŒgetRuntimeContext()ç­‰æ–¹æ³•ã€‚è€ŒKeyedProcessFunction[KEY, IN, OUT]è¿˜é¢å¤–æä¾›äº†ä¸¤ä¸ªæ–¹æ³•:</p><ol><li><code>processElement(v: IN, ctx: Context, out: Collector[OUT])</code>, æµä¸­çš„<strong>æ¯ä¸€ä¸ªå…ƒç´ éƒ½ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•</strong>ï¼Œè°ƒç”¨ç»“æœå°†ä¼šæ”¾åœ¨Collectoræ•°æ®ç±»å‹ä¸­è¾“å‡ºã€‚<strong>Contextå¯ä»¥è®¿é—®å…ƒç´ çš„æ—¶é—´æˆ³ï¼Œå…ƒç´ çš„keyï¼Œä»¥åŠTimerServiceæ—¶é—´æœåŠ¡</strong>ã€‚**Contextè¿˜å¯ä»¥å°†ç»“æœè¾“å‡ºåˆ°åˆ«çš„æµ(side outputs)**ï¼ˆåé¢è®²#<a href="#%E4%BE%A7%E8%BE%93%E5%87%BA%E6%B5%81">ä¾§è¾“å‡ºæµ</a>ï¼‰ã€‚</li><li><code>onTimer(timestamp: Long, ctx: OnTimerContext, out: Collector[OUT])</code>æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ã€‚å½“ä¹‹å‰<font color="red"><strong>æ³¨å†Œçš„å®šæ—¶å™¨è§¦å‘æ—¶è°ƒç”¨</strong></font>ã€‚å‚æ•°timestampä¸ºå®šæ—¶å™¨æ‰€è®¾å®šçš„è§¦å‘çš„æ—¶é—´æˆ³ã€‚Collectorä¸ºè¾“å‡ºç»“æœçš„é›†åˆã€‚OnTimerContextå’ŒprocessElementçš„Contextå‚æ•°ä¸€æ ·ï¼Œæä¾›äº†ä¸Šä¸‹æ–‡çš„ä¸€äº›ä¿¡æ¯ï¼Œä¾‹å¦‚firing triggerçš„æ—¶é—´ä¿¡æ¯(äº‹ä»¶æ—¶é—´æˆ–è€…å¤„ç†æ—¶é—´)ã€‚</li></ol><h3 id="ä¾‹å­ï¼šæ—¶é—´æœåŠ¡å’Œå®šæ—¶å™¨"><a href="#ä¾‹å­ï¼šæ—¶é—´æœåŠ¡å’Œå®šæ—¶å™¨" class="headerlink" title="ä¾‹å­ï¼šæ—¶é—´æœåŠ¡å’Œå®šæ—¶å™¨"></a>ä¾‹å­ï¼š<a href="#%E6%97%B6%E9%97%B4%E6%9C%8D%E5%8A%A1%E5%92%8C%E5%AE%9A%E6%97%B6%E5%99%A8">æ—¶é—´æœåŠ¡å’Œå®šæ—¶å™¨</a></h3><p>Contextå’ŒOnTimerContextæ‰€æŒæœ‰çš„TimerServiceå¯¹è±¡æ‹¥æœ‰ä»¥ä¸‹æ–¹æ³•:</p><ul><li><code>currentProcessingTime(): Long</code> è¿”å›å½“å‰å¤„ç†æ—¶é—´</li><li><code>currentWatermark(): Long</code> è¿”å›å½“å‰æ°´ä½çº¿çš„æ—¶é—´æˆ³</li><li><code>registerProcessingTimeTimer(timestamp: Long): Unit</code> ä¼šæ³¨å†Œå½“å‰keyçš„processing timeçš„timerã€‚å½“processing timeåˆ°è¾¾å®šæ—¶æ—¶é—´æ—¶ï¼Œè§¦å‘timerã€‚</li><li><code>registerEventTimeTimer(timestamp: Long): Unit</code> ä¼šæ³¨å†Œå½“å‰keyçš„event time timerã€‚å½“æ°´ä½çº¿å¤§äºç­‰äºå®šæ—¶å™¨æ³¨å†Œçš„æ—¶é—´æ—¶ï¼Œè§¦å‘å®šæ—¶å™¨æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚</li><li><code>deleteProcessingTimeTimer(timestamp: Long): Unit</code> åˆ é™¤ä¹‹å‰æ³¨å†Œå¤„ç†æ—¶é—´å®šæ—¶å™¨ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ªæ—¶é—´æˆ³çš„å®šæ—¶å™¨ï¼Œåˆ™ä¸æ‰§è¡Œã€‚</li><li><code>deleteEventTimeTimer(timestamp: Long): Unit</code> åˆ é™¤ä¹‹å‰æ³¨å†Œçš„äº‹ä»¶æ—¶é—´å®šæ—¶å™¨ï¼Œå¦‚æœæ²¡æœ‰æ­¤æ—¶é—´æˆ³çš„å®šæ—¶å™¨ï¼Œåˆ™ä¸æ‰§è¡Œã€‚</li></ul><p>å½“å®šæ—¶å™¨timerè§¦å‘æ—¶ï¼Œæ‰§è¡Œå›è°ƒå‡½æ•°onTimer()ã€‚<strong>processElement()æ–¹æ³•å’ŒonTimer()æ–¹æ³•æ˜¯åŒæ­¥ï¼ˆä¸æ˜¯å¼‚æ­¥ï¼‰æ–¹æ³•ï¼Œè¿™æ ·å¯ä»¥é¿å…å¹¶å‘è®¿é—®å’Œæ“ä½œçŠ¶æ€ã€‚</strong></p><p><strong>é’ˆå¯¹æ¯ä¸€ä¸ªkeyå’Œtimestampï¼Œåªèƒ½æ³¨å†Œä¸€ä¸ªå®šæœŸå™¨</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸€ä¸ªkeyå¯ä»¥æ³¨å†Œå¤šä¸ªå®šæ—¶å™¨ï¼Œä½†åœ¨æ¯ä¸€ä¸ªæ—¶é—´æˆ³åªèƒ½æ³¨å†Œä¸€ä¸ªå®šæ—¶å™¨ã€‚KeyedProcessFunctioné»˜è®¤å°†æ‰€æœ‰å®šæ—¶å™¨çš„æ—¶é—´æˆ³æ”¾åœ¨ä¸€ä¸ªä¼˜å…ˆé˜Ÿåˆ—ä¸­ã€‚åœ¨Flinkåšæ£€æŸ¥ç‚¹æ“ä½œæ—¶ï¼Œå®šæ—¶å™¨ä¹Ÿä¼šè¢«ä¿å­˜åˆ°çŠ¶æ€åç«¯ä¸­ã€‚</p><p>ä¸¾ä¸ªä¾‹å­è¯´æ˜KeyedProcessFunctionå¦‚ä½•æ“ä½œKeyedStreamã€‚</p><p>ä¸‹é¢çš„ç¨‹åºå±•ç¤ºäº†å¦‚ä½•ç›‘æ§æ¸©åº¦ä¼ æ„Ÿå™¨çš„æ¸©åº¦å€¼ï¼Œå¦‚æœæ¸©åº¦å€¼åœ¨ä¸€ç§’é’Ÿä¹‹å†…(processing time)è¿ç»­ä¸Šå‡ï¼ŒæŠ¥è­¦ã€‚</p><p>åŸç†ï¼šé€šè¿‡çŠ¶æ€å˜é‡ï¼ˆæµä¸­ä¿ç•™ä¹‹å‰æµæ•°æ®çš„è®¡ç®—ç»“æœï¼Œæ¯å½“æ–°çš„æ•°æ®åˆ°åˆ°è¾¾æ—¶ï¼Œæ›´æ–°ä¿å­˜çš„çŠ¶æ€å˜é‡ï¼‰æ¯”è¾ƒå½“å‰æ¸©åº¦å’Œä¸Šä¸€ä¸ªæ¸©åº¦ï¼Œå¦‚æœå¤§äºçš„è¯ï¼Œåˆ›å»ºä¸€ä¸ª1Såçš„å®šæ—¶å™¨æŠ¥è­¦ï¼›å¦‚æœå°äºçš„è¯ï¼Œå–æ¶ˆä¹‹å‰çš„æŠ¥è­¦å™¨ã€‚è¿™æ ·å¦‚æœ1Sä¸­ä¹‹å†…æŠ¥è­¦å™¨æ²¡æœ‰è¢«å–æ¶ˆçš„è¯ï¼Œè¯æ˜1Så†…æ¸©åº¦åœ¨ä¸æ–­ä¸Šå‡ï¼</p><p>ä¸»è¦ç¨‹åºï¼šï¼ˆä¸ºä»€ä¹ˆä½¿ç”¨çŠ¶æ€å˜é‡ï¼Œå› ä¸ºé˜²æ­¢å®•æœºåï¼Œä¸¢å¤±æ•°æ®ï¼ˆçŠ¶æ€å˜é‡å¯ä»¥å­˜åœ¨hdfsä¸Šï¼Œåˆå§‹åŒ–æ—¶è¯»å–ï¼Œæ²¡æœ‰å†åˆå§‹åŒ–ï¼‰ï¼Œä½¿ç”¨çŠ¶æ€å˜é‡çš„è¯å¾—ç”¨æ‡’æ‰§è¡Œï¼Œå› ä¸ºä¸ç”¨æ‡’æ‰§è¡Œçš„è¯ï¼Œåˆå§‹åŒ–æ—¶<code>getRuntimeContext</code>è¿˜æ²¡æœ‰ï¼‰</p><blockquote><p>éœ€è¦æ³¨æ„æˆ‘æ²¡æœ‰è®¾ç½®å¹¶è¡Œåº¦ï¼Œå¦‚æœä½ çš„ç¨‹åºæ²¡æœ‰è¾“å‡ºç»“æœçš„è¯ï¼Œæ˜¯å› ä¸ºä¸€èˆ¬ç”µè„‘çš„æ ¸æ•°ä¸º8|16ï¼Œæ‰€ä»¥addSourceçš„å¹¶è¡Œåº¦ä¸º8|16ï¼Œè€Œæ¯ä¸ªaddSourceåœ¨æ¯sæ¯ä¸ªidå¤§çº¦ä¼šç”Ÿæˆ3æ¡æ•°æ®ï¼ˆæ ¹æ®300msè®¡ç®—çš„å¾—å‡ºï¼‰ï¼Œè€Œä¹˜ä»¥å¹¶è¡Œåº¦8æœ€åä¸º24æ¡ï¼Œè¿™æ—¶åªæœ‰24æ¡è®°å½•è¿ç»­ä¸Šå‡æ‰ä¼šå¯¼è‡´æŠ¥è­¦è§¦å‘ï¼Œæ‰€ä»¥å¾ˆéš¾å‡ºç°ç»“æœã€‚å¤§å®¶ä»¬å¯ä»¥å•ç‹¬å°†addSourceçš„å¹¶è¡Œåº¦è®¾ç½®ä¸º1</p></blockquote><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.&#123;<span class="type">ValueState</span>, <span class="type">ValueStateDescriptor</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.scala.typeutils.<span class="type">Types</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.<span class="type">KeyedProcessFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"><span class="keyword">import</span> org.example.flink.source.&#123;<span class="type">SensorReading</span>, <span class="type">SensorSource</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">TemperatureMonitor</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> source: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = env.addSource(<span class="keyword">new</span> <span class="type">SensorSource</span>)</span><br><span class="line">    source.keyBy(r =&gt; r.id).process(<span class="keyword">new</span> <span class="type">MykeyedFunction</span>).print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MykeyedFunction</span> <span class="keyword">extends</span> <span class="title">KeyedProcessFunction</span>[<span class="type">String</span>, <span class="type">SensorReading</span>, <span class="type">String</span>] </span>&#123;</span><br><span class="line">    <span class="comment">// å®šä¹‰çŠ¶æ€å˜é‡ï¼Œä½¿ç”¨æ‡’æ‰§è¡Œ</span></span><br><span class="line">    <span class="comment">// æ‡’åŠ è½½ï¼›</span></span><br><span class="line">    <span class="comment">// çŠ¶æ€å˜é‡ä¼šåœ¨æ£€æŸ¥ç‚¹æ“ä½œæ—¶è¿›è¡ŒæŒä¹…åŒ–ï¼Œä¾‹å¦‚hdfs</span></span><br><span class="line">    <span class="comment">// åªä¼šåˆå§‹åŒ–ä¸€æ¬¡ï¼Œå•ä¾‹æ¨¡å¼</span></span><br><span class="line">    <span class="comment">// åœ¨å½“æœºé‡å¯ç¨‹åºæ—¶ï¼Œé¦–å…ˆå»æŒä¹…åŒ–è®¾å¤‡å¯»æ‰¾åä¸º`last-temp`çš„çŠ¶æ€å˜é‡ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥è¯»å–ã€‚ä¸å­˜åœ¨ï¼Œåˆ™åˆå§‹åŒ–ã€‚</span></span><br><span class="line">    <span class="comment">// æµä¸­ä¸Šæ¬¡æ¸©åº¦ï¼Œé€šè¿‡å¯¹æ¯”æœ¬æ¬¡æ¸©åº¦å’Œä¸Šæ¬¡æ¸©åº¦ï¼Œæ¥çœ‹æ¸©åº¦çš„ä¸Šå‡/ä¸‹é™è¶‹åŠ¿  ä¸‹é™çš„è¯ å–æ¶ˆä¹‹å‰è®¾ç½®çš„å®šæ—¶æŠ¥è­¦</span></span><br><span class="line">    <span class="keyword">lazy</span> <span class="keyword">val</span> perTemperature: <span class="type">ValueState</span>[<span class="type">Double</span>] = getRuntimeContext.getState(<span class="keyword">new</span> <span class="type">ValueStateDescriptor</span>[<span class="type">Double</span>]</span><br><span class="line">    (<span class="string">&quot;last-temperature&quot;</span>, <span class="type">Types</span>.of[<span class="type">Double</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¹‹å‰è®¾ç½®çš„æŠ¥è­¦æ—¶é—´ï¼Œå½“æ¸©åº¦ä¸‹é™æ—¶éœ€è¦è·å–ä¹‹å‰è®¾ç½®çš„æŠ¥è­¦å™¨çš„æ—¶é—´ï¼Œé€šè¿‡æ—¶é—´æ¥åˆ é™¤æŠ¥è­¦å™¨</span></span><br><span class="line">    <span class="keyword">lazy</span> <span class="keyword">val</span> time: <span class="type">ValueState</span>[<span class="type">Long</span>] = getRuntimeContext.getState(<span class="keyword">new</span> <span class="type">ValueStateDescriptor</span>[<span class="type">Long</span>]</span><br><span class="line">    (<span class="string">&quot;time&quot;</span>, <span class="type">Types</span>.of[<span class="type">Long</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¯ä¸ªæµçš„å…ƒç´ éƒ½ä¼šæ‰§è¡Œä¸€é</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">processElement</span></span>(i: <span class="type">SensorReading</span>, context: <span class="type">KeyedProcessFunction</span>[<span class="type">String</span>, <span class="type">SensorReading</span>, <span class="type">String</span>]#<span class="type">Context</span>, collector: <span class="type">Collector</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="comment">// è·å–ä¸Šæ¬¡æ¸©åº¦</span></span><br><span class="line">      <span class="keyword">val</span> lastTemperature: <span class="type">Double</span> = perTemperature.value()</span><br><span class="line">      <span class="comment">// æ›´æ–°æ¸©åº¦çš„çŠ¶æ€å˜é‡</span></span><br><span class="line">      perTemperature.update(i.temperature)</span><br><span class="line">      <span class="keyword">val</span> curTime: <span class="type">Long</span> = time.value()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ¸©åº¦ï¼Œåˆ™ä¸Šæ¡æ¸©åº¦ä¸º0 || æœ¬åœ°æ¸©åº¦æ¯”ä¸Šæ¬¡æ¸©åº¦ä½   å½“å‰æ˜¯åˆå§‹åŒ–æˆ–é™æ¸©è¶‹åŠ¿ï¼Œåˆ é™¤å®šæ—¶ä»»åŠ¡</span></span><br><span class="line">      <span class="keyword">if</span> (lastTemperature == <span class="number">0.0</span> || i.temperature&lt;lastTemperature) &#123;</span><br><span class="line">        <span class="comment">// åˆ é™¤æŠ¥è­¦å™¨ï¼Œå¹¶æ¸…ç©ºå®šæ—¶å™¨çš„çŠ¶æ€å˜é‡</span></span><br><span class="line">        context.timerService().deleteProcessingTimeTimer(curTime)</span><br><span class="line">        time.clear()</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯æ¸©åº¦å¤„äºä¸Šå‡è¶‹åŠ¿||å®šæ—¶å™¨æ˜¯æœªè®¾ç½®  åˆ™è¦è®¾ç½®å®šæ—¶å™¨</span></span><br><span class="line">      &#125;<span class="keyword">else</span> <span class="keyword">if</span>(i.temperature&gt; lastTemperature  &amp;&amp; curTime==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">// 1S å†…  å¦‚æœæ¸©åº¦æ²¡æœ‰ä¸‹é™è¶‹åŠ¿ï¼Œå³æ²¡æœ‰å–æ¶ˆå®šæ—¶å™¨ï¼Œåˆ™æŠ¥è­¦</span></span><br><span class="line">        <span class="keyword">val</span> l: <span class="type">Long</span> = context.timerService().currentProcessingTime() + <span class="number">1000</span></span><br><span class="line">        context.timerService().registerProcessingTimeTimer(l)</span><br><span class="line">        time.update(l)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¸è¦æŒ‰ç…§æ³¨é‡Šé‚£æ ·å†™ï¼Œè¡€çš„æ•™è®­  è¿™æ ·å†™ å®šæ—¶äº‹ä»¶çš„æ—¶é—´å’ŒçŠ¶æ€å˜é‡å­˜å‚¨çš„æ—¶é—´ä¸åŒï¼Œå¯¼è‡´æ— æ³•åˆ é™¤åº”è¯¥åˆ é™¤çš„å®šæ—¶äº‹ä»¶</span></span><br><span class="line"><span class="comment">//        context.timerService().registerProcessingTimeTimer(context.timerService().currentProcessingTime() + 1000)</span></span><br><span class="line"><span class="comment">//        time.update(context.timerService().currentProcessingTime() + 1000)</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šæ—¶å™¨è§¦å‘æ—¶æ‰§è¡Œçš„é€»è¾‘</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">onTimer</span></span>(timestamp: <span class="type">Long</span>, ctx: <span class="type">KeyedProcessFunction</span>[<span class="type">String</span>, <span class="type">SensorReading</span>, <span class="type">String</span>]#<span class="type">OnTimerContext</span>, out: <span class="type">Collector</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      out.collect(<span class="string">s&quot;æ¸©åº¦è®¡idä¸º<span class="subst">$&#123;ctx.getCurrentKey&#125;</span>çš„å®ä¾‹æ¸©åº¦åœ¨1Så†…è¿ç»­ä¸Šå‡ï¼&quot;</span>)</span><br><span class="line">      <span class="comment">// ä¸æ¸…ç©ºçš„è¯ï¼Œå¦‚æœæ¸©åº¦ç»§ç»­ä¸Šå‡åˆ™æ— æ³•è¿›è¡Œä¸‹ä¸€æ¬¡çš„æŠ¥è­¦</span></span><br><span class="line">      time.clear()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸ºäº†æ›´å¥½çš„å±•ç¤ºç»“æœï¼Œæ„é€ æ•°æ®éœ€è¦å‡å°‘äº§ç”Ÿé‡ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.flink.source</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Calendar</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.source.<span class="type">SourceFunction</span>.<span class="type">SourceContext</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.source.&#123;<span class="type">RichParallelSourceFunction</span>, <span class="type">SourceFunction</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scala.util.<span class="type">Random</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”Ÿæˆéšæœºæ•°æ®</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SensorSource</span> <span class="keyword">extends</span> <span class="title">RichParallelSourceFunction</span>[<span class="type">SensorReading</span>] </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> running = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>(sourceContext: <span class="type">SourceContext</span>[<span class="type">SensorReading</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> rand = <span class="keyword">new</span> <span class="type">Random</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> curFTemp = (<span class="number">1</span> to <span class="number">10</span>).map(</span><br><span class="line">      i =&gt; (<span class="string">&quot;sensor_&quot;</span> + i, rand.nextGaussian() * <span class="number">20</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (running) &#123;</span><br><span class="line">      curFTemp = curFTemp.map(</span><br><span class="line">        t =&gt; (t._1, t._2 + rand.nextGaussian() * <span class="number">0.5</span>)</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">val</span> curTime = <span class="type">Calendar</span>.getInstance.getTimeInMillis</span><br><span class="line"></span><br><span class="line">      curFTemp.foreach(t =&gt; sourceContext.collect(<span class="type">SensorReading</span>(t._1, curTime, t._2)))</span><br><span class="line"></span><br><span class="line">      <span class="type">Thread</span>.sleep(<span class="number">300</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">cancel</span></span>(): <span class="type">Unit</span> = running = <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>åªæœ‰ç”¨äº†Flinkçš„æµå¤„ç†æ‰èƒ½è®¡ç®—åˆ°è¿ç»­çš„æ•°æ®æµä¸­çš„çŠ¶æ€æ•°æ®å˜åŒ–ï¼Œè€Œå¦‚æœç”¨Sparkæ¥å®ç°è¿™ä¸ªåŠŸèƒ½çš„æ ¹æœ¬å®ç°ä¸äº†çš„ã€‚å› ä¸ºï¼š</p><ul><li>Sparkçš„æµå¤„ç†æ˜¯å¾®æ‰¹ï¼Œæ— æ³•ç›‘æ§åˆ°ä¸åŒå¾®æ‰¹æ•°æ®ä¸­çš„çŠ¶æ€ï¼Œå°±æ— æ³•è¿›è¡Œè¿ç»­1Sçš„æ•°æ®è®¡ç®—</li><li>å¦‚æœé‡‡ç”¨æ‰¹å¤„ç†çš„è¯ï¼Œæ˜¯å¯ä»¥ã€‚ä½†æ˜¯æ•°æ®çš„äº§ç”Ÿéƒ½æ˜¯å®æ—¶çš„ï¼Œæ ¹æœ¬ä¸èƒ½ç”¨æ‰¹å¤„ç†ã€‚å†™å†™DEMOå¯ä»¥ï¼Œå®é™…æ— ç”¨å¤„ã€‚</li></ul></blockquote><h2 id="CoProcessFunction"><a href="#CoProcessFunction" class="headerlink" title="CoProcessFunction"></a><strong><em>CoProcessFunction</em></strong></h2><p>å¯¹äºä¸¤æ¡è¾“å…¥æµï¼ŒDataStream APIæä¾›äº†CoProcessFunctionè¿™æ ·çš„low-levelæ“ä½œã€‚CoProcessFunctionæä¾›äº†æ“ä½œæ¯ä¸€ä¸ªè¾“å…¥æµçš„æ–¹æ³•: processElement1()å’ŒprocessElement2()ã€‚ç±»ä¼¼äºProcessFunctionï¼Œè¿™ä¸¤ç§æ–¹æ³•éƒ½é€šè¿‡Contextå¯¹è±¡æ¥è°ƒç”¨ã€‚è¿™ä¸ªContextå¯¹è±¡å¯ä»¥è®¿é—®äº‹ä»¶æ•°æ®ï¼Œå®šæ—¶å™¨æ—¶é—´æˆ³ï¼ŒTimerServiceï¼Œä»¥åŠside outputsã€‚<strong>CoProcessFunctionä¹Ÿæä¾›äº†onTimer()å›è°ƒå‡½æ•°</strong>ã€‚ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨CoProcessFunctionæ¥åˆå¹¶ä¸¤æ¡æµã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.flink.transform</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.&#123;<span class="type">ValueState</span>, <span class="type">ValueStateDescriptor</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.scala.typeutils.<span class="type">Types</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.co.<span class="type">CoProcessFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"><span class="keyword">import</span> org.example.flink.source.&#123;<span class="type">SensorReading</span>, <span class="type">SensorSource</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">CoProcessFunctionTest</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ingest sensor stream</span></span><br><span class="line">    <span class="keyword">val</span> readings: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = env.addSource(<span class="keyword">new</span> <span class="type">SensorSource</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// filter switches enable forwarding of readings</span></span><br><span class="line">    <span class="keyword">val</span> filterSwitches: <span class="type">DataStream</span>[(<span class="type">String</span>, <span class="type">Long</span>)] = env</span><br><span class="line">      .fromCollection(<span class="type">Seq</span>(</span><br><span class="line">        (<span class="string">&quot;sensor_2&quot;</span>, <span class="number">10</span> * <span class="number">1000</span>L),</span><br><span class="line">        (<span class="string">&quot;sensor_7&quot;</span>, <span class="number">60</span> * <span class="number">1000</span>L)</span><br><span class="line">      ))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> forwardedReadings = readings</span><br><span class="line">      <span class="comment">// connect readings and switches</span></span><br><span class="line">      .connect(filterSwitches)</span><br><span class="line">      <span class="comment">// key by sensor ids</span></span><br><span class="line">      .keyBy(_.id, _._1)</span><br><span class="line">      <span class="comment">// apply filtering CoProcessFunction</span></span><br><span class="line">      .process(<span class="keyword">new</span> <span class="type">ReadingFilter</span>).print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">ReadingFilter</span> <span class="keyword">extends</span> <span class="title">CoProcessFunction</span>[<span class="type">SensorReading</span>, (<span class="type">String</span>, <span class="type">Long</span>), <span class="type">SensorReading</span>] </span>&#123;</span><br><span class="line">    <span class="comment">// switch to enable forwarding</span></span><br><span class="line">    <span class="comment">// ä¼ é€æ•°æ®çš„å¼€å…³</span></span><br><span class="line">    <span class="keyword">lazy</span> <span class="keyword">val</span> forwardingEnabled: <span class="type">ValueState</span>[<span class="type">Boolean</span>] = getRuntimeContext</span><br><span class="line">      .getState(</span><br><span class="line">        <span class="keyword">new</span> <span class="type">ValueStateDescriptor</span>[<span class="type">Boolean</span>](<span class="string">&quot;filterSwitch&quot;</span>, <span class="type">Types</span>.of[<span class="type">Boolean</span>])</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// hold timestamp of currently active disable timer</span></span><br><span class="line">    <span class="keyword">lazy</span> <span class="keyword">val</span> disableTimer: <span class="type">ValueState</span>[<span class="type">Long</span>] = getRuntimeContext</span><br><span class="line">      .getState(</span><br><span class="line">        <span class="keyword">new</span> <span class="type">ValueStateDescriptor</span>[<span class="type">Long</span>](<span class="string">&quot;timer&quot;</span>, <span class="type">Types</span>.of[<span class="type">Long</span>])</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">processElement1</span></span>(reading: <span class="type">SensorReading</span>,</span><br><span class="line">                                 ctx: <span class="type">CoProcessFunction</span>[<span class="type">SensorReading</span>,</span><br><span class="line">                                   (<span class="type">String</span>, <span class="type">Long</span>), <span class="type">SensorReading</span>]#<span class="type">Context</span>,</span><br><span class="line">                                 out: <span class="type">Collector</span>[<span class="type">SensorReading</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="comment">// check if we may forward the reading</span></span><br><span class="line">      <span class="comment">// å†³å®šæˆ‘ä»¬æ˜¯å¦è¦å°†æ•°æ®ç»§ç»­ä¼ ä¸‹å»</span></span><br><span class="line">      <span class="keyword">if</span> (forwardingEnabled.value()) &#123;</span><br><span class="line">        out.collect(reading)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">processElement2</span></span>(switch: (<span class="type">String</span>, <span class="type">Long</span>),</span><br><span class="line">                                 ctx: <span class="type">CoProcessFunction</span>[<span class="type">SensorReading</span>,</span><br><span class="line">                                   (<span class="type">String</span>, <span class="type">Long</span>), <span class="type">SensorReading</span>]#<span class="type">Context</span>,</span><br><span class="line">                                 out: <span class="type">Collector</span>[<span class="type">SensorReading</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="comment">// enable reading forwarding</span></span><br><span class="line">      <span class="comment">// å…è®¸ç»§ç»­ä¼ è¾“æ•°æ®</span></span><br><span class="line">      forwardingEnabled.update(<span class="literal">true</span>)</span><br><span class="line">      <span class="comment">// set disable forward timer</span></span><br><span class="line">      <span class="keyword">val</span> timerTimestamp = ctx.timerService().currentProcessingTime()</span><br><span class="line">      + switch._2</span><br><span class="line"></span><br><span class="line">      <span class="keyword">val</span> curTimerTimestamp = disableTimer.value()</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (timerTimestamp &gt; curTimerTimestamp) &#123;</span><br><span class="line">        <span class="comment">// remove current timer and register new timer</span></span><br><span class="line">        ctx.timerService().deleteProcessingTimeTimer(curTimerTimestamp)</span><br><span class="line">        ctx.timerService().registerProcessingTimeTimer(timerTimestamp)</span><br><span class="line">        disableTimer.update(timerTimestamp)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">onTimer</span></span>(ts: <span class="type">Long</span>,</span><br><span class="line">                         ctx: <span class="type">CoProcessFunction</span>[<span class="type">SensorReading</span>,</span><br><span class="line">                           (<span class="type">String</span>, <span class="type">Long</span>), <span class="type">SensorReading</span>]#<span class="type">OnTimerContext</span>,</span><br><span class="line">                         out: <span class="type">Collector</span>[<span class="type">SensorReading</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="comment">// remove all state; forward switch will be false by default</span></span><br><span class="line">      forwardingEnabled.clear()</span><br><span class="line">      disableTimer.clear()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ProcessFunction"><a href="#ProcessFunction" class="headerlink" title="ProcessFunction"></a>ProcessFunction</h2><blockquote><p><code>process function</code>ä¸<code>KeyedProcessFunction</code>åŒºåˆ«ï¼š</p><p><code>KeyedProcessFunction</code>æ˜¯å¯¹äºkeybyåçš„æµè®¡ç®—ï¼Œè€Œ<code>process function</code>æ˜¯å¯¹keybyå‰çš„æµè®¡ç®—ï¼Œéƒ½æ˜¯ä¸€ä¸ªå…ƒç´ è§¦å‘ä¸€æ¬¡è®¡ç®—</p></blockquote><h1 id="ä¾§è¾“å‡ºæµ"><a href="#ä¾§è¾“å‡ºæµ" class="headerlink" title="ä¾§è¾“å‡ºæµ"></a>ä¾§è¾“å‡ºæµ</h1><p>ä¸Šé¢æˆ‘ä»¬è¯´è¿‡æ°´ä½çº¿åŠ ä¸Šæœ€å¤§å»¶è¿Ÿæ—¶é—´å¯ä¿è¯å°å¹…åº¦è¿Ÿåˆ°çš„æ•°æ®å¯ä»¥ç»§ç»­åŠ å…¥çª—å£è¢«è®¡ç®—ï¼Œä½†æ˜¯å¦‚æœæ•°æ®è¿Ÿåˆ°çš„ç¦»è°±ï¼Œè¿™æ—¶é…ç½®æœ€å¤§å»¶è¿Ÿæ—¶é—´è‚¯å®šæ²¡æœ‰ç”¨äº†ã€‚</p><p>å¦‚æœä¸è®¾ç½®å®ƒä¼šé»˜è®¤èˆå¼ƒè¿™ç§è¿Ÿåˆ°çš„æ—¶é—´ã€‚é™¤éæˆ‘ä»¬æ‰‹åŠ¨ä»£ç è®¾ç½®æ¥å¤„ç†è¿™äº›æ•°æ®ï¼Œæœ‰2ä¸­æ–¹å¼ã€‚</p><ol><li>å…è®¸è¿Ÿåˆ°çš„æ•°æ®ï¼Œä¸€å®šæ—¶é—´å†…ã€‚æ­¤æ—¶æ¥çš„æ•°æ®ä¸ä¹‹å‰çš„ç»“æœè¿›è¡Œèšåˆè®¡ç®—</li><li>è¾“å‡ºåˆ°ä¾§è¾“å‡ºæµ</li></ol><p>ä¸ä¹‹å‰èŠè¿‡çš„lambdaæ¶æ„ï¼Œæ‰¹å¤„ç†æä¾›æ•°æ®å‡†ç¡®æ€§ã€‚è€ŒFlinké€šè¿‡ä¸€ä¸ªæµå¤„ç†å°±èƒ½ä¿è¯æ•°æ®å‡†ç¡®æ€§ï¼Œä¹Ÿæ˜¯ä¾é äº†ä¸‹é¢ä¸‰ç‚¹ï¼š</p><blockquote><p>å‡†ç¡®è®¡ç®—æ€§çš„ä¸‰é‡ä¿è¯ï¼š</p><ol><li>watermarkï¼šå°†æ—¶é—´è¿›åº¦ç”±æ…¢çš„watermarkè°ƒæ§</li><li>allowedLatenessï¼šæ—¶é—´çª—å£ç»“æŸæ—¶é—´å°äºç­‰äºæ°´ä½çº¿åå¼€å§‹èšåˆè®¡ç®—ï¼Œè®¡ç®—ååˆæœ‰è¯¥æ—¶é—´èŒƒå›´å†…çš„æ•°æ®åˆ°è¾¾æ—¶ï¼Œè¿Ÿåˆ°çš„æ•°æ®æ¯ä¸ªå…ƒç´ è¿›å…¥éƒ½ä¼šå’ŒåŸçª—å£çš„ç»“æœè¿›è¡Œèšåˆ</li><li>ä¾§è¾“å‡ºæµï¼šæœ€åçš„æ•°æ®è¿›å…¥ä¾§è¾“å‡ºæµã€‚</li></ol></blockquote><hr><p>ä»¥ä¸‹ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œé€šè¿‡ä¸‰é‡ï¼šwatermarkå’Œæœ€å¤§å»¶è¿Ÿæ—¶é—´ã€å…è®¸è¿Ÿåˆ°æ—¶é—´ã€å’Œä¾§è¾“å‡ºæµä¿å­˜ä¸¢å¼ƒå…ƒç´ æ¥çœ‹å¤„ç†ä¹±åºå’Œè¿Ÿåˆ°æ•°æ®ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.flink.transform</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.&#123;<span class="type">ValueState</span>, <span class="type">ValueStateDescriptor</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.scala.typeutils.<span class="type">Types</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.<span class="type">TimeCharacteristic</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.timestamps.<span class="type">BoundedOutOfOrdernessTimestampExtractor</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.function.<span class="type">ProcessWindowFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows.<span class="type">TimeWindow</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">LaterDataDeal</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®äº‹ä»¶æ—¶é—´</span></span><br><span class="line">    env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">EventTime</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç«¯å£è¾“å…¥æ•°æ®</span></span><br><span class="line">    <span class="keyword">val</span> input: <span class="type">DataStream</span>[<span class="type">String</span>] = env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">9999</span>, &#x27;\n&#x27;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ•°æ®çš„æ”¹è£…</span></span><br><span class="line">    <span class="keyword">val</span> mapStream: <span class="type">DataStream</span>[(<span class="type">String</span>, <span class="type">Long</span>)] = input.map(x =&gt; &#123;</span><br><span class="line">      <span class="keyword">val</span> spilt: <span class="type">Array</span>[<span class="type">String</span>] = x.split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">      (spilt(<span class="number">0</span>), spilt(<span class="number">1</span>).toLong * <span class="number">1000</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®æ°´ä½çº¿å’Œæœ€å¤§å»¶è¿Ÿæ—¶é—´</span></span><br><span class="line">    <span class="keyword">val</span> preStream: <span class="type">WindowedStream</span>[(<span class="type">String</span>, <span class="type">Long</span>), <span class="type">String</span>, windows.<span class="type">TimeWindow</span>] = mapStream.assignTimestampsAndWatermarks(<span class="keyword">new</span> <span class="type">BoundedOutOfOrdernessTimestampExtractor</span>[(<span class="type">String</span>, <span class="type">Long</span>)](<span class="type">Time</span>.seconds(<span class="number">5</span>)) &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(t: (<span class="type">String</span>, <span class="type">Long</span>)): <span class="type">Long</span> = t._2</span><br><span class="line">    &#125;)</span><br><span class="line">      <span class="comment">// åˆ†ç»„+å¼€çª—</span></span><br><span class="line">      .keyBy(_._1)</span><br><span class="line">      .timeWindow(<span class="type">Time</span>.seconds(<span class="number">5</span>))</span><br><span class="line">      <span class="comment">// è®¾ç½®å…è®¸è¿Ÿåˆ°æ•°æ®çš„æ—¶é—´</span></span><br><span class="line">      .allowedLateness(<span class="type">Time</span>.seconds(<span class="number">5</span>))</span><br><span class="line">      <span class="comment">// è®¾ç½®è¿Ÿåˆ°çš„æ•°æ®ï¼Œä¾§è¾“å‡ºæµ</span></span><br><span class="line">      .sideOutputLateData(<span class="keyword">new</span> <span class="type">OutputTag</span>[(<span class="type">String</span>, <span class="type">Long</span>)](<span class="string">&quot;later&quot;</span>))</span><br><span class="line"></span><br><span class="line">    preStream</span><br><span class="line">      <span class="comment">// è®¾ç½®å¤„ç†å‡½æ•°ï¼Œéœ€è¦åŒæ—¶è€ƒè™‘åˆ°ç¬¬ä¸€æ¬¡å¤„ç†  å’Œ  å› ä¸ºå…è®¸è¿Ÿåˆ°æ•°æ®åˆ°æ¥æ—¶å’Œä¹‹å‰å¤„ç†ç»“æœåˆå¹¶æ—¶çš„è®¡ç®—æ‰“å°ä¸åŒçš„å€¼</span></span><br><span class="line">      .process(<span class="keyword">new</span> <span class="type">MyCount1</span>).print()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MyCount1</span> <span class="keyword">extends</span> <span class="title">ProcessWindowFunction</span>[(<span class="type">String</span>, <span class="type">Long</span>), <span class="type">String</span>, <span class="type">String</span>, <span class="type">TimeWindow</span>]</span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">process</span></span>(key: <span class="type">String</span>, context: <span class="type">Context</span>, elements: <span class="type">Iterable</span>[(<span class="type">String</span>, <span class="type">Long</span>)], out: <span class="type">Collector</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="comment">// è®¾ç½®æ¯ä¸ªçª—å£å•ç‹¬çš„çŠ¶æ€å˜é‡ï¼Œç”¨äºåŒºåˆ«æ˜¯æ°´ä½çº¿è¿‡çª—å£ç»“æŸæ—¶é—´æ—¶çš„è®¡ç®—ï¼ˆç¬¬ä¸€æ¬¡ï¼‰è¿˜æ˜¯å…è®¸è¿Ÿåˆ°æ•°æ®æ¥ä¸´æ—¶å€™çš„èšåˆè®¡ç®—ï¼ˆåå‡ æ¬¡ï¼‰ï¼Œåªç”¨äºæ‰“å°ä¸åŒçš„å€¼ï¼Œå®é™…ä¸Šé€»è¾‘ä¸å¿…åˆ†å¼€å†™</span></span><br><span class="line">      <span class="keyword">val</span> flag: <span class="type">ValueState</span>[<span class="type">Boolean</span>] = context.windowState.getState(<span class="keyword">new</span> <span class="type">ValueStateDescriptor</span>[<span class="type">Boolean</span>](<span class="string">&quot;flag&quot;</span>, <span class="type">Types</span>.of[<span class="type">Boolean</span>]))</span><br><span class="line"></span><br><span class="line">      <span class="comment">// flagé»˜è®¤false</span></span><br><span class="line">      <span class="comment">// falseæ—¶æ˜¯ç¬¬ä¸€æ¬¡è®¡ç®—ï¼Œå³æ°´ä½çº¿è¶…è¿‡çª—å£ç»“æŸæ—¶é—´æ—¶å€™</span></span><br><span class="line">      <span class="keyword">if</span> (!flag.value())&#123;</span><br><span class="line">        out.collect(<span class="string">s&quot;çª—å£å¼€å§‹ç¬¬ä¸€æ¬¡è®¡ç®—ï¼ˆæ°´ä½çº¿æ­¤æ—¶å·²ç»è¶…è¿‡çª—å£ç»“æŸæ—¶é—´ï¼‰ï¼Œæ­¤æ—¶çª—å£å†…çš„å…ƒç´ çš„ä¸ªæ•°ä¸º<span class="subst">$&#123;elements.size&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment">// æ›´æ–°çŠ¶æ€</span></span><br><span class="line">        flag.update(<span class="literal">true</span>)</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// æ­¤æ—¶æ˜¯å› ä¸ºå…è®¸è¿Ÿåˆ°æ•°æ®å¼€å§‹çš„èšåˆè®¡ç®—ï¼Œæ­¤æ—¶æ­¤çª—å£å·²ç»è®¡ç®—äº†ä¸€ä¸ªç»“æœï¼Œä½†æ˜¯å› ä¸ºå…è®¸è¿Ÿåˆ°æ•°æ®çš„æ—¶é—´æœªè¿‡ï¼Œæ‰€ä»¥çª—å£æœªå…³é—­ï¼Œæ­¤æ—¶æ¥ä¸€æ¡æ•°æ®éœ€è¦è®¡ç®—ä¸€æ¬¡</span></span><br><span class="line">        out.collect(<span class="string">s&quot;çª—å£æ•´åˆè¿Ÿåˆ°çš„æ•°æ®å¼€å§‹è®¡ç®—...ï¼Œæ­¤æ—¶çª—å£å†…çš„å…ƒç´ çš„ä¸ªæ•°ä¸º<span class="subst">$&#123;elements.size&#125;</span>&quot;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210102155853069.png" alt="image-20210102155853069"></p><p>å¯ä»¥çœ‹åˆ°å› ä¸ºæ°´ä½çº¿çš„å…³ç³»ï¼Œçª—å£[0,5)è™½ç„¶åœ¨äº‹ä»¶æ—¶é—´7åˆ°è¾¾æ—¶è¿˜æ²¡æœ‰è§¦å‘è®¡ç®—ï¼Œ7ä¹‹åçš„2è¿˜è¢«ç›´æ¥çº³å…¥äº†çª—å£[0,5)ï¼Œå½“äº‹ä»¶æ—¶é—´10åˆ°è¾¾æ—¶ï¼Œæ°´ä½çº¿å·²ç»åˆ°è¾¾äº†çª—å£çš„å…³é—­æ—¶é—´ï¼Œå¯¼è‡´çª—å£è®¡ç®—ï¼Œæ­¤æ—¶çª—å£å†…å…ƒç´ ä¸º3ã€‚</p><p>ç„¶åç»§ç»­è¾“å…¥çª—å£[0,5)çš„æ•°æ®</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210102160109858.png" alt="image-20210102160109858"></p><p>å‘ç°è¿Ÿåˆ°çš„æ•°æ®å†æ¬¡å’Œ[0,5)ä¹‹å‰çš„ç»“æœæ•´åˆè®¡ç®—ï¼Œè¿™æ˜¯å› ä¸ºè®¾ç½®äº†<code>.allowedLateness(Time.seconds(5))</code>å…è®¸è¿Ÿåˆ°çš„æ—¶é—´ä¸º5ï¼Œåœ¨æ­¤æ—¶é—´åŒºé—´å†…åˆ°è¾¾çš„æ•°æ®ä¼šæ¯æ¡å’Œä¹‹å‰çª—å£çš„è®¡ç®—ç»“æœè¿›è¡Œæ•´åˆè®¡ç®—ã€‚å½“è¶…è¿‡è¿™5ç§’æ—¶ï¼Œå†æ¬¡åˆ°è¾¾çš„[0,5)çª—å£æ•°æ®å°†è¢«ä¸¢å¼ƒã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210102160331132.png" alt="image-20210102160331132"></p><p>ç¬¬ä¸€ä¸ªæ˜¯[5,10)çš„çª—å£ï¼Œå½“å…è®¸è¶…æ—¶æ—¶é—´è¿‡å»åï¼Œå†æ¬¡è¾“å…¥[0,5)çª—å£æ•°æ®ï¼Œæ•°æ®è¢«ä¸¢å¼ƒï¼Œå­˜åˆ°äº†ä¾§è¾“å‡ºæµ<code>later</code></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;æˆ‘ä»¬å°†ä»‹ç»æ—¶é—´è¯­ä¹‰ï¼Œå¹¶æè¿°æµä¸­ä¸åŒçš„æ—¶é—´æ¦‚å¿µã€‚æˆ‘ä»¬å°†è®¨è®ºæµå¤„ç†å™¨åœ¨ä¹±åºäº‹ä»¶æµçš„æƒ…å†µä¸‹å¦‚ä½•æä¾›å‡†ç¡®çš„è®¡ç®—ç»“æœï¼Œä»¥åŠæˆ‘ä»¬å¦‚ä½•å¤„ç†å†å²äº‹ä»¶æµï¼Œå¦‚ä½•</summary>
      
    
    
    
    <category term="Flink" scheme="https://awslzhang.top/categories/Flink/"/>
    
    
    <category term="Flink" scheme="https://awslzhang.top/tags/Flink/"/>
    
  </entry>
  
  <entry>
    <title>Flink Apiå­¦ä¹ </title>
    <link href="https://awslzhang.top/2020/12/17/Flink-API/"/>
    <id>https://awslzhang.top/2020/12/17/Flink-API/</id>
    <published>2020-12-17T12:36:28.000Z</published>
    <updated>2021-01-02T10:05:23.110Z</updated>
    
    <content type="html"><![CDATA[<h1 id="DataStream-API"><a href="#DataStream-API" class="headerlink" title="DataStream API"></a>DataStream API</h1><p>æ‰€æœ‰çš„Flinkç¨‹åºéƒ½æ˜¯ç”±ä¸‰éƒ¨åˆ†ç»„æˆçš„ï¼š Source ã€Transformation å’Œ Sinkã€‚</p><p>Source è´Ÿè´£è¯»å–æ•°æ®æºï¼ŒTransformation åˆ©ç”¨å„ç§ç®—å­è¿›è¡Œå¤„ç†åŠ å·¥ï¼ŒSink è´Ÿè´£è¾“å‡ºã€‚</p><p>æ‰€ä»¥ç»ƒä¹ APIï¼ŒSourceæ˜¯å¿…ä¸å¯å°‘çš„ï¼Œæ²¡æœ‰æ•°æ®æºå°±æ²¡æœ‰ç¬¬ä¸€æ­¥ã€‚è¿™é‡Œä½¿ç”¨æ‰‹åŠ¨é€ æ•°æ®çš„æ–¹æ³•ï¼Œè€ŒFlinkæä¾›äº†ä¸€ä¸‹æ–¹å¼ã€‚</p><h2 id="æ­å»ºæ‰§è¡Œç¯å¢ƒ"><a href="#æ­å»ºæ‰§è¡Œç¯å¢ƒ" class="headerlink" title="æ­å»ºæ‰§è¡Œç¯å¢ƒ"></a>æ­å»ºæ‰§è¡Œç¯å¢ƒ</h2><p>ç¼–å†™Flinkç¨‹åºçš„ç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯æ­å»ºæ‰§è¡Œç¯å¢ƒã€‚æ‰§è¡Œç¯å¢ƒå†³å®šäº†ç¨‹åºæ˜¯è¿è¡Œåœ¨å•æœºä¸Šè¿˜æ˜¯é›†ç¾¤ä¸Šã€‚åœ¨DataStream APIä¸­ï¼Œç¨‹åºçš„æ‰§è¡Œç¯å¢ƒæ˜¯ç”±StreamExecutionEnvironmentè®¾ç½®çš„ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨é™æ€getExecutionEnvironment()æ–¹æ³•æ¥è·å–æ‰§è¡Œç¯å¢ƒã€‚è¿™ä¸ªæ–¹æ³•æ ¹æ®è°ƒç”¨æ–¹æ³•çš„ä¸Šä¸‹æ–‡ï¼Œè¿”å›ä¸€ä¸ªæœ¬åœ°çš„æˆ–è€…è¿œç¨‹çš„ç¯å¢ƒã€‚å¦‚æœè¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯æäº¤åˆ°è¿œç¨‹é›†ç¾¤çš„ä»£ç è°ƒç”¨çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•å°†ä¼šè¿”å›ä¸€ä¸ªè¿œç¨‹çš„æ‰§è¡Œç¯å¢ƒã€‚å¦åˆ™ï¼Œå°†è¿”å›æœ¬åœ°æ‰§è¡Œç¯å¢ƒã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create a local stream execution environment</span></span><br><span class="line"><span class="keyword">val</span> localEnv = <span class="type">StreamExecutionEnvironment</span></span><br><span class="line">  .createLocalEnvironment()</span><br><span class="line"><span class="comment">// create a remote stream execution environment</span></span><br><span class="line"><span class="keyword">val</span> remoteEnv = <span class="type">StreamExecutionEnvironment</span></span><br><span class="line">  .createRemoteEnvironment(</span><br><span class="line">    <span class="string">&quot;host&quot;</span>, <span class="comment">// hostname of JobManager</span></span><br><span class="line">    <span class="number">1234</span>, <span class="comment">// port of JobManager process</span></span><br><span class="line">    <span class="string">&quot;path/to/jarFile.jar&quot;</span></span><br><span class="line">  ) <span class="comment">// JAR file to ship to the JobManager</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime)</code>æ¥å°†æˆ‘ä»¬ç¨‹åºçš„æ—¶é—´è¯­ä¹‰è®¾ç½®ä¸ºäº‹ä»¶æ—¶é—´ã€‚æ‰§è¡Œç¯å¢ƒæä¾›äº†å¾ˆå¤šé…ç½®é€‰é¡¹ï¼Œä¾‹å¦‚ï¼šè®¾ç½®ç¨‹åºçš„å¹¶è¡Œåº¦å’Œç¨‹åºæ˜¯å¦å¼€å¯å®¹é”™æœºåˆ¶ã€‚</p><h2 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h2><ul><li>ä»é›†åˆä¸­è¯»å–ï¼šfromElementsã€fromCollection</li><li>ä»æ–‡ä»¶ä¸­è¯»å–ï¼šreadTextFile</li><li>ä»ç½‘ç»œsockï¼šsocketTextStream</li><li>Kafkaæ•°æ®æº ï¼šï¼ˆé¢å¤–å¯¼åŒ…ï¼‰</li></ul><h3 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h3><p><strong>pom</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-kafka-0.10_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>0.10æ˜¯Kafkaç‰ˆæœ¬</p></blockquote><p>ä½¿ç”¨addSourceé€šç”¨æ•°æ®æºï¼ŒaddSource(SourceFunction)ï¼Œä½¿ç”¨å¯Œå‡½æ•°SourceFunctionï¼ˆéœ€è¦éšå¼è½¬æ¢ï¼‰ä¹Ÿå¯ä»¥ã€‚ä¸‹é¢çš„è‡ªå®šä¹‰æ•°æ®æºå°±æ˜¯è¿™ä¸ªåŸç†ã€‚</p><p>æ—¢ç„¶addSourceéœ€è¦SourceFunctionçš„å‚æ•°éš¾é“ç”¨æˆ‘ä»¬è‡ªå·±å®ç°å—ï¼Œä¸ç”¨ï¼Œæ—¢ç„¶æˆ‘ä»¬å¯¼äº†åŒ…å°±èƒ½ç›´æ¥ç”¨ç°æˆçš„ï¼</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> kafkaProps = <span class="keyword">new</span> <span class="type">Properties</span>()</span><br><span class="line"> kafkaProps.setProperty(<span class="string">&quot;zookeeper.connect&quot;</span>, <span class="type">ZOOKEEPER_HOST</span>)</span><br><span class="line"> kafkaProps.setProperty(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="type">KAFKA_BROKER</span>)</span><br><span class="line"> kafkaProps.setProperty(<span class="string">&quot;group.id&quot;</span>, <span class="type">TRANSACTION_GROUP</span>)</span><br><span class="line"></span><br><span class="line"> <span class="comment">//topicdçš„åå­—æ˜¯newï¼Œschemaé»˜è®¤ä½¿ç”¨SimpleStringSchema()å³å¯</span></span><br><span class="line"> <span class="keyword">val</span> transaction = env</span><br><span class="line">   .addSource(</span><br><span class="line">     <span class="keyword">new</span> <span class="type">FlinkKafkaConsumer08</span>[<span class="type">String</span>](<span class="string">&quot;new&quot;</span>, <span class="keyword">new</span> <span class="type">SimpleStringSchema</span>(), kafkaProps)</span><br><span class="line">   )</span><br></pre></td></tr></table></figure><h3 id="è‡ªå®šä¹‰"><a href="#è‡ªå®šä¹‰" class="headerlink" title="è‡ªå®šä¹‰"></a>è‡ªå®šä¹‰</h3><p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ¸©åº¦å™¨ï¼Œå¹¶éšæœºå®ƒçš„æ•°æ®ï¼š</p><p><strong>åˆ›å»ºæ•°æ®ç»“æ„</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zxjgg.source</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">SensorReading</span>(<span class="params">id: <span class="type">String</span>, temperature: <span class="type">Double</span>, timestamp: <span class="type">Long</span></span>)</span></span><br></pre></td></tr></table></figure><p><strong>ç”Ÿæˆæ•°æ®</strong></p><p>éœ€è¦é›†æˆFlinkçš„ç±»ï¼Œå› ä¸ºä¹‹åè¦ç”¨Flinkæ¥å¤„ç†è¿™äº›æ•°æ®</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zxjgg.source</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.source.&#123;<span class="type">RichParallelSourceFunction</span>, <span class="type">SourceFunction</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scala.util.<span class="type">Random</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SensorSource</span> <span class="keyword">extends</span> <span class="title">RichParallelSourceFunction</span>[<span class="type">SensorReading</span>] </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> running: <span class="type">Boolean</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>(sourceContext: <span class="type">SourceFunction</span>.<span class="type">SourceContext</span>[<span class="type">SensorReading</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> random = <span class="keyword">new</span> <span class="type">Random</span>()</span><br><span class="line">    <span class="keyword">val</span> result = (<span class="number">1</span> to <span class="number">10</span>).map(x =&gt; (x + <span class="string">&quot;&quot;</span>, random.nextGaussian() * <span class="number">20</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (running) &#123;</span><br><span class="line">      result.map(x =&gt; (x._1, x._2 + random.nextGaussian() * <span class="number">0.5</span>))</span><br><span class="line">      result.foreach(x =&gt; sourceContext.collect(<span class="type">SensorReading</span>(x._1, x._2, <span class="type">System</span>.currentTimeMillis())))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">cancel</span></span>(): <span class="type">Unit</span> = running = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æµ‹è¯•æ•°æ®å¤„ç†</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zxjgg.source</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> value:<span class="type">DataStream</span>[<span class="type">SensorReading</span>] = env.addSource(<span class="keyword">new</span> <span class="type">SensorSource</span>)</span><br><span class="line">    value.print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°Flinkç¨‹åºçš„å®šä¹‰å’Œæäº¤æ‰§è¡Œä½¿ç”¨çš„å°±æ˜¯æ­£å¸¸çš„Scalaæˆ–è€…Javaçš„æ–¹æ³•ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™äº›ä»£ç éƒ½å†™åœ¨ä¸€ä¸ªé™æ€mainæ–¹æ³•ä¸­ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†Testå¯¹è±¡ï¼Œç„¶åå°†å¤§å¤šæ•°çš„åº”ç”¨ç¨‹åºé€»è¾‘æ”¾åœ¨äº†main()ä¸­ã€‚</p><p>Flinkæµå¤„ç†ç¨‹åºçš„ç»“æ„å¦‚ä¸‹ï¼š</p><ol><li>åˆ›å»ºFlinkç¨‹åºæ‰§è¡Œç¯å¢ƒã€‚</li><li>ä»æ•°æ®æºè¯»å–ä¸€æ¡æˆ–è€…å¤šæ¡æµæ•°æ®</li><li>ä½¿ç”¨æµè½¬æ¢ç®—å­å®ç°ä¸šåŠ¡é€»è¾‘</li><li>å°†è®¡ç®—ç»“æœè¾“å‡ºåˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªå¤–éƒ¨è®¾å¤‡ï¼ˆå¯é€‰ï¼‰</li><li>æ‰§è¡Œç¨‹åº</li></ol><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¯¦ç»†çš„å­¦ä¹ ä¸€ä¸‹è¿™äº›éƒ¨åˆ†ã€‚</p><h2 id="Sink"><a href="#Sink" class="headerlink" title="Sink"></a>Sink</h2><p>Flinkæ²¡æœ‰ç±»ä¼¼äºsparkä¸­foreachæ–¹æ³•ï¼Œè®©ç”¨æˆ·è¿›è¡Œè¿­ä»£çš„æ“ä½œã€‚è™½æœ‰å¯¹å¤–çš„è¾“å‡ºæ“ä½œéƒ½è¦åˆ©ç”¨Sinkå®Œæˆã€‚æœ€åé€šè¿‡ç±»ä¼¼å¦‚ä¸‹æ–¹å¼å®Œæˆæ•´ä¸ªä»»åŠ¡æœ€ç»ˆè¾“å‡ºæ“ä½œã€‚</p><p><code> stream.addSink(new MySink(xxxx))</code></p><p>å®˜æ–¹æä¾›äº†ä¸€éƒ¨åˆ†çš„æ¡†æ¶çš„sinkã€‚é™¤æ­¤ä»¥å¤–ï¼Œéœ€è¦ç”¨æˆ·è‡ªå®šä¹‰å®ç°sinkã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210101142032322.png" alt="image-20210101142032322"></p><p>ç¬¬ä¸‰æ–¹ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210101142045980.png" alt="image-20210101142045980"></p><p>å…¶ä»–çš„éœ€è¦è‡ªå®šä¹‰ï¼ï¼</p><h3 id="Kafka-1"><a href="#Kafka-1" class="headerlink" title="Kafka"></a>Kafka</h3><p>ç»§ä¸Šé¢çš„Kafkaçš„Sourceï¼Œç»§ç»­å†™Sink</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dataStream.addSink(<span class="keyword">new</span> <span class="type">FlinkKafkaProducer011</span>[<span class="type">String</span>](<span class="string">&quot;localhost:9092&quot;</span>, <span class="string">&quot;topic&quot;</span>, <span class="keyword">new</span> <span class="type">SimpleStringSchema</span>()))</span><br></pre></td></tr></table></figure><h3 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h3><p>å› ä¸ºå®˜æ–¹æ²¡æœ‰Redisçš„Sinkï¼Œä½†æ˜¯Bahiræä¾›äº†ã€‚æ‰€ä»¥éœ€è¦å¼•å…¥å®ƒçš„åŒ…ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.bahir<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-redis_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å®šä¹‰ä¸€ä¸ªredisçš„mapperç±»ï¼Œç”¨äºå®šä¹‰ä¿å­˜åˆ°redisæ—¶è°ƒç”¨çš„å‘½ä»¤ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyRedisMapper</span> <span class="keyword">extends</span> <span class="title">RedisMapper</span>[<span class="type">SensorReading</span>]</span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getCommandDescription</span></span>: <span class="type">RedisCommandDescription</span> = &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="type">RedisCommandDescription</span>(<span class="type">RedisCommand</span>.<span class="type">HSET</span>, <span class="string">&quot;sensor_temperature&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getValueFromData</span></span>(t: <span class="type">SensorReading</span>): <span class="type">String</span> = t.temperature.toString</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getKeyFromData</span></span>(t: <span class="type">SensorReading</span>): <span class="type">String</span> = t.id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸»å‡½æ•°ä¸­è°ƒç”¨ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">FlinkJedisPoolConfig</span>.<span class="type">Builder</span>().setHost(<span class="string">&quot;localhost&quot;</span>).setPort(<span class="number">6379</span>).build()</span><br><span class="line">dataStream.addSink( <span class="keyword">new</span> <span class="type">RedisSink</span>[<span class="type">SensorReading</span>](conf, <span class="keyword">new</span> <span class="type">MyRedisMapper</span>))</span><br></pre></td></tr></table></figure><h3 id="ElasticSearch"><a href="#ElasticSearch" class="headerlink" title="ElasticSearch"></a>ElasticSearch</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-elasticsearch6_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸»å‡½æ•°ä¸­è°ƒç”¨</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> httpHosts = <span class="keyword">new</span> util.<span class="type">ArrayList</span>[<span class="type">HttpHost</span>]()</span><br><span class="line">httpHosts.add(<span class="keyword">new</span> <span class="type">HttpHost</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">9200</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> esSinkBuilder = <span class="keyword">new</span> <span class="type">ElasticsearchSink</span>.<span class="type">Builder</span>[<span class="type">SensorReading</span>]( httpHosts, <span class="keyword">new</span> <span class="type">ElasticsearchSinkFunction</span>[<span class="type">SensorReading</span>] &#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">process</span></span>(t: <span class="type">SensorReading</span>, runtimeContext: <span class="type">RuntimeContext</span>, requestIndexer: <span class="type">RequestIndexer</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    println(<span class="string">&quot;saving data: &quot;</span> + t)</span><br><span class="line">    <span class="keyword">val</span> json = <span class="keyword">new</span> util.<span class="type">HashMap</span>[<span class="type">String</span>, <span class="type">String</span>]()</span><br><span class="line">    json.put(<span class="string">&quot;data&quot;</span>, t.toString)</span><br><span class="line">    <span class="keyword">val</span> indexRequest = <span class="type">Requests</span>.indexRequest().index(<span class="string">&quot;sensor&quot;</span>).`<span class="class"><span class="keyword">type</span>`(<span class="params">&quot;readingData&quot;</span>).<span class="title">source</span>(<span class="params">json</span>)</span></span><br><span class="line"><span class="class">    <span class="title">requestIndexer</span>.<span class="title">add</span>(<span class="params">indexRequest</span>)</span></span><br><span class="line"><span class="class">    <span class="title">println</span>(<span class="params">&quot;saved successfully&quot;</span>)</span></span><br><span class="line"><span class="class">  &#125;</span></span><br><span class="line"><span class="class">&#125; )</span></span><br><span class="line"><span class="class"><span class="title">dataStream</span>.<span class="title">addSink</span>(<span class="params"> esSinkBuilder.build(</span>) )</span></span><br><span class="line"><span class="class"></span></span><br></pre></td></tr></table></figure><h3 id="JDBC-1-10æ²¡æœ‰"><a href="#JDBC-1-10æ²¡æœ‰" class="headerlink" title="JDBC(1.10æ²¡æœ‰)"></a>JDBC(1.10æ²¡æœ‰)</h3><p><strong>1.11åæœ‰ï¼Œè¿™ç§ä¸å¤Ÿçµæ´»ï¼Œä¸èƒ½æ ¹æ®æƒ…å†µè¿›è¡Œæ’å…¥æˆ–è€…æ›´æ–°ã€‚</strong></p><p><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/jdbc.html">Apache Flink 1.12 Documentation: JDBC Connector</a></p><p>This connector provides a sink that writes data to a JDBC database.</p><p>To use it, add the following dependency to your project (along with your JDBC-driver):</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-jdbc_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Note that the streaming connectors are currently <strong>NOT</strong> part of the binary distribution. See how to link with them for cluster execution <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/project-configuration.html">here</a>.</p><p>Created JDBC sink provides at-least-once guarantee. Effectively exactly-once can be achieved using upsert statements or idempotent updates.</p><p>Example usage:</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">StreamExecutionEnvironment</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment();</span><br><span class="line">env</span><br><span class="line">        .fromElements(...)</span><br><span class="line">        .addSink(<span class="type">JdbcSink</span>.sink(</span><br><span class="line">                <span class="string">&quot;insert into books (id, title, author, price, qty) values (?,?,?,?,?)&quot;</span>,</span><br><span class="line">                (ps, t) -&gt; &#123;</span><br><span class="line">                    ps.setInt(<span class="number">1</span>, t.id);</span><br><span class="line">                    ps.setString(<span class="number">2</span>, t.title);</span><br><span class="line">                    ps.setString(<span class="number">3</span>, t.author);</span><br><span class="line">                    ps.setDouble(<span class="number">4</span>, t.price);</span><br><span class="line">                    ps.setInt(<span class="number">5</span>, t.qty);</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="type">JdbcConnectionOptions</span>.<span class="type">JdbcConnectionOptionsBuilder</span>()</span><br><span class="line">                        .withUrl(getDbMetadata().getUrl())</span><br><span class="line">                        .withDriverName(getDbMetadata().getDriverClass())</span><br><span class="line">                        .build()));</span><br><span class="line">env.execute();</span><br></pre></td></tr></table></figure><p>Please refer to the <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/api/java/org/apache/flink/connector/jdbc/JdbcSink.html">API documentation</a> for more details.</p><h4 id="è‡ªå®šä¹‰-1"><a href="#è‡ªå®šä¹‰-1" class="headerlink" title="è‡ªå®šä¹‰"></a>è‡ªå®šä¹‰</h4><p>1.10ä»¥åŠä»¥å‰æ²¡æœ‰å®˜æ–¹çš„ï¼Œéœ€è¦è‡ªå®šä¹‰ã€‚éœ€è¦ä½¿ç”¨å¯Œå‡½æ•°çš„<code>SinkFunction</code>ï¼Œä½¿ç”¨å¯Œå‡½æ•°çš„ç”Ÿå‘½å‘¨æœŸæ¥åˆ›å»ºå’Œå…³é—­JDBCçš„è¿æ¥</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyJdbcSink</span>(<span class="params"></span>) <span class="keyword">extends</span> <span class="title">RichSinkFunction</span>[<span class="type">SensorReading</span>]</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> conn: <span class="type">Connection</span> = _</span><br><span class="line">  <span class="keyword">var</span> insertStmt: <span class="type">PreparedStatement</span> = _</span><br><span class="line">  <span class="keyword">var</span> updateStmt: <span class="type">PreparedStatement</span> = _</span><br><span class="line"></span><br><span class="line">  <span class="comment">// open ä¸»è¦æ˜¯åˆ›å»ºè¿æ¥</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">open</span></span>(parameters: <span class="type">Configuration</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">super</span>.open(parameters)</span><br><span class="line"></span><br><span class="line">    conn = <span class="type">DriverManager</span>.getConnection(<span class="string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>, <span class="string">&quot;root&quot;</span>, <span class="string">&quot;123456&quot;</span>)</span><br><span class="line">    insertStmt = conn.prepareStatement(<span class="string">&quot;INSERT INTO temperatures (sensor, temp) VALUES (?, ?)&quot;</span>)</span><br><span class="line">    updateStmt = conn.prepareStatement(<span class="string">&quot;UPDATE temperatures SET temp = ? WHERE sensor = ?&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è°ƒç”¨è¿æ¥ï¼Œæ‰§è¡Œsql</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">invoke</span></span>(value: <span class="type">SensorReading</span>, context: <span class="type">SinkFunction</span>.<span class="type">Context</span>[_]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    </span><br><span class="line">updateStmt.setDouble(<span class="number">1</span>, value.temperature)</span><br><span class="line">    updateStmt.setString(<span class="number">2</span>, value.id)</span><br><span class="line">    updateStmt.execute()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (updateStmt.getUpdateCount == <span class="number">0</span>) &#123;</span><br><span class="line">      insertStmt.setString(<span class="number">1</span>, value.id)</span><br><span class="line">      insertStmt.setDouble(<span class="number">2</span>, value.temperature)</span><br><span class="line">      insertStmt.execute()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">close</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">    insertStmt.close()</span><br><span class="line">    updateStmt.close()</span><br><span class="line">    conn.close()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è½¬æ¢ç®—å­"><a href="#è½¬æ¢ç®—å­" class="headerlink" title="è½¬æ¢ç®—å­"></a><a href="#%E8%BD%AC%E6%8D%A2%E7%AE%97%E5%AD%90">è½¬æ¢ç®—å­</a></h2><p>åœ¨è¿™ä¸€å°èŠ‚æˆ‘ä»¬å°†å¤§æ¦‚çœ‹ä¸€ä¸‹DataStream APIçš„åŸºæœ¬è½¬æ¢ç®—å­ã€‚ä¸æ—¶é—´æœ‰å…³çš„æ“ä½œç¬¦ï¼ˆä¾‹å¦‚çª—å£æ“ä½œç¬¦å’Œå…¶ä»–ç‰¹æ®Šçš„è½¬æ¢ç®—å­ï¼‰å°†ä¼šåœ¨åé¢çš„ç« èŠ‚å™è¿°ã€‚ä¸€ä¸ªæµçš„è½¬æ¢æ“ä½œå°†ä¼šåº”ç”¨åœ¨ä¸€ä¸ªæˆ–è€…å¤šä¸ªæµä¸Šé¢ï¼Œè¿™äº›è½¬æ¢æ“ä½œå°†æµè½¬æ¢æˆä¸€ä¸ªæˆ–è€…å¤šä¸ªè¾“å‡ºæµã€‚ç¼–å†™ä¸€ä¸ªDataStream APIç®€å•æ¥è¯´å°±æ˜¯å°†è¿™äº›è½¬æ¢ç®—å­ç»„åˆåœ¨ä¸€èµ·æ¥æ„å»ºä¸€ä¸ªæ•°æ®æµå›¾ï¼Œè¿™ä¸ªæ•°æ®æµå›¾å°±å®ç°äº†æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘ã€‚</p><p><font color="red"><strong>å¤§éƒ¨åˆ†çš„æµè½¬æ¢æ“ä½œéƒ½åŸºäºç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°UDF</strong></font>ã€‚UDFå‡½æ•°æ‰“åŒ…äº†ä¸€äº›ä¸šåŠ¡é€»è¾‘å¹¶å®šä¹‰äº†è¾“å…¥æµçš„å…ƒç´ å¦‚ä½•è½¬æ¢æˆè¾“å‡ºæµçš„å…ƒç´ ã€‚åƒ<code>MapFunction</code>è¿™æ ·çš„å‡½æ•°ï¼Œå°†ä¼šè¢«å®šä¹‰ä¸ºç±»ï¼Œè¿™ä¸ªç±»å®ç°äº†Flinké’ˆå¯¹ç‰¹å®šçš„è½¬æ¢æ“ä½œæš´éœ²å‡ºæ¥çš„æ¥å£ã€‚è™½ç„¶åŒ¿åå‡½æ•°å¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯é€»è¾‘å¤æ‚æ—¶è¿‡é•¿çš„åŒ¿åå‡½æ•°ä¼šæ˜¾å¾—é€»è¾‘æ··ä¹±ã€‚</p><p>DataStream APIé’ˆå¯¹å¤§å¤šæ•°æ•°æ®è½¬æ¢æ“ä½œæä¾›äº†è½¬æ¢ç®—å­ã€‚å¦‚æœä½ å¾ˆç†Ÿæ‚‰æ‰¹å¤„ç†APIã€å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€æˆ–è€…SQLï¼Œé‚£ä¹ˆä½ å°†ä¼šå‘ç°è¿™äº›APIå¾ˆå®¹æ˜“å­¦ä¹ ã€‚æˆ‘ä»¬ä¼šå°†DataStream APIçš„è½¬æ¢ç®—å­åˆ†æˆå››ç±»ï¼š</p><ul><li>åŸºæœ¬è½¬æ¢ç®—å­ï¼šå°†ä¼šä½œç”¨åœ¨æ•°æ®æµä¸­çš„æ¯ä¸€æ¡å•ç‹¬çš„æ•°æ®ä¸Šã€‚</li><li>KeyedStreamè½¬æ¢ç®—å­ï¼šåœ¨æ•°æ®æœ‰keyçš„æƒ…å†µä¸‹ï¼Œå¯¹æ•°æ®åº”ç”¨è½¬æ¢ç®—å­ã€‚</li><li>å¤šæµè½¬æ¢ç®—å­ï¼šåˆå¹¶å¤šæ¡æµä¸ºä¸€æ¡æµæˆ–è€…å°†ä¸€æ¡æµåˆ†å‰²ä¸ºå¤šæ¡æµã€‚</li><li>åˆ†å¸ƒå¼è½¬æ¢ç®—å­ï¼šå°†é‡æ–°ç»„ç»‡æµé‡Œé¢çš„äº‹ä»¶ã€‚</li></ul><h3 id="åŸºæœ¬è½¬æ¢ç®—å­"><a href="#åŸºæœ¬è½¬æ¢ç®—å­" class="headerlink" title="åŸºæœ¬è½¬æ¢ç®—å­"></a><a href="#%E5%9F%BA%E6%9C%AC%E8%BD%AC%E6%8D%A2%E7%AE%97%E5%AD%90">åŸºæœ¬è½¬æ¢ç®—å­</a></h3><p><strong>åŸºæœ¬è½¬æ¢ç®—å­ä¼šé’ˆå¯¹æµä¸­çš„æ¯ä¸€ä¸ªå•ç‹¬çš„äº‹ä»¶åšå¤„ç†ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸€ä¸ªè¾“å…¥æ•°æ®ä¼šäº§ç”Ÿä¸€ä¸ªè¾“å‡ºæ•°æ®ã€‚</strong>å•å€¼è½¬æ¢ï¼Œæ•°æ®çš„åˆ†å‰²ï¼Œæ•°æ®çš„è¿‡æ»¤ï¼Œéƒ½æ˜¯åŸºæœ¬è½¬æ¢æ“ä½œçš„å…¸å‹ä¾‹å­ã€‚æˆ‘ä»¬å°†è§£é‡Šè¿™äº›ç®—å­çš„è¯­ä¹‰å¹¶æä¾›ç¤ºä¾‹ä»£ç ã€‚</p><h4 id="MAP"><a href="#MAP" class="headerlink" title="MAP"></a><em>MAP</em></h4><p><code>map</code>ç®—å­é€šè¿‡è°ƒç”¨<code>DataStream.map()</code>æ¥æŒ‡å®šã€‚<code>map</code>ç®—å­çš„ä½¿ç”¨å°†ä¼šäº§ç”Ÿä¸€æ¡æ–°çš„æ•°æ®æµã€‚å®ƒä¼šå°†æ¯ä¸€ä¸ªè¾“å…¥çš„äº‹ä»¶ä¼ é€åˆ°ä¸€ä¸ªç”¨æˆ·è‡ªå®šä¹‰çš„mapperï¼Œè¿™ä¸ªmapperåªè¿”å›ä¸€ä¸ªè¾“å‡ºäº‹ä»¶ï¼Œè¿™ä¸ªè¾“å‡ºäº‹ä»¶å’Œè¾“å…¥äº‹ä»¶çš„ç±»å‹å¯èƒ½ä¸ä¸€æ ·ã€‚ä¸‹å›¾å±•ç¤ºäº†ä¸€ä¸ªmapç®—å­ï¼Œè¿™ä¸ªmapå°†æ¯ä¸€ä¸ªæ­£æ–¹å½¢è½¬åŒ–æˆäº†åœ†å½¢ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/spaf_0501.png" alt="img"></p><p><code>MapFunction</code>çš„ç±»å‹ä¸è¾“å…¥äº‹ä»¶å’Œè¾“å‡ºäº‹ä»¶çš„ç±»å‹ç›¸å…³ï¼Œå¯ä»¥é€šè¿‡å®ç°<code>MapFunction</code>æ¥å£æ¥å®šä¹‰ã€‚æ¥å£åŒ…å«<code>map()</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°†ä¸€ä¸ªè¾“å…¥äº‹ä»¶æ°å¥½è½¬æ¢ä¸ºä¸€ä¸ªè¾“å‡ºäº‹ä»¶ã€‚</p><p>ä¸‹é¢çš„ä»£ç å®ç°äº†å°†SensorReadingä¸­çš„idå­—æ®µæŠ½å–å‡ºæ¥çš„åŠŸèƒ½ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> readings: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = ...</span><br><span class="line"><span class="keyword">val</span> sensorIds: <span class="type">DataStream</span>[<span class="type">String</span>] = readings.map(<span class="keyword">new</span> <span class="type">IdExtractor</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IdExtractor</span> <span class="keyword">extends</span> <span class="title">MapFunction</span>[<span class="type">SensorReading</span>, <span class="type">String</span>] </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">map</span></span>(r: <span class="type">SensorReading</span>) : <span class="type">String</span> = r.id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶æˆ‘ä»¬æ›´æ¨èåŒ¿åå‡½æ•°çš„å†™æ³•ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> sensorIds: <span class="type">DataStream</span>[<span class="type">String</span>] = filteredReadings.map(r =&gt; r.id)</span><br></pre></td></tr></table></figure><h4 id="FILTER"><a href="#FILTER" class="headerlink" title="FILTER"></a><em>FILTER</em></h4><p><code>filter</code>è½¬æ¢ç®—å­é€šè¿‡åœ¨æ¯ä¸ªè¾“å…¥äº‹ä»¶ä¸Šå¯¹ä¸€ä¸ªå¸ƒå°”æ¡ä»¶è¿›è¡Œæ±‚å€¼æ¥è¿‡æ»¤æ‰ä¸€äº›å…ƒç´ ï¼Œç„¶åå°†å‰©ä¸‹çš„å…ƒç´ ç»§ç»­å‘é€ã€‚ä¸€ä¸ª<code>true</code>çš„æ±‚å€¼ç»“æœå°†ä¼šæŠŠè¾“å…¥äº‹ä»¶ä¿ç•™ä¸‹æ¥å¹¶å‘é€åˆ°è¾“å‡ºï¼Œè€Œå¦‚æœæ±‚å€¼ç»“æœä¸º<code>false</code>ï¼Œåˆ™è¾“å…¥äº‹ä»¶ä¼šè¢«æŠ›å¼ƒæ‰ã€‚æˆ‘ä»¬é€šè¿‡è°ƒç”¨<code>DataStream.filter()</code>æ¥æŒ‡å®šæµçš„<code>filter</code>ç®—å­ï¼Œ<code>filter</code>æ“ä½œå°†äº§ç”Ÿä¸€æ¡æ–°çš„æµï¼Œå…¶ç±»å‹å’Œè¾“å…¥æµä¸­çš„äº‹ä»¶ç±»å‹æ˜¯ä¸€æ ·çš„ã€‚ä¸‹å›¾å±•ç¤ºäº†åªäº§ç”Ÿç™½è‰²æ–¹æ¡†çš„<code>filter</code>æ“ä½œã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/spaf_0502.png" alt="img"></p><p>å¸ƒå°”æ¡ä»¶å¯ä»¥ä½¿ç”¨å‡½æ•°ã€FilterFunctionæ¥å£æˆ–è€…åŒ¿åå‡½æ•°æ¥å®ç°ã€‚FilterFunctionä¸­çš„æ³›å‹æ˜¯è¾“å…¥äº‹ä»¶çš„ç±»å‹ã€‚å®šä¹‰çš„<code>filter()</code>æ–¹æ³•ä¼šä½œç”¨åœ¨æ¯ä¸€ä¸ªè¾“å…¥å…ƒç´ ä¸Šé¢ï¼Œå¹¶è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚</p><p>ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨filteræ¥ä»ä¼ æ„Ÿå™¨æ•°æ®ä¸­è¿‡æ»¤æ‰æ¸©åº¦å€¼å°äº25åæ°æ¸©åº¦çš„è¯»æ•°ã€‚</p><p><code>val filteredReadings = readings.filter(r =&gt; r.temperature &gt;= 25)</code></p><h4 id="FLATMAP"><a href="#FLATMAP" class="headerlink" title="FLATMAP"></a><em>FLATMAP</em></h4><p><code>flatMap</code>ç®—å­å’Œ<code>map</code>ç®—å­å¾ˆç±»ä¼¼ï¼Œä¸åŒä¹‹å¤„åœ¨äºé’ˆå¯¹æ¯ä¸€ä¸ªè¾“å…¥äº‹ä»¶<code>flatMap</code>å¯ä»¥ç”Ÿæˆ0ä¸ªã€1ä¸ªæˆ–è€…å¤šä¸ªè¾“å‡ºå…ƒç´ ã€‚äº‹å®ä¸Šï¼Œ<code>flatMap</code>è½¬æ¢ç®—å­æ˜¯<code>filter</code>å’Œ<code>map</code>çš„æ³›åŒ–ã€‚æ‰€ä»¥<code>flatMap</code>å¯ä»¥å®ç°<code>map</code>å’Œ<code>filter</code>ç®—å­çš„åŠŸèƒ½ã€‚ä¸‹å›¾å±•ç¤ºäº†<code>flatMap</code>å¦‚ä½•æ ¹æ®è¾“å…¥äº‹ä»¶çš„é¢œè‰²æ¥åšä¸åŒçš„å¤„ç†ã€‚å¦‚æœè¾“å…¥äº‹ä»¶æ˜¯ç™½è‰²æ–¹æ¡†ï¼Œåˆ™ç›´æ¥è¾“å‡ºã€‚è¾“å…¥å…ƒç´ æ˜¯é»‘æ¡†ï¼Œåˆ™å¤åˆ¶è¾“å…¥ã€‚ç°è‰²æ–¹æ¡†ä¼šè¢«è¿‡æ»¤æ‰ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/spaf_0503.png" alt="img"></p><p>flatMapç®—å­å°†ä¼šåº”ç”¨åœ¨æ¯ä¸€ä¸ªè¾“å…¥äº‹ä»¶ä¸Šé¢ã€‚å¯¹åº”çš„<code>FlatMapFunction</code>å®šä¹‰äº†<code>flatMap()</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›0ä¸ªã€1ä¸ªæˆ–è€…å¤šä¸ªäº‹ä»¶åˆ°ä¸€ä¸ª<code>Collector</code>é›†åˆä¸­ï¼Œä½œä¸ºè¾“å‡ºç»“æœã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; T: the type of input elements</span><br><span class="line">&#x2F;&#x2F; O: the type of output elements</span><br><span class="line">FlatMapFunction[T, O]</span><br><span class="line">    &gt; flatMap(T, Collector[O]): Unit</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†åœ¨æ•°æ®åˆ†ææ•™ç¨‹ä¸­ç»å¸¸ç”¨åˆ°çš„ä¾‹å­ï¼Œæˆ‘ä»¬ç”¨<code>flatMap</code>æ¥å®ç°ã€‚ä½¿ç”¨<code>_</code>æ¥åˆ‡å‰²ä¼ æ„Ÿå™¨IDï¼Œæ¯”å¦‚<code>sensor_1</code>ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IdSplitter</span> <span class="keyword">extends</span> <span class="title">FlatMapFunction</span>[<span class="type">String</span>, <span class="type">String</span>] </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">flatMap</span></span>(id: <span class="type">String</span>, out: <span class="type">Collector</span>[<span class="type">String</span>]) : <span class="type">Unit</span> = &#123;</span><br><span class="line">        <span class="keyword">val</span> arr = id.split(<span class="string">&quot;_&quot;</span>)</span><br><span class="line">        arr.foreach(out.collect)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒ¿åå‡½æ•°å†™æ³•</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> splitIds = sensorIds</span><br><span class="line">  .flatMap(r =&gt; r.split(<span class="string">&quot;_&quot;</span>))</span><br></pre></td></tr></table></figure><h3 id="é”®æ§æµè½¬æ¢ç®—å­"><a href="#é”®æ§æµè½¬æ¢ç®—å­" class="headerlink" title="é”®æ§æµè½¬æ¢ç®—å­"></a><a href="#%E9%94%AE%E6%8E%A7%E6%B5%81%E8%BD%AC%E6%8D%A2%E7%AE%97%E5%AD%90">é”®æ§æµè½¬æ¢ç®—å­</a></h3><p>å¾ˆå¤šæµå¤„ç†ç¨‹åºçš„ä¸€ä¸ªåŸºæœ¬è¦æ±‚å°±æ˜¯è¦èƒ½<font color="red">å¯¹æ•°æ®è¿›è¡Œåˆ†ç»„ï¼Œåˆ†ç»„åçš„æ•°æ®å…±äº«æŸä¸€ä¸ªç›¸åŒçš„å±æ€§</font>ã€‚DataStream APIæä¾›äº†ä¸€ä¸ªå«åš<code>KeyedStream</code>çš„æŠ½è±¡ï¼Œæ­¤æŠ½è±¡ä¼šä»<strong>é€»è¾‘ä¸Šå¯¹DataStreamè¿›è¡Œåˆ†åŒº</strong>ï¼Œåˆ†åŒºåçš„æ•°æ®æ‹¥æœ‰åŒæ ·çš„<code>Key</code>å€¼ï¼Œåˆ†åŒºåçš„æµäº’ä¸ç›¸å…³ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-19_10-47-17.png"></p><p>è€ŒSparkçš„åˆ†ç»„å‡½æ•°ä¸æ˜¯è¿™æ ·ï¼Œå› ä¸ºå®ƒæ˜¯æ‰¹å¤„ç†ã€‚æ‰€ä»¥ä»–ä¸æ˜¯ä¸€ä¸ªäº‹ä»¶æ‰§è¡Œä¸€ä¸ªåˆ†ç»„ï¼Œè€Œæ˜¯ä¸€æ‰¹æ•°æ®æ‰§è¡Œä¸€æ¬¡åˆ†ç»„ã€‚æ‰€ä»¥å®ƒçš„åˆ†ç»„ä¹‹åæ˜¯K,[V]çš„äº‹ä»¶ï¼Œå³å®ƒçš„åˆ†ç»„å‡½æ•°æ˜¯ç‰©ç†åˆ†ç»„ã€‚</p><hr><p>é’ˆå¯¹KeyedStreamçš„çŠ¶æ€è½¬æ¢æ“ä½œå¯ä»¥è¯»å–æ•°æ®æˆ–è€…å†™å…¥æ•°æ®åˆ°å½“å‰äº‹ä»¶Keyæ‰€å¯¹åº”çš„çŠ¶æ€ä¸­ã€‚<strong>è¿™è¡¨æ˜æ‹¥æœ‰åŒæ ·Keyçš„æ‰€æœ‰äº‹ä»¶éƒ½å¯ä»¥è®¿é—®åŒæ ·çš„çŠ¶æ€</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€ä»¥è¿™äº›äº‹ä»¶å¯ä»¥ä¸€èµ·å¤„ç†ã€‚</p><blockquote><p>ä¹Ÿå°±æ˜¯è¯´åˆ†ç»„åçš„æ¯ä¸ªkeyæ‰€åœ¨çš„åˆ†åŒºéƒ½ä¼šç»´æŠ¤ä¸€ä¸ªçŠ¶æ€ï¼Œä¸ºäº†ä¹‹åçš„æ»šåŠ¨è®¡ç®—åˆ†åŒºå†…çš„å€¼ï¼Œæ¯å½“åˆ†åŒºä¸­çš„ä¸€ä¸ªäº‹ä»¶åˆ°æ¥æ—¶ï¼Œéƒ½ä¼šä¸ä¹‹å‰ä¿å­˜å¥½çš„çŠ¶æ€ç›¸è®¡ç®—ï¼Œå¾—åˆ°æœ€æ–°çš„çŠ¶æ€ã€‚è€Œæ¯ä¸ªkeyçš„çŠ¶æ€éƒ½æ˜¯éš”ç¦»çš„ã€‚</p></blockquote><blockquote><p>è¦å°å¿ƒä½¿ç”¨çŠ¶æ€è½¬æ¢æ“ä½œå’ŒåŸºäºKeyçš„èšåˆæ“ä½œã€‚å¦‚æœKeyçš„å€¼è¶Šæ¥è¶Šå¤šï¼Œä¾‹å¦‚ï¼šKeyæ˜¯è®¢å•IDï¼Œæˆ‘ä»¬å¿…é¡»åŠæ—¶æ¸…ç©ºKeyæ‰€å¯¹åº”çš„çŠ¶æ€ï¼Œä»¥å…å¼•èµ·å†…å­˜æ–¹é¢çš„é—®é¢˜ã€‚ç¨åæˆ‘ä»¬ä¼šè¯¦ç»†è®²è§£ã€‚</p></blockquote><p>KeyedStreamå¯ä»¥ä½¿ç”¨mapï¼ŒflatMapå’Œfilterç®—å­æ¥å¤„ç†ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šä½¿ç”¨keyByç®—å­æ¥å°†DataStreamè½¬æ¢æˆKeyedStreamï¼Œå¹¶è®²è§£åŸºäºkeyçš„è½¬æ¢æ“ä½œï¼š<strong>æ»šåŠ¨èšåˆå’Œreduceç®—å­ã€‚</strong></p><h4 id="KEYBY"><a href="#KEYBY" class="headerlink" title="KEYBY"></a><em>KEYBY</em></h4><p>keyByé€šè¿‡æŒ‡å®škeyæ¥å°†DataStreamè½¬æ¢æˆKeyedStreamã€‚åŸºäºä¸åŒçš„keyï¼Œæµä¸­çš„äº‹ä»¶å°†è¢«åˆ†é…åˆ°ä¸åŒçš„åˆ†åŒºä¸­å»ã€‚æ‰€æœ‰å…·æœ‰ç›¸åŒkeyçš„äº‹ä»¶å°†ä¼šåœ¨æ¥ä¸‹æ¥çš„æ“ä½œç¬¦çš„åŒä¸€ä¸ªå­ä»»åŠ¡æ§½ä¸­è¿›è¡Œå¤„ç†ã€‚æ‹¥æœ‰ä¸åŒkeyçš„äº‹ä»¶å¯ä»¥åœ¨åŒä¸€ä¸ªä»»åŠ¡ä¸­å¤„ç†ã€‚ä½†æ˜¯ç®—å­åªèƒ½è®¿é—®å½“å‰äº‹ä»¶çš„keyæ‰€å¯¹åº”çš„çŠ¶æ€ã€‚</p><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒæŠŠè¾“å…¥äº‹ä»¶çš„é¢œè‰²ä½œä¸ºkeyï¼Œé»‘è‰²çš„äº‹ä»¶è¾“å‡ºåˆ°äº†ä¸€ä¸ªåˆ†åŒºï¼Œå…¶ä»–é¢œè‰²è¾“å‡ºåˆ°äº†å¦ä¸€ä¸ªåˆ†åŒºã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/spaf_0504.png"></p><p><code>keyBy()</code>æ–¹æ³•æ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°æŒ‡å®šäº†keyæˆ–è€…keysï¼Œæœ‰å¾ˆå¤šä¸åŒçš„æ–¹æ³•æ¥æŒ‡å®škeyã€‚æˆ‘ä»¬å°†åœ¨åé¢è®²è§£ã€‚ä¸‹é¢çš„ä»£ç å£°æ˜äº†<code>id</code>è¿™ä¸ªå­—æ®µä¸ºSensorReadingæµçš„keyã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> keyed: <span class="type">KeyedStream</span>[<span class="type">SensorReading</span>, <span class="type">String</span>] = readings.keyBy(r =&gt; r.id)</span><br></pre></td></tr></table></figure><p>åŒ¿åå‡½æ•°<code>r =&gt; r.id</code>æŠ½å–äº†ä¼ æ„Ÿå™¨è¯»æ•°SensorReadingçš„idå€¼ã€‚</p><h4 id="æ»šåŠ¨èšåˆğŸ”º"><a href="#æ»šåŠ¨èšåˆğŸ”º" class="headerlink" title="æ»šåŠ¨èšåˆğŸ”º"></a><em>æ»šåŠ¨èšåˆ</em>ğŸ”º</h4><p><font color="red"><strong>æ»šåŠ¨èšåˆç®—å­ç”±<code>KeyedStream</code>è°ƒç”¨ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªèšåˆä»¥åçš„DataStream</strong></font>ï¼Œä¾‹å¦‚ï¼šsumï¼Œminimumï¼Œmaximumã€‚<strong>ä¸€ä¸ªæ»šåŠ¨èšåˆç®—å­ä¼šä¸ºæ¯ä¸€ä¸ªè§‚å¯Ÿåˆ°çš„keyä¿å­˜ä¸€ä¸ªèšåˆçš„å€¼</strong>ã€‚<strong>é’ˆå¯¹æ¯ä¸€ä¸ªè¾“å…¥äº‹ä»¶ï¼Œç®—å­å°†ä¼šæ›´æ–°ä¿å­˜çš„èšåˆç»“æœ</strong>ï¼Œå¹¶å‘é€ä¸€ä¸ªå¸¦æœ‰æ›´æ–°åçš„å€¼çš„äº‹ä»¶åˆ°ä¸‹æ¸¸ç®—å­ã€‚<strong>æ»šåŠ¨èšåˆä¸éœ€è¦ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°ï¼Œä½†éœ€è¦æ¥å—ä¸€ä¸ªå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°æŒ‡å®šäº†åœ¨å“ªä¸€ä¸ªå­—æ®µä¸Šé¢åšèšåˆæ“ä½œ</strong>ã€‚DataStream APIæä¾›äº†ä»¥ä¸‹æ»šåŠ¨èšåˆæ–¹æ³•ã€‚</p><ul><li>sum()ï¼šåœ¨è¾“å…¥æµä¸Šå¯¹æŒ‡å®šçš„å­—æ®µåšæ»šåŠ¨ç›¸åŠ æ“ä½œã€‚</li><li>min()ï¼šåœ¨è¾“å…¥æµä¸Šå¯¹æŒ‡å®šçš„å­—æ®µæ±‚æœ€å°å€¼ã€‚</li><li>max()ï¼šåœ¨è¾“å…¥æµä¸Šå¯¹æŒ‡å®šçš„å­—æ®µæ±‚æœ€å¤§å€¼ã€‚</li><li>minBy()ï¼šåœ¨è¾“å…¥æµä¸Šé’ˆå¯¹æŒ‡å®šå­—æ®µæ±‚æœ€å°å€¼ï¼Œå¹¶è¿”å›åŒ…å«å½“å‰è§‚å¯Ÿåˆ°çš„æœ€å°å€¼çš„äº‹ä»¶ã€‚</li><li>maxBy()ï¼šåœ¨è¾“å…¥æµä¸Šé’ˆå¯¹æŒ‡å®šå­—æ®µæ±‚æœ€å¤§å€¼ï¼Œå¹¶è¿”å›åŒ…å«å½“å‰è§‚å¯Ÿåˆ°çš„æœ€å¤§å€¼çš„äº‹ä»¶ã€‚</li></ul><p>æ»šåŠ¨èšåˆç®—å­æ— æ³•ç»„åˆèµ·æ¥ä½¿ç”¨ï¼Œæ¯æ¬¡è®¡ç®—åªèƒ½ä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„æ»šåŠ¨èšåˆç®—å­ã€‚</p><blockquote><p>å› ä¸ºæ»šåŠ¨èšåˆç®—å­åªèƒ½å¯¹<code>KeyedStream</code>è°ƒç”¨ï¼Œä¸”è°ƒç”¨åä¼šå˜ä¸º<code>DataStream</code></p></blockquote><p>ä¸‹é¢çš„ä¾‹å­æ ¹æ®ç¬¬ä¸€ä¸ªå­—æ®µæ¥å¯¹ç±»å‹ä¸º<code>Tuple3</code>çš„æµåšåˆ†æµæ“ä½œï¼Œç„¶åé’ˆå¯¹ç¬¬äºŒä¸ªå­—æ®µåšæ»šåŠ¨æ±‚å’Œæ“ä½œã€‚</p><p><strong>scala version</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> inputStream = env.fromElements((<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>), (<span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>), (<span class="number">2</span>, <span class="number">2</span>, <span class="number">4</span>), (<span class="number">1</span>, <span class="number">5</span>, <span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> resultStream = inputStream.keyBy(<span class="number">0</span>).sum(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­é‡Œé¢ï¼Œè¾“å…¥æµæ ¹æ®ç¬¬ä¸€ä¸ªå­—æ®µæ¥åˆ†æµï¼Œç„¶ååœ¨ç¬¬äºŒä¸ªå­—æ®µä¸Šåšè®¡ç®—ã€‚å¯¹äºkey 1ï¼Œè¾“å‡ºç»“æœæ˜¯(1,2,2),(1,7,2)ã€‚å¯¹äºkey 2ï¼Œè¾“å‡ºç»“æœæ˜¯(2,3,1),(2,5,1)ã€‚ç¬¬ä¸€ä¸ªå­—æ®µæ˜¯keyï¼Œç¬¬äºŒä¸ªå­—æ®µæ˜¯æ±‚å’Œçš„æ•°å€¼ï¼Œç¬¬ä¸‰ä¸ªå­—æ®µæœªå®šä¹‰ã€‚</p><blockquote><p>æ»šåŠ¨èšåˆæ“ä½œä¼šå¯¹æ¯ä¸€ä¸ªkeyéƒ½ä¿å­˜ä¸€ä¸ªçŠ¶æ€ã€‚å› ä¸ºçŠ¶æ€ä»æ¥ä¸ä¼šè¢«æ¸…ç©ºï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä½¿ç”¨æ»šåŠ¨èšåˆç®—å­æ—¶åªèƒ½ä½¿ç”¨åœ¨<font color="red">å«æœ‰æœ‰é™ä¸ªkeyçš„æµä¸Šé¢ã€‚</font></p></blockquote><h4 id="REDUCEğŸ”º"><a href="#REDUCEğŸ”º" class="headerlink" title="REDUCEğŸ”º"></a><em>REDUCE</em>ğŸ”º</h4><p>reduceç®—å­æ˜¯æ»šåŠ¨èšåˆçš„æ³›åŒ–å®ç°ã€‚<strong>å®ƒå°†ä¸€ä¸ªReduceFunctionåº”ç”¨åˆ°äº†ä¸€ä¸ªKeyedStreamä¸Šé¢å»ã€‚</strong>reduceç®—å­å°†ä¼šæŠŠæ¯ä¸€ä¸ªè¾“å…¥äº‹ä»¶å’Œå½“å‰å·²ç»reduceå‡ºæ¥çš„å€¼åšèšåˆè®¡ç®—ã€‚<strong>reduceæ“ä½œä¸ä¼šæ”¹å˜æµçš„äº‹ä»¶ç±»å‹ã€‚è¾“å‡ºæµæ•°æ®ç±»å‹å’Œè¾“å…¥æµæ•°æ®ç±»å‹æ˜¯ä¸€æ ·çš„ã€‚</strong></p><blockquote><p>å®é™…ä¸Šreduceæ–¹æ³•å°±æ˜¯è‡ªå®šä¹‰çš„æ»šåŠ¨èšåˆæ–¹æ³•ï¼Œä¸ä¹‹ä¸åŒçš„æ˜¯å®ƒä¸ä¼šæ”¹å˜æµç±»å‹ï¼Œä½¿ç”¨ä¼šä¸ä¼šå°†KeyedStream[T]-&gt;DataStream[T1]</p></blockquote><p>reduceå‡½æ•°å¯ä»¥é€šè¿‡å®ç°æ¥å£ReduceFunctionæ¥åˆ›å»ºä¸€ä¸ªç±»ã€‚ReduceFunctionæ¥å£å®šä¹‰äº†<code>reduce()</code>æ–¹æ³•ï¼Œæ­¤æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªè¾“å…¥äº‹ä»¶ï¼Œè¾“å…¥ä¸€ä¸ªç›¸åŒç±»å‹çš„äº‹ä»¶ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; T: the element type</span><br><span class="line">ReduceFunction[T]</span><br><span class="line">    &gt; reduce(T, T): T</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çš„ä¾‹å­ï¼Œæµæ ¹æ®ä¼ æ„Ÿå™¨IDåˆ†æµï¼Œç„¶åè®¡ç®—æ¯ä¸ªä¼ æ„Ÿå™¨çš„å½“å‰æœ€å¤§æ¸©åº¦å€¼ã€‚</p><p><strong>scala version</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">MyReduce</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> value: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = env.addSource(<span class="keyword">new</span> <span class="type">SensorSource</span>)</span><br><span class="line">    <span class="keyword">val</span> value1: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = value.keyBy(_.id).reduce(<span class="keyword">new</span> myReduce)</span><br><span class="line">    value1.print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">myReduce</span> <span class="keyword">extends</span> <span class="title">ReduceFunction</span>[<span class="type">SensorReading</span>]</span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">reduce</span></span>(t: <span class="type">SensorReading</span>, t1: <span class="type">SensorReading</span>): <span class="type">SensorReading</span> = &#123;</span><br><span class="line">     <span class="keyword">if</span> (t.temperature&gt;t1.temperature) &#123;</span><br><span class="line">       t</span><br><span class="line">     &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">       t1</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>reduceä½œä¸ºæ»šåŠ¨èšåˆçš„æ³›åŒ–å®ç°ï¼ŒåŒæ ·ä¹Ÿè¦é’ˆå¯¹æ¯ä¸€ä¸ªkeyä¿å­˜çŠ¶æ€ã€‚å› ä¸ºçŠ¶æ€ä»æ¥ä¸ä¼šæ¸…ç©ºï¼Œ<font color="red">æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†reduceç®—å­åº”ç”¨åœ¨ä¸€ä¸ªæœ‰é™keyçš„æµä¸Šã€‚</font></p></blockquote><h3 id="å¤šæµè½¬æ¢ç®—å­"><a href="#å¤šæµè½¬æ¢ç®—å­" class="headerlink" title="å¤šæµè½¬æ¢ç®—å­"></a><a href="#%E5%A4%9A%E6%B5%81%E8%BD%AC%E6%8D%A2%E7%AE%97%E5%AD%90">å¤šæµè½¬æ¢ç®—å­</a></h3><p>è®¸å¤šåº”ç”¨éœ€è¦æ‘„å…¥å¤šä¸ªæµå¹¶å°†æµåˆå¹¶å¤„ç†ï¼Œè¿˜å¯èƒ½éœ€è¦å°†ä¸€æ¡æµåˆ†å‰²æˆå¤šæ¡æµç„¶åé’ˆå¯¹æ¯ä¸€æ¡æµåº”ç”¨ä¸åŒçš„ä¸šåŠ¡é€»è¾‘ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è®¨è®ºDataStream APIä¸­æä¾›çš„èƒ½å¤Ÿå¤„ç†å¤šæ¡è¾“å…¥æµæˆ–è€…å‘é€å¤šæ¡è¾“å‡ºæµçš„æ“ä½œç®—å­ã€‚</p><h4 id="UNION"><a href="#UNION" class="headerlink" title="UNION"></a><em>UNION</em></h4><p>DataStream.union()æ–¹æ³•å°†ä¸¤æ¡æˆ–è€…å¤šæ¡DataStreamåˆå¹¶æˆä¸€æ¡å…·æœ‰<strong>ä¸è¾“å…¥æµç›¸åŒç±»å‹çš„è¾“å‡ºDataStream</strong>ã€‚æ¥ä¸‹æ¥çš„è½¬æ¢ç®—å­å°†ä¼šå¤„ç†è¾“å…¥æµä¸­çš„æ‰€æœ‰å…ƒç´ ã€‚ä¸‹å›¾å±•ç¤ºäº†unionæ“ä½œç¬¦å¦‚ä½•å°†é»‘è‰²å’Œç™½è‰²çš„äº‹ä»¶æµåˆå¹¶æˆä¸€ä¸ªå•ä¸€è¾“å‡ºæµã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/spaf_0505.png" alt="img"></p><p>äº‹ä»¶åˆæµçš„æ–¹å¼ä¸ºFIFOæ–¹å¼ã€‚æ“ä½œç¬¦å¹¶ä¸ä¼šäº§ç”Ÿä¸€ä¸ªç‰¹å®šé¡ºåºçš„äº‹ä»¶æµã€‚<strong>unionæ“ä½œç¬¦ä¹Ÿä¸ä¼šè¿›è¡Œå»é‡ã€‚æ¯ä¸€ä¸ªè¾“å…¥äº‹ä»¶éƒ½è¢«å‘é€åˆ°äº†ä¸‹ä¸€ä¸ªæ“ä½œç¬¦ã€‚</strong></p><p>ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•å°†ä¸‰æ¡ç±»å‹ä¸ºSensorReadingçš„æ•°æ®æµåˆå¹¶æˆä¸€æ¡æµã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> parisStream: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = ...</span><br><span class="line"><span class="keyword">val</span> tokyoStream: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = ...</span><br><span class="line"><span class="keyword">val</span> rioStream: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = ...</span><br><span class="line"><span class="keyword">val</span> allCities: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = parisStream</span><br><span class="line">  .union(tokyoStream, rioStream)</span><br></pre></td></tr></table></figure><h4 id="CONNECT-COMAPå’ŒCOFLATMAPğŸ”º"><a href="#CONNECT-COMAPå’ŒCOFLATMAPğŸ”º" class="headerlink" title="CONNECT, COMAPå’ŒCOFLATMAPğŸ”º"></a><em>CONNECT, COMAPå’ŒCOFLATMAP</em>ğŸ”º</h4><p>è”åˆä¸¤æ¡æµçš„äº‹ä»¶æ˜¯éå¸¸å¸¸è§çš„æµå¤„ç†éœ€æ±‚ã€‚ä¾‹å¦‚ç›‘æ§ä¸€ç‰‡æ£®æ—ç„¶åå‘å‡ºé«˜å±çš„ç«è­¦è­¦æŠ¥ã€‚æŠ¥è­¦çš„Applicationæ¥æ”¶ä¸¤æ¡æµï¼Œä¸€æ¡æ˜¯æ¸©åº¦ä¼ æ„Ÿå™¨ä¼ å›æ¥çš„æ•°æ®ï¼Œä¸€æ¡æ˜¯çƒŸé›¾ä¼ æ„Ÿå™¨ä¼ å›æ¥çš„æ•°æ®ã€‚å½“ä¸¤æ¡æµéƒ½è¶…è¿‡å„è‡ªçš„é˜ˆå€¼æ—¶ï¼ŒæŠ¥è­¦ã€‚</p><p>DataStream APIæä¾›äº†<code>connect</code>æ“ä½œæ¥æ”¯æŒä»¥ä¸Šçš„åº”ç”¨åœºæ™¯ã€‚<code>DataStream.connect()</code>æ–¹æ³•æ¥æ”¶ä¸€æ¡<code>DataStream</code>ï¼Œç„¶åè¿”å›ä¸€ä¸ª<code>ConnectedStreams</code>ç±»å‹çš„å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡è¡¨ç¤ºäº†ä¸¤æ¡è¿æ¥çš„æµã€‚</p><p>ConnectedStreamsæä¾›äº†<code>map()</code>å’Œ<code>flatMap()</code>æ–¹æ³•ï¼Œåˆ†åˆ«éœ€è¦æ¥æ”¶ç±»å‹ä¸º<code>CoMapFunction</code>å’Œ<code>CoFlatMapFunction</code>çš„å‚æ•°ã€‚</p><p>ä»¥ä¸Šä¸¤ä¸ªå‡½æ•°é‡Œé¢çš„æ³›å‹æ˜¯ç¬¬ä¸€æ¡æµçš„äº‹ä»¶ç±»å‹å’Œç¬¬äºŒæ¡æµçš„äº‹ä»¶ç±»å‹ï¼Œä»¥åŠè¾“å‡ºæµçš„äº‹ä»¶ç±»å‹ã€‚è¿˜å®šä¹‰äº†ä¸¤ä¸ªæ–¹æ³•ï¼Œæ¯ä¸€ä¸ªæ–¹æ³•é’ˆå¯¹ä¸€æ¡æµæ¥è°ƒç”¨ã€‚<code>map1()</code>å’Œ<code>flatMap1()</code>ä¼šè°ƒç”¨åœ¨ç¬¬ä¸€æ¡æµçš„å…ƒç´ ä¸Šé¢ï¼Œ<code>map2()</code>å’Œ<code>flatMap2()</code>ä¼šè°ƒç”¨åœ¨ç¬¬äºŒæ¡æµçš„å…ƒç´ ä¸Šé¢ã€‚flatmapçš„flatmapå‡½æ•°å¯ä»¥å‘é€å¤šä¸ªå€¼ï¼Œè€Œmapåªèƒ½ä¸€ä¸ªã€‚</p><p>å¯¹ä¸¤æ¡æµåšè¿æ¥æŸ¥è¯¢é€šå¸¸éœ€è¦è¿™ä¸¤æ¡æµåŸºäºæŸäº›æ¡ä»¶è¢«ç¡®å®šæ€§çš„è·¯ç”±åˆ°æ“ä½œç¬¦ä¸­ç›¸åŒçš„å¹¶è¡Œå®ä¾‹é‡Œé¢å»ã€‚<strong>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œconnect()æ“ä½œå°†ä¸ä¼šå¯¹ä¸¤æ¡æµçš„äº‹ä»¶å»ºç«‹ä»»ä½•å…³ç³»ï¼Œæ‰€ä»¥ä¸¤æ¡æµçš„äº‹ä»¶å°†ä¼šéšæœºçš„è¢«å‘é€åˆ°ä¸‹æ¸¸çš„ç®—å­å®ä¾‹é‡Œé¢å»ã€‚</strong>è¿™æ ·çš„è¡Œä¸ºä¼šäº§ç”Ÿä¸ç¡®å®šæ€§çš„è®¡ç®—ç»“æœï¼Œæ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚<font color="red">ä¸ºäº†é’ˆå¯¹ConnectedStreamsè¿›è¡Œç¡®å®šæ€§çš„è½¬æ¢æ“ä½œï¼Œconnect()æ–¹æ³•å¯ä»¥å’ŒkeyBy()æˆ–è€…broadcast()ç»„åˆèµ·æ¥ä½¿ç”¨ã€‚æˆ‘ä»¬é¦–å…ˆçœ‹ä¸€ä¸‹keyBy()çš„ç¤ºä¾‹ã€‚</font></p><ul><li>ä½¿ç”¨keyByæŒ‡å®škeyæ¥å¯¹ä¸¤æ¡æµå»ºç«‹å…³ç³»</li></ul><p><strong>keyby</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> one = ...</span><br><span class="line"><span class="keyword">val</span> two = ...</span><br><span class="line"><span class="comment">// å†™æ³•1</span></span><br><span class="line"><span class="keyword">val</span> keyedConnect1 = one.connect(two).keyBy(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"><span class="comment">// å†™æ³•2</span></span><br><span class="line"><span class="keyword">val</span> keyedConnect2 = one.keyBy(<span class="number">0</span>).connect(two.keyBy(<span class="number">0</span>))</span><br></pre></td></tr></table></figure><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> one: <span class="type">DataStream</span>[(<span class="type">Int</span>, <span class="type">String</span>)] = env.fromElements((<span class="number">1</span>, <span class="string">&quot;a&quot;</span>), (<span class="number">2</span>,<span class="string">&quot;b&quot;</span>))</span><br><span class="line">    <span class="keyword">val</span> two: <span class="type">DataStream</span>[(<span class="type">Int</span>, <span class="type">String</span>)] = env.fromElements((<span class="number">1</span>, <span class="string">&quot;m&quot;</span>), (<span class="number">2</span>,<span class="string">&quot;n&quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> keyedConnect2: <span class="type">ConnectedStreams</span>[(<span class="type">Int</span>, <span class="type">String</span>), (<span class="type">Int</span>, <span class="type">String</span>)] = one.keyBy(<span class="number">0</span>).connect(two.keyBy(<span class="number">0</span>))</span><br><span class="line">    keyedConnect2.map(<span class="keyword">new</span> <span class="type">MyCoMap</span>).print()</span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MyCoMap</span> <span class="keyword">extends</span> <span class="title">CoMapFunction</span>[(<span class="type">Int</span>, <span class="type">String</span>),(<span class="type">Int</span>, <span class="type">String</span>),<span class="type">String</span>]</span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">map1</span></span>(in1: (<span class="type">Int</span>, <span class="type">String</span>)): <span class="type">String</span> = &#123;</span><br><span class="line">      in1._1+in1._2</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">map2</span></span>(in1: (<span class="type">Int</span>, <span class="type">String</span>)): <span class="type">String</span> = &#123;</span><br><span class="line">      in1._1+in1._2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾“å‡ºï¼š1a 1m 2b 2n</span></span><br></pre></td></tr></table></figure><h4 id="SideOutput"><a href="#SideOutput" class="headerlink" title="SideOutput"></a><em>SideOutput</em></h4><p>å¤§éƒ¨åˆ†çš„DataStream APIçš„ç®—å­çš„è¾“å‡ºæ˜¯å•ä¸€è¾“å‡ºï¼Œä¹Ÿå°±æ˜¯æŸç§æ•°æ®ç±»å‹çš„æµã€‚é™¤äº†splitç®—å­ï¼Œå¯ä»¥å°†ä¸€æ¡æµåˆ†æˆå¤šæ¡æµï¼Œè¿™äº›æµçš„æ•°æ®ç±»å‹ä¹Ÿéƒ½ç›¸åŒã€‚process functionçš„side outputsåŠŸèƒ½å¯ä»¥äº§ç”Ÿå¤šæ¡æµï¼Œå¹¶ä¸”è¿™äº›æµçš„æ•°æ®ç±»å‹å¯ä»¥ä¸ä¸€æ ·ã€‚ä¸€ä¸ªside outputå¯ä»¥å®šä¹‰ä¸ºOutputTag[X]å¯¹è±¡ï¼Œ<strong>Xæ˜¯è¾“å‡ºæµçš„æ•°æ®ç±»å‹</strong>ã€‚process functionå¯ä»¥é€šè¿‡Contextå¯¹è±¡å‘å°„ä¸€ä¸ªäº‹ä»¶åˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªside outputsã€‚</p><blockquote><p><code>process function</code>ä¸<code>KeyedProcessFunction</code>åŒºåˆ«ï¼š</p><p><code>KeyedProcessFunction</code>æ˜¯å¯¹äºkeybyåçš„æµè®¡ç®—ï¼Œè€Œ<code>process function</code>æ˜¯å¯¹keybyå‰çš„æµè®¡ç®—ï¼Œéƒ½æ˜¯ä¸€ä¸ªå…ƒç´ è§¦å‘ä¸€æ¬¡è®¡ç®—</p></blockquote><p><strong>å°†æ•°æ®å‘é€åˆ°ä¸åŒçš„ä¾§è¾“å‡ºæµ</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">SideOutputStream</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> inputStream: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = env.addSource(<span class="keyword">new</span> <span class="type">SensorSource</span>)</span><br><span class="line">    inputStream.process(<span class="keyword">new</span> <span class="type">MySideOutputStream</span>).getSideOutput(<span class="keyword">new</span> <span class="type">OutputTag</span>[<span class="type">SensorReading</span>](<span class="string">&quot;tmp&quot;</span>))</span><br><span class="line">      .print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  ProcessFunction`å¤„ç†çš„æ˜¯æ²¡æœ‰ kelByçš„æµ</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MySideOutputStream</span> <span class="keyword">extends</span> <span class="title">ProcessFunction</span>[<span class="type">SensorReading</span>, <span class="type">SensorReading</span>]</span>&#123;</span><br><span class="line">    <span class="keyword">lazy</span> <span class="keyword">private</span> <span class="keyword">val</span> tag: <span class="type">OutputTag</span>[<span class="type">SensorReading</span>] = <span class="keyword">new</span> <span class="type">OutputTag</span>[<span class="type">SensorReading</span>](<span class="string">&quot;tmp&quot;</span>)</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">processElement</span></span>(i: <span class="type">SensorReading</span>, context: <span class="type">ProcessFunction</span>[<span class="type">SensorReading</span>, <span class="type">SensorReading</span>]#<span class="type">Context</span>, collector: <span class="type">Collector</span>[<span class="type">SensorReading</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="comment">// æ»¡è¶³æŒ‡å®šæ¡ä»¶åˆ™è¾“å…¥åˆ°ä¾§è¾“å‡ºæµï¼Œæ‰€æœ‰å…ƒç´ éƒ½éœ€è¦å‘é€åˆ°æ­£å¸¸æµ</span></span><br><span class="line">      <span class="keyword">if</span> (i.temperature&lt;<span class="number">10.0</span>) &#123;</span><br><span class="line">        context.output(tag, i)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      collector.collect(i)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210102142714440.png" alt="image-20210102142714440"></p><h3 id="åˆ†å¸ƒå¼è½¬æ¢ç®—å­"><a href="#åˆ†å¸ƒå¼è½¬æ¢ç®—å­" class="headerlink" title="åˆ†å¸ƒå¼è½¬æ¢ç®—å­"></a><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E8%BD%AC%E6%8D%A2%E7%AE%97%E5%AD%90">åˆ†å¸ƒå¼è½¬æ¢ç®—å­</a></h3><p>å½“æˆ‘ä»¬ä½¿ç”¨DataStream APIæ¥ç¼–å†™ç¨‹åºæ—¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨çš„é€‰æ‹©æ•°æ®åˆ†åŒºç­–ç•¥ï¼Œç„¶åæ ¹æ®æ“ä½œç¬¦çš„è¯­ä¹‰å’Œè®¾ç½®çš„å¹¶è¡Œåº¦å°†æ•°æ®è·¯ç”±åˆ°æ­£ç¡®çš„åœ°æ–¹å»ã€‚æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åœ¨åº”ç”¨ç¨‹åºçš„å±‚é¢æ§åˆ¶åˆ†åŒºç­–ç•¥ï¼Œæˆ–è€…è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬çŸ¥é“ä¼šå‘ç”Ÿæ•°æ®å€¾æ–œï¼Œé‚£ä¹ˆæˆ‘ä»¬æƒ³è¦é’ˆå¯¹æ•°æ®æµåšè´Ÿè½½å‡è¡¡ï¼Œå°†æ•°æ®æµå¹³å‡å‘é€åˆ°æ¥ä¸‹æ¥çš„æ“ä½œç¬¦ä¸­å»ã€‚åˆæˆ–è€…ï¼Œåº”ç”¨ç¨‹åºçš„ä¸šåŠ¡é€»è¾‘å¯èƒ½éœ€è¦ä¸€ä¸ªç®—å­æ‰€æœ‰çš„å¹¶è¡Œä»»åŠ¡éƒ½éœ€è¦æ¥æ”¶åŒæ ·çš„æ•°æ®ã€‚å†æˆ–è€…ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥çš„æ—¶å€™ã€‚åœ¨è¿™ä¸€å°èŠ‚ï¼Œæˆ‘ä»¬å°†å±•ç¤ºDataStreamçš„ä¸€äº›æ–¹æ³•ï¼Œå¯ä»¥ä½¿æˆ‘ä»¬æ¥æ§åˆ¶æˆ–è€…è‡ªå®šä¹‰æ•°æ®åˆ†åŒºç­–ç•¥ã€‚</p><blockquote><p>keyBy()æ–¹æ³•ä¸åŒäºåˆ†å¸ƒå¼è½¬æ¢ç®—å­ã€‚æ‰€æœ‰çš„åˆ†å¸ƒå¼è½¬æ¢ç®—å­å°†äº§ç”ŸDataStreamæ•°æ®ç±»å‹ã€‚è€ŒkeyBy()äº§ç”Ÿçš„ç±»å‹æ˜¯KeyedStreamï¼Œå®ƒæ‹¥æœ‰è‡ªå·±çš„keyed stateã€‚</p><p>åˆ†å¸ƒå¼è½¬æ¢ç®—å­å®é™…ä¸Šå°±æ˜¯shuffleå°†åŸæœ‰åˆ†åŒºçš„æ•°æ®å‘é€åˆ°ä¸‹ä¸€ä»»åŠ¡çš„ä¸åŒåˆ†åŒºã€‚å¦‚æœä¸‹ä¸€ä»»åŠ¡æœ‰å¤šä¸ªå¹¶è¡Œï¼Œåˆ™æœ‰ç”¨ï¼Œå¦‚æœå°±ä¸€ä¸ªå®ƒæ€ä¹ˆå‘è¿˜æ˜¯ç»™ä¸€ä¸ªå¹¶è¡Œåº¦1çš„ä»»åŠ¡æ‰§è¡Œ</p></blockquote><p>æ•°æ®äº¤æ¢ç­–ç•¥å¦‚ä¸‹ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/spaf_0203.png"></p><ul><li>å‰å‘ç­–ç•¥å°†æ•°æ®ä»ä¸€ä¸ªä»»åŠ¡å‘é€åˆ°æ¥æ”¶ä»»åŠ¡ã€‚å¦‚æœä¸¤ä¸ªä»»åŠ¡éƒ½ä½äºåŒä¸€å°ç‰©ç†è®¡ç®—æœºä¸Šï¼ˆè¿™é€šå¸¸ç”±ä»»åŠ¡è°ƒåº¦å™¨ç¡®ä¿ï¼‰ï¼Œè¿™ç§äº¤æ¢ç­–ç•¥å¯ä»¥é¿å…ç½‘ç»œé€šä¿¡ã€‚</li><li>å¹¿æ’­ç­–ç•¥å°†æ‰€æœ‰æ•°æ®å‘é€åˆ°ç®—å­çš„æ‰€æœ‰çš„å¹¶è¡Œä»»åŠ¡ä¸Šé¢å»ã€‚å› ä¸ºè¿™ç§ç­–ç•¥ä¼šå¤åˆ¶æ•°æ®å’Œæ¶‰åŠç½‘ç»œé€šä¿¡ï¼Œæ‰€ä»¥ä»£ä»·ç›¸å½“æ˜‚è´µã€‚</li><li>åŸºäºé”®æ§çš„ç­–ç•¥é€šè¿‡Keyå€¼(é”®)å¯¹æ•°æ®è¿›è¡Œåˆ†åŒºä¿è¯å…·æœ‰ç›¸åŒKeyçš„æ•°æ®å°†ç”±åŒä¸€ä»»åŠ¡å¤„ç†ã€‚åœ¨å›¾2-2ä¸­ï¼Œè¾“å‡ºâ€œExtract hashtagsâ€ç®—å­ä½¿ç”¨é”®æ¥åˆ†åŒºï¼ˆhashtagï¼‰ï¼Œä»¥ä¾¿countç®—å­çš„ä»»åŠ¡å¯ä»¥æ­£ç¡®è®¡ç®—æ¯ä¸ª#æ ‡ç­¾çš„å‡ºç°æ¬¡æ•°ã€‚</li><li>éšæœºç­–ç•¥ç»Ÿä¸€å°†æ•°æ®åˆ†é…åˆ°ç®—å­çš„ä»»åŠ¡ä¸­å»ï¼Œä»¥ä¾¿å‡åŒ€åœ°å°†è´Ÿè½½åˆ†é…åˆ°ä¸åŒçš„è®¡ç®—ä»»åŠ¡ã€‚</li></ul><h4 id="Random"><a href="#Random" class="headerlink" title="Random"></a><em>Random</em></h4><p>éšæœºæ•°æ®äº¤æ¢ç”±<code>DataStream.shuffle()</code>æ–¹æ³•å®ç°ã€‚shuffleæ–¹æ³•å°†æ•°æ®éšæœºçš„åˆ†é…åˆ°ä¸‹æ¸¸ç®—å­çš„å¹¶è¡Œä»»åŠ¡ä¸­å»ã€‚</p><h4 id="Round-Robin"><a href="#Round-Robin" class="headerlink" title="Round-Robin"></a><em>Round-Robin</em></h4><p><code>rebalance()</code>æ–¹æ³•ä½¿ç”¨Round-Robinè´Ÿè½½å‡è¡¡ç®—æ³•å°†è¾“å…¥æµå¹³å‡åˆ†é…åˆ°éšåçš„å¹¶è¡Œè¿è¡Œçš„ä»»åŠ¡ä¸­å»ã€‚å›¾5-7ä¸ºround-robinåˆ†å¸ƒå¼è½¬æ¢ç®—å­çš„ç¤ºæ„å›¾ã€‚</p><h4 id="Rescale"><a href="#Rescale" class="headerlink" title="Rescale"></a><em>Rescale</em></h4><p><code>rescale()</code>æ–¹æ³•ä½¿ç”¨çš„ä¹Ÿæ˜¯round-robinç®—æ³•ï¼Œä½†åªä¼šå°†æ•°æ®å‘é€åˆ°æ¥ä¸‹æ¥çš„å¹¶è¡Œè¿è¡Œçš„ä»»åŠ¡ä¸­çš„ä¸€éƒ¨åˆ†ä»»åŠ¡ä¸­ã€‚æœ¬è´¨ä¸Šï¼Œå½“å‘é€è€…ä»»åŠ¡æ•°é‡å’Œæ¥æ”¶è€…ä»»åŠ¡æ•°é‡ä¸ä¸€æ ·æ—¶ï¼Œrescaleåˆ†åŒºç­–ç•¥æä¾›äº†ä¸€ç§è½»é‡çº§çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ã€‚<font color="red">å¦‚æœæ¥æ”¶è€…ä»»åŠ¡çš„æ•°é‡æ˜¯å‘é€è€…ä»»åŠ¡çš„æ•°é‡çš„å€æ•°æ—¶ï¼Œrescaleæ“ä½œå°†ä¼šæ•ˆç‡æ›´é«˜ã€‚</font></p><p><code>rebalance()</code>å’Œ<code>rescale()</code>çš„æ ¹æœ¬åŒºåˆ«åœ¨äºä»»åŠ¡ä¹‹é—´è¿æ¥çš„æœºåˆ¶ä¸åŒã€‚ <code>rebalance()</code>å°†ä¼šé’ˆå¯¹æ‰€æœ‰å‘é€è€…ä»»åŠ¡å’Œæ‰€æœ‰æ¥æ”¶è€…ä»»åŠ¡ä¹‹é—´å»ºç«‹é€šä¿¡é€šé“ï¼Œè€Œ<code>rescale()</code>ä»…ä»…é’ˆå¯¹æ¯ä¸€ä¸ªä»»åŠ¡å’Œä¸‹æ¸¸ç®—å­çš„ä¸€éƒ¨åˆ†å­å¹¶è¡Œä»»åŠ¡ä¹‹é—´å»ºç«‹é€šä¿¡é€šé“ã€‚rescaleçš„ç¤ºæ„å›¾ä¸ºå›¾5-7ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/spaf_0507.png" alt="5-7"></p><h4 id="Broadcast"><a href="#Broadcast" class="headerlink" title="Broadcast"></a><em>Broadcast</em></h4><p><code>broadcast()</code>æ–¹æ³•å°†è¾“å…¥æµçš„æ‰€æœ‰æ•°æ®å¤åˆ¶å¹¶å‘é€åˆ°ä¸‹æ¸¸ç®—å­çš„æ‰€æœ‰å¹¶è¡Œä»»åŠ¡ä¸­å»ã€‚</p><h4 id="Global"><a href="#Global" class="headerlink" title="Global"></a><em>Global</em></h4><p><code>global()</code>æ–¹æ³•å°†æ‰€æœ‰çš„è¾“å…¥æµæ•°æ®éƒ½å‘é€åˆ°ä¸‹æ¸¸ç®—å­çš„ç¬¬ä¸€ä¸ªå¹¶è¡Œä»»åŠ¡ä¸­å»ã€‚è¿™ä¸ªæ“ä½œéœ€è¦å¾ˆè°¨æ…ï¼Œå› ä¸ºå°†æ‰€æœ‰æ•°æ®å‘é€åˆ°åŒä¸€ä¸ªtaskï¼Œå°†ä¼šå¯¹åº”ç”¨ç¨‹åºé€ æˆå¾ˆå¤§çš„å‹åŠ›ã€‚</p><h4 id="Custom"><a href="#Custom" class="headerlink" title="Custom"></a><em>Custom</em></h4><p>å½“Flinkæä¾›çš„åˆ†åŒºç­–ç•¥éƒ½ä¸é€‚ç”¨æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>partitionCustom()</code>æ–¹æ³•æ¥è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥ã€‚è¿™ä¸ªæ–¹æ³•æ¥æ”¶ä¸€ä¸ª<code>Partitioner</code>å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡éœ€è¦å®ç°åˆ†åŒºé€»è¾‘ä»¥åŠå®šä¹‰é’ˆå¯¹æµçš„å“ªä¸€ä¸ªå­—æ®µæˆ–è€…keyæ¥è¿›è¡Œåˆ†åŒºã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-19_14-38-09.png" alt="Snipaste_2020-12-19_14-38-09"></p><h2 id="è®¾ç½®å¹¶è¡Œåº¦"><a href="#è®¾ç½®å¹¶è¡Œåº¦" class="headerlink" title="è®¾ç½®å¹¶è¡Œåº¦"></a><a href="#%E8%AE%BE%E7%BD%AE%E5%B9%B6%E8%A1%8C%E5%BA%A6">è®¾ç½®å¹¶è¡Œåº¦</a></h2><p>Flinkåº”ç”¨ç¨‹åºåœ¨ä¸€ä¸ªåƒé›†ç¾¤è¿™æ ·çš„åˆ†å¸ƒå¼ç¯å¢ƒä¸­å¹¶è¡Œæ‰§è¡Œã€‚å½“ä¸€ä¸ªæ•°æ®æµç¨‹åºæäº¤åˆ°ä½œä¸šç®¡ç†å™¨æ‰§è¡Œæ—¶ï¼Œç³»ç»Ÿå°†ä¼šåˆ›å»ºä¸€ä¸ªæ•°æ®æµå›¾ï¼Œç„¶åå‡†å¤‡æ‰§è¡Œéœ€è¦çš„æ“ä½œç¬¦ã€‚æ¯ä¸€ä¸ªæ“ä½œç¬¦å°†ä¼šå¹¶è¡ŒåŒ–åˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªä»»åŠ¡ä¸­å»ã€‚æ¯ä¸ªç®—å­çš„å¹¶è¡Œä»»åŠ¡éƒ½ä¼šå¤„ç†è¿™ä¸ªç®—å­çš„è¾“å…¥æµä¸­çš„ä¸€ä»½å­é›†ã€‚ä¸€ä¸ªç®—å­å¹¶è¡Œä»»åŠ¡çš„ä¸ªæ•°å«åšç®—å­çš„å¹¶è¡Œåº¦ã€‚å®ƒå†³å®šäº†ç®—å­æ‰§è¡Œçš„å¹¶è¡ŒåŒ–ç¨‹åº¦ï¼Œä»¥åŠè¿™ä¸ªç®—å­èƒ½å¤„ç†å¤šå°‘æ•°æ®é‡ã€‚</p><p>ä¸€èˆ¬è®¾ç½®å¹¶è¡Œåº¦ï¼Œæˆ‘ä»¬ä¸è¦åœ¨ä»£ç é‡Œè®¾ç½®å…¨å±€å¹¶è¡Œåº¦ï¼Œè¿™æ ·ç¡¬ç¼–ç ä¸å¥½ï¼Œåº”å½“ä½¿ç”¨é›†ç¾¤é»˜è®¤å¹¶è¡Œåº¦ï¼Œè¿™æ ·å½“é›†ç¾¤æ‰©å……èŠ‚ç‚¹æ—¶ï¼Œå¯ä»¥æ”¹å˜å½“å‰è¿è¡Œjobçš„å¹¶è¡Œåº¦ï¼Œè¿™æ ·ä»£ç å°±ä¸ç”¨é‡æ”¹ä»£ç å®ç°å¹¶è¡Œåº¦çš„å¢åŠ ã€‚å¦‚æœå†™æ­»äº†ï¼Œé›†ç¾¤å†æ€ä¹ˆè®¾ç½®ï¼Œå¹¶è¡Œåº¦ä¹Ÿä¸ä¼šå˜åŒ–ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±åº”è¯¥å¯¹ç‰¹å®šçš„ç®—å­è¿›è¡Œå¹¶è¡Œåº¦çš„è®¡ç®—ã€‚</p><p>åœ¨ä¸‹é¢çš„ä¾‹å­é‡Œé¢ï¼Œæ•°æ®æºçš„æ“ä½œç¬¦å°†ä¼šæŒ‰ç…§ç¯å¢ƒé»˜è®¤çš„å¹¶è¡Œåº¦æ¥å¹¶è¡Œæ‰§è¡Œï¼Œmapæ“ä½œç¬¦çš„å¹¶è¡Œåº¦å°†ä¼šæ˜¯é»˜è®¤å¹¶è¡Œåº¦çš„2å€ï¼Œsinkæ“ä½œç¬¦çš„å¹¶è¡Œåº¦ä¸º2ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">StreamExecutionEnvironment</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment;</span><br><span class="line">int defaultP = env.getParallelism;</span><br><span class="line">env</span><br><span class="line">  .addSource(<span class="keyword">new</span> <span class="type">CustomSource</span>)</span><br><span class="line">  .map(<span class="keyword">new</span> <span class="type">MyMapper</span>)</span><br><span class="line">  .setParallelism(defaultP * <span class="number">2</span>)</span><br><span class="line">  .print()</span><br><span class="line">  .setParallelism(<span class="number">2</span>);</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬é€šè¿‡å®¢æˆ·ç«¯å°†åº”ç”¨ç¨‹åºçš„å¹¶è¡Œåº¦è®¾ç½®ä¸º16å¹¶æäº¤æ‰§è¡Œæ—¶ï¼Œsourceæ“ä½œç¬¦çš„å¹¶è¡Œåº¦ä¸º16ï¼Œmapperå¹¶è¡Œåº¦ä¸º32ï¼Œsinkå¹¶è¡Œåº¦ä¸º2ã€‚å¦‚æœæˆ‘ä»¬åœ¨æœ¬åœ°ç¯å¢ƒè¿è¡Œåº”ç”¨ç¨‹åºçš„è¯ï¼Œä¾‹å¦‚åœ¨IDEä¸­è¿è¡Œï¼Œæœºå™¨æ˜¯8æ ¸ï¼Œé‚£ä¹ˆsourceä»»åŠ¡å°†ä¼šå¹¶è¡Œæ‰§è¡Œåœ¨8ä¸ªä»»åŠ¡ä¸Šé¢ï¼Œmapperè¿è¡Œåœ¨16ä¸ªä»»åŠ¡ä¸Šé¢ï¼Œsinkè¿è¡Œåœ¨2ä¸ªä»»åŠ¡ä¸Šé¢ã€‚</p><h2 id="ç±»å‹"><a href="#ç±»å‹" class="headerlink" title="ç±»å‹"></a><a href="#%E7%B1%BB%E5%9E%8B">ç±»å‹</a></h2><p>Flinkç¨‹åºæ‰€å¤„ç†çš„æµä¸­çš„äº‹ä»¶ä¸€èˆ¬æ˜¯å¯¹è±¡ç±»å‹ã€‚æ“ä½œç¬¦æ¥æ”¶å¯¹è±¡è¾“å‡ºå¯¹è±¡ã€‚æ‰€ä»¥Flinkçš„å†…éƒ¨æœºåˆ¶éœ€è¦èƒ½å¤Ÿå¤„ç†äº‹ä»¶çš„ç±»å‹ã€‚åœ¨ç½‘ç»œä¸­ä¼ è¾“æ•°æ®ï¼Œæˆ–è€…å°†æ•°æ®å†™å…¥åˆ°çŠ¶æ€åç«¯ã€æ£€æŸ¥ç‚¹å’Œä¿å­˜ç‚¹ä¸­ï¼Œéƒ½éœ€è¦æˆ‘ä»¬å¯¹æ•°æ®è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚ä¸ºäº†é«˜æ•ˆçš„è¿›è¡Œæ­¤ç±»æ“ä½œï¼ŒFlinkéœ€è¦æµä¸­äº‹ä»¶ç±»å‹çš„è¯¦ç»†ä¿¡æ¯ã€‚Flinkä½¿ç”¨äº†<code>Type Information</code>çš„æ¦‚å¿µæ¥è¡¨è¾¾æ•°æ®ç±»å‹ï¼Œè¿™æ ·å°±èƒ½é’ˆå¯¹ä¸åŒçš„æ•°æ®ç±»å‹äº§ç”Ÿç‰¹å®šçš„åºåˆ—åŒ–å™¨ï¼Œååºåˆ—åŒ–å™¨å’Œæ¯”è¾ƒæ“ä½œç¬¦ã€‚</p><p>Flinkä¹Ÿèƒ½å¤Ÿé€šè¿‡åˆ†æè¾“å…¥æ•°æ®å’Œè¾“å‡ºæ•°æ®æ¥è‡ªåŠ¨è·å–æ•°æ®çš„ç±»å‹ä¿¡æ¯ä»¥åŠåºåˆ—åŒ–å™¨å’Œååºåˆ—åŒ–å™¨ã€‚å°½ç®¡å¦‚æ­¤ï¼Œåœ¨ä¸€äº›ç‰¹å®šçš„æƒ…å†µä¸‹ï¼Œä¾‹å¦‚åŒ¿åå‡½æ•°æˆ–è€…ä½¿ç”¨æ³›å‹çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®çš„æä¾›æ•°æ®çš„ç±»å‹ä¿¡æ¯ï¼Œæ¥æé«˜æˆ‘ä»¬ç¨‹åºçš„æ€§èƒ½ã€‚</p><h3 id="æ”¯æŒçš„æ•°æ®ç±»å‹"><a href="#æ”¯æŒçš„æ•°æ®ç±»å‹" class="headerlink" title="æ”¯æŒçš„æ•°æ®ç±»å‹"></a><a href="#%E6%94%AF%E6%8C%81%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">æ”¯æŒçš„æ•°æ®ç±»å‹</a></h3><p>Flinkæ”¯æŒJavaå’ŒScalaæä¾›çš„æ‰€æœ‰æ™®é€šæ•°æ®ç±»å‹ã€‚æœ€å¸¸ç”¨çš„æ•°æ®ç±»å‹å¯ä»¥åšä»¥ä¸‹åˆ†ç±»ï¼š</p><ul><li>Primitivesï¼ˆåŸå§‹æ•°æ®ç±»å‹ï¼‰</li><li>Javaå’ŒScalaçš„Tuplesï¼ˆå…ƒç»„ï¼‰</li><li>Scalaçš„æ ·ä¾‹ç±»</li><li>POJOç±»å‹</li><li>ä¸€äº›ç‰¹æ®Šçš„ç±»å‹</li></ul><p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬ä¸€æ¢ç©¶ç«Ÿã€‚</p><p><em>Primitives</em></p><p>Javaå’ŒScalaæä¾›çš„æ‰€æœ‰åŸå§‹æ•°æ®ç±»å‹éƒ½æ”¯æŒï¼Œä¾‹å¦‚<code>Int</code>(Javaçš„<code>Integer</code>)ï¼ŒStringï¼ŒDoubleç­‰ç­‰ã€‚ä¸‹é¢ä¸¾ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DataStream[Long] numbers = env.fromElements(<span class="number">1L</span>, <span class="number">2L</span>, <span class="number">3L</span>, <span class="number">4L</span>);</span><br><span class="line">numbers.map(n -&gt; n + <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p><em>Tuples</em></p><p>å…ƒç»„æ˜¯ä¸€ç§ç»„åˆæ•°æ®ç±»å‹ï¼Œç”±å›ºå®šæ•°é‡çš„å…ƒç´ ç»„æˆã€‚</p><p>Flinkä¸ºJavaçš„Tupleæä¾›äº†é«˜æ•ˆçš„å®ç°ã€‚Flinkå®ç°çš„Java Tupleæœ€å¤šå¯ä»¥æœ‰25ä¸ªå…ƒç´ ï¼Œæ ¹æ®å…ƒç´ æ•°é‡çš„ä¸åŒï¼ŒTupleéƒ½è¢«å®ç°æˆäº†ä¸åŒçš„ç±»ï¼šTuple1ï¼ŒTuple2ï¼Œä¸€ç›´åˆ°Tuple25ã€‚Tupleç±»æ˜¯å¼ºç±»å‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;Tuple2&lt;String, Integer&gt;&gt; persons = env</span><br><span class="line">  .fromElements(</span><br><span class="line">    Tuple2.of(<span class="string">&quot;Adam&quot;</span>, <span class="number">17</span>),</span><br><span class="line">    Tuple2.of(<span class="string">&quot;Sarah&quot;</span>, <span class="number">23</span>)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">persons.filter(p -&gt; p.f1 &gt; <span class="number">18</span>);</span><br></pre></td></tr></table></figure><p>Tupleçš„å…ƒç´ å¯ä»¥é€šè¿‡å®ƒä»¬çš„publicå±æ€§è®¿é—®â€”â€”f0ï¼Œf1ï¼Œf2ç­‰ç­‰ã€‚æˆ–è€…ä½¿ç”¨<code>getField(int pos)</code>æ–¹æ³•æ¥è®¿é—®ï¼Œå…ƒç´ ä¸‹æ ‡ä»0å¼€å§‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.tuple.Tuple2</span><br><span class="line"></span><br><span class="line">Tuple2&lt;String, Integer&gt; personTuple = Tuple2.of(<span class="string">&quot;Alex&quot;</span>, <span class="number">42</span>);</span><br><span class="line">Integer age = personTuple.getField(<span class="number">1</span>); <span class="comment">// age = 42</span></span><br></pre></td></tr></table></figure><p>ä¸åŒäºScalaçš„Tupleï¼ŒJavaçš„Tupleæ˜¯å¯å˜æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥Tupleä¸­çš„å…ƒç´ å¯ä»¥é‡æ–°è¿›è¡Œèµ‹å€¼ã€‚é‡å¤åˆ©ç”¨Javaçš„Tupleå¯ä»¥å‡è½»åƒåœ¾æ”¶é›†çš„å‹åŠ›ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">personTuple.f1 = <span class="number">42</span>; <span class="comment">// set the 2nd field to 42</span></span><br><span class="line">personTuple.setField(<span class="number">43</span>, <span class="number">1</span>); <span class="comment">// set the 2nd field to 43</span></span><br></pre></td></tr></table></figure><p><em>POJO</em></p><p>POJOç±»çš„å®šä¹‰ï¼š</p><ul><li>å…¬æœ‰ç±»</li><li>æ— å‚æ•°çš„å…¬æœ‰æ„é€ å™¨</li><li>æ‰€æœ‰çš„å­—æ®µéƒ½æ˜¯å…¬æœ‰çš„ï¼Œå¯ä»¥é€šè¿‡getterså’Œsettersè®¿é—®ã€‚</li><li>æ‰€æœ‰å­—æ®µçš„æ•°æ®ç±»å‹éƒ½å¿…é¡»æ˜¯Flinkæ”¯æŒçš„æ•°æ®ç±»å‹ã€‚</li></ul><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> String name;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">this</span>.age = age;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream&lt;Person&gt; persons = env.fromElements(</span><br><span class="line">  <span class="keyword">new</span> Person(<span class="string">&quot;Alex&quot;</span>, <span class="number">42</span>),</span><br><span class="line">  <span class="keyword">new</span> Person(<span class="string">&quot;Wendy&quot;</span>, <span class="number">23</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p><em>å…¶ä»–æ•°æ®ç±»å‹</em></p><ul><li>Array, ArrayList, HashMap, Enum</li><li>Hadoop Writable types</li></ul><h2 id="å®šä¹‰Keyä»¥åŠå¼•ç”¨å­—æ®µğŸ”º"><a href="#å®šä¹‰Keyä»¥åŠå¼•ç”¨å­—æ®µğŸ”º" class="headerlink" title="å®šä¹‰Keyä»¥åŠå¼•ç”¨å­—æ®µğŸ”º"></a><a href="#%E5%AE%9A%E4%B9%89key%E4%BB%A5%E5%8F%8A%E5%BC%95%E7%94%A8%E5%AD%97%E6%AE%B5">å®šä¹‰Keyä»¥åŠå¼•ç”¨å­—æ®µ</a>ğŸ”º</h2><p>åœ¨Flinkä¸­ï¼Œæˆ‘ä»¬å¿…é¡»æ˜ç¡®æŒ‡å®šè¾“å…¥æµä¸­çš„å…ƒç´ ä¸­çš„å“ªä¸€ä¸ªå­—æ®µæ˜¯keyã€‚</p><h3 id="ä½¿ç”¨å­—æ®µä½ç½®è¿›è¡ŒkeyBy"><a href="#ä½¿ç”¨å­—æ®µä½ç½®è¿›è¡ŒkeyBy" class="headerlink" title="ä½¿ç”¨å­—æ®µä½ç½®è¿›è¡ŒkeyBy"></a><a href="#%E4%BD%BF%E7%94%A8%E5%AD%97%E6%AE%B5%E4%BD%8D%E7%BD%AE%E8%BF%9B%E8%A1%8Ckeyby">ä½¿ç”¨å­—æ®µä½ç½®è¿›è¡ŒkeyBy</a></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;Tuple3&lt;Int, String, Long&gt;&gt; input = ...</span><br><span class="line">KeyedStream&lt;Tuple3&lt;Int, String, Long&gt;, String&gt; keyed = input.keyBy(<span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬æƒ³è¦ç”¨å…ƒç»„çš„ç¬¬2ä¸ªå­—æ®µå’Œç¬¬3ä¸ªå­—æ®µåškeyByï¼Œå¯ä»¥çœ‹ä¸‹é¢çš„ä¾‹å­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input.keyBy(<span class="number">1</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨å­—æ®µè¡¨è¾¾å¼æ¥è¿›è¡ŒkeyBy"><a href="#ä½¿ç”¨å­—æ®µè¡¨è¾¾å¼æ¥è¿›è¡ŒkeyBy" class="headerlink" title="ä½¿ç”¨å­—æ®µè¡¨è¾¾å¼æ¥è¿›è¡ŒkeyBy"></a><a href="#%E4%BD%BF%E7%94%A8%E5%AD%97%E6%AE%B5%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%9D%A5%E8%BF%9B%E8%A1%8Ckeyby">ä½¿ç”¨å­—æ®µè¡¨è¾¾å¼æ¥è¿›è¡ŒkeyBy</a></h3><p>å¯¹äºæ ·ä¾‹ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;SensorReading&gt; sensorStream = ...</span><br><span class="line">sensorStream.keyBy(<span class="string">&quot;id&quot;</span>);</span><br></pre></td></tr></table></figure><p>å¯¹äºå…ƒç»„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;Tuple3&lt;Integer, String, Long&gt;&gt; javaInput = ...</span><br><span class="line">javaInput.keyBy(<span class="string">&quot;f2&quot;</span>) <span class="comment">// key Java tuple by 3rd field</span></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-19_14-46-16.png"></p><h3 id="Keyé€‰æ‹©å™¨"><a href="#Keyé€‰æ‹©å™¨" class="headerlink" title="Keyé€‰æ‹©å™¨"></a><a href="#key%E9%80%89%E6%8B%A9%E5%99%A8">Keyé€‰æ‹©å™¨</a></h3><p>æ–¹æ³•ç±»å‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">KeySelector[IN, KEY]</span><br><span class="line">  &gt; getKey(IN): KEY</span><br></pre></td></tr></table></figure><p><strong>scala version</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> sensorData = ...</span><br><span class="line"><span class="keyword">val</span> byId = sensorData.keyBy(r =&gt; r.id)</span><br></pre></td></tr></table></figure><p><strong>java version</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;SensorReading&gt; sensorData = ...</span><br><span class="line">KeyedStream&lt;SensorReading, String&gt; byId = sensorData.keyBy(r -&gt; r.id);</span><br></pre></td></tr></table></figure><h2 id="å®ç°UDFå‡½æ•°ï¼Œæ›´ç»†ç²’åº¦çš„æ§åˆ¶æµ"><a href="#å®ç°UDFå‡½æ•°ï¼Œæ›´ç»†ç²’åº¦çš„æ§åˆ¶æµ" class="headerlink" title="å®ç°UDFå‡½æ•°ï¼Œæ›´ç»†ç²’åº¦çš„æ§åˆ¶æµ"></a><a href="#%E5%AE%9E%E7%8E%B0udf%E5%87%BD%E6%95%B0%E6%9B%B4%E7%BB%86%E7%B2%92%E5%BA%A6%E7%9A%84%E6%8E%A7%E5%88%B6%E6%B5%81">å®ç°UDFå‡½æ•°ï¼Œæ›´ç»†ç²’åº¦çš„æ§åˆ¶æµ</a></h2><p>å…¶ä¸Šä¸Šé¢çš„ä¾‹å­å·²ç»æœ‰ä½¿ç”¨UDFè‡ªå®šä¹‰å‡½æ•°å¤„ç†é€»è¾‘äº†ã€‚</p><h3 id="å‡½æ•°ç±»"><a href="#å‡½æ•°ç±»" class="headerlink" title="å‡½æ•°ç±»"></a><a href="#%E5%87%BD%E6%95%B0%E7%B1%BB">å‡½æ•°ç±»</a></h3><p>Flinkæš´éœ²äº†æ‰€æœ‰udfå‡½æ•°çš„æ¥å£(å®ç°æ–¹å¼ä¸ºæ¥å£æˆ–è€…æŠ½è±¡ç±»)ã€‚ä¾‹å¦‚MapFunction, FilterFunction, ProcessFunctionç­‰ç­‰ã€‚</p><p>ä¾‹å­å®ç°äº†FilterFunctionæ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FilterFilter</span> <span class="keyword">extends</span> <span class="title">FilterFunction</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Boolean <span class="title">filter</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> value.contains(<span class="string">&quot;flink&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream&lt;String&gt; flinkTweets = tweets.filter(<span class="keyword">new</span> FlinkFilter);</span><br></pre></td></tr></table></figure><p>è¿˜å¯ä»¥å°†å‡½æ•°å®ç°æˆåŒ¿åç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;String&gt; flinkTweets = tweets.filter(</span><br><span class="line">  <span class="keyword">new</span> RichFilterFunction&lt;String&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">filter</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> value.contains(<span class="string">&quot;flink&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬filterçš„å­—ç¬¦ä¸²â€flinkâ€è¿˜å¯ä»¥å½“ä½œå‚æ•°ä¼ è¿›å»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;String&gt; tweets = ...</span><br><span class="line">DataStream&lt;String&gt; flinkTweets = tweets.filter(<span class="keyword">new</span> KeywordFilter(<span class="string">&quot;flink&quot;</span>));</span><br><span class="line"></span><br><span class="line">class KeywordFilter(keyWord: String) extends FilterFunction&lt;String&gt; &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Boolean <span class="title">filter</span><span class="params">(String value)</span> </span>= &#123;</span><br><span class="line">    <span class="keyword">return</span> value.contains(keyWord);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åŒ¿åå‡½æ•°"><a href="#åŒ¿åå‡½æ•°" class="headerlink" title="åŒ¿åå‡½æ•°"></a><a href="#%E5%8C%BF%E5%90%8D%E5%87%BD%E6%95%B0">åŒ¿åå‡½æ•°</a></h3><p><strong>åŒ¿åå‡½æ•°å¯ä»¥å®ç°ä¸€äº›ç®€å•çš„é€»è¾‘ï¼Œä½†æ— æ³•å®ç°ä¸€äº›é«˜çº§åŠŸèƒ½ï¼Œä¾‹å¦‚è®¿é—®çŠ¶æ€ç­‰ç­‰ã€‚</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;String&gt; tweets = ...</span><br><span class="line">DataStream&lt;String&gt; flinkTweets = tweets.filter(r -&gt; r.contains(<span class="string">&quot;flink&quot;</span>));</span><br></pre></td></tr></table></figure><h3 id="å¯Œå‡½æ•°ğŸ”º"><a href="#å¯Œå‡½æ•°ğŸ”º" class="headerlink" title="å¯Œå‡½æ•°ğŸ”º"></a><a href="#%E5%AF%8C%E5%87%BD%E6%95%B0">å¯Œå‡½æ•°</a>ğŸ”º</h3><p>å…¶å®ä¸Šé¢çš„æ•°æ®æºå°±æ˜¯ç”¨äº†å¯Œå‡½æ•°ï¼Œå®ƒå¯ä»¥å®šä¹‰æ›´å¤šçš„æ“ä½œã€‚</p><p>æˆ‘ä»¬ç»å¸¸ä¼šæœ‰è¿™æ ·çš„éœ€æ±‚<strong>ï¼šåœ¨å‡½æ•°å¤„ç†æ•°æ®ä¹‹å‰ï¼Œéœ€è¦åšä¸€äº›åˆå§‹åŒ–çš„å·¥ä½œï¼›æˆ–è€…éœ€è¦åœ¨å¤„ç†æ•°æ®æ—¶å¯ä»¥è·å¾—å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡çš„ä¸€äº›ä¿¡æ¯ï¼›ä»¥åŠåœ¨å¤„ç†å®Œæ•°æ®æ—¶åšä¸€äº›æ¸…ç†å·¥ä½œã€‚</strong>è€ŒDataStream APIå°±æä¾›äº†è¿™æ ·çš„æœºåˆ¶ã€‚</p><p>DataStream APIæä¾›çš„æ‰€æœ‰è½¬æ¢æ“ä½œå‡½æ•°ï¼Œéƒ½æ‹¥æœ‰å®ƒä»¬çš„â€œå¯Œâ€ç‰ˆæœ¬ï¼Œå¹¶ä¸”æˆ‘ä»¬åœ¨ä½¿ç”¨å¸¸è§„å‡½æ•°æˆ–è€…åŒ¿åå‡½æ•°çš„åœ°æ–¹æ¥ä½¿ç”¨å¯Œå‡½æ•°ã€‚ä¾‹å¦‚ä¸‹é¢å°±æ˜¯å¯Œå‡½æ•°çš„ä¸€äº›ä¾‹å­ï¼Œå¯ä»¥çœ‹å‡ºï¼Œ<strong>åªéœ€è¦åœ¨å¸¸è§„å‡½æ•°çš„å‰é¢åŠ ä¸Š<code>Rich</code>å‰ç¼€å°±æ˜¯å¯Œå‡½æ•°äº†ã€‚</strong></p><ul><li>RichMapFunction</li><li>RichFlatMapFunction</li><li>RichFilterFunction</li><li>â€¦</li></ul><p>å½“æˆ‘ä»¬ä½¿ç”¨å¯Œå‡½æ•°æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸¤ä¸ªé¢å¤–çš„æ–¹æ³•ï¼š</p><ul><li>open()æ–¹æ³•æ˜¯rich functionçš„åˆå§‹åŒ–æ–¹æ³•ï¼Œå½“ä¸€ä¸ªç®—å­ä¾‹å¦‚mapæˆ–è€…filterè¢«è°ƒç”¨ä¹‹å‰open()ä¼šè¢«è°ƒç”¨ã€‚open()å‡½æ•°é€šå¸¸ç”¨æ¥åšä¸€äº›åªéœ€è¦åšä¸€æ¬¡å³å¯çš„åˆå§‹åŒ–å·¥ä½œã€‚</li><li>close()æ–¹æ³•æ˜¯ç”Ÿå‘½å‘¨æœŸä¸­çš„æœ€åä¸€ä¸ªè°ƒç”¨çš„æ–¹æ³•ï¼Œé€šå¸¸ç”¨æ¥åšä¸€äº›æ¸…ç†å·¥ä½œã€‚</li></ul><p>å¦å¤–ï¼ŒgetRuntimeContext()æ–¹æ³•æä¾›äº†å‡½æ•°çš„RuntimeContextçš„ä¸€äº›ä¿¡æ¯ï¼Œä¾‹å¦‚å‡½æ•°æ‰§è¡Œçš„å¹¶è¡Œåº¦ï¼Œå½“å‰å­ä»»åŠ¡çš„ç´¢å¼•ï¼Œå½“å‰å­ä»»åŠ¡çš„åå­—ã€‚åŒæ—¶è¿˜å®ƒè¿˜åŒ…å«äº†è®¿é—®<strong>åˆ†åŒºçŠ¶æ€</strong>çš„æ–¹æ³•ã€‚ä¸‹é¢çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFlatMap</span> <span class="keyword">extends</span> <span class="title">RichFlatMapFunction</span>&lt;<span class="title">Integer</span>, <span class="title">Tuple2</span>&lt;<span class="title">Integer</span>, <span class="title">Integer</span>&gt;&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> subTaskIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration configuration)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> subTaskIndex = getRuntimeContext.getIndexOfThisSubtask;</span><br><span class="line">    <span class="comment">// åšä¸€äº›åˆå§‹åŒ–å·¥ä½œ</span></span><br><span class="line">    <span class="comment">// ä¾‹å¦‚å»ºç«‹ä¸€ä¸ªå’ŒHDFSçš„è¿æ¥</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flatMap</span><span class="params">(Integer in, Collector&lt;Tuple2&lt;Integer, Integer&gt;&gt; out)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (in % <span class="number">2</span> == subTaskIndex) &#123;</span><br><span class="line">      out.collect((subTaskIndex, in));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ¸…ç†å·¥ä½œï¼Œæ–­å¼€å’ŒHDFSçš„è¿æ¥ã€‚</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Window-API"><a href="#Window-API" class="headerlink" title="Window API"></a>Window API</h1><p>ä¸€èˆ¬çœŸå®çš„æµéƒ½æ˜¯æ— ç•Œçš„ï¼Œæ€æ ·å¤„ç†æ— ç•Œçš„æ•°æ®ï¼Ÿ</p><p>å°†æ— ç•Œæµè½¬æ¢ä¸ºæœ‰ç•Œæµå¼€å§‹è®¡ç®—ï¼Œå› ä¸ºæ— ç•Œæµæ˜¯æ— é™åˆ¶çš„ï¼Œä¸ä¼šæœ‰ç»“æœã€‚</p><p>å¯ä»¥æŠŠæ— é™çš„æ•°æ®æµè¿›è¡Œåˆ‡åˆ†ï¼Œå¾—åˆ°æœ‰é™çš„æ•°æ®é›†è¿›è¡Œå¤„ç† â€”â€” ä¹Ÿå°±æ˜¯å¾—åˆ°æœ‰ç•Œæµï¼›çª—å£ï¼ˆwindowï¼‰å°±æ˜¯å°†æ— é™æµåˆ‡å‰²ä¸ºæœ‰é™æµçš„ä¸€ç§æ–¹å¼ï¼Œå®ƒä¼šå°†æµæ•°æ®åˆ†å‘åˆ°æœ‰é™å¤§å°çš„æ¡¶ï¼ˆbucketï¼‰ä¸­è¿›è¡Œåˆ†æ</p><h2 id="window-ç±»å‹"><a href="#window-ç±»å‹" class="headerlink" title="window ç±»å‹"></a>window ç±»å‹</h2><ol><li>æ—¶é—´çª—å£ï¼ˆTime Windowï¼‰ï¼šä¸»è¦å†™çš„æ—¶é—´çª—å£ï¼Œè®¡æ•°çª—å£ç±»ä¼¼ã€‚<ul><li><a href="#%E6%97%B6%E9%97%B4%E6%BB%9A%E5%8A%A8%E7%AA%97%E5%8F%A3">æ»šåŠ¨æ—¶é—´çª—å£</a>ï¼š<strong>Tumbling Windows</strong></li><li><a href="#%E6%97%B6%E9%97%B4%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3">æ»‘åŠ¨æ—¶é—´çª—å£</a>ï¼š<strong>Sliding Windows</strong></li><li><a href="#%E4%BC%9A%E8%AF%9D%E7%AA%97%E5%8F%A3">ä¼šè¯çª—å£</a>ï¼š<strong>Session Windows</strong></li></ul></li><li>è®¡æ•°çª—å£ï¼ˆCount Windowï¼‰<ul><li>æ»šåŠ¨è®¡æ•°çª—å£</li><li>æ»‘åŠ¨è®¡æ•°çª—å£</li></ul></li></ol><h3 id="æ—¶é—´çª—å£"><a href="#æ—¶é—´çª—å£" class="headerlink" title="æ—¶é—´çª—å£"></a>æ—¶é—´çª—å£</h3><p><font color="red">æ—¶é—´çª—å£åˆåˆ†ä¸ºï¼šäº‹ä»¶æ—¶é—´ã€è§¦å‘æ—¶é—´ã€‚é»˜è®¤çš„æ˜¯è§¦å‘æ—¶é—´çª—å£</font></p><h4 id="æ—¶é—´æ»šåŠ¨çª—å£"><a href="#æ—¶é—´æ»šåŠ¨çª—å£" class="headerlink" title="æ—¶é—´æ»šåŠ¨çª—å£"></a>æ—¶é—´æ»šåŠ¨çª—å£</h4><p><strong>Tumbling Windows</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201220215345926.png" alt="image-20201220215345926"></p><ol><li>æ—¶é—´å¯¹é½ï¼Œçª—å£é•¿åº¦å›ºå®šï¼Œæ²¡æœ‰é‡å </li><li>æ»šåŠ¨çª—å£æ˜¯ç‰¹æ®Šçš„æ»‘åŠ¨çª—å£ï¼ˆæ»‘åŠ¨é—´éš”=çª—å£é•¿åº¦ï¼‰</li><li>å·¦é—­å³å¼€</li></ol><p>æ»šåŠ¨çª—å£è®¡ç®—æŸä¸€ç§’æ‰€åœ¨çš„çª—å£çš„èµ·å§‹æ—¶é—´ï¼Œoffset=0ï¼Œts=1â€¦n(s)ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201220144118892.png" alt="image-20201220144118892"></p><h4 id="æ—¶é—´æ»‘åŠ¨çª—å£"><a href="#æ—¶é—´æ»‘åŠ¨çª—å£" class="headerlink" title="æ—¶é—´æ»‘åŠ¨çª—å£"></a>æ—¶é—´æ»‘åŠ¨çª—å£</h4><p><strong>Sliding Windows</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201220220206360.png" alt="image-20201220220206360"></p><ol><li>æ»‘åŠ¨çª—å£æ˜¯å›ºå®šçª—å£çš„æ›´å¹¿ä¹‰çš„ä¸€ç§å½¢å¼ï¼Œæ»‘åŠ¨çª—å£ç”±å›ºå®šçš„çª—å£é•¿åº¦å’Œæ»‘åŠ¨é—´éš”ç»„æˆ</li><li>çª—å£é•¿åº¦å›ºå®šï¼Œå¯ä»¥æœ‰é‡å </li></ol><blockquote><p>æ³¨æ„ï¼š</p><p>å› ä¸ºæ»‘åŠ¨çª—å£åœ¨æ»‘åŠ¨é—´éš”&lt;çª—å£é•¿åº¦æ—¶ï¼Œä¸åŒçš„çª—å£ä¼šæœ‰é‡å¤çš„æ•°æ®ï¼Œä¸ºäº†å‰é¢çš„çª—å£çš„æ¶ˆå¤±ä¸å½±å“åé¢çª—å£çš„æ•°æ®ï¼ŒFlinkä¼šå°†æ•°æ®å¤åˆ¶åˆ†åˆ«ç»™ä½¿ç”¨åˆ°æ­¤æ•°æ®çš„ä¸åŒçª—å£ã€‚</p><p><font color="red">æ‰€ä»¥ï¼Œå¦‚æœæ»‘åŠ¨é—´éš”è¿‡å°ï¼Œä¼šå¯¼è‡´Flinkå¤åˆ¶è¿‡å¤šçš„æ•°æ®ï¼Œé€ æˆæ•ˆç‡ä¸¥é‡é™ä½ã€‚</font></p><p>ä¾‹å¦‚ï¼š</p><p>çª—å£é•¿åº¦100minï¼Œçª—å£å“¦é—´éš”1minï¼›è¿™æ ·æ¯è¿‡ä¸€åˆ†é’Ÿï¼Œå°±ä¼šå¤åˆ¶æ­¤çª—å£çš„å99æ¡æ•°æ®ç»™ä¸‹ä¸€ä¸ªçª—å£ã€‚</p></blockquote><h4 id="ä¼šè¯çª—å£"><a href="#ä¼šè¯çª—å£" class="headerlink" title="ä¼šè¯çª—å£"></a>ä¼šè¯çª—å£</h4><p><strong>Session Windows</strong>ï¼Œåªæœ‰æ—¶é—´çª—å£æ‰æœ‰ä¼šè¯çª—å£</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201220221007431.png" alt="image-20201220221007431"></p><ol><li>ç”±ä¸€ç³»åˆ—äº‹ä»¶ç»„åˆä¸€ä¸ªæŒ‡å®šæ—¶é—´é•¿åº¦çš„ timeout é—´éš™ç»„æˆï¼Œä¹Ÿå°±æ˜¯ä¸€æ®µæ—¶é—´æ²¡æœ‰æ¥æ”¶åˆ°æ–°æ•°æ®å°±ä¼šç”Ÿæˆæ–°çš„çª—å£</li><li>ç‰¹ç‚¹ï¼šæ—¶é—´æ— å¯¹é½</li></ol><blockquote><p> æŒ‡å®šæ—¶é—´é•¿åº¦timeoutå†…æ— æ•°æ®ï¼Œæ–°æ•°æ®æ¥ä¸´åä¼šç›´æ¥äº§ç”Ÿæ–°çš„çª—å£ã€‚å®ƒå¯ç”¨æ¥ç»Ÿè®¡è¡Œä¸ºæ¨¡å¼</p><p> å³ï¼šæ–°æ¥çš„äº‹ä»¶å’Œä¸Šä¸€äº‹ä»¶çš„æ—¶é—´é—´éš”å¤§äºtimeoutçš„è¯ï¼Œä¸Šä¸€çª—å£ç›´æ¥å…³é—­ï¼Œæ–°æ¥çš„äº‹ä»¶åœ¨æ–°çš„çª—å£ï¼Œæ˜¯å®ƒçš„ç¬¬ä¸€ä¸ªäº‹ä»¶ã€‚</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201221150605732.png" alt="image-20201221150605732"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201221150626503.png" alt="image-20201221150626503"></p><h2 id="Window-API-1"><a href="#Window-API-1" class="headerlink" title="Window API"></a>Window API</h2><p><strong><font color="red">ä¸€èˆ¬æ•°æ®å…ˆåˆ†æµåå¼€çª—ã€‚</font>åˆ†æµåä¸åŒkeyå¯èƒ½ä¸åœ¨ä¸€ä¸ªslotä¸­ä¹Ÿå¯èƒ½ä¸åœ¨ä¸€ä¸ªtaskmanagerä¸­ï¼Œè¿™æ ·ï¼Œæ¯ä¸ªkeyçš„çª—å£äº’ä¸å¹²æ¶‰ï¼ŒåŠ å¤§å¹¶è¡Œã€‚</strong></p><h3 id="create-window"><a href="#create-window" class="headerlink" title="create window"></a>create window</h3><p><strong><em>window</em></strong></p><p>æœ€åº•å±‚çš„å¼€çª—å£çš„æ–¹æ³•ï¼š<code>window()</code>ã€‚ç”¨ <code>.window() </code>æ¥å®šä¹‰ä¸€ä¸ªçª—å£ï¼Œç„¶ååŸºäºè¿™ä¸ª window å»åšä¸€äº›èšåˆæˆ–è€…å…¶å®ƒå¤„ç†æ“ä½œã€‚æ³¨æ„ window () æ–¹æ³•å¿…é¡»åœ¨ keyBy ä¹‹åæ‰èƒ½ç”¨ã€‚</p><blockquote><p>window()ä¸windowall()</p><p>windowall()æ˜¯åº”ç”¨åœ¨DataStreamä¸Šçš„ï¼Œå°†æ‰€æœ‰æ•°æ®æ”¾åœ¨ä¸€ä¸ªçª—å£ä¸­</p><p>window()æ˜¯åº”ç”¨åœ¨DataStreamå’Œ<strong>KeydStream</strong>ä¸Šçš„ã€‚</p></blockquote><p>è€Œ<code>window</code>æ–¹æ³•æ„é€ æ—¶é—´ã€è®¡æ•°çª—å£æ˜¯éœ€è¦ä¸€ä¸ªçª—å£åˆ†é…å™¨ï¼ˆ<strong>window assigner</strong>ï¼‰çš„ã€‚WindowAssigner è´Ÿè´£å°†æ¯æ¡è¾“å…¥çš„æ•°æ®åˆ†å‘åˆ°æ­£ç¡®çš„ window ä¸­ï¼ŒFlink æä¾›äº†é€šç”¨çš„ <strong>WindowAssigner</strong>ï¼š</p><ul><li>æ»šåŠ¨çª—å£ï¼ˆtumbling windowï¼‰</li><li>æ»‘åŠ¨çª—å£ï¼ˆsliding windowï¼‰</li><li>ä¼šè¯çª—å£ï¼ˆsession windowï¼‰</li><li>å…¨å±€çª—å£ï¼ˆglobal windowï¼‰ï¼Œéƒ½åœ¨ä¸€ä¸ªçª—å£ä¸­</li></ul><hr><p><strong><em>timewindow</em>,<em>countwindow</em>ğŸ”º</strong></p><p>windowæ–¹æ³•åˆ›å»ºè¿˜éœ€è¦<strong>window assigner</strong>ï¼Œæ¯”è¾ƒéº»çƒ¦ã€‚Flink æä¾›äº†æ›´åŠ ç®€å•çš„<code> .timeWindow</code> å’Œ<code>.countWindow</code> æ–¹æ³•ï¼Œç”¨äºå®šä¹‰æ—¶é—´çª—å£å’Œè®¡æ•°çª—å£ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">env.addSource(<span class="keyword">new</span> <span class="type">SensorSource</span>)</span><br><span class="line">    .keyBy(<span class="number">0</span>).timeWindow(<span class="type">Time</span>.seconds(<span class="number">5</span>L))</span><br><span class="line">    .reduce((r1, _)=&gt;r1).print()</span><br></pre></td></tr></table></figure><p><img src="E:\Projects\sync\md\flink\Snipaste_2020-12-19_12-00-52.png" alt="image-20201220102331672"></p><blockquote><p>Flinkçš„çª—å£å‡½æ•°å’ŒSparkçš„æœ‰æ‰€ä¸åŒï¼Œå³å¼€çª—å£çš„ç±»å‹æ˜¯SensorReadingè€Œä¸æ˜¯SensorReading[]ï¼Œå› ä¸ºå®ƒå®é™…ä¸Šæ˜¯æ‰¹å¤„ç†ï¼Œå³æ¥ä¸€æ¡æ•°æ®ç»™ä¸€æ¡æ•°æ®æ‰“ä¸Šçª—å£çš„æ ‡ç­¾ã€‚è€Œä¸æ˜¯èµä¸€ä¸ªçª—å£çš„æ•°æ®å†å¤„ç†ï¼ŒFlinkä¹Ÿèƒ½è¿™æ ·åšå³ä½¿ç”¨å…¨çª—å£å‡½æ•°<code>ProcessWindowFunction</code>ã€‚</p></blockquote><p><strong>åˆ›å»ºä¸åŒç±»å‹çš„çª—å£</strong>ï¼š</p><ol><li><strong>æ»šåŠ¨æ—¶é—´çª—å£ï¼ˆtumbling time windowï¼‰</strong>ï¼š<code>.timeWindow(Time.seconds(5L))</code></li><li><strong>æ»‘åŠ¨æ—¶é—´çª—å£ï¼ˆsliding time windowï¼‰</strong>ï¼š<code>.timeWindow(Time.seconds(5L), Time.seconds(1L))</code></li><li><strong>ä¼šè¯çª—å£ï¼ˆsession windowï¼‰</strong>ï¼š<code>.window(EventTimeSessionWindows.withGrap(Time.minutes(10)))</code></li><li><strong>æ»šåŠ¨è®¡æ•°çª—å£ï¼ˆtumbling count windowï¼‰</strong>ï¼š<code>.countWindow(Time.seconds(5L))</code></li><li><strong>æ»‘åŠ¨è®¡æ•°çª—å£ï¼ˆsliding count windowï¼‰</strong>ï¼š<code>.countWindow(Time.seconds(5L), Time.seconds(1L))</code></li></ol><h3 id="window-functionğŸ”º"><a href="#window-functionğŸ”º" class="headerlink" title="window functionğŸ”º"></a>window functionğŸ”º</h3><p>window function å®šä¹‰äº†è¦å¯¹çª—å£ä¸­æ”¶é›†çš„æ•°æ®åšçš„è®¡ç®—æ“ä½œï¼Œå¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li>å¢é‡èšåˆå‡½æ•°ï¼šæ¯æ¡æ•°æ®åˆ°æ¥å°±è¿›è¡Œè®¡ç®—,åªä¿å­˜ä¸€ä¸ªç®€å•çš„çŠ¶æ€(ç´¯åŠ å™¨)ï¼Œçª—å£é—­åˆå³è®¡ç®—å®Œæˆ<ul><li>ReduceFuntion</li><li>AggregateFunction<ul><li>mergeåªä¼šåœ¨äº‹ä»¶æ—¶é—´çš„çª—å£ä¸­ç”¨åˆ°</li></ul></li></ul></li><li>å…¨çª—å£å‡½æ•°ï¼šå…ˆæŠŠçª—å£æ‰€æœ‰æ•°æ®æ”¶é›†èµ·æ¥,ç­‰åˆ°è®¡ç®—çš„æ—¶å€™ä¼šéå†æ‰€æœ‰æ•°æ®.ç±»ä¼¼äºSparkçš„å¾®æ‰¹å¤„ç†ï¼ŒåŒºåˆ«æ˜¯æ—¶é—´åŒºåŸŸï¼ˆProcessWindowFunctionï¼Œä¸€ä¸ªå¯Œå‡½æ•°ï¼‰</li></ul><h3 id="å…¶ä»–API"><a href="#å…¶ä»–API" class="headerlink" title="å…¶ä»–API"></a>å…¶ä»–API</h3><ul><li>.trigger() â€”â€” è§¦å‘å™¨ï¼šå®šä¹‰ window ä»€ä¹ˆæ—¶å€™å…³é—­ï¼Œè§¦å‘è®¡ç®—å¹¶è¾“å‡ºç»“æœ</li><li>.evictor() â€”â€” ç§»é™¤å™¨ï¼šå®šä¹‰ç§»é™¤æŸäº›æ•°æ®çš„é€»è¾‘</li><li>.allowedLateness() â€”â€” å…è®¸å¤„ç†è¿Ÿåˆ°çš„æ•°æ®</li><li>.sideOutputLateData() â€”â€” å°†è¿Ÿåˆ°çš„æ•°æ®æ”¾å…¥ä¾§è¾“å‡ºæµ</li><li>.getSideOutput() â€”â€” è·å–ä¾§è¾“å‡ºæµ</li></ul><h2 id="å¢é‡èšåˆä¸å…¨é‡èšåˆ"><a href="#å¢é‡èšåˆä¸å…¨é‡èšåˆ" class="headerlink" title="å¢é‡èšåˆä¸å…¨é‡èšåˆ"></a>å¢é‡èšåˆä¸å…¨é‡èšåˆ</h2><h3 id="å¢é‡èšåˆ"><a href="#å¢é‡èšåˆ" class="headerlink" title="å¢é‡èšåˆ"></a>å¢é‡èšåˆ</h3><h4 id="ReduceFunction"><a href="#ReduceFunction" class="headerlink" title="ReduceFunction"></a><em>ReduceFunction</em></h4><p>æ¯”è¾ƒæŠ½è±¡ï¼Œå®ç°ç®€å•ï¼Œå®ç°çš„åŠŸèƒ½è¾ƒå°‘ï¼Œä¸å¯ä»¥æ”¹å˜æµçš„æ•°æ®ç±»å‹ã€‚</p><h4 id="AggregateFunction"><a href="#AggregateFunction" class="headerlink" title="AggregateFunction"></a><em>AggregateFunction</em></h4><p>æ¯”reduceå®ç°è¾ƒéº»çƒ¦ï¼Œä½†æ˜¯å¯ä»¥æ”¹å˜æµä¸­çš„æ•°æ®ç±»å‹ï¼Œè¾ƒçµæ´»ã€‚</p><blockquote><p>å®ƒçš„ä¼˜ç‚¹ï¼šæ¯ä¸ªçª—å£åªç”¨ä¿å­˜ä¸€ä¸ªçŠ¶æ€å³å¯ã€‚æ­£æ˜¯å› ä¸ºå®ƒçš„ä¼˜ç‚¹ç»™å®ƒå¸¦æ¥äº†ä¸€äº›ç¼ºç‚¹ï¼šå› ä¸ºä¿å­˜çš„æ•°æ®å°‘ï¼Œæ— æ³•è®¡ç®—ä¸€äº›åœºæ™¯ï¼šä¾‹å¦‚è®¡ç®—çª—å£æ•°æ®çš„ä¸­ä½æ•°ï¼Œæˆ–è€…è®¡ç®—çª—å£æ•°æ®ä¸­å‡ºç°é¢‘ç‡æœ€é«˜çš„å€¼ã€‚</p><p>è¿™æ—¶ä½¿ç”¨ReduceFunctionå’ŒAggregateFunctionå°±æ— æ³•å®ç°äº†ã€‚<font color="red">ã€‚è¿™ä¸ªæ—¶å€™å°±éœ€è¦ProcessWindowFunctionäº†ã€‚</font></p></blockquote><p>å…ˆæ¥çœ‹æ¥å£å®šä¹‰<em>AggregateFunction</em>ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public interface <span class="type">AggregateFunction</span>&lt;<span class="type">IN</span>, <span class="type">ACC</span>, <span class="type">OUT</span>&gt;</span><br><span class="line">  <span class="keyword">extends</span> <span class="type">Function</span>, <span class="type">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// create a new accumulator to start a new aggregate</span></span><br><span class="line">  <span class="type">ACC</span> createAccumulator();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// add an input element to the accumulator and return the accumulator</span></span><br><span class="line">  <span class="type">ACC</span> add(<span class="type">IN</span> value, <span class="type">ACC</span> accumulator);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// compute the result from the accumulator and return it.</span></span><br><span class="line">  <span class="type">OUT</span> getResult(<span class="type">ACC</span> accumulator);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// merge two accumulators and return the result.</span></span><br><span class="line">  <span class="type">ACC</span> merge(<span class="type">ACC</span> a, <span class="type">ACC</span> b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>INæ˜¯è¾“å…¥å…ƒç´ çš„ç±»å‹ï¼ŒACCæ˜¯ç´¯åŠ å™¨çš„ç±»å‹ï¼ŒOUTæ˜¯è¾“å‡ºå…ƒç´ çš„ç±»å‹ã€‚</p><p>ä¾‹å¦‚ï¼šæ±‚å¹³å‡æ¸©åº¦ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">TumblingWindow</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line"></span><br><span class="line">    env.addSource(<span class="keyword">new</span> <span class="type">SensorSource</span>)</span><br><span class="line">      .keyBy(<span class="number">0</span>).timeWindow(<span class="type">Time</span>.seconds(<span class="number">5</span>L))</span><br><span class="line">      <span class="comment">// ä¾‹å¦‚è®¡ç®—å¹³å‡æ¸©åº¦</span></span><br><span class="line">      .aggregate(<span class="keyword">new</span> <span class="type">MyAggregate</span>).print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ã€æµè¾“å…¥ã€ç´¯åŠ å™¨ã€æµè¾“å‡ºã€‘</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MyAggregate</span> <span class="keyword">extends</span> <span class="title">AggregateFunction</span>[<span class="type">SensorReading</span>, (<span class="type">String</span>, <span class="type">Long</span>, <span class="type">Double</span>), (<span class="type">String</span>, <span class="type">Double</span>)] </span>&#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–ç´¯åŠ å™¨</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">createAccumulator</span></span>(): (<span class="type">String</span>, <span class="type">Long</span>, <span class="type">Double</span>) = &#123;</span><br><span class="line">      (<span class="string">&quot;&quot;</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç´¯åŠ é€»è¾‘</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(in: <span class="type">SensorReading</span>, acc: (<span class="type">String</span>, <span class="type">Long</span>, <span class="type">Double</span>)): (<span class="type">String</span>, <span class="type">Long</span>, <span class="type">Double</span>) = &#123;</span><br><span class="line">      (in.id, acc._2 + <span class="number">1</span>, acc._3 + in.temperature)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æµåˆå¹¶ï¼Œåªæœ‰äº‹ä»¶æ—¶é—´ï¼ˆé»˜è®¤ä¸ºè§¦å‘æ—¶é—´çª—å£ï¼‰çª—å£æ‰ä¼šç”¨åˆ°</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">merge</span></span>(acc: (<span class="type">String</span>, <span class="type">Long</span>, <span class="type">Double</span>), acc1: (<span class="type">String</span>, <span class="type">Long</span>, <span class="type">Double</span>)): (<span class="type">String</span>, <span class="type">Long</span>, <span class="type">Double</span>) = &#123;</span><br><span class="line">      (acc._1, acc._2 + acc1._2, acc._3 + acc1._3)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getResult</span></span>(acc: (<span class="type">String</span>, <span class="type">Long</span>, <span class="type">Double</span>)): (<span class="type">String</span>, <span class="type">Double</span>) = &#123;</span><br><span class="line">      (acc._1, acc._3 / acc._2)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å…¨é‡èšåˆ"><a href="#å…¨é‡èšåˆ" class="headerlink" title="å…¨é‡èšåˆ"></a>å…¨é‡èšåˆ</h3><h4 id="ProcessWindowFunction"><a href="#ProcessWindowFunction" class="headerlink" title="ProcessWindowFunction"></a><em>ProcessWindowFunction</em></h4><p>ä¸€äº›ä¸šåŠ¡åœºæ™¯ï¼Œæˆ‘ä»¬éœ€è¦æ”¶é›†çª—å£å†…æ‰€æœ‰çš„æ•°æ®è¿›è¡Œè®¡ç®—ï¼Œä¾‹å¦‚è®¡ç®—çª—å£æ•°æ®çš„ä¸­ä½æ•°ï¼Œæˆ–è€…è®¡ç®—çª—å£æ•°æ®ä¸­å‡ºç°é¢‘ç‡æœ€é«˜çš„å€¼ã€‚è¿™æ ·çš„éœ€æ±‚ï¼Œä½¿ç”¨ReduceFunctionå’ŒAggregateFunctionå°±æ— æ³•å®ç°äº†ã€‚è¿™ä¸ªæ—¶å€™å°±éœ€è¦ProcessWindowFunctionäº†ã€‚</p><blockquote><p>ä½†æ˜¯ï¼Œæ­¤æ–¹æ³•è™½ç„¶èƒ½è·å–åˆ°çš„ä¿¡æ¯æ¯”è¾ƒå¤šï¼Œä¾‹å¦‚ï¼šçª—å£ä¿¡æ¯å’Œçª—å£å†…æ‰€æœ‰æ•°æ®çš„é›†åˆã€‚ä½†æ˜¯æ­£å¼å› ä¸ºå­˜çš„ä¸œè¥¿è¿‡å¤šï¼Œå°†ä¼šéå¸¸å ç”¨ç©ºé—´ã€‚æ‰€ä»¥ æœ‰ä¸€ç§å°†ReduceFunction/AggregateFunctionProcessWindowFunctionç»“åˆèµ·æ¥ä½¿ç”¨çš„æ–¹å¼ï¼Œå¸å–ä¸¤è¾¹çš„ä¼˜ç‚¹ã€‚<font color="red">å¢é‡èšåˆè´Ÿè´£èšåˆï¼Œå…¨çª—å£å‡½æ•°è´Ÿè´£åŒ…è£…çª—å£ä¿¡æ¯</font></p></blockquote><p>å…ˆæ¥çœ‹æ¥å£å®šä¹‰</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessWindowFunction&lt;IN</span>, <span class="title">OUT</span>, <span class="title">KEY</span>, <span class="title">W</span> <span class="keyword">extends</span> <span class="title">Window&gt;</span></span></span><br><span class="line"><span class="class">  <span class="keyword">extends</span> <span class="title">AbstractRichFunction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Evaluates the window</span></span><br><span class="line">  void process(<span class="type">KEY</span> key, <span class="type">Context</span> ctx, <span class="type">Iterable</span>&lt;<span class="type">IN</span>&gt; vals, <span class="type">Collector</span>&lt;<span class="type">OUT</span>&gt; out)</span><br><span class="line">    <span class="keyword">throws</span> <span class="type">Exception</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Deletes any custom per-window state when the window is purged</span></span><br><span class="line">  public void clear(<span class="type">Context</span> ctx) <span class="keyword">throws</span> <span class="type">Exception</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The context holding window metadata</span></span><br><span class="line">  public <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Context</span> <span class="title">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Returns the metadata of the window</span></span><br><span class="line">    public <span class="keyword">abstract</span> <span class="type">W</span> window();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Returns the current processing time</span></span><br><span class="line">    public <span class="keyword">abstract</span> long currentProcessingTime();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Returns the current event-time watermark</span></span><br><span class="line">    public <span class="keyword">abstract</span> long currentWatermark();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// State accessor for per-window state</span></span><br><span class="line">    public <span class="keyword">abstract</span> <span class="type">KeyedStateStore</span> windowState();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// State accessor for per-key global state</span></span><br><span class="line">    public <span class="keyword">abstract</span> <span class="type">KeyedStateStore</span> globalState();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Emits a record to the side output identified by the OutputTag.</span></span><br><span class="line">    public <span class="keyword">abstract</span> &lt;<span class="type">X</span>&gt; void output(<span class="type">OutputTag</span>&lt;<span class="type">X</span>&gt; outputTag, <span class="type">X</span> value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>process()æ–¹æ³•æ¥å—çš„å‚æ•°ä¸ºï¼šwindowçš„keyï¼ŒIterableè¿­ä»£å™¨åŒ…å«çª—å£çš„æ‰€æœ‰å…ƒç´ ï¼ŒCollectorç”¨äºè¾“å‡ºç»“æœæµã€‚Contextå‚æ•°å’Œåˆ«çš„processæ–¹æ³•ä¸€æ ·ã€‚è€ŒProcessWindowFunctionçš„Contextå¯¹è±¡è¿˜å¯ä»¥è®¿é—®windowçš„å…ƒæ•°æ®(çª—å£å¼€å§‹å’Œç»“æŸæ—¶é—´)ï¼Œå½“å‰å¤„ç†æ—¶é—´å’Œæ°´ä½çº¿ï¼Œper-window stateå’Œper-key global stateï¼Œside outputsã€‚</p><ul><li>per-window state: ç”¨äºä¿å­˜ä¸€äº›ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯å¯ä»¥è¢«process()è®¿é—®ï¼Œåªè¦processæ‰€å¤„ç†çš„å…ƒç´ å±äºè¿™ä¸ªçª—å£ã€‚</li><li>per-key global state: åŒä¸€ä¸ªkeyï¼Œä¹Ÿå°±æ˜¯åœ¨ä¸€æ¡KeyedStreamä¸Šï¼Œä¸åŒçš„windowå¯ä»¥è®¿é—®per-key global stateä¿å­˜çš„å€¼ã€‚</li></ul><p>ä¾‹å­ï¼šè®¡ç®—5sæ»šåŠ¨çª—å£ä¸­å¹³å‡å€¼</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">MyProcessWindowFunction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> source: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = env.addSource(<span class="keyword">new</span> <span class="type">SensorSource</span>)</span><br><span class="line">    source.keyBy(r=&gt;r.id).timeWindow(<span class="type">Time</span>.seconds(<span class="number">3</span>L)).process(<span class="keyword">new</span> test1).print()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¾“å…¥ï¼Œè¾“å‡ºï¼Œkeyï¼Œçª—å£ç±»å‹</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">test1</span> <span class="keyword">extends</span> <span class="title">ProcessWindowFunction</span>[<span class="type">SensorReading</span>, (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Long</span>, <span class="type">Long</span>), <span class="type">String</span>, <span class="type">TimeWindow</span>] </span>&#123;</span><br><span class="line">    <span class="comment">// çª—å£æœ€åçš„å¤„ç†é€»è¾‘ï¼Œ elementsæ˜¯çª—å£ä¸­çš„æ‰€æœ‰äº‹ä»¶</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">process</span></span>(key: <span class="type">String</span>, context: <span class="type">Context</span>, elements: <span class="type">Iterable</span>[<span class="type">SensorReading</span>], out: <span class="type">Collector</span>[(<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Long</span>, <span class="type">Long</span>)]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="keyword">var</span> sum: <span class="type">Double</span> = <span class="number">0.0</span></span><br><span class="line">      <span class="keyword">val</span> size: <span class="type">Int</span> = elements.size</span><br><span class="line">      elements.foreach(x=&gt;&#123;</span><br><span class="line">        sum+=x.temperature</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      out.collect((key, sum / size, context.window.getStart, context.window.getEnd))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>éœ€è¦æ³¨æ„çš„åœ°æ–¹</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201221174330638.png" alt="image-20201221174330638"></p><h3 id="å¢é‡ã€å…¨é‡è”åˆä½¿ç”¨ğŸ”º"><a href="#å¢é‡ã€å…¨é‡è”åˆä½¿ç”¨ğŸ”º" class="headerlink" title="å¢é‡ã€å…¨é‡è”åˆä½¿ç”¨ğŸ”º"></a>å¢é‡ã€å…¨é‡è”åˆä½¿ç”¨ğŸ”º</h3><p>å¦‚æœè®¡ç®—ä¸­ä½æ•°æˆ–è€…å‡ºç°æœ€é«˜é¢‘ç‡çš„æ•°æ®ï¼Œåˆ™å¿…é¡»ç”¨å…¨é‡èšåˆã€‚ä½†æ˜¯ï¼Œå¦‚æœè®¡ç®—å¹³å‡æ•°ä¹‹ç±»çš„ä¸ºäº†æ•ˆç‡ï¼Œç›´æ¥ä½¿ç”¨å¢é‡èšåˆï¼Œç„¶æ˜¯å¦‚æœè¿˜æƒ³è·å–åˆ°çª—å£çš„åŸºç¡€ä¿¡æ¯ï¼Œåˆ™è¿˜éœ€è¦å…¨é‡èšåˆçš„å°è£…ï¼Œä½†æ˜¯æ­¤æ—¶å…¨é‡èšåˆä¸å†è®¡ç®—ï¼ŒäºŒåå°è£…ä¸€æ¬¡æ•°æ®ã€‚</p><ol><li>å¢é‡èšåˆç›´æ¥è®¡ç®—å‡ºç»“æœ</li><li>ç„¶åå…¨é‡èšåˆæ ¹æ®å¢é‡èšåˆçš„ç»“æœï¼Œè°ƒæ•´è¾“å…¥å’Œè¾“å‡ºå¹¶é™„åŠ çª—å£ä¿¡æ¯</li><li>è°ƒç”¨æ—¶é€šè¿‡<code>aggregate(å¢é‡, å…¨é‡)</code></li><li><font color="red">é‡è¦çš„ä¸€ç‚¹ï¼Œç»è¿‡<code>aggregate</code>å¢é‡èšåˆä¹‹åï¼Œå…¨é‡èšåˆçš„elementsé›†åˆåªæœ‰ä¸€æ¡æ•°æ®</font></li></ol><hr><p>ä¾‹å­ï¼šè®¡ç®—5sæ»šåŠ¨çª—å£ä¸­çš„æœ€ä½å’Œæœ€é«˜çš„æ¸©åº¦ã€‚è¾“å‡ºçš„å…ƒç´ åŒ…å«äº†(æµçš„Key, æœ€ä½æ¸©åº¦, æœ€é«˜æ¸©åº¦, çª—å£ç»“æŸæ—¶é—´)ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.flink.transform.window</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.<span class="type">AggregateFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.function.<span class="type">ProcessWindowFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows.<span class="type">TimeWindow</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"><span class="keyword">import</span> org.example.flink.source.&#123;<span class="type">SensorReading</span>, <span class="type">SensorSource</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">AggregateAndProcessWindow</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">out</span>(<span class="params">id: <span class="type">String</span>, max: <span class="type">Double</span>, min: <span class="type">Double</span>,var startTime: <span class="type">Long</span>,var endTime: <span class="type">Long</span></span>)</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  <span class="title">def</span> <span class="title">main</span>(<span class="params">args: <span class="type">Array</span>[<span class="type">String</span>]</span>)</span>: <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line"></span><br><span class="line">    env.addSource(<span class="keyword">new</span> <span class="type">SensorSource</span>)</span><br><span class="line">      .keyBy(r=&gt;r.id).timeWindow(<span class="type">Time</span>.seconds(<span class="number">5</span>L))</span><br><span class="line">      <span class="comment">// ä¾‹å¦‚è®¡ç®—å¹³å‡æ¸©åº¦</span></span><br><span class="line">      .aggregate(<span class="keyword">new</span> myAggFunction ,<span class="keyword">new</span> <span class="type">MyProcessWindowFunction</span>).print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">myAggFunction</span> <span class="keyword">extends</span> <span class="title">AggregateFunction</span>[<span class="type">SensorReading</span>, (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Double</span>), out]</span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">createAccumulator</span></span>(): (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Double</span>) = &#123;</span><br><span class="line">      (<span class="string">&quot;&quot;</span>, <span class="type">Double</span>.<span class="type">MinValue</span>, <span class="type">Double</span>.<span class="type">MaxValue</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(in: <span class="type">SensorReading</span>, acc: (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Double</span>)): (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Double</span>) = &#123;</span><br><span class="line">      (in.id, in.temperature.max(acc._2), in.temperature.min(acc._3))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">merge</span></span>(acc: (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Double</span>), acc1: (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Double</span>)): (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Double</span>) = &#123;</span><br><span class="line">      (acc._1, acc._2.max(acc1._2), acc1._3.min(acc._3))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getResult</span></span>(acc: (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Double</span>)): out = &#123;</span><br><span class="line">      out(acc._1, acc._2, acc._3, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¾“å…¥ï¼Œè¾“å‡ºï¼Œkeyï¼Œçª—å£ç±»å‹</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MyProcessWindowFunction</span> <span class="keyword">extends</span> <span class="title">ProcessWindowFunction</span>[out, out, <span class="type">String</span>, <span class="type">TimeWindow</span>] </span>&#123;</span><br><span class="line">    <span class="comment">// å› ä¸ºæ˜¯å¢é‡èšåˆçš„ä¸‹æ¸¸ï¼Œæ‰€ä»¥ä¸€ä¸ªçª—å£ä¹‹ä¼šæœ‰ä¸€æ¡æ•°æ®ï¼Œå³èšåˆå¥½çš„æœ€å¤§æœ€å°å€¼ï¼Œè¿™é‡Œåªè¦é™„åŠ çª—å£ä¿¡æ¯å³å¯ï¼Œiterableåªæœ‰ä¸€æ¡æ•°æ®ï¼Œä¹Ÿä¸ä¼šå ç”¨è¿‡å¤šä»å­˜å‚¨ç©ºé—´</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">process</span></span>(key: <span class="type">String</span>, context: <span class="type">Context</span>, elements: <span class="type">Iterable</span>[out], out: <span class="type">Collector</span>[out]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="keyword">val</span> head: out = elements.head</span><br><span class="line">      head.startTime = context.window.getStart</span><br><span class="line">      head.endTime = context.window.getEnd</span><br><span class="line">      out.collect(head)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™æ ·å°±å¯ä»¥é€šè¿‡å¢é‡èšåˆå‡å°‘å­˜å‚¨çš„åŒæ—¶ä½¿ç”¨å…¨é‡èšåˆçš„çª—å£ä¿¡æ¯ã€‚</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201221175646429.png" alt="image-20201221175646429"></p><h2 id="å…¶ä»–å¯é€‰API"><a href="#å…¶ä»–å¯é€‰API" class="headerlink" title="å…¶ä»–å¯é€‰API"></a>å…¶ä»–å¯é€‰API</h2><ul><li>trigger() â€”â€” è§¦å‘å™¨ï¼šå®šä¹‰ window ä»€ä¹ˆæ—¶å€™å…³é—­ï¼Œè§¦å‘è®¡ç®—å¹¶è¾“å‡ºç»“æœ</li><li>evitor() â€”â€” ç§»é™¤å™¨ï¼šå®šä¹‰ç§»é™¤æŸäº›æ•°æ®çš„é€»è¾‘</li><li>allowedLateness() â€”â€” å…è®¸å¤„ç†è¿Ÿåˆ°çš„æ•°æ®(æ²¡å¿…è¦ï¼Œçª—å£åˆ°è¾¾ç»“æŸæ—¶é—´æ—¶ç«‹é©¬è®¡ç®—ä¸å…³é—­ï¼Œå…è®¸è¿Ÿåˆ°çš„æ•°æ®æ¯ä¸ªå…ƒç´ è¿›å…¥éƒ½ä¼šå’ŒåŸçª—å£çš„ç»“æœè¿›è¡Œèšåˆ)</li><li>sideOutputLateData() â€”â€” å°†è¿Ÿåˆ°çš„æ•°æ®æ”¾å…¥ä¾§è¾“å‡ºæµï¼ˆå½“è®¾ç½®çš„æœ€å¤§è¿Ÿåˆ°æ—¶é—´ä¹‹åè¿˜æ¥äº†ä¹‹å‰çš„æ•°æ®ï¼Œéœ€è¦æ”¾å…¥ä¾§è¾“å‡ºæµï¼‰ï¼Œä¹±åºã€è¿Ÿåˆ°æ•°æ®å¤„ç†</li><li>getSideOutput() â€”â€” è·å–ä¾§è¾“å‡ºæµ</li></ul><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>èšåˆçš„ä¸¤ç§è®¡ç®—åœºæ™¯ï¼š</p><ol><li>keydStream</li><li>window</li></ol><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210101172351300.png" alt="image-20210101172351300"></p><h1 id="è½¬è½½"><a href="#è½¬è½½" class="headerlink" title="è½¬è½½"></a>è½¬è½½</h1><p>è½¬è½½ä¸‹çš„æ–‡ç« éƒ½æ˜¯é€šè¿‡äº’è”ç½‘ä¸Šå¤åˆ¶ä¸‹æ¥çš„ï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†èƒ½å¤Ÿæ–¹ä¾¿æŸ¥çœ‹å’Œæ›´å¥½çš„é˜…è¯»ï¼Œä»…æ­¤è€Œå·²ï¼Œè°¢è°¢å„ä½ä½œè€…~~</p><p><a href="https://github.com/confucianzuoyuan/flink-tutorial">https://github.com/confucianzuoyuan/flink-tutorial</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;DataStream-API&quot;&gt;&lt;a href=&quot;#DataStream-API&quot; class=&quot;headerlink&quot; title=&quot;DataStream API&quot;&gt;&lt;/a&gt;DataStream API&lt;/h1&gt;&lt;p&gt;æ‰€æœ‰çš„Flinkç¨‹åºéƒ½æ˜¯ç”±ä¸‰éƒ¨åˆ†ç»„æˆçš„ï¼š S</summary>
      
    
    
    
    <category term="Flink" scheme="https://awslzhang.top/categories/Flink/"/>
    
    
    <category term="Flink" scheme="https://awslzhang.top/tags/Flink/"/>
    
  </entry>
  
  <entry>
    <title>ready!</title>
    <link href="https://awslzhang.top/2020/12/17/ready/"/>
    <id>https://awslzhang.top/2020/12/17/ready/</id>
    <published>2020-12-16T16:02:06.000Z</published>
    <updated>2021-02-05T11:51:57.064Z</updated>
    
    <content type="html"><![CDATA[<div id="hexo-blog-encrypt" data-wpm="æŠ±æ­‰, è¿™ä¸ªå¯†ç çœ‹ç€ä¸å¤ªå¯¹, è¯·å†è¯•è¯•." data-whm="æŠ±æ­‰, è¿™ä¸ªæ–‡ç« ä¸èƒ½è¢«æ ¡éªŒ, ä¸è¿‡æ‚¨è¿˜æ˜¯èƒ½çœ‹çœ‹è§£å¯†åçš„å†…å®¹.">  <div class="hbe-input-container">  <input type="password" id="hbePass" placeholder="" />    <label for="hbePass">æ‚¨å¥½, è¿™é‡Œéœ€è¦å¯†ç .</label>    <div class="bottom-line"></div>  </div>  <script id="hbeData" type="hbeData" data-hmacdigest="88b1f18b38b134dad3e756938723115a47b61053be22891316f8a7a7e8116a41">2ef123d636f2f21a7a6ecf818bf73b0168cc121ba75be9c227f6b4e8abc84136359f52f4b010ff4fbcfc0a9c90fe4aef6ec00e82c3925cbeb7eeaf95dea8f8723d8e2d09fe263e8ae76b17b7b3517368c8df60ea512ce0203d75e6a039531cdf7011f0db3627eb4cc9fcffc9c632602f4498a6cc67fbea21b4638dbf20c33988e3af2b2dd264de4fb1090ec55a4df9d1b9dcff46116a085cf10515f493716d3b5219003223305f11180eb80d2ac4a7755370bd8c0743274a2da74d78880b7b460bfb31b15f3210086a86caac45289eed5a2bd8532e15b81cc5538cca5a60d0d12e13f1c46c1b82e2870746fc714aab3a1bbe51272081ffe83993e52a11fd893e2a379c9b463b5e4db2cc836e100dbe4cc648119268666b0af734806a6454fc9315051ec37db12acd0ccf6ce22e03af9cfde8996cc35da6d5638e3eac108889e6a07679a0ba042ab50899c66a814d2d48daa033a633a2d78ba49b697abee1716731999e4717c64a9cc77a146d96ece729dd775ab06ee3b7addeb1202344145676c9fc6a668c9338b772ccac892129d5309c79aac5a66d723ba6a5390f4dcccbbb2d6262542bbe2619780ef3c2d79f35992ea0e0a811747c0b6e7f18f64db3e5aa80acd3e223089f3837f434c1df3496d2b46d586c1505b43d34aa804ec9913cf3d8d8ca51ff001bacd17744a3f5d8dda41aecc7a9c14d41c6bfd8eb08c85c70ca8ab22f104c93af2fd52a8765dd4a3fdbc208d374233a27168248a259741e47a8573e108fc285ee30130face4387d7427a2eb15d7a8366f74b6373f690c5bdb83e62d1985a23059ac9f4053f6892f47e64f044877e662a9ccbe22b61dff08a15e9d0ae32c3e6279495452a0ad54c498795bcf0fe5f3f97d78ee7cc8cc22e8f5693ea534b04cda3c68e61516fe6e9c899dcf56ea77a046c2f580933529e3b88ada1c20f47236c823357f02d7d32623a5afbf3d23ab4551cf8b797718579e9c31fe529179bcf24111eeec570b73ecf677ab7d534d9d2a702f101773d84c25fd68d747e3ab3049b98a20693bba64b82fcaf4bac6d2a7b81b6a8371267398d211433e3edf6cb8b086b376813fb81e616b36050e182d9d2a484ebdbd27c1c94016942797733970e61b6b120095f6b91d09449a1bc4d749e7f8c1f48b5e35ba11f14e64bdf05a80405b09e54771b2c0f11be78cdd775e8d84c1c9d87e9938551192940889df87d25afd5bd0f188c615a0480452090f2c037cb6235b081cb18dabd358c8316a1c78b0db716df2a060aa768613d8b4522cf64fc4813b486f8fc60fc28f78e0eeb6a16d485f0216b05867a653072df223e7dade2d7139901dcaf078827fec62a70005591531bd58c64930228cbfebd1a4f5ef5d03f2d02a042f7ba8d78a1c43cfc3ddd93e9e0aaf37fb855351390ba645df5c052cd404d07a9ae657de0ee4fad93dca4d982ae85c8d72aca314ba055f01301fba0902a58cd1d82011c50fc39ad4f069815fb814ae4fa74df95255227194fb491023f1244209142d29c5e03e07f26be60cacc707d9e9f4c81f7699bd93d6270697eff14fe9d02c074f01188ddc26437f1827868214dfd9515d6b849b448751e8fe17af66af6095afe16a0cf17d401e614ff446c714f939c60707c93cf1205421ac121128bf9267d61a2ae5d78069fd796db5beaed19e14277789f026dc6c3761d85c4b8e573eeb577a92c929abcee57a32044463c90a7eaa6ffaee537a544172d7698632e2768452e2986d77e660b12910d3180c73723138ce5483e29953fbb8aaefc8511fb007974a129242eca8b06bc4c5c043ff54709d535db627deb4b10ea62777edec94253f19a08615de0c7bfde2c11aa31b5f294a609c3bb05e127d48ae838407d955d072123a223850accfd42f7a0485485daa9064ad5ffeed4105356057f172ffaeda519161a061e32c5f4f808f5f2bfa1fa9c1868d355702b2f7629cf81b2ed5193f03fd43941e54d5e01043571d5b230e72b1c61949fe48264a72d3106de3e9594149f4c5099c895a9eaf00e59cab3c021ebf39c568275b3f0e21ff9165d1f89274ad34ef117c833286fa5d9661b4fae6da2995e9e9d85a88a16f319684f346afd0d491230f14add99716417d0ce7a734920d18931c475e7d1eabd5b87750bf4c1b1404cf7bfa51b91bab72a6c401b662662d0d7b41c7dcf0302120dae1eb3c8885c2484eb7b3bd9775b196271caf242de4a80873a7cd9d01419bf97a212671e72fbc3ece81af92892712aebbf847686aeab609077d05acb391217c850b982663b029fa7f2dc47cac058e7f081739e4139c20a1c901542245adffa550b635f31f00509dc186e427ca95ea5bca567be9d9ea604778cfd9e2811f21b81c0e963f927d06306f88838e0ead69a30ebcce4da438b7c89bb0663e2db479c0b4cbf91835459517815749e1f958a719f609f891c4eef09af05e51c6d53d83a02c55b8d612ed972d7db9a38cd41aeab04e8dbea6e424a97cfd450aed377e0809be2b906856912e87506e42c68089be580c5a88affd395fdf77c8a46c07b5ba963e2ce3f4694c2be3e86613454a6f1dafbe0e8d5bcd7c759a5fbd49ad6ea90d261def5a8ba8751f6a22295169f0547cdff322dfc2f99b666f5721e1e16ec1ac0c83f6f7626a4ce955889cfa267e353765697843bd6043fc4ab2f0753699eaf9c56ced901e6ec9c5524b8d287962ddbf480b71d1aaed3f7d09f1378048f8810f8f101eaf15fcef7c2110b25d31f5a81557f74b8a17f80f5f2733dd2c7a95035dafe3295b42dfb09df07ffb6d56824a4d70eb01882f2220f4e198c6f1ccfc08e387c44e6c376562f20b3a446126348d5c1e2ac83560473dad44cdb5a43ce841f2248b83a12de7f933e4b544d9bb676ed05ac6145c48030a3bf575953b11153719285c583dcd9a42f0b8209429f10e3e8a0aa5aefa9bf2e4940efc0d2fb1f07bf6f737ef0d7abd5276dba1a2a7e521952917a982ef029bee9899789dea73167f9396cede2702801027975db05945123eff037291e8a544f0acf12158976608038a44ac1d6baede6343bf0df76ba9aab31402bb391c94ca4ad55d2e7a27db247ce471547e20db8abfab4c99fe5462755ddeaf5a281d6474ca8b6cdf2262d63250f069179d8b11133320f56ca81e2186824bd9647d5c751c1fadc1c84ae1081d3cac795c32d6b10ce9337a7450514941c081e372415894ef6b32953ab9d1f12b1d0d330b082658bd403f5584b93de182bef07fb58132c05805ac8ecf99e1626d31222203787bf38c5c4c8ec31aaaf31459af03dae17c2fde525f1c357eb8d7b8f75250d13fb2f47a6c56a2d0aa3f560ff5bcdd2f2a32be0a5c331560e863e8044f72ae94ab307a6940578899e855fc3d7ff5b2e94703ed0b39f8f2ab6e340dbd5dd6be4864aa13a99a52a085b497ec68d9c3e4d1a4ff27031724c7e34a1b1b4275aaef4df1a3401567d92f37e8ee5262af9b71d3a802fa8847cf6b628afd1617e426bab7966cc57d7ed328ccb840421136f826c42130869b3e71771b5c0fd121516d757e7de0e7224f2cb98bdb35176179ce7522a60968f41eecbe5acc830d1ac82a6857bc5a3d6059aaf6194a38d0c02d6feb5467fb3c74f0411b245214012add552f200ab1fc3150fc85650007cd169a0b74dc281ad45a4db72599372359aec5b20ba6596e3804182251d3cf64a22d882bba931073ab6c4fb5ed41ada99bb6bffd9f9a0061b0e3580e169d0465ded074d5d7d78c08e8673e2e2eaf4a2a37c6e84a9d40c9e4cb8d6752791a57b7c83ab4d1baeb241dab49989afa5b1b6de7cb09d947ff534b9fac05bda1f8ce630c8187bb5f6b36ac67a8808b2ac9b0988e3c9bfb2d6cb83eed7fbb8e293aa0e53ef2ea4edda4ef827c374af32a0c2b140e2eee23f41fa2cf664496dc73bde25224ebd4a4628f2a868d7949a676bca0bed2e07e16e5e500b735b1dcbac2eafff3deea67327d42144c4ad84a074dc0bcadb84fddc65679b20b9c2a0643cd34ee02adafc34a1ba5b1bb0cd697ebd20e493065012cae7ba98a2e66992fdff07d24980ac8acd7a95c5f6051cffbf7ec675dbbb7b4912295857daca4b9f39396ddf99bca44e8e71eda51d704b946ea7cb2c97ce47bc77523c8d1cd080ccd3e843887ea04d0a73fdae13df0bac37da32c948d2d35020a0fcac0dd147fec7a51e6a3f523498cb5f85b10dcbea897aebfc4bd505c8575afcda739ef30bbdbb2a6cfad5608b47e33c9f71e0e7f10305b657ab078d9a8a3a7f948494473ec038a0d461eea134069307628ac1e71ddf33fd4ad9334bf965d6cc6e96da14f545363371d3ff0f73f120640cc3463db2b8eda7427575c879bd37dcb82a20ccc3fd7bd627d020e423b26ec9d8ee1900f5e0a4172e199f213fcfe72bdb0971488b4ec8e6644b2764bda789cd4838e8c0923219e192536cc9a4565e26f370a9d93f9c6ed5b738393596542dfef749f423427932fd85243a7ced0f8c019489052bc038132c9bcace756595d392af153a15741ffe05831d7f0f5f0ca6911df1042003da68d56506c587c98122d218d7fac83e80772e64c22639e0e545289750cd949d5b42dd35b5be2c5e129fb5af1c1e6f5624bb7ad6077293fcbb8157999a89519a1a59aa8bfab7dc426381f846752e475ffaae72e075fa1d5ba50d971fe06fca92524653222da2a0952315a085fe0037585975727e94ebb079c31764e1d2f757056064a7467d48fbc20246f2220c24bfe94ec9b5c6b217d7154e0e456ad060bb4b89d88ddf61ae6e05e781f9fd201b380655c29079957668414a9f83b2c459c6646005420452150090c67c26361a9dd63507b9ed0e372a54059ec0dd987985d028ba98ed9b540e781a6f4b90b1a7ce530e4fc677340a0b5939269745362b66a44c6ebf4f55f944411daf7f39aab31ca1c15cf4f110292b3528d94701353bb8035cc261e32711f091fa3a43031e1b17aa073501bd72de28188fd85dad8df319b292390aa7fa5098987a14cd6e74a3e78a5c536f6fb1b1e2cbaaf7b32c079ace3910b8bb47d04af5d06fa732819237b41d0237eb33cd6099b3bf4a203ba8c3ba505f2c0c815e84310bb87fc9658c34060ac365b97d71862e4dc0a8a80c1f5903a9614f6e91a76fb6d84f46cb8e74a1b40f3789ce9d5f93955a4151d31801dee8e9697a8cc702c5efd8108b60632214d17684dc7372392b994d209204e3c3d92cca94317f6a5f0452a0877f9c57f09e4edba458deee6cd2f6f7239143bf91969c7b5c04783cbdfc64db4097c915978bc89bada78a68391037da416f5ebbb2cd4795a350e21901a55f2bd23d0d717ee49c768d097043dc3505c4e39362fc1088992c7305f042f476a8733ab54b6de5af3902c9163e8e03828f7368fedec08e951f0dc3232b74b564271eee28e52e6d6abcee1761986a79134183f1b468ddf951b991e787a6edb2ea89845610eb0553dc9d70e59626131a7d239f7ecc58e54c1161285b37ec33a2344a73775ff4973bd90fc42d5fb27d0f82599e189145aaa13578f50ae59d5cd9e4f00070746f3e2d8e6fa5cece7a3b1c5dac665ea8241ceb72dee559dff03039d94833bd1bc23682114ee3b44fd7d9fe3fbaaa709bf1443c73261a76f13e50e755a7fb66c7b4424ce3352a9ff4489f1e323a51fc2d0dc408eaff1dfff33137a092650c7b76ef533b93313e99459a67c62cd2cbd0ddb79dd16c984a7321b35f6fbf88090e8c917e821283c59c4c8f4d9b7fe0ce2d4c8206da0c52abb983b4c711fffb150f51381440cc58b4d104f3e6562fe02c3406230b4b0a63f7b374b87328de091d662dc5b06681b11ddc236cfd00618e3ca94a84fd0a1724a2874fe648dc085e6ed072474cace233f7563361a7877528f48ed79690b182db0990c27d6e10c61be931cea87ed32f2afb5eb26ffc75b9412213725fd5101369f1d7001a44e03b6add32b74c039d877f17b8a3b6d6071325468bc6c12e36192307dbd5b0458ac25de494c02e63222e389c654f54d9d9e9560ac79ff0e13a45e6b19755209e24b21ff7915f2121d344d2a392a53e9a9de297cfd1caba3af5797b3a5a06b3154e771ed306dc1335426ca542346f8b587741cf0f9e4d3553f3eba0a672ec803343433f4cee5d9483ee3d10963ea2c9339166822cb065a89dcfead0d21d530f534efebea148e713f6a0c910d420024a1e3ae2048a8dc05ce0f38e996e3cc956edc4dabaac7a5da333ed61df6ea933a7ed2b951caf3feb8c872b3e0811180fa9b01b97db5863a1b92158ff1964605d5a1f85ba966c4693aebf0082526a607617d5827b3f3bc4de2e6f7fb05d3d674ff6837f52308b5725a64cd1462c19d17c5a324e9e56015f2c8d682624d6ad8c9750d595674ed18e99e2b6e369609475e492ae580d0e1658619e5001753ebdef63b7e7681f056b56705e14663360503fcdfef7428320e34c1e6ce3a21d30b089a69ea5aada088d0b066f51e0463c6da4541da79e82f41260b3a4b7939ecca25579fe5d51e7c3f5af4e8bf45a97025dfcc11e0d4b8971f84904034c82c0d9cfb29382b2cc936c1de8fcd41a11ebfa7c8e2454afa1be784c867ac5c46c03eb8a1b98bd4df6c1ea98936afbf681c4ccc302dce87e5d67074b9674b9af3e4f331b019eee900e2482734fe3172ec3c4a171daf0fd6199cc7b8b09524a309a16bb5c1f8ae965981de8fbd915ddacf320fa343a2b10cfb0db90d9cb66c9d9408a1928e5be47864360a91568dc99298a95e864f1e8a7aaf04720c15106967adb01ef05b4917fed8ee1dbb9ca8a4675549bfe282b279237b1eb23c33aa65cd5750d1997e6fd10d35efa291cfd1850704e8ee014bb4889768ee69db4602a49e242de1d72482fd22924403a8fb1e1f15a271d73b0888e503f007e7c9fd9793e85d374c2152fd20919fec71d61143a7d94ad8d59b9adc791fe4c14fdb71007f3b715007c12594d3d23dee6816cf253e903700c3d6b1f406c75af27d5dca768df289ef0417926764a11d4765fe252b9132adc37dadae22b922e7f0f68457f0cc97fcab3e954d87c3a52b58f19b0a44ccf8cc7794e941505e0ec2aa598acf0e9a0123f1cc91f58a76903c3bf0f647189affc14b3d29403859c9a78b022aa2406af42784bf0106bf87dc142ca29455dea9a8c1e2dc09047d64d65af871829af432f19529a2b601ab875c5a0ad68ae0905ea2c7732f5ea02bbe54488c99dd26a527689d632070677d565f37b1274af9de19bbef6aaf491d3ff4ce24dac529a7661041b2031a4d7c454db5c229e275d43a088326b40357c12aacce16c055d55d39f6e7fa20e5191a2b859f74b5770770c1092da13b1a7e636cea4fcacde8a5296439c43fe1300d2b65eeda2247b77f5557acde7e5801c4273f193af849f26d3459e2d0172e1ce1b6457f58da700ba7ee830050e92c06dbe889d5708c4656ab27207a4721430a016aa0e61924cd26b773b76aeb20c074824b1253128126be3db5986ddd7c9a068d669fe490b280aed1665771363095ff703cdac45e67b562eb62a9d91b24e0f1e676b7af288aa014ff718ce7c5c7acf2f7bd3716ac35f2c70f5ae77ab73915489a5cbdd8799f8f789717d7dddb83b7add5f684842cec4a261e7fd5b27023a17747b18b5349087bdecdcfa871980cb326a819a9445634b748eaa2ebf49bb0636d638cc49f6e5a7f0227f61a75fabbdd1cf5fd62d5ba22eb599a6235fcb1ec7aceca4184cd5296f22726fd49fb8e5ba535791323919856be5611b4c1d6a8c39ce7a75d4f4278b792ccb28671e550d23dadf4ba97aed4e65cda66a4c35446e173029b918bc8d2c83b7c7acacc0175f40380edf9851abde66ddef0810dd73eb9b8a3c7184c38dd7dfe6c457a265d22cc70ebc74b223aec38c60e51bdbd99857ded2d40c1aa506e7523ba0a6c69a090225aded1595964a2e37591d28f60aebc9c8a96be74638be930f812842b93c2699e7f52adb3931a71ae3a8f0361b41f5471f49ad9d77ae714f746675385585afe20345a9a48e014eec64e51f84579fe21ab6452e017ffcca0d4b3fbd6ba7c9f894aec26e57d991fff980b88fb3307ed0776accc130f8c1b3800b497fef00ca1b15c32eee10a2b2c281222c353fc2908cff3b8679cb6aa78c4f7030ff83e9bd48eefb15850abec3e07a5dba44dd615bf63f0b8a71deb240ee23f3e94ecebefb1a95995d232cf0afbc287d69b6cb5443d1cdb937d4e496534b59fac9822d8ed25524dd77f304244064d3561ac7c17846602beb8cdd6f1f9d52c4e64a4b62372c171349bd138260e5a2f3d8cf318173241e349f83206f4fc8d1791179cf1848cb97de2c85704ca44d8c1f72cfde2db8d2a288f4f8ecb69a458610cbcfe99aee81264a66e4ba6d8868a269b5ba04826541a6be67f16af9278bf5aa7ad281444b1cb974ec3c801eb661f47d00d6db305a55d84104d5b60ea2335f2521bcd7f0dcff25cc73b4e6c8ba05a38e2b26745f35de8cf0e9936e654885744f03135752bc62818becf7b2e33eeb083250203b46d1f779dbeab6964bd8075e9f408ce37ecf409b2eded33e09c48d71774959b9f3dcef28686c4d58a53e6ed80e6195cd87290c4c919da2e4d8aeeb5139cdd4c30bfde93160fa07e14ef865d4c75a953fb58d351e16b990df30dea29b7ca5597ba48adbb336edcc41182a57ce99ebc3ffac18944631e8c5d2be4ad21b56904b0c1873b5f8a094a7c282277fddfa63673148d89ca3620cc5936e9f8057c097ed23e41917093fe2d1f480109401472e485941cf07a038eea913189b964a9fdf0519e2ace72301ea51afedc8ab46475b6a3f38da26f2460be86522f1e159467b99059893c3f1a978f937c1ba581aa6772dddc11d7f1277fdefe7cd2ee71369913d8c7fdfa781e0d34dc5ba70dbe833c83fb8e2f89eb117f177d54814cb7a1f9e4a232f1cdaa7843644849a40e9ec70c089df0fb95ee0811e092d26ad877a6e1d2259ad2e6da6618fc4497e52f16c9720d2c3ff9e5900e012dea9af83cc7a33d3a7733fa54ebbb16ae9460da840ef5e083babe1fcfd005305b559e6337be01c6025241c4aaa259e1a206f4e9f54574b22dd37b9b3a83df6b031cdf63e83a40b064fffd9845ebe85865af6aa76519398040ff956f01a72422f6ba96029981b99afc04b17807033f02a12f4eac0064bc46451e3268b745a85887f9f94d41c05affe488294bd6e4b7fb244ae5892b46747294f5319cd831b671690f9d5155bd60e7ef4b1155eaf9786e704d1d60663ae0eff560b967f45dec442feb454c42bd2a6fb81f94cddf98bbc0de4dc02ff7aa21fd982fea4422a806e4e83bba091efe17313ac3e9c0fd457cc2987362016300278ffb5b2973dfaf696f59576008d28056a3568f107b865d51aa5abd3f794fcbdf8662f77077511dc604a1e2efc04a852aab0bbd0c148482dce0279783be3878a1b14557676f3f2de513c09de9af4eca9d53c7316af475298933db0fc474c68667a1f10f499497eb917a6cd29532d26b74504c6c314e9dc97807b6bb83ff810aafe6fe8120aa706ce23c708b9c5856595387b94552f4e6b2e29a88344eaa515e9a730c10c9453dc26579809c67429ff01d9e0c061a7ecf28664fce2bdf17e5f2483104e8828f59dd65f303137fdb91dc7f8c48f9f7e5f84f84551bc73e64fc1da45a64014bc6ab9fe518dd59657bbf60bb8faaf9e73ab14be8891ba5c11504c768cc0c65ba41094869f2e024947ce02add4f5deae4f13b2409e4cb5cd4809742d0e1d082099215d2a0d6e098f15ac5c743a124bd2a359346f2d9368f70e8343824ec5038b2360660fe86d140e519925c8bf8b526227da5b1a7d21481768d2ad0f4181766f98fe0db090d10d6138eb879738338f86cb28e948ff1b38a65902b325a8069dd70155c29ba1eb30e973da68c5d8c8769823752d02caa04b3153bcee090a4d6e4be327f46c12b8c269ff78e536810d46fe8381f1f74cf6f144f01220d7443d51b2c03f2aaa28d5068d6956f2b777945b485d1f94db9d1c4855f6db4065c4d87a6f9c55878d4ed37cddbd6ea792a8d762dba86f9c37679ebf274f2c803133593b45d848e7918d527df106fa52f50bb6c9cd32e41793cc159d1f84c622c189b7d55ed90821ddec8e35fbbfb27050bc42a4a3a3cf345f69ea8fe962b00ff1b557a01c56286118463bd25aaceaf1e98a987b79b22e76ec2b6112a9d309bd7119e6664b371fbac8912697d34b1cce8136b29b706b43edc255ec52f37ce76727d46db4f451489f804e9639775c5c0d174f8575acc0a2c724d742c51d0ec2a01618334ea12adbdd29b118abeb87e3415834c96d195bf99b80deac6789087b5aa3f7a6bfebe5825b4e1682a7220c3d7abfa2d8a1faa4054815dfd2e09930009e704673a03975e85f38b8c64e59da88c0252e6e0af56dd0f22526df1a75d2f0ef672e665bde98ef5d475b33180942d48daabe4f9b5dbc574214b14d3bb1909791696be2f28d077b4a232d35d3337884c2b6a55fe2cba3d859de8dec2725e42c866e1934649558f6af150331cddd6ebcc2845155a8f21f9924c9a5739cd7f9497282820d0de43db237999349ea9683f8d669b843b7b0216fe1472237d6116f147d193eabd053156d580ffb9f4a5a6eb20b101cd4702fe6be237bc11c8a6b84bbafdabd1d719f12cb23d0e8da34f8d9556cbe0f7114ea751570bbc5fc265626b761935505e5a012b982c19d3895ea7f15b880cb612dfe440dc773620d3880f4dc767c9a5c4857589a2581dd7213af681179c77123f3d5d00827dd5b2e75aa0026d134f8fc891bee1129f55a3600db16dff9bab7ed2cfb59bfc294399d197d1c08ae289ac4ce8f5c8ff9aafbbc837b23c1f02f2908d25122672a640b0079ec015f1cc16e79c122e7c60f53f1aa6df9e93e2381a79908a34a392ddd94cd7c9a46c62bd27e25c83fa75e121051ab0b72184574adae24dad2c09646ad035dce7b5ee509875abc2c7022e245450b29a2b7baa87f55c8126f6e1b145903751834c867fbbd118a37295e2811dbd6ac0729e8f8b42e1fd61c6796ea1b4e365d21b80474fef7422ac0d26bd1169c3aa1cb3c5cf1526536f7375dcb2704b4b59144156220070736b43aadfe7af80a221275a59a30875a686dc1f29fb2061321caba547c6f408c54e55ae0da33d469c4e25b9694b08e3a607810180bd0bc44957c894ef679944051d01e2f902e349fb65bc3af87c552caf419b10fd7420ae0c9bbc21827d82a0131264cfa178e1064926110400040b3974954a57b1cf1d3d5a3c61a6427916c26572f76010c3332e73074b576e3a8b85428bda1b71cf327a5a6de89c196230a98ecd2ee24a8457dea3c24872f6a849cd1e2e8ee52e907be30d11da4a423abb83b53c8d5c90a243618a531831831d7760f9ae21ebd07fc9853cabe429c4bd6cdc7a0c1db6cebafee6a94bfb3894c43323ead9f1186f50dccff469d3d77ad68ee770aaa831642b7b96a1630d6a94eb9a7ca8e68a12984fcd345683c51c8fe327c433cdf29f2687ea38fe08a9203b04128d1c5eb7602ab747ab46ef540629d0a1d887d3b85125767060fa2d8efd039d9e0a6b26276c91ca2fc059042639e465596699872946ad419e7b7099598040f792274db368606d16fa33b5e1f7ce59fcc1c3a472840f6fa1394c914d48cb3b0c41b652d781c2b9d86678f4e1aeccae51918614c5de5b476d25a6e865ef0be050a415c5a68f70f6b6d2897971491fdd3d6c670e2e4c491499575de4c9e04c679073b777281322bf07059d627de12f88b7a8c7bc9e329fa6fad357301a7169a3d26ef0983028043ad5fe6144d33a196003b018f1f1064969d62248154786075c18487f4cd7b755fdb9f4755472fd411b2be2dae8fe76dba29300f6b21a62478e88a279c56a06dbf91a1cc78cefb4c3283a21add819f9db651c0a07f8e9f1915fa2a4ff6d3671dbb9b41be0c6170e443c71deaaf492f7d5ab2cf530fa6e9bbc85190e82741116eda706efc1077be1e436e9e50ff0b689c03482c4ca21d0364e4a6d260e0273760d42f67c9d74ed19d0839a23aed0e4f27ed4e616069e00cdb257317babb0331c6f6b0d1709e8890adc46c49ac9acdfdbb8095313e1d266a606e7ccfd858180c3b389c5a7577252dfa6111e7b8fb721498313f039c97d1f8c6edec0be359e2a646e335766998b427f9423c007a51ff47c0af4883937e3c87ff9e1fd1d45c08d71084e73c1a9f80e63761f24def68975596c9f92afdfd8aab51ea69efd6f0535a0a1e71fffd722eb73db4771097de7be8b466e80dd80534c197f77ff8aec8043cce2a6ef2b0fbf76c6d54245e9a4e367e20304f9ef27aa161a703c4a3a3dc65e4f7445bbe41ed73fdbb89a40f286cad81c3968eb3cd724c06f9e74aed12b034889049f27ad7cdada48954bb8e91490c2f468a41bf3cd274b6d6ad834f712a36b60cd60ebde40434072c4b57d67ebe23a9da4a485216b4abb41a41cef56445a735ad5fdbbcdd926c7afbbbefb1cfacacd3bc44c2734f3817438531d5e6ed2b21121b1978a6648a44f3ca02e33ce3d338f8d8a9176c9d1f386cffb38bd2fe8d2bd38bf1c66d2574e90437912651ea601e36b00eae6a7a807f1a06c6dad5f1062c5ae003c4bb288dac8e9f91b3fe2a4c1af4ff334c175254b50c65229b31b483e4f54a50f2fa6a65f671617bc4b623ae50eab9c7bb7e1a1778ddead5f5ac317cfc4fe68ff60a9547a5ce48b11e1f138a227e170f14138e710e66af031115d22cfd98a8952ee1ed77d980a7b61a6026f9824cd4f89810e993cdca4d76a2b45af5ecc8dd5d1c47f8cf6f0e5bac1d2b567746a7d6bbb2b220bba4ffdc1bd798ed8cf199b6a26ba81ed135fbd852f825e5a6c963769e858ed77a1f47cb70b5ec6288e2ea2f27d5e8a5292071b820347c5d14e3d36ff36ee7238fd266b46191a20c6efe6cad80cf583060d5d834ac7ecda6393d878bde79a4711a39c4a3c5e5e72525eedd01d4355f742c5bdac701ba8b6c4b0daf74cf06315f6ad69f06729fc4da797632b42e0bc0f51ae990577d6df93981c403c76691b2537e0b15b79624e0a63e6c79293ddd8f173f655088108c5d7545f317b289ab5d6efcc80e00c3d36f1a115d20f7c66c5a7e3dd0c94e2dcaeab5912770419a6ce680b67beff3d4ce66fc198e0fe27158f39aba110c35c5001cc4c92d4c9ab3289a9e1a31ef28b2f32f0b11b7e88af8bdbab3395e616eb84cc42c1513b87665e45a75e443529fa8eccc384384d95b75c4c99785c3129b7ce6890d3c6fc23d108d6510c7eaa58db90be21bbf123f01b434fbbf711d7fe7ef8a71ebfabc416add424018e6fd0b138f7b03b121c71c4cde34de9f6ee8fb25b647e0650638ee39af743a18607e7aae2b08d7dfdcbde2aef670b9a8d36fe6ff25dfc0adc04d1afde91b61c88c1b5aee01099ebefd9f92fbc998bfb864175de48a23f1998ad4c1a928715bf3a2ae1c9fb1e8179bf7820074ed85d75aa7a7a41816e9e7cd8f761297207b3dac3c2a7722dd20d1b99d40dcc8e1b3775545097e72b14796a08658664795f94af44b8929c6db60d485de3d22c0671f1d203732c932bd5260bc0b32b4e083aa0d9b72035224f361db71ab2cffe39b0ec3810bda1c49d59ce1050ebf838addc8ec19c4bfb107b48de9b0aedaaf4b24c30d475431e8eacb2a7607987beee6426fb5f6e5359d451e0be1808a7bf9279ee40300f9ddd7dfab063d1d7f77049c253c1e26cd77d72ef23381b507f2fbe9d80ffa5f139b18a13bbdf1869351296e554d3d9c4b9e8796d5a49eed39baffd31bf8fd4c8d161f4d8bc2912834d6fc0cab172360e37c8a96fd8d5a5a8227a68fdc697e14253d9f522d630d70b7b21050e7da5fd48ef27ad6b31830d439ef5f8c0017bcd41f878a65e098deb3c329f4aa3b32b135a907ce2bea990e952a5676d84ea79de43270530dc0726a322f7b7afb7f148cf54bf32eb5e97ee6c89646829bb71bc5e97a1284acdc9f6105bbbc96691a2f71da0fbe5374b25050b7f1d805089804d0a04a7c6f9e51261065e1433a4299366734f22cd9d5bc9e6e050613c673423ca1892c8d851a880a0501ef6696ecf01e3a078c139215e1932a58a5c27a0ce85c6a83d139616b5f7a57fe1af0e218115962fc8c0e91d66d36dac291d2150aae64fd9e83173aee1b41db570e8646b0f71943096a0f832ff8f9c0adb68de82b2d26cdb18b9588d5f6a2b8a718006b62b526d99368405acf02a524cf202ce225c0022b75ed69d7a087b228b7eaf9d2b6fdf706a2a0b99965929c01d684cd0755250933a923289423936871316e4a473f10eb1c7291aeef4a8e1b5cd0d0b219b890931b4b866b7e1683f527221d43190972a260a4b13d9b54c9f75c9f4848880c7043c835573ba3d119aa931e171f6dd319af4611fcb37a97fc1a9981b92ba64d14ce7c21370ffaa01b87094cc9d5a1ff6dfca11398b8734601a3afd51e968aa678a46b24583b55a7871506014c1d2f42595f93c99568f72f4e4ef6650ad5aeec3b80401cf93d850a51ce5aab7d41f448c7a66477b8d4a61e336468c17d7e5e6fb9975ff567564955f78897c9985ae731bbd4ab83a6fbd70852cdc4b217dd56033a9123bb5f97f57412a304294dccbd3045ddc80ae2d996f246f6bc81c0fe3c6ee36a9b6f27b34b81e647d8bab3d5820409f5cb1f1c919f8b40e9800d368f52a1c091c29564c7ae855d35321a1ed3623eb95c674d7185489b8c7f373a62f513b7d2d68c5d96179f71eecbc43ef6a370c24a0412c993ca3fb312c2f376174e7ddc8fc2256d8fe3bcd88afe8bcefee1f9a65844a2dc49ce5ba35ca5995f5976fcbf1d00768603ea8eee0f014bd151f264b17f8ca7db6e255a7cb7c1813f87e082bdc60cb93d2f0ea9502609cfd0a861d6b3964708dbbe850edbab00acc313f219915b0e2ceca50b27c697385eab7a788a71315d18c05938ed6357309a3b97ad98d8275b54fd2ccc9c04472686b7fa3bd586d247d9d7c699e4202d1114a87daa497e6be4bd74f57192c5276f31c9f22b84fc8828bab985fbfe161cd862fe21d332e33d22db946349c2c78782775b553d2093165100c2e77af30a333786692526a57587f10e45eeb88aab4a49d6b4cfc98ed815d47bd077a8b7281e11d8c67d5cf07413557ed3eaa7cb0808ca4f27419c7018140fc9c19e259612d34a24e7747000eed94fd00551b1c4115e699163391515c602b80b9db88e5b42a45b6cb4b5500115c40ee1ca9f7209c8bfe95bb02c355a91e5c78856ebe77bf0735ef1f636aa37aa57547c3d7aab95f14050158f1233059f2ed11d3844180410ff777ae810b2ea6794cfa1ece6de2f97ff534c9c313767fbf1c7ac9124c949b6db0b5f75cc737701684b454d1f8821d72ce891fd0237fcf3094a4acd00cfe68810a656e2e08ee2d08c413f738ef3fcadddcbe837d3b4e3c18815cfde5084b4f9d026a26255402beeb57530495959cbbf1d9673805a1cc054de84464f33a4e06522fab2e272b29090288f6df4ca859f848313fa1d8384d54bea81aa17d4f250832417d7a50bfcbfa96335b2c7bf2b2bbd13c1d4e7ec1c6a8a4c8c53c4acb7d0424633ef7092e6d84893b778e36d9b66c2893e42f9a74ce90c32801967c10c0de1e0c915b820118dff088aef9506e829f4e7a7c0b95d39bdd01306ce12918c6fe9c9bd2512bc3cc45b259fbdda66662cbf531ba80f1c6df27a929581b62e0cdbe38ed78d109e3777ce93d9a1519fd305f3d270d949208f7b9c668bcdb4d8a0b64d450e2e2899705af66453833724835a271b34bc3dc4474c6bf6df5a93629b4227795cb438e0bb5ee97cdd12b6f2a37006634d59947463aa7a0bbdcc2393d23ecf726d990f19a839bb4861781539d4a91c00864d93aa1fc67e5edc30ae98c99b6f6e042b873bc5a74c360a7574567ef67a0516dc37b40786ceb1286bc3e15526871f04b82922bb0f67776e498b1fdb14b9df564a10fd852a93049cc5ed0fd69b894b17af8349cb669dc6663c51b82c6e1c82ff250fedf8a9f938348b3e29336f3751cd2c7851fe8fc4822f272ac9757b0ec99013baf3ad60b64529cef0eee861e7172c5043974aa82c6cbbb0e3ff67abac36a325964db8d18299c5b92d5bee0877ecac5994e33ebb3b723e6555be2c1efdd504717f3d9de4af3fc80e1a0cb14921127e685021403c233b422426a7e2f5d934b8b047e0ffca284546dde5a2c1ce9ee17330454c489564ec2e83530dfc9c17d76610aaf5fc0d6611868ca2580597eb476d728b2e824a328e61de42d0e37207024595d1df40a63ee66ea15a567a9d956d2c6b96ed0e1998c084d1e68cb61dc56918e03c159c94ab12590014eee2a8dc4293ba21f9f716f1f723c0abfbc83ffedcd89e619e9dd92a2f0107e850319df78be4152322db28052bd8ff21dd489aa4dfb6f3e54995434e82714b0b647f7770a9eda80f5d5ebbd50dd1430ee5168bb771a918a65b36400a5759c246de884389e44778340e78861a1cbb635d7c6fd6f79df73805096d68dd2f16d910adfce2b104eb04627bfa2f71a44fa57d6e27080cf634b116a536858542281bae7b69a614aaa536ab13b73e2d5057c02cff1e2e393214868cd43c68d24687b5f2e5e8d3516dce7e9ef569902f336e8d0f5d38446834f88478bd8cb8555fb7c1813608b2faeab0eacef57d66739ea207e9c72c8ac70c6998937f78e3992de11342e1cb8fc7c72e3cf7171e9e6a9c097209f67d2526fe38e56d598b0d9ec60c7237ef500b5093d3c78302ef018e0ad6562d3adddce4292f4a8b0f7ba8a1609e68b59a868c47cbf324f8d45ca99c53f4bac995139deb308abc3269d80c10668fad31817fb9b3723c47a22567ebefece098cb6669b7438b7602037dfeaf37e3092ce12048bfb9defe25c197fa8e107ebd8df6eb601f50ba7f8acac95609b2ea6c7e565d530cfdd513382898463a0262d3fb071a643718f7a2620f77995921d01ead15fbddcfe9fe3b6a54353634c01871ce85453f727892c52c7e5b6e856114bb727b1f79c470be10852a027e2a01baf7f79f662dd71b421ae35789456840d2a0e5600717c6237eadac6ba4c1a367addaf92a97025d8f3c2deca380e048b5ae12c9200a25ec9b3eb202a31bbab87eeb869e3c05d2a99d7962ceae34b1ae37f79a96725cb75013cb9ef6da2f0343d8fe4fc9b14770e58cdd1f5d35a2bd393746e9d0bddf5cbc4b823fce95c386c8c00b7f44f05dd13db48c746beb3935b6f7de3323d6988da52403c5145d1accff36b8de8de6a82a39e777dcd68c6798ac59e4c794774c23631668a44a748c3db20b0defd229b812b7328aa9ef58fabb0e90b4982a8e4a927edbc7b0f2f33654c81fcacaff9c5b033544aa056d133745b2a8ed841e7b86b4097b04b315ba347e61a1e28f5918edcc8d20073a6351ebea0669bccd6c93d64dbe32836fef01c0e66e895d420e5cb9d22d76616456dd25accb07f9513a50a0984f72fe6edfc0aa5f8ad4fc835b7208e27debbb51cb1aecc086910d6894f466c256d016a4614a9cdbeb221db85a6f4fba3eff6a57b9c089c3cafc71b40951996e9796aafa3c63dd0455854a2b1bc4726867ede7de5ed27e55f0dba65fd95890cb44f0d514dc26600c238bf579b6e6e8a00bbd0332070b6c47b1a75d8dd3bacc5888fe7dec351fd33670d2579525eb14de9b8414f279026a263775b57a32b834bf29623ba9bd1ede7a5e763c425c49c4fd3f9f51780b49a7b8d12dacf236309e03487ce276e2be28f4734aacf543287b7ccea62178233a35a44bbf4f83a6a2a5903c8be145e80d7aa56dd81bacf15b9ab6889072cbbe61eb904361d285099d3b97c657017f04fa3dd16e39d31e792d3f41222088e936a1a22a9656b3f4f4b8dac3229ec78cab446a35cd417338dbdae05013880907fb6b3d819feca47c37f516ae0be227b33f94f40ab0e896f32d735e21c4173d84edfdd0caf5998d54b7ad45a03c14b39d49d6f549d3d2d4ff4dc7f76cbf054dad449fb5e7938b1255d68d9b29938dbff1897b48897f13e192ee0e35525a6688507272cdf233df79643983b609951b06a0b5e3a56a208a523069cbee68c081d06c6e1fdc8cad2e204b1b5a9d47d9593d37b3c5527199c02f7c534ade5cc08e29b02d832336a133b28384dd2dfb4eda06c3b78ef49fab74249c7bd6d82383e9d306a2aae6885c0ace2d5d01cb5b5b877e58d47e225cac1ec3c7f407f4cafab7ad718753f7654888cc082a3433394e8e127f22bf3a371175d0dc3a0a03a0a3804b11aab66f351749fa0f1147fb40571f4b453ed4390c473dd9ccf2bf97efccb612e42b92e6530daa96953fc9d270ce9202df552fdef413755bdad8caceb73e70d2bd37ee935957481b9c380a2426da211e8d876e1304f6ac7fe0ac3c5c5db51abc6366bc428cf0e74b782dc4690dd7996d729fd7260ec6f5826545e77ef676f131bd96b1b708d6b50ec9ea8eb3175aaefe24bd81de8eea4fab162c3104832d0dd190ea13b501d90a93552afa39256f7d501f5f7417a2ddc34b9665fe5bf4f6ceb32b6a76f8b7c27f0a23d1978accb7839f11118ea84b5d54c96db4fa1676076e745ce6c42373f95652a0f1a36e528d110022a6549997f2b926a7fa4701a166d179ee50ea8e5a22fea14370a95fa48f99048d6e2c5b414d39cb2b8c9b20a1cede1f135ac0e55ea6eec357e93c4c868e018a4eb6095e863b556c35fe3f3848062f95f525f6fd354fd3597b8a55f42516581374916e1e4de82d7cd824a17f105d697636fde88c394f2fdbdacbf9390a66b6d378ce11458268e11cab4a25f230ecac361f1edb47b06454a8c6b6790b6ce179707b033acb1b10cd943208ac9da12ae8230e05abd1a9fd43a21c862301e3d0f662e45f4eacc88f064c4eae40869c5d3f10dc7d855f694d94db732048770a0394921b1cfedb13ea810818aadda07daacd45c395b8cf4594eec51041db75947dc1fbfc2b128c599348630fb3a4c1c2cc22522e13e6b4087d704a3d929445067924a9408ec8cd9560eb8584de8f257172e3a050672c813a29922e777ca02e6e887b71b4116ecef3a85fbfd74e6bd21a830e7532febc220c8e416393a185b6f5e29f701b1f6cf50549deed8d76ecebb6860020da8566a930fb23d0354f3ef93b2fbc02a8d95ae1b84817b021c7cf5c1373403a03ae5a72636a2d47b31871863dbae389d7b58da615214b230994f69aae6a6af3df17e43ed64d0730a826d68660f65514f6ece32e451c7c8b486a3b0b0d6133cfb9f8250a3899315f206e226002eae1f945b06ae088c2faa57bf78d04869f9ce5b0304a557c8becdebf04de81702c72a1e22dbb4652a48876f6c023f2d80026a8f6ab6031ce2d62a229b9cd3c2b5bb6fbef22b2d7376e62f9b35813da739378630aeed124d05a00ea9d75a28b3c77af62bcab00ce945e4d2b176a39be97e20f87543e620081030cf79aa0d5478ab8c0860adc8b6be41bcf3972b2a5c555f14c733182fa9c8bfb143094e39bbbc8da13d99586472278a378e6f0e2e7b02b12b5a20728194fac92fbfca58427db1d454b061291c80f839b6a777cdbb89381e1faa5aca87caa654e822df70280d29c1049896fc8bf840209a3605574d8ffbc6cfc281a646b2a27e0e6bcbecf07349baa577f632268e8ad6f8655e6ff544534cf6eaf44951bc87adeed5b261610549425315974650d4cf0b4970850df8e5ff349fd362e56519f592b6d73e76f557245a71a2922601ab2b9670f80eb4d4b4b1ea08795b4a3961e88eff5c3da7657f4a69957bdf2fda8ba37210bd71c7861472298009b84943c67aae1b04cfac36cb88108d2267a692ef00e0e9c7ee3255f371f2b59820793844868072ec3de78d17363cf30ab65d094e63be57476b9a60c0a15a283c3eb16febbb0721ea3684489598abcc746f80e30d6193aa4ec8d3f4a25f195a62df0317af5b95a006ef11a47c961a98fecefc838abdde46ac6dcdaa8c33d5366ffa1ae4d775227a40c9e981c1c8068e3723fa4c81f7e2a073fab2ad852f80793cfcf580b5e1177ccfa1765127987eeb2012be8dc36832431ebaf692bae629fe71208faca3940cd459daaa465abfe4db88b35eb5e6191df1d9ce4ee6afc25d61f641ac13bed09d4195a14f037b3b7457529c22280cf6f8ee7366157ccdbe057cd6d422797a13cb04546827280119d72ace198d62bed3e32b44bb786e8aa86465fb388fc5c1a99d3503fd3b6bb4a1c12b20b7acc07f21540b6d66a7fd8f5a7a4d8e7f417e6b5243d186d17f04e33de7531e6c7f9e91b55e74d71f4b262cc3ee883d12f1f804d38b18321d6a2f4bfcd4bed1f1e3a143f073e6105a96dcd7c633365faa9916711be4f1028eb748925f8d4dcedce27142a6b7a8907a5b477201843717d0f26d65cc1899d4816a035dca8189e2cf4c8ee115cf31c833dd2d415e995d89da87ccf8bf158eeac0eab5bbd44f38af6e638d7fec5a75b03a97eb7b37447cffce76734e3c08d5e9019f5426aacb27b453db49f69dc6a1a925d554f9d9ade21c82562f8b8599c56b0fbe9e88f97bba4a10c034768998bff169f6cd6dcf5dd0e0240e2b611b62350a366c2ebb9d8f2f4505ce09ce295f5ed15936b64cd2548af1482f67a8aa4a991aca9caa8dfbafb6528e9bd5f0a7b743a327f98fbb944f3a58122a43be254a9fc9e74e1863a5fbf05cb694d5af0b10f32eba2ea5dee27ea4d9ac1e9e2ec8dd4cfd8b11aed2a959bbbcbab8b068c93c95ed52ac33203cc2451bea6cae406c9ddb68887d1b8a70ce1a4ff9a68c0f233b92efc0e39c8aec20a32a0bdd120cd0cd0ae2cc50208e0a2b096beadeec737436b93b78aafd8fe0892ae936807db0ff8c10c0b7b04bde971b76562e2077720eac48a86519f17d4979f6604fcef9483bc4b8143656869cbd0ebc11194bcd1099224d55ab37b5db06d400d2f5b62e46c5c2cf12bf774edb4f4d55f4e2885a29c14f9bb1d5f22de7588f3f848bdf36b2ea3edffbe06f1f481768489d41b147ab2a9afb3195bd1e76985085c7e618279cae78416d8e2dcd4e6264865fb303fb98d82a46f52c92905039dc0271c0bdc870fa8555582f5bdbbebf84b7e64a2b6e45f754b5f416cbd39e019ff648a30557f35fe65616ae1f027a7aa1af6bbeafec2864a2634e8d82139175fdbe847c75a35590f6ac4d7c9ee4acf15c75e6b414e9b3783b658e15ee82965df71f5eb218bf35c89e589f0b8b9ea6d4b8c337d360505b89ab3a0bbb528e0dc112dc4111d2ba7eb92ca959fc2e1051d74f258f2713dfaed44f95a6905881a328ccf307ab057de497043554f1e307ab116a748d8dc1e902a92828d20fe3552009440b2320270081c279db5456c1769f30e89e9546b4f09bdae737bc16e40b6de4337e76c7d6316bf9fdf19fef17188ef3881cb76949924c23a7258f76e4a7cb341924b8a2e14478928d8fb5c4245bcbb0a6a2a5c5fadd8543bca5fddf186a4fcf86843c084f5b8ab7212425c248ab74cf3aa6f67ffd690977b3f742683be0e4d8535372927457ad5870b33e94de3857388b4ce9054839f6e920ab786f7dec43c7f44dcdd98020f6c5a9d4e7aa4d9e3a8e6db8ed1ce909fdc726ff7f2dfd717c087123045919661ec787736f8b39419712589607ca8211a1446cf52a405b7eada4045395febf3431bc02bcc879c3de57dd50d17679328a32b8a7ef0df835884117bf47db2dbd5c84c6dbdc58ac6ddd5e0c08aa05ec43ac72b8d2f962cb832a43eb5d170c126bdce495f3932bb1d4d4ccf0145ddf4fff7f840e55e1df17f59478b5f2355abfe5c4bbd5b67b33bdb2d396280202528686e7386de6d83c9a1297f36368b0ed92cc4c9fb2f5e3f6bd03825d893737d26289e33fef8f9573155cc11c5e270d288e1649678375e93b274b7e0f0f328d163c3378c20bf8d411e5fb9e4d149f29ec91510ddc2f52845972cf808f426de87cc24ad70383e0ad19588a49c40a50f7e7a4fd33c05284b7e27c2f6f86c5b8fb61bef9ef82fd4ea255d08e3aead680800d19b6baa7dbca841deffee066b5d928e3633c919957a4a0b4d4caefacc3fba25df51bcf24fe451746e2c58995ffae4779cbde66978fc2ad8c14d92e0d45cbf66acd50804c04c8aa0197bcb8ad7cb84b3e835d081c4cd91c2e03435444288c5cd41fdf6782be1e746f06bd40a2bea1c01b82cca22591b38df9d11666ea111816fbaab4685470f076af2139d1c3b14517758f7fe1b91c57bdd65a1d82ee0a27790486f3d6a0d14d3b5d8e261f87360702584a2af684b329665acaf69970be24abb8a6c2b4107b5c3aeeb5a3d0730bfadff0c886663a8ef43113a319e0a230e08db2151818e41f97357ace2abd1112656ed0b2c6bfc6cb22711c56a5e0312b66bda34706f0a20041cee09e5246647c8a275d9d97872ff1880f7a288f64c18fdf2ed6c71e73b89d22384b6e991b25a7c43e138779357086c869238ef8b83aadab6220aba668cbb95f39e1f5e426b4698231bc4fd64b99ff8fcae97c9f146c92c041ed34c8803e51b08cd1f06fa7d34e718f1874bd3a58c56c20768e2542ba9d49a4757a09a4f3eda920a4f400e403943b0a507f892f8e0e38ed31de4643088842d351617a89fc5e71ff7990c0d6424fa1c860dbe7e9d99e3e21a8c80157f6def20eca357c03b99092640158ae8bb2a8820fff06005671b4c8f273684353d8bafc77fbf68b82d864eae9c3e232135b3a6ee220679eaf134b0f5f8965208a606fa1c1428d63395661df24cf2b3a7a15eabf5a3b815467bcbe533012233608660a89cbdb0edddccea22e370f71e4922baace7dbfdf98a3bb91c4b9000a7a13148a97242f2299eceaa7059a1f457f5c4f7f8405c09b791ea4fe41190e4f379afabdd5d02b32149d9dd5f47e534d5f319efcac43bee00000eb3605a3b0afbbe5a9807d903c64f3812b81a30d06c98bfb064779a5b1f506dbb4f0e23720ed87efb3187ad590851dadde98894b1cc4917e64026a4e82cbe11e5dfe8d9a7b1bb0a2ca07c2ac04df811d901aeadd97b2485be62dde69ae41ae3a91bd4969adb57b240b26d7d41235655836ae47fbf0a2d579169d0d20da52ede0edd870e084c76c67b1d54db82bbeddf5461e62bbf2f9c7b38c27ddbcbf5c31cb571a8cf258f68cc23e0be2f9b12d8ffa8dc99c4981bb6e4b0e9fe316bf122b1ef6f5ff6e12fc0b39f72d69879e03c733b082aefb0b73a6b6a61c164168088119782787073f56585d460137a56d5bdfef9cda3b5da06652d248656b4a314105c6b81da2c62ded6bf3cd479fa878df37a49824968de687223b5dbfcad1b94edfe1fcd3344985d6745cd2394c5b2139f7c5d2b57f2fd7b7b45d5e724940518b7238d3eaa16d37f399ded4c876d528093dd676d237ee884bed3bf94c308aae7541fdac2a6ab07f099acd32efd4e29728432768657afcfb9154a8ddcc74c7175457c5da697716b1f2963bddd4450e7f789ffb348d07fc777d2f8152c40d35415e81d8eb7b7dd5328850f70c53d9f0a385d5330eac6d9457583d548e6cbc0f628edcf7b67240c51c1e60e522dec98b47fe5f267518335a6d5215a299e6fc2e31cb6c8e958817540d454b55616d4e6bc1c1a02b76c19ba63cc5a970cf40bfe4f956545ad47ae2b67698ee4c4ce684914d2922527de757f1a55537af4a0a7b7a0e7b2bad69daadc9a833e8a5bfd9ba239803328d130d193038a8448fcae410862bbb43eaab967cedc228f20000e604d0764dbdd1937391a84ce9b3d44c4593eecc6a2f5ce7e575393a31cc0a3715aa00fa3870dad58da4e12e895b876815a55507e3f84a22e996c65161ad966e59924131a8409f17402dfa52338777747476465c1a81c9955c53162d0833d897ec53096bb4e70600010e2373ff804358a0d49fc38d1706d3a34bfeb9fa3b92d418886b8424f7b9c4356ac0ed7cb11900c79cdc72f26466065f298e8fc02a722e30208ec19017e219ae987195a5cb9bf5ddb5580d0c9c7a9c0e23517ab3d0c1b96a1df26348fd75e9c5d452f9f3d6080ca14136afaeba6d0fe07136d8e8f6db1900b290846e6d3e71abb8069d0b6762b8fe7223e33bf0dcb01516a91f4ea580920646ba290d648b07775985a2126d822c852ab931730b0dff92d74ed1bcb4fcf304f5994841ad6681aa44900d0f6f070d3ff69f673ff229b93dc25c844776a5340928c9fe4f3ac0a5c82695fddcd835aaade7dbfce2ef8ea2ffa42750073c01b5dc70ddb380fd510cab34c9cefd1bf5891c609a34363f3cba49cc15f3f1ed3d5024701929a76c243d07e5113e2feff8e3f48f8e480bb8cfa5d8413039be396ccfcd2c23b0ffd03b18e192c74e56d5f5a7be6203178815e7bec9c1a61a4cae3edabb0314300ebaa2c512ac2af7fade233dbb4421e5853f6cb93b18b7466782c6ddea0da64180e884724b19e3555bba3ffcfe2b3df3227485f54a6f8cc01dddbc256542f0fd6dfa70abf5490766798bd038552f3649ffba8a73032862d946136c72da95f019421681fc3b1ad3272390bc6a02209da189b9b02b5c173e872e523818d8db398c7e6b1a68d80a1e71e00404b2d9c221e3880500ef9c1958a6b9dc0259bd02a88d2b168794caad2e60555653a45d79cbe08150480cec83e6cc85bcdf9bc7df0a438b28e24cef74f2eee22136b85dfef6a8764e637b3aaff8dc31507f2d2e34b19e990e75ab5b2598c104aa2ad56a42df9cfcc8fa22d7e8fccaf7918bca95e48c6fdc78c373977358240f4e9545e1a3830959ab5ee18f3440aff641276f1c69fa0a892aab7a6b97441756a914142a4bb98e63225e810085c76ea13a301fc37d56f97d1a8a5ce2779e29694622f98c53ce44c6b6b299ce166b3fda75c1365fe0321c1b78b9f57289056bb3a16885431346fcfd73de754533db63c1fd5396865a9a36594a05f5325390a94a287be3e04f934cec11663f31155ac94d068c1606611a9eed308a8756133df570f835f22435bfc93e8f0258a48225ef803fd8c1374bfb002d302dab44f49d96dbcf8012af69b0142896bd8b561a7361971c6f0053b764b0ece4495fba6221d14a276eca1edfa27f3637691631ce34dddf5244a39b6cab536b92a61c4180135b3b4dfb6677c48fa4121f5b84964ce28aa992fedbad7d88794bd29b95a7b8b5198d612c1354071263223ddea88433628ba5637624accb2fc2bfc7e6d05f9e2a349f4804e36a95bae785f15952bfc15b63a2c97e4042868a2834544cdbe19a2398518bde6a895097740745d495bb5aaaf864307da57fbbd3a90abeb7bbb6db8b85d9b8e410ee7ac5e4fa7d91c27d913cf018fdc0e3a429677b7452fcc72a560007a23d8965f5d40413f79e2689fc999cc7b3f5955b212d51b03643c1a1c7c24f8a670eae834a3fff7b448d1e1b95490db6ed92b50ede1a2b9f9b011740773574c075ef013d44df7cf276336ed0c416e93cc16fd9d2ed869a41caa9f506bee1c71aec641b9b2e13c010d19bc1faadcb44f7ae493df7d7b5ee2f8e6513cca673f78d7a68ac276ebef881af57a9feca67e7e550ebb7d06af9d06c943ecc30a2ee15e96b5db378f6e5fb247370b01f8275d3558feabc55ab4f32772ee21b25fcf96193921c7bc54b66d6b3a471182f0e8af351fc84f83d062081acca4bf10b88787272440924efae98ca59ad1d3ab1749d25f79e02e5e0967bb0d54c69e14c9a035ec1197fcd22c01a24a84f559036a8712b36836c32ba3501079b5801f02e4b5051c2099b05672f00309335aca1b49e153a180a9c15af0319ad0bdd1f30a78b718eab581d383d660a3a9759acd8e519e454edbe8caa0fd504d810e309ab36963a6bce84b8a023f6a73d684bf859de23e86c9d212a6192eb1c100acabcedb226056ac83fa9bc0a67fb02ac605256a5e8518e54c8b508cb1bde2b285a1c01ce1e2e0ef4d5dd762ebaed728c24571ef4ff0437ee45a64558dbb22335dcbdffc6c34b27da6c9528629ab0a27753e3e11b58672dd7a9e8157f5f415f921a211117850d2a5b1b9163e131e02da37120a4c7cfaeb3735147d876508c3ba8dd27ff924e5c91a673d881af04a6d7ce11a734c406ad46b038a63d686493e455fd1ea3dfa36c959a29c849bc361cdcf3fb6e9f8d4e2489510b35296fca3ea823137a955172410e80d1446c1cd9c68789be9664ed4706e68864fbf0eaad38561c84d87dabf6ec523ffd06d2a56b43e4d0be57f47a0419e4d5b47ac993f50d9203c913863ecd0bc2becb6bad9a26cfb80ddf18788c9ff124cba73389ad3e0ecde7586f467bc0e52b99e1800314baae6eb33c1d8d6fe2e0140b8c579ed41226bb02252629ed1e5092720fd355e1b7f55d7e22b2fc961e3d2c6248c63b1ec95644fdb5219ff0eadfc14aaca4dc869399dfd9f27b58be9b980b85cf4a42c2d1a2f3674ad74f9e972cd4417720032cdb1f0e0b30db5ea3ed76787501dac8f1f00b8188300ce029f60bfc5bb646d07542858edfce35298491a6ac5f3df71a6686879065ca3363889889d63ca8be5d02071c989e510dcd51ac05fa3b89c3dffd25ec94c2c30b11bee8272e99dab8eb3269bc1bf4813e1e2ce38bd5504e3dd9a1278c417eb402263b905bb817cc1e427d3c6a16bc8c2d604a85d668cb8a439b297df47f5e20bb306759c7cb2065bc0082ffc9a4875172e4c4dc42c86935fcf1dc0e5b838332071c2996447a53e94a1066e9f260e0d5100296ae9edb29b3df2f4d3051013685fe7db16a664504340976a735f459f4f59c20c3b23c5b55e8e2fb1319ddd21f0b0958d0567350afd138e73ad419a1a1c6fb3ade509e629b82f73982ac8ab8323b506d511e5000d292be82cec60ecaa9af8883b829a972422b451b1cb22dc0dd90475edc8f956d0ac29170921283ee30d010ac89c1ca02b50617ae5b725352eba0810db4e80faab24f02c18d26bb744dee627bee508ee13ef87469655223df180fc069927d28a452c168a094c0aabef37a04673deaf2199b8a58f1c5b853f77fdec095a1a57ecd09523ca3d1c650a8908831f657ac6bc3a218147acd844f4b26bbce43b9dcc1ca77fcbc0e96805bf5e0934fbb13a745a2f8b824745172fb60dc33b5e2939841f853c8ec4a452edf37931722acbd21a8fecb6b1c9fefc34be7d4079ff8e107d9656d99558e1a2dda6720c534c5cdd32c5cb8a46558bc1a67d2e89d7da044d8efc6e0c0cdc75f2fe05d46d6f81f05ba113fcda4e409e728588e9a9b5be9066abfdb1d5e9be0ba0c3c72a82b4f8e6985381889a2c5c0949e061523395b738880e43e23d5d2e09ec08a6abe9ce771a642f73b52f273bc5948f06c0f50471f30a8e393ffeb97956d38b53a9f78ac75bfd90cd16c9c094d43ca8792555efb8482f42b196b15b7e5f7edac4976b914024467eb6699ca17f7fb2f4f1c1d1ed76da1ffdf4d0059aa7b6b87ad0f9aed6a613728bce865c40a3e6333dae3ea4131e6dd50f399af11c35787364df1fae35f1cbd7b0e98eae94884ee38ca57bc4d6f7873f88582aee974fa4fcc2360019d6d80b13af0e81f96083e0ef378261c3cf565d5f3c642d438e6e305363ea7a1f2dc66d3942196cac2a5321df72b4d6411302de925d1cca9e604b6036734f7a851555a04790773344b26daa1ba82e37df9ca9a273d3fd199df9442ece9c1bdb5fa0432268e9efc99f3887851ee41843c33b0148876704dcdfc7e358655a7503039fcb9882ce499f7197b0f188f0c9dfdab48b238e6a1808510dc23a28ccf81c2fdd576b76943e49581e0068e145dbde98282eeab04a569ccb23302d6b88af271f121c8b5b37358ad037df11a964e26c44171de02cd1ab7c1074983b81f48cacce4144e674aeefc5ec211c10443646f70a1759cde4046e71620a2eec9d0c10b7a051389b371d3ffa9c2a1c3946f3835a728e10b7681ab4d97043f95dd2dbfdd5a4100f777b652ed921dfb6c2bdf2b86fcb51244f8fbd432bc3c5fbe46e0a2b109c4a6a268637cfcdb9077df6dffefe4148dc5f4f043b349c27ccec16e71b2da183cc25566464fbd2023e8da5b13e978403fc60a83aa3e444307f27b8ee4ca9e82e8ab6861c5ed19cd283fe4e6427240a092d056195de8c1ad38a4a08c7bc3e58cd47174831d25a72226c76d63d815abc0bed6cd785c8132e1376a8cbdb7bbd30267fd4fb8ea0aa19c9e0e0f0b6bbe13d245f6394d0810a80fdd4136935c999628c3708c652040d778f2ce107fe652ee5c402421566df5246fa59c741901b3049e627bf3be3a0e89b5a9dc670031adf4a70ae4d01d853f109ac7396b65d0bff76a2bc6d658dec8a24f1d2ca95657b1b6308414f802a681214e1691c5191ba5e14be4bf0983b99623b93b02f5b6c46a6198f618a3c8b8a968320dc67209949fb9d01b36659bdb43908737dc2a25d2f5efb20cd171a38cc70705bfc1148f0f309e86b468d25ed3571e510f3e44a76033d9bc18dfb04b29cb912b176319eaa45260355db90b447323ac657ce35f50a60a5b7371423235b035f4a89b0c919f893443f913691230d12c43a9e00e1faf059a2d98ff49692f598ab1d21912efd66e7c5e20841cbb073b52567ddc63713a89d7f80bc77aa6c0030218a36245bf062359f90ae27e6b64371e9a0504ba4d2763bfa361cbd61e9e38bb3fbae33973da5284efe3c99873a7453f86f331eadfca2a4852db6e81981c5ae251e8c297cf76bd030e641724e9c6ca50b7feb27a34a70503b9c55b9cc9e4d9bacda30bc6f694685432e02a19dd60d0020b39ea8d808ddffae6151acc4ffaac40bc78b943f4eaf295e4051ae420e16ff38a9e87a81e9d073204dc4b8b6d71f18acd56b981a00d09ad9006a078e7125ce7899b334bd09363d3f05ba6f9b632453d23dd4bcb2f47fafa31aa4a312b16f624034d57e331f24e199aead603e16362a628abd18a69b95f4a7a30d6217c1a73960f2db9c99f2afa293f1530f2350f6f57ecf19f343c3023d6f29d4022c384b6e157f8aa43250deaf05159df68ce27b3fdccb1712935741426d54f408a917d9e47423b449597f96c3f0aa5ecfec17a9fb401810bbe672440f7ffbce6839b6b0290ad15c766740c3a42fb1d84ebae99747fb3a665a62ae3820dd5cb714d14fea52e3c4599a0639de2db1a7dc4fc3bd1bb5790ad6b687a8e5385d84a174aa46820b072e5af46fd7fa67efa5d5fdf26bd7c6d39a9f5d3b3bda536064dc22245156d8a96ccfce18ebf5b1f9fd96fafa89205c9a0436f8f38b580be9efd4e3944051e9f773bfb251704ef520047934ab2fed1f8f915daca5d21cc15e3725dc0a2a0d63e830ccc9f78495c36035e620e539a7532247499f135f7520bea653ad05251147380eba352ba8349a6333be4533b96ae82e8a42bd59ef264ede97a1fba49ee17fe773d4140fffd16472874126518211959cbd068348eaf97795fa6941cdb843d1166f1758160fd3d484378e491aa6f959c3807cd3da8557c008d412c62000b1b6c64f2a706fe90cd68cf9942087b3db1f6f1d6da5610db3382e193020f21e29d0978fef6a1eb252eeb03d9f2e6e46ae796651850a0cc8995102004a6ee71243e3015a53ae73a5f2ee16ec27d803736b507b499df43796c06fda7dce211947a2bfbdc2b7737f353d3a453d0016a14f3dccf6cf7e06dbed342704592abbb6df168d0807d5f366d61a48ee2a76f53ef19f3349073eec3d371d90563cc64647584f264f738d32c72626858c7eefb9f80a922d0f65b55fc5e4af2759c01081e69f1c500d4b55090551f0650fdfc20411626f11657ab1ba29fc942e33913b850ebb1d865077441d6d684c27d8fcda3fcaf351301c880baaa45f69c92f15ef569ec9f2d0f103db0966e3969cc02d4a6da92bed0c851fd3bd7971967057efca964763263b686b739001b98cc8c7265cc9e649374196cb94291db65a6135228dedfe9e1ca37f2893067e2e6cca106b77a9567198c8b597323dda84187c54fba96c27cbe136ad9d6acdb9278818e4079beef3316acdfa2fa61d357f5287106946cdd39e80418f281f57c3ebd2b94532b38d0cdfaced0a3a9a282d668c83fff4bd8a65683dba08995168419069dc6df86c962fe3795d99bf38f981bc850e7f668e096f123913291094288261c8ea9a3c7cc4f137ee1cfc74565a4595e4fd944c2c8347d54ffdc54fae188f9834875e1a44564da6b9bd5e0aa52b965125dce3cb1a8afb0914e6d4f46c324cbfcd2e8d35d41cc34eecb0820d7faead74afd37a3ac275980fd56ab98586722a9fccf510e4776578eda79bd16671fbdaec1e59cc24c7e5d7e52135f8ce606fa386e11e8d764360ca9e465e96c79b05fb68918bd16c1e6e22efa2afd248a271e265e1fcd3b967f4e42921d2b8a5245f50dfa3567be386b1e76a445c57ebf4be889b40ca8f67c070a81e0c5ac90e060b9ae1a5a123bd962e761ab3277698b12fd1fd605446eb3483749e205dbe31bf86f0294853c8e92a6f574ed81559c437af90ac1b43055b38c8e8098c5a91c5d2c80a8903d009f2ddbbc214a4abe9f693f905f4fee3d687381ce4c859ca849c8f2f47a97b175355853e62fe9478294ffffe8fd2acc0b11506bb57c2f6b4d040136455393671764e101596a8987aeafd02686104a24305b19d8d3950e153506e2293f963e681d589644558a4fee9893e4becaabc0d284ff33a7d0bca6e54555a38a0c252bc407e5fa25303044ec546426047e65fc24cbdfe15bf19abf76d44a9458c8d0a0cab0611e5082251240ca9f155d2e3ab6e05475c6cad9ff67b68ccd38923787db0f7a70150a0ab4acbde074f2fef0b811a6795221ece752622f81f585db8ff90939230600120f9250dfc6ab2382a6c514821cc069682a81679eec42ab0d0397777c44cd58c73c51fe5de41dc83b35eb80c3c40add405f8540019b893df50e4aed3eea95d4d0fe3ea9b30e5465be01527cbb7b5ccd82eccaa5a88b478b4da7b07d6f3f0a21bcbd9ded26187b413be40d34221ee337f446f8ffeba46d9d684b70eba13556154c2113917c25fd989b295daa41c263d2d3fd305bc3411b75e278e6bc77e2bcd7bf52f384f2785bf5641fa46fc6b160b5b883cad72669b2b465359f2a7b45373b34fe3ae708fb5abd76400f4fddc7ac4b1b13edd619fbec37c4235a3ffe481f754701a138483ffe9841d94073813387b590e648f4a04ad3e36cac645af9ea3bdd94a8b1fd4fe0a9d6e024be00cbf93b5c5732a046b82b8b9543448ca663e73be6f56c1f252c67fb0829ce1a6be41c616259569a776e8ae8ba1c502d291fd0bcabf86b42bdee86943c7d856d967927cba512e4884f4425ae8e509f5a2619a7aa56f44c33262412eb6c4830b0a6dafec86cfe9aefd8034c6acc31ca920d1f4553162ad7e898cb7f0a5e1a31cdc09617ff494474f08c4d7a39abc1787681b681d281275b566d23c7382812adfa33d923684d91050258648a470aac695c7aeca6000a4c701c1240901997b7d67de7b9985ff6aae622662fe148bae6cba85f87b247cbdcdd34d09c6a11a9a9682f66ef99dcc32722ec471fa87e8b44d5e962555b5f5079a6c71ee6fdf37933263c81b86a280f1209ba36af98859a21dcb40bd92e6061ec502efc4bc5efefeb45ecda7416c7d77295eba203f73c2e1edc33e5802d8ec0e864f9f86c696d129fe43c46a4b41a45b360ca373ac049a2b139839613da64f2e8a4ade51cf3c0ba68044e0f51974bf312bb6bdada95b05bb0079117cb4b4ae1006f8fc02b785d1349a42bdeb372dffac0785af448dd0369cee4f7e089121f0151a676d27b03cf5b9c76abd00c96ebba95f821f82ab124f5ebed73703f5e1be090306fc2bd363888c2fd4a351dd79a2e7006f0c427756a0c8e9e89c588d00a7138877af449ed4ba5a3ae679cfec0366913b6621ede836e27a0370bbad24ba314d2c8f4adf95f0fdabea2ae03129505e8beb6088ca84683257b7c74165f137c79056961800b16fb705065b937fb13403d6019f21a47b0dfba4add1d485714e8f0834a90fa159545425466e84f970d3a5ac0f695b4d6cb40925f94abf40af92c51f508e8143e399f000cf18e2aa16af679d557309832d2f493d4c116336f09651f3d0e5631da0e27bbd9beb157132b86e2717eaa23016989a767c45d8958c5eac89ead32c19196752d973417bfe6f8141fc61188739b47a52dc5a512a4609bb24a30623a200e2c8f7b7abb658ac165a949ddd6cb0a7db4658091d85027c5344a828eea4d75c0c800a26a4edb3b1badec109a42b5ac379a15ec9d30f956cb4d86be1b3a53c65452dc94f46884f2248592b1385db7049c3c8eb1483c99eab2cb2a0ec19e00ed367488e47644365260692eca8a09367a4e8b8379b95e63718827647259ec930b3a38d0e4b1ca956cb8b1f81f4819aa62f034cee2b7af602828873a2d7fba0c617066f67703ef9d6d6faa519f0c309b2ff5ae48cc5439bd52bfc9beabe208aac6639d91ac0414ed051ec0344277c1dfa65f04c8d0889028b7148ab4133ad0467caf604986fd8a2dc6510334fd974e6aa993ca7503c0314f44db1476aeadfda5d9639365a5a10d403fde462a56e63c8f1e9a40daf6460b6d362c41c2ed82adf502d3536a2451fe14d7c3db0ae9b914ba7979b93004bf8a72ebb32a5bcf66bea18064aaedc55dde16a24d9924f83746cbdb794e21d7a6905c897b56b9c92c122b22eff1e0c0e652398b19fd2e7f060c58d793cd4e39ed95d8fe7a9fcbdb6de6dff4b711533cd327dca0d8cd35b41638628fed6e49222a165ceb495a1c85d37ecb379c6ea90532f0f270b2c67a1bb2ec82fdea1dc1fd6f6bf833de67284347547f900b682bb57e98250b32b104a5b16759aff3f2034c7826c8acec0f1fd7ca6a62e67c2494c4ef36ff822074cf7aa2a3a6fbd9b8780dcdac0686fd997c69dac67b9e382c671e87a434884e2399a9f7779b8b75dd42f9f7f3f856dccc7f4b489f2b3fab2d88bd9ed78a7979023dfa82832b78c31242b23d9c9aeedb2d6788a6e141891e6ec434b7341d223cc20bf0869b88170ecc5fb45c75d0270fecca28a19c30860270ef30ff4018c17f954b96a4f6f9ed02bb847a805fb576889595244dc48aacdbbdc3f12fcb0b23b39b69a5824a3c573363f16203b289d0f8f7e5991d780498772f569774791c098717adde8d48deddabbc502667069113793a609c43c050aa1a09c5dc60108abdc6428e755f122194f71eb720cef0ccbe5d2d8639b5094bce92bc8e462d6ce6a7facb36c34724d6ea84525ec9f912c83226d53026a9eb476a5f6ad93359c8f65fe67838723103f2d0e66839b02bf62349b3fa2bcbc3246c9a2b13493e6bc3389a05a4755b3227ec7233a56a243eeded8363b1e6a6824bf92cb4903319f41c4f000e47148cf6598d43a08f618abc26c69ac105185c11d96b1703809d96dbc6b74e2f70a5a21f87316ed78aba0243c3435e539aad2e72eb77c97746645d6235bb7e24facb860fe0d151d1bbe616b0b35d46083b3e579ac753e9591841015f0fef5bb2e90e08d03010dc3e4cb90f82ed872b0e7c44d77c25b29d13f965f00ea5f2146966a088717e6437a5a8acd5a1bc0f16028f52aedba97a70d1b1d292f245686a35ecd012f4c59ee11757ee6aa3e422d7a8980e4c48e9ff950b221b3d6746e61fe5377c1e2b168a19343a59d5f3891f2da7cec7bd9f5231d43b49627512e7eb3198224342f03b25acee7133aa1d66b43077157b58a8626bf3d8d970e846ba941dd6bf4391c6b4983255aa6e7e4c57138eecdcd5f7790d580a52ba3dd2aed3178ca8a3c30a7845cb1d1fc8e4f77d9359fbbad27c9a8ecde95df7862ede39be275c88b2f4776956180ac346618e2911cf1bbe0dfcf49e534929a8aa2d4f9eda2e049919e5015e1c82f9fa1b9973ff07feaab55a0f098255237f664f859fc2fb0e69b344e60317772af9eaada9de31b2bcefc587de14ddb6dd93bf449c5bc43a13fc19e1974dd789cb5d598a2dab78a235ea8914b4e86a4a905690fbf9feee5516532c272e76ceb1bb491aef6f4a50d91c906e59f93fb4e7434983f8933459972ecfa6cb835f9036566d101ffdfd64530215d936e43cdd7a2d92dc93f04ca87c7aabe0abb41312ce6f430ef9020299540a260dad649b3ce0adc10ab0ed204452bbb602f74e7461286cb937f41029d31576936f9eeb331d76908cef723ca147c5de41b9f9d2b7bd3121e69cfd0529fa3f8773c7d00e9e3d80e1a340862adb882775b54492a63ebee87d80c5b9c4edb8ea8b8232ff22318c9acafef8ac8aa58f622a124ba11715aa025ca273c81627e0cca85ae4aa2a086d98f763989765e7ca1d984f28c0483122bd016b4060fb5d076680209a922f31aaa9675a1efed4770c53b05a1381a32a2c58d4b48b36cd161c4ab1b72c63588dcaf8d03ee0764df27972300a37fca5f5508ef0212017e92663ea4939eea5b25ee7e3e78307545dbad5b163979c0f3d837c9e0b792f5eb5182d8e523d8e2d8e89051720cc6192766ff71e8ca0344479b0b3a7992903563a72bf4952da3785a65a86fc743b2ceae0422a737bc0ac3f512110e568123d33b66ec0f6b5e4317f4ee69fa047bd8821c604d6232836a13df3800051199c80b80d54d4af26b35d6bac41a11930ea1f7ceea95b8c3bd2cbe6138b8ef72da8e91dc796d0203e5df061b6b3a7c874abe98d51c2adab1301e271932c2616456063ea9d234bb508315371b3d63d1a7f64445139e98070213f864702be327f30444d207b32b8a157f042150e39040c8855687ebaed044444e22aebafd40b2c736e2437bdd56c1296721672859bb151dd5dc042fd62fbbec7fdb5370d6e44e908d96355fbf5b63092cbc29497d48366a7c004c72662b963ed96c3e7586ff21c1447dea11f194433cf40cf814a83c3a95fa183eacc24c9ba577c5e7e1f328bb367f0273b1472052f8226703dbb8836c3763721455ce4e84e5e5a0eca8de363c3e97bac57fbefa81828850f8c0a01620ce80994c953c17c526f25b4189dbd8e2ab2e58b132a230669f1cbb1d99d3a9abc931a1270550ddd6ce83bf6eb0b37ed6f8ca36f019be2d0c653706be7c69ca6297dae2ade99b62fde691a0e4ec2e96b7bfd2b056e3019ca4c7853adfb195ecd93960eef0ddf5c7d3cc44d50dd7e445670a01f2f473ce04370ed40191d634d6cc16a3cf8d7ccf95d771f43bb08d92e6439fc99581c3fcf32a1fb7a075accff5d1f181d680bef446f293a05f6f24f1b4d0753ec0a4c99c64fc6ac2c53fb8f434e0ef92d0fbf75f0a79c1bedd41ac28364e4d7ae3ee805b4846a6187132869f7b87fada2d98031cde07024f8c96b6ed9efac33e88d350a9b3e5380208680430d55d5e8b4e7853a54ef0e3ba37e232913dac8f7a504853f7b4f6e93082a9a18d7d9e1d5653f359a7dfc29ab794366f031685b14c4e8186b4b651ac5ee56a76b6226374f30bf7e93c013105d385b57b67dbbf4f27ae77f8e9066edcd1bb20e049a0529dde96671f0011824dea3aadeb7c204a17fe7e62e5a2343b83c434afdc80d159b2f5fa812a5da1a356792689a9d1f8c82f095ed01dff9529ddd91489d7df1b7a7ac24221e3124d5d98bb8fc33c2f30d3f7ca3d2a18e202b886982ffea6cabbc233fde7b56bb2c5d1e00a294c35c3bfc21067edaad347fd0a9897d80bcb4596634291ebebe503f49ffba047873e15d4b5cfbd1c39e769f9c8f16be83a049ae4e4219b54edaa80fd92f128098a07d24cba99d80d68f63d331c1bfd1e861fa0d2ef6ddc4a156d7b70282164e846079deb94a2599b4a7c364947540404de5d03f641ed7a015161592ae9b777d4aaeeaeb9b68fad746d5aee518df6aefc7393a5f097afc7e0aca50c57a4bbeb34c1ee1834902ad03c6aa28765ae62162b965109bad615251f88c37e811a1c56fe961ca994255003b2c229ff7eb6ab3c60ca3ff4da5f924e690eb5fc0d78aa5ad02c971e4a5f8ec8431c434db873c01cfbf571fbee15bbafd08f0b88822a4cb8b76802ee90bc5d78d070df41b23217ae84ccd81c763ff961527ec26dc911ac72851d4a458d959d9860d8f02b34e335b2b814ab094fb77341d6946db850b107f47803d78825b008050103c1292ae09c47efd9d5d08fc320873c451ffa0015911f2afd87fa2bb97730de0e5012e78ceae6b66b7e385dd25923a4e3f723bfede45e1f16f2dc39f2c46f36898c13a2bf77e0ec0e35a2fd66532c16f4c7b3803c7d1433aeb27e7c145153028559fe12b6ac673bd8fa817a2a3e44afe7e4f1de69a7955554bf66453cc647240599971512e0035ac954bd29f405fcdccfc6243b81fd6d64fe56bf329bdc072cae8d8dc049512bc3778eef389ac41506bbd00eff7a83c3a7c9987c4d5a61907131711647305c11a7494db517e8241851640e3ebd286cffa539460750f7092bcc7bba8244b52d4a0032c9c5a7ad32282c873d91dc43eb12562c45518e064acdaf780a26d2605526160e0490734cd97e6bff67324d46d317abd60b5bee65f71823078a730d841027ef845e9d944da7c0d754aecb75c4d34717fc65d38b8bc2fdf278c217211e530b60ad74140654a538b39dea5e426d27a1870470201714924e8c03c1fe6ed381a3e784b190f040a7d37bb818431a3a5fabd045fa1aa828c321efe4d09d4e7fa1f813e1120081210cac11087681dfa0c8a593c6caf16285619446fed2026419d7465939d3d6fa909356f83a7b862024f7fe0e04bab28c66b22d6af197588e9cd39f0b9c1ca38083f5659b18bb5d88571fea040128e37fc6e0ea59a76f37df4358e3fd3f5f3a8dba9865098ac662d8c2b51ec9e8be4d81501d6639b80916f4c235b0a9c483ade7ff86e7c248929551c13b6f50445d353e64c53cfec279586ee153ecfd36c9ace2a35d3dde2cbdefaabdfb88b11050bc5d79827fb77637b8b7627f3a74797eada837d30379165de1811092fbff1ff310904d52e2f11515c76cfc85ccae5e7e565cb7da360e6b9561b1a42a54b3becfb41746c47a0a95e79e895812519cee77e76a030186c9f592e32fb09fbea16f493c3935e61539f86371e1507099b4409cfb36c4466e3cc4616c69c50f8cb31c94afb356ea8803e0288201b1d7b5e6e21516a0daeb5c761d6fb075024c319c47b9ab8a464491b2b59d56e9751a2e153a777d01269802d894ae7c37ad6382154879b5af24fd83cad57c0a3fae1ef27eb58316c593b93901497be2217409324b64514714ca49d2827c70da197ff5065fbb75722458f9e4dbfff4a3905b1594519ff3e0abad201d70223a74a7ded7c7a5fd2edd5fac2ecbce6accd0e3e04271833880d17bb1a36708902457503988539da1174015bf9c34122a3393f37eba9988a91d9a369c4f79d605575e7d6ca1c8f7f66d1450910c4a6555aedfc3d022d055d8a9aaa2423f638250b570ec1c48fc5c131a385ad587a0bc7eb67d2f2bcf228384c39f116275edf6c014df774aea3b314fa2910771e9d5208d1d2f4e5d5df869eaabca282eafbbca4fa6fb8de7edc07fbb71807bebed98c188dd9f02fa02feee340558be8c0ffad91a493b1f09c8340380192fbc91c8ad54fbe7bd169b42846fc334186d79d33016556e5ef46e435e5d74bbe039b7dad82b1fb5463ded025543d32e350683794740df7afbb70fdbaceb8e900dc36fede9b079ff25863937d4ac4c2cdc77448f222fe4c33f849827330bb483833f858c1c3c10d949134be41cb5484e35726243ffd1ce45430cecf47439066a07fdb34c68788fbf41c2938f37a732b0a7cbcff44214e3453025c93bcd2fef486224d7cc0154c2db2d8554a1dccacbc219a0bde3045cbbfc584e87960f378efc2ac807d1ffde02650b224bc02a6b8be371c5de999a538b861d74cf58975ba78589cb6263c261f2e7b700549578b919b55dc1539f1877a2998fc021981dbe6b501998d094a3017a516701995a66a2a1c11265358b15bb6bd3a09b8ac1003cdd3e2cb5e944ed81f09a05379515207539b89e2d182fe633e82b56d5b5116c029b4b37d227b9d885c36dc02a026213ba1401c7b60f6ff2fa719eba3815e94f2453e766faa30b94579e16a095eff3f296fa96249fc7fae41b7788e482dcdeefeb057c3ff436aaa05cb03bebce9dd766583f148009831af93997294cb886005af63feea072a6de34e352d2dfaa3c657066bebc9980b6f8614beae35671ca8118f26becc630491c223c7feb6c5515ca0b5ebaeec1b85270fe54dec411247c3415c7c8c84fe30ccb0aa8c03758d390c2f0973b05d38f14ac08ab0b6322ad7cdf2c1711ac960441646859af3fcea5d4bcbb4276f8bc3d2f37b880bfc5cb92fcec4509e9d69d415b129adea50291822a0cd7e807b605f0aba9e118ecb4c4b426cb4b8bed13d4b8530af74614044a6c06a6788564fd4e9490c2aa71c9b31aa8a2f218f138d44999ac4b7a0a4d451197f750352fe404740804a69aeca6f8308693f0801456a4e586872caab5b9a3ea83056337d97960deca54bd47c00a94e0ed401c56ce9b0f34ce0005f1c8bf8753750519acee5cd51dc0154a98485dafa7838fbb9cf8edafbff5c6e6cf3cbcf246bd99b5ede03ebfadd54422424601d010336546f10272ed14983e5f303e4cde6060ffc2bab7752afa78c1665e91ddecf2a6e7ce511a00209320764b6e5f679c10b8ce32778a2cddcac2618e695b9319b0d2df26b25516e0ba0165a3efb4a9b5a22b9920d875b8ab2337be74078eb4030ac9d83050f10cde736cbd2208de23638a7abead4cc13a93620b36fc6045bd6e43bc55db7526c668d88bfc92f16c1ed838fc2bba518019044438f91d80aef43266192057dc6a25fdfdf2f89be082b2fbfc0e6df974953c703f6f83993d47d7b708fe65e6e7bf2f3db41fe26ad4ee850f6f53acfc93aa8bc0bdefc29c0d081e5f654d0e1d00dbea3abe5573f8de270430de85db58b7c0f6d29295a12e01666d08441511e516f3abda0420df29ef4984344c097bd1ef5b6b5850d8a96fdb82e86cdf7ffede98ecdf1874d59f7f7439f408990baf46d958c6bd4d977d4e50da551561de06affcecebb7d26c68d16e2ef4f2e61171c7cd5d071f15e43fac77b9c2acb0e295ec354e55e1a070e429d7f7e734a3e0c759d1eb269d968644d4a50eca4c0069bf842ca1385673893643eb8412815606f8662312ca9663366d5f1b5392d39303a11ff8faf1ff7b6dc96e78d558b9ff2b8bd9fe670c01bc53478be4c5f9dbfa0b5c69909f3d91b9d752a2c285f1be4af282df886599578226acb848e7bd380110ce51609fef7d65121404111c1c6fefdd67b3fd4f91315ce998b2cf7065a176ed5dbc8038638495b78d0d28320baf316d18912ed9533e6ff17bf2d97b60ca8eb5fa962274d6ccb4ca9b3bc8fdd7304780b84ea12fb7a24a693eb98fe3cee777c68d10a3e6524be6f05881bd634b51e9b1dc750c7e0f79bdad7a88b761f3d2021f10c677c5ec5284b6d0a8031f72cbd96e227842d2eac886a436e78337c49eb084454a2969b0a0ab7a1c0c6960a8a7dfd1de62583d80fa99c4458219c232c089dc86f8cbee3acd1c30206a1437a3b10bbc9904fda9d23ce9fe9872ff3cf093cea9117a1dadebf5ac060da7f6624c9a07e5a6a88acc02fa105bb227477777e96f098c1c0675af2b6edb2f598001f9963678387a3760f0d6b5f57fbb0fa20c55b3c4baa4b9cf3839f7715187a3e0f4e169d8fdc8b52c437a04fb72eaa398f0cc8ecdeb5e445c3d0e89efa64e563495746d0a23320ce32748c00b02eef289ede4d0553db5e4b912909ab887ba00989f2fa278637a87063450de3bf4f7aa2a33c4f61eb61909d35c0b220a30df3ec149661494cf22647a348e1f7c67636ed5d2fbf9458d6d656a5c40b500999122752c686af1d95534c974bde464271848234013dcc6631d32a7f61329b16c595b33471757903466ac1b3d290e249ccd9b3c29c33715d9ab8f69abcdb534a51336dde378fa0703c44ce91aa04629dc044d94d22802d1dd64a71371e5fe462aa7cbea37021b09ababdd95f827240d30968d7f47693e016ca9591eda2947068d60cacbd52e3c2467dc6b32c5dbdb0613a1df6324078292fcbb334b0cbd1ad68cee4e843c904b6cb1b32d96b0687a440bb5ee09066329848aa3d03bd621007adc111e37b783a476094f0ce909ae81294821e435b9b3faa7660fb4994de83efec01648dd30be90d60c4871af5335e322dbd502ae6bbb4b2c0f009eef859129e984e3f9d0dc8a592f0dd0b8491f854345d7af92d2336217b6fcd0f0f2eccbc3a7878a12b87b7d6aa0a308de2e2fec75aea5ca977a917e9b20fdf15fcfe750b0081d548e52cd0987ad40b2551fcb473c3734ba6d57a28a03dc9500ad06226066d0ae065af9e2b07df90652034698786e14dc7ffd5bd66d8103ed07dc0b6836a8b0412a31cc92ef05990195670c1caf5a054684012418aebc9c91c11472b1557215368cfde4cb9b7a971085c14c682a34a9c27bed323e58b5287b8bf0684bd91066a0d8be1f9fca71990ac2b73bdd58aba90b361921ca6d2e6cf89a8b3ded96bc56fcb40085b93790afc3fde86f44eec093240a5854760b86d759618fc5014760bab2259440c8d0850e8b3efa866ae42ee831c25d51839578fdd5163c50fab189e6a12da013e2ec98b1d3e77dd1ca27f7f14d5d1f15977a6076c013a01c3fa78e7e8391861730e0772d4ea46f98a01ec845a8bf431700c226539f61788d81df50c396d86916ba59d5520f5e5a860a2793384e5af64e025e2ac71961c259a0d27cb1bfb135f78bf31a36b24e71fda07d6a4f45506effbdc0cd0b72f7c5cbdc27105d84eb0c116afdefe3393793a3ce699addc1bbc81d93ee5a2432ce18e1d08eb4b10943ea151926e87d21411f537301bce547432643f3abc35c5e8f47054535f03ec57b193a5cea1cac3e4368d5de67c79fefa4ba5e8980bbbddb39ce3c83294e51639af31f1e7f5ed3731015833222a433c8a4efd299e7d187606eeb34a5b956f8247d3b1a0000269f7c7916ad43912076a758565d47ab02c51e9250a96fdd546cc6c9fe033c69c9fb5a296b67c74187f94593b539a0d1b67e732d99a8d53717cd0a7ebf99226337d062b2b0fd1066acf54d6e840b2b5da96f5d638c714835fcbc545190ee025e55816c1dbeb674ae6e777d0fa4874d237e60b3cda4dd66f8dccba03f177ed87c83acaf430b7a7e2c39834059f47b7d16cdb8eed226a1470d01cf30fb7561d82e6e5a7a6a23a938282a0efa4571878ee2aa24dbfc23d8e923665c9224817d34633b92ee4519189631bacc14e9870e651e18c3346f59a6a2fbf51c9ed85fea424827053c6daa7b9e97cf85c25678ca49dac64a6fefc960fd8a05d34c9f782dc337297d4ecd5773c16b09de950401caaf79faf725b850b658919c658e07f026c35edb9410d9d15a04145c491c92b3d308dda7a8b09afe30d6ea1d1b98b443d0e4ac434d94b580214260d634472f559fe963d9ce016432730e2768fe7141a28d7b2a78a2226281939d408b876c713e966bfa67ad3d2376607ee3149a473ede28ca7a04957cdd243ca36691f6eea99e611a94f62fd3ebbf126ffebbbc777105bd3922f30dcf29cce3663a719cf42629e5ecfd116e73bfdcd8850de2b9160bf380052ba7745c60ce9f2a543e431cb212d57a652a35e7ab4663033bb1f105e968f2c678851dcb7a334012d759df0b9d02c03b0c3730eb25be41c03bf9e288e5d16302ebc4f7e4125f4354dd0f06b769f6bae4618ff7a16fc21794a4f4686231d49706eb3f466a6443d666c382711e89e7430f966b0578891b27f7079cd7cae9d48fc25e65ab48f01855dc1d5706d885dbb82aba7b97c562a5757a78b2961305b8c94fa4690058444f44899e45dc8d3c3389d1ce993d7777c3c004076e02f5561e7560f229d1d859045328a00f0fbe4b05222ff2355e988d7e91d28ffdf38d756eba48e9fde52f872f75352c428ea3e5b572bffb55ed86d299d804efbdaddf50e78e324c038923d99f1c9a532ea587f84974f9b41d4c1e9f1d83e5a959ee2a94c9bae3fb874e649a4ef78c7e2b66e5264f743929dadcaf51e7b1611024d66481f6a733a4e9e5da6be9844f4ac8760f109940d17602d60f1e1d385a7290fa1f352e1b327e542753bd8fa9a06970313df561e509205f7c039dd78a472b17b8eb602e2119fa81561d34f6cdf8da35c8e62118e480e47cab463e11b70d462abb5d00f24be7f2b93df8ba29c4ec70ed00f6b45d428dd3687d1a330abac5657089bdd78c83d9193a6662e85a7de2ac9b7a11eae080552f28c7a25b11dba9d5c71518330478e880c284ac8d2cdfa0a9d21701fc6073c04f7a820d70500f3e8a2cd7b23ad2b2199f6da45755af136d84f3b5660acebe7633e4c2b93e22a0b5de9f9af91061e011827b469ecf4f3925aa0e468e15b47888cc53c1bfb601e9838e685e70c5c75ea638b661d7e63d2bb310197ece1ac448017b7d0360da2bd3cea4ad0520ec92d789711804a0708711a7eb99b190dabbca767c7e6e28738fa2d55a801cd5ad0cf6f44d14b6cf72b74488204c9cd5a56b05fc674ad83f01a68ac1ecb966b5a3723f369f0968ede0ea23f3decd059f2331d8c3aeb67561899c9ce3d6308be8c9bcd04b09d72d5cc5358de473717eef5e5cc37899c51c90157147e24feda8d1f8e3d0c958412224338061691d36aaf2f4e3272d5208b05255ac717bc816e540aec7d4f088c6e91937a95eb5f9aa7b9c28174ebd99782e3c1d9000c162dd986c8dfdaff2c69a3b685cf6667f395c1b447f704f54e6dc1b02e6e66c8cf96d630af5b624ee9f560e51d6da0084a9add1ce949bf61abf88cc460c98555f06161f03656601ee13291387b4e7ebe209e946175fe835821ed4bfe9045a464056a48875b1a520c067c0233dee6caa47b34583147e5cb902adc3bcdb8ca391a3c267c64adefed58b65ac9967916c4736268ce21a943756bbe5ffc9645bf584f1154f42d09864b81821e5b2a52c7e89ab0ea4afb82d0924bd075108625a22a66435bba2747fc4c49267475c8ba09d5c1ef1837928655fedd7eb160a14d8b8ec89387a832487604beb720e943a3f490cc867850e6b22c57c098489eb8dfdff80fa071eb3cfeaa2e63a950c691131788f982aac4283a833267c1b2a213ace8b5ffc461a3a080f8010aa60984e2ecd3dcf3c1edb50109d8ee750e7dd13e03e7f00c02deb512e21e6aac6eab2fd0ffc3dbaa44dc17da4525b4ffe6bc6276f0e30cefd5c6ec5d1964e2b8113ed2bb875307e2f7e03f929e11666ea8bf304a73c9461a646915a94dfff292dea7b5af8f7c160b1af70b04f5d9143527ff46f7090b4d4523a08184a22e57a7cff14e0ff3d715fd84f7a50fb1920096f90140e85fa5cacfe8ef57b2a12fc0036a14958f4bc76c2fc65c14797e28795daf9884aaf51b6a0232e95f79188749595fa201646be95ead463dfb3d0433e69a55443338a233ddd175d54da5c01acd9804be4a5d135920c9d86b6757e2f8b4ac7533f1e2b8977c47eb907320bb177c328618747bea1910d29dc1bf86c210c64c6fffd89286a85a2bcac79fc16d82726c7429bbdfed87c75d7e152c7d361068be25f075c00b7bbe661fbc02227136dec9a753f1c0fdffa98ed4656c6035642d92b59e4c4e44e4010cb615a67b040d8b31a19245689f7ed209a8e847f43940df66658a8756eeb821e9f5eb5137157aca3b68f04e5db4e539f7fdbc122379f9d9f5a744741e1cb6cce54d2e13399a9c4a373ad1313a10dfe34970e4898586e51fe293dcf9af24a550b30e3a37df3ef3abf43c77fb22ae0c674da94e4c5fb0232410b71e3c5baafb4ca11f01e78974303f829d35cce88f7425450a990339e304cecb0b75500063c212bfcc2293489091a4419d5a91d8c895d2ea70b022ad64d806e643b6b4b21bb106ecbc8371f2297cfb13a08cd10c0a13e5ed50031074fb9a1a3cc83ac3a86263f95f2b2e0702424b77a1dc99170cfd90dcbde2913321b36dd7cc8d51a497b09e6abbbdd46c0d47aface2107f7ab9807760e3be6d8ec66202c60cb701b149718df1d7ce20bb6e986aa3c64211438e722eabef31adeb158b125ca6b13a04647e5d78602a9877cb736489cc070a1ba63d94dc3b0e52678aa38ac84dc67cf59a646f8ff380ce7c8aa0be3de5c12df9c5ec04007b347c45e981885f453bedfc64efbd8c994770599a9a1eecbc95014fa1391334f85a12b6c264e71e1f0a8f0d43f2f6c7bd3983b0c78b61ccb2efe9a7547c342d7e5cda6c6ede7152688da109d1e293c7ded77882334691610ff2918470fd82bf2d358e7f3ce592d052fc1855848d373fd54f6b8a8af62bc1b6f61290f27ee6d94090cac0f0906ae14b7720ab5a428a78c407e7d4bee71c39c19b643130619313224d94cba428030d6847ab724ccd521e9a5d6a193869051c9e593a7c17903ca12f1f590ebf1f7002998438dbdd22f0fe90df6211b5408c3fdb3bbfad583a0f59aef772b8afa583c75668f663dba26c9491b05bf0f4602c7b6340c07534ffa7ac4af0621fedca6771f017fbd532baf5e85689ca1f6d3ec1b6af664bc508b5b9286a1f306ec32f18bb1a2a091fd0dac7ce5e47a659f975b6d9df09840f49bafab777386abbf5cac0de02efcf507a264519ac9218fe1cba73bba52a9734bc0502747182f3725717ec4163e05909195e6e219660d01e417e4559c32f9264fbc3ec5c075fdcc02212caa69a6064c2828071b394899b56f7ed696983f4e8194358f81cf31bef2241fb5986eb406c656ff711a42ba875d37e7248601efd296e02140d8ee264cbbc7e9dfeabbf9047aa35960a5a0328c7ee9af5e3fecdd66ed5786ae4b761f5d952b6119e6b4ec2ab1d4a755f9438befcced9a2c280745bfbcba67d706c31315cc14e8b8fa6125bb754c89e47061cbc5b1d81b9fe875618f84a5a45c19b7d5e1be58e64f4e097d110935fec41afcc90ca8a184880f16b4125075f80604d5966dc69febb9470ba04ed6f4756ca4b56b511126641c4cdfe10042e414533ec939b732133c759aa2cd07dc570577a118a4bce872ef15f09c9bd4a5361c3557daaf4791aad720ef153ed9d973cef7ae31d28505860e3ca5d387e42ccf7062c863f53c2e35cdf39b702fa01bc327763c558939b5914b38f8f6f77facf12ed6212612abfa4f2dd848e93796d4b16331f81b117243136d507982200c2d707d8a802f88038c532b11de7fe394acaec6ce9eb7a82cc80a5e6890cf6a64efeff2b69105070bccd30760abb73fa182f67df9231ac5528cb14e2d36fdc8bc55d1e762c3ddc707803b4d6f8f705dc7f460a9917299ec1c9e72f9780bd0bbd4dcbc957b70c15b054a76acf3b962000f58dbdc5cd2b9eb544498416fb14baf686d927c92d14fa11e48c7d081691708bad8f501486a7e4b9190d4c1856b881d389a0a9b19667929c916da4319abcf7bdc65e0d04fa453c9b12e778c1864497754a1bcd575c76a68a37ef4a6fc0aacab95546b8fe99741f7b38c416998824b26e33bb0f1b04ed7556ce638505f8b954776f3f84f4175ebd894d6a8efe1b8a4e21e8e0f3afca53c60673e10baa4af0cc9d3abf3872cf1f3c330c843e9297fc65e1c883a7a4ed8a52f77c47d0e1313459e3f231d69a696c766dfdae3d3ec909531e55cecdf297bbfde4d4923c893bb0fed0a688ec7011b9e7dfa01767217b9e20b720dac315c862960cb05472b784487037dde6c3d68628687a8ec687a376f3afc76b29a54161c5f3907e5c59f5778eede330103674b45de39afa5d211d4b414231dfae0b26a6c1fa8a907c741f7c83a679d79decac0ec9876a48e6cfa4a24985a9c2d744e959662edfb0ef7eb9fbe19a8a3dd570054374eeff0a9d63510de0bb2c7813f75a1ca120a3ce7241ed77e4ea63d0b255d21e2868a95285c6ea1a5ae90d2e7bf8edc0a1991f82a99bd9d4eb037df0408acf16b43a919edd57b8aca051d6f7289d05e4b23770c11e58881c4d500853f432442e08b037b96f0433f2cc35d02640a7de20e89fc23d50e444fa7e6a28753f4fec0b569e75be5ebd93febf501265eeac3d02948bf99a25009d2c480f890fb6fd7b8ab6685c3b5ea00f9157f1bd4011eea746c2fa8dab4ce87515e7cf3798f4e5d04bc28037c67c6b2a6b323c293e411add0249bd5f01b58b55e1940d5bc61e52b3726280802f16defb4e39e7db217e826a790569fcd55e13c847dc19c6aa95f7110785537fae295f2e25153dd5091fba521130d524fc1a00a62f501531bccb45f0aaddada559addfccaaaa0efa16c20143ab6165a199e0ef4be1012fa34375dc7adf2d8b88559ba520ef56ab1b8a3194b576f1dc3faa345fbf04a46b15e181682b7ace2db556fcab7ef94e4d493f9ea83cb78ec598d3b5a7f6fca1ae95e6c1c92509a212d64ec0b7ffdb2bac53fb6bc190fa8acfc88fba630b8cdc08f17fec6392c9c41b528b984b58ff6a073aa3c1a88bb49b8f6cb088bc60ec90d16b69478b64f1efa66dd847111c22ae570ec4765a6b8996d15995964fc17228759b8313ee4dde16c38cbd03e6ee07f3d465a39374b07d99f597270c3efd6202e087929afecf660514eb88392828bac07b5cd3787f3b9ec0fa20cb7bbe1a3cd20fee3d1b93cd911e44b89a1abb2f6fc391082f15e06f0239ff8dc7dbf9401a6ecde384906664e7a9f54914da8546f61363075af44055b66d3cbbc9f3479558e218f075298f4a1e181f0ae96cdb51e5a73ec223c282bc4f8dbede02c21855e5f56b2ae279c22f7a44374a638668b7b70c3758b869c772c1969f6b0fd1cdca9d2f2cb14df42c79616636281254bd98d0abe70e4318a0d04d08cc05994ba9293e816c6753a1ea860d06f477098e68ea2d304b22944479e6888a980bf58eef6f8e176e974a4ecede4374f90edea9a1310afc2fe5760b17512d0a1c06d7b6095b3a0f26400743f1d4e33b4edbe17f82f18225745421a6f7490ccadfcdcc332d74014b99ad9ec1caa623a8c502617b26d7d370e9248983f0e0d329aa9fe4cb2cdd02ce9b67e92a23b87287097c286c126774c710eeba5b49ed643c5b03a4fabb8857b3b31cefa3638f79b1f4f348a858572a141e0fc78358a523ebb1a3d4197f66402414c902b018039330fd431c29a61176f4cd33b9bf5714a4d0ba68c878dd06dfe25bac42006467f3d5f0f07d7c091904c774a82ed06ad9c97fe035ee8e6b2e867ccb0513faf2c1b1ec7981d16a80b6b804d1997d41c65cda60638fe16d4d1007ed70e23430ce563e9ecd214e83b519b6f302f088a55d57c79a4ba88fdda7c1a2d1358f2b94bf5fc16abe7f23c390c2d44f2a208b54d3910d5044b05315f0e130dd2d5651f847486ba8248368e946bb3c957f3d857f7ab692093771dc3fb4dd78680e72759faf415c478d48d87f718e8ff3b3324967aafcec9e455d416900eda9d8d545094b4b12e2b79c7b5bd9d75c83797f2145331f20587179f610105958b2d5803e088566a89ae551678180ced33326dad272f5d32c78d0065fa49ad96f1e48ff4f18ca2fe65c104fa0bef75129ff408629998eed0f5e27161a8d8a2be33f7cf166b93d2dbc27f7eb4708b0fc132d9f269d8ee6f171a5a098dbbc3f001c9496ecf7d3d34d33304c3cae8a2030e517728534826ef9ca128546c934570497bdbfb998af03527452fe1ebcfbe6f1775fe4c38b05f467f51f01d3854e6bd3361b77ce5aaec1287966e33d198c79dba6ba6af5eae978680905f213da9cb338a52472290ce92ba1dccded14b979f2c981f6e584181d3ad115ecc0add6303c24c26a780dea6e35d91244237d6b4bb868fd69f9624841a40c808a03964710718dbc008817bc46a901e03ba47cee7546d0e6fae8039effc33b9981dcf7a6ce4048629970d5ec5861a08fd1973f9f5589f36756c3df633d8203a07f156321166bbdb7fed004c2ef277d64c4c65ae7b90b83fe73887d81d3b2dedb15e44fc1b6c00207c9b71ff8d907d942f13b5662f8b49b5976b7b1494c4a3af91b8ab461da62a4de8f5939c0078a9d9edea5e5872dfba886fe79470a90580d6b89ec94c9cb2d07374655d24379b828a5ee29aa37f318bafa3f453a888c33f10c85f2d806a08ac0b47c874d59dee6d0002173288465cfdb10114081935a994c2bbf1f641abd763c0a0705b508d1dc41d47079d841f0fc565e92ed4bec9a2413051e74d537ba93705494e158c9b8d6704ee2ae115b05ce8257e2d3aead8bc071e7fa985b4d4c290c26eb5c345bf4fe975c3c7f075a440325416bd608013ea347c5c17adcbaf2877c29af3c5f25ea2f9f37efce505c4657ed70f2c2513fa13d463fc572a1fc61b23f5605dfb39cf1ca603d516cfe9fe1bae04ffad844a0cdbe4ecefcd44657064371efdb9f82a30b628710f4427db93e327652f53f443e8925624b265440aee5d45dd41c39151e9ea351d35baa3b5c054b98c4236356a6cce51934525adbe302bf53012e507b96cf1413e7c5567be808badc5be76220ae75e42cd91fe1cb06f72a7233767c71a3aa59d823791f43135bfc9a9a572fb6ab37a999bf0a3f38d02054b6161c450390e3ae04f69eb450a37a10067f67f67bbe1a042fa4e84f630f54bd90cecad8872d040fd7a0082491e1c39ad6cf2e11c2afeffddf2eddf85e5cb5855306f60d8008a101856a0a5b7b3977c73e7f3b6013c5103154cff246ce4fdadf9bd76dae14b42329e156a0b1758cbe741eb710df0562f3649c596f7e2efce9399b1b2f0e669df78036a78217523856364d85c37093c56ff7d4ffea230ea71c762ec3aebaca0d5282a3f5dae49fa8283349dd81483612ef897d0cd3164fceab070b3b67631917052ee19a39958058d342d97c9bbb62bc42f33c5843033b159772373e8fdbc532ed135c73fed3277e022b4d88726b803eaa47f9e51e4d6ef48c057d32865a158d85f61524db1ba0960faeaafccc6260ae31db08b88d8b40eeaf5f901e4247f6589b1c0c10637e5cdfdb06bd6431e83048af44788634ece247d1ceda02c3cd224c0dd239e2f22e54dbdd5c2ee78aa792326f68e96bae2125311358044bceb2f2e5e6220c1d18f47721fbe18f51b8111cdb7f1cef5ebde7dd417a4eacb6854d66005b5a88a493f7a2744c9f8af310edf8e343a0af6960790c8ae88a7dd35f2b58415ebe27786a7ca469f131816e86952b2c8c020282143c444f4fc22479ce8c2e3f5a8493a729e01e9ec0fa47a44b8f5bac5dd8f3c16d435bfb469563214b0c25adb36eb525c2b93403b57b9211ce02a35e668895ecb4d9f1e08250db2368371386263d273ab2d6d12a7d1bd6ece1ebbde44c47c4be8fdd54f59cea0c530fe4afa64eab2a226541828f6d7e288a44224062ac9f209cd71349afc3d72a3fde72e2ae3d3bfd01bfe036f8d06d38a3f8a55de1f29c438ffae13b748a6be500a165c49950ea5f1dfd0515d1c041e296513966e4851f5d48361797da61205ec8247f043a2a0e5b88f59076f312ffedaa325040be9f3ca5848c155f691286b23344402393c707ca7abaae34154123fcda3d89f0cfb4a86559bd70f48ce459b1cfd78fe75435aea06e0a56a39d73c16b445c74083d96e75b1bf4af5836e035c81382e3678167ee2e9b7be49860edbdbc935ab29acc9ca7a9bbf96136d2ea00695a7b074ac968ccf11caa7124308829879b77f1e97801999325abf3c8221b6518bddd072247f105afc2e530d3934f3ac3f006ff9c554c78cad3a4c1af7853138e1d8aa47af927c7f0db9848d586935b4aceda0b4a2a81f53061e747472bc236522ff589658acf3bd75513843f405df108ab162196709737832e0510f27e5b29944bb4970f022e7778167f614d2a2b1c73388f5bf2d287c37bb582f3d5871cdbc914ed77dd533db3ae14fd0a856c701f47897ee425ad98572060ff871e5ab7eb8a29e305370131108c0db6721db6bb3e4ece88dca5d2f684906b411f83b98e31f458ace634804914c469488db58e2dd0df186ae7c7ff6728b1eaa60e21097bdab4a84583e9548739dc200fbfdb694ee78f02c0f170182fb70888a34121fc3d840ddc5ae797eda32f05a9e836a9e543706a04436df768d8b17ac3adbd0bea2b653faa4f712c95d22e788b5f0df7c22f3db181310da3908ef3c3ecc29d60d9faa7c073ea135a22b540eb2bb60360d1eafe0eb50f204f399413746f4ddfe6d527e7fbe92edbd7639ffe0993a15c222d4e14d0ad1715151277bbf0626dd9a2e203a4d4b209dd439e111fde521576396ccffa807f78b9890e36d0542dc919bf686e4686a49db7fa46319535218319ca02d435fba37643dd5258c76b81d885a0d3f4e41b32379e5abb6ac435d5b462ecdeec55ccd3a8d096f74951f612a47562bcdebc8367d2126168c8cf77bfbbda1cdc3eaa6bccfdfb6523e10f5cc836719c216365bdc0c4d4a6400d22caef3e81b9bf4851d59a351918338a1fc1a6d01a6daa983c6c4f2d4c66a99302721f7397f9fd9d66a877f1e87d9ccb99378c00e1cd6c17ed777c94d42e959465f54815c38b125dfbdfd92bd1bf68a2585415efeb39255bad6c73512337d04d89d51df295fdfd384be3b5645297f231c9daafeec1d1cdea9e07a89d8bcd1fe4eccb41dbd5a8939a8b1631ae554d7e4f3a595e305ec9b3c5164ca3cc0c5a3752fc854854f0110b87421ca6516b15ede3b363ec92383061158b11fa2fea9632d6a721c2459b896e9e02cdb4f9a5505c6f58853eac044c227814cfe954c4995e0ab1d9f84dcdd7c131de4e1091349508a9c530729bbae0d25cf013dc77c120f3278375100af90dce40c7d1bdf7954ad0e700320b2912abafa99d721dcd8ea58bb8d5cdad149e34367ef903e75f68df764001ce8f28f38d9418a1a39a79a3cda9df501bd506fc57bce4d873cca973352760c9a60e84e92efbc8b1cf3eb676652115c3ed7859c3344747564cca623e412aeb3eb0a0229a7a842be8290c8d1e8eb4ce782069d4da6ebef8db12d1f780a3b859fba5457e311017afd6f16c77713e0fc976854c9424efec20e58460e23e1b3695f528c9e477b399baf5ed2e79f227cefddb98779e30942516083a67c2e2a793139c2c08b446df4c2d56363f99821e53d5bd9f7e10707ead2515b54a58111866444c104f625fc147c9f88b34a33018bc73e8c9cfe30310706e94655e762c496987b98982a668818bbf6c4829ef1ca1a381bc3b14fa79aec14319f28f045ffb7d2950ae8adabd1583af412ca7fee1818670f1b5ecde826973c55af27d041f4f22487b2a25a10597c760b2f8033641fb577bfb661be1ef9db71c8a3b0de6720b850d617be42db758233a80d7e60958fdc9eceae7719264c2d28bf9a52a6ff4a5e1a6d1df23a15d3186bd04c7c042e6b28592066e32cbe285f606dbc2a2ef2bd94f529eac6d6db15f4c88a689d902612e28a468d62fde0241d1e4a24cf9250c0f1be7bd331fd4c90224a82502937328aeddee619bab3eb3401bf023f144ab0224818edb2712f740344122e9818bafa92cc4380bf5cc9cea92a9555a1a8853c64d5fed51cd0a2727a00b4a59a3379d13de182181d781c23c499a28fe2b283567d241edaff2e1a3d9e42c66d61d2d4c2efe62b3ff5fc10b11f1d6d1db4243927771eae2849fe5570fe3325f846756daf61f87453c8ad751486d0a309a3036b2ce2613b3115cce7df3113954b2f4c9d95724ac6e12b79c00dc5b53bbba98d50eba49581c9b6c7d51aefba6a6f3870fd642b8e34fe120c89698a41d03078e3788e0d917bd96f171a10a9553ab6edfe761cb8f71428b87e11bbd9880ff05ffe05729cd34453167646a6d9c7142d89eee5d9cd86eb98dce3282719f753d94631db44e529ac98920951d9f0c78995c6a9096b866baa544b1631b278b8c627320846c5684e12f60cddef966a7cdde528bc73a4943b0502d79764c4028df23a4fa9e85afdca094deb035bea2485e143a06b303e25180d618a7519e2e2a55367be80af8abf08f8ac9ef705d8253712fecf5e4adf91f35c15b4dd7b314b25919c678d5fa179dc4b738c11a521c3ef9855e5ae8a5ac477dc265383c6955085e806c48b2118c68673eb83c5b68e98e504d0c5468e5efb3a3e741d308bbdc40ecbb67c8b1f9364739475521724ae77103905f64240d2be141da081889c4e3764c85219b2b9cacb3b69383d2ca187cad98f3421f28bc82a67e558806136d3f3761e4eb814121b0d812b0bf08cf271546e9557cb88bd3cb895890742cd0ca5dc4b3d88217485f1c58006c00e3c059a889f3b2ba565956f476cf98d8b554030056615e86022c373fa3f8e921134017bac8c996316ae6df66fcd472e7f64e075879929ce2bf6fe225bc33cc125f1e188e89dfd1453837c609f1fb04d059ca34de68ba2863723ba0291d247a7186d184cff1490a9e225ec28d01e24d78870ca8f06163d7d94c6e7fea04874c9d1968c6dfd89042cd38923b9f84e3e6026590324193ce8ec7cd6099631830fc3da91686f75707dacca8ab170b7f5db425659bd3e2b4f62cc2c90b65de857397afd8372403659fb996077335ef6c36de1a4da9cb7fd74d6001056877b9545ad7b122162a52f6d2b1238fcd782f6a7628d293ea7765b9e0adb6fd3a55d171445b77f1262da519c600f643b391f19eb23915a775d9ce1556f90525200792b730bef4cffe25fa9234a0f7e55a421ef9bdf7bb7f86b70f4e32fde15660601e129c5f1709f01460981d41bf6e50d676dfe00251bad35ef02a7b63da9604ba29be03deb0131c9cc4d10c8d99d7903bfedd9945ba1db54254da10d3bf4e52706c4298110992031a5e7f27014a581861a2b38ffb4805ac311e991eb06c8d2882ccd029a406ac4ee10946c732b0a0058a6d01ad52d6713428a29865c8b531f648c5301098d37e216a3af8322e97ad2d0612d9f34cc4865badfa8664e18b5015aa62771acb8a889f5e3b0f1849d23ca78e9b095f2c9f67606b94fb4fef3f6b11ae89436de84673dd91d3078381cb827778ac194fa662d42e0605f28eb5e4007f28446854633ddb778fe233b561b6704ad966254f85de5f9548ae4fb82bcb7281e85c8b64b6631c66b0c82f5ac724b2a6eb51a25774e8ba3ff0dba8d54096928efa5fb96e6d7d7108ff6c5bd19683be8cd6b76166534665f7b9f967d449c6f4cb9dcf3213ba3d317564406ba1d1e03b745fe2ebbe0bd1589e214aeca174e7928b37b628a5d34d7bba90504264338d8629b899cb82f9b2b876a0bd03d3aa7dcae6de72c1fd380f94723d54fc83ee19eb08b92efbec19e6c53ba4bc7ef2edef6d77c3eb9c4ac5d44fa7637e5579d3b262039974b4c646b09ec094109a20511db58790391dcb2ef9b091cf50360ed43bc1caa22e8940b585c1ba8525d333b96e7fd5769b7c89f203f1f267f95d9dbcf0a3200256fe01f3e5847384f897e3dac401a125b197acc9a839e9363cb9b215a5f9b85dc3ba42ebf6fba9edba8b9b48f06b63d9a06e880b68cfcdf4531593d7f1d21ba17e9ea256354bcf5c3d68510d47aaf04135593758a683f3d6d6749c1e11875369e0a8435ee70b34803f90bf5cf361a4985abff5065208bf6fddb82cb8c8ced1f0028865b09d83718a12eecef97dec8d05da3be0c6b7642d8bb267ede070f19600e705f0c1cba709c1fbb35393463a62a9e105375b4ac3f177a9d96d8cbf726f0d2b5b15948d8618bd3a36fb5c5f5f14a6e798025bd164d205b05abfcf515ba9f2f8c665cae7e7914ab8f5a68e7a7cf8b63e6c050c6f99aae7566b76909b8c546108697177c50abb1c58a1c995972c2a6372f7955051713e6419719c04ca034049bb06d811312f9748c1538491d13c3330a0eb8bd85f42d695cdf36c1957166732cc972325b55a194b5dfaf6b7b979adcbe059870f8ccb7bf9f9264fa3e7b9c77f45494763287a70983e0e7ee877abe48306ace09a9fca9b82160369fdb316e7ff18f27e09241df201b499fa6fa3bf1db8dbfa9355935cefd75b8be9c6e0f46d19b095ca35f9b853ade18191944c7a953905186dcbbc7efc7d169d0e8251569121e56871ffa2fe4942824f497a8fc5debf21701eb38d070eedd27a5d49edb562b0330be870a78d41a72ac7360b0c2180e0bc316c79b3293fdb7b9f27ebc5816287aa60adc52f604510a8be8b9b5345f02217aa00ce0f1dfb540bd31813f48ef1e4f4a7ce05f76bd0c751e3ede293f65a07458d828c8583406be0e47aa61808522449cc56bde3bf9835fee725be7452a594be49125382e9eb63cab78661ea509ef611c7419c88785033b31799a7d8f7e66a72eb30b01b7d9820e1e85f54906c118fd594fd6271400a6d3e165db4224d0b1ee2c18495f2c8e343dbda1567e16ffed4b9e1c188fa3894a90bfc51999c891dee6973e53ec2a2f08afbb0363415cb51a7423513cdb1180314582fedbf30dbca8125267f87762f046ba7b18f6214ff822fe5914a9110a417be8448be67e110df1fcbe16b886555a3a7e4c31b1a7235c0cc9f8a590150faf773d5a3d39c2005f2616ae8b732eba91bb0f5f10fa6976ad602268fb153183ba1ed903c0d19aca8888a047299995ff824cf7a8f7fac06ad59247732edb8a7882fbb0072cc063008b47d6812adef4c57099ef324b4220795eb6650512e35aba72c8c85a1e05d36ead88b520354bfc071b3354084a012f7bb4295b76e7e814332915b6fbbbac3f026aeeef5775546ce73f706c4c505c070218806504e0ae7d847d7f6665a7113930682bdef0c159cdcfc058b0d8c54e9e6baf750920af8845148988f6bb078314ffa166058d15ad241a43f45c8832d180279fe5890ca1755c6ce5d7be5a2ae52c52ae8b1a30d0248652136f8dac0eb291eb733ff7698df3e05c36a753760faf720443ed9041b6ab30d9650513861a5cc56a24b4a28709df7989b626fb3c60be24b2499a6bdc38d209309ff78437735ec5c1e17bde8955733a188d03e3e6683386be8dfdbfdb8682bc53f905f2ea66697ca75d0ca38635ddb969c2b61cf6a261668c150aa7f86cb2945157ab8f11b7b5fc0afd6df5f9984558900fcf861621e1e9cbac5dc814ee3e905c2929f73f968f9c02e07af6ba65bdf55975743882bf54a104b2f958948383b22cf6497355b947188e49058dedaf4f797c9c75d50815fac773bb656931e02bba87ff7a2675ecf5a48baf6f38fb99bfb55bc77e74956a2fe2d1198a649453012c23dd27e0df9f019bea51d024fbc418d57f361c5c0c8c2494afc7269e53a103bfab8d20c5baa2e5f0182bcc9a67a16d5d9113445624c0a2418db5caf646604a26c4478ab22f8ffdc4d48d9b434882d4dba7450ef5c64042743b1704101d6f3b75adb038302433c7599cad454f0f84889b0b06c7941fb58ccc548a1c94fb1e64c6b9acb27b502b4ae05a4bcfe5c556c1a063757a206630e4310e6172899728845fa37ab5e5ba651cf0b371bfd686bb84ae53aa6827614810830eb8b5bcdfeb900fd17010b45309e712c341ae94302457f3661f12e8cc8c5ce4436915e947f704f5253cc31cbddffd07648fbfb8889c257c1c19ca5442332062cbb6237e6baef7f7bfb0b91616dc77f43576f8a0de5b1f24e1a2c0c0dbe9653a5e6da7256d77b6f03997d9ec07663d624b751784983945fd296acf0015091056a067c3922c62146890e2b903ec5826b5a3373596e83e0a4b15cd79e340d56affae03ed216c291e40f9bbc50a18ce7b5da2e49224fb53b792a1dddbeffabc6fd3d7d11d34c797d6a109641e1b319c37b86e4292bfcb1252436a01f587c8f201cde999e93c81eaa88c4c478573860c01035a088f17882420a27b9500bc6c8b95a098cda6a23aa6ee1c654af00a188a1c5fc45401839c1e349108e16368be0824900763ef5236979c553163737b29d5b0b476bea6c9c2ade0534794c45e354fd0058588ad27f74092d163107572c3163266d1ebdc1f3d7c9100de43ef24ad377050b5cbc6d36fe227b18b6580e03d62b950066d02049d0a0409515b937ee047bbb2093741a5e123a2b94e908d09c5bef7c7c98bd59c8735ca3b0e0ca9548d1b6c20611147042620be351cdf1a92844dc29f116b506a20e7cbe7de4d8b4e4dde2f3ae45874a42cde8d2b308eadd0db69481d5629253697db72f9368223e74030778b1f81ac760d5e6e0dda9cdc715725268f066f97b9fa454d70542ac8d7dd7466877ae9427c460f006c321fa19deb84c52844fdf96ec36ddccbfbb45031d3dabe8d699bbff09e45653c6318d107c42c32b31828836ce71b41fcb7eb754b244f3cd90e01ff9ecfe64c5bee49b56efd9a772fdc3f1f6bf1df52dbf52e443ef6302f96b37581ee0d8cb0fb1ff41df771a7acdba043b62b3a5936f8de24a2200686ea237ae7a9ec19819de24ea0c055663df605f3943ca457f6747168a3084c2fa3df113991b8b8ae8e96660d1b7f8ded81496948a3e8c6d1a3ff7adc232e238ee0e20f25817a0f4fe31734183eb280bfff80de5d750d61e8ccc9f9e9d7bf9a02b037e9a745e0dc716d114ffafd2cc6e57362efc8a1fd98d106be2ad31c0b58a98d13ff07c1d1f90eddf2e7b2e39ff39d8beac9e8d7efc911db7100493759f107f74925e8e8d44db8d7819721da41035be5b9ac4d010a066963f9ebd35c5127ac25447a90d2e063c72b467e10a0bbefae657290545159ddc5712d0253ca20aaf4fd12fb6885cc37204f2a6757d6981b0633cdc3c7a6f6ab11d547850a785dd36e91a04e047d06517812928b8b34dc48775f182161bd2b86c2b2aeb4bf9bb83bf82bfa8f1daf711e2ee2ee192d88c134dc826d69fff3497a826bb473a4ec844d5bce42775cf79d53e5675704d98c97077df3119b6efd4e9b73f2324845b0596616b22956d19c4b44a8e08b87639b659b31e2e2e874e39156e451c319d7c048a214ba39b72a6a21b98754d0c9899b28029d9652213fb77c14bd186fc51c78d252f6efa81919f911147ba45f8c90c5029b5edc0f9d89a085fa7190afbdbd7f762734972edea2ba6652d014e5d1dce68f5d1eb699e3b03b193be3ed1c15b963a70a4c10ba3589d8029b146def24f12fd9ba83d3307b5e59d19b19ae3dd09a9484013d0fa1a90f3cee7e50d8e5c2a0498ea59a745b80e59412f3ff77c34f0e1aa8231f944bd156222a7b751cc572cbcec1e0fe27ead39441f0a29be2432c7e9380b1f3b52c698813a34e12953550e3ab2861fbc6029c9e4c463089ff6bd93c6e9bbf9d0ebf2f48f6a74098d8a2855d11c8ea418e821a0d61a9b3c8484778c3bc9cdbcac1bd3a27ef8e8f898d39ec62829e5f45733c130c7ebb92e744b6e33351df9c55c5d05961184b9dfc663ae7199aac8c66207f05f2415ad569b8ebeebffd7c25411d71f3dcf89d2cf8720c5f4ac815d7a86589e3afc099f50d5eeac2fc074ed56e8acb07e7a77baee8026d12564df98d3d2bbac5280b1550a8ec54fca8f256c4abf066db4f330eca864ad9d538fd83f7da402ccea7a025e13b7a7c5fd6f42cdb8cdd4b21e33a50c580c8ebc380f4247eec266666fe4ebc2f1db15831a375be8cc92d2879a97330dd0c80fa6284fbcd078594ee0b7f824c2c6223b11f13acab5a14d61635b6e7ff40ea984a444288a24d0560e7f4d68dc6c7fd4309863c2c30efe54759c0c8a655e6641aef04e460adc80069b8f5e94b603b12da12035025f4114a6766ae1e2565d2fcfa6e943886d628825ae033a297d292fc5aed4b5a2bbf17f9b819145f52920f70458ae809b562577e53b74daf418593b7e87514ccf5c73cee9b1551478a53e4b5c07db96e7b03c274138fc3672f0d06bae6b34df6daeb742626276af7af6d068d743484a41d1ab766e2bc9ed28e1c6b0e6c005d7975448b3cbf22a5fe02607242a91b0a1d10826c48c6a654385f11dacb604ee948ba6d5a3b083dfe3f4f46b00a1e7ad86d416db3242dd1939c0e9011272fab0bd60bd1558c88e852121b4cc69c37e5ec5b80a49beda664b97a71010a334e9e617f8fb8dec7027c59ae34e82c6f433098c05b021772c1b2f1fd81489a6691198999e0c7fd9832665b0c174ff9acfb3f7d0bfccab42c6f29b33f430b1874dd5656a803938032c41811def904e914cd228ed8d617b28a9a96a220a8cc2b3cb89be8287d4b6795e2f13826846ec5cc0ee1312e36c25ced153deb9d2e324339dac144035f7b65b3a8c38f2ddf156e955670c5307c5d112bd44b1b506aa896ad280eb5daae87981a967e9a0184e050deb09ca99ace7804bac01b97cf60cb1d3f7131dd1897598810007d10a79cbdbc37dea21e5112dd4ff41f8e4f67ebd6404a512c2864db826bf9fce9671496bc2e01e86b4da503256169d854240c43249d07402f1648a31e7b7386f862a3a0e4b02f103f3276c889f2ab5eb5c439d2a0dc94719e202aabc09824a9fa0bf409048206e30f186e314b05d495311eaedcdad4321560e88547c5a92d2c6270d1c89de5ec768e68bb3084a3e911c728c637d0f013d4bb6f1f7b7f6f92266c57782238f9c766f376ea5201874d9200ac251d4947a6b4e7f993e11a952126595838b31b8005e851c1790fb4868ed5761ab131ebdf3567c52dea8e9b6e9b135a27342c347b35f9bf7afadc1e350bb13cc66fd43a4c3b1b667f87f2a12f2fd75b025009834e3ecd5333d1aaeb143016ae2e77820294b0a709820d3e68383739358411f992a29b3d110ccc592fdccd8f2dde30b15187555f7e25c8e39a9ab1449e32546d88f808ebc64c1667bbf3cd71f2d3f2ed4ad613ae76b627af2d9926df85a65cb098b13f0284e6adb2c17cf87c1c7ddd24975b76b7a08f923558886c4812591b580126877ee6a397a2d3a510d453d9663354175cc4b66e1a6637e8ecfeb4498fce610a6f5d7142bbf8fc4502ea524be3d7e5e1c1ffb10d9408b594863a22e1512e24d973d6a8940532dc1c4bf9ed30752bb8dc8f0023d9bf583a90897e287f5d151fbfe7783d3cc0476ecc34bc71d7c77283d71a1d06f28e7a477b2726f67726821b6842758eb254de28a7f239bfe86c42eefe4219af74c0692c37b623b36b68719b7fb8dda622e5d821509e4e9b71362f8e73520fcca9247e039329ec6afca9311287d322479efbf587c2913f9409c02a37aaed72de0a4d53002222d022d25b5e59197713dc31ea989fc159ae27675a4c5e370c6ada1ae47dbad49dd2a2f4e34ea1df16078da8526fc4b26d99c1e5f7728537d64ee8fa54412b12b5751ad25375aab1a3615545ef40d7cf8441c37c78a3e6d53edcbff5533f33b6f0d020803ad6e2fc5c7e446cd2cd14c772963dc43552010a25d92e1e2d048dea1ce966dcc26c056a5397c290af6c53fc2a7771b80c9ddbac31905a45db22206bdd8d60c2422c53a5acc811aaf66ade79516c208841a6a4d84a34b6f8abbae79733bc20c101a1a4404765ce3f7960816754185dc185e28a531b614b9028d3e2c3b459f47a4b3248a610cea0088d735a2dbc3e58d84357f115dc2451724dfddf24a077905dcd4ddacbc84386245fece050f5acbae90036739384ad387466a9ce2df2c91ecf36aef264693969720134f171c12def0886f21e37b6f267df5987cfe79ffa49188327f837ff98ffbf4bfd61221c6341dc0b5689f6dd6138b65cef86dcad9679c14d29c87725534dd783d7aef9ae02e2732c89619fbc2db05fa03b819f51d0d3938ee7348068a8f543cca22d99f6257b60b94a88d42ad68f3aff0c73d8e2e35863400917b4fbf96e99f62fa9f8a2e54431f442be6ac9b7472f43751f3dee622ceee4f93a89439ad2e0d6dabe3384e8fda81ae83a4d846defa118a172d3e8f316a868331d2c1d343105d8b7ad28809750e3544622a0a0ea1bc38e5e93ee14febd812045dac94d06efb93c121c93d1caa51292452bd8397a17b7a30f0808d92542aa12f1e275a9732b3721b778b636e7e8003d0bbeec67c866682bffb869ae588441cf4f0554458f668a51d73fd62b3f3b84ad447e2b9db157e08d90428cfa407dee32ffddc745c8b8d60ab12739e71c42843e603e7c48cd4a1af6949668ebc833fd0ecac56d4ba743bbda08a8681e93e8b4cff036fc44618d9c381446238b0adb1267451067f20f055a69764e4efa8b5825ae2779b850348f9c055c5f08d035977edddbb1446804db63e5f08a80ef6b69fd3bc0e91582c91b3305e6768a7ceb15f96068425d3cbbd9d4284d88e512f765768d3222c0e3be05cf7dbb14f5470270a20af89c0d7275347cc57e6768b806476ef24b65dbae7aab5a9e8727be84b0a8d16fbd921c2af7c23b1aaa80f0cab8d90fadbd030261d72c83e3a0ac0853d26e844ff6d53414a1c8c116985a2e757f78a331a018d636cec607d8ec2c6e36dd604c6fbda4ec480e30fd7cdb04bda501a1805470dfb14aa10497b70f41897263c0f4448a2fdd76d420fcccddae8e1f8aed77e529469a7d2eecfa1f45debe1f9b4aea4282631e8b6683d7ca3a77e31770decb634e160c5e3ea9839413b2c14cdec97a3f8ed1a587924e18c277d1b46a27dacd0ae91e8857d493960180115e593938668fe8be0ff4864a5a865f49fe9acc2374ad5e0804a875a360c258db3edac5626091dcad6312587cbbe477aad18a5212af0aba0b581c77ad65d5fe49368cd780add1b174e5be6ffe7cb0b6aa73ffe25c74518284ac53c3c32784dd4d2c2e965a6fb5f916285e0b65424bb5f6270b3e9c20489ff8e7d15977dac4468a98feadc76d16fb90405228c9eb595e1fa94d8775ac90f4247b2e13d94c8ed9f66640b8ec89455e2dbc263f9d949b2e5c1b8e5adbd30a7f8d000e6831019c0bb7db5ccfb00a51760d0e1af8c57dddcd2969325739106e7fb663d88871e4407fa701c72eb45cd1b6b50ae589c5a0393b0e0bbc74f2eb1a18ebe67bf2fe8edf5786ff2423b5e27573a8d726d0f4ebcb2322985850b5d91a0172dcece2f779782a4eb3c6724511b0906d1fddcfd74de4ced061996c5862c6f6989dda114c64047af43795f879d1603073d5c00b74acb65062521439df4f6c6290c70a5434d1ff1ed1167f679e57769896b9fe341e6ec7394a940e1414317782de523fa37858d31929f688a9dbe35abaf097c50788a3ac36beb8b84421693d8abdb8a96a5ee37cda349b4258c04210e189bda12b7b892e6638adfe1b44dafd0a7c963699f254034c2525211a42f545be50f3e5d2487ce4c9f1be057d17bae35f4d7f3f349c742a6c3cf4903934a7de00fb3a3945f9026780399b6112260b7d626f13c08e632744c5088c39a485560b2014a3182552c6e91bf697074df344811909ab07ede7507b786d6b88e9550a8dbf24e9a083f63fdb83f859f5307a7479310de3950f5eaad5ce4fec7789cfd43258166d5347618419a7347a81c3f60a7b632bad2eae7e16159c34eee05c37aabc5d384e667954ea64cee983467f8c41ee2f4a8f7475ab694f1468e5acd59136ecce9709632c823b54693f7cb4df7f59e4ffb0fa392cd5152ab29f50f1059cf7674477a884665117a0f03854733d424c982c0d8e80a951627e364697e43450cf6009e050f175b828a7018438609837ff3777aae1d3bb155aedcbf7f088cbb6dbc5b3b83f0c06ed401cf2bf22794b8e9c6aa739081a757c26a3208a684d602aea2155d47a3013d9ebafbe42b9562e6735484a0f548f85109f7f0aede773c8e02b20527c434c0f36940ec46e8fe3e5be38556bc8d29533a0669a0c1f273d6552608ed483bd41f44499f572213f963b0c669763cdc6239ff414193a26b82870b8d5b4db686222c3fa8f3aeb20476aa338dfa1297a646c3d5e6cecc29e3868d8925154ac51c7b99b41bcb67753f8d9d5f3fe639c575354197d135e85d2ca2cc87eda09c03e6383da09ae8f6ab9cb0aca9fb54733c783f9cd285f1e0b4800bf2a53a2a7181159fdcbc69a7840f2b52581d2b2d356ba59da58a263713ee60843d6db43b4e061471bdb4731ec7d17b55c042fc1181e9bbf79f9ec1f9be828b69773770fb8b949b47d840cb9ba373c39d113696c0d54fd897fa0f49b5ad9c25742d547963aca9a254c0fedcdde20a7442b028f826bba0a84f27713c902aa67e4de6ddca880444042b81a36dd23db23ec309c46ac82051d92d30d8f4654dba606ffc9cdf218e8d64e7bf1071106589a59cfdd4bdacf5a0d895517662561bf0bb489132f07f553d433486a9b81eb02c73c38642986722348af212c2b92fbb3f451a3f5e8753e73fcbadafa764146987ce2467e2f753f4a01451f21ac861410f950433282f73107a5f0eb89a9a656aacb53a2ce88ce6084d6d26bb8e0ced75d7d999cf9208896955c84cbf780024628f06bc0835e033867710dd31011a6148853a61d4401484889fdae89970013a2ecfbcfd7e6b8a33bd5323f46628682dcf47e523a79628fde111be78bf263c5b378c8276bf7473b6e11fa0fbb6a33ef18784c681c13c1ae14a7f7e4f23e445e858bb1ad49e3a40bb7ec66c9487a7cc9c80a64ccdbf04d1d11423ce3cf3e34dc17f8c13699e2aada32b7df172aabbad659254099cfb375bfb55e7838aba16f16d5038ee16c71828986dd4042aa2d1df95369dd29d8756fa23d8a251d9d74c4ece12fa3083e15341845f50be7b4dda9384245500a9f3584442397b9ed17b9f870bc4537aed6eb90a5079bf1f3a6f67561877c2d08a2673e4040d990f9d9e05570a0718fb9310d514b4b51b009bb021fc52c782c3468141d384e19c5575551e67f67e2058c63a1f4f0b2e70b10a7a258135870cf42e645640773b2f39873139eed79e1f09088a442cbac1a63e9da465a519784d319c9d737f8baa5e46b763592bb0e4eeb97f14c77af8de9b1cf4a1b58358dfec3170aa2c1eec45ab1083b900009580df6de1966cdcb5baf2047ab6264ca50f0db9d49649af59864ff6c45a4531ecb3f2a3450c0ddb57dbaf4f6e75680275d220123a9d3f6c16cb1e0772232c38cebd4282156996a9e1589bf6a40b8261d9173d096a8a4ba95e270e27a2cea4a431c6be28fe6a78927b26b2f5d694fd67df78a8a4aab28a12b607ef10066b22e4073f7a584f9a7aa40b7e5db47854999bbb27e1e8c62491c6703b1dc06ff5ba8f1d5f97f08b2937079f9d2dc61ba770a281f75ed585d38c27be6ee49e23739059a404e1c6dc332743651e22df3c06b5af960f9676e8523363109a58f96b4cf63ecfc9743d40db976ac6b500b56bbaff81e89810d6f67f62b4d7be6312c2371234cf2da9bc478f1670b9df5cf093a5c39b5d5a618ef00961d73b68ea4be836b79d911631c4ee1ba19f34eb6e793dc861cc7128080b1c99cb423d283832ca080b0ef3841fc0d1a5cdcae0e29fa2592a8572a994331d37aa3f507beb20c6f053dfd10d981c3906461914e87c75cdfcbacd0289641227b1c9f42f5dc964697eb6ccab80aab93e841134e235f60d19539272539cbc91069003e65857a3b60d0ba6da3abc724e5aaa1f38df3e1cd518847203213568efe5654198e14f265f72103fa4bbd3984bbe7069367aa4455e28ceb30faf044a85f9e52361256df363140574e0df52e56d926dbddb43712e1b450ce8fa453aafae6ae192bbbff2b99726627310f5e61062259a95db86276273f8db64153679b361ceab756fadf13c83f0b0c67b058f7e7bd38aa2f7b5e5c3305a7cb669f591ee000a638e83964ef228e8dfc41181ee36b3894c12668537baac458e677254dd6c0f78e2b294e3b2f83f3623bba5117ec7e8a15489bb423c0142fdd3b81fd3aa87a358a0f8eb925f9f65a54f95e97511e80ac8d6bc2e2b483c28b611121e9dbd1179a5ecea33d1ee99e5f22e2c6dee39eaed0a16c9e5c883d8c9825e0c6a9ad6708ca4d7845a23cc85c2ade8135ede768c69097e4408d5542bd488064e6c9f3e16b04e0a80f96f4db505258e19fc015b440d5fd5c795ed71626157fb926e23980e961827218afab5b8615e6e9cd1b0cbc3b391454b765008ada89247b79181905d22a35795d8a32ab04b99e48400cc220a744a14f093a1353fa809112f3d4181455a58dca670064b91d86536d8934c03ac64abda5c759bd6af69e906362b52d7738797a4cfd8facd0b48f7480657e10a4dfd5c1c68ca4d0fdad924b204b578e5f148aad57089d40e482b16c111b08e7dc1aa4c0342320493544e9ed615b50c1f3866e97194e56f9516eaac4d8ac12cb35be4881d2cb311dac02f0b15c58bf62ad2d537f29ea21578adad90533107415bd79867510a9a794fc39c0e9af2ea477a44b99c6a17954da7a761b4071d1da6fc2cd04e0f8f34236268b62564059a3a34047b4c0edab91997ffdf722c6f6f1d4a36378c2cec9b9697b2edef154bb1d8d67b13077142770a1fdaf02c76aeb12a1645d266cc84b1e08cc23281dbb26ed9b6d156e5bfa2d2428b08a9d14a9b12eb2f1a87fba204732a924550b38342c098e9b31937f559c76b177bd92847b63903c69063f5705056ee80918129638bb3221e6e1203b842eb633fbd015325df3440d46b7cd166ebd099bd106a9cb2ff38a5501b710df3003284093b535c5b4bdeda93f9b67e5eb5fa466202d2d6fb4f559b55cad81776e17ae0cd4e448bf5f1ef6b1be6178e0758639ed802d6fc3d16d687a2f82cfb0d992b51cf81324b6b51bead04b534c0137f4d9d8e4b74d0db5a471af725bdbed7e783bc3a5bb78a063e14870f4b2c3873b649d4d5a89a1aa0788ce9856966c993b102e53a03c875c0d756978eb36b6d642029a113d50c7e1723fe825460090692d4e8c474fe4795969e38089a7cfc57cc41cb33f705ec521c458a76a04be92c8dc9fdc435a39e2a8b9ce9d3f945abb77752bdc5fe43463db0e97549a451520c01ae629c3ca45cecd719ebc1c5fa249d6d6ed0a543bd24ab4ee2d6e32731fb485b7374c0c111270e8b0c3801a6ed8c828919cf90dc6a4ffe97a13fa350fd10fea991a82cdbf57e312b4b2fb41202cd71aa209dbd5c99df1fe03318e8337cea1dd8b2c12383363690f5fd3a65343653ce9dcb64813fa33b0015bdc08d2469069641556bc5e01744429620aece80ce3395f856b36bc70096f74b7db62c243f2c5b8aa47019cca54691bcfb0fa02db946088c368391547dc0d9aabb66f6437c484775dbad721702ab65330d6ec9e961469007b493819dc38bfde37ff99b2149095ed178f6943948d459931230cc1f5d7ec8a69c0b39f72199274fefc8577210db02a0164cae36daa74566cd461523bcaea095fd5bb81eb45b03c4d623a56b59abdcad0c9f668a93626009d9adcc551602640bcdfb933c008a52a92c5fb745122ca95dda7afa1c0f400e5db5ae2988b867b13503b3323c4a7e68f566fc166213a02517b04df81e4788bfdb0dd1319918cb8ce1744ef1097baeb4c363ad5f448cc03565a192ddaaf2499ada967c76433f7a8644e3f1c2df5f0966bca51913636fd1e2c3d489f9a96d62a0844ebffd21c06540b46ce829821fede12fa9c764ec92833414212bf80716772e80da02cff76af2d8bca873d28836cefff8fdeb6c944f967911d2c88be5486b3a7e4d763390fa50cbfe4162400a5e5a5fc7bcc37d449b2006602a5a059858bb254bd612fb17d9d51480f687b867f25fc6fef17037ca34198d019998baacd26aa21e6190fd48e0289adb1798cb8cc38484e484868af8dc6fa9ebda2205438ff8efe316b759d3716bc78a1af17d7b8f57142e26a426449a1e79bc8494f03b145c34064dfc6a87584ccbc4d2f46fdbc0229b7126a1a4e0a41f1ea984a5c061ae050e0e52ccf302220a323dd16c8cfa3c34c6a8f5602deaa291536fc3abf1e0bd973b626b3a98319d6ffe661041c16ee894e98107b53e2d633dbd087866c79ed9c1a13a098358fd08bedff209f76c1ac299ff0dfb759d4472ceeeb74fab1c62ee75954af8d6fa957a0fd0de8605fbc40daf667e3bdf3bf9c4e4fb15e9c2009102f7ffa88df768c20727b5f64d13b36e23eedbe9c51e9acf0027dd9b07895e1fc8cbd083eea248e33a6e2130981fc67f5b234ba4c5d8c84409cf078fd2f37bbdb97103e3f4dd759745af3b757b0e314b5736d2d6d3cc502395599954b435ea487666f8f40dd21092311fb8b84934493d82f735c999f9ee667ec12cb5e2b58a81e006438bd858d3df81eea3dab277feb9b099ee3ea4bd45093b6a52a4caa5bee617d0dda2d4c5ef4cb70ce495acbb75f12b5104f7035e67066b0da79e1219ca3ae10989238fe7258f6a5d9eeeed3107fb979a48b284ee4ed1f1132e074fd10d95c3b72801b62a8d38e141e79f5127d71f5207885986affd72377cb31371d06922a4c425d1e083a2e059ae813b0a5e63840a8d99d1f94554dfa862690a3869d3a960ebe9c27daa101f11f7728ca0b23dfd8fec9e8974a9150b5a032ea115cbacf0ca0b9d4bdd77e2a8f52f5407fb4947fa6f3c6fd4ceacc6cf6bac190176e2b60797e501dd9f68f7d5959da603e6bb4f0aa1306e1dedad8133df7d5ee9b772aff99a9f553f0c1dd9418cd618301b2b4adb167056b739e9d55ff18f18ee878484484d41639a46aa5768a218eae3e7eadc42e852a48fd2f3a8ccca4cf7acdfee1d968d7ed0494881a0a1824be922d5715979f1e8c8bff6967de0bce73a55bc009a66320087841d628c7db1b49d4db2cf9cf5bc71527da1a03eefdc4156f0e6bde2330d1e20ebf9b341c1405a617b076d5f2fa9f2c5ba300b91021a7d9991838d69c4f8e07b8ea261e43ac0c01ff7f5a577c62962af156bcbd00d1d1c7830d19d4dfef5bb6d35350c5bf7affe31d18e1fe4e4712cd811d67e25391df45c9d3ff93d195866a81c3e89a88b12ec270760e2cda5e80de8971201435d575e80ca5eb94d93c35949ccfa2c307dbe692b095d994a9e54488c38e4b16432d5f6afc96b44efc230ffa793639f028eadf2238e8d4150807622c7ffa0cdc60520afc15e8524a75d5111236a4a36862b1ed4510fb8dac8ed280fcf2fbdc81644ac821ea67f057979057b78bdf28eb15e3020d45fa216a1258f6dc1249952898a2c69f602b2690d4d76f297deb44e2a2e110a3134512e48a6493e03d5ca30a15c061ce4ef273d792bde6d8b8020c4a65f2afe2eb33cf9cafd0d1e0a7c87ace0813ce706f3dbafe4e3e9d085e0be4250793a940d1100abe76914f1e044d6c619c84456c0c1f5a3726744067290832f3acd938457830d4ad257d406d5ba015af8a68855dec1b959064531b15df7e026c2e9fe7368e3d8b01263f7eb4ba1ed9da261d8008bb1da031551bf464a66534ac23dd37dfd343bf325bba720310ec9594bd77c1c5f52b65573e99d046b86afe322584e881a40d51fb27d8649565807fd783a984ab40ed716548735536f45313f309cdb3c17d11a76d7eb9c1621c6a75c6139516b60b39d383a1f5fabb5b1e6791455f79d76104b31ecba862c092e478c160fbee5481e218eb4cf6141836ffec9eda74611cfbd605073b56595239debea57ae4355ecf1145b0ce66c014ec6120ee99648855a9cd0ef721569316f2b391eec7aceeead461e3c2ddffe92f5b3ce17662f4362dbd71c7a4374aab67a64caee18c0e9174601e01a32fde8018455e6b0294f5de1da13602aa0aedaacf092fb8cdcc7085b02ccf8f835a6c7e083765be5fa02e73daa1320e3471b2276d96743cb0491ea90c4bebd775c28ab252805b148b615f452441a1ace912d8062d652e64ceee5f5c7569745dc4da5d64f71b61c64ffb5780705c648aec80619bbe6e2038a69e8c0ab55e5029fe8b09f19c5d70413f88d00d688ad659b6b271ac08442b9cc754f6508fee6df70f92b895ad06369921d3a27c2656e6104b00d17fe4338c47a90193eb57960be44f979cc2b7974b6b1e7641d53b98866c05c327849f0b077679bdabe8660f9c35141e108b1e3b2ed40125422a01afc7ea0ce3b0e2bc830a3b59b58149cf5a9a60a559f0edecf9b18447cfa466b2d08a2526eae07a15ba8aa00478f762390d6b59ac7c7e0356c9bb1a2f037358554053d481f9ff1450d19f68be9010fe8a032cb179c4c57a1fed1386d5197ed46581260ab3f973a66d05441aa76f9dfe6e7911cae942df8b5ee1a788d822e1234ae31de89a57134fe84d87001e7601723da7331a5bae906c0c4fed95a83ed6e939f36f7d80bac708285bd7e1fc5765727b4b3e0521ad103ef50daa7e5bd6fa337f4ca15050d6714d5ce89a2797f779d8af594962ff372e02e2f437b59e0911610b0391a5fcc904380753b779f5de965be79d59bfd21ebaa48316b3f78697160d65ad051a8b241af3c589943cc900c01ea88dabbb5f454299f0cf3882dad0a7880da283df91fc469e06978c0b54f2a28cf65c404b7b435263cb22ad29e36cf1b68fb0040c21fdaedb552160bade0b3b5bf676392ce02afdecb52add59fb3a04a84932add9a1268d944e6e2bd3f312d96e5a4ae08af4f940ca3760e5063303f35f53b0095573f7769a5b62df490a41bd7d1a1be122f3b52c82d9cb57bea329f4210145da9c043f55e3cb846c3e7d7021835d00ba22aae3980d4632b800e5d8c0b905908b778f753280cd6cdc9904e2e1c715c24f098b51e4d7521673a4e0d1898c230c4ff5650d7ee53ff2ce62ce32f862f862a56ca4c80e7df88b3fae0894da99be93c76ce1b4b782e2bfb58728ca8cff068dd6bcf84228661f243fabbccc902db57a39f11c4193761407fd233a9acb352c64f337cad1a7009be7af4ef806488508ebd4b45ca160807fea18bf3acd40d7e22fea2fb1ae4b5476c7c2559dec8c19bbf05c4205664807ac060aba6ed778141dd5efb0616cb1d8c176e2c31e723d2ba996bf45d5e7828482f32df875dfa070e35cd484015921731adc55e02e20b907a8e53fa90410f48ec56200637f66db1128c732e3b0314b84df1da3330eaaca4fc0bb36dda07bba43b29122baa535f73311b7add1328cecb4d135b4564c425bf123c0ffe49684b892e09d1b4826b9d552902c6eee6ce9f2bdd7721e848e80b3607cb912f484edece7928d875c0421916e33982fc6259e8951d727447845e289a05322bd53a8551d73da1e08a33a5e0d78ae40cdb66f2681cd4afcd1d573fe3c7fcbebccb75cbf13e1c430526f501ccc1b9d76ce938256fe7f6a944024023e7b142cd10c85e1c7c52801c41620a31c049aac46e2ce37c6e1ea7aae745e0810d2bf4e92de58e0a64b8354034a4ec1d8f63705f6d67ff5e46f3ec9f10214296502e2c95df44f1cde97b2aec409bf46064ea73ad632400d52a0fbef30634501da094be8b408b9f39237d31c2f045f0e0adcacb05bc30c4bc67fed61e1c93ca7499a30556049bf58c67ff5677a2d339e4682a27901c396c4a458cd2f76c77ae30d59c6269517b9b353ec772bea81ce573aa8d301b6b45dfd870f7056fdd49d1f38abb5fc1a1b3984e1b569b8b99899b2ef0fa05fe23a87f14ea58beb5717427b5e63320892e93e445fefeaf1a3cdcdf4b6507f1bcdc0efe6ffd43b436a6ebecdcc31385078f8b363af4d708791a78a36668acb36da13f6780201bd30ad88ccb3813fd08914479ade9fd3f5d604877db0854c254cd51e6940597e36de9b92ad30399b425e52264d2174f9efb77927a4e11ae742532bd02dff2aee633ceda2b9fee69d1f3fdf4fe81f4ebb5bc387d9811129c66eb765f1b5969702612d7814ac509a575f111522e9fe95941345d09242b0678ef5d445752531c7bd18a5a3b93392daeb65177fe7ffeb1b53ec9afc186b78ed188191df51d25d1f1318432f7f9252c0b5b8fd5ffe4952ddf3e7850c9772a3932331cbb22654100129ee694c747a01717f2e14f93094b23d5021203c88bbc6bde6eb03eaec002e33afab71085df28b5c517efa141ab635fef5c36a15029432c6b5939b2d53cd0d91dd86c952468e00dd86bfa0ee32d101fb04f4014cdf14858f57a55f87ee6e3d5970c32b62bd2be6258e4d387bab95080220781555bd4f50e4999ccfe77549a200dd3bdf3e48a7c5fd814a99e0eec1a5cdb0a78cd7d6bdbcd8af50cc2fe8f12196fb669c959ab3a9aa0f450536e3e17bb650e147948fb1a54dbeaa33c917a432a6c085574a9c112bb33a21af4a3199f27ac1f3f6e497125132dffdb5c28d77639cde41367f664346da996780e9309e40a7d5cf4f0ae5eac86dd5f3865dd905b32c5b73d7fd352c2565872edd434c5032c2dcb4bfea0b560b382c56d9f272913cc87117565e214a9a0950ec82a66a2ae65bae6365bfaae121c47a3d0fc4a8e7b2dfc5e175c41392fba707f3a688ae113540977833f13cf8e317fd7851052ae9e0f45ac59354d818e4cb3acc8ab9ec39db6981ed0d78c26577a945220cdeb715138095133899c290a565296c474f45271398eb7dd3127fbe21b8d0c0ee07e997f0dc146fe3125b56677f0ccc13f402dba74e67a0dfa36cd772dec314c859cf7c3efd051d4879d63909e23eaf934c3535326d78a648a494a046c92b934e43ce4556a8379d27a965de2feb235cddf87e14222c93d6e63de5920bb3115befff207a55da70d8527677875418519441b565a33e86bb641fb4928b34597f2938ef127cddacaf5e0eff0712d8f5596cd8c9119c96c62a582e067ccef6b962483f7ae022dc3a449239c8c5d1e16b80b8e681247b86c492feb90ddf20aed11cc6ef166b64def5dfb917d597716038ef45abfa2c043a70a325d1db946340333f54bf846f523649ff9d4a650d58b9177853b12494b01bc08882c2ebda96f27b78e7ca9b5c740b2762fc19458fa58a6ac1e8af787e025892ea090a3da0490ea60ac5ec9cc28671f568f5a5638d10d9cb23dbd5ed68991b5cedad87f2931541f213256e1540e87da231d3177f7534d7ac7d48be43ebbde58ad3b4adf45273f1d070f22cb3f2c9cffea5543a251d3df0dbf68147e9618704813d533030030df208b021322cf0a1417493bc72b0eff1662d15cb655d51fe991d2de1497e3cc35eda63a5d5ad43e1bdc6e49e04465057dd2d6fce35bbcae0b28846da1e00c0a9f031da389945df1c7a07f7c7655e5ad49b58a9c8e233f5656d1652e5bdd0fdb5ccef85fc8cbc4ea7160ef2464f3bec8e8c6211234259877ffdb2ed83b819af7f480e159caef343202003e0af89979cbf79fc4b8a36d222e823c1174d330396d6304864971cfcacc5bcac9ad426eb2023d31fde357fdad841294d4346c603ac779e99273c3c0ac135410889548d3de4d5a8eb03409187c7e7846e976e6535c7636aae6827651b2802a5699ecd3994b992e592425c652baa9b708603a6d3711aa4c997a47457021e90ea1e85ddf26fc9ff1fc895fd9dd7e459b342b3409ab0123af36a7a4ac788d3a0e65cf9558015df7f4789580e3fd24fe592507383bbd956a54a99d82f9d6f243b6c58c9b64d8f9a58b5ce397b88b1883d221388d2c29b62945afcb707bd9d230543938ffe4393d2c372e63dcc145bb0a814473bda94d8d4dfa5e1b9d18617ffc698f403ecb842d770b879c994cf76dfed05264446b3c156b93f48a3ad23ca7d93111465dd59347955edf036a16b55fbbc20012040c709d6b682c346dd115c810e38aac45d7d7380f36ee97d7dfd30d88409914a1a6423ecdc70b23ba0bee8d3afc726d13ab2475079edc33527ee1c1bc6c63339e99a74f958719808b2a37b2786ec412d088d434ad847365312e7763c3f339d6192ed864eac6005b25720f44774773b56b66c6122ee7ef22dce4ebc77ade78e57e3b243ef0984e4ec2befb55dcf9641526291fdd96322e612476a5b72f37574a1fa975cd99e468d3ce1e106f660f1eddf7eb31af992ce06a5f52ae0cde17e37421e16e9e8f9edda476eb7f2970ca3d1bbb19ed28451919c18ed5621dde81c4c2eed5ea72658ea46be32b83e6099e163cefbca29e31e3889cf93b14e98210a98dff1ae094277863cc3a015870862718441e222b6e6a798679f955f4c874bd6803515beca7e849ed2aef9d947c46d2f42fd3198130caf5f8f6bb5f836c860447443692b9b0d60a033c0f694175e6f4b3121c38fd7342f6efb98d1b3bdfa46121736cfc2b10ab2fc5467a98e742286798318f0ce7a7f7b26601d3c96052c5ddeedd3a3dd8ccf09c51ebf0c57b9e08a806fefc02d53864b06c40a6f982cf61061e51cfc723a1bf268833fe15f7b4fc6518c8731fc7c6b21f38d1e116c5e48ed5859a9db10dde63eb6dadb93339cf5f389affc55a7885d75778208ffe1131e500251fc50dd52cd03c0ed5b49bc45df22efccb1bd28b057fd53534440089623dcfb890ea90cc4df88ced69335840e7f6636e9513b5ccc7a80a2098cd7a734db133dffbd02be126eb8135bb0d6278bad8cc2fefb5f9bccc27539d192b4620cf8feb87120a412d4ff7241fb0bbe8b9c63ff04352f78546ba8d8af7638917146968a0ada2cba37c49add58ddc313d258ef1b5d0eec388815bf3b8b4f66559e50afe90c5be38be7fdf94e626b00c52a708d96fe5c59a13f796baaeb901f16d673e70f450cfe3fafcf3300579a0d1b4cc95945af97b74c3d59475a5049ea2272df654bd5b3910dad63d90d7fcf5e2811d081b018a87b19ff98f0b084926bf27798c223cb3b3339917987f8282c37941a71858d2679cedccb70ee83c3ab4bff89a9490801b33e1a39a05717e8ab1126e5ae09157c1fb4f87ded10a020498ea10fa1fb117c405e630c120841bf22496725f31fe539ad1b415806ad78b699f1c19ed1cfd0fac3c27d1543fc8cee96e9bffb1182471839b5d4581b323185b8a9a1804a1dfd653b0b4130d0c58dd24daf460febfa3301dbb722ed4f3d9b72a029190ab657c05a2f991e1af8e1d93b9da4b8d395bd4a8eda5fc485d5d4297bd846dfb23a9a58c3b35744fc66de903c184227f01a677f472631bca3f70f826f58a39449082a8d9592156922eb03524259980fba257810f5b25855b846a41768c0b60015993dc08156e56b8ba88996f8577042e7f29ab541858730e1ebdf1239c0b8afcdd41bdf7f0cf8f05a924001a9b5748d629f1746392317aad1cfd55e9c57ecf85cf263b0a091f2be7d5804883ac8b78449e61a07f01c78413e9f7bd18123ebeccef250c347b120dca849e05150023c8cac5350a8a6912a50c0b2c7dacc5b9b50141aab851c867d04559359f95ef254e02e19f783ba41fb121707818dd1b20120746969fd5ae849af9f38a480f9657e9fb95cada30e61495292722d64032cd10e1da6f84d2bba36cc06616eecf4c4ab50d715654f5492dca6f944c1930e65555bb3a6f8a1c6af93e2564e8a57a042a1881373e8991ec3dc2b0a598caacdf072233051fdd1b66f3bd7864b521726e4815722bf2312a3b62c3bf6de9ed84648471c5e9fc82216fb7adeb714d9fc4f71ad0350aa7c533d4f7b9983c21cbe532bf18396396a1c8834b2b61b72e13c2945c40c01c32c7bcc35c5fd2ebe79a38b0fd76f6a5f4d606cfc67a0a4b78ec900aec8085030acf2dfea2e1cdbff6eb91b124b7a8c725d4029781efac60d2af4aae6a1217e8c6a200a0fae3307e79e5b97cc6ae889003f308fc65a97787b14fba6f63fa5305fbd1f5214ccf56d63b9512cbba0b9bf5b93379029bfda129dc2c0d585f57209cf397df22ca603c3873ce234e75942ef5a5267044696134869060f414de879b3f80191990d694e8f59a7ba35b269081fff59d8b9ad0799dd8ed039609bb9da47d0f162da3522acec9714c6114d2d152726609925c9c40c97798e5b2b3eb007178078026a625e041f96d495acb2be41d15e46672eaaddb2df69476ee1a2274808806c833b590c243408c434e9d4a566f113bb8f02082d76b2969ee6bbbe9ba559926a6d9d9c572ba8d7ecf43e161040c2efbf7076e6b3d1861ee4e76c6e8803bc835f929899621c04be69e6901d45ca45956152d958aff46cfb25d45fec7a91dc06784ff5e63a095fd6fa91d17882f88bbe10eab9fc7f44b9424bf9b952b874b250fa6d0806b483581f4c7738846172c2d6d218c511ce85e11e90ab39f41d31ca7c6c97bfa13dd2e71a906b0e96e6d6fd226455a5bbcd8a5b0f2f065aedfe1ba06c272134bb636edfaa1cc01e858ceca65ce2f2edaba5de990933d126a671e82816804e86d49535d0f1bc33ca8de7f3ab702cc4b8b58eeec7686dc58623d7b1293283851b230d69cd281e73ceecc4afca3152bf8e5fdf779fe027e26fc51a78f48c50af5510862da9a0379a520cbdbaf50b8150ea685638516af4755daca2146cf3163d483b215d6a289fc7df1b8a14680737d1da1bc3b9ff8c11f515c4afc9f2e7d223d90db07ed9948936dcc25e58f9bfe0eaa2c49cd36a4a478e8339bafabb2f597f07625e6eee44179e963ffb5044846c8bde19e1a2efaf0d6dbe75d9c5cab5dfdbff7e91fd8849a388a4c76f0facb7d118ca3c8823718d0fdb43a2019bb4922c51d40a56a4968d0551d1612fba956f90f6286eace7869d82b880a3d1b79892947f7225e29ba48bf165ab71894188af2fcd6152f4264a84dc6dfafdd8f1c1d427b8f91e4d466a1b36a8397afa80b764178dcbc64c58d7b3f598fbf47fae0c295ad15f9497090067eacbf72de99455680a52e186d760aab43b4511f484a4242d75e62167044a00d174c2846ad0d83162fa872f4556b0a1f7bbb71d1dfe626cdc0d1fdb1ce943cf4a3b94237445749cda5e83e3e3a128485c8678a7f1e0a4efb3e38e41f189fc6981ba2f9e6faa3489cec7319febf0110c76815bb6a29c180cf36d9bcc0cf66f4e7ae4f86da4b9c6885ced50fa39a49f70e10d6be4289058ef14efc1c21a38461036eabffc326d852325554dc4caab5ed0d05989e53cc83c3292d63813ae435fe70028868f2b77eb6b2d9ed60852682acc3a36aa306e0a170471f70699cbcf5c6f216caeb1c5d5c3043631d057e26b6741aea11063003578b6266d0ef4f848fafd5ee911697370ef752fd5523e905e669782d2fca3d5f903d62e01bc8d677bcb2b22d2caaf79cd0ffdc9bfb80afaa371bfdbf9bf3125233c7df721b513ec9f79adcba8ac3d89e259f1f9bc8466bc66bbfb54642c54c3d835cbbef42a90cceb6137f7f26522807f53f1278286256e2e285390daa0ecea36ae986c72e7d524ee1c14440cf752f83c56f4539ed93e7f0f7f6ed6c174d99a68c5d29d6d37064192e3baba278f94589a8bcb3da360b4fcfb182b771039a7ba72438122d061d86b7a14b26c199f749843271bdcc27c539c581320b052f0f0d96b8349e4ac5897790d914985d4fcd0541793beaf3664b0a46e42b44af73195a99c20ab92b9e9f6060307f9a21b718dd23e765456574bd59e715f35d7ef415e7d105d24e5ae8192f7f3a95a94b0ae3be32937d65c4f9c0386df190cd14f7dce3936ee8ebb4ac76e4009429b2c5896c178820450aaf311ee1950f29c7ade5e777d9cff88c71fdff45235635c8d6439dc49e8b8c4f45ea18c48b637434126d0dd1030d5db694a39406b44b2b31109e1bec7ea7a730c7694f3ecdd34197fea16b867941441ba07beddc540e38af7334b53d2061536cf1b62c37d6f17040c2f1e0cec071af3b8a55146170c0c095b6cdbc65db3bf6797307dffe6a082812795af56f3199b53f96faa25001d8186466cd853c3ce2ce62991eb935ce09ba49e92ef62193dbb1246dd4eaf540fb1d9e62475b95ee94df30053b28ab49c6960c5473687d194e3afb6692b02ec1ed6ac30bcb5670cce219a2584d243b38be8f36322f89857698001465420ac5236a8fac106460bf2de30c26133922139ed059b6fc97e58efed2695dd06c89cd1d30ea34c378bec9d5492299ca05f0b7208345ca868069191b1878d9a8d13ef4662fdeff1380763ef1e00e0836445981b8b3642af7bf86770b9a77325ced46d26754ad6ce25fb58720e6f0219e2d00ad7f4858ef79b0b60bd4fa862a2bac08743e966010897847b25c577e33d4a21773eacc00e3f7b39cbaa572182c5fe20f126dd527c9f25344f5575726fd24813670e8cf138f446fdad725b791f2fa8c58de47fa3c9545e0a156059399d482fa62dba44773f04f7309b8b6a88db32e7fda9fa066c8b4336fe5a216253eae6f80282f318a0aa62acbd30932453feafebd05d5e1b33cff3b5bb5caa589eb6f2a0a8e39e262f3bfbdceee54365cd70c98965e3615639808d51cc96624138772cb7fbc771909e3dfecd811144a705abb46da21701e4b3219ebb2d5ab6f865bd66e32494b82cb097386a0e2a0c38df8dc5d0efb29256f45efea0a625bebffbfac82e43d6332802a9ff834f8cccb3bcad49b36cc81fb46b432d9be1340e8d535d485641bfe37a97331567334b0d62a42eba87dec1bb10d46c7c1d6d4abb3febbe9408f0ccc01d12a25b24976c5d9fc660ea382e1d37bc3875c9075b6b4e635c3d05776835765d0d936ae4332a04eacd1abcac709152c582c3cb30fd8be2efa46b40114194291394d49c1cad982d48e41d72d4d92f2175e0d4cad27d20a758a51f1eea2ba465d7b31d1fcf23d189f8cebe6d787423c97e0d806d52b54e8356c3a4c84a05c3b58b669574f810a91e2b85afc119254463e94d7dedd97da70de1043e7fb0ca87a2f01789195da83c050eb8578dc2f3783e7dbec14e2cc1c681d521174a1d34c6511104fe7788e2668a79afbf6de04fab471ff6f236aa841bc0e33a577a2a8bdcc24a1cfa262375a243544230ce1b70c0ed400bba487db669b37c15ce1d1be3b6dda07e605ae2e7369e53838db287579fdedd0411e92758633b131f207448d251d9b75d423006a690f9c37d6cc18264799804435fc35dcf2ab519289583e1f7674c1e317738747734061e2e9b9a26a17671fa34a2ab75dbb699e64c4aee33d7775b7692b695e8079e98761b853a343085475fbf272bbac677ca81c8bf708b691971d1d4ed49b35f8b5641a0fcc5fcc3817f3c80c29b3f56cf368a663eed4ae1317c4fa46faa89a4ad5e9f245748c9605d1088533c15e54b6859b5090299ccbaded9590f364ac557a0d3dbff604362d0fb218f9f670988e69f5f566ba22d38cb37dcfc7a57f379173d30c4ca14efeffa8d5ad940620a9fbadf6f4780eb449191841c478ed107ed4f70630fa26e2fc510f4415395256f5057e709e2e54c5f0e07caf9ad97b9bf6c7297e6eb994f95004af75f6c9652b7818fd3b8c13f2aaf9c1c4c3c44283c204c71019e97abeff578026c77413acfa5a46c8ca4bb5ff97c431fac273064a12c4cffe1c72d5dc3422eabbb0f94e5298c22934da23588b84ade1e9b162e7f59cc72bafee0f8ee9c3769bb645f81c701b1c97b0888f889b5e53ca845e16e6fcc377f4af2f7bcd19e52dacec496e58d2ebf86287fd90cfabaf342b14a6314594ad38376c14bb60d65a936e8ec4b2e26d2f8a743b62306af05f8c661c3b664f6880d01f402416594c2b3af0804a6d34ecf79429f1111d0f65ccbf449155644657df52279fd531303d122143225d6446888dd36e46b47f643043a5f91e79c1b8164b6f384c03f26c8e57c26c302ac2006ec8f474bca2c85173b8644f5a0b7d81074d9a49debd7c91f97515fbfeaeff68bc1cb69a9330bda56369e2b696af5f375a493de286443e0b9a84514f3611b488c39cb65c232df635809a2b5e94d3f3e180de1a2d2b671b9644d32fe2950cb5c5072b205d158e8882f60a563bd3750e71d6f23fcad7d60c3bbe9d8719452eb2d3460f7f4ef03fbd0e6d3192ee940f2b3c85cf35f90e610c303297894f6841e55ab2b8d0ace9cc5873823e6b76c086eb127e01667a439bfd487b9b14c3ba2e94f00bffe9d7c08a96c6e40e6da8010a9c4fc08c78c87cd28b097d5cc86abe272f57d760f56fcf887c6c54f57fdb3e87a13a7e440fa5cabbef44430d4abf780a20d718c8424c77e2d5db0a3a9a45214be69aef4ffddb2f0be9d2b4915b4235c3a23860733622af90812b3510fa06c9faf7887e6fbc2410f7807dd487a9d854c02f8c161fb4fcf14bc87f89adf6d4de4b6d7b529679268f5bd321dd5417e24934897adb48d73740819035f84f54c505540f54189a338414e558defd1f369fc28bea8678cc4595c00c76c1a7d394d4203580d61adc1b2d2fa9e21e0e6dba5e1e75d27a1264cebcad7167df3e652510ef90fa6038adc0f873eb2980930178158630d9392ced000849cacfaaa468eed72b1085a7e9c7e619ccc259ea23bf49112fad44978ddc295dcc58226733294a2b0682993fb3c6d268c2e9fcdb43a8072491632e2b85cdf6b95da81e28d560f53808c507eab22c9f88699f89db39254538c297c50c27171cad039c1dbad23cf09f8dfa73e880e749cd86d343554dbe2945662c06a6118b0859ffbd61c36071b0467a78d9f1655ad0152e5225ff530a9a83fd1d8d81bd02ccad03f0c2a6e2e8e9b536c75282b10ebe6e30366bd8b215b10023ff010c0aedbeee504135b444c7364e54a05aac51ccc00e04b5313cd8cc8d0793fd473c3351abb60ef48f9911ddfab0166389ff23666a8614f0d037493e547b84ddb92c9c766dc22b66c7bc9d1e0a74b5a0d177a993391e5acdbe1c6a7632559d0e52f761359dcc85437f01c0a9afcc5ad4533b4a18ec0cf17fb940c8faafb5bfc266d0cd0a1c5b468ebd992ede1db94411e0b1c9e8815121f545acda01fea10715085d26aa4acc0eaac9e84d1de32797b84c3d50ef7d46237dfc44dc71f98b3a122d0c29e9f06d6560077340d52e9f7d2c2e0b6435d29fbbc58475f8535d338bca1afa23384c23711d8e8b2ce4a0d5ca124e63e88295d31ced9e5716a0c3114335c1540ef0b0a3da8f9eb210a6eb23525917608de0c1d2bef3d299831db5c11233d7030f1697a0c5122036a482eb4717a01c40a9b0ed361f57deb3125b9f8c80234690ff22ca41f5605d480e841be4c7d975b2858a5982f1123839ee3074ead0c00928d2e41f307b09f02c46844b30c8e66ba8779bb8f08696448edd09535bd642796850a399b2af15a742940a233bcf8f03511e9ccf4da3ab33abdd98bb504617875c43e39dad170ad0780058a4345a4901423560ec14d556e481aedc129fdd46ffdc44bb3eb24b5e144d989e7019df3582f51690a9cbaf7aefccc133daeee733abb93f86c27aaccec17e6224cb3a1ff7dfb550aa86dd5c79a071dd1f57a8b0770de28e644f8084f0e559d97ccf0b3f701b45f5c538dc7041ad3b4637f9385f2447268aad5e7066e45186ad280f5c7ee91bcf228042956f03c7dca0e52a43e606e482bc59ca5f27042b0a5a06a23eed48f099f1a6c691ce77b64743997505fab1e31c254872e383c44c04808182b39fbb4257727b895691b80fe15a3fb29bda8360618562fa8e8619ba3dec2e4ff12e1e53efe8f98b2bfacde3f64947f823219e7bc171a4fff722703b5eb46d42935b25ac4829412b88e33fd6a0828824ffc212b2bb37ccf122200c69f2c2dd3325d31cbd542af0cdd45d2d538e3bf5217de39e7e28fec31153693bb69692d42f75067d6444baa9d23d1669973ceffa71ce1fbd7644e8f7e8d39c9cb43457fa07486b12a267f114c3b3471b05c69f00f64f9f9c242f51bf76600f92073abde96826790371915a5a7f72108bb79173feb04981a3d79d226f2fce4b48e1a283e430b84136340fb177d79815569562a62b5dec9f3c47a8443bf51b4793f5c3467be86e4caa692d5c25f6a09e30428019734de6320edbb061a7ba58dfb2649776b6183bd8b7a38c20a95ae2957fe1e0fe24e1ca690d9231b36aa952346e65cba4f462443affbcc95c86b5e82e05584114114d552f02bc21e36f808fa114c364e8bc4970939224926b7326a4354a47528c0414e03e0428a585405152edaa2ed757247b72c4886eb9b5337f91554a9ec88afce75df576e779fbda77ca9bbd920c513a7ffb6221d6d527be6e4aa476b0b375466d3627e561d024a24825f2bc8a06431ae020b29bb01b00958199f4c260b4ebd7a4714e6529016d159fa8c4101708a53a675522e808a54aa2969abbf55960f7dc3d5a325e4808be305fd4fe6a2f8f4cb093c78d4c04c439c4f414c85d9fb5f97873643ef37edb348967d3b521ba3e11b7e5e85519e04be91c0a177c0dc7aeb70c4aa0c5bdcaac1977240fc2ce55daf0f3195eb6235263b4cc6969ce78fe3906554bff31dd2cc7c2976ce27b0bf871c1a72c29c5e16a8562847b7a4140e6f28d35c1444aa97c8e22f0a882540961c1a3998b6d07895e744e7fa407b23a60839d16ab73f0c81018f75315dbe3207fdaae405f27858017fab9fae7fb2c17c494f32e820c6617af4736afdcaf0f15fe0c7db3820a1af7c4a3f2c9928229fd9919cefa684399aed773b160104b6e2f1a558ba62e15af63997f41d8c35d07eedfe4c87666e2f7a903d3c981d51be7d3bfffa893027622da80a4208e2b73b7a922dbd165cf5d761ce261722e007b2d40330104749482e42cc9d0b1f872ee0da0a67c70d51ce107e53b19bd5fcc578ee40854be871fe4c783c9405cbead64e80354f37dde7830a7ef185c2d63538bb6eeb35f781cb4f1a0aad391b16ec75f4b47c401c4b3b181d39835d351b2b94809d5be1e84a4828d5774d2f2fb0bd00d5722f301ca4e8012db403707a9a70a78753fceb548772a453efcda5f7701057574161d1b42cb0c3970c671775e14ed346447098a958c5c1fd3b22f77b63f36f8ecdef9e6becb11a2f4a9e128345a78198a4fe782a9aeca1cd33972984687a30d05ddf57b12cea7b8f6743bfe82077f673ef88bc23c96b150da327e21fc4fc7c26d56ef21248779af6a5f68e309adaebdbf0ae932397ef32af8f9ab41fb6a7086e8f40cab6359c88ee9bb703fa4b7a3a2a5de9b5a7b52e1f53e6175b8d5460861db921d5d0d178d9d44d929c3941194b5cdc9855771ddedf2ba5563dd86834118c78bea7236f8808953e7a603e5bed04e8ac54688c8baaad08b6960187b872d80c0e78bb25ba7dd1c165122114e90280892bdc662e16efa7cf4312e9b0fa2284d0be6b9acd62086ba47c558d42180d33c0f48e719dcd8dcc40af559250ee500209d72e330589b8be299ad8d12b5f07166234acc8f63975f3d411db091d228c5b0ff2e1a0fcd9cb73c780bc47dc150055b7b1415a5e22079787a5fcb2e3e5f267ef889b5a5aa75fc4686b75ee4a4c24c13ccbca847f643b3fe22a412ef13ae713038a8c4273deb2264ffb19f3fc9e959a4ebac1a8adcb7fdb738b5172efdd63f7da4bfc9d1e1d82f25f6d9d7ffd141b8c4ccbd36340e9f04a41a2c35369ce0165ab36db6bb4f639072090588b75abbee2d265d3bd52267a2e32cba1fa698f2c23b9a966be74036dacba273fa31896d6c54a00bc6f75906705aa469064663bbfa0df4f92fd69f3f4678259c034fa6a372658686cc44cd0744d26eb55be1d8b114c9b51a2781d246b083b6205c532baa2810bab0714d49ee692889c5ea113189e75f8a349d0bb89f3d0f2a12e71f9410a216890153903a397eb2ad6f26e6e1f3684c17e585921fbe224a653cb5f111b390f60df541649977256ae4de9f5f2cea490a723f7b4cd963dd42a154ade361928180cfb849e3bf766fc1ed2fd142a8abfd22fa1934493077e97596f41879a7f97c4eb2a72e9b2d8272dd6ae8a13b5163a0f0601a73b97394093b178f83d67f149ca46476325f9513b8fced889a7850b8ac1fdd54a85213bb64728250cd9ed81feefb36a6f3cfcc4b573b40890fc9bc4496c8384ed9d406808dbe1d3743f6d4ec87d4daf05676a01841698bb9f7934db9b072997808eaf443ca0a3b552c9ac2e470da5b795bbb09139adcb3f743aab22c067e0fd014963c15336651cbb8b361ae500af48380b8ce7033d0ec12c1b1559286b9f86c0647fcfcd0b3dec22cdba8ac7b2b9627eb7ef8131a0b1c8af9f6c1e0c2927d869d23e2f10f2d6cd3304cc25eb7b2e885cb94fc2c9557401bd832c72d4d840886abada7eb979c8f6e85ba256535b7d25eccd03496f1770fbc25e11dd4814b25e8c83394ca93e0aa2f7833fafb60c908683250b5f2a5ac4f09182008ec1c4c86fc385ada40af81b090f0e70c256635d7886d48ff680bd3b7ac0e874c1338a93cf5a1667a64bae47907f84ae715a76aa196f38aec6d4725be073b052a740364cac7fb1629b56b2cdec30fb4e4ee32a65c8b52c517cb6a66f5f58855b55f4f7883d0eb2f05579890ea5d8f262aa64b1801de366381aab266dad2d36143f1072c61b762fa1164c7d184ed092ad20e8502037e0e9a56cc21d0ee5a8ec40ce65ef5793493abcf0d76757262a7f5a42453185efe696265c15fef5baaca0fb1df4a89c0fab74bf04c6a331b41f1f23288d84445181dcb66bf42714a46a4223fd055ff7fc10adc1de55881d3f5e7c7d4eb49962f4d0d025e9dcd7a2ce08f047a57b78eb8823e8f473cb5d6f510736538967d96680b5471f715e03b17c0cb059d1cf43a3bc79a0374b4afd9fd97d4eaf2f8066117b4a3433df3cd377a05e7b1ab3fb5264882071ef35203ee243099242d0b787c7f9f5963b4e86fba70732958e546a5002205865fca4532d8e3b20b05b007a8090f4a2fb9401699c49ac791ad7a068556303e9a28e57332a3de0a607868f4b2300d20241dde3e72a5ac58cf2b1201f7b43b7d948553240a9ec572449f2ecb9212a474f78ada6e073f2dac8445060607cf685abdf44e6b4177c14968f42c5c0d6dd79ee864449d9a468d7544197764692bf7042a4453acc71ac6adf7c46694838c4d7779659f52b118c72541ff7de97de6cff69ff8571d944b83cb19647ee01b4a00b9ea5f53bf107f447078d09673e389080aabadb1cc2f82fbaa4cead01316a30ea907b30a6ebaa7cadd58e3fb6ff383adf80fa43e5ab82fc1419b41253182e3d3fdff944d352545f7461f0f9aeb8bd24605978593b084369c13f5dc8c8216327b90ef6298a0ebe57a43d681f682ce2c1d6526e93767b974350cd131c78060a9df25fbd8ffc89fa7728dc9f4851289882aa93b1dc5d0079adfa3eee7cabf5c840307926f26792656a80a062b31bc65b9299fc157b879bdb468440e755480f511d4e6c5a4e1f7e2b304a2976b2f83bda16fb5ee2e9f9c396b4bb0c13bfa4ff3fc762d9cfa5a9d673335a5421782539f771d99878357c6c37f749610d1fadde1a7970eeae704164c64e9729ba71ad163ed57a78aed55b0d446c98d9b97f63dbac420312fcc47caa8cbbc4b961b614f31fbe20a4617fc47325362f1945825e87e9356b7e52e2017a80770aadf9f711981828321df166b01f0f9ce0ef54bb899c3c6e89c583ea7dd89866047971b85eff94815b614a1922c315d35f2fa5c03a29d8a5c769c5c8eda111f5bd9b0234dacf2c442384ca6cbf35251c1caf901c9a4fc6c55c4126bbbab1d74c574ab69ced1ee8ce44f5bf70b8def32c86ca4c0d4cebf57bfb26eb636f82bfc974819bc3d922ea60c4e05689aac015378fad0b9bd6108d91504b025da74e9aa5bbc36225822d92e6c353b214274387e252e4985538297e14bc9cadfa2ed9bad8148409a2c3e54f26a9921de80c1dd3b2040f59d6b5489e78b1e21296b3b892897e7361f9872488444c224d9ac3e36aa134e2e8aa05300c73eabd745524bb2c99495eee4300b6e7f655c2a861d616f4c02df6df5600c54cf8c87fbd179500805b1bc823ad0aa20ba65b2dc1a9b618b9ac9d316e243609d111a2317e46e243847bb706f219a634137a14d264deb925144cf77f50a45b8304112dfb509d1ed7aba77c796630c884669b840d7ba60a5073f4536e29e2070216dc7d29c0f3202bec5276ebf86b9a11c6e3210d897618121562ecddbbc4065998b0f7db169fb8fc4ed69d8e21ee8e35020b5f581815121ea36546aea63f35ff08d788d655a83407fb3bc046835294c9a179fbbbac89e869695ce345631d9fd7b082863bb7d0a17572c28e17aa381c58ce9b06a08e5571bc6401b9d0d61cd9c7d747e6d35093aa7a485800775d2d21f1cc0b552bcefe0f525036499a5867271d9790955a48dad42827941bde826b7e3a91c2c27328b4bde204c881c1e16369c051c77657caa8365b5b402a431de6b9342b9c5cf355fdadbfdeab789d631a62ae34f5bc29d1f7bce4fc2366c458498b416bfc002160344617a8a5a2281978f39e09842b6a0e0c64c52cc424f627a14723004cfe027c95c84ff0d6d65d439ea0e758147dea2f837c510064c884e869754b29f0035f9623c0ef80f9586249687902114f1a065f2a57f754992e8335f02968203cae8ce0644645c10f6827a9a8a2c757f62905f3a353f84f6e421d8b7711e8097bf2df3e97f115add19d7ba82ac355d66e31bfa1ef803afb37a67d22546b10012def11150e4ccb7b8bb9d3f584a8bc152789153b50e02c12d6c2dd1a4492fe9953741268ef77f3f5150d3ce832ae9db03faf992fb1b2484e145764d95370c3b7e8853a5a9e1cd1885265bb690442dd342f0dd916ec153fe975e2c0d78d5ef7621e8ad85394e67c4281859317bbd2888af1212cf52368075287ee2160ba47d21e7ac80c70b4d5956d03d63b6853c965cda0546c19e9b623bb48cd90b78e6dc05f605b611185802a061ac1f3b586d9bd18e830518b23309d84e9fa9e1bfb469c20de67915a74dd629dd184b38169b8d103b5af47351b40f19b627c66fbd5fdaa02c4dbb3295f9989b7b36d5edd328848ad10b335f606a19f883c70c01185a75a6c634224be068da8001294a4c08fd2153444406d45f4edccc7b48a20062e1550001115e5686ee425356d221365b419ea7a2e11bc5669acb0bb81a5a495c70ccec2ecdf875f4ecb68701bc5f24f01d4668e508d62548893d9d1cdbd49fad0d5b30e64fd7492f5f2d2bcee9ff609d1e891fae34fbab160b9d16f449b5a199626c960e59b13e8177e3ebe0d793b1acbc7fb0a41ec082abf977e2b4454954a39a0411cb44be8bf3c65387c84723b3c7d8e299ed23fb1921c30ed23593ca72cbc9063f86e03e900c903d0c809d6a15dcf807164679141c201c2d36423351d6d08e421fb094074880ece512d62ec51cff39e50809f156949c2bfb62f1df28715455ead33cea4f20d9efc1369ba5a715f1bb6246cdfb957c3132432738b8387ce672dde5e19e6c33377a0ce43374ada2412ef484e98973befef86aa796133f321b3a43cbb28075e36377e7c076570c3810e4c45dbabd2c95bb98b908c5673b6510340ef5a109854b14c20a194bcb621421e8d9c9fcd545785da731decdeb6316d44fb0bb24920aae09a3f8529c76670f5e64263014c7099ac48ef3c301c4485e2d88b999e1dc8e954d5152cf24d6f1ae68a8811af3f74a3116368fdd79ad38b4d9c6a87c4e9db9801d306bf4f871cb423d0caa6f3672efec2e179c6b62e4ee680a51d1cfc6121fb8f9b621d49c5fd5cb127140d3c2abbe84ed0c7cefe1efb58a1793b7472d48d5926065ffe5487fcf5314123bf8d8013e9f596961a0e742603c4eadb7b5dec974ae30efe758e01999a0b728344554bf21d3f50009690d81f918fcec1f944fda73e38a07a22468c0f51177cb8b6383cd8b553356031c617c041abbaa025f40dcc9eb691cabc6fa3c2b775160561cc1a31a9305e6e259c4c51c0fb1bbe47c29c062785d8f845e98917a6b9a39b948ca4bdf4e1e0f97a82f87e9bc9e50860b4e64941a28c7a051b3cbf7bd3b7873a190a897fe3822dace4629c0f191b209018e212091eba5f99cfd92db7251e9a7e8e5919bae07ff4ddd30053d7ae1e5bfb40d2bd41a1b0dc0b657d121fd3367f32b5578b19a743814a9762ddda9715c571775ceb1e69be2f65a59786adda03b1184d7bde4415f5cb81e1f5baa6d29f109662382461d51b16032aa3866c929e52999cb7f49a208480698e703ec00c406a369c65cc6de2acc97c23f8aaf17dc4b0c8c15d3a86feb71aca35710430067af342c68f60f6590a15aab41ca1ddf1dfc8472ab86d7a07248dd58425d6240c3403ef095f41a337f98616dbf012fb5de451b66730ba086c76e70010fa0819d5e202d9e94dc7547b795509f86116065b19ad302a15f096cacedab4ad13e2170ecd702795d369b50f649192d6ffe2a52ac4bf28485a0815769a22786ad0d774c8f4335afddaeb12a5f3fd8a112fcb689b46cdcc1532322cae06f3d34c4fe17dd87a5d61ba72fd64e875f77b7f406c5fd03f07ed0bdfcf0f2f03eec972c638bc9052ef48168e6a6da6c2ea6e74a79a6ca6ac1c64a6fa8d96241893444edb1e8d50858281c3b3b1c7e158ef84f62ed0c02e6dae84f7e1ef2d1aee7fdca4c53de7478acf12a6421d9ca1290aeda50eef90bfdc389d85256dd95514a26c7d8c6161da8c5e4c0baa967e89e0920df8337a1f4bf90478bb328fa1d2b6d3f8c9137ac5e833ab881aa4a51d69e4d3dd408747fd9eece77f9b4fcca333bb69d2b466729c6caad85227db3b084b868ab9f7261c5667294ab0fe7e3fba1a43cbd59e2eb0f564135b786603b9e19816a83049e06e0cc870718e625a41167abf677425c283211ea7faee3d62683c05340b3d7795c1db27285a07528b887aa3ad10caf729d6e310bc4bc6b32846101aae507b249324d09fe858b01bd5e8a9da42227954a3761a94c1c4198e11fc02848602e04d562e1f9744a8650d7ad0ce9ef7060879caa3dfc209ca7f87435c3db063e74f73c63a6f64e9a787125fe9bbcd72839ff1cf4ef873e219af61782258d41b9268b9cd439956c168498b99be50919952d6a046a1fda022dad9ae1b2c8d08691273fab0be8d4e57e45e373dfa017cd87dfe029b36eadbfb15950c8e96606652f32fea6d4ef5d6db79759e679f286440174f13b13a3e8e55470de99ac0455803e4e59edd15b1225c1a51fa271d09dd9f45eba7be51a980ca2d5931b7c3682b94bd245198b915f0f28fd79ec1ce184833babe14803c99e1fe1bf3b553c99a0d3db902a17457155278cb2a2663d711dfb41ed47890ae7615ecc6a3b985f2e867438c303a961a0b3b07df75677652cf8771f649d28bb9b816feefa1fb3df8af9f72ff60b85244ddb0a7283e39ae8c26e3a795ce2f47f1457daed6b9ee379f62d8971a4eae2766f2e0c265ade6a17f1f46a7681850737913b9262bd84bd77c0c4a57f27f090272c50c3a5c9d381f425110afcbe7db87309d72e0173da31732f8d59a870639a8413e28e007b08a7db299061aaa56cae91baeeeec6671c9544aaf07bdd7e04af934150350b88a7e6c0d4170dbc9136be52c946ff0e5d8592d908cd324dd42f5e8edaa85feef20ed7f1534a71034d7929576d138f89ffaa69bd8469cbead4ff91c15c5fee82956649a2496ddef559966c6accdd539c1f42f87913bb46266d72b94460fb13be82ca17a844a3a830448ca57370df782cf61e69d677640eb4497cceb6d6356a732c0e050c6234cc10c57599d1d9c4ca0d610d3e398354121c21d1e484f9fce3152afd44ffb3258a319901c4332cee2d433d50c99b83ea75f2c1066ba053821e91d040043a802de17d18db258021bd6ae74e40086427d31948f1fe5c3d2aee4d824ad032165da054fc790144f6fdfe7041a526dd996fedd1cfe33ff3e9bda263b3269b7dbcb0f5574f02a6d65517efab792bc2180614ce69d23f7c6e99b27bf07b4fc4ab39fd30cbb334b04ada8210cec4f94c3a913b6b02797532fedaa34268424c2e66ab0f13b34de30438cd6b5bf227984e1818a0d334a1f35b1de4e047d29cbfebf01f4e00e6a5fa49b3d66db8c57bb63b99007810b6168e4fc9ceba5f0f262c9272a494871980e98b0fd5cb385491b767d224035709d9c35bafc54dfd61abaa444c24a419d89d2517f558409a2e882b5e3e99d836e2388576f76f2215141cb8ae4d6f9b5d1ee85bed4b0fbe58d049a0e1b5df711deb4f92e4ec621d3a1d44101f1f47b95558a26898efceaa96fe03bf3966ad9d54fe99a49764c627d859e1d7d3a33e0264a65559ede9d3cc18328bb4095aca6a665324184dabf379454f045cd5fc086488c2d9f1d1dcf3b2a7785481f58b2901a550c2533e8b94015de365682ecf92e59fbf4d1a3f5126b77b0a3cf1b373431ffcc41d0e7256177bab3d1ad60f6299e7fb9ed27d1def62e1689d92e589d5a014abe6c76b4642cde3e27e1e088e9e5f6cad561ea9c30db64d1a691f93e555bc3b6ba8fc0d06971d88b4b96242833b8aad551073e18ad971a683281ebd69e09616e45f39ab21af3caa4d0b5d2aefc6c9aacc80171d20697439fd5a767c37cba55ef45dd8d4dabce4a237b020710e9e781e1aa74997d4c0b1276c6d81904b2232f54578f868bd2aa82462fd4593bfac9697de22eb2b813d6860733f93ab38ae5a1cead4df15b251a9d3109f90b59489b2b0120d12f8e68b87af626b2ddaab12379c58d06ed15a0ea9287e8f4d2a85b7d57ddaf6f9836488e1a9a712c3931ae3f1f60eeec91f8d44776e97fe4f84f97743b799e8a6adda925206fd7682b0643d699352b73a3f0855e211fe2e6a560b0be5fa158b00863cbe0905c41c70b585a547d4a22225f7faf6b5fd77d8ace394358bebf70f44b8a06a209b4b2495275e539f5353801add04fd025e10cb859a8e4b9bcc16d403c29c76f1f444758ab447d326946a1c4828043354534e05c3aa283fe475ccd643f01d6e5d3ac35cb3e5cca34bcd7e6e346863ba4c926a6c7f3079f5950796adefccef4da4d45db1b8f402e12dfd54bde9b49196ae396ce7189464fa28b87d4307c3f5deedcf402f4f1eea2e8016408ec4852d1d5d0e08e6d34d2d47332b027d913733b89a142108206b8142b2c8de867eb6eaee7fbb3dffa939d71fd99b94a27462ea7229e6d6e9072d4c4d5b5f275db7cb997efcb578e77e45278150b08867a9a81deac50f8e449af27c4b3293a6e15491cf863b1c0e1d67ccfa76ea05539ad28e362e4931f65567fa1a5ae13856afa64b54fdef5ad0557d5939df0fdd959490d8bc7e8e0d3f7066eca22fcd59bfa40555d2162c611415ac55d1d21a4fea117719dc661959103f0883bca3f3f76ba3c075217a54d85226a3e1199e136a64a612d2b446407d101ad5f088c896a5ee63a4f462cd769b721901b162f0acc8a7e969bde1fef18f10b9fe4c41eadea2565bddc22e89e8f095871a88cbf32cb7bf0b46c06943850e412afd07c42569953b1aa93137719c1b0f852777f63d1f9297137cde6c9855de14a646efdf9c28dbc591e98b6fbdc8658937b9f74dfc9f715debb83298f964238a1d0f2b5874d038d2e820a1f3c27d414ea81068522b0288380125c2fe611ec0e71f34c7764064f6a197e9640fe6e6d88b41ca2c68141f95cfd5b497969f73d25d460967d1a47cbdc4a1812f032d09f32274b1754fba541610f9132730fe2a3f6be9e9f50c26b8081b36d469ce0d19b6ec9894a612308e1091ac6279c996193f850422ed5b5384443a67abcb8f45bfc3ea26fc7db8fe6db1470a80316a9f27a2593f63efb201f1d24cf9c73381ff89e2b5fc856721dce6e8bd842a844b886645cf50535a03b14a297e415ba3276303843b0678390dd2d4bc9f08ae6679ad7cb2ef29f01168d7a3001043b6f1f1e085eaba83c01d834f33275b6e62aede091838b224fdc17d1b6ac85ffff0281b1baf949d9f0a600b864608cf533589e9a794ee072a48630d85dbf704d790be74a916b4b8152f3cd1fd46886833aea83838fbeea92dc4afacc6a4cbd8230485cf54948fc12524da387cf92c80f028ec0ddb7719ae145440dca43e8848540425ec0f1898a9e9c5f6db8e1bc7237bfcd0c94547e602f381a383cd2b30261de2374d2b0a4483e6b5664f1fe428bca465b45e8facbf05a229ed552ee81868b4b4f6104f8729ba68c1979b7a9d7daebb0e64162feb8244094c4b27ccfe053f28f904555fa6d6aa1b9e7fd6857af9e2212b9779f7c510ed76faa83c29dd14ee88e63b1b8b151a2533d2dbc1a0bdb39e7c21a7ff450ddc2ec7064e4f0252bc731e2c2355ba451ed8813bd36d7c6e76baaadf2e037936d5b2b7468c0762f18446035a7f3c0c2d06c711764a06d6d3c6c63163d3f6e6b65a65f45fa887e38d51c8a5530826a4cd60f20a53c3d97af5b4d5dc5f41a5cb5643a2ce8e0de231a59d4a16cda30bb20a7ccd38b151a922c2e466370ff7243540db20be978c09ddf7b225beae6c72cd3bfa762a043000784e205db7bb7a083ba778cd6af50df424e915c14d57d6119a957635356ac12bf549948a2906ebb615c786fb4c48d3899d857df01732f3860068527db6da002147c5170411c7bcbc7c465db9639d4841594d8b5840c66fa69dce3b43c46cd4dfee63d87174c33e63c1d1498da400bea2847af50505663eee0d9e26da554c6b6724d86a090b29cdbad31f3e0afad962b12ad990aa137dd8d9a313eb22388376e480fd02d8b09239b2634bebc6d2f307875fbb1442e5a5eae25b01382cdcfa4b68daf19008cda002908986b673649ea7ef00f82dffdd52350f3382bc2511a0d37c136628cbd828cd4977c28d4f5dcccbfc0b302a60831a617749084c96a4e16fc519fc9046b6de89296f13a940a4c8ccab858831ceb2ae8eb69ab113a8f7821d78af7125fb39445308dbab8b5fb931bfab928217b25c6b1cdc844e0b7ff1eec4688e42cabbfe47a635625db294961394e6f4f5dca4b127ef440b3e3ff92de2b6e10b3115b63518618243470a476b15fe6a2792bfe1891799e5a0f2b0507029f05167a7691bbc1f2e93fbe1e889cb58b5aa168da714e471da4d348868d0b73bf19bab4f9ad8b2550f3724cc9b471407d40c12f6cc02b7964b1089cad0fd7ffdda4ea398bb38325a760f6980e81b074e4dba0440d21265c226a6290056d97523dddf23efbd3584d7b7508c1e2b3f93554e1bbd048b2841c29a5c34b8967a73963cdc7a3c66e0718b0ab46b3b265ce893db4236bf0e5f33d0e951ec3ccae2fd76028e59332d56db811e08227803121ed6722d265b293be8a881d22c40b45c69e7057197af98d3db3b1f9d2cb07209605b1b187fad322cbd5bde6e68fcab877ddb0ea8689d5ea5596b750c13adc02a116727706110e8e50be13129b575c9644ee212ec9ecc48a08777508c2a54c79201b68aa278e5232ee44ba008f114866d050585ecdea2de95694a0a71d43e14a1f6634bbdec02fa3b5de79f4bf508ed36e8e52f59c7099ea9516196e2170c807dd1c3a170d26bfe2cee9143955d2487a22bec39aea0e4b33220520e35c97562c73d1d4f943e3be9880a5b30546036bcb7eea3be625480cb7355629b9c343747c667c0c22a762a653f0072499bfc8c49e788cf442439099c50e3dad0a532500871f9b09b81fe4ab471ded8be0464016db8f2fc7d80e61e55b48cbddc7f2021a2fbd771d5d0dd08a13e1665aa5da0afaaed67ac943f34e88152935f72c2f3f345b36fe5d4419e9654f8d0c9c44fb60355c4f3af87e3494440d111ceff0750d7e67fa4be5ff778844e7751736ec9ec31dfa79d7fec6bb9734b3cd9c5cd4d32ff9a72a27b910ad014081d617c6c843a5b73b88b2f5e65df73afca2f9cfe8f430bdd1807272ac9044536afd29369dfdc5e029a4c1c19e01aadc0616095e3ae117bf72d7dded8788c9b0653073280798eff597263fad6c738adf61a5a932638acd47d75fb69f7af61dd3ce178c78906d0113f85668510a1d251cda09123cd5082300ef04109cb78ec64cc21d1e9a1905d37436fd9cfef37ccaedb647b0edaad746f58a2c226b2ffb732210b0e228c0cd08a8b86d906b2d3a7106585b478d2621d59012634e6631485416ba928580fce590b76d085951e42c66e7f38214cdfd67b963c29500bcd9753a4761b5ede8744c540590ffa444486d74094973802b5bb69d67061a26cac8410d8f889e169f4cc1fa226f5d350599d97fcb6063b36ac1e5311fe9e6bdbbf83f72f6b08696f3d0a6d7d9396b2c8a6db8df028c7a1f4ba6080db59f4ec8dfd807a84195d1b4acd80b4870f13bd69fde708ac84733633d6c90889a352337d775ee36c8db36737dffd1fb6f610d1392e8d6c867e0e519646d18b4a1a1f4e64eec8b8f809f8cee611694e0a612b9d68c9a22dde80994fffd062fcb777f5e36e844a7b57613b5c4f38dab5cb3b292ef341025044ca13c558fb1d696959966a362d6c8502a4d5c30b3b765c686f383b4f4a1160048d2c0e37f1b0e7b3a35ea8a1f267a6210bfd6569e9d8b6b49777a23ab51524d9412de873c2e349d51768b56125549c17bbaa8d4de01e24da8d0e1242053d577acf4fa14e60fcca6d7ecdb74964e206d75304573ad9347d3add4cbfecc298c89abf44283d04a73876fd2bfffdf10594fac18742ad1682b81987f240dacb7af46bd84ed6363122cf15aac77ed678ae61182843df0fe04ae959368bd4188f0164939f081f754370e9469d719f4ff202c014d7938ddf6767e8d3f60bafda987e6be4f74545b5f9c3861ce140f2120bc93e0da00f82bc7ac239d5893633a7231ecc53248b997480718a3f60a18e95b0cc1b437f726b4d4fae8f36409bac573fe25cb291fd644261cf22c3b22ac9df1dc2eb8088dae0cf448b33e96f8dadd2e71d6b41e87bdadda5351a71acef987ee118d3c8447e18bae029806aacf8ea59d17879399bab68c951b41b69382b8f7248edf805735ce58dd7ba04d62be4c0a147377c71d7b5fa13fb4ee415ed9556d6daf052b4f1f31265aaadf2ec7c311c4c11badd05f547a4e2f08259c919f830f21f1b74032ffc874b986d7fad31219464c2377b5d9f330ef1f1be1aef3d476ce9138b2141f1008ef488707bd95e1547da53650c07ac310599573bf80585c47467727bae29abef4554b042bb402efb0758181a6cea92e377dabe57e61206c0db67f4f725cc11c65b019476b8aa04ee93458044436d1ada4973e057a6b889c8bef788a5c6f8f6e1d26f8b5055f7dc89f2b00887453893bf29da2d6203baa780e417c0a540dad25c7d5c200ca123a95ec97667f6d69badb20bd578e9808c097f51c5b69acaa9cd1d8e52fa488c36aec2544a823b24212291817f6010488ee903d09b28e7fcec501129dc97ae5be6117feeeb49300604da766923a920ea6947c3882988dccb2bd894346369d8099d4a07e8ea53c5090f1d3f4ef3a5da7cb56e1656e8216ed19775d4c83925de6581e2e8750cca61e1a321b18d9a0d8ba705a4dfe8981193fb2d987fb80a576006d52135b839621f6947e320ca45eea02c4840ef77224a2d4ca147df273bfc9ea1c5663892cf0e8ba7894e61622fdb1c3e9182cbf36af84da8a03b5104e38bbcd13066d4fd170acd3da8ac5c4fe834ab948033d559632f6a0196306302478df5e344bf7525fac876b3e8a3e44eaee4a4545cb750bbfb267c07582d209d2f61ccb3e73ce8531f3883a13e140f47ef099de8953f9c481c2bfb33f2ab726003e620211cfc23b0644fef5befafc4bc8f7639b978c68b0cf9ba4a344b1419d49771c5187ed7e3e7b10d40fdf9ccbac460bb931fa3c7cbbbc9f88c5898a4cd94eafc96de78e603445d30917ce11a000be7231444cfbfe4af0c6b394e5c74d08ed23706e35c282ae53f228c7e97fbe5a58c3b2725ed2803a5ff04003a095f7e3601504fa2ac115c84a9e86e5de0cb6d18c306b204c331c062365377964d0ef5dfc68d1b3b1c6fd065719ea63fd8d08f49fea8f195b648e4291ea2ae8a20f957c5ded28f3d4c06887b18c764e7cec9fb91cdb9f2ffafd2355c1d692928995ab3857fd2e8ff51a20b7f92a0054b25d89b02d684761e6c2a7d850064d9a6ca129bcd41bac136c91d8cfc520ce847879b3cba7ca57643241e64ccbe1aa2acacbc44a57ed108c8423bc19a18469cfaf7a2c0f731e2d25ae472daa13bc3c8524c56d697c173245c1d89d5f78a54693d551d8e7bc81fe8f6f7e5a31d80ff76bf583283b42525993b4d938bc1410f0e7eeef1a5a28a5360de52bc7a387966e0a653d971ae66bfa3f57ddc4369bd3f952c2fc494d70450401eaabb02f79375cb3cf1ed7d7d804bcaaedc6ab44429a5eff5e61cbfc15273779411fbb551168662d96143059500865bec08b00cde192a539b4b4a79f4daffd3085105b0858aefaa4032db2251ef8487e325c8c487147a4b6f737bf57926203f5f2bd59d0d48ae06b31d41e56eed9e1931f1ca94f0e5c74102f83c1d64cc9499d0fed31992171ccab35d33393dc7f926816de6ebe565c0513c09b9f46d0db71f6e863738456fe3fc6bdb66f940d0b350fde039801cec6bb0e607dc8dd8f27e51f8e347821b842d1c0263e764cde90b4497e99dc81384d726233a41b91705d64838d30be0732c7f98451bd45560650e472b15178816ad997d6b09215bf6f653e8d1f3a19825fe8d50c53694225e7173a1cc9e0d1f73f6bf453362eaf6804d933eee5f8d85cca942cc6cfd068d3e317ee9e07cea4e9d71ed7eaf8746e64fdb08edacad2dbb2eaff79b24e5cedd27116a15babc4a261fff8665689b1c5109615d2a58f7368351628cf06180dfea31f009ac321356c79c035b2d21d5a17389f875e09f7de7eec78c70eb733ea68e34e054d4622a74e9fc3c9397ca40a13bf02180720acf0ccb4ada9b34ca3ec3ad19c37d7ddf79ff7aef876e393484b3e9478c574e2bd6259da0667753c172b1c19dccefd2d8423e4abd9f71ea53f41b5b1b9bc725a6e38e8ae05f6404638c2d90d55cf41ebf033dcf8a10f4494de2fc3b8b9a0da46c5480e4b274a4b760fef4a58b21f94fddcd8ebcaf0c3fbc42fb9f323d4ed6134b57554221ee9840e6954fc210fe861e02ffdd24c2b1ea21c4b883ab1a2dc81ab6de3f6c3439ca834d80f64fed058173c9b2ec7ee312273056cd0ca6782b4ef3c889aea44ae2444d18c83cecac8628f32e00efbf2190089fefb3b34adab7ab7b458ad40db899e5228c6e2b7eb2d48700549a92364d2de476a76cb9b72e2d8328e6a997c541dfe0bea82583faede0756dee665d5f82b93a19e6589436663934d1efd76452fc6a6b9e3e0598a3b668ff4aacc9503566db87400aa7ba3e55c47636e5fa5c37859168e2d4a159b31b7e7ad99b4d8175b416d5956282e20b08686e7e79409202497aac44392e6cde8bbad0855ca63c004df38039a179328a2b40094b2abee9b09e5a39ac459a52f0c143f1859f08248a652812a617fbc7b305403eae5a2922aeab9e204853e57c33da296c21fdcc250cd52651ca87cc74cc65f96d99192d8bb966eb60521597251ed74f9f47453a074f6ebc9c53e90dd3388394a832e71b97878c102185118dbfa89922158a66da9d3278627fc843395d612103670c060981ae33cb4aed090831d6cc3cf97215b1a18c16f55fe64abfa8f5c29b71dce6bf90a47207a6db237a91b7e99186984f265700ef0ded3a45851bbe6b10b3aaa669faac3d77efd05198c61db78b7386dc1f8a22b6e0011220beecd2db10a20c9f9d13da79eaa9e3e4d35a6ec4a304a91fefb9ce779b36b95f24322e8a8086f38264c587d5d734d7eedf5d84827921bcccffe8d4ad7397cef17a28f68645f46e6a154cafe85ce9eb42c7a932e405e7e04026e95951035f65bb9d0a478ea3f2ef2c32085fb5b2ef131ecc5c2a792ea5da92be18f65e47bea7a2250988802f787f24dff3e2f1e39b6458a3fab5c910c61dabfbdc0025518e7ffe73ae40dab216108930692b534be59a7a00873bea050c56d3c2f2398f17ba17ff85759064b917bab663f88d19e0ade3489182ab815d0d507d2de7c0a3618f3ceae37e080630415ef156e34102064e38f0f5bacb86495520557e230a79594267ccbc5ef7b0bd345b4a5859fc378e9cf8366c3f3020c4e25cd92df05af9bc1b2feaa94535370cb619014179e3afd34f5eb6db84e54b5ef781cd456979129ddb2a7b28548e1f591f8296696b220a76e5032529c480f41759c3a610d74287aab0dd070522125ac91589097c7276cc345093ae7b2d5337130f5e38b0bf3c8fd87025a9a7e45de2a80ef40d15de0ff24cf8693cfe1830e14b8c995dfecbfabd3f6b05c9fe7fcd35b808a13f49e8403b252df6fa14d26d56674bf088a9e5e0473c36101a5b6eaa9356bba22d4c070cd5de99e7f3ea482d545dff67a248d86d714f583778231d6ad160ba99b149fac9cdc86f2f4e9d101999c4ea6de99458331ad7ffa2a1a0cf3c6126ac4c919c995af3e2fe005a7e89770cf4a70b8a61e05a601cda6940f4259180e1693e3e578d9e5f42f9099e5ca2c988833b1ca6715664c175db1ef713f4991c915d9c53a0093934a2924c45a2b49c4837f61b8ded66f906a1c4db46fa19313e150cfa235a040338e27a1ef573ab9709fe5d9d505b1a9f1ffa023f91144fff0330a24a62048183f823b3df4abb28def14877755874202f0a82881cdeff4855bcb017b9135782e14717883c4873fdefa66a9773d1a909e09ace600571e1de78bad07b8722d88035bc2275b15a4d1657acb9d4c2b6ee0818f8684a8aa3567fba617edd1495cbd4118b6c679cd9965476c328e844f318a588a622d1eccfb8915e5bebe965c50f942da5f0933872df42ae4e9e54abf6faffefe77b64eae91cbf4c32a52994d8924d2c5a942709f3fbeeedb755ff67ae68f9d78e761121500f76d17959328b273160a9a7eb71a6173de9c2f28b2021e767260431ee207a240b4e1f2ea6ea2e7bf369ae18c914c98e2267290399b25961ebf74eb3bc92ba74307e64dc2d67dde812dc333c47be10d8a4afda575df759471a0083f6f14727e7294dd39f66b1747db7869c9423ed85860a4f907ea3f12abaf2fd0e5dab922a8d027d47e4ca4fdf731b5f0a9fd142514ccc8c7507ceeedda1c8b20cef69991a5be3b048bbd5a29abcc94b692540894351fb8247c08a9fc74a87075f327f8419ef9a1228924534571f90d96ac8e06b71f1626acc0b6f98b3f19ddba1f63d0688e61b70b84d39895a6f49d3e884533cf92979944558b42c8e05d26aeaff2c3b4a1fc507c979ce9b2a5f8e28d5338e30616a677d26b836f77e1ee633ce7aaf761e013cdb97fc7c495c2e972fda70ac78617d55a4fdbe4c3872d7824c59af18bdcbf1485a94255c55f2df45819c039a691c4c6816a0bff62c0dcb6e64ab89b48f1bbd309b75b41a665c1d9d129f6ea3ba9b9cee9dc164fcc0592241180cf02928e6b0cfa7196078ca2f115eddc73c0a3523baf5bcca5c1ece819733813de466e1a2ba4ec5ac8c016d5184d900eb798951ff6d8ac2baed3fde763a0be7fab41679a3c91ca3dab2f8a69214614b85513e1908e69c5705d7b275f12691c8c5bc7767197ad864e5f350ad9368e80d9b2558c47dbe0b0553bfa5eb9ad2bf357d4c4276a66ea1b4f0f90f895b77cfb80cdb8f5bbd5b153f43a915b3b161aa2361f466bd55d75631fe57e52eb9c7868f341bf449e052fa49900cb73523f7b4a983f768a2b098132a16f691a58f31bb510ff7403d2acc93f179bd4b15a86c69556214c9bbe8bc461f9ae6f2020a5a89754327ab8f9c10f0c720f1ee40aff178d3eaae4c86c87e1842e9d2725d03ca41cc9ba18d82af9630d04a32c1e1a31fb92575cd11594c91c8bd7aadff5a9e3b08fa44214ad44881bd65e55c454c2ea3e20f219b491131378afd68b9301406ee6d9bcf0c229edaee5fd28844ed42004fb84aa4343260e9f4a05eaa8bf8ef28804185c6c894ec6bc8a4c5c25547f3f7eaa72d56fd8b08cae6843b606401021c6e09d1e1cc52f86bef1f16db266932f841d15d3868a0bb9f2b26143e60b50a2b2c9b44ee4b382cc829ddc5eb3e43714ee4ac94d57e2eda35dcd58b0af041ea2307bdcef190f5914c1600ca1ee762d299a9ad9bce90280e74aa77d48f2cfd96ab5b337370414a188fd618a1ab3a82d24474b97f849a99478d289b0d8ebb074b16b1bb1d8e5de4622785249acce71d2a1e2e880fec0fb82f0ab76d3da76da8682e1f4d9a23d482ddb114d2752ca52a1485c52499569b73edc0323b65108100da043b6a94bfd41d60ad8def2dce8af4458d317106af1e8e77aceade2ed94512c107bc6a5bfc068be99f08d65907c06f4207c61c81ee18d58023208fba2b8cafbbd92f92f9f0f5e1ebbde18595208235f433b7f24b86b60dc68bccc3b222d1b86cf14f2400000407675490e8d18bcf24c9c5434e06295ceb37cf34282b3a3140b5e1edfa9cd55db05649f0cf0d1fb4f64110fdccad2cdf7dd921f63abbcaf3f75e9668a74eb8e759ee9d35ed73a59bc14dbe67b8bb8b3d518bb06625e9bdaa0874589f765947b52be1561b320f5a0b4cc684382a6b9af8ea7dbc52641e757b6b8ac519cf7e8951104861efba87bae4ca0f8271f2a68357c2d9bfbfa9189c432dafff70d26af27e265576aff662239657a331b3b85ec245787ca49d3b156069f6deea2f574c4444d2aceb4db9a54074c08aacf36adce671a4c4e289c7dfa3f0ee36cdb4f5921c6171be6f0434313302d0c850da9cea74df9140df20d3107120139358a9ec7dc43e90274c8fd5aa203192830e37d1fd48d7a3b624a4d59730ad497971a143ded87e25f6f643d5d4a4906a7b62814a9e3086d317058519bf69e5bd0ff554b3c8c6f2b22e94784051e64767abd94d6c030da73639e6f53f15012bbae46b4ea4372a27b7857ba27e6575d077b117e1107e2e0ee294238684154221258e933dccf7bf6b793669b62408166358bf62db1e1284f4820bf61bdf9623c35662fe7b884d413177f178408e4b518a292b243c3517ffff2d202818dca385db72d81916f283fe25ea72bbed145f88bb6d9c33dc25f05bfb9d3cf943e4329f6c7e811e5d97a039dc14d8087eb9553eb9aea677fb266cf79fa735d859528dd6d491a4749ad6bb01603d328efa16a206fe3c86ee558e551f571b77378c1aa1b4ab3cc257b6f04c384883d5514d7b743cc33d88a9609379783a54d357f6438cfe152b9bc6f2111d299a29849e0f410a81d54fabc820eb5f6d4102017eda22f4c5ed275023e6364fca63cd138580104d506385a5b7622254300dae562b4dd6f932b01b4067e1c5a94289830edf8e30e5a02879472af758db7a84bbd8566628f347ffa6cc5cde326ed12469b0d1fcf51efb8fc667ee89842732dad5c7e5a84d9bcd0896c7bc8ce06b4d3729a3e2b2896a054f6c6f9c6dce66f8d4c8bb87424c0c0942f2dc2d61e647245166511dc9642d70930645f503894bb7988301d9cc0bb8711e6afd538f6d2df24dab8ad0d4e3f0306fe37e55d301abe857f18d321e333329a3161dd20d428fe84bf641b476ae91cc950c53e0a6861278dee8e7e1b3ffcf7cc25571aa37ce5cd6254cb20c5b8f1a599471dbfabcae4d40e0bdeb0d7e3045f78b5e81cd17d63754750f392a8149e57e4f38809a5f7293fa8ed3e849765af8086025fcf48838dab78e8e5521c15d7c59ac8ad8abe9d7f8ac56ad7fa0f7c5728be30b049615f7269d662557518e61e85ee580b735d7efbc2576ccafba1e3f3aaa920f661b5c6472eee1190602e81031b2bfe708b3a0e9720d00c23e150711280ded2557a6b3bd490d91fc7ee8964d815c04c3c2e6add7319459a8f7b5882ecbcbf8be2423126e8702c1b2b2e6be78c96868538d356626cfc2d7876e09f4e5ca08c691d0811be7109a68eeb544d1a358d66ba4b107675d1bb5bacd097b3dfa282b5f0705114950a6e6d56686b45ca3a900f124aab95e93083a50e3b13492109d08f700c1737c846db60956eddb89ddadd6b690a52c04fe5296adbe949a5e90de5a6495426604c5684285686ef1c48eb0276e98b0ee361ed369cf08b989d9500fab54e58aa90d44f46b3b49e0b5f5e5a23f465dd362ef337ccce4c94cffb494ed93ae422ae0e943cc44350846967fdcaa90bac04fc14d9b84505515af8e471e5b7dab7c09813b5b7b21db54466d461cb7cfbbefaadb5b1d245f72b67ab1a247dd1c89aa8318ced8880e6e922a11ee665c3c2a09419e8c39584dc412a21707addf959ded055c6bdb4eb980ca04037461f0c73e968db591d86ce70ef1e77f1f445f586ab2eb638890122980983e027b9ee9d8e84e783d9934fa24f9b695d0063cfaf35bf8b2c3211484515172f9bc13955c7300b542642676cfae81f5f093f727fde7e526336de26eb342fba25bfe27e3d7f7a3e815afaf33bf4c293f0e9e78966aefe8f82b924319ebd7ee9e656bc49c8cdfe1459a51d87a0ffe07a9d4f6ddf1b316e2d8ed04aa380e6c9eca14dfc05a0f0392276c19ff1c61a1fb0d4fda7ae3129492543c6c1dde737be9126980b923fefe62c7d811c0e86e18c7e95f0175f70c47ac49da6ec454c08c7355adda15eceb83aa42eb16b3af59efa2045f06a556cc3e8afd9b0bf21d7373da85b880d874a2329fd4ed84569356b562e47bd0d86bcab286c3edd42ff4f39a283ec2e27da9fc07e9f6c40a9c644440a3b61ee783c9dd04a2233ba3780274877a1c042ea0e0e324a104c8a3123aec125b18facecb734584b538b0bc560c5ac11fcad8367bb8ef87a589b26ddc81273f179d98d4e75a0be2f3aac293d6f504d1d6979db8f11d300c5e097f1794ef252483bfa78b182de86f3eea0f6f8b87f8930d606f8a5b2001d0f213005716da9ba75f3be8de24860e8cf58a423bd78db9e1d233d78495932c7ba5941f53e3f40096c240283a9a0f2993543bf15334949d0852faaf866c86baa763345edeb9a6bc8b1c6bcb16b6a47d9ae64c14fa4b7a61abafea8b005db83d924cf88c120de8920fa5b91b173070959cf1c9665e74bb260db9fedb05ceb6f028da81bc5458ea32b70e0234e729d5a4ff267469badbdf0ce1d59191eae8b2235a609b9ab0711738fcde04df0cca34c97d040741f3c3c0ae484d5f972cc39a7a33891556b710a4b050e18b8a6b4d2fac117184b79981f24bad47d9f9138a090759f351affa86054d5e7d099df5c849af5c3f708c9dfb58100d873cbd6e683195135be9a5eae26b1ffd501fd2251fe9e5a67c4bfc081c10cb2876150db16085509c25b188cb14ce35b0646b1353e08a4ee642467637ca93273d6ca6fd6c240d33c5e2e2709969a0b83dfa87e8f336cdb27f626fef8588449229ca174954214c8aca869bd71843f65140fe1189dcc5b8550d2fcaad56b564c8d1549be2b3eab20760d09c89ec5647f29a4c23d6978b69b73be66146dd2ae2c4815cb25af65c380c2235029985dbc286261992781ec33e61f7d142deda810144ec851ee16b45ee4790f06907b67c39b6ed98e52174fb8f01e5b430a31376a4d5c7f2a9761f49b0760bf9dc606090b40d693526df347d76c29e4ab5da6e53a2a7601dba872a7d69c3981aa729a32c453213957027f854ed054250994f3a8b2d99817c90698eea74ffff36f416c44e633e521affa4ed04057330d04b1a142a93cae1bf859f472f4aedfc24a5883f1c3ec409cec118e9b2c528acbbab8b013436d492b8ebdf2cfd158cda517e25024b02b91c025a62eabfb113a191b766cc483f9b236aacf88143f08e22d2a557b835cd3827350af3df7fdb7cfc750e7b3682494e0634052242f478b2d3b5044e72b207f9757f2f687cdbc7111561c3ed36c1dd924d2f96fd391af40ed5dd3162d3b42fccfc284c89d3cb19d96a67ce5b7e22b1091a7dcd63c28bb2411d6bab97bfa35919448b97db21dc373e2f96d7b4ee0e39c6164b3bc71bfc9cd675e90540205992dce47755bffbf80418608df7b71965ef6a23f607d0044f87cc831ea6484a4b5b30c65cdd6f4edb6d277c439d7cc766b3ceccf9b3ae7a15adced32bbefe7762d97a62e529f53db2b23cf6d9f311b5a490711e3a8db64bd40a37d9a2fac6ff31e3c16188f3e830f2eed6b7e1a7c3c78d329e2828a20b2f41ed6406da48594c302eb603649a689bc7d4fcf9a56f98e38b24a4f7b921d9670105a3dd1840e86149558d9cea3eafc5d843f625c5189738cbd896b40936f834ded4402160e994eb4db4c35a2d622c6f99ed8150ac958ef26f5722fa3e06594c560bc55153015984edd262606a959ab65bc0e14e24bcdd222241e30fea4bd8bc21dc5303fd54a870fd96e035dbaed1cacc036f0b571af412adac13fd2a5724c9b3f02d9dec565c78b8ef6fd5946a719dc70548ab25d5b51834985ce7757ed20b1873d978cbdf68ec0bb74a30f5627f059246e4ea76ed147211d6463ec0c1da3e09f33a3d80ed2459333c988cb9f2d3f36176d455da885ae1493196fae0ecbaa72aa95ad18744122c05ad69671a70d719ec3408a79a90305fee67112f87820290de3be9de1be3aea082ec7eee5ecc3063d7431d21a1538f</script></div><script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">æœ‰ä¸œè¥¿è¢«åŠ å¯†äº†, è¯·è¾“å…¥å¯†ç æŸ¥çœ‹.</summary>
    
    
    
    
    <category term="interview" scheme="https://awslzhang.top/tags/interview/"/>
    
  </entry>
  
  <entry>
    <title>Flinkå­¦ä¹ ç¬”è®°</title>
    <link href="https://awslzhang.top/2020/12/16/Flink%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <id>https://awslzhang.top/2020/12/16/Flink%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</id>
    <published>2020-12-16T12:29:56.000Z</published>
    <updated>2021-01-01T05:49:59.939Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Flink"><a href="#Flink" class="headerlink" title="Flink"></a>Flink</h1><h2 id="Flinkæ˜¯ä»€ä¹ˆ"><a href="#Flinkæ˜¯ä»€ä¹ˆ" class="headerlink" title="Flinkæ˜¯ä»€ä¹ˆ"></a>Flinkæ˜¯ä»€ä¹ˆ</h2><p>Apache Flink æ˜¯ä¸€ä¸ª<strong>æ¡†æ¶</strong>å’Œ<strong>åˆ†å¸ƒå¼å¤„ç†å¼•æ“</strong>ï¼Œç”¨äºå¯¹<strong>æ— ç•Œå’Œæœ‰ç•Œæ•°æ®æµ</strong>è¿›è¡Œ<strong>çŠ¶æ€</strong>è®¡ç®—ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œhdfsã€mapreduceã€hbaseåˆ†åˆ«æ˜¯å¯¹åº”googleçš„ä¸‰ç¯‡è®ºæ–‡æå‡ºçš„æŠ€æœ¯ï¼Œè€ŒFlinkä¹Ÿæ˜¯åŸºäºGoogleçš„dataflow modelæå‡ºçš„æŠ€æœ¯ã€‚</p><blockquote><p>æœ‰çŠ¶æ€ï¼šå¯¹è¾“å…¥è¿›è¡Œè®¡ç®—æ—¶ï¼Œè¦å’Œä¹‹å‰çš„è®¡ç®—ç»“æœå‘ç”Ÿå…³ç³»ã€‚</p><p>æ— çŠ¶æ€ï¼š<strong>å¹‚ç­‰æ€§ï¼Œæ¯æ¬¡è¾“å…¥ï¼Œè¾“å‡ºéƒ½ä¸€è‡´</strong>ã€‚</p><p>ç»“æœå‡†ç¡®æ€§ï¼šexactly-onceï¼Œåªå¤„ç†ä¸€æ¬¡</p></blockquote><h2 id="ä¸ºä»€ä¹ˆä½¿ç”¨Flink"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨Flink" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨Flink"></a>ä¸ºä»€ä¹ˆä½¿ç”¨Flink</h2><ul><li>æµæ‰¹æ•°æ®ç›¸åŒè®¡ç®—é€»è¾‘</li><li>ä½å»¶è¿Ÿï¼Œç›¸å¯¹äºSpark Streamingçš„å¾®æ‰¹æœ‰æ›´å°çš„å»¶è¿Ÿ</li><li>ç»“æœçš„å‡†ç¡®æ€§å’Œè‰¯å¥½çš„å®¹é”™æ€§</li></ul><h3 id="æ•°æ®å¤„ç†æ¶æ„çš„æ¼”å˜"><a href="#æ•°æ®å¤„ç†æ¶æ„çš„æ¼”å˜" class="headerlink" title="æ•°æ®å¤„ç†æ¶æ„çš„æ¼”å˜"></a>æ•°æ®å¤„ç†æ¶æ„çš„æ¼”å˜</h3><h4 id="äº‹åŠ¡å¤„ç†"><a href="#äº‹åŠ¡å¤„ç†" class="headerlink" title="äº‹åŠ¡å¤„ç†"></a>äº‹åŠ¡å¤„ç†</h4><p>æ‰€æœ‰çš„å­˜å‚¨å’Œè®¡ç®—éƒ½äº¤ç”±ä¸€ä¸ªDBMSæ¥å¤„ç†ï¼Œç„¶åé€šè¿‡å„ä¸ªç³»ç»Ÿæ¥å±•ç¤ºã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_20-47-35.png" alt="Snipaste_2020-12-16_20-47-35"></p><p>ç‰¹ç‚¹ï¼š</p><ul><li>å®æ—¶æ€§å¾ˆå¥½</li></ul><p>é—®é¢˜ï¼š</p><ul><li>èƒ½å¤ŸåŒæ—¶å¤„ç†çš„è¯·æ±‚æœ‰é™ï¼Œå½“æ•°æ®é‡å¤§ï¼Œè¯·æ±‚å¤šæ—¶å°±æ— æ³•å¤„ç†äº†</li></ul><h4 id="åˆ†æå¤„ç†"><a href="#åˆ†æå¤„ç†" class="headerlink" title="åˆ†æå¤„ç†"></a>åˆ†æå¤„ç†</h4><p>å°†æ•°æ®ä»ä¸šåŠ¡æ•°æ®åº“å¤åˆ¶åˆ°æ•°ä»“ï¼Œå†è¿›è¡Œåˆ†æå’ŒæŸ¥è¯¢</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_20-50-09.png" alt="Snipaste_2020-12-16_20-50-09"></p><p>ç‰¹ç‚¹ï¼š</p><ul><li>ä¸ç”¨åœ¨è”è¡¨æŸ¥è¯¢ï¼Œä¸æ€•é«˜å¹¶å‘</li></ul><p>é—®é¢˜ï¼š</p><ul><li>å®æ—¶æ€§åšä¸åˆ°</li></ul><h3 id="æµå¤„ç†æ¶æ„"><a href="#æµå¤„ç†æ¶æ„" class="headerlink" title="æµå¤„ç†æ¶æ„"></a>æµå¤„ç†æ¶æ„</h3><p>ä¸Šé¢çš„äº‹åŠ¡å¤„ç†å’Œåˆ†æå¤„ç†éƒ½æœ‰å„è‡ªçš„ä¼˜ç‚¹ï¼Œä½†æ˜¯æ²¡æœ‰åŒæ—¶æ»¡è¶³ä½å»¶è¿Ÿå’Œæ•°æ®æ­£ç¡®ã€‚</p><p>æ‰€ä»¥å‡ºç°äº†æµå¤„ç†ç»“æ„ï¼Œé€šè¿‡å°†æ•°æ®å­˜åœ¨æ•°æ®åº“ä¸­å˜ä¸ºå­˜åœ¨äºæµå¤„ç†çš„å†…å®¹ä¸­ï¼ˆæœ‰çŠ¶æ€ï¼‰ï¼Œå®šæ—¶æŒä¹…åŒ–åˆ°æœ¬åœ°ï¼Œå†…å­˜ä¸å¤Ÿçš„è¯ä½¿ç”¨é›†ç¾¤ï¼Œå°±èƒ½åŒæ—¶æ»¡è¶³ä½å»¶æ—¶å’Œé«˜ååã€‚</p><p>ä½†æ˜¯è¿™æ ·æœ‰ä¸ªç¼ºç‚¹ï¼Œå› ä¸ºä½¿ç”¨é›†ç¾¤å¤„ç†ï¼Œæ— æ³•ä¿è¯å„ä¸ªèŠ‚ç‚¹äº‹ä»¶çš„æœ‰åºæ€§ï¼Œè¿™æ ·å°±ä¼šå¯¹æœ€ç»ˆç»“æœé€ æˆåå·®ã€‚</p><p>è¿™æ—¶ï¼Œlambdaæ¶æ„é€šè¿‡ä¸¤å¥—å¤„ç†ç³»ç»Ÿï¼Œåˆ†åˆ«å¯¹ä½å»¶è¿Ÿå’Œæ•°æ®å‡†ç¡®æ€§åšå‡ºäº†ä¿éšœã€‚</p><h4 id="Lambdaæ¶æ„"><a href="#Lambdaæ¶æ„" class="headerlink" title="Lambdaæ¶æ„"></a>Lambdaæ¶æ„</h4><p>lambdaæ¶æ„ï¼šäº‹ä»¶æµæ—¢è¦è¿›è¡Œæµå¤„ç†ï¼ˆä½å»¶è¿Ÿï¼‰è¿˜è¦è¿›è¡Œæ‰¹å¤„ç†ï¼ˆä¿è¯å‡†ç¡®æ€§ï¼‰ï¼Œç”¨ä¸¤å¥—ç³»ç»Ÿä¿è¯ä½å»¶è¿Ÿå’Œç»“æœå‡†ç¡®ã€‚twitteræå‡º</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_20-59-21.png" alt="Snipaste_2020-12-16_20-59-21"></p><blockquote><p>ä¸ºä»€ä¹ˆè¿™é‡Œçš„æ‰¹å¤„ç†ç»“æœä¸å‡†ç¡®ï¼Ÿ</p><p><strong>æ—¶é—´æ­£ç¡®å¤„ç†/è¯­ä¹‰åŒ–çª—å£</strong>ï¼ˆæŒ‰ç…§äº‹ä»¶è§¦å‘æ—¶é—´è®¡ç®—ï¼Œä¸æ˜¯æŒ‰ç…§äº‹ä»¶åˆ°è¾¾æ—¶é—´è®¡ç®—ï¼‰ï¼Œåªæœ‰FLinkèƒ½åšåˆ°</p><p>ç¼ºç‚¹ï¼š</p><p>æµå¤„ç†è´Ÿè´£ä½å»¶è¿Ÿï¼Œæ•°æ®ä¸å‡†ç¡®ï¼›æ‰¹å¤„ç†è´Ÿè´£æ•°æ®å‡†ç¡®ã€‚<strong>ä½†å‡ ä¹å¤„ç†é€»è¾‘å¤§è‡´ç›¸åŒï¼Œå´å†™ä¸¤éã€‚</strong>ä¸å¥½</p></blockquote><blockquote><p><strong>æ—¶é—´æ­£ç¡®å¤„ç†/è¯­ä¹‰åŒ–çª—å£</strong></p><p>ï¼ˆæŒ‰ç…§äº‹ä»¶è§¦å‘æ—¶é—´è®¡ç®—ï¼Œä¸æ˜¯æŒ‰ç…§äº‹ä»¶åˆ°è¾¾æ—¶é—´è®¡ç®—ï¼‰</p><p>ä¾‹å¦‚ï¼Œç”±äºç½‘ç»œå»¶è¿Ÿï¼Œä¸€ä¸ªæ—¥å¿—æœ¬æ¥æ˜¯æ˜¨å¤©äº§ç”Ÿçš„ï¼Œç»“æœä»Šå¤©æ‰åˆ°è¾¾æœåŠ¡å™¨ã€‚</p><p>è¿™æ—¶ï¼Œsparkstreamä¼šè®¤ä¸ºå®ƒæ˜¯ä»Šå¤©çš„æ•°æ®ï¼Œå®ƒåªèƒ½æŒ‰ç…§å¤„ç†æ—¶é—´è®¡ç®—ã€‚è€Œflinkè®¤ä¸ºå®ƒæ˜¯æ˜¨å¤©çš„æ•°æ®ï¼Œå®ƒæŒ‰ç…§äº‹ä»¶æ—¶é—´è®¡ç®—ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201216114055114.png" alt="image-20201216114055114"></p><p><strong>ä¸Šå›¾æŸ¥çœ‹ç»“æœ</strong>ï¼Œåœ¨ssä¸­äº‹ä»¶æ”¾åœ¨äº†ä¸€ä¸ªä¸€åˆ†é’Ÿçš„çª—å£ä¸­ï¼Œè€Œäº‹ä»¶äº‹ä»¶å¹¶ä¸åœ¨ä¸€åˆ†é’Ÿä¹‹å†…ï¼Œæ‰€ä»¥å¾—çŸ¥ssæ˜¯è®¡ç®—å¤„ç†æ—¶é—´ã€‚è€ŒFlinkæ”¾åœ¨äº†2ä¸ªçª—å£ä¸­ï¼Œæ‰€ä»¥å®ƒä¸æ˜¯è®¡ç®—å¤„ç†æ—¶é—´ï¼Œè€Œæ˜¯è®¡ç®—äº‹ä»¶æœ¬èº«çš„æ—¶é—´ã€‚</p></blockquote><p><font color="red"><strong>æ‰€ä»¥ï¼ŒFlinkå‡ºç°äº†ï¼Œèƒ½åŒæ—¶å¤„ç†æ‰¹æµæ•°æ®çš„è®¡ç®—æ¡†æ¶ã€‚</strong></font></p><h2 id="Flinkç‰¹ç‚¹"><a href="#Flinkç‰¹ç‚¹" class="headerlink" title="Flinkç‰¹ç‚¹"></a>Flinkç‰¹ç‚¹</h2><ul><li>äº‹ä»¶é©±åŠ¨ï¼ˆäº‹ä»¶åˆ°è¾¾ï¼Œç«‹é©¬è®¡ç®—ï¼‰ï¼ˆSSä¸æ˜¯äº‹ä»¶é©±åŠ¨ï¼Œå› ä¸ºå®ƒæ˜¯å¾®æ‰¹ï¼Œæ”’å¤Ÿä¸€ä¸ªæ‰¹çš„äº‹ä»¶æ‰è®¡ç®—ï¼‰</li><li>æ—¶é—´æ­£ç¡®å¤„ç†/è¯­ä¹‰åŒ–çª—å£</li><li>exacly-once</li><li>æ¯«ç§’å»¶è¿Ÿ</li><li>é«˜å¯ç”¨</li><li>ä¸ä¼—å¤šå¸¸ç”¨å­˜å‚¨ç³»ç»Ÿçš„è¿æ¥</li></ul><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_21-07-39.png" alt="Snipaste_2020-12-16_21-07-39"></p><h2 id="vs-Spark-Streaming"><a href="#vs-Spark-Streaming" class="headerlink" title="vs Spark Streaming"></a>vs Spark Streaming</h2><ul><li>æµ(stream)å’Œå¾®æ‰¹(micro-batching)</li><li>æ•°æ®æ¨¡å‹ï¼ŒRDDä¸DataFlow</li><li>è¿è¡Œæ—¶æ¶æ„<ul><li>â€“spark æ˜¯æ‰¹è®¡ç®—ï¼Œå°† DAG åˆ’åˆ†ä¸ºä¸åŒçš„ stageï¼Œä¸€ä¸ªå®Œæˆåæ‰å¯ä»¥è®¡ç®—ä¸‹ä¸€ä¸ª</li><li>â€“flink æ˜¯æ ‡å‡†çš„æµæ‰§è¡Œæ¨¡å¼ï¼Œä¸€ä¸ªäº‹ä»¶åœ¨ä¸€ä¸ªèŠ‚ç‚¹å¤„ç†å®Œåå¯ä»¥ç›´æ¥å‘å¾€ä¸‹ä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œå¤„ç†</li></ul></li><li>shuffleåŒºåˆ«ğŸ”º<ul><li>Sparkæ˜¯æ‰¹å¤„ç†ï¼Œåœ¨shuffleæ—¶è¦ç­‰æ­¤stageçš„æ•°æ®å…¨éƒ¨è®¡ç®—å®Œæ¯•æ‰å¯ä»¥è¿›è¡Œshuffleæ´—ç‰Œï¼Œå¼€å§‹ä¸‹ä¸€ä¸ªstage</li><li>è€Œflinkæ˜¯æµå¤„ç†ï¼Œæ¯æ¬¡å¤„ç†å°±ä¸€å¼ ç‰Œï¼Œå®ƒçš„shuffleä¹Ÿå°±ä¸æ˜¯æ´—ç‰Œäº†ï¼Œè€Œæ˜¯å‘ç‰Œç»™ä¸‹ä¸€ä¸ªå­ä»»åŠ¡ï¼Œ<strong>ä¹Ÿä¸éœ€è¦ç­‰å¾…å…¶ä»–äº‹ä»¶çš„åˆ°è¾¾ã€‚</strong>flinkä¹Ÿæœ‰ä¸ªapiå«shuffleï¼Œå®ƒæ˜¯éšæœºå‘ç‰Œç»™ä¸‹ä¸€ä¸ªå­ä»»åŠ¡ï¼Œè€Œrebalanceæ˜¯è½®è¯¢å‘ç‰Œç»™ä¸‹ä¸€ä¸ªå­ä»»åŠ¡çš„åˆ†åŒºã€‚</li></ul></li></ul><h1 id="å¿«é€Ÿå¼€å§‹"><a href="#å¿«é€Ÿå¼€å§‹" class="headerlink" title="å¿«é€Ÿå¼€å§‹"></a>å¿«é€Ÿå¼€å§‹</h1><h2 id="åœ¨IDEAä¸­ç¼–å†™Flinkç¨‹åº"><a href="#åœ¨IDEAä¸­ç¼–å†™Flinkç¨‹åº" class="headerlink" title="åœ¨IDEAä¸­ç¼–å†™Flinkç¨‹åº"></a>åœ¨IDEAä¸­ç¼–å†™Flinkç¨‹åº</h2><p>æœ¬é¡¹ç›®ä½¿ç”¨çš„Flinkç‰ˆæœ¬ä¸ºæœ€æ–°ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯1.11.0ã€‚ç°åœ¨æä¾›mavené¡¹ç›®çš„é…ç½®æ–‡ä»¶ã€‚</p><ol><li>ä½¿ç”¨Intellij IDEAåˆ›å»ºä¸€ä¸ªMavenæ–°é¡¹ç›®</li><li>å‹¾é€‰<code>Create from archetype</code>ï¼Œç„¶åç‚¹å‡»<code>Add Archetype</code>æŒ‰é’®</li><li><code>GroupId</code>ä¸­è¾“å…¥<code>org.apache.flink</code>ï¼Œ<code>ArtifactId</code>ä¸­è¾“å…¥<code>flink-quickstart-scala</code>ï¼Œ<code>Version</code>ä¸­è¾“å…¥<code>1.11.0</code>ï¼Œç„¶åç‚¹å‡»<code>OK</code></li><li>ç‚¹å‡»å‘å³ç®­å¤´ï¼Œå‡ºç°ä¸‹æ‹‰åˆ—è¡¨ï¼Œé€‰ä¸­<code>flink-quickstart-scala:1.11.0</code>ï¼Œç‚¹å‡»<code>Next</code></li><li><code>Name</code>ä¸­è¾“å…¥<code>FlinkTutorial</code>ï¼Œ<code>GroupId</code>ä¸­è¾“å…¥<code>com.atguigu</code>ï¼Œ<code>ArtifactId</code>ä¸­è¾“å…¥<code>FlinkTutorial</code>ï¼Œç‚¹å‡»<code>Next</code></li><li>æœ€å¥½ä½¿ç”¨IDEAé»˜è®¤çš„Mavenå·¥å…·ï¼šBundledï¼ˆMaven 3ï¼‰ï¼Œç‚¹å‡»<code>Finish</code>ï¼Œç­‰å¾…ä¸€ä¼šå„¿ï¼Œé¡¹ç›®å°±åˆ›å»ºå¥½äº†</li></ol><p>ç¼–å†™<code>WordCount.scala</code>ç¨‹åº</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line">    <span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">object</span> <span class="title">StreamingJob</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">      <span class="comment">/** Main program method */</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) : <span class="type">Unit</span> = &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// get the execution environment</span></span><br><span class="line">        <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span></span><br><span class="line">          .getExecutionEnvironment</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// get input data by connecting to the socket</span></span><br><span class="line">        <span class="keyword">val</span> text: <span class="type">DataStream</span>[<span class="type">String</span>] = env</span><br><span class="line">          .socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">9999</span>, &#x27;\n&#x27;)</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// parse the data, group it, window it, and aggregate the counts</span></span><br><span class="line">        <span class="keyword">val</span> windowCounts = text</span><br><span class="line">          .flatMap &#123; w =&gt; w.split(<span class="string">&quot;\\s&quot;</span>) &#125;</span><br><span class="line">          .map &#123; w =&gt; <span class="type">WordWithCount</span>(w, <span class="number">1</span>) &#125;</span><br><span class="line">          .keyBy(<span class="string">&quot;word&quot;</span>)</span><br><span class="line">          .timeWindow(<span class="type">Time</span>.seconds(<span class="number">5</span>))</span><br><span class="line">          .sum(<span class="string">&quot;count&quot;</span>)</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// print the results with a single thread, rather than in parallel</span></span><br><span class="line">        windowCounts</span><br><span class="line">          .print()</span><br><span class="line">          .setParallelism(<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">        env.execute(<span class="string">&quot;Socket Window WordCount&quot;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">      <span class="comment">/** Data type for words with count */</span></span><br><span class="line">      <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">WordWithCount</span>(<span class="params">word: <span class="type">String</span>, count: <span class="type">Long</span></span>)</span></span><br><span class="line"><span class="class">    &#125;</span></span><br></pre></td></tr></table></figure><p>æ‰“å¼€ä¸€ä¸ªç»ˆç«¯ï¼ˆTerminalï¼‰ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nc -lk 9999</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä½¿ç”¨<code>IDEA</code>è¿è¡Œå°±å¯ä»¥äº†ã€‚</p><h2 id="ä¸‹è½½Flinkè¿è¡Œæ—¶ç¯å¢ƒï¼Œæäº¤JaråŒ…çš„è¿è¡Œæ–¹å¼"><a href="#ä¸‹è½½Flinkè¿è¡Œæ—¶ç¯å¢ƒï¼Œæäº¤JaråŒ…çš„è¿è¡Œæ–¹å¼" class="headerlink" title="ä¸‹è½½Flinkè¿è¡Œæ—¶ç¯å¢ƒï¼Œæäº¤JaråŒ…çš„è¿è¡Œæ–¹å¼"></a>ä¸‹è½½Flinkè¿è¡Œæ—¶ç¯å¢ƒï¼Œæäº¤JaråŒ…çš„è¿è¡Œæ–¹å¼</h2><p>ä¸‹è½½é“¾æ¥ï¼š<a href="http://mirror.bit.edu.cn/apache/flink/flink-1.11.0/flink-1.11.0-bin-scala_2.11.tgz">http://mirror.bit.edu.cn/apache/flink/flink-1.11.0/flink-1.11.0-bin-scala_2.11.tgz</a></p><p>ç„¶åè§£å‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tar xvfz flink-1.11.0-bin-scala_2.11.tgz</span><br></pre></td></tr></table></figure><p>å¯åŠ¨Flinké›†ç¾¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> flink-1.11.0</span><br><span class="line">$ ./bin/start-cluster.sh</span><br></pre></td></tr></table></figure><p>å¯ä»¥æ‰“å¼€Flink WebUIæŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼š<a href="http://localhost:8081/">http://localhost:8081</a></p><p>åœ¨<code>IDEA</code>ä¸­ä½¿ç”¨<code>maven package</code>æ‰“åŒ…ã€‚</p><p>æäº¤æ‰“åŒ…å¥½çš„<code>JAR</code>åŒ…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> flink-1.11.0</span><br><span class="line">$ ./bin/flink run æ‰“åŒ…å¥½çš„JARåŒ…çš„ç»å¯¹è·¯å¾„</span><br></pre></td></tr></table></figure><p>åœæ­¢Flinké›†ç¾¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./bin/stop-cluster.sh</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æ ‡å‡†è¾“å‡ºæ—¥å¿—çš„ä½ç½®ï¼Œåœ¨<code>log</code>æ–‡ä»¶å¤¹ä¸­ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> flink-1.11.0/<span class="built_in">log</span></span><br></pre></td></tr></table></figure><h2 id="ç¨‹åºä¸æ•°æ®æµ"><a href="#ç¨‹åºä¸æ•°æ®æµ" class="headerlink" title="ç¨‹åºä¸æ•°æ®æµ"></a>ç¨‹åºä¸æ•°æ®æµ</h2><ul><li>æ‰€æœ‰çš„Flinkç¨‹åºéƒ½æ˜¯ç”±ä¸‰éƒ¨åˆ†ç»„æˆçš„ï¼š Source ã€Transformation å’Œ Sinkã€‚</li><li>Source è´Ÿè´£è¯»å–æ•°æ®æºï¼ŒTransformation åˆ©ç”¨å„ç§ç®—å­è¿›è¡Œå¤„ç†åŠ å·¥ï¼ŒSink è´Ÿè´£è¾“å‡º</li><li>åœ¨è¿è¡Œæ—¶ï¼ŒFlinkä¸Šè¿è¡Œçš„ç¨‹åºä¼šè¢«æ˜ å°„æˆâ€œé€»è¾‘æ•°æ®æµâ€ï¼ˆdataflowsï¼‰ï¼Œå®ƒåŒ…å«äº†è¿™ä¸‰éƒ¨åˆ†</li><li>æ¯ä¸€ä¸ªdataflowä»¥ä¸€ä¸ªæˆ–å¤šä¸ªsourceså¼€å§‹ä»¥ä¸€ä¸ªæˆ–å¤šä¸ªsinksç»“æŸã€‚dataflowç±»ä¼¼äºä»»æ„çš„æœ‰å‘æ— ç¯å›¾ï¼ˆDAGï¼‰</li><li>åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œç¨‹åºä¸­çš„è½¬æ¢è¿ç®—ï¼ˆtransformationsï¼‰è·Ÿdataflowä¸­çš„ç®—å­ï¼ˆoperatorï¼‰æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»</li></ul><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_23-32-45.png" alt="Snipaste_2020-12-16_23-32-45"></p><h1 id="Flinkè¿è¡Œæ¶æ„ğŸ”º"><a href="#Flinkè¿è¡Œæ¶æ„ğŸ”º" class="headerlink" title="Flinkè¿è¡Œæ¶æ„ğŸ”º"></a>Flinkè¿è¡Œæ¶æ„ğŸ”º</h1><h2 id="Flinkè¿è¡Œæ—¶ç»„ä»¶"><a href="#Flinkè¿è¡Œæ—¶ç»„ä»¶" class="headerlink" title="Flinkè¿è¡Œæ—¶ç»„ä»¶"></a>Flinkè¿è¡Œæ—¶ç»„ä»¶</h2><p>Flinkè¿è¡Œæ—¶æ¶æ„ä¸»è¦åŒ…æ‹¬å››ä¸ªä¸åŒçš„ç»„ä»¶ï¼Œå®ƒä»¬ä¼šåœ¨è¿è¡Œæµå¤„ç†åº”ç”¨ç¨‹åºæ—¶ååŒå·¥ä½œï¼šä½œä¸šç®¡ç†å™¨ï¼ˆJobManagerï¼‰ã€èµ„æºç®¡ç†å™¨ï¼ˆResourceManagerï¼‰ã€ä»»åŠ¡ç®¡ç†å™¨ï¼ˆTaskManagerï¼‰ï¼Œä»¥åŠåˆ†å‘å™¨ï¼ˆDispatcherï¼‰ã€‚å› ä¸ºFlinkæ˜¯ç”¨Javaå’ŒScalaå®ç°çš„ï¼Œæ‰€ä»¥æ‰€æœ‰ç»„ä»¶éƒ½ä¼šè¿è¡Œåœ¨Javaè™šæ‹Ÿæœºï¼ˆJVMsï¼‰ä¸Šã€‚</p><h3 id="ä½œä¸šç®¡ç†å™¨ï¼ˆJobManagerï¼‰"><a href="#ä½œä¸šç®¡ç†å™¨ï¼ˆJobManagerï¼‰" class="headerlink" title="ä½œä¸šç®¡ç†å™¨ï¼ˆJobManagerï¼‰"></a>ä½œä¸šç®¡ç†å™¨ï¼ˆJobManagerï¼‰</h3><p>ç±»ä¼¼äºSparkçš„Driverè¿›ç¨‹ï¼Œä¸€ä¸ªJobå°±å¯¹åº”è¿™ä¸€ä¸ªJobManagerã€‚</p><ul><li>æ§åˆ¶ä¸€ä¸ªåº”ç”¨ç¨‹åºæ‰§è¡Œçš„ä¸»è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªåº”ç”¨ç¨‹åºéƒ½ä¼šè¢«ä¸€ä¸ªä¸åŒçš„JobManager æ‰€æ§åˆ¶æ‰§è¡Œã€‚</li><li>JobManager ä¼šå…ˆæ¥æ”¶åˆ°è¦æ‰§è¡Œçš„åº”ç”¨ç¨‹åºï¼Œè¿™ä¸ªåº”ç”¨ç¨‹åºä¼šåŒ…æ‹¬ï¼šä½œä¸šå›¾ï¼ˆJobGraphï¼‰ã€é€»è¾‘æ•°æ®æµå›¾ï¼ˆlogical dataflow graphï¼‰å’Œæ‰“åŒ…äº†æ‰€æœ‰çš„ç±»ã€åº“å’Œå…¶å®ƒèµ„æºçš„JARåŒ…ã€‚</li><li>JobManager ä¼šæŠŠJobGraphè½¬æ¢æˆä¸€ä¸ªç‰©ç†å±‚é¢çš„æ•°æ®æµå›¾ï¼Œè¿™ä¸ªå›¾è¢«å«åšâ€œæ‰§è¡Œå›¾â€ï¼ˆExecutionGraphï¼‰ï¼ŒåŒ…å«äº†æ‰€æœ‰å¯ä»¥å¹¶å‘æ‰§è¡Œçš„ä»»åŠ¡ã€‚</li><li>JobManager ä¼šå‘èµ„æºç®¡ç†å™¨ï¼ˆResourceManagerï¼‰è¯·æ±‚æ‰§è¡Œä»»åŠ¡å¿…è¦çš„èµ„æºï¼Œä¹Ÿå°±æ˜¯ä»»åŠ¡ç®¡ç†å™¨ï¼ˆTaskManagerï¼‰ä¸Šçš„<strong>æ’æ§½ï¼ˆslotï¼‰</strong>ã€‚ä¸€æ—¦å®ƒè·å–åˆ°äº†è¶³å¤Ÿçš„èµ„æºï¼Œå°±ä¼šå°†æ‰§è¡Œå›¾åˆ†å‘åˆ°çœŸæ­£è¿è¡Œå®ƒä»¬çš„TaskManagerä¸Šã€‚è€Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒJobManagerä¼šè´Ÿè´£æ‰€æœ‰éœ€è¦ä¸­å¤®åè°ƒçš„æ“ä½œï¼Œ<strong>æ¯”å¦‚è¯´æ£€æŸ¥ç‚¹ï¼ˆcheckpointsï¼‰çš„åè°ƒã€‚</strong></li></ul><h4 id="æ‰§è¡Œå›¾ï¼ˆExecutionGraphï¼‰ğŸ”º"><a href="#æ‰§è¡Œå›¾ï¼ˆExecutionGraphï¼‰ğŸ”º" class="headerlink" title="æ‰§è¡Œå›¾ï¼ˆExecutionGraphï¼‰ğŸ”º"></a>æ‰§è¡Œå›¾ï¼ˆExecutionGraphï¼‰ğŸ”º</h4><p>Flink ä¸­çš„æ‰§è¡Œå›¾å¯ä»¥åˆ†æˆå››å±‚ï¼šStreamGraph -&gt; JobGraph -&gt; ExecutionGraph -&gt; ç‰©ç†æ‰§è¡Œå›¾</p><ol><li>StreamGraphï¼šæ˜¯æ ¹æ®ç”¨æˆ·é€šè¿‡ Stream API ç¼–å†™çš„ä»£ç ç”Ÿæˆçš„æœ€åˆçš„å›¾ã€‚ç”¨æ¥è¡¨ç¤ºç¨‹åºçš„æ‹“æ‰‘ç»“æ„ã€‚</li><li>JobGraphï¼šStreamGraphç»è¿‡ä¼˜åŒ–åç”Ÿæˆäº† JobGraphï¼Œæäº¤ç»™ JobManager çš„æ•°æ®ç»“æ„ã€‚ä¸»è¦çš„ä¼˜åŒ–ä¸ºï¼Œ<strong>å°†å¤šä¸ªç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹ chain åœ¨ä¸€èµ·ä½œä¸ºä¸€ä¸ªèŠ‚ç‚¹</strong>ï¼Œé¿å…åœ¨ä¸åŒçš„slotè€Œè¿›è¡Œç½‘ç»œIOã€‚</li><li>ExecutionGraphï¼šJobManager æ ¹æ® JobGraph ç”ŸæˆExecutionGraphã€‚ExecutionGraphæ˜¯JobGraphçš„å¹¶è¡ŒåŒ–ç‰ˆæœ¬ï¼Œæ˜¯è°ƒåº¦å±‚æœ€æ ¸å¿ƒçš„æ•°æ®ç»“æ„ã€‚</li><li>ç‰©ç†æ‰§è¡Œå›¾ï¼šJobManager æ ¹æ® ExecutionGraph å¯¹ Job è¿›è¡Œè°ƒåº¦åï¼Œåœ¨å„ä¸ªTaskManager ä¸Šéƒ¨ç½² Task åå½¢æˆçš„â€œå›¾â€ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„æ•°æ®ç»“æ„ã€‚</li></ol><p><strong>æµç¨‹å›¾å®ä¾‹</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/sdkkfkasd.png" alt="sdkkfkasd"></p><ul><li>StreamGraph-&gt;JobGraphæ—¶ï¼Œæœ€åä¸¤ä¸ªåˆå¹¶äº†ï¼Œæ˜¯å› ä¸ºå®ƒä»¬ä¹‹é—´æ²¡æœ‰shuffleå¹¶ä¸”ç›¸åŒå¹¶è¡Œåº¦ï¼Œæ‰€ä»¥ä¸²ä¸ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œé¿å…å®ƒä»¬ä¸åœ¨ä¸€ä¸ªslotä¸­å¯èƒ½å¯¼è‡´çš„ç½‘ç»œä¼ è¾“</li><li>JobGraph-&gt;ExecutionGraphï¼Œè¿™æ˜¯ç”±Job Managerå®Œæˆçš„ï¼Œå®ƒå±•ç¤ºäº†å¹¶è¡Œçš„ä»»åŠ¡<ul><li><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-17_20-19-52.png" alt="Snipaste_2020-12-17_20-19-52"></li></ul></li></ul><p>æ‰€ä»¥æœ€åå„ä¸ªå­ä»»åŠ¡åœ¨TaskMangerä¸Šçš„åˆ†å¸ƒå¯èƒ½æ˜¯ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_23-46-12.png" alt="Snipaste_2020-12-16_23-46-12"></p><blockquote><p>æ‰å¹³çš„é•¿æ–¹å½¢æŒ‡çš„æ˜¯slot</p></blockquote><h4 id="ä»»åŠ¡é“¾ï¼ˆOperator-Chainsï¼‰ğŸ”º"><a href="#ä»»åŠ¡é“¾ï¼ˆOperator-Chainsï¼‰ğŸ”º" class="headerlink" title="ä»»åŠ¡é“¾ï¼ˆOperator Chainsï¼‰ğŸ”º"></a>ä»»åŠ¡é“¾ï¼ˆOperator Chainsï¼‰ğŸ”º</h4><p>GraphèŠ‚ç‚¹åˆå¹¶è§„åˆ™-Operator Chains</p><ul><li>Flink é‡‡ç”¨äº†ä¸€ç§ç§°ä¸ºä»»åŠ¡é“¾çš„ä¼˜åŒ–æŠ€æœ¯ï¼Œ<font color="red"><strong>å¯ä»¥åœ¨ç‰¹å®šæ¡ä»¶ä¸‹å‡å°‘æœ¬åœ°é€šä¿¡çš„å¼€é”€</strong></font>ã€‚ä¸ºäº†æ»¡è¶³ä»»åŠ¡é“¾çš„è¦æ±‚<strong>ï¼Œå¿…é¡»å°†ä¸¤ä¸ªæˆ–å¤šä¸ªç®—å­è®¾ä¸ºç›¸åŒçš„å¹¶è¡Œåº¦ï¼Œå¹¶é€šè¿‡æœ¬åœ°è½¬å‘ï¼ˆlocal forwardï¼‰çš„æ–¹å¼è¿›è¡Œè¿æ¥</strong></li><li><strong>ç›¸åŒå¹¶è¡Œåº¦</strong>çš„ <strong>one-to-one</strong>(ç»´æŠ¤åˆ†åŒºå†…æ•°æ®æœ‰åº) æ“ä½œï¼ŒFlink è¿™æ ·ç›¸è¿çš„ç®—å­é“¾æ¥åœ¨ä¸€èµ·å½¢æˆä¸€ä¸ª taskï¼ŒåŸæ¥çš„ç®—å­æˆä¸ºé‡Œé¢çš„ subtask</li><li>å¹¶è¡Œåº¦ç›¸åŒã€å¹¶ä¸”æ˜¯ one-to-one æ“ä½œï¼Œä¸¤ä¸ªæ¡ä»¶ç¼ºä¸€ä¸å¯</li></ul><hr><blockquote><p>åœ¨ä»£ç ç¼–è¯‘è¿‡ç¨‹ä¸­ä¼šå°†streamGarphå˜ä¸ºJobGraphï¼Œå…¶ä¸­ä¼šå°†å¤šä¸ªç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹ chain åœ¨ä¸€èµ·ä½œä¸ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p><p>å› ä¸ºæŠŠå®ƒä»¬æ”¾åœ¨ä¸€ä¸ªèŠ‚ç‚¹å®ƒä»¬æœ€ç»ˆä¼šåœ¨ä¸€ä¸ªslotä¸­è¿è¡Œï¼Œè¿™æ—¶å®ƒä»¬ä¹‹é—´æ•°æ®ä¼ é€’ä¼šèµ°æœ¬åœ°æ–¹å¼è¿æ¥ï¼Œå¦‚æœä¸æ”¾åœ¨ä¸€èµ·ï¼Œåˆ™æœ‰å¯èƒ½ä¼šå‡ºç°å®ƒä»¬èŠ‚ç‚¹åœ¨ä¸åŒçš„slotä¸­æ‰§è¡Œï¼Œå¿…ç„¶é€ æˆçº¿ç¨‹é—´æ•°æ®è¿æ¥æˆ–è€…ä¸åŒçš„job managerä¸­çš„sloté—´ç½‘ç»œæ•°æ®è¿æ¥ã€‚æ•ˆç‡ä½ä¸‹ã€‚</p></blockquote><p>æ‰€ä»¥ï¼Œå„ä¸ªå­ä»»åŠ¡çš„å¹¶è¡Œåº¦æœ€å¥½ä¸€è‡´ï¼Œå› ä¸ºåœ¨ç›¸åŒslotä¸­æ‰§è¡Œä½¿ç”¨æœ¬åœ°çº¿ç¨‹ä¼ è¾“ä¼šæ¯”å¯èƒ½çš„ç½‘ç»œä¼ è¾“æœ‰æ•ˆç‡ã€‚ä¸¾ä¸€ä¸ªåé¢æ•™æï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-17_20-25-35.png" alt="Snipaste_2020-12-17_20-25-35"></p><p>ç”±å›¾å¾—çŸ¥ï¼Œé™¤äº†CEå‰©ä¸‹çš„éƒ½æ˜¯å¹¶è¡Œåº¦4ã€‚å¹¶ä¸”Cå’ŒDä¹‹é—´æ˜¯shuffleï¼Œè€ŒDå’ŒEä¹‹é—´ä¸æ˜¯shuffleã€‚</p><p>è¿™ä¸ªå›¾å”¯ä¸€èƒ½ä¼˜åŒ–çš„åœ°æ–¹å°±æ˜¯Eçš„å¹¶è¡Œåº¦ï¼Œå¦‚æœæŠŠå®ƒçš„å¹¶è¡Œåº¦è®¾ä¸º4ï¼Œåˆ™D-Eä¹‹åèµ°slotæœ¬åœ°ä¼ è¾“ï¼Œè€Œä¸ä¼šè·¨slotä¼ è¾“ï¼›è‡³äºCï¼Œå› ä¸ºc-dæ˜¯shuffleï¼Œæ‰€ä»¥Cçš„å¹¶è¡Œåº¦åœ¨è¿™é‡Œä¸é‡è¦ã€‚</p><p><font color="red">ä½†æ˜¯æœ€å¥½å„ä¸ªå­ä»»åŠ¡çš„å¹¶è¡Œåº¦æœ€å¥½ä¸€è‡´ã€‚</font></p><h5 id="ä»»åŠ¡é“¾ç¦ç”¨"><a href="#ä»»åŠ¡é“¾ç¦ç”¨" class="headerlink" title="ä»»åŠ¡é“¾ç¦ç”¨"></a>ä»»åŠ¡é“¾ç¦ç”¨</h5><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-17_22-14-42.png" alt="Snipaste_2020-12-17_22-14-42"></p><p>æ ¹æ®é»˜è®¤è§„åˆ™ä¸Šå›¾çš„keyå’Œsinkæ˜¯è¦åˆå¹¶çš„ï¼Œä½†æ˜¯æˆ‘å°±æ˜¯ä¸åƒè®©å®ƒåˆå¹¶ï¼Œå¯ä»¥å‚è€ƒçš„æ–¹æ³•æœ‰ï¼š</p><ol><li>åœ¨keyåæ‰‹åŠ¨é‡åˆ†åŒº(rebalance|shuffle)</li><li>å•ç‹¬ä¸ºkeyæ“ä½œè®¾ç½®<code>disableChaining</code>ï¼Œè¿™æ ·keyå‰åéƒ½ä¸ä¼šå‚ä¸åˆå¹¶</li><li>æŠ›å¼€æ­¤å›¾æ¥è®²ï¼Œkeyå’Œå‰åéƒ½æ˜¯åˆå¹¶çŠ¶æ€ï¼Œå¦‚æœæƒ³è®©keyå’Œå‰é¢æ–­å¼€å’Œåè¾¹åˆå¹¶ï¼Œå¯ä»¥å•ç‹¬ä¸ºkeyè®¾ç½®<code>.startNewChain</code></li><li>å¦‚æœç›´æ¥ä¸ºæ­¤å›¾ç¦ç”¨åˆå¹¶Chainï¼Œåˆ™ç›´æ¥åœ¨ç¯å¢ƒå¤„<code>.disableChaining</code></li></ol><h3 id="ä»»åŠ¡ç®¡ç†å™¨ï¼ˆTaskManagerï¼‰"><a href="#ä»»åŠ¡ç®¡ç†å™¨ï¼ˆTaskManagerï¼‰" class="headerlink" title="ä»»åŠ¡ç®¡ç†å™¨ï¼ˆTaskManagerï¼‰"></a>ä»»åŠ¡ç®¡ç†å™¨ï¼ˆTaskManagerï¼‰</h3><p>ç±»ä¼¼äºSparkçš„Executorè¿›ç¨‹ã€‚</p><ul><li>Flinkä¸­çš„å·¥ä½œè¿›ç¨‹ã€‚é€šå¸¸åœ¨Flinkä¸­ä¼šæœ‰å¤šä¸ªTaskManagerè¿è¡Œï¼Œæ¯ä¸€ä¸ªTaskManageréƒ½åŒ…å«äº†ä¸€å®šæ•°é‡çš„æ’æ§½ï¼ˆslotsï¼‰ã€‚æ’æ§½çš„æ•°é‡é™åˆ¶äº†TaskManagerèƒ½å¤Ÿæ‰§è¡Œçš„ä»»åŠ¡æ•°é‡ã€‚</li><li>å¯åŠ¨ä¹‹åï¼ŒTaskManagerä¼šå‘èµ„æºç®¡ç†å™¨æ³¨å†Œå®ƒçš„æ’æ§½ï¼›æ”¶åˆ°èµ„æºç®¡ç†å™¨çš„æŒ‡ä»¤åï¼ŒTaskManagerå°±ä¼šå°†ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ’æ§½æä¾›ç»™JobManagerè°ƒç”¨ã€‚JobManagerå°±å¯ä»¥å‘æ’æ§½åˆ†é…ä»»åŠ¡ï¼ˆtasksï¼‰æ¥æ‰§è¡Œäº†ã€‚</li><li>åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªTaskManagerå¯ä»¥è·Ÿå…¶å®ƒè¿è¡ŒåŒä¸€åº”ç”¨ç¨‹åºçš„TaskManageräº¤æ¢æ•°æ®ã€‚</li></ul><blockquote><p>TaskManageræ˜¯è¿›ç¨‹ï¼›slotæ˜¯çº¿ç¨‹ï¼›</p></blockquote><h4 id="TaskManager-å’Œ-SlotsğŸ”º"><a href="#TaskManager-å’Œ-SlotsğŸ”º" class="headerlink" title="TaskManager å’Œ SlotsğŸ”º"></a>TaskManager å’Œ SlotsğŸ”º</h4><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_23-07-10.png" alt="Snipaste_2020-12-16_23-07-10"></p><ul><li>Flink ä¸­æ¯ä¸€ä¸ª TaskManager éƒ½æ˜¯ä¸€ä¸ªJVMè¿›ç¨‹ï¼Œå®ƒå¯èƒ½ä¼šåœ¨ç‹¬ç«‹çš„çº¿ç¨‹ä¸Šæ‰§è¡Œä¸€ä¸ªæˆ–å¤šä¸ªå­ä»»åŠ¡</li><li>ä¸ºäº†æ§åˆ¶ä¸€ä¸ª TaskManager èƒ½æ¥æ”¶å¤šå°‘ä¸ª taskï¼Œ TaskManager é€šè¿‡ task slot æ¥è¿›è¡Œæ§åˆ¶ï¼ˆä¸€ä¸ª TaskManager è‡³å°‘æœ‰ä¸€ä¸ª slotï¼‰</li><li>Task Slot æ˜¯é™æ€çš„æ¦‚å¿µï¼Œæ˜¯æŒ‡ TaskManager å…·æœ‰çš„å¹¶å‘æ‰§è¡Œèƒ½åŠ› </li></ul><blockquote><p><font color="red"><strong>å…±äº«slot</strong></font></p><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒFlink å…è®¸å­ä»»åŠ¡å…±äº« slotï¼Œå­ä»»åŠ¡å³åŒä¸€Jobçš„ä¸åŒæ“ä½œã€‚ è¿™æ ·çš„ç»“æœæ˜¯ï¼Œä¸€ä¸ª slot å¯ä»¥ä¿å­˜ä½œä¸šçš„æ•´ä¸ªç®¡é“ã€‚(å½“æ­¤Jobè®¾ç½®å…¨å±€å¹¶è¡Œåº¦ä¸º1æ—¶,å³<code>env.setParallelism(1)</code>)</p><p>æ­¤å›¾å°±æ˜¯ä¸€ä¸ªslotä¿å­˜äº†æ•´ä¸ªä½œä¸šçš„å¤„ç†é€»è¾‘ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_23-19-17.png" alt="Snipaste_2020-12-16_23-19-17"></p><p>å¦‚æœæƒ³ä¸ç”¨å…±äº«soltï¼Œå¯ä»¥ä¸ºä¸åŒçš„å­ä»»åŠ¡è®¾ç½®ä¸åŒçš„å…±äº«ç»„(slotSharingGroup)ã€‚</p><p>å¦‚æœç¦ç”¨äº†å…±äº«slotä¹‹åï¼Œåˆ™å¹¶è¡Œåº¦å’Œslotä½¿ç”¨çš„è®¡ç®—æ–¹å¼å·²ç»ä¸æ˜¯ä¸‹é¢çš„è®¡ç®—æ–¹å¼ã€‚é¦–å…ˆæŒ‰ç…§åˆ†ç»„è®¡ç®—å„ä¸ªå­ä»»åŠ¡çš„æœ€å¤§å¹¶è¡Œåº¦ï¼Œ<strong>ç„¶åä¸åŒç»„ä¹‹é—´çš„æœ€å¤§ç›¸åŠ ã€‚</strong></p></blockquote><h4 id="å¹¶è¡Œåº¦æµ‹è¯•ğŸ”º"><a href="#å¹¶è¡Œåº¦æµ‹è¯•ğŸ”º" class="headerlink" title="å¹¶è¡Œåº¦æµ‹è¯•ğŸ”º"></a>å¹¶è¡Œåº¦æµ‹è¯•ğŸ”º</h4><p>ä»£ç ä¸­å¯ä»¥é€šè¿‡<code>env.setParallelism(1)</code>è®¾ç½®Jobé»˜è®¤å¹¶è¡Œåº¦ï¼Œ<strong>ä½†æ˜¯æ¯ä¸ªå­ä»»åŠ¡éƒ½æœ‰è‡ªå·±çš„å¹¶è¡Œåº¦</strong>ï¼Œæ‰€ä»¥ï¼Œ<font color="red"><strong>ä¸€ä¸ªStreamæœ€åçš„å¹¶è¡Œåº¦ï¼ˆå³æœ€åéœ€è¦çš„slotï¼‰è¦ç»¼åˆå„ä¸ªç®—å­ï¼Œä¸€èˆ¬(æ²¡æœ‰è®¾ç½®ä¸åŒçš„å…±äº«ç»„)å¯ä»¥è®¤ä¸ºå°±æ˜¯å…¶æ‰€æœ‰ç®—å­ä¸­æœ€å¤§çš„å¹¶è¡Œåº¦ã€‚</strong></font>ï¼ˆå› ä¸ºå…±äº«slotçš„å­˜åœ¨ï¼Œä½¿å¾—åŒä¸€ä»»åŠ¡çš„ä¸åŒå­ä»»åŠ¡å¯ä»¥å…±äº«slotï¼Œæ‰€ä»¥åªéœ€è¦å…¶æ‰€æœ‰ç®—å­ä¸­æœ€å¤§çš„å¹¶è¡Œåº¦ã€‚ï¼‰</p><blockquote><p>ä¸€ä¸ªç‰¹å®šç®—å­çš„ å­ä»»åŠ¡ï¼ˆsubtaskï¼‰çš„ä¸ªæ•°è¢«ç§°ä¹‹ä¸ºå…¶å¹¶è¡Œåº¦ï¼ˆparallelismï¼‰</p></blockquote><p>å¦‚æœè®¾ç½®äº†ä¸åŒçš„å…±äº«ç»„(slotSharingGroup)ï¼Œåˆ™è®¡ç®—æ–¹æ³•ä¸æ˜¯ä¸Šé¢çš„è®¡ç®—æ–¹æ³•ï¼Œè€Œæ˜¯æ¯ä¸ªç»„å†…éƒ½è¦ä½¿ç”¨ä¸Šé¢çš„è®¡ç®—æ–¹æ³•ï¼Œå¹¶ä¸”ä¸åŒçš„ç»„ç›¸åŠ <strong>ï¼ˆå› ä¸ºå…±äº«ç»„ä¹‹é—´çš„ä»»åŠ¡ä¸èƒ½å…±äº«slotï¼Œæ¯”å¦‚2ç»„çš„ä»»åŠ¡ä¸èƒ½åˆ°1ç»„çš„slotæ‰§è¡Œï¼‰</strong>ã€‚æœ€åçš„æ•°å°±æ˜¯æ­¤Jobæœ€ç»ˆä¼šæ¶ˆè€—çš„slotæ•°ç›®ã€‚</p><p><strong>ä¾‹å¦‚ä»¥ä¸‹ä»£ç ï¼š</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> text: <span class="type">DataStream</span>[<span class="type">String</span>] = env</span><br><span class="line">  .socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">9999</span>, &#x27;\n&#x27;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// parse the data, group it, window it, and aggregate the counts</span></span><br><span class="line"><span class="keyword">val</span> windowCounts = text</span><br><span class="line">  .flatMap &#123; w =&gt; w.split(<span class="string">&quot;\\s&quot;</span>) &#125;.slotSharingGroup(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">  .map &#123; w =&gt; <span class="type">WordWithCount</span>(w, <span class="number">1</span>) &#125;</span><br><span class="line">  .keyBy(<span class="string">&quot;word&quot;</span>)</span><br><span class="line">  .sum(<span class="string">&quot;count&quot;</span>).setParallelism(<span class="number">2</span>).slotSharingGroup(<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// print the results with a single thread, rather than in parallel</span></span><br><span class="line">windowCounts</span><br><span class="line">  .print()</span><br><span class="line">  .setParallelism(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆæ¶ˆè€—4ä¸ªslotï¼Œè®¡ç®—æ˜ç»†å¦‚ä¸‹ï¼š</p><ul><li>defalutç»„ï¼šæœ€å¤§å¹¶è¡Œ1</li><li>1ç»„ï¼šæœ€å¤§å¹¶è¡Œ1</li><li>2ç»„ï¼šæœ€å¤§å¹¶è¡Œ2</li></ul><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-17_22-28-59.png" alt="Snipaste_2020-12-17_22-28-59"></p><p><strong>ä¸¾ä¾‹è¯´æ˜</strong></p><p>ç°æœ‰3ä¸ªTaskManagerï¼Œæ¯ä¸ªTaskManageræœ‰3ä¸ªslotã€‚</p><p><strong>1. Parallelism=1</strong></p><p>æ‰€æœ‰çš„å­ä»»åŠ¡éƒ½åœ¨ä¸€ä¸ªslotä¸­ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_23-27-06.png" alt="Snipaste_2020-12-16_23-27-06"></p><p><strong>2. Parallelism=9</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_23-27-42.png" alt="Snipaste_2020-12-16_23-27-42"></p><p><strong>3. æ€»ä½“ä¸º9ï¼Œä½†æ˜¯å•ç‹¬ä¸ºSinkè®¾ç½®ä¸º1</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_23-28-43.png" alt="Snipaste_2020-12-16_23-28-43"></p><hr><h3 id="èµ„æºç®¡ç†å™¨ï¼ˆResourceManagerï¼‰"><a href="#èµ„æºç®¡ç†å™¨ï¼ˆResourceManagerï¼‰" class="headerlink" title="èµ„æºç®¡ç†å™¨ï¼ˆResourceManagerï¼‰"></a>èµ„æºç®¡ç†å™¨ï¼ˆResourceManagerï¼‰</h3><ul><li>ä¸»è¦è´Ÿè´£ç®¡ç†ä»»åŠ¡ç®¡ç†å™¨ï¼ˆTaskManagerï¼‰çš„æ’æ§½ï¼ˆslotï¼‰ï¼ŒTaskManger æ’æ§½æ˜¯Flinkä¸­å®šä¹‰çš„å¤„ç†èµ„æºå•å…ƒã€‚</li><li>Flinkä¸ºä¸åŒçš„ç¯å¢ƒå’Œèµ„æºç®¡ç†å·¥å…·æä¾›äº†ä¸åŒèµ„æºç®¡ç†å™¨ï¼Œæ¯”å¦‚YARNã€Mesosã€K8sï¼Œä»¥åŠstandaloneéƒ¨ç½²ã€‚</li><li>å½“JobManagerç”³è¯·æ’æ§½èµ„æºæ—¶ï¼ŒResourceManagerä¼šå°†æœ‰ç©ºé—²æ’æ§½çš„TaskManageråˆ†é…ç»™JobManagerã€‚å¦‚æœResourceManageræ²¡æœ‰è¶³å¤Ÿçš„æ’æ§½æ¥æ»¡è¶³JobManagerçš„è¯·æ±‚ï¼Œå®ƒè¿˜å¯ä»¥å‘èµ„æºæä¾›å¹³å°å‘èµ·ä¼šè¯ï¼Œä»¥æä¾›å¯åŠ¨TaskManagerè¿›ç¨‹çš„å®¹å™¨ã€‚</li></ul><h3 id="åˆ†å‘å™¨ï¼ˆDispatcherï¼‰"><a href="#åˆ†å‘å™¨ï¼ˆDispatcherï¼‰" class="headerlink" title="åˆ†å‘å™¨ï¼ˆDispatcherï¼‰"></a>åˆ†å‘å™¨ï¼ˆDispatcherï¼‰</h3><ul><li><p>å¯ä»¥è·¨ä½œä¸šè¿è¡Œï¼Œå®ƒä¸ºåº”ç”¨æäº¤æä¾›äº†RESTæ¥å£ã€‚</p></li><li><p>å½“ä¸€ä¸ªåº”ç”¨è¢«æäº¤æ‰§è¡Œæ—¶ï¼Œåˆ†å‘å™¨å°±ä¼šå¯åŠ¨å¹¶å°†åº”ç”¨ç§»äº¤ç»™ä¸€ä¸ªJobManagerã€‚</p></li><li><p>Dispatcherä¹Ÿä¼šå¯åŠ¨ä¸€ä¸ªWeb UIï¼Œç”¨æ¥æ–¹ä¾¿åœ°å±•ç¤ºå’Œç›‘æ§ä½œä¸šæ‰§è¡Œçš„ä¿¡æ¯ã€‚</p></li><li><p>Dispatcheråœ¨æ¶æ„ä¸­å¯èƒ½å¹¶ä¸æ˜¯å¿…éœ€çš„ï¼Œè¿™å–å†³äºåº”ç”¨æäº¤è¿è¡Œçš„æ–¹å¼ã€‚</p></li></ul><p>åœ¨UIæäº¤ä»»åŠ¡æ—¶çš„å…¥å£ã€‚</p><h2 id="ä»»åŠ¡æäº¤æµç¨‹"><a href="#ä»»åŠ¡æäº¤æµç¨‹" class="headerlink" title="ä»»åŠ¡æäº¤æµç¨‹"></a>ä»»åŠ¡æäº¤æµç¨‹</h2><h3 id="UI"><a href="#UI" class="headerlink" title="UI"></a>UI</h3><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_22-58-39.png" alt="Snipaste_2020-12-16_22-58-39"></p><h3 id="Yarn"><a href="#Yarn" class="headerlink" title="Yarn"></a>Yarn</h3><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_23-00-28.png" alt="Snipaste_2020-12-16_23-00-28"></p><h2 id="ä»»åŠ¡è°ƒåº¦åŸç†"><a href="#ä»»åŠ¡è°ƒåº¦åŸç†" class="headerlink" title="ä»»åŠ¡è°ƒåº¦åŸç†"></a>ä»»åŠ¡è°ƒåº¦åŸç†</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_23-01-44.png" alt="Snipaste_2020-12-16_23-01-44"></p><p>keybyä¹‹åä¸ºä»€ä¹ˆæ²¡æœ‰åˆ†ç»„[]ï¼Œæ˜¯é€»è¾‘åˆ†ç»„ï¼Œå› ä¸ºå®ƒæ˜¯æµå¤„ç†æ¥ä¸€ä¸ªå¤„ç†ä¸€ä¸ªï¼Œæ‰€ä»¥åªå¯¹äº‹ä»¶è¿›è¡Œæ‰“æ ‡æ ‡æ˜æ˜¯å“ªä¸ªç»„ï¼Œç„¶ååªå¤„ç†ä¸€æ¡äº‹ä»¶ã€‚ä¸Sparkä¸åŒï¼ŒSparkæ˜¯æ‰¹å¤„ç†ï¼Œæ‰€ä»¥åˆ†ç»„åä¼šæ˜¯key,[event]çš„æ•°æ®</p><p>æ»šåŠ¨èšåˆåä¼šå˜ä¸ºDataStreamï¼›æ»šåŠ¨èšåˆä¼šå­˜æ”¾ä¸€ä¸ªçŠ¶æ€ï¼Œæ¯å½“æ•°æ®æ»šåŠ¨ï¼ˆæ•°æ®æµå¢åŠ æ—¶ï¼‰ä¼šå’ŒçŠ¶æ€ï¼ˆä¸€ä¸ªkeyä¸€ä¸ªçŠ¶æ€ï¼‰è¿›è¡Œè®¡ç®—ï¼Œå¾—å‡ºä¸‹ä¸€ä¸ªçŠ¶æ€ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Flink&quot;&gt;&lt;a href=&quot;#Flink&quot; class=&quot;headerlink&quot; title=&quot;Flink&quot;&gt;&lt;/a&gt;Flink&lt;/h1&gt;&lt;h2 id=&quot;Flinkæ˜¯ä»€ä¹ˆ&quot;&gt;&lt;a href=&quot;#Flinkæ˜¯ä»€ä¹ˆ&quot; class=&quot;headerlink&quot; titl</summary>
      
    
    
    
    <category term="Flink" scheme="https://awslzhang.top/categories/Flink/"/>
    
    
    <category term="Flink" scheme="https://awslzhang.top/tags/Flink/"/>
    
  </entry>
  
  <entry>
    <title>k8sé›†ç¾¤ç›‘æ§ã€é«˜å¯ç”¨ä»¥åŠéƒ¨ç½²è‡ªå»ºJavaé¡¹ç›®</title>
    <link href="https://awslzhang.top/2020/12/06/k8s%E9%9B%86%E7%BE%A4%E7%9B%91%E6%8E%A7%E3%80%81%E9%AB%98%E5%8F%AF%E7%94%A8%E4%BB%A5%E5%8F%8A%E9%83%A8%E7%BD%B2%E8%87%AA%E5%BB%BAJava%E9%A1%B9%E7%9B%AE/"/>
    <id>https://awslzhang.top/2020/12/06/k8s%E9%9B%86%E7%BE%A4%E7%9B%91%E6%8E%A7%E3%80%81%E9%AB%98%E5%8F%AF%E7%94%A8%E4%BB%A5%E5%8F%8A%E9%83%A8%E7%BD%B2%E8%87%AA%E5%BB%BAJava%E9%A1%B9%E7%9B%AE/</id>
    <published>2020-12-06T01:26:41.000Z</published>
    <updated>2021-01-01T05:50:00.027Z</updated>
    
    <content type="html"><![CDATA[<h1 id="k8sé›†ç¾¤ç›‘æ§"><a href="#k8sé›†ç¾¤ç›‘æ§" class="headerlink" title="k8sé›†ç¾¤ç›‘æ§"></a>k8sé›†ç¾¤ç›‘æ§</h1><p>æ—¢ç„¶æ˜¯ç›‘æ§k8sçš„é›†ç¾¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦å®æ—¶è·å–k8sé›†ç¾¤çš„å“ªäº›ä¿¡æ¯å‘¢ï¼Ÿå³æˆ‘ä»¬çš„ç›‘æ§æŒ‡æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>æƒ³æƒ³k8sçš„é›†ç¾¤ä¸­æ‰€æœ‰çš„æ¦‚å¿µï¼Œå³æˆ‘ä»¬éœ€è¦ç›‘æ§ï¼š</p><ul><li>èŠ‚ç‚¹èµ„æºåˆ©ç”¨ç‡</li><li>èŠ‚ç‚¹æ•°</li><li>è¿è¡Œçš„Podæ•°ç›®</li><li>å„ä¸ªå®¹å™¨çš„çŠ¶æ€ã€èµ„æº</li><li>è¿è¡Œçš„ç¨‹åºç­‰ã€‚</li></ul><p>ç¡®å®šå¥½ç›‘æ§çš„æŒ‡æ ‡åï¼Œå°±è¦å¼€å§‹å†³å®šä½¿ç”¨çš„ç›‘æ§å¹³å°æ˜¯ä»€ä¹ˆï¼Œåœ¨ä¼—å¤šçš„ç›‘æ§å¹³å°ä¸­é€‰æ‹©äº†<code>prometheus</code>å’Œ<code>Grafana</code>æ¥ç›‘æ§å’Œå±•ç¤ºå†…å®¹ã€‚</p><p><code>prometheus</code>æ˜¯ä¸€ä¸ª<strong>å¼€æºçš„ã€ä»¥HTTPåè®®å‘¨æœŸæ€§æŠ“å–è¢«ç›‘æ§ç»„ä»¶çŠ¶æ€çš„é›†ç›‘æ§ã€æŠ¥è­¦ã€æ•°æ®åº“ä¸ºä¸€èº«çš„ç»„ä»¶</strong>ã€‚</p><p><code>Grafana</code>æ˜¯ä¸€ä¸ª<strong>å¼€æºçš„æ•°æ®åˆ†æå’Œæ•°æ®å¯è§†åŒ–å·¥å…·ï¼Œæä¾›uiç•Œé¢æ”¯æŒå¤šç§æ•°æ®åº“æºçš„æ•°æ®ã€‚</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-06_09-48-11.png" alt="Snipaste_2020-12-06_09-48-11"></p><h2 id="æ­å»ºç›‘æ§å¹³å°"><a href="#æ­å»ºç›‘æ§å¹³å°" class="headerlink" title="æ­å»ºç›‘æ§å¹³å°"></a>æ­å»ºç›‘æ§å¹³å°</h2><h3 id="prometheus"><a href="#prometheus" class="headerlink" title="prometheus"></a><code>prometheus</code></h3><p><strong>0. åˆ›å»ºæ”¶é›†å®ˆæŠ¤è¿›ç¨‹</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">node-exporter</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">node-exporter</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">prom/node-exporter</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9100</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9100</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">31672</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">node-exporter</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f xxx.yaml</span><br></pre></td></tr></table></figure><p><strong>1. æƒé™é…ç½®</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/proxy</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">nonResourceURLs:</span> [<span class="string">&quot;/metrics&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-06_10-19-18.png" alt="Snipaste_2020-12-06_10-19-18"></p><p><strong>2.é…ç½®æ–‡ä»¶</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">prometheus.yml:</span> <span class="string">|</span></span><br><span class="line">    <span class="attr">global:</span></span><br><span class="line">      <span class="attr">scrape_interval:</span>     <span class="string">15s</span></span><br><span class="line">      <span class="attr">evaluation_interval:</span> <span class="string">15s</span></span><br><span class="line">    <span class="attr">scrape_configs:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes-apiservers&#x27;</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">tls_config:</span></span><br><span class="line">        <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">      <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>, <span class="string">__meta_kubernetes_service_name</span>, <span class="string">__meta_kubernetes_endpoint_port_name</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">default;kubernetes;https</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes-nodes&#x27;</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">      <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">tls_config:</span></span><br><span class="line">        <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">      <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">kubernetes.default.svc:443</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_node_name</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">/api/v1/nodes/$&#123;1&#125;/proxy/metrics</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes-cadvisor&#x27;</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">      <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">tls_config:</span></span><br><span class="line">        <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">      <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">kubernetes.default.svc:443</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_node_name</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">/api/v1/nodes/$&#123;1&#125;/proxy/metrics/cadvisor</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes-service-endpoints&#x27;</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_scrape</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_scheme</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__scheme__</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(https?)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_path</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>, <span class="string">__meta_kubernetes_service_annotation_prometheus_io_port</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">$1:$2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_service_label_(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_name</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_name</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes-services&#x27;</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">service</span></span><br><span class="line">      <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">      <span class="attr">params:</span></span><br><span class="line">        <span class="attr">module:</span> [<span class="string">http_2xx</span>]</span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_probe</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">blackbox-exporter.example.com:9115</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_service_label_(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_name</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_name</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes-ingresses&#x27;</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">ingress</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_ingress_annotation_prometheus_io_probe</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_ingress_scheme</span>,<span class="string">__address__</span>,<span class="string">__meta_kubernetes_ingress_path</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.+);(.+);(.+)</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">$&#123;1&#125;://$&#123;2&#125;$&#123;3&#125;</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">blackbox-exporter.example.com:9115</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_ingress_label_(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_ingress_name</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_name</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes-pods&#x27;</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">pod</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_scrape</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_path</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>, <span class="string">__meta_kubernetes_pod_annotation_prometheus_io_port</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">$1:$2</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_pod_label_(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_name</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_pod_name</span></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-06_10-20-28.png" alt="Snipaste_2020-12-06_10-20-28"></p><p><strong>3. deploymentåˆ›å»º</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">prometheus-deployment</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">prom/prometheus:v2.0.0</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;/bin/prometheus&quot;</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;--config.file=/etc/prometheus/prometheus.yml&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;--storage.tsdb.path=/prometheus&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;--storage.tsdb.retention=24h&quot;</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9090</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&quot;/prometheus&quot;</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&quot;/etc/prometheus&quot;</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">2500Mi</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">prometheus</span>    </span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">prometheus-config</span>   </span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-06_10-21-44.png" alt="Snipaste_2020-12-06_10-21-44"></p><p><strong>4. svcåˆ›å»º</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9090</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30003</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-06_10-22-46.png" alt="Snipaste_2020-12-06_10-22-46"></p><h3 id="Grafana"><a href="#Grafana" class="headerlink" title="Grafana"></a><code>Grafana</code></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana-core</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">core</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">      <span class="attr">component:</span> <span class="string">core</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">        <span class="attr">component:</span> <span class="string">core</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">grafana/grafana:4.2.0</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">grafana-core</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        </span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">         </span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">         </span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_AUTH_BASIC_ENABLED</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_AUTH_ANONYMOUS_ENABLED</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">         </span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/login</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">         </span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-persistent-storage</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-persistent-storage</span></span><br><span class="line">        <span class="attr">emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">core</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">core</span></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-06_10-30-38.png" alt="Snipaste_2020-12-06_10-30-38"></p><hr><p>æ£€éªŒ</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-06_11-03-38.png" alt="Snipaste_2020-12-06_11-03-38"></p><h2 id="è®¾ç½®"><a href="#è®¾ç½®" class="headerlink" title="è®¾ç½®"></a>è®¾ç½®</h2><p>æ ¹æ®<code>kubectl get svc -n kube-system    </code>å¾—åˆ°è®¿é—®åœ°å€ï¼Œè®¿é—®ä¹‹åï¼Œè¾“å…¥è´¦å·å¯†ç ï¼Œéƒ½æ˜¯admin</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-06_11-05-46.png" alt="Snipaste_2020-12-06_11-05-46"></p><p><strong>1. é…ç½®æ•°æ®æºprometheus</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-06_11-33-54.png" alt="Snipaste_2020-12-06_11-33-54"></p><p>è¯·æ³¨æ„ï¼ŒURLçš„ipè¯·é‡‡ç”¨prometheusçš„svcçš„IPã€‚</p><p><strong>2. è®¾ç½®æ•°æ®æ¨¡æ¿</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-06_11-36-19.png" alt="Snipaste_2020-12-06_11-36-19"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-06_11-50-06.png" alt="Snipaste_2020-12-06_11-50-06"></p><p>è¿™é‡Œä¸¤ç§é€‰æ‹©ï¼Œä½ å¯ä»¥ç›´æ¥åœ¨ä¸Šé¢çš„è¾“å…¥æ¡†å†…è¾“å…¥<code>315</code>ï¼Œåˆæˆ–è€…åœ¨ä¸‹é¢çš„JSONå†…è¾“å…¥JSONã€‚</p><p>å› ä¸ºè¾“å…¥315ä»–ä¼šè¯·æ±‚ä¸€ä¸ªç½‘å€æ¥è·å–JSONï¼Œä½†æ˜¯å¯èƒ½éœ€è¦ç§‘å­¦ä¸Šç½‘æ‰èƒ½æ‹‰å–åˆ°JSONã€‚æ‰€ä»¥è¿™é‡Œæˆ‘æ‰‹åŠ¨è¾“å…¥JSONä¹Ÿå¯ä»¥ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br><span class="line">1251</span><br><span class="line">1252</span><br><span class="line">1253</span><br><span class="line">1254</span><br><span class="line">1255</span><br><span class="line">1256</span><br><span class="line">1257</span><br><span class="line">1258</span><br><span class="line">1259</span><br><span class="line">1260</span><br><span class="line">1261</span><br><span class="line">1262</span><br><span class="line">1263</span><br><span class="line">1264</span><br><span class="line">1265</span><br><span class="line">1266</span><br><span class="line">1267</span><br><span class="line">1268</span><br><span class="line">1269</span><br><span class="line">1270</span><br><span class="line">1271</span><br><span class="line">1272</span><br><span class="line">1273</span><br><span class="line">1274</span><br><span class="line">1275</span><br><span class="line">1276</span><br><span class="line">1277</span><br><span class="line">1278</span><br><span class="line">1279</span><br><span class="line">1280</span><br><span class="line">1281</span><br><span class="line">1282</span><br><span class="line">1283</span><br><span class="line">1284</span><br><span class="line">1285</span><br><span class="line">1286</span><br><span class="line">1287</span><br><span class="line">1288</span><br><span class="line">1289</span><br><span class="line">1290</span><br><span class="line">1291</span><br><span class="line">1292</span><br><span class="line">1293</span><br><span class="line">1294</span><br><span class="line">1295</span><br><span class="line">1296</span><br><span class="line">1297</span><br><span class="line">1298</span><br><span class="line">1299</span><br><span class="line">1300</span><br><span class="line">1301</span><br><span class="line">1302</span><br><span class="line">1303</span><br><span class="line">1304</span><br><span class="line">1305</span><br><span class="line">1306</span><br><span class="line">1307</span><br><span class="line">1308</span><br><span class="line">1309</span><br><span class="line">1310</span><br><span class="line">1311</span><br><span class="line">1312</span><br><span class="line">1313</span><br><span class="line">1314</span><br><span class="line">1315</span><br><span class="line">1316</span><br><span class="line">1317</span><br><span class="line">1318</span><br><span class="line">1319</span><br><span class="line">1320</span><br><span class="line">1321</span><br><span class="line">1322</span><br><span class="line">1323</span><br><span class="line">1324</span><br><span class="line">1325</span><br><span class="line">1326</span><br><span class="line">1327</span><br><span class="line">1328</span><br><span class="line">1329</span><br><span class="line">1330</span><br><span class="line">1331</span><br><span class="line">1332</span><br><span class="line">1333</span><br><span class="line">1334</span><br><span class="line">1335</span><br><span class="line">1336</span><br><span class="line">1337</span><br><span class="line">1338</span><br><span class="line">1339</span><br><span class="line">1340</span><br><span class="line">1341</span><br><span class="line">1342</span><br><span class="line">1343</span><br><span class="line">1344</span><br><span class="line">1345</span><br><span class="line">1346</span><br><span class="line">1347</span><br><span class="line">1348</span><br><span class="line">1349</span><br><span class="line">1350</span><br><span class="line">1351</span><br><span class="line">1352</span><br><span class="line">1353</span><br><span class="line">1354</span><br><span class="line">1355</span><br><span class="line">1356</span><br><span class="line">1357</span><br><span class="line">1358</span><br><span class="line">1359</span><br><span class="line">1360</span><br><span class="line">1361</span><br><span class="line">1362</span><br><span class="line">1363</span><br><span class="line">1364</span><br><span class="line">1365</span><br><span class="line">1366</span><br><span class="line">1367</span><br><span class="line">1368</span><br><span class="line">1369</span><br><span class="line">1370</span><br><span class="line">1371</span><br><span class="line">1372</span><br><span class="line">1373</span><br><span class="line">1374</span><br><span class="line">1375</span><br><span class="line">1376</span><br><span class="line">1377</span><br><span class="line">1378</span><br><span class="line">1379</span><br><span class="line">1380</span><br><span class="line">1381</span><br><span class="line">1382</span><br><span class="line">1383</span><br><span class="line">1384</span><br><span class="line">1385</span><br><span class="line">1386</span><br><span class="line">1387</span><br><span class="line">1388</span><br><span class="line">1389</span><br><span class="line">1390</span><br><span class="line">1391</span><br><span class="line">1392</span><br><span class="line">1393</span><br><span class="line">1394</span><br><span class="line">1395</span><br><span class="line">1396</span><br><span class="line">1397</span><br><span class="line">1398</span><br><span class="line">1399</span><br><span class="line">1400</span><br><span class="line">1401</span><br><span class="line">1402</span><br><span class="line">1403</span><br><span class="line">1404</span><br><span class="line">1405</span><br><span class="line">1406</span><br><span class="line">1407</span><br><span class="line">1408</span><br><span class="line">1409</span><br><span class="line">1410</span><br><span class="line">1411</span><br><span class="line">1412</span><br><span class="line">1413</span><br><span class="line">1414</span><br><span class="line">1415</span><br><span class="line">1416</span><br><span class="line">1417</span><br><span class="line">1418</span><br><span class="line">1419</span><br><span class="line">1420</span><br><span class="line">1421</span><br><span class="line">1422</span><br><span class="line">1423</span><br><span class="line">1424</span><br><span class="line">1425</span><br><span class="line">1426</span><br><span class="line">1427</span><br><span class="line">1428</span><br><span class="line">1429</span><br><span class="line">1430</span><br><span class="line">1431</span><br><span class="line">1432</span><br><span class="line">1433</span><br><span class="line">1434</span><br><span class="line">1435</span><br><span class="line">1436</span><br><span class="line">1437</span><br><span class="line">1438</span><br><span class="line">1439</span><br><span class="line">1440</span><br><span class="line">1441</span><br><span class="line">1442</span><br><span class="line">1443</span><br><span class="line">1444</span><br><span class="line">1445</span><br><span class="line">1446</span><br><span class="line">1447</span><br><span class="line">1448</span><br><span class="line">1449</span><br><span class="line">1450</span><br><span class="line">1451</span><br><span class="line">1452</span><br><span class="line">1453</span><br><span class="line">1454</span><br><span class="line">1455</span><br><span class="line">1456</span><br><span class="line">1457</span><br><span class="line">1458</span><br><span class="line">1459</span><br><span class="line">1460</span><br><span class="line">1461</span><br><span class="line">1462</span><br><span class="line">1463</span><br><span class="line">1464</span><br><span class="line">1465</span><br><span class="line">1466</span><br><span class="line">1467</span><br><span class="line">1468</span><br><span class="line">1469</span><br><span class="line">1470</span><br><span class="line">1471</span><br><span class="line">1472</span><br><span class="line">1473</span><br><span class="line">1474</span><br><span class="line">1475</span><br><span class="line">1476</span><br><span class="line">1477</span><br><span class="line">1478</span><br><span class="line">1479</span><br><span class="line">1480</span><br><span class="line">1481</span><br><span class="line">1482</span><br><span class="line">1483</span><br><span class="line">1484</span><br><span class="line">1485</span><br><span class="line">1486</span><br><span class="line">1487</span><br><span class="line">1488</span><br><span class="line">1489</span><br><span class="line">1490</span><br><span class="line">1491</span><br><span class="line">1492</span><br><span class="line">1493</span><br><span class="line">1494</span><br><span class="line">1495</span><br><span class="line">1496</span><br><span class="line">1497</span><br><span class="line">1498</span><br><span class="line">1499</span><br><span class="line">1500</span><br><span class="line">1501</span><br><span class="line">1502</span><br><span class="line">1503</span><br><span class="line">1504</span><br><span class="line">1505</span><br><span class="line">1506</span><br><span class="line">1507</span><br><span class="line">1508</span><br><span class="line">1509</span><br><span class="line">1510</span><br><span class="line">1511</span><br><span class="line">1512</span><br><span class="line">1513</span><br><span class="line">1514</span><br><span class="line">1515</span><br><span class="line">1516</span><br><span class="line">1517</span><br><span class="line">1518</span><br><span class="line">1519</span><br><span class="line">1520</span><br><span class="line">1521</span><br><span class="line">1522</span><br><span class="line">1523</span><br><span class="line">1524</span><br><span class="line">1525</span><br><span class="line">1526</span><br><span class="line">1527</span><br><span class="line">1528</span><br><span class="line">1529</span><br><span class="line">1530</span><br><span class="line">1531</span><br><span class="line">1532</span><br><span class="line">1533</span><br><span class="line">1534</span><br><span class="line">1535</span><br><span class="line">1536</span><br><span class="line">1537</span><br><span class="line">1538</span><br><span class="line">1539</span><br><span class="line">1540</span><br><span class="line">1541</span><br><span class="line">1542</span><br><span class="line">1543</span><br><span class="line">1544</span><br><span class="line">1545</span><br><span class="line">1546</span><br><span class="line">1547</span><br><span class="line">1548</span><br><span class="line">1549</span><br><span class="line">1550</span><br><span class="line">1551</span><br><span class="line">1552</span><br><span class="line">1553</span><br><span class="line">1554</span><br><span class="line">1555</span><br><span class="line">1556</span><br><span class="line">1557</span><br><span class="line">1558</span><br><span class="line">1559</span><br><span class="line">1560</span><br><span class="line">1561</span><br><span class="line">1562</span><br><span class="line">1563</span><br><span class="line">1564</span><br><span class="line">1565</span><br><span class="line">1566</span><br><span class="line">1567</span><br><span class="line">1568</span><br><span class="line">1569</span><br><span class="line">1570</span><br><span class="line">1571</span><br><span class="line">1572</span><br><span class="line">1573</span><br><span class="line">1574</span><br><span class="line">1575</span><br><span class="line">1576</span><br><span class="line">1577</span><br><span class="line">1578</span><br><span class="line">1579</span><br><span class="line">1580</span><br><span class="line">1581</span><br><span class="line">1582</span><br><span class="line">1583</span><br><span class="line">1584</span><br><span class="line">1585</span><br><span class="line">1586</span><br><span class="line">1587</span><br><span class="line">1588</span><br><span class="line">1589</span><br><span class="line">1590</span><br><span class="line">1591</span><br><span class="line">1592</span><br><span class="line">1593</span><br><span class="line">1594</span><br><span class="line">1595</span><br><span class="line">1596</span><br><span class="line">1597</span><br><span class="line">1598</span><br><span class="line">1599</span><br><span class="line">1600</span><br><span class="line">1601</span><br><span class="line">1602</span><br><span class="line">1603</span><br><span class="line">1604</span><br><span class="line">1605</span><br><span class="line">1606</span><br><span class="line">1607</span><br><span class="line">1608</span><br><span class="line">1609</span><br><span class="line">1610</span><br><span class="line">1611</span><br><span class="line">1612</span><br><span class="line">1613</span><br><span class="line">1614</span><br><span class="line">1615</span><br><span class="line">1616</span><br><span class="line">1617</span><br><span class="line">1618</span><br><span class="line">1619</span><br><span class="line">1620</span><br><span class="line">1621</span><br><span class="line">1622</span><br><span class="line">1623</span><br><span class="line">1624</span><br><span class="line">1625</span><br><span class="line">1626</span><br><span class="line">1627</span><br><span class="line">1628</span><br><span class="line">1629</span><br><span class="line">1630</span><br><span class="line">1631</span><br><span class="line">1632</span><br><span class="line">1633</span><br><span class="line">1634</span><br><span class="line">1635</span><br><span class="line">1636</span><br><span class="line">1637</span><br><span class="line">1638</span><br><span class="line">1639</span><br><span class="line">1640</span><br><span class="line">1641</span><br><span class="line">1642</span><br><span class="line">1643</span><br><span class="line">1644</span><br><span class="line">1645</span><br><span class="line">1646</span><br><span class="line">1647</span><br><span class="line">1648</span><br><span class="line">1649</span><br><span class="line">1650</span><br><span class="line">1651</span><br><span class="line">1652</span><br><span class="line">1653</span><br><span class="line">1654</span><br><span class="line">1655</span><br><span class="line">1656</span><br><span class="line">1657</span><br><span class="line">1658</span><br><span class="line">1659</span><br><span class="line">1660</span><br><span class="line">1661</span><br><span class="line">1662</span><br><span class="line">1663</span><br><span class="line">1664</span><br><span class="line">1665</span><br><span class="line">1666</span><br><span class="line">1667</span><br><span class="line">1668</span><br><span class="line">1669</span><br><span class="line">1670</span><br><span class="line">1671</span><br><span class="line">1672</span><br><span class="line">1673</span><br><span class="line">1674</span><br><span class="line">1675</span><br><span class="line">1676</span><br><span class="line">1677</span><br><span class="line">1678</span><br><span class="line">1679</span><br><span class="line">1680</span><br><span class="line">1681</span><br><span class="line">1682</span><br><span class="line">1683</span><br><span class="line">1684</span><br><span class="line">1685</span><br><span class="line">1686</span><br><span class="line">1687</span><br><span class="line">1688</span><br><span class="line">1689</span><br><span class="line">1690</span><br><span class="line">1691</span><br><span class="line">1692</span><br><span class="line">1693</span><br><span class="line">1694</span><br><span class="line">1695</span><br><span class="line">1696</span><br><span class="line">1697</span><br><span class="line">1698</span><br><span class="line">1699</span><br><span class="line">1700</span><br><span class="line">1701</span><br><span class="line">1702</span><br><span class="line">1703</span><br><span class="line">1704</span><br><span class="line">1705</span><br><span class="line">1706</span><br><span class="line">1707</span><br><span class="line">1708</span><br><span class="line">1709</span><br><span class="line">1710</span><br><span class="line">1711</span><br><span class="line">1712</span><br><span class="line">1713</span><br><span class="line">1714</span><br><span class="line">1715</span><br><span class="line">1716</span><br><span class="line">1717</span><br><span class="line">1718</span><br><span class="line">1719</span><br><span class="line">1720</span><br><span class="line">1721</span><br><span class="line">1722</span><br><span class="line">1723</span><br><span class="line">1724</span><br><span class="line">1725</span><br><span class="line">1726</span><br><span class="line">1727</span><br><span class="line">1728</span><br><span class="line">1729</span><br><span class="line">1730</span><br><span class="line">1731</span><br><span class="line">1732</span><br><span class="line">1733</span><br><span class="line">1734</span><br><span class="line">1735</span><br><span class="line">1736</span><br><span class="line">1737</span><br><span class="line">1738</span><br><span class="line">1739</span><br><span class="line">1740</span><br><span class="line">1741</span><br><span class="line">1742</span><br><span class="line">1743</span><br><span class="line">1744</span><br><span class="line">1745</span><br><span class="line">1746</span><br><span class="line">1747</span><br><span class="line">1748</span><br><span class="line">1749</span><br><span class="line">1750</span><br><span class="line">1751</span><br><span class="line">1752</span><br><span class="line">1753</span><br><span class="line">1754</span><br><span class="line">1755</span><br><span class="line">1756</span><br><span class="line">1757</span><br><span class="line">1758</span><br><span class="line">1759</span><br><span class="line">1760</span><br><span class="line">1761</span><br><span class="line">1762</span><br><span class="line">1763</span><br><span class="line">1764</span><br><span class="line">1765</span><br><span class="line">1766</span><br><span class="line">1767</span><br><span class="line">1768</span><br><span class="line">1769</span><br><span class="line">1770</span><br><span class="line">1771</span><br><span class="line">1772</span><br><span class="line">1773</span><br><span class="line">1774</span><br><span class="line">1775</span><br><span class="line">1776</span><br><span class="line">1777</span><br><span class="line">1778</span><br><span class="line">1779</span><br><span class="line">1780</span><br><span class="line">1781</span><br><span class="line">1782</span><br><span class="line">1783</span><br><span class="line">1784</span><br><span class="line">1785</span><br><span class="line">1786</span><br><span class="line">1787</span><br><span class="line">1788</span><br><span class="line">1789</span><br><span class="line">1790</span><br><span class="line">1791</span><br><span class="line">1792</span><br><span class="line">1793</span><br><span class="line">1794</span><br><span class="line">1795</span><br><span class="line">1796</span><br><span class="line">1797</span><br><span class="line">1798</span><br><span class="line">1799</span><br><span class="line">1800</span><br><span class="line">1801</span><br><span class="line">1802</span><br><span class="line">1803</span><br><span class="line">1804</span><br><span class="line">1805</span><br><span class="line">1806</span><br><span class="line">1807</span><br><span class="line">1808</span><br><span class="line">1809</span><br><span class="line">1810</span><br><span class="line">1811</span><br><span class="line">1812</span><br><span class="line">1813</span><br><span class="line">1814</span><br><span class="line">1815</span><br><span class="line">1816</span><br><span class="line">1817</span><br><span class="line">1818</span><br><span class="line">1819</span><br><span class="line">1820</span><br><span class="line">1821</span><br><span class="line">1822</span><br><span class="line">1823</span><br><span class="line">1824</span><br><span class="line">1825</span><br><span class="line">1826</span><br><span class="line">1827</span><br><span class="line">1828</span><br><span class="line">1829</span><br><span class="line">1830</span><br><span class="line">1831</span><br><span class="line">1832</span><br><span class="line">1833</span><br><span class="line">1834</span><br><span class="line">1835</span><br><span class="line">1836</span><br><span class="line">1837</span><br><span class="line">1838</span><br><span class="line">1839</span><br><span class="line">1840</span><br><span class="line">1841</span><br><span class="line">1842</span><br><span class="line">1843</span><br><span class="line">1844</span><br><span class="line">1845</span><br><span class="line">1846</span><br><span class="line">1847</span><br><span class="line">1848</span><br><span class="line">1849</span><br><span class="line">1850</span><br><span class="line">1851</span><br><span class="line">1852</span><br><span class="line">1853</span><br><span class="line">1854</span><br><span class="line">1855</span><br><span class="line">1856</span><br><span class="line">1857</span><br><span class="line">1858</span><br><span class="line">1859</span><br><span class="line">1860</span><br><span class="line">1861</span><br><span class="line">1862</span><br><span class="line">1863</span><br><span class="line">1864</span><br><span class="line">1865</span><br><span class="line">1866</span><br><span class="line">1867</span><br><span class="line">1868</span><br><span class="line">1869</span><br><span class="line">1870</span><br><span class="line">1871</span><br><span class="line">1872</span><br><span class="line">1873</span><br><span class="line">1874</span><br><span class="line">1875</span><br><span class="line">1876</span><br><span class="line">1877</span><br><span class="line">1878</span><br><span class="line">1879</span><br><span class="line">1880</span><br><span class="line">1881</span><br><span class="line">1882</span><br><span class="line">1883</span><br><span class="line">1884</span><br><span class="line">1885</span><br><span class="line">1886</span><br><span class="line">1887</span><br><span class="line">1888</span><br><span class="line">1889</span><br><span class="line">1890</span><br><span class="line">1891</span><br><span class="line">1892</span><br><span class="line">1893</span><br><span class="line">1894</span><br><span class="line">1895</span><br><span class="line">1896</span><br><span class="line">1897</span><br><span class="line">1898</span><br><span class="line">1899</span><br><span class="line">1900</span><br><span class="line">1901</span><br><span class="line">1902</span><br><span class="line">1903</span><br><span class="line">1904</span><br><span class="line">1905</span><br><span class="line">1906</span><br><span class="line">1907</span><br><span class="line">1908</span><br><span class="line">1909</span><br><span class="line">1910</span><br><span class="line">1911</span><br><span class="line">1912</span><br><span class="line">1913</span><br><span class="line">1914</span><br><span class="line">1915</span><br><span class="line">1916</span><br><span class="line">1917</span><br><span class="line">1918</span><br><span class="line">1919</span><br><span class="line">1920</span><br><span class="line">1921</span><br><span class="line">1922</span><br><span class="line">1923</span><br><span class="line">1924</span><br><span class="line">1925</span><br><span class="line">1926</span><br><span class="line">1927</span><br><span class="line">1928</span><br><span class="line">1929</span><br><span class="line">1930</span><br><span class="line">1931</span><br><span class="line">1932</span><br><span class="line">1933</span><br><span class="line">1934</span><br><span class="line">1935</span><br><span class="line">1936</span><br><span class="line">1937</span><br><span class="line">1938</span><br><span class="line">1939</span><br><span class="line">1940</span><br><span class="line">1941</span><br><span class="line">1942</span><br><span class="line">1943</span><br><span class="line">1944</span><br><span class="line">1945</span><br><span class="line">1946</span><br><span class="line">1947</span><br><span class="line">1948</span><br><span class="line">1949</span><br><span class="line">1950</span><br><span class="line">1951</span><br><span class="line">1952</span><br><span class="line">1953</span><br><span class="line">1954</span><br><span class="line">1955</span><br><span class="line">1956</span><br><span class="line">1957</span><br><span class="line">1958</span><br><span class="line">1959</span><br><span class="line">1960</span><br><span class="line">1961</span><br><span class="line">1962</span><br><span class="line">1963</span><br><span class="line">1964</span><br><span class="line">1965</span><br><span class="line">1966</span><br><span class="line">1967</span><br><span class="line">1968</span><br><span class="line">1969</span><br><span class="line">1970</span><br><span class="line">1971</span><br><span class="line">1972</span><br><span class="line">1973</span><br><span class="line">1974</span><br><span class="line">1975</span><br><span class="line">1976</span><br><span class="line">1977</span><br><span class="line">1978</span><br><span class="line">1979</span><br><span class="line">1980</span><br><span class="line">1981</span><br><span class="line">1982</span><br><span class="line">1983</span><br><span class="line">1984</span><br><span class="line">1985</span><br><span class="line">1986</span><br><span class="line">1987</span><br><span class="line">1988</span><br><span class="line">1989</span><br><span class="line">1990</span><br><span class="line">1991</span><br><span class="line">1992</span><br><span class="line">1993</span><br><span class="line">1994</span><br><span class="line">1995</span><br><span class="line">1996</span><br><span class="line">1997</span><br><span class="line">1998</span><br><span class="line">1999</span><br><span class="line">2000</span><br><span class="line">2001</span><br><span class="line">2002</span><br><span class="line">2003</span><br><span class="line">2004</span><br><span class="line">2005</span><br><span class="line">2006</span><br><span class="line">2007</span><br><span class="line">2008</span><br><span class="line">2009</span><br><span class="line">2010</span><br><span class="line">2011</span><br><span class="line">2012</span><br><span class="line">2013</span><br><span class="line">2014</span><br><span class="line">2015</span><br><span class="line">2016</span><br><span class="line">2017</span><br><span class="line">2018</span><br><span class="line">2019</span><br><span class="line">2020</span><br><span class="line">2021</span><br><span class="line">2022</span><br><span class="line">2023</span><br><span class="line">2024</span><br><span class="line">2025</span><br><span class="line">2026</span><br><span class="line">2027</span><br><span class="line">2028</span><br><span class="line">2029</span><br><span class="line">2030</span><br><span class="line">2031</span><br><span class="line">2032</span><br><span class="line">2033</span><br><span class="line">2034</span><br><span class="line">2035</span><br><span class="line">2036</span><br><span class="line">2037</span><br><span class="line">2038</span><br><span class="line">2039</span><br><span class="line">2040</span><br><span class="line">2041</span><br><span class="line">2042</span><br><span class="line">2043</span><br><span class="line">2044</span><br><span class="line">2045</span><br><span class="line">2046</span><br><span class="line">2047</span><br><span class="line">2048</span><br><span class="line">2049</span><br><span class="line">2050</span><br><span class="line">2051</span><br><span class="line">2052</span><br><span class="line">2053</span><br><span class="line">2054</span><br><span class="line">2055</span><br><span class="line">2056</span><br><span class="line">2057</span><br><span class="line">2058</span><br><span class="line">2059</span><br><span class="line">2060</span><br><span class="line">2061</span><br><span class="line">2062</span><br><span class="line">2063</span><br><span class="line">2064</span><br><span class="line">2065</span><br><span class="line">2066</span><br><span class="line">2067</span><br><span class="line">2068</span><br><span class="line">2069</span><br><span class="line">2070</span><br><span class="line">2071</span><br><span class="line">2072</span><br><span class="line">2073</span><br><span class="line">2074</span><br><span class="line">2075</span><br><span class="line">2076</span><br><span class="line">2077</span><br><span class="line">2078</span><br><span class="line">2079</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;__inputs&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;DS_PROMETHEUS&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;label&quot;</span>: <span class="string">&quot;Prometheus&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;datasource&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;pluginId&quot;</span>: <span class="string">&quot;prometheus&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;pluginName&quot;</span>: <span class="string">&quot;Prometheus&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;__requires&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;panel&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;graph&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Graph&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;panel&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;singlestat&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Singlestat&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;grafana&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;grafana&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Grafana&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;3.1.1&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;datasource&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;prometheus&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Prometheus&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;1.3.0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;id&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Kubernetes cluster monitoring (via Prometheus)&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Monitors Kubernetes cluster using Prometheus. Shows overall cluster CPU / Memory / Filesystem usage as well as individual pod, containers, systemd services statistics. Uses cAdvisor metrics only.&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;tags&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;kubernetes&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;style&quot;</span>: <span class="string">&quot;dark&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;timezone&quot;</span>: <span class="string">&quot;browser&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;hideControls&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;sharedCrosshair&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;rows&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;collapse&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;200px&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;panels&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;aliasColors&quot;</span>: &#123;&#125;,</span><br><span class="line">          <span class="attr">&quot;bars&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;fill&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;grid&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;threshold1&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold1Color&quot;</span>: <span class="string">&quot;rgba(216, 200, 27, 0.27)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2Color&quot;</span>: <span class="string">&quot;rgba(234, 112, 112, 0.22)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdLine&quot;</span>: <span class="literal">false</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;200px&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">32</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;legend&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;alignAsTable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;avg&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;current&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;max&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;min&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;rightSide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;sideWidth&quot;</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="string">&quot;current&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;sortDesc&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;total&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;values&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;lines&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;linewidth&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;percentage&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;pointradius&quot;</span>: <span class="number">5</span>,</span><br><span class="line">          <span class="attr">&quot;points&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;renderer&quot;</span>: <span class="string">&quot;flot&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;seriesOverrides&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">&quot;stack&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;steppedLine&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_network_receive_bytes_total&#123;kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m]))&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;Received&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;network&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;- sum (rate (container_network_transmit_bytes_total&#123;kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m]))&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;Sent&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;network&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;B&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;timeFrom&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;timeShift&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Network I/O pressure&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;tooltip&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;msResolution&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;shared&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;value_type&quot;</span>: <span class="string">&quot;cumulative&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;transparent&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;graph&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;xaxis&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;yaxes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;Bps&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;Bps&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Network I/O pressure&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;collapse&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;250px&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;panels&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;cacheTimeout&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;colorBackground&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colorValue&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;colors&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;rgba(50, 172, 45, 0.97)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(237, 129, 40, 0.89)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(245, 54, 54, 0.9)&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;percent&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;gauge&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;maxValue&quot;</span>: <span class="number">100</span>,</span><br><span class="line">            <span class="attr">&quot;minValue&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdLabels&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdMarkers&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;180px&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">4</span>,</span><br><span class="line">          <span class="attr">&quot;interval&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;mappingType&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;mappingTypes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;value to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;range to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">2</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;maxDataPoints&quot;</span>: <span class="number">100</span>,</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;nullText&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;postfix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;postfixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;rangeMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;from&quot;</span>: <span class="string">&quot;null&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">4</span>,</span><br><span class="line">          <span class="attr">&quot;sparkline&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;fillColor&quot;</span>: <span class="string">&quot;rgba(31, 118, 189, 0.18)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;full&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;lineColor&quot;</span>: <span class="string">&quot;rgb(31, 120, 193)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (container_memory_working_set_bytes&#123;id=\&quot;/\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;) / sum (machine_memory_bytes&#123;kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;) * 100&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;thresholds&quot;</span>: <span class="string">&quot;65, 90&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Cluster memory usage&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;transparent&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;singlestat&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueFontSize&quot;</span>: <span class="string">&quot;80%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;op&quot;</span>: <span class="string">&quot;=&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;valueName&quot;</span>: <span class="string">&quot;current&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;cacheTimeout&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;colorBackground&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colorValue&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;colors&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;rgba(50, 172, 45, 0.97)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(237, 129, 40, 0.89)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(245, 54, 54, 0.9)&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;percent&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;gauge&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;maxValue&quot;</span>: <span class="number">100</span>,</span><br><span class="line">            <span class="attr">&quot;minValue&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdLabels&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdMarkers&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;180px&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">6</span>,</span><br><span class="line">          <span class="attr">&quot;interval&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;mappingType&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;mappingTypes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;value to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;range to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">2</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;maxDataPoints&quot;</span>: <span class="number">100</span>,</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;nullText&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;postfix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;postfixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;rangeMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;from&quot;</span>: <span class="string">&quot;null&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">4</span>,</span><br><span class="line">          <span class="attr">&quot;sparkline&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;fillColor&quot;</span>: <span class="string">&quot;rgba(31, 118, 189, 0.18)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;full&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;lineColor&quot;</span>: <span class="string">&quot;rgb(31, 120, 193)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_cpu_usage_seconds_total&#123;id=\&quot;/\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) / sum (machine_cpu_cores&#123;kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;) * 100&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;thresholds&quot;</span>: <span class="string">&quot;65, 90&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Cluster CPU usage (1m avg)&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;singlestat&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueFontSize&quot;</span>: <span class="string">&quot;80%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;op&quot;</span>: <span class="string">&quot;=&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;valueName&quot;</span>: <span class="string">&quot;current&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;cacheTimeout&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;colorBackground&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colorValue&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;colors&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;rgba(50, 172, 45, 0.97)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(237, 129, 40, 0.89)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(245, 54, 54, 0.9)&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;percent&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;gauge&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;maxValue&quot;</span>: <span class="number">100</span>,</span><br><span class="line">            <span class="attr">&quot;minValue&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdLabels&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdMarkers&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;180px&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">7</span>,</span><br><span class="line">          <span class="attr">&quot;interval&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;mappingType&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;mappingTypes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;value to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;range to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">2</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;maxDataPoints&quot;</span>: <span class="number">100</span>,</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;nullText&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;postfix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;postfixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;rangeMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;from&quot;</span>: <span class="string">&quot;null&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">4</span>,</span><br><span class="line">          <span class="attr">&quot;sparkline&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;fillColor&quot;</span>: <span class="string">&quot;rgba(31, 118, 189, 0.18)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;full&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;lineColor&quot;</span>: <span class="string">&quot;rgb(31, 120, 193)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (container_fs_usage_bytes&#123;device=~\&quot;^/dev/[sv]d[a-z][1-9]$\&quot;,id=\&quot;/\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;) / sum (container_fs_limit_bytes&#123;device=~\&quot;^/dev/[sv]d[a-z][1-9]$\&quot;,id=\&quot;/\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;) * 100&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;thresholds&quot;</span>: <span class="string">&quot;65, 90&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Cluster filesystem usage&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;singlestat&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueFontSize&quot;</span>: <span class="string">&quot;80%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;op&quot;</span>: <span class="string">&quot;=&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;valueName&quot;</span>: <span class="string">&quot;current&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;cacheTimeout&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;colorBackground&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colorValue&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colors&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;rgba(50, 172, 45, 0.97)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(237, 129, 40, 0.89)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(245, 54, 54, 0.9)&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;bytes&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;gauge&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;maxValue&quot;</span>: <span class="number">100</span>,</span><br><span class="line">            <span class="attr">&quot;minValue&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdLabels&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdMarkers&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;1px&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">9</span>,</span><br><span class="line">          <span class="attr">&quot;interval&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;mappingType&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;mappingTypes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;value to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;range to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">2</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;maxDataPoints&quot;</span>: <span class="number">100</span>,</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;nullText&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;postfix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;postfixFontSize&quot;</span>: <span class="string">&quot;20%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefixFontSize&quot;</span>: <span class="string">&quot;20%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;rangeMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;from&quot;</span>: <span class="string">&quot;null&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;sparkline&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;fillColor&quot;</span>: <span class="string">&quot;rgba(31, 118, 189, 0.18)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;full&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;lineColor&quot;</span>: <span class="string">&quot;rgb(31, 120, 193)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (container_memory_working_set_bytes&#123;id=\&quot;/\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;thresholds&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Used&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;singlestat&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;op&quot;</span>: <span class="string">&quot;=&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;valueName&quot;</span>: <span class="string">&quot;current&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;cacheTimeout&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;colorBackground&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colorValue&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colors&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;rgba(50, 172, 45, 0.97)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(237, 129, 40, 0.89)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(245, 54, 54, 0.9)&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;bytes&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;gauge&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;maxValue&quot;</span>: <span class="number">100</span>,</span><br><span class="line">            <span class="attr">&quot;minValue&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdLabels&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdMarkers&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;1px&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">10</span>,</span><br><span class="line">          <span class="attr">&quot;interval&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;mappingType&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;mappingTypes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;value to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;range to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">2</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;maxDataPoints&quot;</span>: <span class="number">100</span>,</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;nullText&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;postfix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;postfixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;rangeMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;from&quot;</span>: <span class="string">&quot;null&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;sparkline&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;fillColor&quot;</span>: <span class="string">&quot;rgba(31, 118, 189, 0.18)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;full&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;lineColor&quot;</span>: <span class="string">&quot;rgb(31, 120, 193)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (machine_memory_bytes&#123;kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;thresholds&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Total&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;singlestat&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;op&quot;</span>: <span class="string">&quot;=&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;valueName&quot;</span>: <span class="string">&quot;current&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;cacheTimeout&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;colorBackground&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colorValue&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colors&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;rgba(50, 172, 45, 0.97)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(237, 129, 40, 0.89)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(245, 54, 54, 0.9)&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;gauge&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;maxValue&quot;</span>: <span class="number">100</span>,</span><br><span class="line">            <span class="attr">&quot;minValue&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdLabels&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdMarkers&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;1px&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">11</span>,</span><br><span class="line">          <span class="attr">&quot;interval&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;mappingType&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;mappingTypes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;value to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;range to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">2</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;maxDataPoints&quot;</span>: <span class="number">100</span>,</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;nullText&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;postfix&quot;</span>: <span class="string">&quot; cores&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;postfixFontSize&quot;</span>: <span class="string">&quot;30%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;rangeMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;from&quot;</span>: <span class="string">&quot;null&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;sparkline&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;fillColor&quot;</span>: <span class="string">&quot;rgba(31, 118, 189, 0.18)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;full&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;lineColor&quot;</span>: <span class="string">&quot;rgb(31, 120, 193)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_cpu_usage_seconds_total&#123;id=\&quot;/\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m]))&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;thresholds&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Used&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;singlestat&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;op&quot;</span>: <span class="string">&quot;=&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;valueName&quot;</span>: <span class="string">&quot;current&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;cacheTimeout&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;colorBackground&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colorValue&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colors&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;rgba(50, 172, 45, 0.97)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(237, 129, 40, 0.89)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(245, 54, 54, 0.9)&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;gauge&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;maxValue&quot;</span>: <span class="number">100</span>,</span><br><span class="line">            <span class="attr">&quot;minValue&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdLabels&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdMarkers&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;1px&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">&quot;interval&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;mappingType&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;mappingTypes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;value to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;range to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">2</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;maxDataPoints&quot;</span>: <span class="number">100</span>,</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;nullText&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;postfix&quot;</span>: <span class="string">&quot; cores&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;postfixFontSize&quot;</span>: <span class="string">&quot;30%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;rangeMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;from&quot;</span>: <span class="string">&quot;null&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;sparkline&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;fillColor&quot;</span>: <span class="string">&quot;rgba(31, 118, 189, 0.18)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;full&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;lineColor&quot;</span>: <span class="string">&quot;rgb(31, 120, 193)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (machine_cpu_cores&#123;kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;thresholds&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Total&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;singlestat&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;op&quot;</span>: <span class="string">&quot;=&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;valueName&quot;</span>: <span class="string">&quot;current&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;cacheTimeout&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;colorBackground&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colorValue&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colors&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;rgba(50, 172, 45, 0.97)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(237, 129, 40, 0.89)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(245, 54, 54, 0.9)&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;bytes&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;gauge&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;maxValue&quot;</span>: <span class="number">100</span>,</span><br><span class="line">            <span class="attr">&quot;minValue&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdLabels&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdMarkers&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;1px&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">13</span>,</span><br><span class="line">          <span class="attr">&quot;interval&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;mappingType&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;mappingTypes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;value to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;range to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">2</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;maxDataPoints&quot;</span>: <span class="number">100</span>,</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;nullText&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;postfix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;postfixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;rangeMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;from&quot;</span>: <span class="string">&quot;null&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;sparkline&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;fillColor&quot;</span>: <span class="string">&quot;rgba(31, 118, 189, 0.18)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;full&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;lineColor&quot;</span>: <span class="string">&quot;rgb(31, 120, 193)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (container_fs_usage_bytes&#123;device=~\&quot;^/dev/[sv]d[a-z][1-9]$\&quot;,id=\&quot;/\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;thresholds&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Used&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;singlestat&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;op&quot;</span>: <span class="string">&quot;=&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;valueName&quot;</span>: <span class="string">&quot;current&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;cacheTimeout&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;colorBackground&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colorValue&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colors&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;rgba(50, 172, 45, 0.97)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(237, 129, 40, 0.89)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(245, 54, 54, 0.9)&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;bytes&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;gauge&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;maxValue&quot;</span>: <span class="number">100</span>,</span><br><span class="line">            <span class="attr">&quot;minValue&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdLabels&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdMarkers&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;1px&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">14</span>,</span><br><span class="line">          <span class="attr">&quot;interval&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;mappingType&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;mappingTypes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;value to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;range to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">2</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;maxDataPoints&quot;</span>: <span class="number">100</span>,</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;nullText&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;postfix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;postfixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;rangeMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;from&quot;</span>: <span class="string">&quot;null&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;sparkline&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;fillColor&quot;</span>: <span class="string">&quot;rgba(31, 118, 189, 0.18)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;full&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;lineColor&quot;</span>: <span class="string">&quot;rgb(31, 120, 193)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (container_fs_limit_bytes&#123;device=~\&quot;^/dev/[sv]d[a-z][1-9]$\&quot;,id=\&quot;/\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;thresholds&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Total&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;singlestat&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;op&quot;</span>: <span class="string">&quot;=&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;valueName&quot;</span>: <span class="string">&quot;current&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;showTitle&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Total usage&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;collapse&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;250px&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;panels&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;aliasColors&quot;</span>: &#123;&#125;,</span><br><span class="line">          <span class="attr">&quot;bars&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">3</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;fill&quot;</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="attr">&quot;grid&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;threshold1&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold1Color&quot;</span>: <span class="string">&quot;rgba(216, 200, 27, 0.27)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2Color&quot;</span>: <span class="string">&quot;rgba(234, 112, 112, 0.22)&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">17</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;legend&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;alignAsTable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;avg&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;current&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;max&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;min&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;rightSide&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="string">&quot;current&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;sortDesc&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;total&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;values&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;lines&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;linewidth&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;percentage&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;pointradius&quot;</span>: <span class="number">5</span>,</span><br><span class="line">          <span class="attr">&quot;points&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;renderer&quot;</span>: <span class="string">&quot;flot&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;seriesOverrides&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">&quot;stack&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;steppedLine&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_cpu_usage_seconds_total&#123;image!=\&quot;\&quot;,name=~\&quot;^k8s_.*\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (pod_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;&#123;&#123; pod_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;container_cpu&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;timeFrom&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;timeShift&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Pods CPU usage (1m avg)&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;tooltip&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;msResolution&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;shared&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;value_type&quot;</span>: <span class="string">&quot;cumulative&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;transparent&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;graph&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;xaxis&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;yaxes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="string">&quot;cores&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;short&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;showTitle&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Pods CPU usage&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;collapse&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;250px&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;panels&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;aliasColors&quot;</span>: &#123;&#125;,</span><br><span class="line">          <span class="attr">&quot;bars&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">3</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;fill&quot;</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="attr">&quot;grid&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;threshold1&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold1Color&quot;</span>: <span class="string">&quot;rgba(216, 200, 27, 0.27)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2Color&quot;</span>: <span class="string">&quot;rgba(234, 112, 112, 0.22)&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">23</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;legend&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;alignAsTable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;avg&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;current&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;max&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;min&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;rightSide&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="string">&quot;current&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;sortDesc&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;total&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;values&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;lines&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;linewidth&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;percentage&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;pointradius&quot;</span>: <span class="number">5</span>,</span><br><span class="line">          <span class="attr">&quot;points&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;renderer&quot;</span>: <span class="string">&quot;flot&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;seriesOverrides&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">&quot;stack&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;steppedLine&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_cpu_usage_seconds_total&#123;systemd_service_name!=\&quot;\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (systemd_service_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;hide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;&#123;&#123; systemd_service_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;container_cpu&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;timeFrom&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;timeShift&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;System services CPU usage (1m avg)&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;tooltip&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;msResolution&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;shared&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;value_type&quot;</span>: <span class="string">&quot;cumulative&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;graph&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;xaxis&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;yaxes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="string">&quot;cores&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;short&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;System services CPU usage&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;collapse&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;250px&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;panels&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;aliasColors&quot;</span>: &#123;&#125;,</span><br><span class="line">          <span class="attr">&quot;bars&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">3</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;fill&quot;</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="attr">&quot;grid&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;threshold1&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold1Color&quot;</span>: <span class="string">&quot;rgba(216, 200, 27, 0.27)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2Color&quot;</span>: <span class="string">&quot;rgba(234, 112, 112, 0.22)&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">24</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;legend&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;alignAsTable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;avg&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;current&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;hideEmpty&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;hideZero&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;max&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;min&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;rightSide&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sideWidth&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="string">&quot;current&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;sortDesc&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;total&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;values&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;lines&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;linewidth&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;percentage&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;pointradius&quot;</span>: <span class="number">5</span>,</span><br><span class="line">          <span class="attr">&quot;points&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;renderer&quot;</span>: <span class="string">&quot;flot&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;seriesOverrides&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">&quot;stack&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;steppedLine&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_cpu_usage_seconds_total&#123;image!=\&quot;\&quot;,name=~\&quot;^k8s_.*\&quot;,container_name!=\&quot;POD\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (container_name, pod_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;hide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;pod: &#123;&#123; pod_name &#125;&#125; | &#123;&#123; container_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;container_cpu&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_cpu_usage_seconds_total&#123;image!=\&quot;\&quot;,name!~\&quot;^k8s_.*\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (kubernetes_io_hostname, name, image)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;hide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;docker: &#123;&#123; kubernetes_io_hostname &#125;&#125; | &#123;&#123; image &#125;&#125; (&#123;&#123; name &#125;&#125;)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;container_cpu&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;B&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_cpu_usage_seconds_total&#123;rkt_container_name!=\&quot;\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (kubernetes_io_hostname, rkt_container_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;rkt: &#123;&#123; kubernetes_io_hostname &#125;&#125; | &#123;&#123; rkt_container_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;container_cpu&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;C&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;timeFrom&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;timeShift&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Containers CPU usage (1m avg)&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;tooltip&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;msResolution&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;shared&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;value_type&quot;</span>: <span class="string">&quot;cumulative&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;graph&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;xaxis&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;yaxes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="string">&quot;cores&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;short&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Containers CPU usage&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;collapse&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;500px&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;panels&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;aliasColors&quot;</span>: &#123;&#125;,</span><br><span class="line">          <span class="attr">&quot;bars&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">3</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;fill&quot;</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="attr">&quot;grid&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;threshold1&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold1Color&quot;</span>: <span class="string">&quot;rgba(216, 200, 27, 0.27)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2Color&quot;</span>: <span class="string">&quot;rgba(234, 112, 112, 0.22)&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">20</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;legend&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;alignAsTable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;avg&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;current&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;max&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;min&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;rightSide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="string">&quot;current&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;sortDesc&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;total&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;values&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;lines&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;linewidth&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;percentage&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;pointradius&quot;</span>: <span class="number">5</span>,</span><br><span class="line">          <span class="attr">&quot;points&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;renderer&quot;</span>: <span class="string">&quot;flot&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;seriesOverrides&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">&quot;stack&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;steppedLine&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_cpu_usage_seconds_total&#123;id!=\&quot;/\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (id)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;hide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;&#123;&#123; id &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;container_cpu&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;timeFrom&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;timeShift&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;All processes CPU usage (1m avg)&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;tooltip&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;msResolution&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;shared&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;value_type&quot;</span>: <span class="string">&quot;cumulative&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;graph&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;xaxis&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;yaxes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="string">&quot;cores&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;short&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;repeat&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">&quot;showTitle&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;All processes CPU usage&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;collapse&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;250px&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;panels&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;aliasColors&quot;</span>: &#123;&#125;,</span><br><span class="line">          <span class="attr">&quot;bars&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;fill&quot;</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="attr">&quot;grid&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;threshold1&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold1Color&quot;</span>: <span class="string">&quot;rgba(216, 200, 27, 0.27)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2Color&quot;</span>: <span class="string">&quot;rgba(234, 112, 112, 0.22)&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">25</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;legend&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;alignAsTable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;avg&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;current&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;max&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;min&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;rightSide&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sideWidth&quot;</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="string">&quot;current&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;sortDesc&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;total&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;values&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;lines&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;linewidth&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;percentage&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;pointradius&quot;</span>: <span class="number">5</span>,</span><br><span class="line">          <span class="attr">&quot;points&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;renderer&quot;</span>: <span class="string">&quot;flot&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;seriesOverrides&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">&quot;stack&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;steppedLine&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (container_memory_working_set_bytes&#123;image!=\&quot;\&quot;,name=~\&quot;^k8s_.*\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;) by (pod_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;&#123;&#123; pod_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;container_memory_usage:sort_desc&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;timeFrom&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;timeShift&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Pods memory usage&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;tooltip&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;msResolution&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;shared&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;value_type&quot;</span>: <span class="string">&quot;cumulative&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;graph&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;xaxis&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;yaxes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;bytes&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;short&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Pods memory usage&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;collapse&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;250px&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;panels&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;aliasColors&quot;</span>: &#123;&#125;,</span><br><span class="line">          <span class="attr">&quot;bars&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;fill&quot;</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="attr">&quot;grid&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;threshold1&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold1Color&quot;</span>: <span class="string">&quot;rgba(216, 200, 27, 0.27)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2Color&quot;</span>: <span class="string">&quot;rgba(234, 112, 112, 0.22)&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">26</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;legend&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;alignAsTable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;avg&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;current&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;max&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;min&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;rightSide&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sideWidth&quot;</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="string">&quot;current&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;sortDesc&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;total&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;values&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;lines&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;linewidth&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;percentage&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;pointradius&quot;</span>: <span class="number">5</span>,</span><br><span class="line">          <span class="attr">&quot;points&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;renderer&quot;</span>: <span class="string">&quot;flot&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;seriesOverrides&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">&quot;stack&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;steppedLine&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (container_memory_working_set_bytes&#123;systemd_service_name!=\&quot;\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;) by (systemd_service_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;&#123;&#123; systemd_service_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;container_memory_usage:sort_desc&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;timeFrom&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;timeShift&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;System services memory usage&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;tooltip&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;msResolution&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;shared&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;value_type&quot;</span>: <span class="string">&quot;cumulative&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;graph&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;xaxis&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;yaxes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;bytes&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;short&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;System services memory usage&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;collapse&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;250px&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;panels&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;aliasColors&quot;</span>: &#123;&#125;,</span><br><span class="line">          <span class="attr">&quot;bars&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;fill&quot;</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="attr">&quot;grid&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;threshold1&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold1Color&quot;</span>: <span class="string">&quot;rgba(216, 200, 27, 0.27)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2Color&quot;</span>: <span class="string">&quot;rgba(234, 112, 112, 0.22)&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">27</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;legend&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;alignAsTable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;avg&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;current&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;max&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;min&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;rightSide&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sideWidth&quot;</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="string">&quot;current&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;sortDesc&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;total&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;values&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;lines&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;linewidth&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;percentage&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;pointradius&quot;</span>: <span class="number">5</span>,</span><br><span class="line">          <span class="attr">&quot;points&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;renderer&quot;</span>: <span class="string">&quot;flot&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;seriesOverrides&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">&quot;stack&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;steppedLine&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (container_memory_working_set_bytes&#123;image!=\&quot;\&quot;,name=~\&quot;^k8s_.*\&quot;,container_name!=\&quot;POD\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;) by (container_name, pod_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;pod: &#123;&#123; pod_name &#125;&#125; | &#123;&#123; container_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;container_memory_usage:sort_desc&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (container_memory_working_set_bytes&#123;image!=\&quot;\&quot;,name!~\&quot;^k8s_.*\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;) by (kubernetes_io_hostname, name, image)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;docker: &#123;&#123; kubernetes_io_hostname &#125;&#125; | &#123;&#123; image &#125;&#125; (&#123;&#123; name &#125;&#125;)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;container_memory_usage:sort_desc&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;B&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (container_memory_working_set_bytes&#123;rkt_container_name!=\&quot;\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;) by (kubernetes_io_hostname, rkt_container_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;rkt: &#123;&#123; kubernetes_io_hostname &#125;&#125; | &#123;&#123; rkt_container_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;container_memory_usage:sort_desc&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;C&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;timeFrom&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;timeShift&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Containers memory usage&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;tooltip&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;msResolution&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;shared&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;value_type&quot;</span>: <span class="string">&quot;cumulative&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;graph&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;xaxis&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;yaxes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;bytes&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;short&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Containers memory usage&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;collapse&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;500px&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;panels&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;aliasColors&quot;</span>: &#123;&#125;,</span><br><span class="line">          <span class="attr">&quot;bars&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;fill&quot;</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="attr">&quot;grid&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;threshold1&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold1Color&quot;</span>: <span class="string">&quot;rgba(216, 200, 27, 0.27)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2Color&quot;</span>: <span class="string">&quot;rgba(234, 112, 112, 0.22)&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">28</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;legend&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;alignAsTable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;avg&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;current&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;max&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;min&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;rightSide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sideWidth&quot;</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="string">&quot;current&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;sortDesc&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;total&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;values&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;lines&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;linewidth&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;percentage&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;pointradius&quot;</span>: <span class="number">5</span>,</span><br><span class="line">          <span class="attr">&quot;points&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;renderer&quot;</span>: <span class="string">&quot;flot&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;seriesOverrides&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">&quot;stack&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;steppedLine&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (container_memory_working_set_bytes&#123;id!=\&quot;/\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;) by (id)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;&#123;&#123; id &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;container_memory_usage:sort_desc&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;timeFrom&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;timeShift&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;All processes memory usage&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;tooltip&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;msResolution&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;shared&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;value_type&quot;</span>: <span class="string">&quot;cumulative&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;graph&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;xaxis&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;yaxes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;bytes&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;short&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;All processes memory usage&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;collapse&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;250px&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;panels&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;aliasColors&quot;</span>: &#123;&#125;,</span><br><span class="line">          <span class="attr">&quot;bars&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;fill&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;grid&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;threshold1&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold1Color&quot;</span>: <span class="string">&quot;rgba(216, 200, 27, 0.27)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2Color&quot;</span>: <span class="string">&quot;rgba(234, 112, 112, 0.22)&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">16</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;legend&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;alignAsTable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;avg&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;current&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;max&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;min&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;rightSide&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sideWidth&quot;</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="string">&quot;current&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;sortDesc&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;total&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;values&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;lines&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;linewidth&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;percentage&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;pointradius&quot;</span>: <span class="number">5</span>,</span><br><span class="line">          <span class="attr">&quot;points&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;renderer&quot;</span>: <span class="string">&quot;flot&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;seriesOverrides&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">&quot;stack&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;steppedLine&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_network_receive_bytes_total&#123;image!=\&quot;\&quot;,name=~\&quot;^k8s_.*\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (pod_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;-&gt; &#123;&#123; pod_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;network&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;- sum (rate (container_network_transmit_bytes_total&#123;image!=\&quot;\&quot;,name=~\&quot;^k8s_.*\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (pod_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;&lt;- &#123;&#123; pod_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;network&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;B&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;timeFrom&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;timeShift&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Pods network I/O (1m avg)&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;tooltip&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;msResolution&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;shared&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;value_type&quot;</span>: <span class="string">&quot;cumulative&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;graph&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;xaxis&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;yaxes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;Bps&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;short&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Pods network I/O&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;collapse&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;250px&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;panels&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;aliasColors&quot;</span>: &#123;&#125;,</span><br><span class="line">          <span class="attr">&quot;bars&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;fill&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;grid&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;threshold1&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold1Color&quot;</span>: <span class="string">&quot;rgba(216, 200, 27, 0.27)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2Color&quot;</span>: <span class="string">&quot;rgba(234, 112, 112, 0.22)&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">30</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;legend&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;alignAsTable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;avg&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;current&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;max&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;min&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;rightSide&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sideWidth&quot;</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="string">&quot;current&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;sortDesc&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;total&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;values&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;lines&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;linewidth&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;percentage&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;pointradius&quot;</span>: <span class="number">5</span>,</span><br><span class="line">          <span class="attr">&quot;points&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;renderer&quot;</span>: <span class="string">&quot;flot&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;seriesOverrides&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">&quot;stack&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;steppedLine&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_network_receive_bytes_total&#123;image!=\&quot;\&quot;,name=~\&quot;^k8s_.*\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (container_name, pod_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;hide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;-&gt; pod: &#123;&#123; pod_name &#125;&#125; | &#123;&#123; container_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;network&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;B&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;- sum (rate (container_network_transmit_bytes_total&#123;image!=\&quot;\&quot;,name=~\&quot;^k8s_.*\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (container_name, pod_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;hide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;&lt;- pod: &#123;&#123; pod_name &#125;&#125; | &#123;&#123; container_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;network&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;D&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_network_receive_bytes_total&#123;image!=\&quot;\&quot;,name!~\&quot;^k8s_.*\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (kubernetes_io_hostname, name, image)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;hide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;-&gt; docker: &#123;&#123; kubernetes_io_hostname &#125;&#125; | &#123;&#123; image &#125;&#125; (&#123;&#123; name &#125;&#125;)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;network&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;- sum (rate (container_network_transmit_bytes_total&#123;image!=\&quot;\&quot;,name!~\&quot;^k8s_.*\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (kubernetes_io_hostname, name, image)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;hide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;&lt;- docker: &#123;&#123; kubernetes_io_hostname &#125;&#125; | &#123;&#123; image &#125;&#125; (&#123;&#123; name &#125;&#125;)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;network&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;C&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_network_transmit_bytes_total&#123;rkt_container_name!=\&quot;\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (kubernetes_io_hostname, rkt_container_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;hide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;-&gt; rkt: &#123;&#123; kubernetes_io_hostname &#125;&#125; | &#123;&#123; rkt_container_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;network&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;E&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;- sum (rate (container_network_transmit_bytes_total&#123;rkt_container_name!=\&quot;\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (kubernetes_io_hostname, rkt_container_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;hide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;&lt;- rkt: &#123;&#123; kubernetes_io_hostname &#125;&#125; | &#123;&#123; rkt_container_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;network&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;F&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;timeFrom&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;timeShift&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Containers network I/O (1m avg)&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;tooltip&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;msResolution&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;shared&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;value_type&quot;</span>: <span class="string">&quot;cumulative&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;graph&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;xaxis&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;yaxes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;Bps&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;short&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Containers network I/O&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;collapse&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;500px&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;panels&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;aliasColors&quot;</span>: &#123;&#125;,</span><br><span class="line">          <span class="attr">&quot;bars&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;fill&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;grid&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;threshold1&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold1Color&quot;</span>: <span class="string">&quot;rgba(216, 200, 27, 0.27)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2Color&quot;</span>: <span class="string">&quot;rgba(234, 112, 112, 0.22)&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">29</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;legend&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;alignAsTable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;avg&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;current&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;max&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;min&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;rightSide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sideWidth&quot;</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="string">&quot;current&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;sortDesc&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;total&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;values&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;lines&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;linewidth&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;percentage&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;pointradius&quot;</span>: <span class="number">5</span>,</span><br><span class="line">          <span class="attr">&quot;points&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;renderer&quot;</span>: <span class="string">&quot;flot&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;seriesOverrides&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">&quot;stack&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;steppedLine&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_network_receive_bytes_total&#123;id!=\&quot;/\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (id)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;-&gt; &#123;&#123; id &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;network&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;- sum (rate (container_network_transmit_bytes_total&#123;id!=\&quot;/\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (id)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;&lt;- &#123;&#123; id &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;network&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;B&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;timeFrom&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;timeShift&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;All processes network I/O (1m avg)&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;tooltip&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;msResolution&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;shared&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;value_type&quot;</span>: <span class="string">&quot;cumulative&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;graph&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;xaxis&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;yaxes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;Bps&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;short&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;All processes network I/O&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;time&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;from&quot;</span>: <span class="string">&quot;now-5m&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;now&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;timepicker&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;refresh_intervals&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;5s&quot;</span>,</span><br><span class="line">      <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">      <span class="string">&quot;30s&quot;</span>,</span><br><span class="line">      <span class="string">&quot;1m&quot;</span>,</span><br><span class="line">      <span class="string">&quot;5m&quot;</span>,</span><br><span class="line">      <span class="string">&quot;15m&quot;</span>,</span><br><span class="line">      <span class="string">&quot;30m&quot;</span>,</span><br><span class="line">      <span class="string">&quot;1h&quot;</span>,</span><br><span class="line">      <span class="string">&quot;2h&quot;</span>,</span><br><span class="line">      <span class="string">&quot;1d&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;time_options&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;5m&quot;</span>,</span><br><span class="line">      <span class="string">&quot;15m&quot;</span>,</span><br><span class="line">      <span class="string">&quot;1h&quot;</span>,</span><br><span class="line">      <span class="string">&quot;6h&quot;</span>,</span><br><span class="line">      <span class="string">&quot;12h&quot;</span>,</span><br><span class="line">      <span class="string">&quot;24h&quot;</span>,</span><br><span class="line">      <span class="string">&quot;2d&quot;</span>,</span><br><span class="line">      <span class="string">&quot;7d&quot;</span>,</span><br><span class="line">      <span class="string">&quot;30d&quot;</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;templating&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;list&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;allValue&quot;</span>: <span class="string">&quot;.*&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;current&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;hide&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;includeAll&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">&quot;multi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Node&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;options&quot;</span>: [],</span><br><span class="line">        <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;label_values(kubernetes_io_hostname)&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;refresh&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;query&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;annotations&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;list&quot;</span>: []</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;refresh&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;schemaVersion&quot;</span>: <span class="number">12</span>,</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="number">13</span>,</span><br><span class="line">  <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">  <span class="attr">&quot;gnetId&quot;</span>: <span class="number">315</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-06_11-50-15.png" alt="Snipaste_2020-12-06_11-50-15"></p><p>loadä¹‹åè¿˜éœ€è¦é€‰æ‹©ä¹‹é—´æ–°å¢çš„æ•°æ®æºprometheusã€‚å¯¼å…¥æ¨¡æ¿å®Œæˆã€‚</p><blockquote><p>æ³¨æ„</p><p>å¦‚æœæœ€åæ•°æ®ç»Ÿè®¡ä¸å‡ºæ¥ï¼Œè¯·æ³¨æ„æœ¬æœºã€Grafanaã€Prometheusçš„æ—¶åŒºæ˜¯ä¸æ˜¯ä¸€è‡´çš„ï¼Œè¦æ˜¯ä¸€æ ·çš„æ—¶é—´æ‰å¯ä»¥ã€‚</p></blockquote><h1 id="æ­å»ºé«˜å¯ç”¨çš„é›†ç¾¤"><a href="#æ­å»ºé«˜å¯ç”¨çš„é›†ç¾¤" class="headerlink" title="æ­å»ºé«˜å¯ç”¨çš„é›†ç¾¤"></a>æ­å»ºé«˜å¯ç”¨çš„é›†ç¾¤</h1><p>ä¹‹å‰1ä¸ªmasterã€2ä¸ªworkerçš„é›†ç¾¤æœ‰ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜ï¼Œè¿™ç§åªæœ‰1ä¸ªmasterçš„é›†ç¾¤çš„é€šç”¨é—®é¢˜å³å•ç‚¹æ•…éšœï¼Œå½“æˆ‘ä»¬çš„masterç”±äºæŸç§åŸå› å®•æœºä¹‹åï¼Œæ•´ä¸ªé›†ç¾¤å°±ä¼šåœæ­¢å·¥ä½œäº†ï¼Œæ²¡æœ‰äººæ¥æŒ‡æŒ¥äº†ã€‚</p><p>è¦æƒ³è§£å†³è¿™ä¸­é—®é¢˜ï¼Œé€šå¸¸æ–¹æ¡ˆæ˜¯å¯ç”¨å¤šä¸ªmasterï¼Œç„¶åå°±æ²¡æœ‰å•ç‚¹æ•…éšœé—®é¢˜äº†ï¼Œè‡³äºæ€ä¹ˆä½¿ç”¨å¤šä¸ªmasterä¸åŒçš„é›†ç¾¤æœ‰ä¸åŒçš„é€»è¾‘ï¼Œä¾‹å¦‚ï¼š</p><ul><li>Hadoopé›†ç¾¤æ˜¯active masterå’Œstandby masterï¼Œactive masterå®•æœºä¹‹åè¢«æ£€æµ‹åˆ°standby masterå°±åˆ‡æ¢ä¸ºactive master</li><li>k8sé›†ç¾¤æ˜¯å¤šä¸ªmasteréƒ½å®‰è£…äº†HAProxyæ’ä»¶ï¼Œworkeré€šè¿‡è™šæ‹ŸIPè¿æ¥åˆ°ä¸€å°masteræ—¶ï¼Œmasterçš„HAProxyä½¿ç”¨è´Ÿè½½å‡è¡¡å°†ä»»åŠ¡éšæœº(å¯è®¾ç½®è§„åˆ™)å‘é€ç»™ä»»ä¸€master</li></ul><blockquote><p>k8sä¸­çš„è™šæ‹ŸIPæ˜¯é€šè¿‡keepalivedå®ç°çš„ï¼Œkeepalivedå°†ä¸€è™šæ‹ŸIPåŒæ—¶ç»‘å®šåˆ°æ‰€æœ‰masterã€‚ä½†æ˜¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€å°masterå­˜åœ¨è¿™ä¸ªè™šæ‹ŸIPï¼Œåªæœ‰è¿™å°masterå®•æœºä¹‹åï¼Œè™šæ‹ŸIPæ‰ä¼šé£˜å‘å…¶ä»–è®¾ç½®äº†keepalivedçš„masterèŠ‚ç‚¹ã€‚</p></blockquote><p><strong>k8sé«˜å¯ç”¨é›†ç¾¤è°ƒç”¨å±•ç¤ºï¼š</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201209111646898.png" alt="image-20201209111646898"></p><p><strong>k8sé«˜å¯ç”¨é›†ç¾¤å„è§’è‰²ä»»åŠ¡å±•ç¤ºï¼š</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201209112543393.png" alt="image-20201209112543393"></p><p><strong>æŒ‚æ‰æ‹¥æœ‰vipçš„masterï¼Œvip(æ˜¯æŒ‡å®šçš„ä¸€ä¸ªå›ºå®šIP)ä¼šè‡ªåŠ¨é£˜å‘å…¶å®ƒmasterï¼Œkeepalivedå®ç°ï¼Œæ­¤æ—¶nodeä¼šè‡ªåŠ¨è¿æ¥vipï¼Œä½†æ­¤æ—¶æ‹¥æœ‰vipçš„èŠ‚ç‚¹å·²ç»æ˜¯å…¶ä»–masterï¼š</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201209112909081.png" alt="image-20201209112909081"></p><p>è‹¥æŒ‚æ‰æ²¡æœ‰VIPçš„èŠ‚ç‚¹ï¼Œåˆ™HAProxyä¸ä¼šå°†è¯·æ±‚è´Ÿè½½åˆ°æ­¤èŠ‚ç‚¹ä¸Šï¼Œå¯¹é›†ç¾¤åŠŸèƒ½æ²¡æœ‰å½±å“ã€‚</p><blockquote><p>é›†ç¾¤å†…å®ç°åŠŸèƒ½çš„å„ä¸ªç»„ä»¶ï¼š</p><ol><li>è´Ÿè½½å‡è¡¡-&gt;HAProxy</li><li>è™šæ‹ŸIP-&gt;keepalived</li></ol></blockquote><h2 id="å®‰è£…è¦æ±‚"><a href="#å®‰è£…è¦æ±‚" class="headerlink" title="å®‰è£…è¦æ±‚"></a>å®‰è£…è¦æ±‚</h2><p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œéƒ¨ç½²Kubernetesé›†ç¾¤æœºå™¨éœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶ï¼š</p><ul><li>ä¸€å°æˆ–å¤šå°æœºå™¨ï¼Œæ“ä½œç³»ç»Ÿ CentOS7.x-86_x64</li><li>ç¡¬ä»¶é…ç½®ï¼š2GBæˆ–æ›´å¤šRAMï¼Œ2ä¸ªCPUæˆ–æ›´å¤šCPUï¼Œç¡¬ç›˜30GBæˆ–æ›´å¤š</li><li>å¯ä»¥è®¿é—®å¤–ç½‘ï¼Œéœ€è¦æ‹‰å–é•œåƒï¼Œå¦‚æœæœåŠ¡å™¨ä¸èƒ½ä¸Šç½‘ï¼Œéœ€è¦æå‰ä¸‹è½½é•œåƒå¹¶å¯¼å…¥èŠ‚ç‚¹</li><li>ç¦æ­¢swapåˆ†åŒº</li></ul><h2 id="å‡†å¤‡ç¯å¢ƒ"><a href="#å‡†å¤‡ç¯å¢ƒ" class="headerlink" title="å‡†å¤‡ç¯å¢ƒ"></a>å‡†å¤‡ç¯å¢ƒ</h2><table><thead><tr><th>è§’è‰²</th><th>IP</th><th>keepalived</th><th>kubeadm init</th><th>docker</th></tr></thead><tbody><tr><td>master1</td><td>192.168.44.155</td><td>âˆš</td><td>âˆš</td><td>âˆš</td></tr><tr><td>master2</td><td>192.168.44.156</td><td>âˆš</td><td>åŠ å…¥</td><td>âˆš</td></tr><tr><td>node1</td><td>192.168.44.157</td><td></td><td>åŠ å…¥</td><td>âˆš</td></tr><tr><td>VIPï¼ˆè™šæ‹Ÿipï¼‰</td><td>192.168.44.158</td><td></td><td></td><td></td></tr></tbody></table><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å…³é—­é˜²ç«å¢™</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å…³é—­selinux</span></span><br><span class="line">sed -i &#x27;s/enforcing/disabled/&#x27; /etc/selinux/config  # æ°¸ä¹…</span><br><span class="line">setenforce 0  # ä¸´æ—¶</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å…³é—­swap</span></span><br><span class="line">swapoff -a  # ä¸´æ—¶</span><br><span class="line">sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab    # æ°¸ä¹…</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ ¹æ®è§„åˆ’è®¾ç½®ä¸»æœºå</span></span><br><span class="line">hostnamectl set-hostname &lt;hostname&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> åœ¨masteræ·»åŠ hosts</span></span><br><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line">192.168.44.158    master.k8s.io   k8s-vip</span><br><span class="line">192.168.44.155    master01.k8s.io master1</span><br><span class="line">192.168.44.156    master02.k8s.io master2</span><br><span class="line">192.168.44.157    node01.k8s.io   node1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å°†æ¡¥æ¥çš„IPv4æµé‡ä¼ é€’åˆ°iptablesçš„é“¾</span></span><br><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line">sysctl --system  # ç”Ÿæ•ˆ</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ—¶é—´åŒæ­¥</span></span><br><span class="line">yum install ntpdate -y</span><br><span class="line">ntpdate time.windows.com</span><br></pre></td></tr></table></figure><blockquote><p>Linux hosts</p><p>ä¸€èˆ¬æƒ…å†µä¸‹hostsæ–‡ä»¶çš„æ¯è¡Œå°¾ä¸€ä¸ªä¸»æœºï¼Œæ¯è¡Œç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œæ¯ä¸ªéƒ¨åˆ†ç”±ç©ºæ ¼éš”å¼€ã€‚</p><ol><li>ç½‘ç»œIPåœ°å€</li><li>ä¸»æœºåæˆ–åŸŸå</li><li>ä¸»æœºååˆ«å</li></ol></blockquote><h2 id="æ‰€æœ‰masterèŠ‚ç‚¹éƒ¨ç½²keepalived"><a href="#æ‰€æœ‰masterèŠ‚ç‚¹éƒ¨ç½²keepalived" class="headerlink" title="æ‰€æœ‰masterèŠ‚ç‚¹éƒ¨ç½²keepalived"></a>æ‰€æœ‰masterèŠ‚ç‚¹éƒ¨ç½²keepalived</h2><h3 id="å®‰è£…ç›¸å…³åŒ…å’Œkeepalived"><a href="#å®‰è£…ç›¸å…³åŒ…å’Œkeepalived" class="headerlink" title="å®‰è£…ç›¸å…³åŒ…å’Œkeepalived"></a>å®‰è£…ç›¸å…³åŒ…å’Œkeepalived</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y conntrack-tools libseccomp libtool-ltdl</span><br><span class="line"></span><br><span class="line">yum install -y keepalived</span><br></pre></td></tr></table></figure><h3 id="é…ç½®masterèŠ‚ç‚¹"><a href="#é…ç½®masterèŠ‚ç‚¹" class="headerlink" title="é…ç½®masterèŠ‚ç‚¹"></a>é…ç½®masterèŠ‚ç‚¹</h3><p>master1èŠ‚ç‚¹é…ç½®</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt;EOF </span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id k8s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_haproxy &#123;</span><br><span class="line">    script &quot;killall -0 haproxy&quot;</span><br><span class="line">    interval 3</span><br><span class="line">    weight -2</span><br><span class="line">    fall 10</span><br><span class="line">    rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER </span><br><span class="line">    interface ens33 </span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 250</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass ceb1b3ec013d66163d6ab</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.44.158</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_haproxy</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>master2èŠ‚ç‚¹é…ç½®</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt;EOF </span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id k8s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_haproxy &#123;</span><br><span class="line">    script &quot;killall -0 haproxy&quot;</span><br><span class="line">    interval 3</span><br><span class="line">    weight -2</span><br><span class="line">    fall 10</span><br><span class="line">    rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP </span><br><span class="line">    interface ens33 </span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 200</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass ceb1b3ec013d66163d6ab</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.44.158</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_haproxy</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201209114249444.png" alt="image-20201209114249444"></p><p><strong>é€šè¿‡å¯¹æ¯”ä¸Šé¢çš„å‘½ä»¤ï¼Œæ¥è¯´æ˜ä¸€ä¸‹é…ç½®æ–‡ä»¶çš„æ³¨æ„ç‚¹</strong></p><ol><li>master2çš„stateæ˜¯backupï¼Œmaster1æ˜¯masterã€‚æ‰€ä»¥ä¸€å¼€å§‹è™šæ‹ŸIP<code>192.168.44.158</code>ä¼šåœ¨master1ä¸Š</li><li>ä¸¤è€…çš„interfaceéƒ½è¦å†™è‡ªå·±èŠ‚ç‚¹çš„ç½‘å¡åï¼Œä¸€èˆ¬æ˜¯ens33</li><li>è¾“å…¥è‡ªå®šä¹‰çš„è™šæ‹ŸIPï¼Œè¦å’Œä½ è‡ªå·±èŠ‚ç‚¹çš„IPä¸€ä¸ªç½‘æ®µ</li></ol><h3 id="å¯åŠ¨å’Œæ£€æŸ¥"><a href="#å¯åŠ¨å’Œæ£€æŸ¥" class="headerlink" title="å¯åŠ¨å’Œæ£€æŸ¥"></a>å¯åŠ¨å’Œæ£€æŸ¥</h3><p>åœ¨ä¸¤å°masterèŠ‚ç‚¹éƒ½æ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯åŠ¨keepalived</span></span><br><span class="line">$ systemctl start keepalived.service</span><br><span class="line">è®¾ç½®å¼€æœºå¯åŠ¨</span><br><span class="line">$ systemctl <span class="built_in">enable</span> keepalived.service</span><br><span class="line"><span class="comment"># æŸ¥çœ‹å¯åŠ¨çŠ¶æ€</span></span><br><span class="line">$ systemctl status keepalived.service</span><br></pre></td></tr></table></figure><p>å¯åŠ¨åæŸ¥çœ‹master1çš„ç½‘å¡ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip a s ens33</span><br></pre></td></tr></table></figure><h2 id="éƒ¨ç½²haproxy"><a href="#éƒ¨ç½²haproxy" class="headerlink" title="éƒ¨ç½²haproxy"></a>éƒ¨ç½²haproxy</h2><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y haproxy</span><br></pre></td></tr></table></figure><h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><p>ä¸¤å°masterèŠ‚ç‚¹çš„é…ç½®å‡ç›¸åŒï¼Œé…ç½®ä¸­å£°æ˜äº†åç«¯ä»£ç†çš„ä¸¤ä¸ªmasterèŠ‚ç‚¹æœåŠ¡å™¨ï¼ŒæŒ‡å®šäº†haproxyè¿è¡Œçš„ç«¯å£ä¸º16443ç­‰ï¼Œå› æ­¤16443ç«¯å£ä¸ºé›†ç¾¤çš„å…¥å£</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/haproxy/haproxy.cfg &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="string"># Global settings</span></span><br><span class="line"><span class="string">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="string">global</span></span><br><span class="line"><span class="string">    # to have these messages end up in /var/log/haproxy.log you will</span></span><br><span class="line"><span class="string">    # need to:</span></span><br><span class="line"><span class="string">    # 1) configure syslog to accept network log events.  This is done</span></span><br><span class="line"><span class="string">    #    by adding the &#x27;-r&#x27; option to the SYSLOGD_OPTIONS in</span></span><br><span class="line"><span class="string">    #    /etc/sysconfig/syslog</span></span><br><span class="line"><span class="string">    # 2) configure local2 events to go to the /var/log/haproxy.log</span></span><br><span class="line"><span class="string">    #   file. A line like the following can be added to</span></span><br><span class="line"><span class="string">    #   /etc/sysconfig/syslog</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #    local2.*                       /var/log/haproxy.log</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    log         127.0.0.1 local2</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    chroot      /var/lib/haproxy</span></span><br><span class="line"><span class="string">    pidfile     /var/run/haproxy.pid</span></span><br><span class="line"><span class="string">    maxconn     4000</span></span><br><span class="line"><span class="string">    user        haproxy</span></span><br><span class="line"><span class="string">    group       haproxy</span></span><br><span class="line"><span class="string">    daemon </span></span><br><span class="line"><span class="string">       </span></span><br><span class="line"><span class="string">    # turn on stats unix socket</span></span><br><span class="line"><span class="string">    stats socket /var/lib/haproxy/stats</span></span><br><span class="line"><span class="string">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="string"># common defaults that all the &#x27;listen&#x27; and &#x27;backend&#x27; sections will</span></span><br><span class="line"><span class="string"># use if not designated in their block</span></span><br><span class="line"><span class="string">#---------------------------------------------------------------------  </span></span><br><span class="line"><span class="string">defaults</span></span><br><span class="line"><span class="string">    mode                    http</span></span><br><span class="line"><span class="string">    log                     global</span></span><br><span class="line"><span class="string">    option                  httplog</span></span><br><span class="line"><span class="string">    option                  dontlognull</span></span><br><span class="line"><span class="string">    option http-server-close</span></span><br><span class="line"><span class="string">    option forwardfor       except 127.0.0.0/8</span></span><br><span class="line"><span class="string">    option                  redispatch</span></span><br><span class="line"><span class="string">    retries                 3</span></span><br><span class="line"><span class="string">    timeout http-request    10s</span></span><br><span class="line"><span class="string">    timeout queue           1m</span></span><br><span class="line"><span class="string">    timeout connect         10s</span></span><br><span class="line"><span class="string">    timeout client          1m</span></span><br><span class="line"><span class="string">    timeout server          1m</span></span><br><span class="line"><span class="string">    timeout http-keep-alive 10s</span></span><br><span class="line"><span class="string">    timeout check           10s</span></span><br><span class="line"><span class="string">    maxconn                 3000</span></span><br><span class="line"><span class="string">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="string"># kubernetes apiserver frontend which proxys to the backends</span></span><br><span class="line"><span class="string">#--------------------------------------------------------------------- </span></span><br><span class="line"><span class="string">frontend kubernetes-apiserver</span></span><br><span class="line"><span class="string">    mode                 tcp</span></span><br><span class="line"><span class="string">    bind                 *:16443</span></span><br><span class="line"><span class="string">    option               tcplog</span></span><br><span class="line"><span class="string">    default_backend      kubernetes-apiserver    </span></span><br><span class="line"><span class="string">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="string"># round robin balancing between the various backends</span></span><br><span class="line"><span class="string">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="string">backend kubernetes-apiserver</span></span><br><span class="line"><span class="string">    mode        tcp</span></span><br><span class="line"><span class="string">    balance     roundrobin</span></span><br><span class="line"><span class="string">    server      master01.k8s.io   192.168.44.155:6443 check</span></span><br><span class="line"><span class="string">    server      master02.k8s.io   192.168.44.156:6443 check</span></span><br><span class="line"><span class="string">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="string"># collection haproxy statistics message</span></span><br><span class="line"><span class="string">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="string">listen stats</span></span><br><span class="line"><span class="string">    bind                 *:1080</span></span><br><span class="line"><span class="string">    stats auth           admin:awesomePassword</span></span><br><span class="line"><span class="string">    stats refresh        5s</span></span><br><span class="line"><span class="string">    stats realm          HAProxy\ Statistics</span></span><br><span class="line"><span class="string">    stats uri            /admin?stats</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„ä¿®æ”¹æ–‡ä»¶ä¸­çš„ä¸»æœºåå’ŒIPå°±è¡Œ</p><h3 id="å¯åŠ¨å’Œæ£€æŸ¥-1"><a href="#å¯åŠ¨å’Œæ£€æŸ¥-1" class="headerlink" title="å¯åŠ¨å’Œæ£€æŸ¥"></a>å¯åŠ¨å’Œæ£€æŸ¥</h3><p>ä¸¤å°masteréƒ½å¯åŠ¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®å¼€æœºå¯åŠ¨</span></span><br><span class="line">$ systemctl <span class="built_in">enable</span> haproxy</span><br><span class="line"><span class="comment"># å¼€å¯haproxy</span></span><br><span class="line">$ systemctl start haproxy</span><br><span class="line"><span class="comment"># æŸ¥çœ‹å¯åŠ¨çŠ¶æ€</span></span><br><span class="line">$ systemctl status haproxy</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥ç«¯å£</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -lntup|grep haproxy</span><br></pre></td></tr></table></figure><h2 id="æ‰€æœ‰èŠ‚ç‚¹å®‰è£…Docker-kubeadm-kubelet"><a href="#æ‰€æœ‰èŠ‚ç‚¹å®‰è£…Docker-kubeadm-kubelet" class="headerlink" title="æ‰€æœ‰èŠ‚ç‚¹å®‰è£…Docker/kubeadm/kubelet"></a>æ‰€æœ‰èŠ‚ç‚¹å®‰è£…Docker/kubeadm/kubelet</h2><p>Kubernetesé»˜è®¤CRIï¼ˆå®¹å™¨è¿è¡Œæ—¶ï¼‰ä¸ºDockerï¼Œå› æ­¤å…ˆå®‰è£…Dockerã€‚</p><h3 id="å®‰è£…Docker"><a href="#å®‰è£…Docker" class="headerlink" title="å®‰è£…Docker"></a>å®‰è£…Docker</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">$ yum -y install docker-ce-18.06.1.ce-3.el7</span><br><span class="line">$ systemctl <span class="built_in">enable</span> docker &amp;&amp; systemctl start docker</span><br><span class="line">$ docker --version</span><br><span class="line">Docker version 18.06.1-ce, build e68fc7a</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; /etc/docker/daemon.json &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;registry-mirrors&quot;: [&quot;https://b9pmyelo.mirror.aliyuncs.com&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h3 id="æ·»åŠ é˜¿é‡Œäº‘YUMè½¯ä»¶æº"><a href="#æ·»åŠ é˜¿é‡Œäº‘YUMè½¯ä»¶æº" class="headerlink" title="æ·»åŠ é˜¿é‡Œäº‘YUMè½¯ä»¶æº"></a>æ·»åŠ é˜¿é‡Œäº‘YUMè½¯ä»¶æº</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">repo_gpgcheck=0</span></span><br><span class="line"><span class="string">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h3 id="å®‰è£…kubeadmï¼Œkubeletå’Œkubectl"><a href="#å®‰è£…kubeadmï¼Œkubeletå’Œkubectl" class="headerlink" title="å®‰è£…kubeadmï¼Œkubeletå’Œkubectl"></a>å®‰è£…kubeadmï¼Œkubeletå’Œkubectl</h3><p>ç”±äºç‰ˆæœ¬æ›´æ–°é¢‘ç¹ï¼Œè¿™é‡ŒæŒ‡å®šç‰ˆæœ¬å·éƒ¨ç½²ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y kubelet-1.16.3 kubeadm-1.16.3 kubectl-1.16.3</span><br><span class="line">$ systemctl <span class="built_in">enable</span> kubelet</span><br></pre></td></tr></table></figure><h2 id="éƒ¨ç½²Kubernetes-Master"><a href="#éƒ¨ç½²Kubernetes-Master" class="headerlink" title="éƒ¨ç½²Kubernetes Master"></a>éƒ¨ç½²Kubernetes Master</h2><h3 id="åˆ›å»ºkubeadmé…ç½®æ–‡ä»¶"><a href="#åˆ›å»ºkubeadmé…ç½®æ–‡ä»¶" class="headerlink" title="åˆ›å»ºkubeadmé…ç½®æ–‡ä»¶"></a>åˆ›å»ºkubeadmé…ç½®æ–‡ä»¶</h3><p><strong>åœ¨å…·æœ‰vipçš„masterä¸Šæ“ä½œï¼Œè¿™é‡Œä¸ºmaster1</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir /usr/<span class="built_in">local</span>/kubernetes/manifests -p</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/kubernetes/manifests/</span><br><span class="line"></span><br><span class="line">$ vi kubeadm-config.yaml</span><br><span class="line"></span><br><span class="line">apiServer:</span><br><span class="line">  certSANs:</span><br><span class="line">    - master1</span><br><span class="line">    - master2</span><br><span class="line">    - master.k8s.io</span><br><span class="line">    - 192.168.44.158</span><br><span class="line">    - 192.168.44.155</span><br><span class="line">    - 192.168.44.156</span><br><span class="line">    - 127.0.0.1</span><br><span class="line">  extraArgs:</span><br><span class="line">    authorization-mode: Node,RBAC</span><br><span class="line">  timeoutForControlPlane: 4m0s</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta1</span><br><span class="line">certificatesDir: /etc/kubernetes/pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">controlPlaneEndpoint: <span class="string">&quot;master.k8s.io:16443&quot;</span></span><br><span class="line">controllerManager: &#123;&#125;</span><br><span class="line">dns: </span><br><span class="line">  <span class="built_in">type</span>: CoreDNS</span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:    </span><br><span class="line">    dataDir: /var/lib/etcd</span><br><span class="line">imageRepository: registry.aliyuncs.com/google_containers</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.16.3</span><br><span class="line">networking: </span><br><span class="line">  dnsDomain: cluster.local  </span><br><span class="line">  podSubnet: 10.244.0.0/16</span><br><span class="line">  serviceSubnet: 10.1.0.0/16</span><br><span class="line">scheduler: &#123;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201209142119717.png" alt="image-20201209142119717"></p><p>è¿™é‡Œéœ€è¦å¡«master1ï¼Œmaster2ï¼Œè™šæ‹ŸIPçš„ä¸»æœºåå’ŒIP</p><h3 id="åœ¨master1èŠ‚ç‚¹æ‰§è¡Œ"><a href="#åœ¨master1èŠ‚ç‚¹æ‰§è¡Œ" class="headerlink" title="åœ¨master1èŠ‚ç‚¹æ‰§è¡Œ"></a>åœ¨master1èŠ‚ç‚¹æ‰§è¡Œ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm init --config kubeadm-config.yaml</span><br></pre></td></tr></table></figure><p>æŒ‰ç…§æç¤ºé…ç½®ç¯å¢ƒå˜é‡ï¼Œä½¿ç”¨kubectlå·¥å…·ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">$ kubectl get nodes</span><br><span class="line">$ kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure><p><strong>æŒ‰ç…§æç¤ºä¿å­˜ä»¥ä¸‹å†…å®¹ï¼Œä¸€ä¼šè¦ä½¿ç”¨ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join master.k8s.io:16443 --token jv5z7n.3y1zi95p952y9p65 \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:403bca185c2f3a4791685013499e7ce58f9848e2213e27194b75a2e3293d8812 \</span><br><span class="line">    --control-plane </span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cs</span><br><span class="line"></span><br><span class="line">kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure><h2 id="master2èŠ‚ç‚¹åŠ å…¥é›†ç¾¤"><a href="#master2èŠ‚ç‚¹åŠ å…¥é›†ç¾¤" class="headerlink" title="master2èŠ‚ç‚¹åŠ å…¥é›†ç¾¤"></a>master2èŠ‚ç‚¹åŠ å…¥é›†ç¾¤</h2><h3 id="å¤åˆ¶å¯†é’¥åŠç›¸å…³æ–‡ä»¶"><a href="#å¤åˆ¶å¯†é’¥åŠç›¸å…³æ–‡ä»¶" class="headerlink" title="å¤åˆ¶å¯†é’¥åŠç›¸å…³æ–‡ä»¶"></a>å¤åˆ¶å¯†é’¥åŠç›¸å…³æ–‡ä»¶</h3><p>ä»master1å¤åˆ¶å¯†é’¥åŠç›¸å…³æ–‡ä»¶åˆ°master2</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ssh root@192.168.44.156 mkdir -p /etc/kubernetes/pki/etcd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># scp /etc/kubernetes/admin.conf root@192.168.44.156:/etc/kubernetes</span></span><br><span class="line">   </span><br><span class="line"><span class="comment"># scp /etc/kubernetes/pki/&#123;ca.*,sa.*,front-proxy-ca.*&#125; root@192.168.44.156:/etc/kubernetes/pki</span></span><br><span class="line">   </span><br><span class="line"><span class="comment"># scp /etc/kubernetes/pki/etcd/ca.* root@192.168.44.156:/etc/kubernetes/pki/etcd</span></span><br></pre></td></tr></table></figure><h3 id="master2åŠ å…¥é›†ç¾¤"><a href="#master2åŠ å…¥é›†ç¾¤" class="headerlink" title="master2åŠ å…¥é›†ç¾¤"></a>master2åŠ å…¥é›†ç¾¤</h3><p>æ‰§è¡Œåœ¨master1ä¸Šinitåè¾“å‡ºçš„joinå‘½ä»¤,éœ€è¦å¸¦ä¸Šå‚æ•°<code>--control-plane</code>è¡¨ç¤ºæŠŠmasteræ§åˆ¶èŠ‚ç‚¹åŠ å…¥é›†ç¾¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join master.k8s.io:16443 --token ckf7bs.30576l0okocepg8b     --discovery-token-ca-cert-hash sha256:19afac8b11182f61073e254fb57b9f19ab4d798b70501036fc69ebef46094aba --control-plane</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line"></span><br><span class="line">kubectl get pods --all-namespaces</span><br></pre></td></tr></table></figure><p><strong>æŒ‰ç…§åç»­æç¤ºï¼Œæ‰§è¡Œç›¸å…³å†…å®¹</strong></p><h2 id="åŠ å…¥Kubernetes-Node"><a href="#åŠ å…¥Kubernetes-Node" class="headerlink" title="åŠ å…¥Kubernetes Node"></a>åŠ å…¥Kubernetes Node</h2><p>åœ¨node1ä¸Šæ‰§è¡Œ</p><p>å‘é›†ç¾¤æ·»åŠ æ–°èŠ‚ç‚¹ï¼Œæ‰§è¡Œåœ¨kubeadm initè¾“å‡ºçš„kubeadm joinå‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join master.k8s.io:16443 --token ckf7bs.30576l0okocepg8b     --discovery-token-ca-cert-hash sha256:19afac8b11182f61073e254fb57b9f19ab4d798b70501036fc69ebef46094aba</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line"></span><br><span class="line">kubectl get pods --all-namespaces</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…é›†ç¾¤ç½‘ç»œ"><a href="#å®‰è£…é›†ç¾¤ç½‘ç»œ" class="headerlink" title="å®‰è£…é›†ç¾¤ç½‘ç»œ"></a>å®‰è£…é›†ç¾¤ç½‘ç»œ</h2><p>ä»å®˜æ–¹åœ°å€è·å–åˆ°flannelçš„yamlï¼Œåœ¨master1ä¸Šæ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir flannel</span><br><span class="line"><span class="built_in">cd</span> flannel</span><br><span class="line">wget -c https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure><p>å®‰è£…flannelç½‘ç»œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kube-flannel.yml </span><br></pre></td></tr></table></figure><p>æ£€æŸ¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure><h2 id="æµ‹è¯•kubernetesé›†ç¾¤"><a href="#æµ‹è¯•kubernetesé›†ç¾¤" class="headerlink" title="æµ‹è¯•kubernetesé›†ç¾¤"></a>æµ‹è¯•kubernetesé›†ç¾¤</h2><p>åœ¨Kubernetesé›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ªpodï¼ŒéªŒè¯æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create deployment nginx --image=nginx</span><br><span class="line">$ kubectl expose deployment nginx --port=80 --<span class="built_in">type</span>=NodePort</span><br><span class="line">$ kubectl get pod,svc</span><br></pre></td></tr></table></figure><p>è®¿é—®åœ°å€ï¼š<a href="http://NodeIP:Port">http://NodeIP:Port</a>  </p><h1 id="k8sé›†ç¾¤éƒ¨ç½²Javaé¡¹ç›®"><a href="#k8sé›†ç¾¤éƒ¨ç½²Javaé¡¹ç›®" class="headerlink" title="k8sé›†ç¾¤éƒ¨ç½²Javaé¡¹ç›®"></a>k8sé›†ç¾¤éƒ¨ç½²Javaé¡¹ç›®</h1><p>æˆ‘ä»¬çŸ¥é“k8sé›†ç¾¤æ˜¯ä»¥Podä¸ºåŸºæœ¬å•ä½çš„ï¼Œè€ŒPodæ˜¯å¤šä¸ªå®¹å™¨çš„ç»„åˆã€‚æ‰€ä»¥å¦‚æœå‘éƒ¨ç½²é¡¹ç›®åˆ°k8sé›†ç¾¤éœ€è¦é¦–å…ˆå°±æ˜‚é¡¹ç›®æºä»£ç é›†æˆä¸ºå®¹å™¨é•œåƒã€‚ç„¶ååœ¨k8sä¸Šéƒ¨ç½²å®¹å™¨æœåŠ¡ã€‚</p><h2 id="å®¹å™¨äº¤ä»˜æµç¨‹"><a href="#å®¹å™¨äº¤ä»˜æµç¨‹" class="headerlink" title="å®¹å™¨äº¤ä»˜æµç¨‹"></a>å®¹å™¨äº¤ä»˜æµç¨‹</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201210111801547.png" alt="image-20201210111801547"></p><h2 id="k8séƒ¨ç½²é¡¹ç›®æµç¨‹"><a href="#k8séƒ¨ç½²é¡¹ç›®æµç¨‹" class="headerlink" title="k8séƒ¨ç½²é¡¹ç›®æµç¨‹"></a>k8séƒ¨ç½²é¡¹ç›®æµç¨‹</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201210111902550.png" alt="image-20201210111902550"></p><h3 id="ç¼–å†™é¡¹ç›®"><a href="#ç¼–å†™é¡¹ç›®" class="headerlink" title="ç¼–å†™é¡¹ç›®"></a>ç¼–å†™é¡¹ç›®</h3><p>åˆ›å»ºä¸€ä¸ªspringbooté¡¹ç›®</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-09_20-49-49.png" alt="Snipaste_2020-12-09_20-49-49"></p><p><strong>ç¼–å†™Dockerfile</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-09_20-55-52.png"></p><h3 id="åˆ›å»ºç¬¬ä¸‰æ–¹ä»“åº“"><a href="#åˆ›å»ºç¬¬ä¸‰æ–¹ä»“åº“" class="headerlink" title="åˆ›å»ºç¬¬ä¸‰æ–¹ä»“åº“"></a>åˆ›å»ºç¬¬ä¸‰æ–¹ä»“åº“</h3><p>æ¨é€æ•°æ®åˆ°ç¬¬ä¸‰æ–¹ä»“åº“ï¼Œè¿™é‡Œé€‰æ‹©é˜¿é‡Œäº‘ã€‚ä¹Ÿå¯ä»¥è‡ªå·±æ­å»ºdockerä»“åº“</p><p><a href="https://cn.aliyun.com/product/containerservice">https://cn.aliyun.com/product/containerservice</a></p><p><strong>1. åˆ›å»ºå‘½åç©ºé—´</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-09_20-59-46.png"></p><p><strong>2. åˆ›å»ºä»“åº“</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-09_21-01-01.png"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-09_21-01-09.png"></p><h3 id="æ¨é€é•œåƒ"><a href="#æ¨é€é•œåƒ" class="headerlink" title="æ¨é€é•œåƒ"></a><strong>æ¨é€é•œåƒ</strong></h3><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-09_21-01-50.png"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-09_21-12-11.png"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-09_21-12-27.png"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-09_21-18-17.png"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-09_21-19-00.png" alt="Snipaste_2020-12-09_21-19-00"></p><h3 id="é¡¹ç›®éƒ¨ç½²"><a href="#é¡¹ç›®éƒ¨ç½²" class="headerlink" title="é¡¹ç›®éƒ¨ç½²"></a>é¡¹ç›®éƒ¨ç½²</h3><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-10_22-10-42.png" alt="Snipaste_2020-12-10_22-10-42"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-10_22-08-07.png" alt="Snipaste_2020-12-10_22-08-07"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;k8sé›†ç¾¤ç›‘æ§&quot;&gt;&lt;a href=&quot;#k8sé›†ç¾¤ç›‘æ§&quot; class=&quot;headerlink&quot; title=&quot;k8sé›†ç¾¤ç›‘æ§&quot;&gt;&lt;/a&gt;k8sé›†ç¾¤ç›‘æ§&lt;/h1&gt;&lt;p&gt;æ—¢ç„¶æ˜¯ç›‘æ§k8sçš„é›†ç¾¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦å®æ—¶è·å–k8sé›†ç¾¤çš„å“ªäº›ä¿¡æ¯å‘¢ï¼Ÿå³æˆ‘ä»¬çš„ç›‘æ§æŒ‡æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ&lt;/p&gt;</summary>
      
    
    
    
    <category term="Kubernetes" scheme="https://awslzhang.top/categories/Kubernetes/"/>
    
    
    <category term="Docker" scheme="https://awslzhang.top/tags/Docker/"/>
    
    <category term="Kubernetes" scheme="https://awslzhang.top/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>æµ…è°ˆHttps</title>
    <link href="https://awslzhang.top/2020/11/21/%E6%B5%85%E8%B0%88Https/"/>
    <id>https://awslzhang.top/2020/11/21/%E6%B5%85%E8%B0%88Https/</id>
    <published>2020-11-21T01:10:13.000Z</published>
    <updated>2021-01-01T05:50:00.099Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><h2 id="Http"><a href="#Http" class="headerlink" title="Http"></a>Http</h2><p>HyperText Transfer Protocolï¼Œè¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼Œæ˜¯äº’è”ç½‘ä¸Šä½¿ç”¨æœ€å¹¿æ³›çš„ä¸€ç§åè®®ï¼Œæ‰€æœ‰WWWæ–‡ä»¶å¿…é¡»éµå¾ªçš„æ ‡å‡†ã€‚HTTPåè®®ä¼ è¾“çš„æ•°æ®éƒ½æ˜¯æœªåŠ å¯†çš„ï¼Œä¹Ÿå°±æ˜¯æ˜æ–‡çš„ï¼Œå› æ­¤ä½¿ç”¨HTTPåè®®ä¼ è¾“éšç§ä¿¡æ¯éå¸¸ä¸å®‰å…¨ã€‚</p><p>ä½¿ç”¨TCPç«¯å£ä¸ºï¼š80</p><h2 id="Https"><a href="#Https" class="headerlink" title="Https"></a>Https</h2><p>Hyper Text Transfer Protocol over Secure Socket Layerï¼Œå®‰å…¨çš„è¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼Œç½‘æ™¯å…¬å¼è®¾è®¡äº†SSL(Secure Sockets Layer)åè®®ç”¨äºå¯¹Httpåè®®ä¼ è¾“çš„æ•°æ®è¿›è¡ŒåŠ å¯†ï¼Œä¿è¯ä¼šè¯è¿‡ç¨‹ä¸­çš„å®‰å…¨æ€§ã€‚</p><p>ä½¿ç”¨TCPç«¯å£é»˜è®¤ä¸º443</p><hr><p>HTTPS åè®®æ ˆä¸ HTTP çš„å”¯ä¸€åŒºåˆ«åœ¨äºå¤šäº†ä¸€ä¸ªå®‰å…¨å±‚ï¼ˆSecurity Layerï¼‰â€”â€” TLS/SSLï¼ŒSSL æ˜¯æœ€æ—©çš„å®‰å…¨å±‚åè®®ï¼ŒTLS ç”± SSL å‘å±•è€Œæ¥ï¼Œæ‰€ä»¥ä¸‹é¢æˆ‘ä»¬ç»Ÿç§° TLSã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/v2-29fee3e54e584905453e69c3df133e05_720w.jpg" alt="img"></p><p>åŸæ¥HTTPSå°±æ˜¯åœ¨HTTPåè®®çš„åŸºç¡€ä¸ŠåŠ å…¥äº†TLSåè®®ã€‚ç›®çš„æ˜¯ä¿è¯æˆ‘ä»¬çš„æ•°æ®åœ¨ç½‘ç»œä¸Šä¼ è¾“çš„å®‰å…¨æ€§ã€‚</p><p><strong>ä»€ä¹ˆæ˜¯TLSï¼Ÿ</strong></p><blockquote><p>TLSæ˜¯ä¼ è¾“å±‚åŠ å¯†åè®®ï¼Œå‰èº«æ˜¯SSLåè®®ã€‚ç”±ç½‘æ™¯å…¬å¸äº1995å¹´å‘å¸ƒã€‚åæ”¹åä¸ºTLSã€‚å¸¸ç”¨çš„ TLS åè®®ç‰ˆæœ¬æœ‰ï¼šTLS1.2, TLS1.1, TLS1.0 å’Œ SSL3.0ã€‚å…¶ä¸­ SSL3.0 ç”±äº POODLE æ”»å‡»å·²ç»è¢«è¯æ˜ä¸å®‰å…¨ã€‚TLS1.0 ä¹Ÿå­˜åœ¨éƒ¨åˆ†å®‰å…¨æ¼æ´ï¼Œæ¯”å¦‚ RC4 å’Œ BEAST æ”»å‡»ã€‚</p></blockquote><h1 id="æ•°å­—è¯ä¹¦"><a href="#æ•°å­—è¯ä¹¦" class="headerlink" title="æ•°å­—è¯ä¹¦"></a>æ•°å­—è¯ä¹¦</h1><p>TLS æ¡æ‰‹çš„ä½œç”¨ä¹‹ä¸€æ˜¯èº«ä»½è®¤è¯ï¼ˆauthenticationï¼‰ï¼Œè¢«éªŒè¯çš„ä¸€æ–¹éœ€è¦æä¾›ä¸€ä¸ªèº«ä»½è¯æ˜ï¼Œåœ¨ HTTPS çš„ä¸–ç•Œé‡Œï¼Œè¿™ä¸ªèº«ä»½è¯æ˜å°±æ˜¯ ã€ŒTLS è¯ä¹¦ã€ï¼Œæˆ–è€…ç§°ä¸º ã€ŒHTTPS è¯ä¹¦ã€ã€‚</p><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨è®¿é—®xxxxæ—¶ï¼Œæµè§ˆå™¨ä¼šå¾—åˆ°ä¸€ä¸ª TLS è¯ä¹¦ï¼Œè¿™ä¸ªæ•°å­—è¯ä¹¦ç”¨äºè¯æ˜æˆ‘ä»¬æ­£åœ¨è®¿é—®çš„ç½‘ç«™å’Œè¯ä¹¦çš„æŒæœ‰è€…æ˜¯åŒ¹é…çš„ï¼Œå¦åˆ™å› ä¸ºèº«ä»½è®¤è¯æ— æ³•é€šè¿‡ï¼Œè¿æ¥ä¹Ÿå°±æ— æ³•å»ºç«‹ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201121091912788.png" alt="image-20201121091912788"></p><p>ä¸Šä¾‹å¯ä»¥çœ‹å‡ºï¼Œæµè§ˆå™¨å¾—åˆ°çš„æ˜¯ä¸€ä¸ªè¯ä¹¦çš„é“¾è¡¨ï¼Œè¿™ä¸ªé“¾è¡¨å«è¯ä¹¦é“¾ï¼ˆCertificate Chainï¼‰ï¼Œæˆ‘ä»¬åé¢ä¼šåˆ†æå®ƒçš„ä½œç”¨ã€‚</p><h2 id="è¯ä¹¦é“¾"><a href="#è¯ä¹¦é“¾" class="headerlink" title="è¯ä¹¦é“¾"></a>è¯ä¹¦é“¾</h2><p>ä¸Šå›¾çš„å±‚çº§ç»“æ„å°±æ˜¯è¯ä¹¦é“¾ã€‚</p><p>å½“è·å¾—è¯ä¹¦é“¾ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾ˆè½»æ¾çš„å¾€ä¸Šå›æº¯åˆ°è¢« UA ä¿¡ä»»çš„è¯ä¹¦ï¼Œè™½ç„¶ UA å†…ç½®çš„å¯èƒ½æ˜¯ä¸­é—´è¯ä¹¦ï¼ˆIntermediate Certificateï¼‰ï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ª End-Entity è¯ä¹¦å³ä½¿å›æº¯åˆ°è·Ÿè¯ä¹¦ï¼ˆRoot Certificateï¼‰ä¹Ÿæ²¡æœ‰åœ¨ UA çš„å—ä¿¡åˆ—è¡¨ä¸­æ‰¾åˆ°ï¼Œé‚£ä¹ˆè¿™ä¸ªç«™ç‚¹å°±ä¼šè¢«æ ‡è®°ä¸ºä¸å®‰å…¨ã€‚</p><p>æœ€ä¸Šå±‚çš„éƒ½æ˜¯è·Ÿè¯ä¹¦ï¼Œè¿™äº›è¯ä¹¦éœ€è¦å­˜åœ¨äºæµè§ˆå™¨çš„å—ä¿¡åˆ—è¡¨ä¸­ï¼Œå¦åˆ™é“¾æ¥ä¸å®‰å…¨ã€‚</p><h2 id="HTTPSè¯·æ±‚è¿‡ç¨‹"><a href="#HTTPSè¯·æ±‚è¿‡ç¨‹" class="headerlink" title="HTTPSè¯·æ±‚è¿‡ç¨‹"></a>HTTPSè¯·æ±‚è¿‡ç¨‹</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1704743ced98df13"></p><h2 id="ä¸­é—´äººæ”»å‡»"><a href="#ä¸­é—´äººæ”»å‡»" class="headerlink" title="ä¸­é—´äººæ”»å‡»"></a>ä¸­é—´äººæ”»å‡»</h2><p>è¯·æŸ¥çœ‹ä¸­é—´äººæ”»å‡»åŸç†ï¼š<a href="https://juejin.cn/post/6844904065227292685#heading-11">https://juejin.cn/post/6844904065227292685#heading-11</a></p><blockquote><p>ä»¥ä¸Šæ€»ç»“æ”»å‡»çš„æ¡ä»¶ï¼š</p><ol><li>é¦–å…ˆæ”»å‡»è€…éœ€è¦æˆªå–åˆ°ä½ çš„è¯·æ±‚ï¼Œç°åœ¨é™¤äº†åœ¨æœ¬æœºä½¿ç”¨fiddler/wiresharkï¼Œæˆ‘æƒ³ä¸åˆ°å…¶ä»–çš„æ–¹å¼</li><li>å¦‚æœé‡‡ç”¨fiddler/wiresharkéœ€è¦æ‰‹åŠ¨ä¿¡ä»»ä»–ä»¬çš„è¯ä¹¦</li><li>å¦‚æœç¬¬ä¸‰æ–¹èƒ½åœ¨ç½‘ç»œä¸­æˆªå–ä½ çš„è¯·æ±‚ï¼Œæˆ‘æƒ³ä¸åˆ°æ–¹æ³•ï¼Œå¯èƒ½ä¹Ÿæœ‰</li></ol></blockquote><h2 id="é˜²èŒƒä¸­é—´äººæ”»å‡»"><a href="#é˜²èŒƒä¸­é—´äººæ”»å‡»" class="headerlink" title="é˜²èŒƒä¸­é—´äººæ”»å‡»"></a>é˜²èŒƒä¸­é—´äººæ”»å‡»</h2><p>å¯æŸ¥çœ‹ï¼š<a href="https://www.zhihu.com/question/65464646">https://www.zhihu.com/question/65464646</a></p><p>HTTPSæ˜¯ä¿æŠ¤ç”¨æˆ·å’ŒæœåŠ¡å™¨ä¹‹é—´çš„é€šè®¯ä¸è¢«ç¬¬ä¸‰æ–¹çªƒå–æˆ–è€…ç¯¡æ”¹ã€‚è¿™ä¸ªç¬¬ä¸‰æ–¹æ”»å‡»è€…æ‰æ˜¯ä¸­é—´äººã€‚å¯¹äºç”¨æˆ·å¯¹å®¢æˆ·ç«¯é€»è¾‘çš„é€†å‘å’Œç¯¡æ”¹ï¼ŒHTTPSæ˜¯ä¸èƒ½èµ·åˆ°é˜²æŠ¤ä½œç”¨çš„ã€‚<strong>æ‰€ä»¥ç”¨æˆ·é€šè¿‡æŠ“å–è¯·æ±‚çš„è½¯ä»¶é€šè¿‡ä½¿è‡ªå·±ç”µè„‘ä¿¡ä»»(æ‰‹åŠ¨å¯¼å…¥DHçš„å‚æ•°)æŠ“å–è¯·æ±‚è½¯ä»¶çš„è¯ä¹¦è¿˜æ˜¯å¯ä»¥è§£å¯†httpsçš„</strong></p><blockquote><p>HTTPSä¼šè¢«æŠ“åŒ…ï¼ŒHTTPS åªé˜²æ­¢ç”¨æˆ·åœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹é€šä¿¡è¢«ç›‘å¬ï¼Œå¦‚æœç”¨æˆ·ä¸»åŠ¨æˆä¿¡ï¼Œæ˜¯å¯ä»¥æ„å»ºâ€œä¸­é—´äººâ€ç½‘ç»œï¼Œä»£ç†è½¯ä»¶å¯ä»¥å¯¹ä¼ è¾“å†…å®¹è¿›è¡Œè§£å¯†ã€‚</p></blockquote><h1 id="ä½¿ç”¨Httpsè®¿é—®é¡¹ç›®"><a href="#ä½¿ç”¨Httpsè®¿é—®é¡¹ç›®" class="headerlink" title="ä½¿ç”¨Httpsè®¿é—®é¡¹ç›®"></a>ä½¿ç”¨Httpsè®¿é—®é¡¹ç›®</h1><h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><p>é¡¹ç›®é‡‡ç”¨spring boot</p><ul><li>Java</li><li>maven</li><li>éƒ¨ç½²æœåŠ¡çš„vpsä¸€å°ï¼Œä¸ºäº†æ¨¡æ‹ŸçœŸå®ï¼Œé‡‡ç”¨çš„å…¬ç½‘IPï¼Œå¹¶å°†åŸŸåæ·»åŠ å®ƒçš„Aè®°å½•ã€‚</li><li>è¯ä¹¦ï¼Œé¢å‘ç»™åŸŸåã€‚</li></ul><p>è¯ä¹¦ç”³è¯·ï¼š<a href="https://blog.walterlv.com/post/apply-for-free-ssl-certificates-using-freessl.html">https://blog.walterlv.com/post/apply-for-free-ssl-certificates-using-freessl.html</a></p><p>åœ¨åˆ›å»ºå¥½è¯ä¹¦ä¹‹åå¯¼å‡ºè¯ä¹¦ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201121122116308.png" alt="image-20201121122116308"></p><h2 id="é¡¹ç›®é…ç½®"><a href="#é¡¹ç›®é…ç½®" class="headerlink" title="é¡¹ç›®é…ç½®"></a>é¡¹ç›®é…ç½®</h2><p><strong>1.åˆå§‹åŒ–springbooté¡¹ç›®</strong></p><p>ç•¥</p><p><strong>2.é…ç½®æ–‡ä»¶</strong></p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¿é—®åœ°å€ é‡è¦ ä¸åŠ çš„è¯ä¸èƒ½è¿œç¨‹è®¿é—®</span></span><br><span class="line"><span class="meta">server.address</span>=<span class="string">0.0.0.0</span></span><br><span class="line"><span class="comment">#httpsåŠ å¯†ç«¯å£å· 443</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">443</span></span><br><span class="line"><span class="comment">#SSLè¯ä¹¦è·¯å¾„ ä¸€å®šè¦åŠ ä¸Šclasspath:</span></span><br><span class="line"><span class="meta">server.ssl.key-store</span>=<span class="string">classpath:t-av2ray-top-tomcat-1121122148.jks</span></span><br><span class="line"><span class="comment">#SSLè¯ä¹¦å¯†ç </span></span><br><span class="line"><span class="meta">server.ssl.key-store-password</span>=<span class="string">1214</span></span><br><span class="line"><span class="comment">#è¯ä¹¦ç±»å‹</span></span><br><span class="line"><span class="meta">server.ssl.key-store-type</span>=<span class="string">JKS</span></span><br><span class="line"><span class="comment">#è¯ä¹¦åˆ«å</span></span><br><span class="line"><span class="comment">#server.ssl.key-alias=alias</span></span><br></pre></td></tr></table></figure><p>é¡¹ç›®å¯åŠ¨ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(DemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * httpé‡å®šå‘åˆ°https</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TomcatServletWebServerFactory <span class="title">servletContainer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        TomcatServletWebServerFactory tomcat = <span class="keyword">new</span> TomcatServletWebServerFactory() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postProcessContext</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">                SecurityConstraint constraint = <span class="keyword">new</span> SecurityConstraint();</span><br><span class="line">                constraint.setUserConstraint(<span class="string">&quot;CONFIDENTIAL&quot;</span>);</span><br><span class="line">                SecurityCollection collection = <span class="keyword">new</span> SecurityCollection();</span><br><span class="line">                collection.addPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">                constraint.addCollection(collection);</span><br><span class="line">                context.addConstraint(constraint);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        tomcat.addAdditionalTomcatConnectors(httpConnector());</span><br><span class="line">        <span class="keyword">return</span> tomcat;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connector <span class="title">httpConnector</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connector connector = <span class="keyword">new</span> Connector(<span class="string">&quot;org.apache.coyote.http11.Http11NioProtocol&quot;</span>);</span><br><span class="line">        connector.setScheme(<span class="string">&quot;http&quot;</span>);</span><br><span class="line">        <span class="comment">//Connectorç›‘å¬çš„httpçš„ç«¯å£å·</span></span><br><span class="line">        connector.setPort(<span class="number">8080</span>);</span><br><span class="line">        connector.setSecure(<span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">//ç›‘å¬åˆ°httpçš„ç«¯å£å·åè½¬å‘åˆ°çš„httpsçš„ç«¯å£å·</span></span><br><span class="line">        connector.setRedirectPort(<span class="number">443</span>);</span><br><span class="line">        <span class="keyword">return</span> connector;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¾ç½®80ç«¯å£è·³è½¬è‡³443ç«¯å£ï¼Œå¼ºåˆ¶ä½¿ç”¨httpsã€‚</p><p><strong>3.æ‰“åŒ…</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn package -DskipTests</span><br></pre></td></tr></table></figure><p><strong>4. ä¸Šä¼ è‡³æœåŠ¡å™¨</strong></p><p><strong>4.1 æœåŠ¡å™¨å®‰è£…Java</strong></p><p>ç•¥</p><p><strong>4.2é¡¹ç›®è¿è¡Œ</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar xxx</span><br></pre></td></tr></table></figure><p><a href="https://t.av2ray.top/hello%EF%BC%8C%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE">https://t.av2ray.top/helloï¼Œå¯ä»¥è®¿é—®</a></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201121162646185.png" alt="image-20201121162646185"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201121162701151.png" alt="image-20201121162701151"></p><hr><p>å½“æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ipè®¿é—®æ—¶ï¼š</p><p><strong><a href="http://ip:443/hello">http://ip:443/hello</a></strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Bad Request</span><br><span class="line">This combination of host and port requires TLS.</span><br></pre></td></tr></table></figure><blockquote><p>è¿™æ˜¯å› ä¸ºé¡¹ç›®é…ç½®äº†TLSè®¿é—®ï¼Œæ‰€ä»¥è¿™æ—¶ä¸èƒ½ä½¿ç”¨http</p></blockquote><p><strong><a href="https://ip/hello">https://ip:443/hello</a></strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201121162909986.png" alt="image-20201121162909986"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201121162925128.png" alt="image-20201121162925128"></p><blockquote><p>è¿™æ—¶å› ä¸ºæˆ‘ä»¬é€šè¿‡ipè®¿é—®é¡¹ç›®æ—¶ï¼Œè¯ä¹¦ä¸å¯¹ã€‚æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯é¢å‘ç»™åŸŸåxxxçš„è¯ä¹¦ï¼Œæ‰€ä»¥åªèƒ½ä½¿ç”¨æ­¤åŸŸåè®¿é—®æ—¶æ‰æ˜¯å®‰å…¨çš„ã€‚</p><p>ä¸å®‰å…¨æ—¶æµè§ˆå™¨ä¼šæç¤ºï¼Œä»å¯ä»¥è®¿é—®ï¼Œä½†æ˜¯æ˜¾ç¤ºä¸å®‰å…¨ã€‚</p></blockquote><blockquote><p>httpsé¡¹ç›®æ€»ç»“</p><p>å› ä¸ºé¡¹ç›®ä¸­é…ç½®äº†TSLï¼Œæ‰€ä»¥åªæœ‰ä½ è®¿é—®æ—¶æºå¸¦äº†è¯ä¹¦ï¼Œä¸”æºå¸¦çš„è¯ä¹¦æ­£å¥½å’Œé¡¹ç›®ä¸­é…ç½®çš„è¯ä¹¦åŒ¹é…è®¿é—®æ‰æ˜¯å®‰å…¨çš„ï¼Œå¦åˆ™è®¿é—®éƒ½ä¸å®‰å…¨ã€‚ </p><p>é‚£å¦‚ä½•æ‰èƒ½æºå¸¦è¯ä¹¦è®¿é—®å‘¢ï¼Œçœ‹ä½ é¡¹ç›®ä¸­çš„è¯ä¹¦æ˜¯æ€ä¹ˆç”Ÿæˆé¢ï¼Œä¾‹å¦‚ä¸Šè¿°é¡¹ç›®ä¸­çš„è¯ä¹¦æ˜¯ç”±åŸŸåt.av2ray.topç”Ÿæˆçš„ï¼Œæ‰€ä»¥åªæœ‰å½“ä½¿ç”¨æ­¤åŸŸåè®¿é—®æœåŠ¡æ—¶æ‰ä¼šæºå¸¦æ­£ç¡®çš„è¯ä¹¦ï¼Œå¦‚æœç›´æ¥ä½¿ç”¨IPåœ°å€è®¿é—®ä¹Ÿä¸æ˜¯å®‰å…¨çš„ã€‚å› ä¸ºè¯ä¹¦æ˜¯é¢å‘ç»™t.av2ray.topçš„ã€‚</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;h2 id=&quot;Http&quot;&gt;&lt;a href=&quot;#Http&quot; class=&quot;headerlink&quot; title=&quot;Http&quot;&gt;&lt;/a&gt;Http&lt;/h</summary>
      
    
    
    
    <category term="åè®®" scheme="https://awslzhang.top/categories/%E5%8D%8F%E8%AE%AE/"/>
    
    
    <category term="Https" scheme="https://awslzhang.top/tags/Https/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetesæ ¸å¿ƒæŠ€æœ¯</title>
    <link href="https://awslzhang.top/2020/11/17/Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/"/>
    <id>https://awslzhang.top/2020/11/17/Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/</id>
    <published>2020-11-17T13:31:09.000Z</published>
    <updated>2021-01-01T05:49:59.958Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ ¸å¿ƒæŠ€æœ¯Pod"><a href="#æ ¸å¿ƒæŠ€æœ¯Pod" class="headerlink" title="æ ¸å¿ƒæŠ€æœ¯Pod"></a>æ ¸å¿ƒæŠ€æœ¯Pod</h1><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><blockquote><p>Pod æ˜¯ k8s ç³»ç»Ÿä¸­å¯ä»¥åˆ›å»ºå’Œç®¡ç†çš„æœ€å°å•å…ƒï¼Œæ˜¯èµ„æºå¯¹è±¡æ¨¡å‹ä¸­ç”±ç”¨æˆ·åˆ›å»ºæˆ–éƒ¨ç½²çš„æœ€å°èµ„æºå¯¹è±¡æ¨¡å‹ï¼Œä¹Ÿæ˜¯åœ¨ k8s ä¸Šè¿è¡Œå®¹å™¨åŒ–åº”ç”¨çš„èµ„æºå¯¹è±¡ï¼Œå…¶ä»–çš„èµ„æºå¯¹è±¡éƒ½æ˜¯ç”¨æ¥æ”¯ æ’‘æˆ–è€…æ‰©å±• Pod å¯¹è±¡åŠŸèƒ½çš„ï¼Œæ¯”å¦‚æ§åˆ¶å™¨å¯¹è±¡æ˜¯ç”¨æ¥ç®¡æ§ Pod å¯¹è±¡çš„ï¼ŒService æˆ–è€… Ingress èµ„æºå¯¹è±¡æ˜¯ç”¨æ¥æš´éœ² Pod å¼•ç”¨å¯¹è±¡çš„ï¼ŒPersistentVolume èµ„æºå¯¹è±¡æ˜¯ç”¨æ¥ä¸º Pod æä¾›å­˜å‚¨ç­‰ç­‰ï¼Œ<font color="red">k8s ä¸ä¼šç›´æ¥å¤„ç†å®¹å™¨ï¼Œè€Œæ˜¯ Podï¼ŒPod æ˜¯ç”±ä¸€ä¸ªæˆ–å¤šä¸ª container ç»„æˆ</font>ï¼ŒPod æ˜¯ Kubernetes çš„æœ€é‡è¦æ¦‚å¿µï¼Œ<font color="red">æ¯ä¸€ä¸ª Pod éƒ½æœ‰ä¸€ä¸ªç‰¹æ®Šçš„è¢«ç§°ä¸ºâ€æ ¹å®¹å™¨â€œçš„ Pauseå®¹å™¨ã€‚</font>Pause å®¹å™¨å¯¹åº”çš„é•œ åƒå±äº Kubernetes å¹³å°çš„ä¸€éƒ¨åˆ†ï¼Œé™¤äº† Pause å®¹å™¨ï¼Œæ¯ä¸ª Pod è¿˜åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªç´§å¯†ç›¸å…³çš„ç”¨æˆ·ä¸šåŠ¡å®¹å™¨ã€‚</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201119143357674.png" alt="image-20201119143357674"></p><p><strong>ä¸ºä»€ä¹ˆPodæ˜¯æœ€å°èµ„æºè€Œä¸æ˜¯å®¹å™¨ï¼Ÿ</strong></p><p><code>docker run</code>äº§ç”Ÿä¸€ä¸ªå®¹å™¨(è¿›ç¨‹)ï¼Œä¸€èˆ¬å®¹å™¨ä¸­åªèƒ½ç”±ä¸€ä¸ªåº”ç”¨ï¼Œå¦‚æœåº”ç”¨è¿‡å¤šï¼Œæ— æ³•é€šè¿‡å®¹å™¨æ¥ç®¡ç†åº”ç”¨ã€‚å½“æˆ‘ä»¬Podé‡Œé¢è¦è¿è¡Œå¤šä¸ªåº”ç”¨æ—¶æ˜¯é€šè¿‡å®¹å™¨å’Œåº”ç”¨ä¸€å¯¹ä¸€çš„è¿è¡Œåº”ç”¨çš„ï¼Œæ‰€ä»¥Podä¸­èƒ½è¿è¡Œå¤šä¸ªåº”ç”¨å³Podä¸­èƒ½è¿è¡Œå¤šä¸ªå®¹å™¨ã€‚</p><blockquote><p>ä¸€ä¸ª Pod å¯ä»¥æœ‰å¤šä¸ªå®¹å™¨ï¼Œå½¼æ­¤é—´å…±äº«ç½‘ç»œå’Œå­˜å‚¨èµ„æºï¼Œæ¯ä¸ª Pod ä¸­æœ‰ä¸€ä¸ª Pause å®¹å™¨ä¿å­˜æ‰€æœ‰çš„å®¹å™¨çŠ¶æ€ï¼Œ é€šè¿‡ç®¡ç† pause å®¹å™¨ï¼Œè¾¾åˆ°ç®¡ç† pod ä¸­æ‰€æœ‰å®¹å™¨çš„æ•ˆæœã€‚</p></blockquote><h2 id="Podç‰¹æ€§"><a href="#Podç‰¹æ€§" class="headerlink" title="Podç‰¹æ€§"></a>Podç‰¹æ€§</h2><ul><li>å…±äº«ç½‘ç»œ</li><li>å…±äº«å­˜å‚¨</li><li>ç”Ÿå‘½å‘¨æœŸçŸ­æš‚</li><li>å¹³å¦çš„ç½‘ç»œ</li></ul><h3 id="å…±äº«ç½‘ç»œ"><a href="#å…±äº«ç½‘ç»œ" class="headerlink" title="å…±äº«ç½‘ç»œ"></a>å…±äº«ç½‘ç»œ</h3><p>æˆ‘ä»¬çŸ¥é“Dockerå®¹å™¨ä¹‹é—´æ˜¯äº’ç›¸éš”ç¦»çš„(ç½‘ç»œã€æ–‡ä»¶ç³»ç»Ÿâ€¦)ï¼Œå®ƒæ˜¯ç”±Dockerä½¿ç”¨äº†Linux Namespace(ä¸­çš„cgroup)æ¥å®ç°çš„ã€‚è€ŒK8sä¸­çš„Podä½¿å®ƒå†…éƒ¨åŒ…å«çš„æ‰€æœ‰å®¹å™¨å…±äº«ç½‘ç»œï¼Œæ˜¯å› ä¸ºå®ƒä½¿é‡Œé¢çš„æ‰€æœ‰å®¹å™¨éƒ½å¤„äºäº†ä¸€ä¸ªNamespaceä¸­çš„ã€‚</p><blockquote><p> <strong>Podçš„å…±äº«ç½‘ç»œåŒ…å«ä»€ä¹ˆï¼Ÿ/å•¥æ„æ€ï¼Ÿ</strong></p><ul><li>åœ¨ä¸€ä¸ª Pod é‡Œçš„å¤šä¸ªå®¹å™¨å…±äº« Pod çš„ IPï¼šå¤šä¸ªå®¹å™¨çš„Ipç›¸åŒ</li><li>ä»¥ä¸€ä¸ª Pod å†…çš„å¤šä¸ªå®¹å™¨ä¹‹é—´å¯ä»¥é€šè¿‡ localhost æ¥è¿›è¡Œé€šä¿¡ï¼šä¸åŒçš„å®¹å™¨å¯é€šè¿‡localhostäº¤æµ</li><li>ä¸åŒå®¹å™¨è¦æ³¨æ„ä¸è¦æœ‰ç«¯å£å†²çªå³å¯ï¼šå†…æ‰€æœ‰å®¹å™¨ç«¯å£å…¬ç”¨ï¼Œä¸å¯å†²çª</li><li>ä¸åŒçš„ Pod æœ‰ä¸åŒçš„ IP,ä¸åŒ Pod é€šä¿¡è¦åŸºäºPod Ipï¼›ä¸å¯é€šè¿‡IPCé€šä¿¡</li></ul></blockquote><p><strong>Dockerå®¹å™¨çš„éš”ç¦»</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/20191121111452351.png"></p><p><strong>Podæ€ä¹ˆå®ç°ç½‘ç»œå…±äº«çš„</strong></p><p>é€šè¿‡<code>Pause</code>å®¹å™¨ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201119151230610.png" alt="image-20201119151230610"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/20191121111837155.png"></p><p>åªæœ‰ä¸€ä¸ªeth0ç½‘å¡åªå‡ºç°åœ¨äº†â€pauseå®¹å™¨â€é‡Œé¢ï¼Œnginxå’Œphp-fpmå¤ç”¨äº†â€pauseå®¹å™¨â€çš„network namespaceï¼Œç®€å•ç†è§£å°±æ˜¯ä½¿ç”¨äº†â€pauseå®¹å™¨â€çš„eth0ç½‘å¡ä¸å¤–éƒ¨è¿›è¡Œé€šä¿¡ã€‚</p><h3 id="å…±äº«å­˜å‚¨"><a href="#å…±äº«å­˜å‚¨" class="headerlink" title="å…±äº«å­˜å‚¨"></a>å…±äº«å­˜å‚¨</h3><p>ä¸€ä¸ª Pod é‡Œçš„å¤šä¸ªå®¹å™¨å¯ä»¥å…±äº«å­˜å‚¨å·ï¼Œè¿™ä¸ªå­˜å‚¨å·ä¼šè¢«å®šä¹‰ä¸º Pod çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ä¸”å¯ä»¥æŒ‚è½½åˆ°è¯¥ Pod é‡Œçš„æ‰€æœ‰å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿä¸Šã€‚</p><h4 id="å­˜å‚¨å·å®ç°å…±äº«å­˜å‚¨"><a href="#å­˜å‚¨å·å®ç°å…±äº«å­˜å‚¨" class="headerlink" title="å­˜å‚¨å·å®ç°å…±äº«å­˜å‚¨"></a>å­˜å‚¨å·å®ç°å…±äº«å­˜å‚¨</h4><p>å¤§å¤šæ•°å’Œæ•°æ®å­˜å‚¨ç›¸å…³çš„åº”ç”¨å’Œæœ‰çŠ¶æ€åº”ç”¨éƒ½æ˜¯éœ€è¦æŒä¹…å­˜å‚¨æ•°æ®çš„ã€‚å®¹å™¨æœ¬èº«æœ‰ç”Ÿå‘½å‘¨æœŸï¼Œ<font color="red">ä¸ºäº†ä½¿å¾—å®¹å™¨å°†æ¥ç»ˆç»“åæˆ‘ä»¬å¯ä»¥æŠŠå®ƒåˆ é™¤ï¼Œç”šè‡³æ˜¯ç¼–æ’åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œæ„å‘³ç€æ•°æ®ä¸èƒ½æ”¾åœ¨å®¹å™¨è‡ªå·±çš„åç§°ç©ºé—´ä¸­ã€‚</font></p><blockquote><p>åœ¨k8sä¸­ï¼Œ<font color="red">Podæ˜¯è¿è¡Œåœ¨æŸä¸ªèŠ‚ç‚¹ä¸Šçš„</font>ï¼Œåªè¦ä¸å‡ºæ•…éšœï¼Œå°±ä¸€ç›´ä¼šè¿è¡Œåœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šï¼Œ<strong>èŠ‚ç‚¹æ•…éšœäº†æ‰ä¼šè°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œåªè¦èŠ‚ç‚¹ä¸æ•…éšœï¼Œæ˜¯ä¸ä¼šèµ°çš„ï¼Œæ— éå°±æ˜¯é‡å¯é‡å¯è€Œå·²ã€‚</strong></p><p>è¿™é‡Œå°±æœ‰ä¸¤ä¸ªé—®é¢˜äº†ï¼Œä¸€æ—¦è¿™ä¸ªPodæ•…éšœäº†è¢«åˆ é™¤ï¼Œæˆ–è€…èŠ‚ç‚¹æ•…éšœäº†ï¼Œæ­¤æ—¶æœ‰å¯èƒ½ç¼–æ’åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šäº†ï¼Œ<strong>ä¸ºäº†çªç ´Podç”Ÿå‘½å‘¨æœŸå—é™è¿™ç§ç°çŠ¶ï¼Œæˆ‘ä»¬éœ€è¦æŠŠæ•°æ®æ”¾åœ¨Podè‡ªæœ‰æ–‡ä»¶ç³»ç»Ÿä¹‹å¤–çš„åœ°æ–¹ã€‚</strong></p></blockquote><p>æˆ‘ä»¬æ­¤å‰åœ¨å•ç‹¬ä½¿ç”¨dockeræ—¶ï¼Œä½¿ç”¨å­˜å‚¨å·ï¼Œç›¸å½“äº<font color="red">æŠŠå®¹å™¨ä¸­çš„æŸä¸€ç›®å½•ä¸å®¿ä¸»æœºä¸ŠæŸä¸€ç›®å½•å…³è”èµ·æ¥</font>ï¼Œéšåå®¹å™¨å†…è¯¥ç›®å½•å­˜å‚¨çš„æ•°æ®éƒ½å­˜åˆ°äº†å®¿ä¸»æœºä¸Šäº†ã€‚å½“æˆ‘ä»¬åˆ äº†å®¹å™¨ï¼Œåœ¨é‡å»ºå®¹å™¨ï¼Œåªè¦è¿™ä¸ªå­˜å‚¨å·ä¸å—å½±å“ï¼Œé‚£ä¹ˆæ•°æ®æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šæ‹¥æœ‰äº†æŒä¹…åŠŸèƒ½ã€‚</p><p>ä½†æ˜¯è¿™ä¸ªé—®é¢˜åœ¨k8sä¸Šä¸èƒ½è¿™ä¹ˆæ¥æ“ä½œï¼Œ<strong>k8sæ˜¯ä¸€ä¸ªé›†ç¾¤</strong>ï¼Œç”±è°ƒåº¦å™¨è´Ÿè´£è°ƒåº¦ï¼Œ<font color="red">Podè¢«åˆ æ‰äº†å¯èƒ½ä¼šè¢«è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹</font>ï¼Œæ‰€ä»¥è¿™ç§åœ¨èŠ‚ç‚¹çº§å¸®å¿™æä¾›å­˜å‚¨å·çš„æ–¹å¼æ¥æŒä¹…å­˜å‚¨æ•°æ®çš„é€»è¾‘åœ¨k8sä¸Šï¼Œåªèƒ½è¯´åªæœ‰ä¸€å®šç¨‹åº¦ä¸Šçš„æŒä¹…æ€§ï¼Œä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„æŒä¹…æ€§ã€‚<font color="red"><strong>åº”è¯¥ä½¿ç”¨è„±ç¦»èŠ‚ç‚¹è€Œå­˜åœ¨çš„å­˜å‚¨è®¾å¤‡ã€‚</strong></font></p><p>ä¸ºæ­¤ï¼Œk8sæä¾›äº†èƒ½åº”ä»˜å„ç§ä¸åŒç±»å‹çš„å­˜å‚¨å·è®©æˆ‘ä»¬æ¥ä½¿ç”¨ï¼Œæ²¡æœ‰æŒä¹…ã€åŠæŒä¹…ã€æˆ–çœŸæ­£æ„ä¹‰ä¸Šçš„æŒä¹…åŠŸèƒ½ã€‚å¯¹äºPodæ¥è¯´ï¼ŒPodå†…çš„å¤šä¸ªå®¹å™¨å¯å…±äº«è®¿é—®åŒä¸€ç»„å­˜å‚¨å·ï¼Œå› ä¸ºå¯¹k8sæ¥è®²ï¼Œå­˜å‚¨å·ä¸å±äºå®¹å™¨ï¼Œè€Œå±äºPodã€‚åœ¨å®¹å™¨ä¸­æŒ‚è½½å­˜å‚¨å·ï¼Œå¦‚æœPodä¸­ä¸¤ä¸ªå®¹å™¨éƒ½æŒ‚è½½äº†æŸä¸ªå­˜å‚¨å·ï¼Œå°±ç›¸å½“äºä¸¤ä¸ªå®¹å™¨å…±äº«æ•°æ®äº†ã€‚Podåº•å±‚æœ‰ä¸ªåŸºç¡€å®¹å™¨ï¼Œä¸å¯åŠ¨ï¼Œé ä¸€ä¸ªç‹¬ç‰¹çš„é•œåƒæ¥åˆ›å»ºçš„ï¼Œå«pauseã€‚<strong>æ‰€æœ‰çš„Podï¼Œå…¶ç½‘ç»œåç§°ç©ºé—´ã€å­˜å‚¨å·ä¹‹ç±»çš„éƒ½æ˜¯åˆ†é…ç»™è¿™ä¸ªPodçš„</strong>ï¼ŒPodä¸­è¿è¡Œçš„ä¸»å®¹å™¨æ˜¯å…±äº«è¿™ä¸ªé•œåƒçš„ç½‘ç»œåç§°ç©ºé—´çš„ï¼Œå®¹å™¨æŒ‚è½½å­˜å‚¨å·å…¶å®æ˜¯æŒ‚è½½è¿™ä¸ªå®¹å™¨çš„å­˜å‚¨å·çš„ã€‚æ‰€ä»¥å«åŸºç¡€æ¶æ„å®¹å™¨ã€‚</p><p>åœ¨Podä¸Šä½¿ç”¨å­˜å‚¨å·ï¼Œå®é™…ä¸Šä¹Ÿå°±æ˜¯è¿™ä¸ªpauseå®¹å™¨æœ‰äº†å­˜å‚¨å·ï¼Œè€Œè¿™ä¸ªå®¹å™¨æœ‰å­˜å‚¨å·ï¼Œåªä¸è¿‡æ˜¯è¿™ä¸ªå®¹å™¨å’Œå®¿ä¸»æœºç›®å½•å»ºç«‹äº†å…³è”å…³ç³»ã€‚è€Œå®¿ä¸»æœºç›®å½•å¦‚æœæ˜¯èŠ‚ç‚¹æœ¬åœ°çš„ï¼Œé‚£ä¹ˆå®ƒå°±éšç€å®¿ä¸»æœºè€Œç»ˆç»“äº†ï¼Œå› æ­¤å®¿ä¸»æœºè¿™ä¸ªç›®å½•ä¸ºäº†çœŸæ­£å®ç°æŒä¹…æ€§ï¼Œå®ƒåº”è¯¥ä¹Ÿä¸æ˜¯å®¿ä¸»æœºæœ¬åœ°çš„ï¼Œ<strong>è€Œæ˜¯å®¿ä¸»æœºæŒ‚è½½çš„å¤–éƒ¨å­˜å‚¨è®¾å¤‡ä¸Šçš„å­˜å‚¨å·ã€‚</strong>å½“ç„¶å¦‚æœè¿™ä¸ªå®¿ä¸»æœºçš„ç›®å½•æ²¡æŒ‚è½½ï¼Œé‚£å°±æ˜¯èŠ‚ç‚¹æœ¬åœ°çš„äº†ã€‚åªè¦èŠ‚ç‚¹ä¸å®•æœºï¼Œæ•°æ®å°±æ˜¯æŒä¹…çš„ã€‚ä½†æ˜¯è·¨èŠ‚ç‚¹å­˜å‚¨ï¼Œåªèƒ½ä½¿ç”¨è„±ç¦»èŠ‚ç‚¹æœ¬åœ°çš„ç½‘ç»œè®¾å¤‡ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/143.png"></p><blockquote><p>æ€»ä¹‹ï¼š</p><p>è·¨èŠ‚ç‚¹å­˜å‚¨ï¼šPodå†…å®¹å™¨â¡Pauseå®¹å™¨â¡å®¿ä¸»æœºï¼ˆéæœ¬åœ°ï¼‰æŒ‚è½½çš„å¤–éƒ¨è®¾å¤‡</p><p>æœ¬åœ°èŠ‚ç‚¹å­˜å‚¨ï¼šPodå†…å®¹å™¨â¡Pauseå®¹å™¨â¡å®¿ä¸»æœºï¼ˆæœ¬åœ°ï¼‰ï¼Œè¿™æ ·Podé‡å¯æˆ–è€…è¿ç§»æ—¶èŠ‚ç‚¹æ¢æ‰ï¼Œåˆ™æ•°æ®ä¸¢å¤±ï¼</p></blockquote><h4 id="Kuberneteså­˜å‚¨å·åˆ†ç±»"><a href="#Kuberneteså­˜å‚¨å·åˆ†ç±»" class="headerlink" title="Kuberneteså­˜å‚¨å·åˆ†ç±»"></a>Kuberneteså­˜å‚¨å·åˆ†ç±»</h4><p>ä¸Šé¢è¯´åˆ°k8sæä¾›äº†èƒ½åº”ä»˜å„ç§ä¸åŒç±»å‹çš„å­˜å‚¨å·è®©æˆ‘ä»¬æ¥ä½¿ç”¨ï¼šæ²¡æœ‰æŒä¹…ã€åŠæŒä¹…ã€æˆ–çœŸæ­£æ„ä¹‰ä¸Šçš„æŒä¹…åŠŸèƒ½ã€‚</p><h5 id="emptyDir"><a href="#emptyDir" class="headerlink" title="emptyDir"></a>emptyDir</h5><p>ç»™Podåˆ†é…ä¸€ä¸ªå­˜å‚¨å·ï¼Œå­˜å‚¨å·åªå­˜åœ¨PodèŠ‚ç‚¹æœ¬åœ°ï¼Œ<strong>å½“Podè¢«åˆ é™¤ï¼ŒèŠ‚ç‚¹ä¸Šå­˜å‚¨å·ä¹Ÿä¼šä¸€å¹¶è¢«åˆ é™¤</strong>ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201119161057269.png" alt="image-20201119161057269"></p><blockquote><p>è¿™ä¸ªä¸æ˜¯ä¸ºäº†æŒä¹…è€Œè®¾è®¡ã€‚åªæ˜¯ç”¨æ¥åšä¸´æ—¶ç›®å½•ä½¿ç”¨çš„ã€‚</p></blockquote><h5 id="hostPath"><a href="#hostPath" class="headerlink" title="hostPath"></a>hostPath</h5><p>ä¸»æœºè·¯å¾„ã€‚ç›´æ¥åœ¨å®¿ä¸»æœºæ‰¾ä¸€ä¸ªç›®å½•ï¼Œä¸å®¹å™¨å»ºç«‹å…³è”å…³ç³»ã€‚ä¹Ÿä¸å…·æœ‰çœŸæ­£æ„ä¹‰ä¸Šçš„æŒä¹…æ€§ã€‚å¦‚æœéœ€è¦çœŸæ­£ä»¥ä¸Šçš„æŒä¹…æ€§ï¼Œåˆ™éœ€è¦è¿æ¥ç½‘ç»œè¿æ¥å­˜å‚¨ã€‚å¤§æ¦‚åˆ†3ç±»ï¼š</p><ol><li>SAN(å­˜å‚¨åŒºåŸŸç½‘ç»œï¼Œæ¯”å¦‚iSCSIã€FCåè®®)ã€NAS(ç½‘ç»œé™„åŠ å­˜å‚¨ï¼Œæ¯”å¦‚nfsåè®®ã€cifsåè®®ä»¥åŠhttpåè®®)</li><li>åˆ†å¸ƒå¼å­˜å‚¨ï¼šæˆ–æ˜¯æ–‡ä»¶ç³»ç»Ÿçº§åˆ«ã€æˆ–è€…å—è®¾å¤‡ã€‚<br>æ–‡ä»¶ç³»ç»Ÿçº§åˆ«ï¼šglusterfsã€cephfs<br>å—çº§åˆ«ï¼šrbd</li><li>äº‘å­˜å‚¨ï¼šäºšé©¬é€Šçš„EBS(å¼¹æ€§å—å­˜å‚¨)ã€Azure Diskã€‚</li></ol><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201119161514977.png" alt="image-20201119161514977"></p><h5 id="pvc"><a href="#pvc" class="headerlink" title="pvc"></a>pvc</h5><p><strong>æŒä¹…å­˜å‚¨å·ç”³è¯·ï¼Œç®€ç§°pvc</strong>ã€‚ä»æŸç§æ„ä¹‰ä¸Šæ¥è®²ï¼Œå®ƒä¸æ˜¯ä¸€ä¸ªå­˜å‚¨å·ã€‚ä»¥rbdä¸ºä¾‹ï¼Œå½“ä½ å®šä¹‰ä½¿ç”¨rbdç±»å‹çš„å­˜å‚¨æ—¶ï¼Œä½ éœ€è¦å®šä¹‰å¾ˆå¤šç›¸å…³çš„å‚æ•°ï¼Œè¿™éœ€è¦ä½ å¯¹è¿™ä¸ªå­˜å‚¨å¾ˆç†Ÿæ‚‰ã€‚è¿™ä¼šé˜»æ–­ä¸€å¤§éƒ¨åˆ†ç”¨æˆ·æ¥ç”¨k8sã€‚æ€ä¹ˆè½¬æ¢æˆå‚»ç“œçš„å½¢å¼æ¥ä½¿ç”¨ï¼Ÿpvcå°±æ˜¯å¹²è¿™ä¸ªäº‹æƒ…çš„ã€‚<br>å½“éœ€è¦åˆ›å»ºä¸€ä¸ªå­˜å‚¨å·æ—¶ï¼Œä½ åªéœ€è¦å‘Šè¯‰æˆ‘ï¼Œâ€œæˆ‘è¦æ¥ä¸ªå­˜å‚¨å·â€ï¼Œæ‰€ä»¥å«å­˜å‚¨å·åˆ›å»ºç”³è¯·ã€‚ä½ ä¸è¦ç®¡å®ƒåº•å±‚å­˜å‚¨ç³»ç»Ÿæ˜¯ä»€ä¹ˆï¼Œä½ åªéœ€è¦è¯´â€œæˆ‘å°±éœ€è¦è¿™ä¹ˆå¤šâ€å°±è¡Œã€‚æŒ‡å®šå‘Šè¯‰å®ƒæ¯”å¦‚è¯´éœ€è¦ä¸ª5gçš„å­˜å‚¨ç©ºé—´ï¼Œè€Œä¸ç”¨ç®¡å®ƒé‚£ä¸ªå­˜å‚¨åˆ°åº•æ”¾åœ¨å“ªä¸ªç³»ç»Ÿä¸Šã€‚<strong>è¿™å«å­˜å‚¨åŠæœåŠ¡ã€‚</strong></p><p>è®©Podåˆ›å»ºå’Œåº•å±‚å­˜å‚¨è§£è€¦ã€‚å…³é”®æ˜¯å’Œpvcå»ºç«‹å…³è”å…³ç³»ï¼Œè€Œpvcå…³é”®æ˜¯å’Œpvå»ºç«‹å…³è”å…³ç³»ï¼Œè€Œpvå…³é”®æ˜¯å’Œå­˜å‚¨ç³»ç»Ÿå»ºç«‹å…³è”å…³ç³»ã€‚è§£é‡Šå¦‚ä¸‹ï¼šå‡å¦‚ä¸€ä¸ªPodåˆ›å»ºè°ƒåº¦åˆ°æŸä¸ªèŠ‚ç‚¹ä¸Šï¼Œæˆ‘ä»¬åœ¨Podä¸Šå®šä¹‰ä¸€ä¸ªpvcï¼Œå®ƒæ˜¯ä¸€ç§å­˜å‚¨å·ç±»å‹ï¼Œpvcè¦å…³è”åˆ°å½“å‰è¿™ä¸ªPodæ‰€åœ¨åç§°ç©ºé—´çœŸæ­£å­˜åœ¨çš„pvcèµ„æºï¼Œè¿™ä¸ªpvcåªæ˜¯ä¸ªç”³è¯·ï¼Œç”³è¯·è¦ä¸pvå»ºç«‹å…³è”å…³ç³»ï¼Œpvæ˜¯çœŸæ­£å­˜å‚¨ç³»ç»Ÿä¹‹ä¸Šçš„ä¸€æ®µå­˜å‚¨ç©ºé—´ï¼Œpvä¸åç«¯å­˜å‚¨å»ºç«‹å…³è”å…³ç³»ã€‚ä½†æ˜¯è¿™ä¸ªpvcä¸å“ªä¸ªpvå»ºç«‹å…³è”å…³ç³»æ—¶ï¼Œæ€ä¹ˆå¯èƒ½æœ‰ä¸ªpvæ”¾åœ¨é‚£ç­‰ä½ æ¥ç”¨å‘¢ï¼Ÿè¦åšåˆ°è¿™ä¸€æ­¥ï¼Œç”¨æˆ·åœ¨åˆ›å»ºç”³è¯·ä¹‹å‰ï¼Œå…ˆæéœ€æ±‚ï¼Œç„¶ååç«¯å­˜å‚¨å·¥ç¨‹å¸ˆæˆ–è€…k8sç®¡ç†å‘˜æŠŠè¿™äº›pvåˆ›å»ºå¥½ã€‚ä½†æ˜¯å¦‚æœæ˜¯å…¬æœ‰äº‘å‘¢ï¼Ÿæœ‰å¾ˆå¤šç§Ÿæˆ·åœ¨ä¸Šé¢è·‘ç€ï¼Œå‹æ ¹ä¸çŸ¥é“ä»–ä»¬ä»€ä¹ˆæ—¶å€™è¦åˆ›å»ºpvã€‚å› æ­¤å¦‚æœè¦åšåˆ°æŒ‰éœ€åˆ›å»ºï¼Œæˆ‘ä»¬pvä¹Ÿä¸å»ºäº†ï¼Œæˆ‘ä»¬æŠŠæ‰€æœ‰çš„å­˜å‚¨ç©ºé—´æŠ½è±¡å‡ºæ¥ï¼ŒæŠ½è±¡ä¸ºä¸€ä¸ªæŠ½è±¡å±‚ï¼Œå«<strong>å­˜å‚¨ç±»</strong>ã€‚å½“ç”¨æˆ·åˆ›å»ºpvcéœ€è¦ç”¨åˆ°pvæ—¶ï¼Œå®ƒèƒ½å¤Ÿå‘å­˜å‚¨ç±»ç”³è¯·è¯´ï¼Œâ€œä½ å¸®æˆ‘åˆ›å»ºå‡ºæ¥â€ï¼Œå­˜å‚¨ç±»ä¼šå¸®å®ƒç”Ÿæˆåˆšå¥½ç¬¦åˆç”¨æˆ·è¯·æ±‚å¤§å°çš„pvæ¥ï¼Œå¹¶è®©äºŒè€…å»ºç«‹å…³è”å…³ç³»ã€‚<strong>åƒè¿™ç§pvç”±ç”¨æˆ·çš„è¯·æ±‚è§¦å‘è€ŒåŠ¨æ€ç”Ÿæˆï¼Œæˆ‘ä»¬ç§°ä¸ºpvçš„åŠ¨æ€ä¾›ç»™ã€‚è€Œè¿™é‡Œéœ€è¦ä¾èµ–ä¸€ä¸ªå‰æï¼šè¦å®šä¹‰å¥½å­˜å‚¨ç±»ã€‚</strong><br><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/144.png" alt="img"><br>ä»€ä¹ˆå«å­˜å‚¨ç±»ï¼Ÿå­˜å‚¨æŒ‰ç…§å…¶ç»¼åˆæœåŠ¡è´¨é‡å¯ä»¥åˆ†ä¸ºå¥½å‡ ä¸ªçº§åˆ«ï¼Œæœ‰çš„åˆæ…¢åˆç¬¨ï¼Œç§°ä¸ºBronzeå­˜å‚¨ï¼Œæœ‰çš„é€Ÿåº¦ç®—ä¸­é—´ï¼Œæˆ‘ä»¬å¯¹æ€§èƒ½æ²¡æœ‰å¤ªé«˜è¦æ±‚ï¼Œç§°ä¸ºSilverå­˜å‚¨ï¼Œè€Œæœ‰äº›ç‰¹åˆ«å¿«ï¼Œssdä¹‹ç±»ç»„æˆçš„ï¼Œç§°ä¸ºGoldå­˜å‚¨ã€‚<br><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/145.png" alt="img"><br>å¦‚æœæˆ‘ä»¬è‡ªå·±æ˜¯ä¸€ä¸ªå¯¹äºå­˜å‚¨ç³»ç»Ÿéå¸¸äº†è§£çš„äººï¼Œåˆ›å»ºPodæ—¶å¯ç›´æ¥ä½¿ç”¨å­˜å‚¨ç©ºé—´ï¼Œå¦‚æœä½ ä¸æ˜¯ç‰¹åˆ«äº†è§£ï¼Œæˆ–è€…æˆ‘ä»¬å°†æ¥æœ‰å¾ˆå¤šç”¨æˆ·ã€ç»ˆç«¯ç”¨æˆ·å¯¹äºå­˜å‚¨æŠ€æœ¯çŸ¥ä¹‹ä¸å¤šçš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±åº”è¯¥å°½å¯èƒ½åœ°ç»™ä»–ä»¬åšæˆåŠ¨æ€ä¾›ç»™çš„æ–¹å¼ï¼Œè®©ä»–ä»¬ä½¿ç”¨pvcæ¥ä½¿ç”¨ã€‚</p><h4 id="å®ä¾‹"><a href="#å®ä¾‹" class="headerlink" title="å®ä¾‹"></a>å®ä¾‹</h4><p>å­˜å‚¨å·åªæ˜¯åœ¨Podä¸Šå®šä¹‰çš„ï¼Œå®¹å™¨ä¸­è¦æƒ³ä½¿ç”¨è¿˜å¾—æŒ‚è½½å’Œç»‘å®šã€‚ç¬¬ä¸€åœ¨Podä¸­è¦å®šä¹‰<code>volume</code>ï¼Œè¿™ä¸ªvolumeè¦æŒ‡æ˜å…³è”åˆ°å“ªä¸ªå­˜å‚¨è®¾å¤‡ä¸Šå»çš„ï¼Œç¬¬äºŒè¦åœ¨å®¹å™¨ä¸­ä½¿ç”¨<code>volumeMounts</code>ï¼Œç„¶åä½ æ‰èƒ½ä½¿ç”¨ã€‚</p><h5 id="emptyDir-1"><a href="#emptyDir-1" class="headerlink" title="emptyDir"></a>emptyDir</h5><p>emptyDirä¸éœ€è¦ä¾èµ–ä»»ä½•å¤–éƒ¨è®¾å¤‡ã€‚</p><p>æŸ¥çœ‹å®šä¹‰emptyDirçš„ç›¸å…³å­—æ®µï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl explain pod.spec.volumes.emptyDir</span><br><span class="line">$ kubectl explain pod.spec.containers.volumeMounts</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªç»ƒä¹ ä¸­ï¼Œä½ ä¼šåˆ›å»ºä¸€ä¸ªåŒ…å«ä¸¤ä¸ªå®¹å™¨çš„ Podã€‚ä¸¤ä¸ªå®¹å™¨å…±äº«ä¸€ä¸ªå·ç”¨äºä»–ä»¬ä¹‹é—´çš„é€šä¿¡ã€‚ Pod çš„é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">two-containers</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">shared-data</span></span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">shared-data</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debian-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">debian</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">shared-data</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/pod-data</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo Hello from the debian container &gt; /pod-data/index.html&quot;</span>]</span><br></pre></td></tr></table></figure><p>åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ° Pod æœ‰ä¸€ä¸ªå…±äº«å·ï¼Œåä¸º <code>shared-data</code>ã€‚</p><p>é…ç½®æ–‡ä»¶ä¸­çš„ç¬¬ä¸€ä¸ªå®¹å™¨è¿è¡Œäº†ä¸€ä¸ª nginx æœåŠ¡å™¨ã€‚å…±äº«å·çš„æŒ‚è½½è·¯å¾„æ˜¯ <code>/usr/share/nginx/html</code>ã€‚ ç¬¬äºŒä¸ªå®¹å™¨æ˜¯åŸºäº debian é•œåƒçš„ï¼Œæœ‰ä¸€ä¸ª <code>/pod-data</code> çš„æŒ‚è½½è·¯å¾„ã€‚ç¬¬äºŒä¸ªå®¹å™¨è¿è¡Œäº†ä¸‹é¢çš„å‘½ä»¤ç„¶åç»ˆæ­¢ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> Hello from the debian container &gt; /pod-data/index.html</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œç¬¬äºŒä¸ªå®¹å™¨åœ¨ nginx æœåŠ¡å™¨çš„æ ¹ç›®å½•ä¸‹å†™äº† <code>index.html</code> æ–‡ä»¶ã€‚</p><p>åˆ›å»ºä¸€ä¸ªåŒ…å«ä¸¤ä¸ªå®¹å™¨çš„ Podï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f https://k8s.io/examples/pods/two-container-pod.yaml</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ Pod å’Œå®¹å™¨çš„ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod two-containers --output=yaml</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯è¾“å‡ºçš„ä¸€éƒ¨åˆ†ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">two-containers</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="attr">containerStatuses:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">containerID:</span> <span class="string">docker://c1d8abd1</span> <span class="string">...</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">debian</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">lastState:</span></span><br><span class="line">      <span class="attr">terminated:</span></span><br><span class="line">        <span class="string">...</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">debian-container</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">containerID:</span> <span class="string">docker://96c1ff2c5bb</span> <span class="string">...</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx-container</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">state:</span></span><br><span class="line">      <span class="attr">running:</span></span><br><span class="line">    <span class="string">...</span></span><br></pre></td></tr></table></figure><p>ä½ å¯ä»¥çœ‹åˆ° debian å®¹å™¨å·²ç»è¢«ç»ˆæ­¢äº†ï¼Œè€Œ nginx æœåŠ¡å™¨ä¾ç„¶åœ¨è¿è¡Œã€‚</p><p>è¿›å…¥ nginx å®¹å™¨çš„ shellï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it two-containers -c nginx-container -- /bin/bash</span><br></pre></td></tr></table></figure><p>åœ¨ shell ä¸­ï¼Œç¡®è®¤ nginx è¿˜åœ¨è¿è¡Œã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@two-containers:/<span class="comment"># ps aux</span></span><br></pre></td></tr></table></figure><p>è¾“å‡ºç±»ä¼¼äºè¿™æ ·ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">USER       PID  ...  STAT START   TIME COMMAND</span><br><span class="line">root         1  ...  Ss   21:12   0:00 nginx: master process nginx -g daemon off;</span><br></pre></td></tr></table></figure><p>å›å¿†ä¸€ä¸‹ï¼Œdebian å®¹å™¨åœ¨ nginx çš„æ ¹ç›®å½•ä¸‹åˆ›å»ºäº† <code>index.html</code> æ–‡ä»¶ã€‚ ä½¿ç”¨ <code>curl</code> å‘ nginx æœåŠ¡å™¨å‘é€ä¸€ä¸ª GET è¯·æ±‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@two-containers:/<span class="comment"># apt-get update</span></span><br><span class="line">root@two-containers:/<span class="comment"># apt-get install curl</span></span><br><span class="line">root@two-containers:/<span class="comment"># curl localhost</span></span><br></pre></td></tr></table></figure><p>è¾“å‡ºè¡¨ç¤º nginx æä¾›äº† debian å®¹å™¨å†™çš„é¡µé¢ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello from the debian container</span><br></pre></td></tr></table></figure><h5 id="nfså…±äº«ç½‘ç»œå­˜å‚¨"><a href="#nfså…±äº«ç½‘ç»œå­˜å‚¨" class="headerlink" title="nfså…±äº«ç½‘ç»œå­˜å‚¨"></a>nfså…±äº«ç½‘ç»œå­˜å‚¨</h5><p>è¿™ç§æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„æŒä¹…åŠŸèƒ½ï¼Œæˆ‘ä»¬<font color="red">éœ€è¦ä¸€å°å•ç‹¬çš„æœºå™¨ä½œä¸ºç½‘ç»œå­˜å‚¨nfsçš„æœåŠ¡ç«¯</font>ï¼Œç„¶ååœ¨å¯åŠ¨çš„Podé‡Œæ‰‹åŠ¨æŒ‡å®šVolumeæŒ‚è½½åˆ°nfsçš„æœåŠ¡ç«¯ï¼Œæ‰€ä»¥<font color="red">ä¹Ÿéœ€è¦k8sçš„é›†ç¾¤çš„å„ä¸ªèŠ‚ç‚¹è¦å®‰è£…nfsçš„å®¢æˆ·ç«¯</font></p><p><strong>1. æœåŠ¡ç«¯å®‰è£…nfs</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y nfs-utils</span><br></pre></td></tr></table></figure><p>è®¾ç½®æŒ‚è½½è·¯å¾„ï¼ˆæŒ‚è½½è·¯å¾„éœ€è¦å­˜åœ¨ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/exports</span><br><span class="line">/data/nfs *(rw,no_root_squash)</span><br></pre></td></tr></table></figure><p>å¯åŠ¨nfsæœåŠ¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/nfs</span><br><span class="line">systemctl start nfs</span><br><span class="line">ps -ef|grep nfs</span><br></pre></td></tr></table></figure><p><strong>2. k8sé›†ç¾¤èŠ‚ç‚¹å®‰è£…nfså®¢æˆ·ç«¯</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y nfs-utils</span><br></pre></td></tr></table></figure><p><strong>3.  ä½¿ç”¨nfsä½œä¸ºpvè¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-dep1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wwwroot</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wwwroot</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">          <span class="comment"># è¦æ›´æ”¹ä¸ºä½ è‡ªå·±nfsæœåŠ¡ç«¯çš„åœ°å€å’Œç›®å½•</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.58</span><span class="number">.138</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/data/nfs</span></span><br></pre></td></tr></table></figure><p><code>kubectl apply -f xxx.yaml </code></p><p>æˆ‘ä»¬åœ¨æœåŠ¡ç«¯çš„è·¯å¾„ä¸­æ·»åŠ ä¸€ä¸ªæ–‡ä»¶index.htmlï¼Œç„¶ååœ¨è¿›å…¥Podå®¹å™¨æŸ¥çœ‹æ˜¯å¦å­˜åœ¨æ­¤æ–‡ä»¶ã€‚</p><p>nfsæœåŠ¡ç«¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/nfs/</span><br><span class="line">vim index.html</span><br><span class="line">hello my nfs</span><br></pre></td></tr></table></figure><p>è¿›å…¥å®¹å™¨</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-05_17-40-30.png" alt="Snipaste_2020-12-05_17-40-30"></p><p>å¯ä»¥å‘ç°æˆ‘ä»¬è¿›å…¥äº†å®¹å™¨ï¼Œå‘ç°æ•°æ®å·²ç»ç»‘å®šäº†è¿‡å»ï¼Œè¯æ˜æˆ‘ä»¬æˆåŠŸäº†</p><blockquote><p>ç¼ºç‚¹</p><p>è¿™æ ·æˆ‘ä»¬åœ¨Podçš„é…ç½®æ–‡ä»¶ä¸­å£°æ˜nfsçš„åœ°å€å’Œç›®å½•è¿™æ ·æœ‰ç‚¹ä¸å¤ªå®‰å…¨ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡pvå’Œpvcçš„æ–¹å¼æ¥å®ç°æŒä¹…åŒ–ï¼Œå½“ç„¶æœ€åæ•°æ®è¿˜æ˜¯å­˜æ”¾åœ¨æˆ‘ä»¬çš„nfsæœåŠ¡ç«¯</p></blockquote><h5 id="pvå’Œpvcæ–¹å¼"><a href="#pvå’Œpvcæ–¹å¼" class="headerlink" title="pvå’Œpvcæ–¹å¼"></a>pvå’Œpvcæ–¹å¼</h5><p><a href="#pvc">ä¸Šé¢è¯´è¿‡</a>ï¼Œpvcä¸æ˜¯ä¸€ä¸ªå­˜å‚¨æ–‡ä»¶çš„åœ°æ–¹ï¼Œä»–æ˜¯ä¸€ä¸ªæéœ€æ±‚çš„åœ°æ–¹ï¼›pvæ˜¯ä¸€ä¸ªå­˜å‚¨èµ„æºçš„æŠ½è±¡ï¼Œå®ƒæä¾›äº†å­˜å‚¨èµ„æºçš„æ¥å£ã€‚</p><p>ä¾‹å¦‚ä¸Šé¢çš„nfsæœåŠ¡ç«¯å°±æ˜¯å­˜å‚¨çš„èµ„æºï¼Œæˆ‘ä»¬éœ€è¦å¯¹è¿™ä¸ªnfsæœåŠ¡ç«¯å­˜å‚¨èµ„æºåˆ›å»ºpvä¸å…¶ç»‘å®šï¼Œè¿™æ ·æˆ‘ä»¬åªéœ€è¦æŒ‡å®špvæ¥ç»‘å®šæ•°æ®ï¼Œä¸éœ€è¦æ‰‹åŠ¨æŒ‡å®šå­˜å‚¨èµ„æºçš„ç»†èŠ‚ã€‚è€Œpvcæ˜¯ä¸pvç»‘å®šçš„ï¼Œåœ¨ä½¿ç”¨k8sæ—¶ï¼Œç”¨æˆ·æ ¹æœ¬ä¸è€ƒè™‘è¦æŠŠæ•°æ®å­˜å‚¨åœ¨å“ªä¸ªpvï¼Œä»–ä»¬åªä¼šæå‡ºå­˜å‚¨å¤šå¤§çš„å†…å®¹å’ŒåŒ¹é…çš„æ¨¡å¼ï¼Œä»–ä»¬æçš„è¦æ±‚å°±å¯ä»¥çœ‹ä¸ºæ˜¯pvcã€‚ä»–ä»¬çš„å…³ç³»ä¸ºï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-05_17-48-55.png" alt="Snipaste_2020-12-05_17-48-55"></p><p>ä¸€èˆ¬åœ¨çœŸå®ä½¿ç”¨ä¸­ï¼Œpvçš„åˆ›å»ºå’Œpvåº•å±‚çš„å­˜å‚¨èµ„æºçš„åˆ›å»ºéƒ½æ˜¯ç”±ä¸“é—¨çš„å­˜å‚¨å·¥ç¨‹å¸ˆæ¥åšçš„ï¼Œæˆ‘ä»¬åœ¨åˆ›å»ºæœåŠ¡çš„æŒä¹…åŒ–çš„å·¥ç¨‹ä¸­åªéœ€è¦æŒ‡å®špvcï¼ˆéœ€æ±‚ï¼‰å³å¯ã€‚</p><p>æˆ‘è¿™é‡Œä¸ºäº†å®ç°æ•´ä¸ªæµç¨‹ï¼Œæœ‰åˆ›å»ºå­˜å‚¨èµ„æºæŠ½è±¡pvçš„è¿‡ç¨‹</p><p><strong>1. åˆ›å»ºpv</strong></p><p>æ­¤è¿‡ç¨‹æ˜¯å·²ç»åœ¨<a href="#nfs%E5%85%B1%E4%BA%AB%E7%BD%91%E7%BB%9C%E5%AD%98%E5%82%A8">ä¸Šä¸€æ­¥éª¤</a>åˆ›å»ºå¥½äº†nfsæœåŠ¡ç«¯çš„åç»­ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/k8s/nfs</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.58</span><span class="number">.138</span></span><br></pre></td></tr></table></figure><p><code>kubectl apply -f pv.yaml</code></p><p><strong>2. åˆ›å»ºpvcå¹¶ä½¿ç”¨</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-dep1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wwwroot</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wwwroot</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">my-pvc</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure><p><code>kubectl apply -f pvc.yaml</code></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201205175846703.png" alt="image-20201205175846703"></p><blockquote><p>å¯ä»¥æ ¹æ®é…ç½®æ–‡ä»¶çœ‹åˆ°pvcçš„åˆ›å»ºåªéœ€è¦æŒ‡å®šå¤§å°ã€è§„åˆ™ã€‚æ²¡æœ‰ä¸pvæœ‰å…³çš„åœ°æ–¹ã€‚k8sä¼šæ ¹æ®ä½ çš„éœ€æ±‚è‡ªåŠ¨ä¸pvç»‘å®šã€‚</p></blockquote><p>æ‰‹åŠ¨è¿›å…¥å®¹å™¨ï¼ŒæŸ¥çœ‹ä¹‹å‰åœ¨nfsæœåŠ¡ç«¯æ·»åŠ çš„æ–‡ä»¶index.htmlæ˜¯å¦å­˜åœ¨</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-05_18-01-51.png" alt="Snipaste_2020-12-05_18-01-51"></p><p>pvcæ¨¡å¼æˆåŠŸï¼Œè®¿é—®ä¸€ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]<span class="comment"># kubectl expose deploy nginx-dep1 --type=NodePort --port=80 --target-port=80</span></span><br><span class="line">service/nginx-dep1 exposed</span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl get svc</span></span><br><span class="line">NAME         TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1     &lt;none&gt;        443/TCP        18d</span><br><span class="line">nginx-dep1   NodePort    10.108.56.3   &lt;none&gt;        80:30437/TCP   5s</span><br><span class="line">[root@k8smaster ~]<span class="comment">#</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-05_18-04-12.png" alt="Snipaste_2020-12-05_18-04-12"></p><h3 id="ç”Ÿå‘½å‘¨æœŸçŸ­æš‚"><a href="#ç”Ÿå‘½å‘¨æœŸçŸ­æš‚" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸçŸ­æš‚"></a>ç”Ÿå‘½å‘¨æœŸçŸ­æš‚</h3><p>Pod å±äºç”Ÿå‘½å‘¨æœŸæ¯”è¾ƒçŸ­æš‚çš„ç»„ä»¶ï¼Œæ¯”å¦‚ï¼Œå½“ Pod æ‰€åœ¨èŠ‚ç‚¹å‘ç”Ÿæ•…éšœï¼Œé‚£ä¹ˆè¯¥èŠ‚ç‚¹ä¸Šçš„ Podä¼šè¢«è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¢«é‡æ–°è°ƒåº¦çš„ Pod æ˜¯ä¸€ä¸ªå…¨æ–°çš„ Pod,è·Ÿä¹‹å‰çš„Pod æ²¡æœ‰åŠæ¯›é’±å…³ç³»ã€‚</p><h3 id="å¹³å¦çš„ç½‘ç»œ"><a href="#å¹³å¦çš„ç½‘ç»œ" class="headerlink" title="å¹³å¦çš„ç½‘ç»œ"></a><strong>å¹³å¦çš„ç½‘ç»œ</strong></h3><p>K8s é›†ç¾¤ä¸­çš„æ‰€æœ‰ Pod éƒ½åœ¨åŒä¸€ä¸ªå…±äº«ç½‘ç»œåœ°å€ç©ºé—´ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ª Pod éƒ½å¯ä»¥é€šè¿‡å…¶ ä»– Pod çš„ IP åœ°å€æ¥å®ç°è®¿é—®ã€‚ </p><h2 id="Podçš„ä¸€äº›è®¾ç½®"><a href="#Podçš„ä¸€äº›è®¾ç½®" class="headerlink" title="Podçš„ä¸€äº›è®¾ç½®"></a>Podçš„ä¸€äº›è®¾ç½®</h2><h3 id="é•œåƒæ‹‰å–ç­–ç•¥"><a href="#é•œåƒæ‹‰å–ç­–ç•¥" class="headerlink" title="é•œåƒæ‹‰å–ç­–ç•¥"></a>é•œåƒæ‹‰å–ç­–ç•¥</h3><ul><li><code>ifNotPresent</code>ï¼šé»˜è®¤å€¼ï¼Œé•œåƒåœ¨å®¿ä¸»æœºä¸Šä¸å­˜åœ¨æ—¶æ‰æ‹‰å–</li><li><code>Always</code>ï¼šæ¯æ¬¡åˆ›å»ºéƒ½ä¼šé‡æ–°æ‹‰å–</li><li><code>Never</code>ï¼šä»ä¸æ‹‰å–ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl explain pod.spec.containers.imagePullPolicy</span><br></pre></td></tr></table></figure><h3 id="ç”Ÿå‘½å‘¨æœŸå’Œé‡å¯ç­–ç•¥"><a href="#ç”Ÿå‘½å‘¨æœŸå’Œé‡å¯ç­–ç•¥" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸå’Œé‡å¯ç­–ç•¥"></a>ç”Ÿå‘½å‘¨æœŸå’Œé‡å¯ç­–ç•¥</h3><h4 id="ç”Ÿå‘½å‘¨æœŸ"><a href="#ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸ"></a>ç”Ÿå‘½å‘¨æœŸ</h4><table><thead><tr><th>çŠ¶æ€å€¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>Pending</td><td>API Serverå·²ç»åˆ›å»ºäº†è¯¥Pod,ä½†Podä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨çš„é•œåƒè¿˜æ²¡æœ‰åˆ›å»º,åŒ…æ‹¬é•œåƒä¸‹è½½è¿‡ç¨‹</td></tr><tr><td>Running</td><td>Podå†…æ‰€æœ‰å®¹å™¨å·²åˆ›å»º,ä¸”è‡³å°‘ä¸€ä¸ªå®¹å™¨å¤„äºè¿è¡ŒçŠ¶æ€ã€æ­£åœ¨å¯åŠ¨çŠ¶æ€æˆ–æ­£åœ¨é‡å¯çŠ¶æ€</td></tr><tr><td>Completed</td><td>Podå†…æ‰€æœ‰å®¹å™¨å‡æˆåŠŸæ‰§è¡Œé€€å‡º,ä¸”ä¸ä¼šå†é‡å¯</td></tr><tr><td>Failed</td><td>Podå†…æ‰€æœ‰å®¹å™¨å‡å·²é€€å‡º,ä½†è‡³å°‘ä¸€ä¸ªå®¹å™¨é€€å‡ºå¤±è´¥</td></tr><tr><td>Unknown</td><td>ç”±äºæŸç§åŸå› æ— æ³•è·å–PodçŠ¶æ€,ä¾‹å¦‚ç½‘ç»œé€šä¿¡ä¸ç•…</td></tr></tbody></table><h4 id="é‡å¯ç­–ç•¥"><a href="#é‡å¯ç­–ç•¥" class="headerlink" title="é‡å¯ç­–ç•¥"></a>é‡å¯ç­–ç•¥</h4><p>Pod çš„é‡å¯ç­–ç•¥åŒ…æ‹¬ Alwaysã€OnFailure å’Œ Neverï¼Œé»˜è®¤å€¼æ˜¯ Always</p><table><thead><tr><th>é‡å¯ç­–ç•¥</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>Always</td><td>å½“å®¹å™¨å¤±æ•ˆæ—¶,ç”± kubeletè‡ªåŠ¨é‡å¯è¯¥å®¹å™¨</td></tr><tr><td>OnFailure</td><td>å½“å®¹å™¨ç»ˆæ­¢è¿è¡Œä¸”é€€å‡ºç ä¸ä¸º0æ—¶,ç”± kubeleè‡ªåŠ¨é‡å¯è¯¥å®¹å™¨</td></tr><tr><td>Never</td><td>ä¸è®ºå®¹å™¨è¿è¡ŒçŠ¶æ€å¦‚ä½•, kubeletéƒ½ä¸ä¼šé‡å¯è¯¥å®¹å™¨</td></tr></tbody></table><h3 id="èµ„æºé™åˆ¶é…ç½®"><a href="#èµ„æºé™åˆ¶é…ç½®" class="headerlink" title="èµ„æºé™åˆ¶é…ç½®"></a>èµ„æºé™åˆ¶é…ç½®</h3><p>æ¯ä¸ª Pod éƒ½å¯ä»¥å¯¹å…¶èƒ½ä½¿ç”¨çš„æœåŠ¡å™¨ä¸Šçš„è®¡ç®—èµ„æºè®¾ç½®é™é¢ï¼ŒKubernetes ä¸­å¯ä»¥è®¾ç½®é™é¢çš„è®¡ç®—èµ„æºæœ‰ CPU ä¸ Memory ä¸¤ç§ï¼Œå…¶ä¸­CPU çš„èµ„æºå•ä½ä¸º CPU æ•°é‡,æ˜¯ä¸€ä¸ªç»å¯¹å€¼è€Œéç›¸å¯¹å€¼ã€‚Memory é…é¢ä¹Ÿæ˜¯ä¸€ä¸ªç»å¯¹å€¼ï¼Œå®ƒçš„å• ä½æ˜¯<strong>å†…å­˜å­—èŠ‚æ•°</strong>ã€‚ </p><p>Kubernetes é‡Œï¼Œä¸€ä¸ªè®¡ç®—èµ„æºè¿›è¡Œé…é¢é™å®šéœ€è¦è®¾å®šä»¥ä¸‹ä¸¤ä¸ªå‚æ•°ï¼š Requests è¯¥èµ„æºæœ€å°ç”³è¯·æ•°é‡ï¼Œç³»ç»Ÿå¿…é¡»æ»¡è¶³è¦æ±‚ Limits è¯¥èµ„æºæœ€å¤§å…è®¸ä½¿ç”¨çš„é‡ï¼Œä¸èƒ½çªç ´ï¼Œå½“å®¹å™¨è¯•å›¾ä½¿ç”¨è¶…è¿‡è¿™ä¸ªé‡çš„èµ„æºæ—¶ï¼Œ<strong>å¯èƒ½ä¼šè¢« Kubernetes Kill å¹¶é‡å¯</strong> ã€‚</p><p><strong>ä¸¾ä¾‹</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">db</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">env:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;123456&quot;</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;64Mi&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;128Mi&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br></pre></td></tr></table></figure><p><strong>ä¸Šè¿°ä»£ç è¡¨æ˜ MySQL å®¹å™¨ç”³è¯·æœ€å°‘ 0.25 ä¸ª CPU ä»¥åŠ 64MiB å†…å­˜ï¼Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­å®¹å™¨æ‰€èƒ½ä½¿ç”¨çš„èµ„æºé…é¢ä¸º 0.5 ä¸ª CPU ä»¥åŠ 128MiB å†…å­˜</strong></p><h3 id="å¥åº·æ£€æŸ¥"><a href="#å¥åº·æ£€æŸ¥" class="headerlink" title="å¥åº·æ£€æŸ¥"></a>å¥åº·æ£€æŸ¥</h3><p>Kubeletä½¿ç”¨liveness probeï¼ˆå­˜æ´»æ¢é’ˆï¼‰æ¥ç¡®å®šä½•æ—¶é‡å¯å®¹å™¨ã€‚ä¾‹å¦‚ï¼Œå½“åº”ç”¨ç¨‹åºå¤„äºè¿è¡ŒçŠ¶æ€ä½†æ— æ³•åšè¿›ä¸€æ­¥æ“ä½œï¼Œlivenessæ¢é’ˆå°†æ•è·åˆ°deadlockï¼Œé‡å¯å¤„äºè¯¥çŠ¶æ€ä¸‹çš„å®¹å™¨ï¼Œä½¿åº”ç”¨ç¨‹åºåœ¨å­˜åœ¨bugçš„æƒ…å†µä¸‹ä¾ç„¶èƒ½å¤Ÿç»§ç»­è¿è¡Œä¸‹å»ï¼ˆè°çš„ç¨‹åºè¿˜æ²¡å‡ ä¸ªbugå‘¢ï¼‰ã€‚</p><p>Kubeletä½¿ç”¨readiness probeï¼ˆå°±ç»ªæ¢é’ˆï¼‰æ¥ç¡®å®šå®¹å™¨æ˜¯å¦å·²ç»å°±ç»ªå¯ä»¥æ¥å—æµé‡ã€‚åªæœ‰å½“Podä¸­çš„å®¹å™¨éƒ½å¤„äºå°±ç»ªçŠ¶æ€æ—¶kubeletæ‰ä¼šè®¤å®šè¯¥Podå¤„äºå°±ç»ªçŠ¶æ€ã€‚è¯¥ä¿¡å·çš„ä½œç”¨æ˜¯æ§åˆ¶å“ªäº›Podåº”è¯¥ä½œä¸ºserviceçš„åç«¯ã€‚å¦‚æœPodå¤„äºéå°±ç»ªçŠ¶æ€ï¼Œé‚£ä¹ˆå®ƒä»¬å°†ä¼šè¢«ä»serviceçš„load balancerä¸­ç§»é™¤ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl explain pod.spec.containers.livenessProbe</span><br><span class="line">$ kubectl explain pod.spec.containers.readinessProbe</span><br></pre></td></tr></table></figure><h2 id="Podåˆ›å»ºæµç¨‹"><a href="#Podåˆ›å»ºæµç¨‹" class="headerlink" title="Podåˆ›å»ºæµç¨‹"></a>Podåˆ›å»ºæµç¨‹</h2><p><img src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/A1HKVXsfHNkb9ibEAnRZekRbN1Kic7aicNynPBNqlCrnJeb8PqzpbO5FwtGaxo78RbfRdYRzlTE8Mjt4j6PiafVAlA/640"></p><p><strong>masterç«¯</strong></p><ol><li>ç”¨æˆ·å‘å‡ºå‘½ä»¤åˆ°ApiServerï¼Œå°†æ–°å»ºpodçš„ä¿¡æ¯å­˜å…¥etcd</li><li>Schedulerè§‚å¯Ÿåˆ°Api Serverå‘å‡ºäº†æ–°å»ºPodçš„æŒ‡ä»¤ï¼Œä»Etcdé‚£å¾—åˆ°äº†è¦åˆ›å»ºçš„Podå…·ä½“ä¿¡æ¯ï¼Œå®ƒæ ¹æ®è°ƒåº¦è§„åˆ™é€‰ä¸­äº†ä¸€å°èŠ‚ç‚¹æ¥è¿è¡ŒPodï¼Œå¹¶å°†æ­¤ä¿¡æ¯å†™å…¥etcd</li></ol><p><strong>Nodeç«¯</strong></p><ol><li>è¢«é€‰ä¸­çš„èŠ‚ç‚¹ä¸­çš„kubeletè§‚å¯Ÿåˆ°Schedulerç»‘å®šPodåˆ°æœ¬æœºçš„äº‹ä»¶ï¼Œå¼€å§‹æ“æ§Dockerè¿è¡Œå®¹å™¨ï¼Œè¿è¡ŒæˆåŠŸåå‘ŠçŸ¥api serverï¼Œå¹¶ä¿®æ”¹etcdä¸­çš„çŠ¶æ€</li></ol><h2 id="Podè°ƒåº¦ç­–ç•¥"><a href="#Podè°ƒåº¦ç­–ç•¥" class="headerlink" title="Podè°ƒåº¦ç­–ç•¥"></a>Podè°ƒåº¦ç­–ç•¥</h2><h3 id="Podèµ„æºé™åˆ¶"><a href="#Podèµ„æºé™åˆ¶" class="headerlink" title="Podèµ„æºé™åˆ¶"></a>Podèµ„æºé™åˆ¶</h3><p>å‰é¢è¯´åˆ°åœ¨Podåˆ›å»ºçš„é…ç½®ä¸­æœ‰èµ„æºé…ç½®ï¼Œè°ƒåº¦å™¨æ ¹æ®æ­¤Podæ‰€éœ€è¦çš„èµ„æºæ¥é…ç½®ç›¸åº”èŠ‚ç‚¹æ¥è¿è¡Œæ­¤Podï¼Œé‚£è‚¯å®šæ˜¯é…ç½®è¶³å¤Ÿçš„èŠ‚ç‚¹æ‰èƒ½è¿è¡Œæ­¤Podã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201120153131728.png" alt="image-20201120153131728"></p><h3 id="èŠ‚ç‚¹é€‰æ‹©å™¨-nodeSelector"><a href="#èŠ‚ç‚¹é€‰æ‹©å™¨-nodeSelector" class="headerlink" title="èŠ‚ç‚¹é€‰æ‹©å™¨(nodeSelector)"></a>èŠ‚ç‚¹é€‰æ‹©å™¨(nodeSelector)</h3><p>é€šè¿‡å¯¹NodeèŠ‚ç‚¹æ‰“ä¸Šä¸åŒçš„æ ‡ç­¾<code>Label</code>æ¥æŠŠPodè°ƒåº¦åˆ°æŒ‡å®šæ ‡ç­¾çš„Nodeã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201120154555674.png" alt="image-20201120154555674"></p><blockquote><p>å¯¹èŠ‚ç‚¹åˆ›å»ºæ ‡ç­¾</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;$ kubectl label node xxx env_role=dev</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹èŠ‚ç‚¹çš„æ ‡ç­¾</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;$ kubectl node xxx --show-label</span><br></pre></td></tr></table></figure><p>ç»™ namespace ä¸­çš„æ‰€æœ‰ pod æ·»åŠ  label</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;$ kubectl label pods --all status=unhealthy</span><br></pre></td></tr></table></figure><p>åˆ é™¤åä¸ºâ€œbarâ€çš„label ã€‚ï¼ˆä½¿ç”¨â€œ - â€å‡å·ç›¸è¿ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;kubectl label pods xxx bar-</span><br></pre></td></tr></table></figure></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cuda-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cuda-test</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">&quot;k8s.gcr.io/cuda-vector-add:v0.1&quot;</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">nvidia.com/gpu:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">env_role:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201120155613803.png" alt="image-20201120155613803"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201120160233595.png" alt="image-20201120160233595"></p><h3 id="äº²å’Œæ€§è°ƒåº¦-nodeAffinity"><a href="#äº²å’Œæ€§è°ƒåº¦-nodeAffinity" class="headerlink" title="äº²å’Œæ€§è°ƒåº¦(nodeAffinity)"></a>äº²å’Œæ€§è°ƒåº¦(nodeAffinity)</h3><p>å’ŒèŠ‚ç‚¹é€‰æ‹©æ€§åŸç†ä¸€è‡´ï¼Œä½†åŠŸèƒ½æ›´å¼ºå¤§ï¼Œå¯ä»¥å¯¹æ ‡ç­¾è¿›è¡Œä¸åŒçš„æ“ä½œç¬¦è®¡ç®—ã€‚</p><p><code>nodeAffinity</code>å°±æ˜¯èŠ‚ç‚¹äº²å’Œæ€§ï¼Œç›¸å¯¹åº”çš„æ˜¯<code>Anti-Affinity</code>ï¼Œå°±æ˜¯åäº²å’Œæ€§ï¼Œè¿™ç§æ–¹æ³•æ¯”ä¸Šé¢çš„<code>nodeSelector</code>æ›´åŠ çµæ´»ï¼Œå®ƒå¯ä»¥è¿›è¡Œä¸€äº›ç®€å•çš„é€»è¾‘ç»„åˆäº†ï¼Œä¸åªæ˜¯ç®€å•çš„ç›¸ç­‰åŒ¹é…ã€‚ è°ƒåº¦å¯ä»¥åˆ†æˆè½¯ç­–ç•¥å’Œç¡¬ç­–ç•¥ä¸¤ç§æ–¹å¼ï¼Œè½¯ç­–ç•¥å°±æ˜¯å¦‚æœä½ æ²¡æœ‰æ»¡è¶³è°ƒåº¦è¦æ±‚çš„èŠ‚ç‚¹çš„è¯ï¼ŒPOD å°±ä¼šå¿½ç•¥è¿™æ¡è§„åˆ™ï¼Œç»§ç»­å®Œæˆè°ƒåº¦è¿‡ç¨‹ï¼Œè¯´ç™½äº†å°±æ˜¯<strong>æ»¡è¶³æ¡ä»¶æœ€å¥½äº†ï¼Œæ²¡æœ‰çš„è¯ä¹Ÿæ— æ‰€è°“äº†</strong>çš„ç­–ç•¥ï¼›è€Œç¡¬ç­–ç•¥å°±æ¯”è¾ƒå¼ºç¡¬äº†ï¼Œå¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹çš„è¯ï¼Œå°±ä¸æ–­é‡è¯•ç›´åˆ°æ»¡è¶³æ¡ä»¶ä¸ºæ­¢ï¼Œç®€å•è¯´å°±æ˜¯<strong>ä½ å¿…é¡»æ»¡è¶³æˆ‘çš„è¦æ±‚ï¼Œä¸ç„¶æˆ‘å°±ä¸å¹²</strong>çš„ç­–ç•¥ã€‚ <code>nodeAffinity</code>å°±æœ‰ä¸¤ä¸Šé¢ä¸¤ç§ç­–ç•¥ï¼š<code>preferredDuringSchedulingIgnoredDuringExecution</code>å’Œ<code>requiredDuringSchedulingIgnoredDuringExecution</code>ï¼Œå‰é¢çš„å°±æ˜¯è½¯ç­–ç•¥ï¼Œåé¢çš„å°±æ˜¯ç¡¬ç­–ç•¥ã€‚</p><p>å¦‚ä¸‹ä¾‹å­ï¼šï¼ˆ<strong>test-node-affinity.yaml</strong>ï¼‰</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">with-node-affinity</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">node-affinity-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">with-node-affinity</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">NotIn</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.140</span></span><br><span class="line">            <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.161</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">preference:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">source</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">qikqiak</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ä¸ª POD é¦–å…ˆæ˜¯è¦æ±‚ POD ä¸èƒ½è¿è¡Œåœ¨140å’Œ161ä¸¤ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå¦‚æœæœ‰ä¸ªèŠ‚ç‚¹æ»¡è¶³<code>source=qikqiak</code>çš„è¯å°±ä¼˜å…ˆè°ƒåº¦åˆ°è¿™ä¸ªèŠ‚ç‚¹ä¸Šï¼ŒåŒæ ·çš„æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>descirbe</code>å‘½ä»¤æŸ¥çœ‹å…·ä½“çš„è°ƒåº¦æƒ…å†µæ˜¯å¦æ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚ã€‚è¿™é‡Œçš„åŒ¹é…é€»è¾‘æ˜¯ label çš„å€¼åœ¨æŸä¸ªåˆ—è¡¨ä¸­ï¼Œç°åœ¨<code>Kubernetes</code>æä¾›çš„æ“ä½œç¬¦æœ‰ä¸‹é¢çš„å‡ ç§ï¼š</p><ul><li>Inï¼šlabel çš„å€¼åœ¨æŸä¸ªåˆ—è¡¨ä¸­</li><li>NotInï¼šlabel çš„å€¼ä¸åœ¨æŸä¸ªåˆ—è¡¨ä¸­</li><li>Gtï¼šlabel çš„å€¼å¤§äºæŸä¸ªå€¼</li><li>Ltï¼šlabel çš„å€¼å°äºæŸä¸ªå€¼</li><li>Existsï¼šæŸä¸ª label å­˜åœ¨</li><li>DoesNotExistï¼šæŸä¸ª label ä¸å­˜åœ¨</li></ul><blockquote><p>æ³¨æ„ï¼š</p><p>å¦‚æœ<code>nodeSelectorTerms</code>ä¸‹é¢æœ‰å¤šä¸ªé€‰é¡¹çš„è¯ï¼Œæ»¡è¶³ä»»ä½•ä¸€ä¸ªæ¡ä»¶å°±å¯ä»¥äº†ï¼›å¦‚æœ<code>matchExpressions</code>æœ‰å¤šä¸ªé€‰é¡¹çš„è¯ï¼Œåˆ™å¿…é¡»åŒæ—¶æ»¡è¶³è¿™äº›æ¡ä»¶æ‰èƒ½æ­£å¸¸è°ƒåº¦ PODã€‚</p></blockquote><h3 id="podAffinity"><a href="#podAffinity" class="headerlink" title="podAffinity"></a>podAffinity</h3><p>ä¸Šé¢ä¸¤ç§æ–¹å¼éƒ½æ˜¯è®© <strong>POD å»é€‰æ‹©èŠ‚ç‚¹çš„</strong>ï¼Œæœ‰çš„æ—¶å€™æˆ‘ä»¬ä¹Ÿå¸Œæœ›èƒ½å¤Ÿæ ¹æ® POD ä¹‹é—´çš„å…³ç³»è¿›è¡Œè°ƒåº¦ï¼Œ<code>Kubernetes</code>åœ¨1.4ç‰ˆæœ¬å¼•å…¥çš„<code>podAffinity</code>æ¦‚å¿µå°±å¯ä»¥å®ç°æˆ‘ä»¬è¿™ä¸ªéœ€æ±‚ã€‚</p><p>å’Œ<code>nodeAffinity</code>ç±»ä¼¼ï¼Œ<code>podAffinity</code>ä¹Ÿæœ‰<code>requiredDuringSchedulingIgnoredDuringExecution</code>å’Œ <code>preferredDuringSchedulingIgnoredDuringExecution</code>ä¸¤ç§è°ƒåº¦ç­–ç•¥ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯å¦‚æœè¦ä½¿ç”¨äº’æ–¥æ€§ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨<code>podAntiAffinity</code>å­—æ®µã€‚ å¦‚ä¸‹ä¾‹å­ï¼Œæˆ‘ä»¬å¸Œæœ›<code>with-pod-affinity</code>å’Œ<code>busybox-pod</code>èƒ½å¤Ÿå°±è¿‘éƒ¨ç½²ï¼Œè€Œä¸å¸Œæœ›å’Œ<code>node-affinity-pod</code>éƒ¨ç½²åœ¨åŒä¸€ä¸ªæ‹“æ‰‘åŸŸä¸‹é¢ï¼šï¼ˆ<strong>test-pod-affinity.yaml</strong>ï¼‰</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">with-pod-affinity</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">pod-affinity-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">with-pod-affinity</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">podAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">busybox-pod</span></span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">    <span class="attr">podAntiAffinity:</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">podAffinityTerm:</span></span><br><span class="line">          <span class="attr">labelSelector:</span></span><br><span class="line">            <span class="attr">matchExpressions:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">              <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">              <span class="attr">values:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">node-affinity-pod</span></span><br><span class="line">          <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­çš„ POD éœ€è¦è°ƒåº¦åˆ°æŸä¸ªæŒ‡å®šçš„ä¸»æœºä¸Šï¼Œè‡³å°‘æœ‰ä¸€ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œäº†è¿™æ ·çš„ PODï¼šè¿™ä¸ª POD æœ‰ä¸€ä¸ª<code>app=busybox-pod</code>çš„ labelã€‚<code>podAntiAffinity</code>åˆ™æ˜¯å¸Œæœ›æœ€å¥½ä¸è¦è°ƒåº¦åˆ°è¿™æ ·çš„èŠ‚ç‚¹ï¼šè¿™ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œäº†æŸä¸ª PODï¼Œè€Œè¿™ä¸ª POD æœ‰<code>app=node-affinity-pod</code>çš„ labelã€‚</p><blockquote><p><font color="red">æ³¨æ„ï¼Œè¿™é‡ŒåŒ¹é…çš„æ˜¯Podçš„æ ‡ç­¾  ä¸æ˜¯ä¸»æœºçš„æ ‡ç­¾</font></p></blockquote><p>äº²å’Œæ€§/åäº²å’Œæ€§è°ƒåº¦ç­–ç•¥æ¯”è¾ƒå¦‚ä¸‹ï¼š</p><table><thead><tr><th align="left">è°ƒåº¦ç­–ç•¥</th><th align="left">åŒ¹é…æ ‡ç­¾</th><th align="left">æ“ä½œç¬¦</th><th align="left">æ‹“æ‰‘åŸŸæ”¯æŒ</th><th align="left">è°ƒåº¦ç›®æ ‡</th></tr></thead><tbody><tr><td align="left">nodeAffinity</td><td align="left"><strong>ä¸»æœº</strong></td><td align="left">In, NotIn, Exists, DoesNotExist, Gt, Lt</td><td align="left">å¦</td><td align="left">æŒ‡å®šä¸»æœº</td></tr><tr><td align="left">podAffinity</td><td align="left"><strong>POD</strong></td><td align="left">In, NotIn, Exists, DoesNotExist</td><td align="left">æ˜¯</td><td align="left">PODä¸æŒ‡å®šPODåŒä¸€æ‹“æ‰‘åŸŸ</td></tr><tr><td align="left">podAnitAffinity</td><td align="left"><strong>POD</strong></td><td align="left">In, NotIn, Exists, DoesNotExist</td><td align="left">æ˜¯</td><td align="left">PODä¸æŒ‡å®šPODä¸åœ¨åŒä¸€æ‹“æ‰‘åŸŸ</td></tr></tbody></table><h3 id="æ±¡ç‚¹ï¼ˆTaintsï¼‰ä¸å®¹å¿ï¼ˆtolerationsï¼‰"><a href="#æ±¡ç‚¹ï¼ˆTaintsï¼‰ä¸å®¹å¿ï¼ˆtolerationsï¼‰" class="headerlink" title="æ±¡ç‚¹ï¼ˆTaintsï¼‰ä¸å®¹å¿ï¼ˆtolerationsï¼‰"></a>æ±¡ç‚¹ï¼ˆTaintsï¼‰ä¸å®¹å¿ï¼ˆtolerationsï¼‰</h3><p>å¯¹äº<code>nodeAffinity</code>æ— è®ºæ˜¯ç¡¬ç­–ç•¥è¿˜æ˜¯è½¯ç­–ç•¥æ–¹å¼ï¼Œéƒ½æ˜¯è°ƒåº¦ POD åˆ°é¢„æœŸèŠ‚ç‚¹ä¸Šï¼Œ<strong>è€Œ<code>Taints</code>æ°å¥½ä¸ä¹‹ç›¸åï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ ‡è®°ä¸º Taints ï¼Œé™¤é POD ä¹Ÿè¢«æ ‡è¯†ä¸ºå¯ä»¥å®¹å¿æ±¡ç‚¹èŠ‚ç‚¹ï¼Œå¦åˆ™è¯¥ Taints èŠ‚ç‚¹ä¸ä¼šè¢«è°ƒåº¦podã€‚</strong></p><p>æ±¡ç‚¹taintsæ˜¯å®šä¹‰åœ¨èŠ‚ç‚¹ä¸Šçš„é”®å€¼å‹å±æ€§æ•°æ®ï¼Œç”¨äºè®©èŠ‚ç‚¹æ‹’ç»å°† Pod è°ƒåº¦è¿è¡Œäºå…¶ä¸Šï¼Œ é™¤é Pod æœ‰æ¥çº³èŠ‚ç‚¹æ±¡ç‚¹çš„å®¹å¿åº¦å®¹å¿åº¦ tolerations æ˜¯å®šä¹‰åœ¨ Pod ä¸Šçš„é”®å€¼å±æ€§æ•°æ®ï¼Œ ç”¨äºé…ç½®å¯å®¹å¿çš„æ±¡ç‚¹ï¼Œä¸”è°ƒåº¦å™¨å°† Pod è°ƒåº¦è‡³å…¶èƒ½å®¹å¿è¯¥èŠ‚ç‚¹æ±¡ç‚¹çš„èŠ‚ç‚¹ä¸Šæˆ–æ²¡æœ‰æ±¡ç‚¹çš„èŠ‚ç‚¹ä¸Šã€‚</p><p><strong>æ±¡ç‚¹æ˜¯èŠ‚ç‚¹çš„å±æ€§ï¼Œè€Œå®¹å¿æ±¡ç‚¹æ˜¯Podçš„å±æ€§ã€‚</strong></p><p>æ¯”å¦‚ç”¨æˆ·å¸Œæœ›æŠŠ Master èŠ‚ç‚¹ä¿ç•™ç»™ Kubernetes ç³»ç»Ÿç»„ä»¶ä½¿ç”¨ï¼Œæˆ–è€…æŠŠä¸€ç»„å…·æœ‰ç‰¹æ®Šèµ„æºé¢„ç•™ç»™æŸäº› PODï¼Œåˆ™æ±¡ç‚¹å°±å¾ˆæœ‰ç”¨äº†ï¼ŒPOD ä¸ä¼šå†è¢«è°ƒåº¦åˆ° taint æ ‡è®°è¿‡çš„èŠ‚ç‚¹ã€‚</p><h4 id="å®šä¹‰æ±¡ç‚¹å’Œå®¹å¿åº¦"><a href="#å®šä¹‰æ±¡ç‚¹å’Œå®¹å¿åº¦" class="headerlink" title="å®šä¹‰æ±¡ç‚¹å’Œå®¹å¿åº¦"></a>å®šä¹‰æ±¡ç‚¹å’Œå®¹å¿åº¦</h4><p>æ±¡ç‚¹å®šä¹‰äº<code>nodes.spec.taints</code>å®¹å¿åº¦å®šä¹‰äº<code>pods.spec.tolerations</code> </p><p><strong>è¯­æ³•ï¼š key=value:effect</strong></p><h4 id="effectå®šä¹‰æ’æ–¥ç­‰çº§"><a href="#effectå®šä¹‰æ’æ–¥ç­‰çº§" class="headerlink" title="effectå®šä¹‰æ’æ–¥ç­‰çº§"></a>effectå®šä¹‰æ’æ–¥ç­‰çº§</h4><p>effect å…±æœ‰ä¸‰ä¸ªå¯é€‰é¡¹ï¼Œå¯æŒ‰å®é™…éœ€æ±‚è¿›è¡Œè®¾ç½®ï¼š</p><ol><li><code>NoSchedule</code>ï¼šä¸èƒ½å®¹å¿ï¼Œä½†ä»…å½±å“è°ƒåº¦è¿‡ç¨‹ï¼Œå·²è°ƒåº¦ä¸Šå»çš„ pod ä¸å—å½±å“ï¼Œä»…å¯¹æ–°å¢åŠ çš„pod ç”Ÿæ•ˆã€‚ </li><li><code>PreferNoSchedule</code>ï¼šæŸ”æ€§çº¦æŸï¼ŒèŠ‚ç‚¹ç°å­˜ Podä¸å—å½±å“ï¼Œå¦‚æœå®åœ¨æ˜¯æ²¡æœ‰ç¬¦åˆçš„èŠ‚ç‚¹ï¼Œä¹Ÿ å¯ä»¥è°ƒåº¦ä¸Šæ¥</li><li><code>NoExecute</code>ï¼šè¯¥é€‰é¡¹æ„å‘³ç€ä¸€æ—¦ Taint ç”Ÿæ•ˆï¼Œå¦‚è¯¥èŠ‚ç‚¹å†…æ­£åœ¨è¿è¡Œçš„ POD æ²¡æœ‰å¯¹åº” Tolerate(å®¹å¿æ±¡ç‚¹) è®¾ç½®ï¼Œä¼šç›´æ¥è¢«é€å‡ºã€‚</li></ol><h4 id="Podå®šä¹‰å®¹å¿åº¦"><a href="#Podå®šä¹‰å®¹å¿åº¦" class="headerlink" title="Podå®šä¹‰å®¹å¿åº¦"></a>Podå®šä¹‰å®¹å¿åº¦</h4><blockquote><ul><li><p>ç­‰å€¼æ¯”è¾ƒå®¹å¿åº¦ä¸æ±¡ç‚¹åœ¨ keyã€valueã€effect ä¸‰è€…å®Œå…¨åŒ¹é… </p></li><li><p>å­˜åœ¨æ€§åˆ¤æ–­ keyã€effect å®Œå…¨åŒ¹é…ï¼Œvalue ä½¿ç”¨ç©ºå€¼ </p></li></ul><p><font color="red">ä¸€ä¸ªèŠ‚ç‚¹å¯é…ç½®å¤šä¸ªæ±¡ç‚¹ï¼Œä¸€ä¸ª Pod ä¹Ÿå¯æœ‰å¤šä¸ªå®¹å¿åº¦</font></p></blockquote><p>å¦‚æœä»ç„¶å¸Œæœ›æŸä¸ª POD è°ƒåº¦åˆ° taint èŠ‚ç‚¹ä¸Šï¼Œåˆ™å¿…é¡»åœ¨ Spec ä¸­åšå‡º<code>Toleration</code>å®šä¹‰ï¼Œæ‰èƒ½è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ï¼Œä¸¾ä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;your key&quot;</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;your value&quot;</span></span><br><span class="line">    <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br></pre></td></tr></table></figure><h4 id="èŠ‚ç‚¹ç®¡ç†æ±¡ç‚¹"><a href="#èŠ‚ç‚¹ç®¡ç†æ±¡ç‚¹" class="headerlink" title="èŠ‚ç‚¹ç®¡ç†æ±¡ç‚¹"></a>èŠ‚ç‚¹ç®¡ç†æ±¡ç‚¹</h4><blockquote><p><strong>åŒä¸€ä¸ªé”®å€¼æ•°æ®ï¼Œeffect ä¸åŒï¼Œä¹Ÿå±äºä¸åŒçš„æ±¡ç‚¹</strong></p><p>å‡å¦‚èŠ‚ç‚¹node2æœ‰ï¼š</p><ul><li>w1=v1:NoSchedule</li><li>s2=v2:NoSchedule</li><li>w1=v1:NoExecute</li></ul><p>åˆ™èŠ‚ç‚¹æœ‰ä¸‰ä¸ªæ±¡ç‚¹ã€‚</p></blockquote><p>ç»™èŠ‚ç‚¹æ·»åŠ æ±¡ç‚¹ï¼š</p><p><code>kubectl taint node &lt;node-name&gt; &lt;key&gt;=&lt;value&gt;:&lt;effect&gt; </code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸¾ä¾‹ k,véšä¾¿èµ·</span></span><br><span class="line">$ kubectl taint node kube-node1 node-type=production:NoShedule</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹èŠ‚ç‚¹æ±¡ç‚¹:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes &lt;nodename&gt; -o go-template=&#123;&#123;.spec.taints&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸å»ºè®®ï¼Œåªèƒ½è¾“å‡ºä¸€è¡Œï¼Œå±•ç¤ºä¸å…¨</span></span><br><span class="line">$ kubectl describe nodes &lt;nodename&gt; | grep Taint</span><br></pre></td></tr></table></figure><p>åˆ é™¤èŠ‚ç‚¹æ±¡ç‚¹ï¼š</p><p><strong>è¯­æ³•ï¼š</strong><code>kubectl taint node &lt;node-name&gt;&lt;key&gt;[:&lt;effect&gt;]-</code></p><p>åˆ é™¤ key ä¸º node-typeï¼Œeffect ä¸º NoSchedule çš„æ±¡ç‚¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl taint node kube-node1 node-type:NoSchedule-</span><br></pre></td></tr></table></figure><p>åˆ é™¤ key ä¸º node-type çš„æ‰€æœ‰æ±¡ç‚¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl taint node kube-node1 node-type-</span><br></pre></td></tr></table></figure><p>åˆ é™¤æ‰€æœ‰æ±¡ç‚¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl patch nodes &lt;node-name&gt; -p <span class="string">&#x27;&#123;&quot;spec&quot;:&#123;&quot;taints&quot;:[]&#125;&#125;&#x27;</span> </span><br></pre></td></tr></table></figure><h4 id="åœºæ™¯"><a href="#åœºæ™¯" class="headerlink" title="åœºæ™¯"></a>åœºæ™¯</h4><p>æ±¡ç‚¹ç”¨äºï¼š</p><ol><li>ä¸“ç”¨èŠ‚ç‚¹</li><li>é…ç½®ç‰¹åˆ«ç¡¬ä»¶çš„èŠ‚ç‚¹</li><li>åŸºäºTainté©±é€Pod</li></ol><h2 id="PodæŸ¥çœ‹å¸¸ç”¨å‘½ä»¤ğŸ”º"><a href="#PodæŸ¥çœ‹å¸¸ç”¨å‘½ä»¤ğŸ”º" class="headerlink" title="PodæŸ¥çœ‹å¸¸ç”¨å‘½ä»¤ğŸ”º"></a>PodæŸ¥çœ‹å¸¸ç”¨å‘½ä»¤ğŸ”º</h2><p>æŸ¥çœ‹Podåˆ†é…çš„èŠ‚ç‚¹å’ŒIP</p><p><code>kubectl get pods -o wide</code></p><h2 id="æœ‰çŠ¶æ€ä¸æ— çŠ¶æ€PodğŸ”º"><a href="#æœ‰çŠ¶æ€ä¸æ— çŠ¶æ€PodğŸ”º" class="headerlink" title="æœ‰çŠ¶æ€ä¸æ— çŠ¶æ€PodğŸ”º"></a>æœ‰çŠ¶æ€ä¸æ— çŠ¶æ€PodğŸ”º</h2><p><strong>æ— çŠ¶æ€åº”ç”¨ï¼ˆStateless Applicationï¼‰</strong>æ˜¯æŒ‡åº”ç”¨ä¸ä¼šåœ¨ä¼šè¯ä¸­ä¿å­˜ä¸‹æ¬¡ä¼šè¯æ‰€éœ€è¦çš„å®¢æˆ·ç«¯æ•°æ®ã€‚æ¯ä¸€ä¸ªä¼šè¯éƒ½åƒé¦–æ¬¡æ‰§è¡Œä¸€æ ·ï¼Œä¸ä¼šä¾èµ–ä¹‹å‰çš„æ•°æ®è¿›è¡Œå“åº”ã€‚<strong>æœ‰çŠ¶æ€çš„åº”ç”¨ï¼ˆStateful Applicationï¼‰</strong>æ˜¯æŒ‡åº”ç”¨ä¼šåœ¨ä¼šè¯ä¸­ä¿å­˜å®¢æˆ·ç«¯çš„æ•°æ®ï¼Œå¹¶åœ¨å®¢æˆ·ç«¯ä¸‹ä¸€æ¬¡çš„è¯·æ±‚ä¸­æ¥ä½¿ç”¨é‚£äº›æ•°æ®ã€‚</p><h3 id="æ— çŠ¶æ€"><a href="#æ— çŠ¶æ€" class="headerlink" title="æ— çŠ¶æ€"></a>æ— çŠ¶æ€</h3><p>æ˜¯æŒ‡è¯¥æœåŠ¡è¿è¡Œçš„å®ä¾‹ä¸ä¼šåœ¨æœ¬åœ°å­˜å‚¨éœ€è¦æŒä¹…åŒ–çš„æ•°æ®ï¼Œå¹¶ä¸”å¤šä¸ªå®ä¾‹å¯¹äºåŒä¸€ä¸ªè¯·æ±‚å“åº”çš„ç»“æœæ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚</p><p>å¤šä¸ªå®ä¾‹å¯ä»¥å…±äº«ç›¸åŒçš„æŒä¹…åŒ–æ•°æ®ã€‚ä¾‹å¦‚ï¼šnginxå®ä¾‹ï¼Œtomcatå®ä¾‹ç­‰</p><p>ç›¸å…³çš„k8sèµ„æºæœ‰ï¼šReplicaSetã€ReplicationControllerã€Deploymentç­‰ï¼Œç”±äºæ˜¯æ— çŠ¶æ€æœåŠ¡ï¼Œæ‰€ä»¥è¿™äº›æ§åˆ¶å™¨åˆ›å»ºçš„podåºå·éƒ½æ˜¯éšæœºå€¼ã€‚å¹¶ä¸”åœ¨ç¼©å®¹çš„æ—¶å€™å¹¶ä¸ä¼šæ˜ç¡®ç¼©å®¹æŸä¸€ä¸ªpodï¼Œè€Œæ˜¯éšæœºçš„ï¼Œå› ä¸ºæ‰€æœ‰å®ä¾‹å¾—åˆ°çš„è¿”å›å€¼éƒ½æ˜¯ä¸€æ ·ï¼Œæ‰€ä»¥ç¼©å®¹ä»»ä½•ä¸€ä¸ªpodéƒ½å¯ä»¥ã€‚</p><blockquote><p>æ€»ç»“</p><ol><li>Podéƒ½ä¸€æ ·ï¼Œå¯¹äºåŒä¸€ä¸ªè¯·æ±‚å“åº”çš„ç»“æœæ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚</li><li>Podä¹‹é—´æ²¡æœ‰å¯åŠ¨é¡ºåº</li><li>Podä¸ç”¨è€ƒè™‘åœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Šå¯åŠ¨</li><li>éšæ„æ‰©å®¹å’Œä¼¸ç¼©</li></ol></blockquote><h3 id="æœ‰çŠ¶æ€"><a href="#æœ‰çŠ¶æ€" class="headerlink" title="æœ‰çŠ¶æ€"></a>æœ‰çŠ¶æ€</h3><p>ä¸Šé¢æ— çŠ¶æ€çš„æ€»ç»“éƒ½éœ€è¦è€ƒè™‘åˆ°ã€‚æœ‰çŠ¶æ€çš„Podå¾ˆéœ€è¦æ•°æ®å·ï¼ŒPodä¹‹é—´æ˜¯ä¸åŒçš„æ¯ä¸ªPodä¸åŒçš„Ipé‡Œé¢å­˜å‚¨çš„èµ„æºä¹Ÿä¸å°½ç›¸åŒï¼Œä¹Ÿæœ‰å¯åŠ¨é¡ºåºçš„éœ€è¦ï¼Œä¾‹å¦‚Mysqlä¸»ä»Podï¼Œè‚¯å®šå…ˆä¸»åä»å¯åŠ¨ã€‚</p><p>å½“Podåˆ†é…Nodeæ‰§è¡Œæ—¶ï¼Œå¦‚æœNodeä¸Šæ²¡æœ‰ä¹‹å‰çš„æ•°æ®å·ï¼Œåˆ™ä¸è¡Œï¼Œè¦åœ¨ä¹‹å‰çš„Nodeä¸Šè¿è¡ŒPodåˆæˆ–è€…æœ‰å…±äº«å­˜å‚¨å·ã€‚</p><p>StatefulSet ç¼©å®¹ä»»ä½•æ—¶å€™åªä¼šæ“ä½œ ä¸€ä¸ª pod å®ä¾‹ï¼Œæ‰€ä»¥æœ‰çŠ¶æ€åº”ç”¨çš„ç¼©å®¹ä¸ä¼šå¾ˆè¿…é€Ÿã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œ ä¸€ä¸ªåˆ†å¸ƒå¼å­˜å‚¨åº”ç”¨è‹¥åŒæ—¶ä¸‹çº¿å¤šä¸ªèŠ‚ç‚¹ ï¼Œåˆ™å¯èƒ½å¯¼è‡´å…¶æ•°æ®ä¸¢å¤± ã€‚ æ¯”å¦‚è¯´ä¸€ä¸ªæ•°æ®é¡¹å‰¯æœ¬æ•°è®¾ç½®ä¸º 2 çš„æ•°æ®å­˜å‚¨åº”ç”¨ï¼Œ è‹¥ åŒæ—¶æœ‰ä¸¤ä¸ªèŠ‚ç‚¹ä¸‹çº¿ï¼Œä¸€ä»½æ•°æ®è®°å½•å°±ä¼šä¸¢å¤±ï¼Œå¦‚æœå®ƒæ­£å¥½ä¿å­˜åœ¨è¿™ä¸¤ä¸ªèŠ‚ç‚¹ä¸Š ã€‚ è‹¥ç¼©å®¹æ˜¯çº¿æ€§çš„ ï¼Œåˆ™åˆ†å¸ƒå¼å­˜å‚¨åº”ç”¨å°±æœ‰æ—¶é—´æŠŠä¸¢å¤±çš„å‰¯æœ¬å¤åˆ¶åˆ°å…¶ä»–èŠ‚ç‚¹ ï¼Œä¿è¯æ•°æ®ä¸ä¼šä¸¢å¤±ã€‚</p><h1 id="Label"><a href="#Label" class="headerlink" title="Label"></a>Label</h1><h2 id="Label-æ¦‚è¿°"><a href="#Label-æ¦‚è¿°" class="headerlink" title="Label æ¦‚è¿°"></a><strong>Label æ¦‚è¿°</strong></h2><p>Label æ˜¯ Kubernetes ç³»ç»Ÿä¸­å¦ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‚ä¸€ä¸ª Label æ˜¯ä¸€ä¸ª key=value çš„é”®å€¼å¯¹ï¼Œå…¶ä¸­ key ä¸ value ç”±ç”¨æˆ·è‡ªå·±æŒ‡ å®šã€‚Label å¯ä»¥é™„åŠ åˆ°å„ç§èµ„æºå¯¹è±¡ä¸Šï¼Œå¦‚ Nodeã€Podã€Serviceã€RCï¼Œä¸€ä¸ªèµ„æºå¯¹è±¡å¯ä»¥å®šä¹‰ä»»æ„æ•°é‡çš„ Labelï¼Œ åŒä¸€ä¸ª Label ä¹Ÿå¯ä»¥è¢«æ·»åŠ åˆ°ä»»æ„æ•°é‡çš„èµ„æºå¯¹è±¡ä¸Šï¼ŒLabel é€šå¸¸åœ¨èµ„æºå¯¹è±¡å®šä¹‰æ—¶ç¡®å®šï¼Œä¹Ÿå¯ä»¥åœ¨å¯¹è±¡åˆ›å»ºååŠ¨æ€æ·»åŠ æˆ–åˆ é™¤ã€‚ </p><p>Label çš„æœ€å¸¸è§çš„ç”¨æ³•æ˜¯ä½¿ç”¨ metadata.labels å­—æ®µï¼Œæ¥ä¸ºå¯¹è±¡æ·»åŠ  Labelï¼Œé€šè¿‡spec.selector æ¥å¼•ç”¨å¯¹è±¡ ã€‚</p><p>Label é™„åŠ åˆ° Kubernetes é›†ç¾¤ä¸­å„ç§èµ„æºå¯¹è±¡ä¸Šï¼Œç›®çš„å°±æ˜¯å¯¹è¿™äº›èµ„æºå¯¹è±¡è¿›è¡Œåˆ†ç»„ç®¡ç†ï¼Œè€Œåˆ†ç»„ç®¡ç†çš„æ ¸å¿ƒå°±æ˜¯ Label Selectorã€‚Label ä¸ Label Selector éƒ½æ˜¯ä¸èƒ½å•ç‹¬å®šä¹‰ï¼Œå¿…é¡»é™„åŠ åœ¨ä¸€äº›èµ„æºå¯¹è±¡çš„å®šä¹‰æ–‡ä»¶ä¸Šï¼Œä¸€èˆ¬é™„åŠ  åœ¨ RC å’Œ Service çš„èµ„æºå®šä¹‰æ–‡ä»¶ä¸­ã€‚</p><h1 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h1><h2 id="æ¦‚è¿°-1"><a href="#æ¦‚è¿°-1" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>Controlleræ˜¯åœ¨é›†ç¾¤ä¸Šç®¡ç†å’Œè¿è¡Œå®¹å™¨çš„å¯¹è±¡ã€‚</p><p><strong>1.Podä¸Controllerçš„å…³ç³»</strong></p><p>Podæ˜¯é€šè¿‡Controller<strong>å®ç°åº”ç”¨çš„è¿ç»´ï¼Œæ¯”å¦‚ä¼¸ç¼©ã€æ»šåŠ¨å‡çº§ç­‰ç­‰</strong>ã€‚</p><p>Podå’Œ Controllerä¹‹é—´é€šè¿‡labelæ ‡ç­¾å’Œselectoré€‰æ‹©å™¨å»ºç«‹å…³ç³»</p><blockquote><p>æ§åˆ¶å™¨æœ‰ï¼š</p><ol><li><strong>Replication Controller</strong></li><li><strong>Replica Set</strong></li><li><strong>Deployment</strong></li><li><strong>Horizontal Pod Autoscaler</strong></li></ol></blockquote><blockquote><p><strong>æ³¨æ„</strong></p><p><strong>Replication Controller</strong>ã€<strong>Replica Set</strong>ã€<strong>Deployment</strong>éƒ½æ˜¯æ— çŠ¶æ€çš„Podçš„æ§åˆ¶å™¨ã€‚</p><p>statefulSetæ˜¯æœ‰çŠ¶æ€çš„Podçš„æ§åˆ¶å™¨ã€‚</p></blockquote><h2 id="æ— çŠ¶æ€Podæ§åˆ¶å™¨"><a href="#æ— çŠ¶æ€Podæ§åˆ¶å™¨" class="headerlink" title="æ— çŠ¶æ€Podæ§åˆ¶å™¨"></a>æ— çŠ¶æ€Podæ§åˆ¶å™¨</h2><h3 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h3><p>Deploymentæ˜¯ä¸€ç§å¸¸ç”¨çš„Controllerã€‚</p><p>Deployment æ˜¯ Kubenetes v1.2 å¼•å…¥çš„æ–°æ¦‚å¿µï¼Œå¼•å…¥çš„ç›®çš„æ˜¯ä¸ºäº†æ›´å¥½çš„è§£å†³ Pod çš„ç¼–æ’é—®é¢˜ï¼ŒDeployment å†…éƒ¨ä½¿ç”¨äº† Replica Set æ¥å®ç°ã€‚</p><h4 id="åº”ç”¨åœºæ™¯"><a href="#åº”ç”¨åœºæ™¯" class="headerlink" title="åº”ç”¨åœºæ™¯"></a><strong>åº”ç”¨åœºæ™¯</strong></h4><ul><li>éƒ¨ç½²æ— çŠ¶æ€åº”ç”¨(webã€å¾®æœåŠ¡)</li><li>ç®¡ç†Podå’ŒReplicaSet(Podå‰¯æœ¬)</li><li>éƒ¨ç½²ã€æ»šåŠ¨å‡çº§ç­‰åŠŸèƒ½</li></ul><h4 id="Deploymentéƒ¨ç½²åº”ç”¨"><a href="#Deploymentéƒ¨ç½²åº”ç”¨" class="headerlink" title="Deploymentéƒ¨ç½²åº”ç”¨"></a>Deploymentéƒ¨ç½²åº”ç”¨</h4><p><strong>1.ä½¿ç”¨yamlæ–‡ä»¶éƒ¨ç½²ï¼Œé¦–å…ˆå¯¼å‡ºyamlæ¨¡æ¿</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create deployment web --image=nginx --dry-run=client -o yaml &gt; web.yaml</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¯´åˆ°Podå’Œ Controllerä¹‹é—´é€šè¿‡labelæ ‡ç­¾å’Œselectoré€‰æ‹©å™¨å»ºç«‹å…³ç³»ï¼Œä¸‹å›¾è¯æ˜äº†ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201123165244192.png" alt="image-20201123165244192"></p><p><strong>2.ä½¿ç”¨yamlæ–‡ä»¶éƒ¨ç½²</strong></p><p><strong>åˆ›å»ºçš„æ˜¯pod</strong>ï¼Œé€šè¿‡web.yamlçš„å†…å®¹å¾—çŸ¥ï¼Œè¯¦ç»†è¯·çœ‹ä¸‹å›¾</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f web.yaml</span><br></pre></td></tr></table></figure><p><strong>3.å¯¹å¤–å‘å¸ƒ(æš´éœ²å¯¹å¤–ç«¯å£)</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl expose deployment web --port 80 --<span class="built_in">type</span>=NodePort --target-port=80 --name=web1 -o yaml &gt; web1.yaml</span><br></pre></td></tr></table></figure><blockquote><p>å°†èµ„æºæš´éœ²ä¸º<font color="red"><strong>æ–°çš„Kubernetes Serviceã€‚</strong></font></p><p>æŒ‡å®š<code>deployment</code>ã€<code>service</code>ã€<code>replica set</code>ã€<code>replication controller</code>æˆ–<code>pod</code>ï¼Œå¹¶ä½¿ç”¨è¯¥èµ„æºçš„é€‰æ‹©å™¨ä½œä¸ºæŒ‡å®šç«¯å£ä¸Šæ–°æœåŠ¡çš„é€‰æ‹©å™¨ã€‚<strong>deployment æˆ– replica setåªæœ‰å½“å…¶é€‰æ‹©å™¨å¯è½¬æ¢ä¸ºserviceæ”¯æŒçš„é€‰æ‹©å™¨æ—¶ï¼Œå³å½“é€‰æ‹©å™¨ä»…åŒ…å«matchLabelsç»„ä»¶æ—¶æ‰ä¼šä½œä¸ºæš´éœ²æ–°çš„Serviceã€‚</strong></p><ul><li>â€“portï¼šèµ„æºçš„ç«¯å£ï¼ˆè¿™é‡Œæ˜¯deploymentçš„ç«¯å£ï¼‰</li><li>â€“target-portï¼šå®¹å™¨çš„ç«¯å£</li><li>â€“typeï¼šType for this service: ClusterIP, NodePort, or LoadBalancer. Default is â€˜ClusterIPâ€™.(è¯¥æœåŠ¡çš„ç±»å‹ï¼šClusterIPï¼ŒNodePortæˆ–LoadBalancerã€‚é»˜è®¤å€¼ä¸ºâ€œ ClusterIPâ€)</li></ul><p>å› ä¸ºæˆ‘ä»¬æ˜¯æš´éœ²ç«¯å£ï¼Œæ‰€ä»¥typeé€‰æ‹©NodePort</p></blockquote><p><strong>4.é‡æ–°åº”ç”¨yamlæ–‡ä»¶</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f web1.yaml</span><br></pre></td></tr></table></figure><p><strong>åˆ›å»ºçš„æ˜¯service</strong>ï¼Œå› ä¸º<code>web.yaml</code>ä¸<code>web1.yaml</code>çš„åŒºåˆ«å†…å®¹ä¸ºï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201124114353266.png" alt="image-20201124114353266"></p><blockquote><p>ç”±æ­¤å›¾å¾—çŸ¥ï¼š</p><ul><li>createæ—¶åˆ›å»ºçš„æ˜¯æ‰‹åŠ¨é€‰æ‹©çš„<code>deployment</code>ï¼›è€Œexposeæ—¶ï¼Œæ˜¯åˆ›å»ºäº†<code>Service</code></li><li><code>deployment</code>å’Œ<code>Service</code>éƒ½æ˜¯é€šè¿‡Podä¸Šçš„æ ‡ç­¾iä»¥åŠé€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨æ¥å¯»æ‰¾Pod</li><li><code>Service</code>æœ‰IPå¯ä»¥é€šè¿‡å…¶è®¿é—®åˆ°Podï¼Œç›´æ¥é€šè¿‡Podè®¿é—®å†…å®¹ä¸ç¨³å®šã€‚</li></ul></blockquote><hr><p><strong>ä¸Šè¿°çš„æ­¥éª¤è¾ƒå¤šã€‚å…¶å®ï¼Œæœ€åä½ å‡†å¤‡ä¸€ä¸ªå®Œæ•´çš„yamlï¼Œå°±å¯ä»¥ç›´æ¥éƒ¨ç½²äº†ã€‚</strong></p><h5 id="å‡çº§å›æ»š"><a href="#å‡çº§å›æ»š" class="headerlink" title="å‡çº§å›æ»š"></a>å‡çº§å›æ»š</h5><p><strong>å‡çº§</strong></p><p>å¯¹å·²æœ‰deploymentçš„èµ„æºè¿›è¡Œä»¥ä¸‹æ“ä½œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubactl <span class="built_in">set</span> image deployment xxx nginx=nginx:xxx</span><br></pre></td></tr></table></figure><blockquote><p><strong>å‡çº§è¿‡ç¨‹</strong></p><ol><li>ä¸‹è½½æœ€æ–°é•œåƒ</li><li>è¿è¡Œå®¹å™¨</li><li>å½“æœ€æ–°å®¹å™¨è¿è¡Œå¥½äº†åç›´æ¥æ›¿æ¢æ—§çš„å®¹å™¨</li></ol></blockquote><p>æŸ¥çœ‹åº”ç”¨æ˜¯å¦å‡çº§æˆåŠŸï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl rollout status deployment xxx</span><br></pre></td></tr></table></figure><p><strong>å›æ»š</strong></p><p>å½“é•œåƒæ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬åï¼Œå‘ç°äº†å…¶ä»–é—®é¢˜ï¼Œéœ€è¦å›æ»šåˆ°ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œè¿™ç§åœºæ™¯å¾ˆå¸¸è§ã€‚</p><blockquote><p>æŸ¥çœ‹deploymentå†å²ç‰ˆæœ¬</p><p><code>kubectl rollout history deployment xxx</code></p><p>å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬</p><p><code>kubectl rollout undo deployment xxx</code></p><p>å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬</p><p><code>kubectl rollout undo deployment xxx --to-revision=xx</code></p></blockquote><h5 id="å¼¹æ€§ä¼¸ç¼©"><a href="#å¼¹æ€§ä¼¸ç¼©" class="headerlink" title="å¼¹æ€§ä¼¸ç¼©"></a>å¼¹æ€§ä¼¸ç¼©</h5><p>å½“å‘ç°æµ‹æœåŠ¡çƒ­é—¨ï¼Œå½“å‰èµ„æºä¸å¤Ÿç”¨æ—¶ï¼Œå¯ä»¥æ‰©å±•æœåŠ¡çš„ä¸ªæ•°ï¼š</p><p><code>kubectl scale deployment xxx --replicas=x</code></p><h3 id="Replication-Controller"><a href="#Replication-Controller" class="headerlink" title="Replication Controller"></a>Replication Controller</h3><p>Replication Controller(RC)æ˜¯ Kubernetes ç³»ç»Ÿä¸­æ ¸å¿ƒæ¦‚å¿µä¹‹ä¸€ï¼Œå½“æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª RCå¹¶æäº¤åˆ° Kubernetes é›†ç¾¤ä¸­ä»¥åï¼ŒMaster èŠ‚ç‚¹ä¸Šçš„ Controller Manager ç»„ä»¶å°±å¾—åˆ°é€šçŸ¥ï¼Œå®šæœŸæ£€æŸ¥ç³»ç»Ÿä¸­å­˜æ´»çš„ Pod,å¹¶ç¡®ä¿ç›®æ ‡ Pod å®ä¾‹çš„æ•°é‡åˆšå¥½ç­‰äº RC çš„é¢„æœŸå€¼ï¼Œå¦‚æœæœ‰è¿‡å¤šæˆ–è¿‡å°‘çš„ Pod è¿è¡Œï¼Œç³»ç»Ÿå°±ä¼šåœæ‰æˆ–åˆ›å»ºä¸€äº› Pod.æ­¤å¤–æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹ RC çš„å‰¯æœ¬æ•°é‡ï¼Œæ¥å®ç° Pod çš„åŠ¨æ€ç¼©æ”¾åŠŸèƒ½ã€‚</p><p><code>kubectl scale rc nginx --replicas=5 </code></p><p>ç”±äº Replication Controller ä¸ Kubernetes ä»£ç ä¸­çš„æ¨¡å— Replication Controller åŒåï¼Œ<strong>æ‰€ä»¥åœ¨ Kubernetes v1.2 æ—¶ï¼Œ å®ƒå°±å‡çº§æˆäº†å¦å¤–ä¸€ä¸ªæ–°çš„æ¦‚å¿µ Replica Sets,å®˜æ–¹è§£é‡Šä¸ºä¸‹ä¸€ä»£çš„ RC</strong>ï¼Œå®ƒä¸ RC åŒºåˆ«æ˜¯:Replica Sets æ”¯æ´åŸºäºé›†åˆçš„ Label selector,è€Œ RC åªæ”¯æŒåŸºäºç­‰å¼çš„ Label Selectorã€‚æˆ‘ä»¬å¾ˆå°‘å•ç‹¬ä½¿ç”¨ Replica Set,å®ƒä¸»è¦è¢« Deployment è¿™ä¸ªæ›´é«˜å±‚é¢çš„èµ„æºå¯¹è±¡æ‰€ä½¿ç”¨ï¼Œä»è€Œå½¢æˆä¸€æ•´å¥— Pod åˆ›å»ºã€åˆ é™¤ã€æ›´æ–°çš„ç¼–æ’æœºåˆ¶ã€‚æœ€å¥½ä¸è¦è¶Šè¿‡ RC ç›´æ¥åˆ›å»º Podï¼Œ å› ä¸º Replication Controller ä¼šé€šè¿‡ RC ç®¡ç† Pod å‰¯æœ¬ï¼Œå®ç°è‡ªåŠ¨åˆ›å»ºã€è¡¥è¶³ã€æ›¿æ¢ã€åˆ é™¤ Pod å‰¯æœ¬ï¼Œè¿™æ ·å°±èƒ½æé«˜åº”ç”¨çš„å®¹ç¾èƒ½åŠ›ï¼Œå‡å°‘ç”±äºèŠ‚ç‚¹ å´©æºƒç­‰æ„å¤–çŠ¶å†µé€ æˆçš„æŸå¤±ã€‚å³ä½¿åº”ç”¨ç¨‹åºåªæœ‰ä¸€ä¸ª Pod å‰¯æœ¬ï¼Œä¹Ÿå¼ºçƒˆå»ºè®®ä½¿ç”¨ RC æ¥ å®šä¹‰ Podã€‚</p><h3 id="Replica-Set"><a href="#Replica-Set" class="headerlink" title="Replica Set"></a>Replica Set</h3><p>ReplicaSet è·Ÿ ReplicationController æ²¡æœ‰æœ¬è´¨çš„ä¸åŒï¼Œåªæ˜¯åå­—ä¸ä¸€æ ·ï¼Œ<strong>å¹¶ä¸”ReplicaSet æ”¯æŒé›†åˆå¼çš„ selectorï¼ˆReplicationController ä»…æ”¯æŒç­‰å¼ï¼‰</strong>ã€‚ <font color="red"><strong>Kubernetes å®˜æ–¹å¼ºçƒˆå»ºè®®é¿å…ç›´æ¥ä½¿ç”¨ ReplicaSet</strong></font>ï¼Œè€Œåº”è¯¥é€šè¿‡ Deployment æ¥åˆ›å»º RS å’ŒPodã€‚ç”±äº ReplicaSet æ˜¯ ReplicationController çš„ä»£æ›¿ç‰©ï¼Œå› æ­¤ç”¨æ³•åŸºæœ¬ç›¸åŒï¼Œå”¯ä¸€çš„åŒºåˆ«åœ¨äº ReplicaSet æ”¯æŒé›†åˆå¼çš„ selector</p><hr><h2 id="æœ‰çŠ¶æ€çš„Podçš„æ§åˆ¶å™¨"><a href="#æœ‰çŠ¶æ€çš„Podçš„æ§åˆ¶å™¨" class="headerlink" title="æœ‰çŠ¶æ€çš„Podçš„æ§åˆ¶å™¨"></a>æœ‰çŠ¶æ€çš„Podçš„æ§åˆ¶å™¨</h2><p>æœ‰çŠ¶æ€çš„Podçš„æ§åˆ¶å™¨ä¸ºï¼š<code>StatefulSet</code></p><p>Kubernetesåœ¨1.9ç‰ˆæœ¬ä¸­æ­£å¼å‘å¸ƒçš„StatefulSetæ§åˆ¶å™¨èƒ½æ”¯æŒï¼š</p><ul><li><strong>Podä¼šè¢«é¡ºåºéƒ¨ç½²å’Œé¡ºåºç»ˆç»“</strong>ï¼šStatefulSetä¸­çš„å„ä¸ª Podä¼šè¢«é¡ºåºåœ°åˆ›å»ºå‡ºæ¥ï¼Œæ¯ä¸ªPodéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„IDï¼Œåœ¨åˆ›å»ºåç»­ Pod ä¹‹å‰ï¼Œé¦–å…ˆè¦ç­‰å‰é¢çš„ Pod è¿è¡ŒæˆåŠŸå¹¶è¿›å…¥åˆ°å°±ç»ªçŠ¶æ€ã€‚åˆ é™¤ä¼šé”€æ¯StatefulSet ä¸­çš„æ¯ä¸ª Podï¼Œå¹¶ä¸”æŒ‰ç…§åˆ›å»ºé¡ºåºçš„ååºæ¥æ‰§è¡Œï¼Œåªæœ‰åœ¨æˆåŠŸç»ˆç»“åé¢ä¸€ä¸ªä¹‹åï¼Œæ‰ä¼šç»§ç»­ä¸‹ä¸€ä¸ªåˆ é™¤æ“ä½œã€‚</li><li><strong>Podå…·æœ‰å”¯ä¸€ç½‘ç»œåç§°</strong>ï¼šPodå…·æœ‰å”¯ä¸€çš„åç§°ï¼Œè€Œä¸”åœ¨é‡å¯åä¼šä¿æŒä¸å˜ã€‚é€šè¿‡HeadlessæœåŠ¡ï¼ŒåŸºäºä¸»æœºåï¼Œæ¯ä¸ª Pod éƒ½æœ‰ç‹¬ç«‹çš„ç½‘ç»œåœ°å€ï¼Œè¿™ä¸ªç½‘åŸŸç”±ä¸€ä¸ªHeadless æœåŠ¡æ‰€æ§åˆ¶ã€‚è¿™æ ·æ¯ä¸ªPodä¼šä¿æŒç¨³å®šçš„å”¯ä¸€çš„åŸŸåï¼Œä½¿å¾—é›†ç¾¤å°±ä¸ä¼šå°†é‡æ–°åˆ›å»ºå‡ºçš„Podä½œä¸ºæ–°æˆå‘˜ã€‚</li><li><strong>Podèƒ½æœ‰ç¨³å®šçš„æŒä¹…å­˜å‚¨</strong>ï¼šStatefulSetä¸­çš„æ¯ä¸ªPodå¯ä»¥æœ‰å…¶è‡ªå·±ç‹¬ç«‹çš„PersistentVolumeClaimå¯¹è±¡ã€‚å³ä½¿Podè¢«é‡æ–°è°ƒåº¦åˆ°å…¶å®ƒèŠ‚ç‚¹ä¸Šä»¥åï¼ŒåŸæœ‰çš„æŒä¹…ç£ç›˜ä¹Ÿä¼šè¢«æŒ‚è½½åˆ°è¯¥Podã€‚</li><li><strong>Podèƒ½è¢«é€šè¿‡HeadlessæœåŠ¡è®¿é—®åˆ°</strong>ï¼šå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡æœåŠ¡çš„åŸŸåè¿æ¥åˆ°ä»»æ„Podã€‚</li></ul><p><strong>å”¯ä¸€IDè§„åˆ™ï¼Ÿï¼Ÿ</strong></p><p>é€šè¿‡statefulSetï¼Œç”±äºæ˜¯æœ‰çŠ¶æ€çš„æœåŠ¡ï¼Œæ‰€ä»¥æ¯ä¸ªpodéƒ½æœ‰ç‰¹å®šçš„åç§°å’Œç½‘ç»œæ ‡è¯†ã€‚æ¯”å¦‚podåæ˜¯ç”±statefulSetå+æœ‰åºçš„æ•°å­—ç»„æˆï¼ˆ0ã€1ã€2..ï¼‰</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-02_20-15-50.png" alt="Snipaste_2020-12-02_20-15-50"></p><p>è¿˜å¯ä»¥é€šè¿‡åŸŸåå¯¹Podå½¢æˆ1å¯¹1çš„å…³è”å…³ç³»ï¼Œä¸Šé¢è¯´äº†Podåï¼ˆä¸»æœºåç§°ï¼‰è§„åˆ™ï¼Œä¸‹é¢å”¯ä¸€æ ‡è¯†çš„è§„åˆ™ä¸ºï¼š</p><p><code>ä¸»æœºå.serviceåç§°.åç§°ç©ºé—´.svc.local</code></p><h2 id="ä¸€æ¬¡æ€§ä»»åŠ¡"><a href="#ä¸€æ¬¡æ€§ä»»åŠ¡" class="headerlink" title="ä¸€æ¬¡æ€§ä»»åŠ¡"></a>ä¸€æ¬¡æ€§ä»»åŠ¡</h2><p>Job å…¶å®å°±æ˜¯æ ¹æ®å®šä¹‰èµ·ä¸€ä¸ªæˆ–å¤šä¸ª pod æ¥æ‰§è¡Œä»»åŠ¡ï¼Œpod æ‰§è¡Œå®Œé€€å‡ºåï¼Œè¿™ä¸ª Job å°±å®Œæˆäº†ã€‚æ‰€ä»¥ Job åˆç§°ä¸º Batch Job ï¼Œå³è®¡ç®—ä¸šåŠ¡æˆ–ç¦»çº¿ä¸šåŠ¡ã€‚</p><h3 id="Jobä½¿ç”¨æ–¹æ³•"><a href="#Jobä½¿ç”¨æ–¹æ³•" class="headerlink" title="Jobä½¿ç”¨æ–¹æ³•"></a>Jobä½¿ç”¨æ–¹æ³•</h3><p>Job çš„ YAML å®šä¹‰ä¸ Deployment ååˆ†ç›¸ä¼¼ã€‚ä¸ Deployment ä¸åŒçš„æ˜¯ï¼ŒJob ä¸éœ€è¦å®šä¹‰ <code>spec.selector</code> æ¥æŒ‡å®šéœ€è¦æ§åˆ¶çš„ podï¼Œçœ‹ä¸ªä¾‹å­ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">date</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pi</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">perl</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;perl&quot;</span>, <span class="string">&quot;-Mbignum=bpi&quot;</span>, <span class="string">&quot;-wle&quot;</span>, <span class="string">&quot;print bpi(2000)&quot;</span>]</span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬è®¡ç®—äº†Piçš„å€¼ã€‚</p><p><strong>1. å¯åŠ¨Job</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f job.yaml</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201203192035404.png" alt="image-20201203192035404"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201203192057237.png" alt="image-20201203192057237"></p><p><strong>2. æŸ¥çœ‹ç»“æœ</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201203192136897.png" alt="image-20201203192136897"></p><p>pod åœ¨æ‰§è¡Œå®Œæ¯•åï¼ŒçŠ¶æ€ä¼šå˜æˆ <code>Completed</code></p><blockquote><h3 id="pod-é‡å¯ç­–ç•¥"><a href="#pod-é‡å¯ç­–ç•¥" class="headerlink" title="pod é‡å¯ç­–ç•¥"></a>pod é‡å¯ç­–ç•¥</h3><p>åœ¨ Job ä¸­ï¼Œpod çš„é‡å¯ç­–ç•¥ restartPolicy ä¸å…è®¸è¢«è®¾ç½®æˆ Alwaysï¼Œåªå…è®¸è¢«è®¾ç½®ä¸º Never æˆ– OnFailureã€‚è¿™æ˜¯å› ä¸º Job çš„ pod æ‰§è¡Œå®Œæ¯•åç›´æ¥é€€å‡ºï¼Œå¦‚æœ restartPolicy=Alwaysï¼Œpod å°†ä¸æ–­æ‰§è¡Œè®¡ç®—ä½œä¸šï¼Œè¿™å¯ä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„ã€‚</p><p>Job å¯ä»¥è®¾ç½® pod çš„æœ€é•¿è¿è¡Œæ—¶é—´ spec.activeDeadlineSecondsï¼Œä¸€æ—¦è¶…è¿‡äº†è¿™ä¸ªæ—¶é—´ï¼Œè¿™ä¸ª Job çš„æ‰€æœ‰ pod éƒ½ä¼šè¢«ç»ˆæ­¢ã€‚</p><p>é‚£ä¹ˆï¼Œå¦‚æœ pod çš„è®¡ç®—ä½œä¸šå¤±è´¥äº†ï¼Œåœ¨ä¸åŒçš„é‡å¯ç­–ç•¥ä¸‹ä¼šæ€ä¹ˆåŠï¼Ÿ</p><h4 id="restartPolicy-Never"><a href="#restartPolicy-Never" class="headerlink" title="restartPolicy=Never"></a>restartPolicy=Never</h4><p>å¦‚æœè®¾ç½®äº† restartPolicy=Neverï¼Œé‚£ä¹ˆ Job Controller ä¼šä¸æ–­çš„å°è¯•åˆ›å»ºä¸€ä¸ªæ–°çš„ pod å‡ºæ¥ï¼Œé»˜è®¤å°è¯• 6 æ¬¡ã€‚å½“ç„¶è¿™ä¸ªå€¼å¯ä»¥è®¾ç½®ï¼Œå³ Job å¯¹è±¡çš„ spec.backoffLimit å­—æ®µã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé‡æ–°åˆ›å»º Pod çš„é—´éš”æ˜¯å‘ˆæŒ‡æ•°å¢åŠ çš„ã€‚</p><h4 id="restartPolicy-OnFailure"><a href="#restartPolicy-OnFailure" class="headerlink" title="restartPolicy=OnFailure"></a>restartPolicy=OnFailure</h4><p>å¦‚æœè®¾ç½®äº† restartPolicy=Neverï¼Œé‚£ä¹ˆ Job Controller ä¼šä¸æ–­çš„é‡å¯è¿™ä¸ª podã€‚</p></blockquote><h2 id="å®šæ—¶ä»»åŠ¡"><a href="#å®šæ—¶ä»»åŠ¡" class="headerlink" title="å®šæ—¶ä»»åŠ¡"></a>å®šæ—¶ä»»åŠ¡</h2><p>ä½ å¯ä»¥åˆ©ç”¨ CronJobs æ‰§è¡ŒåŸºäºæ—¶é—´è°ƒåº¦çš„ä»»åŠ¡ã€‚è¿™äº›è‡ªåŠ¨åŒ–ä»»åŠ¡å’Œ Linux æˆ–è€… Unix ç³»ç»Ÿçš„ Cron ä»»åŠ¡ç±»ä¼¼ã€‚</p><p>CronJobs åœ¨åˆ›å»ºå‘¨æœŸæ€§ä»¥åŠé‡å¤æ€§çš„ä»»åŠ¡æ—¶å¾ˆæœ‰å¸®åŠ©ï¼Œä¾‹å¦‚æ‰§è¡Œå¤‡ä»½æ“ä½œæˆ–è€…å‘é€é‚®ä»¶ã€‚CronJobs ä¹Ÿå¯ä»¥åœ¨ç‰¹å®šæ—¶é—´è°ƒåº¦å•ä¸ªä»»åŠ¡ï¼Œä¾‹å¦‚ä½ æƒ³è°ƒåº¦ä½æ´»è·ƒå‘¨æœŸçš„ä»»åŠ¡ã€‚</p><h3 id="CronJobä½¿ç”¨æ–¹æ³•"><a href="#CronJobä½¿ç”¨æ–¹æ³•" class="headerlink" title="CronJobä½¿ç”¨æ–¹æ³•"></a>CronJobä½¿ç”¨æ–¹æ³•</h3><p>CronJob éœ€è¦ä¸€ä¸ªé…ç½®æ–‡ä»¶ã€‚ æœ¬ä¾‹ä¸­ CronJob çš„<code>.spec</code> é…ç½®æ–‡ä»¶æ¯åˆ†é’Ÿæ‰“å°å‡ºå½“å‰æ—¶é—´å’Œä¸€ä¸ªé—®å¥½ä¿¡æ¯ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hello</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">schedule:</span> <span class="string">&quot;*/1 * * * *&quot;</span></span><br><span class="line">  <span class="attr">jobTemplate:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">containers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hello</span></span><br><span class="line">            <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">            <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">            <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">date;</span> <span class="string">echo</span> <span class="string">Hello</span> <span class="string">from</span> <span class="string">the</span> <span class="string">Kubernetes</span> <span class="string">cluster</span></span><br><span class="line">          <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br></pre></td></tr></table></figure><p>æƒ³è¦è¿è¡Œç¤ºä¾‹çš„ CronJobï¼Œå¯ä»¥ä¸‹è½½ç¤ºä¾‹æ–‡ä»¶å¹¶æ‰§è¡Œå‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl create -f ./cronjob.yaml</span></span><br></pre></td></tr></table></figure><p><code>cronjob.batch/hello created</code></p><p>åˆ›å»ºå¥½ CronJob åï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥è·å–å…¶çŠ¶æ€ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get cronjob hello</span></span><br></pre></td></tr></table></figure><p>è¾“å‡ºç±»ä¼¼äºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME    SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE</span><br><span class="line">hello   *&#x2F;1 * * * *   False     0        50s             75s</span><br></pre></td></tr></table></figure><p>å°±åƒä½ ä»å‘½ä»¤è¿”å›ç»“æœçœ‹åˆ°çš„é‚£æ ·ï¼ŒCronJob è¿˜æ²¡æœ‰è°ƒåº¦æˆ–æ‰§è¡Œä»»ä½•ä»»åŠ¡ã€‚å¤§çº¦éœ€è¦ä¸€åˆ†é’Ÿä»»åŠ¡æ‰èƒ½åˆ›å»ºå¥½ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl get jobs --watch</span><br><span class="line">NAME               COMPLETIONS   DURATION   AGE</span><br><span class="line">hello-4111706356   0/1                      0s</span><br><span class="line">hello-4111706356   0/1           0s         0s</span><br><span class="line">hello-4111706356   1/1           5s         5s</span><br></pre></td></tr></table></figure><p>ç°åœ¨ä½ å·²ç»çœ‹åˆ°äº†ä¸€ä¸ªè¿è¡Œä¸­çš„ä»»åŠ¡è¢« â€œhelloâ€ CronJob è°ƒåº¦ã€‚ ä½ å¯ä»¥åœæ­¢ç›‘è§†è¿™ä¸ªä»»åŠ¡ï¼Œç„¶åå†æ¬¡æŸ¥çœ‹ CronJob å°±èƒ½çœ‹åˆ°å®ƒè°ƒåº¦ä»»åŠ¡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get cronjob hello</span></span><br></pre></td></tr></table></figure><p>è¾“å‡ºç±»ä¼¼äºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME    SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE</span><br><span class="line">hello   *&#x2F;1 * * * *   False     0        50s             75s</span><br></pre></td></tr></table></figure><p>ä½ åº”è¯¥èƒ½çœ‹åˆ° â€œhelloâ€ CronJob åœ¨ <code>LAST-SCHEDULE</code> å£°æ˜çš„æ—¶é—´ç‚¹æˆåŠŸçš„è°ƒåº¦äº†ä¸€æ¬¡ä»»åŠ¡ã€‚ æœ‰ 0 ä¸ªæ´»è·ƒçš„ä»»åŠ¡æ„å‘³ç€ä»»åŠ¡æ‰§è¡Œå®Œæ¯•æˆ–è€…æ‰§è¡Œå¤±è´¥ã€‚</p><p>ç°åœ¨ï¼Œæ‰¾åˆ°æœ€åä¸€æ¬¡è°ƒåº¦ä»»åŠ¡åˆ›å»ºçš„ Pod å¹¶æŸ¥çœ‹ä¸€ä¸ª Pod çš„æ ‡å‡†è¾“å‡ºã€‚è¯·æ³¨æ„ä»»åŠ¡åç§°å’Œ Pod åç§°æ˜¯ä¸åŒçš„ã€‚</p><blockquote><p><strong>è¯´æ˜ï¼š</strong> Job åç§°å’Œ Pod åç§°ä¸åŒã€‚</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> åœ¨ä½ çš„ç³»ç»Ÿä¸Šå°† <span class="string">&quot;hello-4111706356&quot;</span> æ›¿æ¢ä¸º Job åç§°</span></span><br><span class="line">pods=$(kubectl get pods --selector=job-name=hello-4111706356 --output=jsonpath=&#123;.items..metadata.name&#125;)</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ Pod æ—¥å¿—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs $pods</span><br><span class="line">Fri Feb 22 11:02:09 UTC 2019</span><br><span class="line">Hello from the Kubernetes cluster</span><br></pre></td></tr></table></figure><p>å½“ä½ ä¸å†éœ€è¦ CronJob æ—¶ï¼Œå¯ä»¥ç”¨ <code>kubectl delete cronjob</code> åˆ æ‰å®ƒï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete cronjob hello</span><br></pre></td></tr></table></figure><p>åˆ é™¤ CronJob ä¼šæ¸…é™¤å®ƒåˆ›å»ºçš„æ‰€æœ‰ä»»åŠ¡å’Œ Podï¼Œå¹¶é˜»æ­¢å®ƒåˆ›å»ºé¢å¤–çš„ä»»åŠ¡ã€‚</p><h1 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h1><p>Service æ˜¯ Kubernetes æœ€æ ¸å¿ƒæ¦‚å¿µï¼Œé€šè¿‡åˆ›å»º Serviceï¼Œ<strong>å¯ä»¥ä¸ºä¸€ç»„å…·æœ‰ç›¸åŒåŠŸèƒ½çš„å®¹å™¨åº”ç”¨æä¾›ä¸€ä¸ªç»Ÿä¸€çš„å…¥å£åœ°å€</strong>ï¼Œå¹¶ä¸”å°†è¯·æ±‚è´Ÿè½½åˆ†å‘åˆ°åç«¯çš„å„ä¸ªå®¹å™¨åº”ç”¨ä¸Šã€‚ </p><p>ç±»ä¼¼äºå¾®æœåŠ¡çš„æœåŠ¡æ³¨å†Œä¸å‘ç°ä¸­å¿ƒã€‚</p><blockquote><p>å­˜åœ¨æ„ä¹‰ï¼š</p><ul><li>å› ä¸ºPodçš„IPä¸æ–­å˜åŒ–ï¼ŒServiceå…³è”Podï¼Œé˜²æ­¢Podå¤±å»è”ç³»</li><li>å®šä¹‰ä¸€ç»„Podçš„è®¿é—®è§„åˆ™ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰</li></ul></blockquote><p>todo kubeget get svcçš„å›¾ç‰‡</p><h2 id="Serviceä¸Podå…³ç³»"><a href="#Serviceä¸Podå…³ç³»" class="headerlink" title="Serviceä¸Podå…³ç³»"></a>Serviceä¸Podå…³ç³»</h2><p>ä¸Šé¢è¯´åˆ°Serviceé˜²æ­¢ä¸Podå¤±è”ï¼Œæ‰€ä»¥Serviceè¦ä¸Podå»ºç«‹è”ç³»ï¼Œä»–ä»¬æ˜¯ç”¨è¿‡æ ‡ç­¾å’Œæ ‡ç­¾é€‰æ‹©å™¨æ¥å»ºç«‹è”ç³»çš„ã€‚</p><p>ç„¶åè¯´åˆ°Serviceå®šäºä¸€ç»„è®¿é—®Podçš„è§„åˆ™ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸ºä»€ä¹ˆä¸ç›´æ¥é€šè¿‡ipè®¿é—®podå‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ kubectl get pods -l app=mywebapp -o yaml | grep podIP æ¥è·å–Pod çš„ IP åœ°å€å’Œç«¯å£å·æ¥è®¿é—® Tomcat æœåŠ¡ï¼Œä½†æ˜¯ç›´æ¥é€šè¿‡ Pod çš„ IP åœ°å€å’Œç«¯å£è®¿é—®åº”ç”¨æœåŠ¡æ˜¯ä¸å¯é çš„ï¼Œå› ä¸ºå½“ Pod æ‰€åœ¨çš„ Node å‘ç”Ÿæ•…éšœæ—¶ï¼Œ Pod å°†è¢« kubernetes é‡æ–°è°ƒåº¦åˆ° å¦ä¸€å° Nodeï¼ŒPod çš„åœ°å€ä¼šå‘ç”Ÿæ”¹å˜ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶æ¥å®šä¹‰ Serviceï¼Œå† é€šè¿‡kubectl create æ¥åˆ›å»ºï¼Œè¿™æ ·å¯ä»¥é€šè¿‡ Service åœ°å€æ¥è®¿é—®åç«¯çš„ Pod.ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201124113505202.png" alt="image-20201124113505202"></p><h2 id="Serviceçš„ç§ç±»"><a href="#Serviceçš„ç§ç±»" class="headerlink" title="Serviceçš„ç§ç±»"></a>Serviceçš„ç§ç±»</h2><p><a href="#Deployment%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8">ä¸Šé¢æš´éœ²ç«¯å£æ—¶</a>æœ‰ä¸ª<code>--type=xxx</code>ï¼Œè¿™é‡Œæœ‰ä¸‰ä¸ªé€‰é¡¹ï¼Œè¿™å…¶å®å°±æ˜¯Serviceçš„ç§ç±»ï¼Œæ‰€ä»¥<code>expose</code>æ“ä½œæ—¶å°±æ˜¯åˆ›å»ºä¸åŒçš„<code>Service</code>ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-02_19-53-26.png" alt="Snipaste_2020-12-02_19-53-26"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl expose --<span class="built_in">help</span></span><br></pre></td></tr></table></figure><h3 id="ClusterIP"><a href="#ClusterIP" class="headerlink" title="ClusterIP"></a>ClusterIP</h3><p>é»˜è®¤å€¼ï¼Œä¸€èˆ¬åœ¨é›†ç¾¤å†…éƒ¨è®¿é—®æ—¶ä½¿ç”¨ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-02_19-58-04.png" alt="Snipaste_2020-12-02_19-58-04"></p><h3 id="NodePort"><a href="#NodePort" class="headerlink" title="NodePort"></a>NodePort</h3><p>ä¸€èˆ¬ç”¨äºå°†é›†ç¾¤å†…éƒ¨çš„Podæš´éœ²ç»™å¤–ç½‘è®¿é—®æ—¶é‡‡ç”¨è¿™ç§æ¨¡å¼ï¼Œå®ƒå¯ä»¥æš´éœ²Podå†…çš„æŒ‡å®šç«¯å£ï¼Œç„¶åå¯ä»¥é€šè¿‡é›†ç¾¤å†…ä»»ä½•ä¸€å°æœºå™¨çš„IPåŠ ä¸Šéšæœºæš´éœ²çš„ç«¯å£è¿›è¡Œè®¿é—®Podã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-02_19-58-39.png" alt="Snipaste_2020-12-02_19-58-39"></p><p>é€šè¿‡æŸ¥çœ‹serviceï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-02_19-59-38.png" alt="Snipaste_2020-12-02_19-59-38"></p><p>å‘ç°ï¼ŒClusterIPçš„åªæœ‰ä¸€ä¸ªç«¯å£ï¼Œåªèƒ½å†…éƒ¨è®¿é—®ï¼Œè€ŒNodePortæœ‰ç«¯å£çš„æ˜ å°„ï¼Œæ‰€ä»¥ä»–èƒ½é€šè¿‡é›†ç¾¤èŠ‚ç‚¹çš„Ipå’Œç«¯å£è®¿é—®åˆ°Podé‡ŒæŒ‡å®šçš„ç«¯å£ã€‚</p><h3 id="LoadBalancer"><a href="#LoadBalancer" class="headerlink" title="LoadBalancer"></a>LoadBalancer</h3><p>ä¹Ÿæ˜¯ä¸€èˆ¬ç”¨äºå¤–ç½‘è®¿é—®Podï¼Œä¸€èˆ¬ä¸å…¬æœ‰äº‘ä¸€åŒä½¿ç”¨ï¼Œåšåˆ°è´Ÿè½½å‡è¡¡çš„æ•ˆæœã€‚</p><h1 id="é…ç½®ç®¡ç†"><a href="#é…ç½®ç®¡ç†" class="headerlink" title="é…ç½®ç®¡ç†"></a>é…ç½®ç®¡ç†</h1><h2 id="Sercet"><a href="#Sercet" class="headerlink" title="Sercet"></a>Sercet</h2><p>Sercetï¼šæœ‰å¯†ç çš„æ„æ€ï¼Œå®ƒæ˜¯å°†å¯†ç ç­‰æ•æ„Ÿæ•°æ®å­˜å‚¨åœ¨etcdä¸­ã€‚ä¸Šé¢è¯´è¿‡etcdæ˜¯k8sçš„å­˜å‚¨ä¸­å¿ƒã€‚</p><p><strong>å®ƒçš„ä½œç”¨å°±æ˜¯å°†åŠ å¯†çš„æ•°æ®å­˜å‚¨åœ¨etcdä¸­ï¼Œè®©Podå®¹å™¨ä»¥å˜é‡/Volumeçš„æ–¹å¼è¿›è¡Œè®¿é—®ã€‚</strong></p><h3 id="åˆ›å»ºSercet"><a href="#åˆ›å»ºSercet" class="headerlink" title="åˆ›å»ºSercet"></a>åˆ›å»ºSercet</h3><p><strong>å°† secret æ•°æ®è½¬æ¢ä¸º base-64 å½¢å¼</strong></p><p>å‡è®¾ç”¨æˆ·æƒ³è¦æœ‰ä¸¤æ¡ Secret æ•°æ®ï¼šç”¨æˆ·å <code>my-app</code> å’Œå¯†ç  <code>39528$vdg7Jb</code>ã€‚ é¦–å…ˆä½¿ç”¨ <a href="https://www.base64encode.org/">Base64 ç¼–ç </a> å°†ç”¨æˆ·åå’Œå¯†ç è½¬åŒ–ä¸º base-64 å½¢å¼ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨å¸¸ç”¨çš„ base64 ç¨‹åºçš„ç¤ºä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo -n &#x27;my-app&#x27; | base64</span><br><span class="line">echo -n &#x27;39528$vdg7Jb&#x27; | base64</span><br></pre></td></tr></table></figure><p>ç»“æœæ˜¾ç¤º base-64 å½¢å¼çš„ç”¨æˆ·åä¸º <code>bXktYXBw</code>ï¼Œ base-64 å½¢å¼çš„å¯†ç ä¸º <code>Mzk1MjgkdmRnN0pi</code>ã€‚</p><blockquote><p><strong>æ³¨æ„ï¼š</strong> ä½¿ç”¨ä½ çš„æ“ä½œç³»ç»Ÿæ‰€èƒ½ä¿¡ä»»çš„æœ¬åœ°å·¥å…·ä»¥é™ä½ä½¿ç”¨å¤–éƒ¨å·¥å…·çš„é£é™©ã€‚</p></blockquote><p><strong>åˆ›å»º Secret</strong></p><p>è¿™é‡Œæ˜¯ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå¯ä»¥ç”¨æ¥åˆ›å»ºå­˜æœ‰ç”¨æˆ·åå’Œå¯†ç çš„ Secret:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-secret</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">bXktYXBw</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">Mzk1MjgkdmRnN0pi</span></span><br></pre></td></tr></table></figure><ol><li><p>åˆ›å»º Secretï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f https://k8s.io/examples/pods/inject/secret.yaml</span></span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ Secret ç›¸å…³ä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get secret test-secret</span></span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME          TYPE      DATA      AGE</span><br><span class="line">test-secret   Opaque    2         1m</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ Secret ç›¸å…³çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe secret test-secret</span></span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Name:       test-secret</span><br><span class="line">Namespace:  default</span><br><span class="line">Labels:     &lt;none&gt;</span><br><span class="line">Annotations:    &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Type:   Opaque</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">password:   13 bytes</span><br><span class="line">username:   7  bytes</span><br></pre></td></tr></table></figure></li></ol><h3 id="æ³¨å…¥åˆ°å®¹å™¨"><a href="#æ³¨å…¥åˆ°å®¹å™¨" class="headerlink" title="æ³¨å…¥åˆ°å®¹å™¨"></a>æ³¨å…¥åˆ°å®¹å™¨</h3><h4 id="ç¯å¢ƒå˜é‡"><a href="#ç¯å¢ƒå˜é‡" class="headerlink" title="ç¯å¢ƒå˜é‡"></a>ç¯å¢ƒå˜é‡</h4><p>ä½¿ç”¨ <code>envFrom</code> æ¥å°† Secret ä¸­çš„æ‰€æœ‰æ•°æ®å®šä¹‰ä¸ºç¯å¢ƒå˜é‡ã€‚ Secret ä¸­çš„é”®åæˆä¸ºå®¹å™¨ä¸­çš„ç¯å¢ƒå˜é‡åï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">envfrom-secret</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">envars-test-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">envFrom:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">secretRef:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">test-secret</span></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201203195838491.png" alt="image-20201203195838491"></p><p>åˆ›å»º Podï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f https://k8s.io/examples/pods/inject/pod-secret-envFrom.yaml</span><br></pre></td></tr></table></figure><p>åœ¨ Shell ä¸­ï¼Œæ˜¾ç¤ºç¯å¢ƒå˜é‡ <code>username</code> å’Œ <code>password</code> çš„å†…å®¹ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201203200120573.png" alt="image-20201203200120573"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -i -t envfrom-secret -- /bin/sh -c <span class="string">&#x27;echo &quot;username: $username\npassword: $password\n&quot;&#x27;</span></span><br></pre></td></tr></table></figure><p>è¾“å‡ºä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username: my-app</span><br><span class="line">password: 39528$vdg7Jb</span><br></pre></td></tr></table></figure><h4 id="Volumeå½¢å¼"><a href="#Volumeå½¢å¼" class="headerlink" title="Volumeå½¢å¼"></a>Volumeå½¢å¼</h4><p>è¿™é‡Œæ˜¯ä¸€ä¸ªå¯ä»¥ç”¨æ¥åˆ›å»º pod çš„é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="comment"># name must match the volume name below</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secret-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/secret-volume</span></span><br><span class="line">  <span class="comment"># The secret data is exposed to Containers in the Pod through a Volume.</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secret-volume</span></span><br><span class="line">      <span class="attr">secret:</span></span><br><span class="line">        <span class="attr">secretName:</span> <span class="string">test-secret</span></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201203200422422.png" alt="image-20201203200422422"></p><ol><li><p>åˆ›å»º Podï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f secret-pod.yaml</span><br></pre></td></tr></table></figure></li><li><p>ç¡®è®¤ Pod æ­£åœ¨è¿è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod secret-test-pod</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME              READY     STATUS    RESTARTS   AGE</span><br><span class="line">secret-test-pod   1/1       Running   0          42m</span><br></pre></td></tr></table></figure></li><li><p>è·å–ä¸€ä¸ª shell è¿›å…¥ Pod ä¸­è¿è¡Œçš„å®¹å™¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it secret-test-pod -- /bin/bash</span><br></pre></td></tr></table></figure></li><li><p>Secret æ•°æ®é€šè¿‡æŒ‚è½½åœ¨ <code>/etc/secret-volume</code> ç›®å½•ä¸‹çš„å·æš´éœ²åœ¨å®¹å™¨ä¸­ã€‚</p><p>åœ¨ shell ä¸­ï¼Œåˆ—ä¸¾ <code>/etc/secret-volume</code> ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls /etc/secret-volume</span><br></pre></td></tr></table></figure><p>è¾“å‡ºåŒ…å«ä¸¤ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªå¯¹åº”ä¸€ä¸ª Secret æ•°æ®æ¡ç›®ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">password username</span><br></pre></td></tr></table></figure></li><li><p>åœ¨ Shell ä¸­ï¼Œæ˜¾ç¤º <code>username</code> å’Œ <code>password</code> æ–‡ä»¶çš„å†…å®¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> åœ¨å®¹å™¨ä¸­ Shell è¿è¡Œä¸‹é¢å‘½ä»¤</span></span><br><span class="line">echo &quot;$(cat /etc/secret-volume/username)&quot;</span><br><span class="line">echo &quot;$(cat /etc/secret-volume/password)&quot;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºä¸ºç”¨æˆ·åå’Œå¯†ç ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">my-app</span><br><span class="line"><span class="meta">39528$</span><span class="bash">vdg7Jb</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h2><p><strong>å’ŒSercetçš„ä½œç”¨å·®ä¸å¤šï¼Œå°†é…ç½®çš„æ•°æ®å­˜å‚¨åœ¨etcdä¸­ï¼Œè®©Podå®¹å™¨ä»¥å˜é‡/Volumeçš„æ–¹å¼è¿›è¡Œè®¿é—®ã€‚</strong></p><p>ConfigMap å…è®¸ä½ å°†é…ç½®æ–‡ä»¶ä¸é•œåƒæ–‡ä»¶åˆ†ç¦»ï¼Œä»¥ä½¿å®¹å™¨åŒ–çš„åº”ç”¨ç¨‹åºå…·æœ‰å¯ç§»æ¤æ€§ã€‚ æœ¬é¡µæä¾›äº†ä¸€ç³»åˆ—ä½¿ç”¨ç¤ºä¾‹ï¼Œè¿™äº›ç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•åˆ›å»º ConfigMap ä»¥åŠé…ç½® Pod ä½¿ç”¨å­˜å‚¨åœ¨ ConfigMap ä¸­çš„æ•°æ®ã€‚</p><h3 id="åˆ›å»ºConfigMap"><a href="#åˆ›å»ºConfigMap" class="headerlink" title="åˆ›å»ºConfigMap"></a>åˆ›å»ºConfigMap</h3><p>ä½ å¯ä»¥ä½¿ç”¨ <code>kubectl create configmap</code> æˆ–è€…åœ¨ <code>kustomization.yaml</code> ä¸­çš„ ConfigMap ç”Ÿæˆå™¨ æ¥åˆ›å»º ConfigMapã€‚æ³¨æ„ï¼Œ<code>kubectl</code> ä» 1.14 ç‰ˆæœ¬å¼€å§‹æ”¯æŒ <code>kustomization.yaml</code>ã€‚</p><h4 id="åŸºäºæ–‡ä»¶åˆ›å»º"><a href="#åŸºäºæ–‡ä»¶åˆ›å»º" class="headerlink" title="åŸºäºæ–‡ä»¶åˆ›å»º"></a>åŸºäºæ–‡ä»¶åˆ›å»º</h4><p>ä½ å¯ä»¥ä½¿ç”¨ <code>kubectl create configmap</code> åŸºäºå•ä¸ªæ–‡ä»¶æˆ–å¤šä¸ªæ–‡ä»¶åˆ›å»º ConfigMapã€‚</p><p>ä¾‹å¦‚ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap game-config-2 --from-file=configure-pod-container/configmap/game.properties</span><br></pre></td></tr></table></figure><p>å°†äº§ç”Ÿä»¥ä¸‹ ConfigMap:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe configmaps game-config-2</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç±»ä¼¼ä»¥ä¸‹å†…å®¹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Name:         game-config-2</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">game.properties:</span><br><span class="line">----</span><br><span class="line">enemies&#x3D;aliens</span><br><span class="line">lives&#x3D;3</span><br><span class="line">enemies.cheat&#x3D;true</span><br><span class="line">enemies.cheat.level&#x3D;noGoodRotten</span><br><span class="line">secret.code.passphrase&#x3D;UUDDLRLRBABAS</span><br><span class="line">secret.code.allowed&#x3D;true</span><br><span class="line">secret.code.lives&#x3D;30</span><br></pre></td></tr></table></figure><hr><p>åœ¨ä½¿ç”¨ <code>--from-file</code> å‚æ•°æ—¶ï¼Œä½ å¯ä»¥å®šä¹‰åœ¨ ConfigMap çš„ <code>data</code> éƒ¨åˆ†å‡ºç°é”®åï¼Œ è€Œä¸æ˜¯æŒ‰é»˜è®¤è¡Œä¸ºä½¿ç”¨æ–‡ä»¶åï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap game-config-3 --from-file=&lt;my-key-name&gt;=&lt;path-to-file&gt;</span><br></pre></td></tr></table></figure><p><code>&lt;my-key-name&gt;</code> æ˜¯ä½ è¦åœ¨ ConfigMap ä¸­ä½¿ç”¨çš„é”®åï¼Œ<code>&lt;path-to-file&gt;</code> æ˜¯ä½ æƒ³è¦é”®è¡¨ç¤ºæ•°æ®æºæ–‡ä»¶çš„ä½ç½®ã€‚</p><p>ä¾‹å¦‚:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap game-config-3 --from-file=game-special-key=configure-pod-container/configmap/game.properties</span><br></pre></td></tr></table></figure><p>å°†äº§ç”Ÿä»¥ä¸‹ ConfigMap:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get configmaps game-config-3 -o yaml</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç±»ä¼¼ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="number">2016-02-18T18:54:22Z</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">game-config-3</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;530&quot;</span></span><br><span class="line">  <span class="attr">selfLink:</span> <span class="string">/api/v1/namespaces/default/configmaps/game-config-3</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">05f8da22-d671-11e5-8cd0-68f728db1985</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">game-special-key:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">enemies=aliens</span></span><br><span class="line">    <span class="string">lives=3</span></span><br><span class="line">    <span class="string">enemies.cheat=true</span></span><br><span class="line">    <span class="string">enemies.cheat.level=noGoodRotten</span></span><br><span class="line">    <span class="string">secret.code.passphrase=UUDDLRLRBABAS</span></span><br><span class="line">    <span class="string">secret.code.allowed=true</span></span><br><span class="line">    <span class="string">secret.code.lives=30</span></span><br></pre></td></tr></table></figure><h4 id="åŸºäºç”Ÿæˆå™¨åˆ›å»º-ConfigMap"><a href="#åŸºäºç”Ÿæˆå™¨åˆ›å»º-ConfigMap" class="headerlink" title="åŸºäºç”Ÿæˆå™¨åˆ›å»º ConfigMap"></a>åŸºäºç”Ÿæˆå™¨åˆ›å»º ConfigMap</h4><p>è‡ª 1.14 å¼€å§‹ï¼Œ<code>kubectl</code> å¼€å§‹æ”¯æŒ <code>kustomization.yaml</code>ã€‚ ä½ è¿˜å¯ä»¥åŸºäºç”Ÿæˆå™¨åˆ›å»º ConfigMapï¼Œç„¶åå°†å…¶åº”ç”¨äº API æœåŠ¡å™¨ä¸Šåˆ›å»ºå¯¹è±¡ã€‚ ç”Ÿæˆå™¨åº”åœ¨ç›®å½•å†…çš„ <code>kustomization.yaml</code> ä¸­æŒ‡å®š</p><p>ä¾‹å¦‚ï¼Œè¦ä» <code>configure-pod-container/configmap/kubectl/game.properties</code> æ–‡ä»¶ç”Ÿæˆä¸€ä¸ª ConfigMapï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> åˆ›å»ºåŒ…å« ConfigMapGenerator çš„ kustomization.yaml æ–‡ä»¶</span></span><br><span class="line">cat &lt;&lt;EOF &gt;./kustomization.yaml</span><br><span class="line">configMapGenerator:</span><br><span class="line">- name: game-config-4</span><br><span class="line">  files:</span><br><span class="line">  - configure-pod-container/configmap/kubectl/game.properties</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ kustomization ç›®å½•åˆ›å»º ConfigMap å¯¹è±¡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -k .</span><br><span class="line">configmap/game-config-4-m9dm2f92bt created</span><br></pre></td></tr></table></figure><p>ä½ å¯ä»¥æ£€æŸ¥ ConfigMap æ˜¯è¿™æ ·åˆ›å»ºçš„:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">kubectl get configmap</span><br><span class="line">NAME                       DATA   AGE</span><br><span class="line">game-config-4-m9dm2f92bt   1      37s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl describe configmaps/game-config-4-m9dm2f92bt</span><br><span class="line">Name:         game-config-4-m9dm2f92bt</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubectl.kubernetes.io/last-applied-configuration:</span><br><span class="line">                &#123;&quot;apiVersion&quot;:&quot;v1&quot;,&quot;data&quot;:&#123;&quot;game.properties&quot;:&quot;enemies=aliens\nlives=3\nenemies.cheat=true\nenemies.cheat.level=noGoodRotten\nsecret.code.p...</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">game.properties:</span><br><span class="line">----</span><br><span class="line">enemies=aliens</span><br><span class="line">lives=3</span><br><span class="line">enemies.cheat=true</span><br><span class="line">enemies.cheat.level=noGoodRotten</span><br><span class="line">secret.code.passphrase=UUDDLRLRBABAS</span><br><span class="line">secret.code.allowed=true</span><br><span class="line">secret.code.lives=30</span><br><span class="line">Events:  &lt;none&gt;</span><br></pre></td></tr></table></figure><p>è¯·æ³¨æ„ï¼Œç”Ÿæˆçš„ ConfigMap åç§°å…·æœ‰é€šè¿‡å¯¹å†…å®¹è¿›è¡Œæ•£åˆ—è€Œé™„åŠ çš„åç¼€ï¼Œ è¿™æ ·å¯ä»¥ç¡®ä¿æ¯æ¬¡ä¿®æ”¹å†…å®¹æ—¶éƒ½ä¼šç”Ÿæˆæ–°çš„ ConfigMapã€‚</p><hr><p>åœ¨ ConfigMap ç”Ÿæˆå™¨ï¼Œä½ å¯ä»¥å®šä¹‰ä¸€ä¸ªéæ–‡ä»¶åçš„é”®åã€‚ ä¾‹å¦‚ï¼Œä» <code>configure-pod-container/configmap/game.properties</code> æ–‡ä»¶ç”Ÿæˆ ConfigMapï¼Œ ä½†ä½¿ç”¨ <code>game-special-key</code> ä½œä¸ºé”®åï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> åˆ›å»ºåŒ…å« ConfigMapGenerator çš„ kustomization.yaml æ–‡ä»¶</span></span><br><span class="line">cat &lt;&lt;EOF &gt;./kustomization.yaml</span><br><span class="line">configMapGenerator:</span><br><span class="line">- name: game-config-5</span><br><span class="line">  files:</span><br><span class="line">  - game-special-key=configure-pod-container/configmap/kubectl/game.properties</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ Kustomization ç›®å½•åˆ›å»º ConfigMap å¯¹è±¡ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -k .</span><br><span class="line">configmap/game-config-5-m67dt67794 created</span><br></pre></td></tr></table></figure><hr><blockquote><p>å¦‚åŸºäºæ–‡ä»¶åˆ›å»º <a href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-pod-configmap/#create-configmaps-from-files">ConfigMap</a> ä¸­æ‰€è¿°ï¼Œå½“ä½ ä½¿ç”¨ <code>--from-file</code> åˆ›å»º ConfigMap æ—¶ï¼Œï¼ˆé»˜è®¤ï¼‰æ–‡ä»¶åæˆä¸ºå­˜å‚¨åœ¨ ConfigMap çš„ <code>data</code> éƒ¨åˆ†ä¸­çš„é”®ï¼Œ æ–‡ä»¶å†…å®¹æˆä¸ºé”®å¯¹åº”çš„å€¼ã€‚</p><p>æ‰€ä»¥è¿™ç§åˆ›å»ºæ–¹å¼ï¼Œåªæœ‰ä¸€ä¸ªk-vã€‚ä½¿ç”¨ä¸‹è¿°yamlåˆ›å»ºçš„è¯ä¸€ä¸ªConfigMaoå¤šä¸ªKV</p></blockquote><h3 id="æ³¨å…¥åˆ°å®¹å™¨-1"><a href="#æ³¨å…¥åˆ°å®¹å™¨-1" class="headerlink" title="æ³¨å…¥åˆ°å®¹å™¨"></a>æ³¨å…¥åˆ°å®¹å™¨</h3><h4 id="ç¯å¢ƒå˜é‡-1"><a href="#ç¯å¢ƒå˜é‡-1" class="headerlink" title="ç¯å¢ƒå˜é‡"></a>ç¯å¢ƒå˜é‡</h4><ul><li><p>åˆ›å»ºä¸€ä¸ªåŒ…å«å¤šä¸ªé”®å€¼å¯¹çš„ ConfigMapã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">special-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">SPECIAL_LEVEL:</span> <span class="string">very</span></span><br><span class="line">  <span class="attr">SPECIAL_TYPE:</span> <span class="string">charm</span></span><br></pre></td></tr></table></figure><p>åˆ›å»º ConfigMap:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f https://kubernetes.io/examples/configmap/configmap-multikeys.yaml</span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨ <code>envFrom</code> å°†æ‰€æœ‰ ConfigMap çš„æ•°æ®å®šä¹‰ä¸ºå®¹å™¨ç¯å¢ƒå˜é‡ï¼ŒConfigMap ä¸­çš„é”®æˆä¸º Pod ä¸­çš„ç¯å¢ƒå˜é‡åç§°ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dapi-test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">k8s.gcr.io/busybox</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;env&quot;</span> ]</span><br><span class="line">      <span class="attr">envFrom:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">special-config</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure><p>åˆ›å»º Pod:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f https://kubernetes.io/examples/pods/pod-configmap-envFrom.yaml</span><br></pre></td></tr></table></figure><p>ç°åœ¨ï¼ŒPod çš„è¾“å‡ºåŒ…å«ç¯å¢ƒå˜é‡ <code>SPECIAL_LEVEL=very</code> å’Œ <code>SPECIAL_TYPE=charm</code>ã€‚</p></li></ul><h4 id="æ•°æ®å·"><a href="#æ•°æ®å·" class="headerlink" title="æ•°æ®å·"></a>æ•°æ®å·</h4><p>å¦‚åŸºäºæ–‡ä»¶åˆ›å»º ConfigMap ä¸­æ‰€è¿°ï¼Œå½“ä½ ä½¿ç”¨ â€“from-file åˆ›å»º ConfigMap æ—¶ï¼Œæ–‡ä»¶åæˆä¸ºå­˜å‚¨åœ¨ ConfigMap çš„ data éƒ¨åˆ†ä¸­çš„é”®ï¼Œ æ–‡ä»¶å†…å®¹æˆä¸ºé”®å¯¹åº”çš„å€¼ã€‚</p><p>æœ¬èŠ‚ä¸­çš„ç¤ºä¾‹å¼•ç”¨äº†ä¸€ä¸ªåä¸º special-config çš„ ConfigMapï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">special-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">SPECIAL_LEVEL:</span> <span class="string">very</span></span><br><span class="line">  <span class="attr">SPECIAL_TYPE:</span> <span class="string">charm</span></span><br></pre></td></tr></table></figure><p>åˆ›å»º ConfigMap:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f https://kubernetes.io/examples/configmap/configmap-multikeys.yaml</span><br></pre></td></tr></table></figure><p>åœ¨ Pod è§„çº¦çš„ <code>volumes</code> éƒ¨åˆ†ä¸‹æ·»åŠ  ConfigMap åç§°ã€‚ è¿™ä¼šå°† ConfigMap æ•°æ®æ·»åŠ åˆ°æŒ‡å®šä¸º <code>volumeMounts.mountPath</code> çš„ç›®å½•ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸º <code>/etc/config</code>ï¼‰ã€‚ <code>command</code> éƒ¨åˆ†å¼•ç”¨å­˜å‚¨åœ¨ ConfigMap ä¸­çš„ <code>special.level</code>ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dapi-test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">k8s.gcr.io/busybox</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;ls /etc/config/&quot;</span> ]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">        <span class="attr">mountPath:</span> <span class="string">/etc/config</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">      <span class="attr">configMap:</span></span><br><span class="line">        <span class="comment"># Provide the name of the ConfigMap containing the files you want</span></span><br><span class="line">        <span class="comment"># to add to the container</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">special-config</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure><p><img src="E:%5CProjects%5Csync%5Cmd%5Ck8s%5Cimage-20201204100337839.png" alt="image-20201204100337839"></p><p>åˆ›å»º Pod:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f https://kubernetes.io/examples/pods/pod-configmap-volume.yaml</span><br></pre></td></tr></table></figure><p>Pod è¿è¡Œæ—¶ï¼Œå‘½ä»¤ <code>ls /etc/config/</code> äº§ç”Ÿä¸‹é¢çš„è¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SPECIAL_LEVEL</span><br><span class="line">SPECIAL_TYPE</span><br></pre></td></tr></table></figure><blockquote><p><strong>æ³¨æ„ï¼š</strong> å¦‚æœåœ¨ <code>/etc/config/</code> ç›®å½•ä¸­æœ‰ä¸€äº›æ–‡ä»¶ï¼Œå®ƒä»¬å°†è¢«åˆ é™¤ã€‚</p></blockquote><blockquote><p><strong>è¯´æ˜ï¼š</strong> æ–‡æœ¬æ•°æ®ä¼šä½¿ç”¨ UTF-8 å­—ç¬¦ç¼–ç çš„å½¢å¼å±•ç°ä¸ºæ–‡ä»¶ã€‚å¦‚æœä½¿ç”¨å…¶ä»–å­—ç¬¦ç¼–ç ï¼Œ å¯ä»¥ä½¿ç”¨ <code>binaryData</code>ã€‚</p></blockquote><h1 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h1><h2 id="Ingressçš„åŠŸèƒ½"><a href="#Ingressçš„åŠŸèƒ½" class="headerlink" title="Ingressçš„åŠŸèƒ½"></a>Ingressçš„åŠŸèƒ½</h2><p>ä¹‹å‰åˆ›å»ºçš„Nginx Deploymentèµ„æºä¸ºäº†èƒ½è®©å¤–éƒ¨è®¿é—®ï¼Œé‡‡ç”¨<code>kubectl expose</code>æ“ä½œåˆ›å»ºäº†ä¸€ä¸ªtype=NodePortçš„Serviceï¼Œç„¶åå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¥è®¿é—®åˆ°å†…éƒ¨çš„Nginxèµ„æºï¼š</p><ul><li>Service IP:PORT</li><li>é›†ç¾¤å†…ä»»ä¸€èŠ‚ç‚¹IP:Port</li></ul><p>é‚£è¿™æ ·æœ‰ç‚¹ä¸æ–¹ä¾¿ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è®¿é—®ä¸€ä¸ªåº”ç”¨è¦å…ˆæŸ¥çœ‹ä»–å¼€æ”¾çš„ç«¯å£ï¼Œé€šè¿‡IPç«¯å£å½¢å¼è®¿é—®ï¼Œä½†åœ¨å®é™…çš„ä½¿ç”¨å½“ä¸­æ˜¯å¸Œæœ›é€šè¿‡ä¸åŒåŸŸåè®¿é—®åˆ°ä¸åŒçš„æœåŠ¡ï¼ŒåŸŸååº”è¯¥æŒ‡å‘çš„IPæ˜¯åŒä¸€ä¸ªã€‚Ingresså°±å®ç°äº†è¿™ä¸ª</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201204142357121.png" alt="image-20201204142357121"></p><blockquote><p>å¤§å®¶å¯èƒ½æƒ³Ingresså®ç°çš„å†…å®¹ä¸å°±å’ŒNginxä¸€è‡´å—ã€‚å…¶å®å®˜æ–¹æä¾›çš„IngressåŸç†å°±æ˜¯Nginxï¼Œåšäº†æ­¥å°è£…ã€‚</p></blockquote><p>é€šè¿‡ä¸Šå›¾å¾—çŸ¥ï¼ŒIngresså¯¹è®¿é—®çš„åŸŸåè¿›è¡Œäº†è§„åˆ™çš„è½¬å‘ï¼Œè½¬å‘è‡³å¯¹è±¡çš„ServiceIPå’Œç«¯å£ï¼Œè€ŒServcieæ˜¯ä¸€ç»„Podçš„è®¿é—®è§„åˆ™ï¼Œè¿™æ ·å°±å¯ä»¥æ ¹æ®ä¸åŒçš„åŸŸåè®¿é—®åˆ°ä¸åŒçš„æœåŠ¡äº†ã€‚</p><h2 id="Ingressçš„ä½¿ç”¨"><a href="#Ingressçš„ä½¿ç”¨" class="headerlink" title="Ingressçš„ä½¿ç”¨"></a>Ingressçš„ä½¿ç”¨</h2><p>Ingressä¸æ˜¯k8sé›†ç¾¤è‡ªå¸¦çš„åŠŸèƒ½ï¼Œéœ€è¦é€‰æ‹©Ingressçš„æ§åˆ¶å™¨å®‰è£…ï¼Œæˆ‘ä»¬é€‰æ‹©å®˜æ–¹ç»´æŠ¤nginxæ§åˆ¶å™¨ï¼Œå®ç°éƒ¨ç½²</p><blockquote><p>æ­¥éª¤ï¼š</p><ol><li>éƒ¨ç½²ingress Controller</li><li>åˆ›å»ºingressè§„åˆ™</li></ol></blockquote><p><strong>1. åˆ›å»ºåº•å±‚è¢«è®¿é—®åº”ç”¨ï¼Œå¹¶æš´éœ²</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl create deployment web --image=nginx</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl expose deployment web --port=80 --target-port=80 --<span class="built_in">type</span>=NodePort</span></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201204143724336.png" alt="image-20201204143724336"></p><blockquote><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬é€šè¿‡Serivceçš„10.106.99.78:80è½¬å‘åˆ°é›†ç¾¤ä»»ä¸€å‡ ç‚¹çš„ip:32402å°±èƒ½è®¿é—®åˆ°deploymentèµ„æº</p></blockquote><p><strong>2. éƒ¨ç½²Ingress Controller</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-configuration</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tcp-services</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">udp-services</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-serviceaccount</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-clusterrole</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">events</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;extensions&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;networking.k8s.io&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;extensions&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;networking.k8s.io&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingresses/status</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-role</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">    <span class="attr">resourceNames:</span></span><br><span class="line">      <span class="comment"># Defaults to &quot;&lt;election-id&gt;-&lt;ingress-class&gt;&quot;</span></span><br><span class="line">      <span class="comment"># Here: &quot;&lt;ingress-controller-leader&gt;-&lt;nginx&gt;&quot;</span></span><br><span class="line">      <span class="comment"># This has to be adapted if you change either parameter</span></span><br><span class="line">      <span class="comment"># when launching the nginx-ingress-controller.</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;ingress-controller-leader-nginx&quot;</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-role-nisa-binding</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-role</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx-ingress-serviceaccount</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-clusterrole-nisa-binding</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-clusterrole</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx-ingress-serviceaccount</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-controller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">prometheus.io/port:</span> <span class="string">&quot;10254&quot;</span></span><br><span class="line">        <span class="attr">prometheus.io/scrape:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment"># wait up to five minutes for the drain of connections</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">300</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nginx-ingress-serviceaccount</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-ingress-controller</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">lizhenliang/nginx-ingress-controller:0.30.0</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/nginx-ingress-controller</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--configmap=$(POD_NAMESPACE)/nginx-configuration</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--tcp-services-configmap=$(POD_NAMESPACE)/tcp-services</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--udp-services-configmap=$(POD_NAMESPACE)/udp-services</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--publish-service=$(POD_NAMESPACE)/ingress-nginx</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--annotations-prefix=nginx.ingress.kubernetes.io</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">capabilities:</span></span><br><span class="line">              <span class="attr">drop:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">              <span class="attr">add:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">NET_BIND_SERVICE</span></span><br><span class="line">            <span class="comment"># www-data -&gt; 101</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">101</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">443</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">10254</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">10254</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">lifecycle:</span></span><br><span class="line">            <span class="attr">preStop:</span></span><br><span class="line">              <span class="attr">exec:</span></span><br><span class="line">                <span class="attr">command:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="string">/wait-shutdown</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">min:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">90Mi</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Container</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201204145037259.png" alt="image-20201204145037259"></p><p><strong>3. åˆ›å»ºingressè§„åˆ™</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># http</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">example.ingredemo.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">web</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># https</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tls-example-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sslexample.ctnrs.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">secret-tls</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">sslexample.ctnrs.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">          <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">web</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201204145348232.png" alt="image-20201204145348232"></p><p><strong>4. æ·»åŠ æœ¬åœ°åŸŸåè§£æ</strong></p><p>å› ä¸ºIngress-Controllerè¿è¡Œåœ¨masterä¸­ï¼Œæ‰€ä»¥å°†è¦ä½¿ç”¨çš„åŸŸåè§£æåˆ°masterçš„IPã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201204145635739.png" alt="image-20201204145635739"></p><p><strong>5. è®¿é—®</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201204145720268.png" alt="image-20201204145720268"></p><h1 id="æ ¸å¿ƒæŠ€æœ¯Helm"><a href="#æ ¸å¿ƒæŠ€æœ¯Helm" class="headerlink" title="æ ¸å¿ƒæŠ€æœ¯Helm"></a>æ ¸å¿ƒæŠ€æœ¯Helm</h1><h2 id="Helmçš„å¼•å…¥"><a href="#Helmçš„å¼•å…¥" class="headerlink" title="Helmçš„å¼•å…¥"></a>Helmçš„å¼•å…¥</h2><p>ä¹‹å‰æˆ‘ä»¬åˆ›å»ºæœåŠ¡æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨ç¼–å†™å•ä¸ªæœåŠ¡çš„Deploymentã€Serviceã€Ingressçš„é…ç½®æ–‡ä»¶ï¼Œ<strong>å¹¶å¤šæ¬¡é€šè¿‡<code>kubectl apply</code>å¯åŠ¨ã€‚</strong>è¿™æ ·å•ä¸ªæœåŠ¡æ²¡é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœéƒ¨ç½²å¾®æœåŠ¡æ—¶ï¼Œä¸€ä¸ªé¡¹ç›®æœ‰å¾ˆå¤šæœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡éƒ½éœ€è¦æ‰‹åŠ¨å¯åŠ¨å¤šä¸ªèµ„æºæ‰å¯ä»¥å¼€å¯ï¼Œè¿™æ ·å¾ˆéº»çƒ¦ï¼Œæ‰€ä»¥Helmè¯ç”Ÿäº†ã€‚</p><p>K8S ä¸Šçš„åº”ç”¨å¯¹è±¡ï¼Œéƒ½æ˜¯ç”±ç‰¹å®šçš„èµ„æºæè¿°ç»„æˆï¼ŒåŒ…æ‹¬ deploymentã€service ç­‰ã€‚éƒ½ä¿å­˜å„è‡ªæ–‡ä»¶ä¸­æˆ–è€…é›†ä¸­å†™åˆ°ä¸€ä¸ªé…ç½®æ–‡ä»¶ã€‚ç„¶å kubectl apply â€“f éƒ¨ç½²ã€‚å¦‚æœåº”ç”¨åªç”±ä¸€ä¸ªæˆ–å‡ ä¸ªè¿™æ ·çš„æœåŠ¡ç»„æˆï¼Œä¸Šé¢éƒ¨ç½²æ–¹å¼è¶³å¤Ÿäº†ã€‚è€Œå¯¹äºä¸€ä¸ªå¤æ‚çš„åº”ç”¨ï¼Œä¼šæœ‰å¾ˆå¤šç±»ä¼¼ä¸Šé¢çš„èµ„æºæè¿°æ–‡ä»¶ï¼Œä¾‹å¦‚å¾®æœåŠ¡æ¶æ„åº”ç”¨ï¼Œç»„æˆåº”ç”¨çš„æœåŠ¡å¯èƒ½å¤šè¾¾åä¸ªï¼Œå‡ åä¸ªã€‚å¦‚æœæœ‰æ›´æ–°æˆ–å›æ»šåº”ç”¨çš„éœ€æ±‚ï¼Œå¯èƒ½è¦ä¿®æ”¹å’Œç»´æŠ¤æ‰€æ¶‰åŠçš„å¤§é‡èµ„æºæ–‡ä»¶ï¼Œè€Œè¿™ç§ç»„ç»‡å’Œç®¡ç†åº”ç”¨çš„æ–¹å¼å°±æ˜¾å¾—åŠ›ä¸ä»å¿ƒäº†ã€‚ä¸”ç”±äºç¼ºå°‘å¯¹å‘å¸ƒè¿‡çš„åº”ç”¨ç‰ˆæœ¬ç®¡ç†å’Œæ§åˆ¶ï¼Œä½¿Kubernetes ä¸Šçš„åº”ç”¨ç»´æŠ¤å’Œæ›´æ–°ç­‰é¢ä¸´è¯¸å¤šçš„æŒ‘æˆ˜ï¼Œä¸»è¦é¢ä¸´ä»¥ä¸‹é—®é¢˜ï¼š</p><ol><li>å¦‚ä½•å°†è¿™äº›æœåŠ¡ä½œä¸ºä¸€ä¸ªæ•´ä½“ç®¡ç† </li><li>è¿™äº›èµ„æºæ–‡ä»¶å¦‚ä½•é«˜æ•ˆå¤ç”¨</li><li>ä¸æ”¯æŒåº”ç”¨çº§åˆ«çš„ç‰ˆæœ¬ç®¡ç†</li></ol><h2 id="Helmä»‹ç»"><a href="#Helmä»‹ç»" class="headerlink" title="Helmä»‹ç»"></a>Helmä»‹ç»</h2><p>Helm æ˜¯ä¸€ä¸ª Kubernetes çš„åŒ…ç®¡ç†å·¥å…·ï¼Œå°±åƒ Linux ä¸‹çš„åŒ…ç®¡ç†å™¨ï¼Œå¦‚ yum/apt ç­‰ï¼Œå¯ä»¥ å¾ˆæ–¹ä¾¿çš„å°†ä¹‹å‰æ‰“åŒ…å¥½çš„ yaml æ–‡ä»¶éƒ¨ç½²åˆ° kubernetes ä¸Šã€‚ </p><p><strong>Helm æœ‰ 3 ä¸ªé‡è¦æ¦‚å¿µï¼š</strong> </p><ol><li>helmï¼šä¸€ä¸ªå‘½ä»¤è¡Œå®¢æˆ·ç«¯å·¥å…·ï¼Œä¸»è¦ç”¨äº Kubernetes åº”ç”¨ chart çš„åˆ›å»ºã€æ‰“åŒ…ã€å‘ å¸ƒå’Œç®¡ç†ã€‚ </li><li>Chartï¼šåº”ç”¨æè¿°ï¼Œä¸€ç³»åˆ—ç”¨äºæè¿° k8s èµ„æºç›¸å…³æ–‡ä»¶(yamlé…ç½®æ–‡ä»¶)çš„é›†åˆã€‚</li><li>Releaseï¼šåŸºäº Chart çš„éƒ¨ç½²å®ä½“ï¼Œä¸€ä¸ª chart è¢« Helm è¿è¡Œåå°†ä¼šç”Ÿæˆå¯¹åº”çš„ä¸€ä¸ª releaseï¼›å°†åœ¨ k8s ä¸­åˆ›å»ºå‡ºçœŸå®è¿è¡Œçš„èµ„æºå¯¹è±¡ã€‚å³æ¯è¿è¡Œä¸€æ¬¡æœåŠ¡ï¼Œå°±ä¼šæœ‰ä¸€ä¸ªRelease</li></ol><p><strong>Helmå¯ä»¥è§£å†³çš„é—®é¢˜</strong></p><ol><li>å¯ä»¥æŠŠä¸€ä¸ªæœåŠ¡çš„æ‰€ä»¥é…ç½®æ–‡ä»¶yamlç»Ÿä¸€ç®¡ç†ï¼Œé€šè¿‡Chartã€‚</li><li>å®ç°yamlé«˜æ ¡å¤ç”¨ï¼Œé€šè¿‡ä¼ é€’å‚æ•°åŠ¨æ€æ¸²æŸ“æ¨¡æ¿åšåˆ°ã€‚</li><li>ä½¿ç”¨helmåº”ç”¨ç•Œåˆ«çš„ç‰ˆæœ¬ç®¡ç†ã€‚</li></ol><blockquote><p> æ€»ç»“æ¥è¯´é€šè¿‡Helmæ¥ç®¡ç†æœåŠ¡ï¼Œè™½ç„¶é…ç½®æ–‡ä»¶ä¹Ÿæ˜¯ä¸€ä¸ªä¹Ÿæ²¡æœ‰å‡å°‘ï¼Œä½†æ˜¯é€šè¿‡å®ƒæ¥ç®¡ç†æœåŠ¡ï¼Œå‡çº§ï¼Œå¯åŠ¨ä¼šæå¤§çš„æ–¹ä¾¿</p></blockquote><h2 id="Helm-v3-å˜åŒ–"><a href="#Helm-v3-å˜åŒ–" class="headerlink" title="Helm v3 å˜åŒ–"></a>Helm v3 å˜åŒ–</h2><p>2019 å¹´ 11 æœˆ 13 æ—¥ï¼Œ Helm å›¢é˜Ÿå‘å¸ƒ Helm v3 çš„ç¬¬ä¸€ä¸ªç¨³å®šç‰ˆæœ¬ã€‚ è¯¥ç‰ˆæœ¬ä¸»è¦å˜åŒ–å¦‚ä¸‹ï¼š </p><ol><li>æœ€æ˜æ˜¾çš„å˜åŒ–æ˜¯ Tiller çš„åˆ é™¤<img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-05_13-15-22.png" alt="Snipaste_2020-12-05_13-15-22"></li><li>Release åç§°å¯ä»¥åœ¨ä¸åŒå‘½åç©ºé—´é‡ç”¨</li><li>æ”¯æŒå°† Chart æ¨é€è‡³ Docker é•œåƒä»“åº“ä¸­</li><li>ä½¿ç”¨ JSONSchema éªŒè¯ chart values</li></ol><h2 id="Helmå®¢æˆ·ç«¯"><a href="#Helmå®¢æˆ·ç«¯" class="headerlink" title="Helmå®¢æˆ·ç«¯"></a>Helmå®¢æˆ·ç«¯</h2><h3 id="å®‰è£…å’Œé…ç½®æº"><a href="#å®‰è£…å’Œé…ç½®æº" class="headerlink" title="å®‰è£…å’Œé…ç½®æº"></a>å®‰è£…å’Œé…ç½®æº</h3><p>å› ä¸ºå®ƒç±»ä¼¼äºaptã€yumï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦é…ç½®æºï¼Œç„¶åå°±å¯ä»¥ä»ç½‘ä¸Šä¸‹è½½é…ç½®å¥½çš„å„ä¸ªAPPçš„Chartçš„é…ç½®æ–‡ä»¶ï¼Œç›´æ¥é…ç½®ç½‘ä¸Šçš„åº”ç”¨ã€‚ä½†æ˜¯å¤šæ•°æ¥è¯´è¿˜æ˜¯ä¼šè‡ªå®šä¹‰Charté…ç½®ï¼Œæ¥éƒ¨ç½²è‡ªå·±çš„åº”ç”¨ï¼Œä¸æ˜¯å…¬å…±çš„åº”ç”¨ã€‚</p><p><strong>å®‰è£…</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://get.helm.sh/helm-v3.4.1-linux-amd64.tar.gz</span><br><span class="line">$ tar -zxvf helm-v3.4.1-linux-amd64.tar.gz</span><br><span class="line">$ cp linux-amd64/helm /usr/bin/</span><br><span class="line"><span class="comment"># éªŒè¯</span></span><br><span class="line">$ helm</span><br></pre></td></tr></table></figure><p><strong>é…ç½®å›½å†… chart ä»“åº“</strong></p><ul><li>å¾®è½¯ä»“åº“ï¼ˆ<a href="http://mirror.azure.cn/kubernetes/charts/%EF%BC%89%E8%BF%99%E4%B8%AA%E4%BB%93%E5%BA%93%E6%8E%A8%E8%8D%90%EF%BC%8C%E5%9F%BA%E6%9C%AC">http://mirror.azure.cn/kubernetes/charts/ï¼‰è¿™ä¸ªä»“åº“æ¨èï¼ŒåŸºæœ¬</a> ä¸Šå®˜ç½‘æœ‰çš„ chart è¿™é‡Œéƒ½æœ‰ã€‚ </li><li> é˜¿é‡Œäº‘ä»“åº“ï¼ˆ<a href="https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts">https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</a> ï¼‰</li><li>å®˜æ–¹ä»“åº“ï¼ˆ<a href="https://hub.kubeapps.com/charts/incubator%EF%BC%89%E5%AE%98%E6%96%B9">https://hub.kubeapps.com/charts/incubatorï¼‰å®˜æ–¹</a> chart ä»“åº“ï¼Œå›½ å†…æœ‰ç‚¹ä¸å¥½ä½¿ã€‚</li></ul><p>æ·»åŠ å­˜å‚¨åº“ï¼š<code>helm repo add éšä¾¿èµ·Name url</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm repo add stable http://mirror.azure.cn/kubernetes/charts </span><br><span class="line">helm repo add aliyun https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts </span><br><span class="line">helm repo update</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹é…ç½®çš„å­˜å‚¨åº“</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo list</span><br></pre></td></tr></table></figure><p>åˆ é™¤å­˜å‚¨åº“</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo remove aliyun</span><br></pre></td></tr></table></figure><h2 id="éƒ¨ç½²åº”ç”¨"><a href="#éƒ¨ç½²åº”ç”¨" class="headerlink" title="éƒ¨ç½²åº”ç”¨"></a>éƒ¨ç½²åº”ç”¨</h2><h3 id="Chartåˆ›å»º"><a href="#Chartåˆ›å»º" class="headerlink" title="Chartåˆ›å»º"></a>Chartåˆ›å»º</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm create mychart</span><br><span class="line">ls mycharts/</span><br></pre></td></tr></table></figure><ul><li>Chart.yamlæ˜¯å½“å‰Chartå±æ€§é…ç½®ä¿¡æ¯</li><li>templatesæ˜¯å­˜æ”¾æœåŠ¡é…ç½®æ–‡ä»¶çš„æ–‡ä»¶å¤¹</li><li>values.yamlæ˜¯å®šä¹‰å…¨å±€å˜é‡çš„æ–‡ä»¶</li></ul><h3 id="yamlé«˜æ•ˆå¤ç”¨"><a href="#yamlé«˜æ•ˆå¤ç”¨" class="headerlink" title="yamlé«˜æ•ˆå¤ç”¨"></a>yamlé«˜æ•ˆå¤ç”¨</h3><p>åˆ›å»ºæœåŠ¡yamlé€šè¿‡value.yamlé‡Œçš„å‚æ•°åŠ¨æ€ç»‘å®šæ¨¡æ¿ï¼Œè¿™æ ·è¾ƒå°‘Yamlç¼–å†™æ—¶é—´ã€‚å› ä¸ºæœåŠ¡èµ„æºyamlæ¨¡æ¿å¤§ä½“ä¿¡æ¯ä¸€è‡´ï¼Œåªéœ€è¦æ”¹éƒ¨é—¨å‚æ•°å†…å®¹å³å¯ã€‚</p><p>ä¸‹é¢å¼€å§‹å®šä¹‰å…¨å±€å˜é‡ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> mychart</span><br><span class="line">vim values.yaml</span><br><span class="line">replicas: 1</span><br><span class="line">image: nginx</span><br><span class="line">tag: 1.16</span><br><span class="line">label: nginx</span><br><span class="line">port: 80</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨templatesæ–‡ä»¶å¤¹ä¸­çš„å¯¹åº”çš„é…ç½®æ–‡ä»¶ä¸­é€šè¿‡å˜é‡å¼•å…¥ï¼š<code>&#123;&#123; .Values.xxx&#125;&#125;</code>ã€‚æ³¨æ„ ç‚¹ä¸å¤§æ‹¬å·ä¹‹é—´çš„ç©ºæ ¼ã€‚ç„¶åæˆ‘ä»¬ä¸€èˆ¬åœ¨nameçš„å€¼é‡‡ç”¨<code>&#123;&#123; .Release.Name&#125;&#125;</code>æ·»åŠ åç§°ï¼Œä»–çš„å€¼å°±æ˜¯<code>helm install xxx chartçš„ä½ç½®</code>ä¸­çš„xxxï¼Œé¿å…å¤šæ¬¡åˆ›å»ºnameç›¸åŒã€‚</p><p>ä¿®æ”¹éƒ¨åˆ†é…ç½®æ–‡ä»¶ï¼Œå‚è€ƒä¸‹é¢ï¼Œè¯·ç»“åˆè‡ªå·±å®é™…ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-05_14-25-07.png" alt="Snipaste_2020-12-05_14-25-07"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-05_14-24-57.png" alt="Snipaste_2020-12-05_14-24-57"></p><h3 id="å¯åŠ¨"><a href="#å¯åŠ¨" class="headerlink" title="å¯åŠ¨"></a>å¯åŠ¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install myweb ./mychart</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-05_14-28-42.png" alt="Snipaste_2020-12-05_14-28-42"></p><h3 id="å‡çº§"><a href="#å‡çº§" class="headerlink" title="å‡çº§"></a>å‡çº§</h3><p><code>helm upgrade myweb ./mychart/</code></p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://jkzhao.github.io/2019/08/26/Kubernetes%E5%AD%98%E5%82%A8%E5%8D%B7/">https://jkzhao.github.io/2019/08/26/Kubernetes%E5%AD%98%E5%82%A8%E5%8D%B7/</a></p><p><a href="https://www.qikqiak.com/post/understand-kubernetes-affinity/">https://www.qikqiak.com/post/understand-kubernetes-affinity/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;æ ¸å¿ƒæŠ€æœ¯Pod&quot;&gt;&lt;a href=&quot;#æ ¸å¿ƒæŠ€æœ¯Pod&quot; class=&quot;headerlink&quot; title=&quot;æ ¸å¿ƒæŠ€æœ¯Pod&quot;&gt;&lt;/a&gt;æ ¸å¿ƒæŠ€æœ¯Pod&lt;/h1&gt;&lt;h2 id=&quot;æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;æ¦‚</summary>
      
    
    
    
    <category term="Kubernetes" scheme="https://awslzhang.top/categories/Kubernetes/"/>
    
    
    <category term="Docker" scheme="https://awslzhang.top/tags/Docker/"/>
    
    <category term="Kubernetes" scheme="https://awslzhang.top/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kuberneteså­¦ä¹ </title>
    <link href="https://awslzhang.top/2020/11/15/Kubernetes%E5%AD%A6%E4%B9%A0/"/>
    <id>https://awslzhang.top/2020/11/15/Kubernetes%E5%AD%A6%E4%B9%A0/</id>
    <published>2020-11-15T11:50:36.000Z</published>
    <updated>2021-01-01T05:49:59.957Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h1><h2 id="Kubernetesæ¦‚è¿°"><a href="#Kubernetesæ¦‚è¿°" class="headerlink" title="Kubernetesæ¦‚è¿°"></a>Kubernetesæ¦‚è¿°</h2><p>kubernetesï¼Œç®€ç§° K8sï¼Œæ˜¯ç”¨ 8 ä»£æ›¿ 8 ä¸ªå­—ç¬¦â€œuberneteâ€è€Œæˆçš„ç¼©å†™ã€‚æ˜¯ä¸€ä¸ªå¼€æº çš„ï¼Œç”¨äºç®¡ç†äº‘å¹³å°ä¸­å¤šä¸ªä¸»æœºä¸Šçš„å®¹å™¨åŒ–çš„åº”ç”¨ï¼ŒKubernetes çš„ç›®æ ‡æ˜¯è®©éƒ¨ç½²å®¹å™¨åŒ–çš„ åº”ç”¨ç®€å•å¹¶ä¸”é«˜æ•ˆï¼ˆpowerfulï¼‰,Kubernetes æä¾›äº†åº”ç”¨éƒ¨ç½²ï¼Œè§„åˆ’ï¼Œæ›´æ–°ï¼Œç»´æŠ¤çš„ä¸€ç§ æœºåˆ¶ã€‚</p><p>Kubernetes æ˜¯ Google å¼€æºçš„ä¸€ä¸ªå®¹å™¨ç¼–æ’å¼•æ“ï¼Œ<font color="red">å®ƒæ”¯æŒè‡ªåŠ¨åŒ–éƒ¨ç½²ã€å¤§è§„æ¨¡å¯ä¼¸ç¼©ã€ åº”ç”¨å®¹å™¨åŒ–ç®¡ç†ã€‚</font>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­éƒ¨ç½²ä¸€ä¸ªåº”ç”¨ç¨‹åºæ—¶ï¼Œ<font color="red">é€šå¸¸è¦éƒ¨ç½²è¯¥åº”ç”¨çš„å¤šä¸ªå®ä¾‹ä»¥ä¾¿ å¯¹åº”ç”¨è¯·æ±‚è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚</font></p><blockquote><p>Kubernetesæ˜¯å®¹å™¨åŒ–é›†ç¾¤ç®¡ç†ç³»ç»Ÿã€‚å®ƒè®©éƒ¨ç½²å®¹å™¨åŒ–åº”ç”¨æ›´åŠ ç®€æ´å’Œé«˜æ•ˆã€‚</p></blockquote><blockquote><p>Kuberneteså¯ä»¥è®¤ä¸ºæ˜¯å®¹å™¨çš„èµ„æºç®¡ç†å™¨ï¼Œå…¶ä»–çš„èµ„æºç®¡ç†å™¨è¿˜æœ‰ï¼š</p><ul><li><code>Apache MESOS</code>ï¼šåˆ†å¸ƒå¼èµ„æºç®¡ç†æ¡†æ¶ï¼Œåœ¨2019-5ï¼ŒTwitterå®£å¸ƒç”±MESOSè½¬ä¸ºKubernetes</li><li><code>Docker Swarm</code>ï¼šè½»é‡ã€åŠŸèƒ½å°‘ï¼Œåœ¨2019-7ï¼Œé˜¿é‡Œäº‘å®£å¸ƒä¸æ”¯æŒDocker Swarm</li><li><font color="red"><code>Kubernetes</code></font>ï¼šGoogleå…¬å¸å‘å¸ƒï¼Œé‡‡ç”¨GOè¯­è¨€å¼€å‘<ul><li>ç‰¹ç‚¹ï¼šè½»é‡çº§ã€å¼€æºã€å¼¹æ€§ä¼¸ç¼©ã€è´Ÿè½½å‡è¡¡(IPVS)</li></ul></li></ul></blockquote><h2 id="ä¸ºä»€ä¹ˆéœ€è¦-Kubernetesï¼Œå®ƒèƒ½åšä»€ä¹ˆ"><a href="#ä¸ºä»€ä¹ˆéœ€è¦-Kubernetesï¼Œå®ƒèƒ½åšä»€ä¹ˆ" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦ Kubernetesï¼Œå®ƒèƒ½åšä»€ä¹ˆ?"></a>ä¸ºä»€ä¹ˆéœ€è¦ Kubernetesï¼Œå®ƒèƒ½åšä»€ä¹ˆ?</h2><p><font color="red">å®¹å™¨æ˜¯æ‰“åŒ…å’Œè¿è¡Œåº”ç”¨ç¨‹åºçš„å¥½æ–¹å¼ã€‚</font>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ‚¨éœ€è¦ç®¡ç†è¿è¡Œåº”ç”¨ç¨‹åºçš„å®¹å™¨ï¼Œ<strong>å¹¶ç¡®ä¿ä¸ä¼šåœæœº</strong>ã€‚ä¾‹å¦‚ï¼Œ<font color="red">å¦‚æœä¸€ä¸ªå®¹å™¨å‘ç”Ÿæ•…éšœï¼Œåˆ™éœ€è¦å¯åŠ¨å¦ä¸€ä¸ªå®¹å™¨ã€‚å¦‚æœç³»ç»Ÿå¤„ç†æ­¤è¡Œä¸ºï¼Œä¼šä¸ä¼šæ›´å®¹æ˜“ï¼Ÿ</font></p><p><strong>è¿™å°±æ˜¯ Kubernetes çš„æ•‘æ´æ–¹æ³•ï¼</strong>Kubernetes ä¸ºæ‚¨æä¾›äº†ä¸€ä¸ª<font color="red"><strong>å¯å¼¹æ€§è¿è¡Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„æ¡†æ¶</strong></font>ã€‚Kubernetes ä¼šæ»¡è¶³æ‚¨çš„æ‰©å±•è¦æ±‚ã€æ•…éšœè½¬ç§»ã€éƒ¨ç½²æ¨¡å¼ç­‰ã€‚ä¾‹å¦‚ï¼ŒKubernetes å¯ä»¥è½»æ¾ç®¡ç†ç³»ç»Ÿçš„ Canary éƒ¨ç½²ã€‚</p><hr><p><strong>Kubernetes ä¸ºæ‚¨æä¾›ï¼š</strong></p><ul><li><p><strong>æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡</strong><br>Kubernetes å¯ä»¥ä½¿ç”¨ DNS åç§°æˆ–è‡ªå·±çš„ IP åœ°å€å…¬å¼€å®¹å™¨ï¼Œå¦‚æœåˆ°å®¹å™¨çš„æµé‡å¾ˆå¤§ï¼ŒKubernetes å¯ä»¥è´Ÿè½½å‡è¡¡å¹¶åˆ†é…ç½‘ç»œæµé‡ï¼Œä»è€Œä½¿éƒ¨ç½²ç¨³å®šã€‚</p></li><li><p><strong>å­˜å‚¨ç¼–æ’</strong><br>Kubernetes å…è®¸æ‚¨è‡ªåŠ¨æŒ‚è½½æ‚¨é€‰æ‹©çš„å­˜å‚¨ç³»ç»Ÿï¼Œä¾‹å¦‚æœ¬åœ°å­˜å‚¨ã€å…¬å…±äº‘æä¾›å•†ç­‰ã€‚</p></li><li><p><strong>è‡ªåŠ¨éƒ¨ç½²å’Œå›æ»š</strong><br>æ‚¨å¯ä»¥ä½¿ç”¨ Kubernetes æè¿°å·²éƒ¨ç½²å®¹å™¨çš„æ‰€éœ€çŠ¶æ€ï¼Œå®ƒå¯ä»¥ä»¥å—æ§çš„é€Ÿç‡å°†å®é™…çŠ¶æ€æ›´æ”¹ä¸ºæ‰€éœ€çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥è‡ªåŠ¨åŒ– Kubernetes æ¥ä¸ºæ‚¨çš„éƒ¨ç½²åˆ›å»ºæ–°å®¹å™¨ï¼Œåˆ é™¤ç°æœ‰å®¹å™¨å¹¶å°†å®ƒä»¬çš„æ‰€æœ‰èµ„æºç”¨äºæ–°å®¹å™¨ã€‚</p></li><li><p><strong>è‡ªåŠ¨äºŒè¿›åˆ¶æ‰“åŒ…</strong><br>Kubernetes å…è®¸æ‚¨æŒ‡å®šæ¯ä¸ªå®¹å™¨æ‰€éœ€ CPU å’Œå†…å­˜ï¼ˆRAMï¼‰ã€‚å½“å®¹å™¨æŒ‡å®šäº†èµ„æºè¯·æ±‚æ—¶ï¼ŒKubernetes å¯ä»¥åšå‡ºæ›´å¥½çš„å†³ç­–æ¥ç®¡ç†å®¹å™¨çš„èµ„æºã€‚</p></li><li><p><strong>è‡ªæˆ‘ä¿®å¤</strong><br>Kubernetes é‡æ–°å¯åŠ¨å¤±è´¥çš„å®¹å™¨ã€æ›¿æ¢å®¹å™¨ã€æ€æ­»ä¸å“åº”ç”¨æˆ·å®šä¹‰çš„è¿è¡ŒçŠ¶å†µæ£€æŸ¥çš„å®¹å™¨ï¼Œå¹¶ä¸”åœ¨å‡†å¤‡å¥½æœåŠ¡ä¹‹å‰ä¸å°†å…¶é€šå‘Šç»™å®¢æˆ·ç«¯ã€‚</p></li><li><p><strong>å¯†é’¥ä¸é…ç½®ç®¡ç†</strong><br>Kubernetes å…è®¸æ‚¨å­˜å‚¨å’Œç®¡ç†æ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚å¯†ç ã€OAuth ä»¤ç‰Œå’Œ ssh å¯†é’¥ã€‚æ‚¨å¯ä»¥åœ¨ä¸é‡å»ºå®¹å™¨é•œåƒçš„æƒ…å†µä¸‹éƒ¨ç½²å’Œæ›´æ–°å¯†é’¥å’Œåº”ç”¨ç¨‹åºé…ç½®ï¼Œä¹Ÿæ— éœ€åœ¨å †æ ˆé…ç½®ä¸­æš´éœ²å¯†é’¥ã€‚</p></li></ul><h2 id="Kubernetesæ¶æ„ç»„ä»¶"><a href="#Kubernetesæ¶æ„ç»„ä»¶" class="headerlink" title="Kubernetesæ¶æ„ç»„ä»¶"></a>Kubernetesæ¶æ„ç»„ä»¶</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-11-15_16-52-10.png" alt="Snipaste_2020-11-15_16-52-10"></p><p><font color="red"><strong>k8s é›†ç¾¤çš„èŠ‚ç‚¹æœ‰ä¸¤ä¸ªè§’è‰²ï¼Œåˆ†åˆ«ä¸º Master èŠ‚ç‚¹å’Œ Node èŠ‚ç‚¹ï¼Œæ•´ä¸ª K8s é›†ç¾¤Master å’Œ Node èŠ‚ç‚¹å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</strong></font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/20200823181812.png"></p><h3 id="MasterèŠ‚ç‚¹ç»„ä»¶"><a href="#MasterèŠ‚ç‚¹ç»„ä»¶" class="headerlink" title="MasterèŠ‚ç‚¹ç»„ä»¶"></a>MasterèŠ‚ç‚¹ç»„ä»¶</h3><p>Master èŠ‚ç‚¹ä¹Ÿç§°ä¸ºæ§åˆ¶èŠ‚ç‚¹ï¼Œæ¯ä¸ª k8s é›†ç¾¤éƒ½æœ‰ä¸€ä¸ª Master èŠ‚ç‚¹è´Ÿè´£æ•´ä¸ªé›†ç¾¤çš„ç®¡ç†æ§åˆ¶ï¼Œæˆ‘ä»¬ä¸Šé¢ä»‹ç»çš„ k8s ä¸‰å¤§èƒ½åŠ›éƒ½æ˜¯ç»è¿‡ Master èŠ‚ç‚¹å‘èµ·çš„ï¼ŒMaster èŠ‚ç‚¹åŒ…å«äº†ä»¥ä¸‹å‡ ä¸ªç»„ä»¶ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/20200823181408.png"></p><ul><li><code>API server</code>ï¼šé›†ç¾¤ç»Ÿä¸€å…¥å£ï¼Œæä¾›äº† HTTP Rest æ¥å£çš„æœåŠ¡è¿›ç¨‹ï¼Œæ‰€æœ‰èµ„æºå¯¹è±¡çš„å¢ã€åˆ ã€æ”¹ã€æŸ¥ç­‰æ“ä½œçš„å”¯ä¸€å…¥å£ï¼›</li><li><code>controller-manager</code>ï¼šk8s é›†ç¾¤æ‰€æœ‰èµ„æºå¯¹è±¡çš„è‡ªåŠ¨åŒ–æ§åˆ¶ä¸­å¿ƒï¼›<strong>ä¸€ä¸ªèµ„æºå¯¹åº”ä¸€ä¸ªæ§åˆ¶å™¨</strong>ã€‚</li><li><code>scheduler</code>ï¼šä¸»èŠ‚ç‚¹ä¸Šçš„ç»„ä»¶ï¼Œè¯¥ç»„ä»¶ç›‘è§†é‚£äº›æ–°åˆ›å»ºçš„æœªæŒ‡å®šè¿è¡ŒèŠ‚ç‚¹çš„ Podï¼Œå¹¶é€‰æ‹©èŠ‚ç‚¹è®© Pod åœ¨ä¸Šé¢è¿è¡Œã€‚</li><li><code>etcd</code>ï¼šæ˜¯å…¼å…·ä¸€è‡´æ€§å’Œé«˜å¯ç”¨æ€§çš„é”®å€¼æ•°æ®åº“ï¼Œå¯ä»¥ä½œä¸ºä¿å­˜ Kubernetes æ‰€æœ‰é›†ç¾¤æ•°æ®çš„åå°æ•°æ®åº“ã€‚</li></ul><h3 id="WorkerèŠ‚ç‚¹ç»„ä»¶"><a href="#WorkerèŠ‚ç‚¹ç»„ä»¶" class="headerlink" title="WorkerèŠ‚ç‚¹ç»„ä»¶"></a>WorkerèŠ‚ç‚¹ç»„ä»¶</h3><p>Node èŠ‚ç‚¹çš„ä½œç”¨æ˜¯æ‰¿æ¥ Master åˆ†é…çš„å·¥ä½œè´Ÿè½½ï¼Œå®ƒä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªå…³é”®ç»„ä»¶ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/20200823184119.png"></p><ul><li><code>Kubelet</code>ï¼šè´Ÿè´£ Pod å¯¹åº”å®¹å™¨çš„åˆ›å»ºã€å¯åœç­‰æ“ä½œï¼Œä¸ Master èŠ‚ç‚¹ç´§å¯†åä½œï¼›</li><li><code>kube-proxy</code>ï¼šæä¾›ç½‘ç»œä»£ç†ï¼Œå®ç° k8s é›†ç¾¤é€šä¿¡ä¸è´Ÿè½½å‡è¡¡çš„ç»„ä»¶ã€‚</li></ul><h2 id="Kubernetesæ ¸å¿ƒæ¦‚å¿µ"><a href="#Kubernetesæ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="Kubernetesæ ¸å¿ƒæ¦‚å¿µ"></a>Kubernetesæ ¸å¿ƒæ¦‚å¿µ</h2><h3 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h3><p>Pod æ˜¯ k8s æœ€é‡è¦è€Œä¸”æ˜¯æœ€åŸºæœ¬çš„ä¸€ä¸ªèµ„æºå¯¹è±¡ï¼Œå®ƒçš„ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/20200821153531.png"></p><p>ä»ä»¥ä¸Š Pod çš„ç»“æ„å›¾å¯ä»¥çœ‹å‡ºï¼Œå®ƒå…¶å®æ˜¯å®¹å™¨çš„ä¸€ä¸ªä¸Šå±‚åŒ…è£…ç»“æ„ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ K8s å¯ä»¥æ”¯æŒå¤šç§å®¹å™¨ç±»å‹çš„åŸå› ï¼ŒåŸºäºè¿™æ–¹é¢ï¼Œæˆ‘ç†è§£ k8s çš„å®šä½å°±æ˜¯ä¸€ä¸ªç¼–æ’ä¸è°ƒåº¦å·¥å…·ï¼Œè€Œå®¹å™¨åªæ˜¯å®ƒè°ƒåº¦çš„ä¸€ä¸ªèµ„æºå¯¹è±¡è€Œå·²ã€‚</p><p>Pod å¯åŒ…å«å¤šä¸ªå®¹å™¨åœ¨é‡Œé¢ï¼Œæ¯ä¸ª Pod è‡³å°‘ä¼šæœ‰ä¸€ä¸ª Pause å®¹å™¨ï¼Œå…¶å®ƒç”¨æˆ·å®šä¹‰çš„å®¹å™¨éƒ½å…±äº«è¯¥ Pause å®¹å™¨ï¼ŒPause å®¹å™¨çš„ä¸»è¦ä½œç”¨æ˜¯ç”¨äºå®šä¹‰ Pod çš„ ip å’Œ volumeã€‚</p><p>Pod åœ¨ k8s é›†ç¾¤ä¸­çš„ä½ç½®å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/20200823185441.png"></p><p><strong>Podç‰¹ç‚¹ï¼š</strong></p><ul><li>k8sä¸­çš„æœ€å°éƒ¨ç½²å•å…ƒã€‚</li><li>æ˜¯ä¸€ç»„å®¹å™¨çš„é›†åˆã€‚</li><li>Podä¸­çš„æ‰€æœ‰å®¹å™¨æ˜¯å…±äº«ç½‘ç»œçš„</li><li>Podçš„ç”Ÿå‘½å‘¨æœŸå¾ˆçŸ­æš‚</li></ul><h3 id="Label"><a href="#Label" class="headerlink" title="Label"></a>Label</h3><p>Label åœ¨ k8s ä¸­æ˜¯ä¸€ä¸ªéå¸¸æ ¸å¿ƒçš„æ¦‚å¿µï¼Œæˆ‘ä»¬å¯ä»¥å°† Label æŒ‡å®šåˆ°å¯¹åº”çš„èµ„æºå¯¹è±¡ä¸­ï¼Œä¾‹å¦‚ Nodeã€Podã€Replica Setã€Service ç­‰ï¼Œä¸€ä¸ªèµ„æºå¯ä»¥ç»‘å®šä»»æ„ä¸ª Labelï¼Œ<font color="red">k8s é€šè¿‡ Label å¯å®ç°å¤šç»´åº¦çš„èµ„æºåˆ†ç»„ç®¡ç†</font>ï¼Œåç»­å¯é€šè¿‡ <font color="red">Label Selector æŸ¥è¯¢å’Œç­›é€‰æ‹¥æœ‰æŸäº› Label çš„èµ„æºå¯¹è±¡</font>ï¼Œä¾‹å¦‚åˆ›å»ºä¸€ä¸ª Podï¼Œç»™å®šä¸€ä¸ª Labelï¼Œworkerid=123ï¼Œåç»­å¯é€šè¿‡ workerid=123 åˆ é™¤æ‹¥æœ‰è¯¥æ ‡ç­¾çš„ Pod èµ„æºã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/20200823192435.png"></p><h3 id="Replica-Set"><a href="#Replica-Set" class="headerlink" title="Replica Set"></a>Replica Set</h3><p><font color="red"><strong>Replica Set ç›®çš„æ˜¯ä¸ºäº†å®šä¹‰ä¸€ä¸ªæœŸæœ›çš„åœºæ™¯</strong></font>ï¼Œæ¯”å¦‚å®šä¹‰æŸç§ <strong>Pod çš„å‰¯æœ¬æ•°é‡</strong>åœ¨ä»»æ„æ—¶åˆ»éƒ½å¤„äº Peplica Set æœŸæœ›çš„å€¼ï¼Œå‡è®¾ Replica Set å®šä¹‰ Pod çš„å‰¯æœ¬æ•°ç›®ä¸ºï¼šreplicas=2ï¼Œå½“è¯¥ Replica Set æäº¤ç»™ Master åï¼ŒMaster ä¼šå®šæœŸå·¡æ£€è¯¥ Pod åœ¨é›†ç¾¤ä¸­çš„æ•°ç›®ï¼Œå¦‚æœå‘ç°è¯¥ Pod æŒ‚æ‰äº†ä¸€ä¸ªï¼ŒMaster å°±ä¼šå°è¯•ä¾æ® Replica Set è®¾ç½®çš„ Pod æ¨¡ç‰ˆåˆ›å»º Podï¼Œä»¥ç»´æŒ Pod çš„æ•°é‡ä¸ Replica Set é¢„æœŸçš„ Pod æ•°é‡ç›¸åŒã€‚</p><p>é€šè¿‡ Replica Setï¼Œk8s é›†ç¾¤å®ç°äº†ç”¨æˆ·åº”ç”¨çš„é«˜å¯ç”¨æ€§ï¼Œè€Œä¸”å¤§å¤§å‡å°‘äº†è¿ç»´å·¥ä½œé‡ã€‚<font color="red"><strong>å› æ­¤ç”Ÿäº§ç¯å¢ƒä¸€èˆ¬ç”¨ Deployment æˆ–è€… Replica Set å»æ§åˆ¶ Pod çš„ç”Ÿå‘½å‘¨æœŸå’ŒæœŸæœ›å€¼ï¼Œè€Œä¸æ˜¯ç›´æ¥å•ç‹¬åˆ›å»º Podã€‚</strong></font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/20200823193118.png"></p><p>ç±»ä¼¼ Replica Set çš„è¿˜æœ‰ <code>Deployment</code>ï¼Œå®ƒçš„å†…éƒ¨å®ç°ä¹Ÿæ˜¯é€šè¿‡ Replica Set å®ç°çš„ï¼Œå¯ä»¥è¯´ Deployment æ˜¯ Replica Set çš„å‡çº§ç‰ˆï¼Œå®ƒä»¬ä¹‹é—´çš„ yaml é…ç½®æ–‡ä»¶æ ¼å¼å¤§éƒ¨åˆ†éƒ½ç›¸åŒã€‚</p><h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>Service æ˜¯ k8s èƒ½å¤Ÿå®ç°å¾®æœåŠ¡é›†ç¾¤çš„ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œé¡¾åæ€ä¹‰ï¼Œk8s çš„ Service å°±æ˜¯æˆ‘ä»¬å¹³æ—¶æ‰€æåŠçš„å¾®æœåŠ¡æ¶æ„ä¸­çš„â€œå¾®æœåŠ¡â€ï¼Œæœ¬æ–‡ä¸Šé¢æåŠçš„ Podã€Replica Set ç­‰éƒ½æ˜¯ä¸º Service æœåŠ¡çš„èµ„æºï¼Œ å¦‚ä¸‹å›¾è¡¨ç¤º Serviceã€Podã€Replica Set çš„å…³ç³»ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/20200823200632.png"></p><p>ä»ä¸Šå›¾å¯çœ‹å‡ºï¼ŒService å®šä¹‰äº†ä¸€ä¸ªæœåŠ¡è®¿é—®çš„å…¥å£ï¼Œå®¢æˆ·ç«¯é€šè¿‡è¿™ä¸ªå…¥å£å³å¯è®¿é—®æœåŠ¡èƒŒåçš„åº”ç”¨é›†ç¾¤å®ä¾‹ï¼Œ<font color="red">è€Œ Service åˆ™æ˜¯é€šè¿‡ Label Selector å®ç°å…³è”ä¸å¯¹æ¥çš„ï¼ŒReplica Set ä¿è¯æœåŠ¡é›†ç¾¤èµ„æºå§‹ç»ˆå¤„äºæœŸæœ›å€¼ã€‚</font></p><p>ä»¥ä¸Šåªæ˜¯ä¸€ä¸ªå¾®æœåŠ¡ï¼Œé€šå¸¸æ¥è¯´ä¸€ä¸ªåº”ç”¨é¡¹ç›®ä¼šç”±å¤šä¸ªä¸åŒä¸šåŠ¡èƒ½åŠ›è€Œåˆå½¼æ­¤ç‹¬ç«‹çš„å¾®æœåŠ¡ç»„æˆï¼Œå¤šä¸ªå¾®æœåŠ¡é—´ç»„æˆäº†ä¸€ä¸ªå¼ºå¤§è€Œåˆé«˜å¯ç”¨çš„åº”ç”¨æœåŠ¡é›†ç¾¤ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/20200823220527.png"></p><h3 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h3><p>Namespace é¡¾åæ€ä¹‰æ˜¯å‘½åç©ºé—´çš„æ„æ€ï¼Œåœ¨ k8s ä¸­ä¸»è¦ç”¨äºå®ç°èµ„æºéš”ç¦»çš„ç›®çš„ï¼Œç”¨æˆ·å¯æ ¹æ®ä¸åŒé¡¹ç›®åˆ›å»ºä¸åŒçš„ Namespaceï¼Œé€šè¿‡ k8s å°†èµ„æºåˆ†é…åˆ°ä¸åŒ Namespace ä¸­ï¼Œå³å¯å®ç°ä¸åŒé¡¹ç›®çš„èµ„æºéš”ç¦»ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/20200823214534.png" alt="img"></p><h1 id="Kubernetesçš„æ­å»º"><a href="#Kubernetesçš„æ­å»º" class="headerlink" title="Kubernetesçš„æ­å»º"></a>Kubernetesçš„æ­å»º</h1><p><strong>å‰ç½®çŸ¥è¯†ç‚¹</strong> </p><p>ç›®å‰ç”Ÿäº§éƒ¨ç½²Kubernetes é›†ç¾¤ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š </p><blockquote><p><strong>kubeadm</strong> </p><p>Kubeadm æ˜¯ä¸€ä¸ª K8s éƒ¨ç½²å·¥å…·ï¼Œæä¾› kubeadm init å’Œ kubeadm joinï¼Œç”¨äºå¿«é€Ÿéƒ¨ç½² Kubernetes é›†ç¾¤ã€‚ </p><p>å®˜æ–¹åœ°å€ï¼š<a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/">https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/</a> </p></blockquote><blockquote><p><strong>äºŒè¿›åˆ¶åŒ…</strong> </p><p>ä» github ä¸‹è½½å‘è¡Œç‰ˆçš„äºŒè¿›åˆ¶åŒ…ï¼Œæ‰‹åŠ¨éƒ¨ç½²æ¯ä¸ªç»„ä»¶ï¼Œç»„æˆ Kubernetes é›†ç¾¤ã€‚Kubeadm é™ä½éƒ¨ç½²é—¨æ§›ï¼Œä½†å±è”½äº†å¾ˆå¤šç»†èŠ‚ï¼Œé‡åˆ°é—®é¢˜å¾ˆéš¾æ’æŸ¥ã€‚å¦‚æœæƒ³æ›´å®¹æ˜“å¯æ§ï¼Œæ¨èä½¿ç”¨äºŒè¿›åˆ¶åŒ…éƒ¨ç½² Kubernetes é›†ç¾¤ï¼Œè™½ç„¶æ‰‹åŠ¨éƒ¨ç½²éº»çƒ¦ç‚¹ï¼ŒæœŸé—´å¯ä»¥å­¦ä¹ å¾ˆå¤šå·¥ä½œåŸç†ï¼Œä¹Ÿåˆ©äºåæœŸç»´æŠ¤ã€‚ </p></blockquote><hr><p><strong>é›†ç¾¤æœºå™¨é¡»çŸ¥</strong></p><ul><li>é›†ç¾¤é—´æœºå™¨ç½‘ç»œäº’é€š</li><li>ç¦æ­¢Swapäº¤æ¢</li></ul><h2 id="kubeadméƒ¨ç½²"><a href="#kubeadméƒ¨ç½²" class="headerlink" title="kubeadméƒ¨ç½²"></a>kubeadméƒ¨ç½²</h2><p><code>kubeadm</code>æ˜¯å®˜æ–¹ç¤¾åŒºæ¨å‡ºçš„ä¸€ä¸ªç”¨äºå¿«é€Ÿéƒ¨ç½² kubernetes é›†ç¾¤çš„å·¥å…·ï¼Œè¿™ä¸ªå·¥å…·èƒ½é€šè¿‡ä¸¤æ¡æŒ‡ä»¤å®Œæˆä¸€ä¸ªkubernetesé›†ç¾¤çš„éƒ¨ç½²ï¼š</p><ol><li>åˆ›å»ºä¸€ä¸ªMasterèŠ‚ç‚¹<code>kubeadm init</code></li><li>å°†NodeèŠ‚ç‚¹åŠ å…¥åˆ°å½“å‰é›†ç¾¤ä¸­<code>kubeadm join &lt;Master èŠ‚ç‚¹çš„ IP å’Œç«¯å£ &gt;</code></li></ol><blockquote><p>è¯¦ç»†æ­¥éª¤ï¼š</p></blockquote><h3 id="å‡†å¤‡ç¯å¢ƒ"><a href="#å‡†å¤‡ç¯å¢ƒ" class="headerlink" title="å‡†å¤‡ç¯å¢ƒ"></a>å‡†å¤‡ç¯å¢ƒ</h3><table><thead><tr><th>è§’è‰²</th><th>IP</th></tr></thead><tbody><tr><td>master</td><td>192.168.58.11</td></tr><tr><td>node1</td><td>192.168.58.12</td></tr><tr><td>node2</td><td>192.168.58.13</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…³é—­é˜²ç«å¢™</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­selinux</span></span><br><span class="line">sed -i <span class="string">&#x27;s/enforcing/disabled/&#x27;</span> /etc/selinux/config  <span class="comment"># æ°¸ä¹…</span></span><br><span class="line">setenforce 0  <span class="comment"># ä¸´æ—¶</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­swap</span></span><br><span class="line">swapoff -a  <span class="comment"># ä¸´æ—¶</span></span><br><span class="line">sed -ri <span class="string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab    <span class="comment"># æ°¸ä¹…</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ¹æ®è§„åˆ’è®¾ç½®ä¸»æœºå</span></span><br><span class="line">hostnamectl set-hostname &lt;hostname&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨masteræ·»åŠ hosts</span></span><br><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">192.168.58.11 k8smaster</span></span><br><span class="line"><span class="string">192.168.58.12 k8snode1</span></span><br><span class="line"><span class="string">192.168.58.13 k8snode2</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†æ¡¥æ¥çš„IPv4æµé‡ä¼ é€’åˆ°iptablesçš„é“¾</span></span><br><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">sysctl --system  <span class="comment"># ç”Ÿæ•ˆ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ—¶é—´åŒæ­¥</span></span><br><span class="line">yum install ntpdate -y</span><br><span class="line">ntpdate time.windows.com</span><br></pre></td></tr></table></figure><h3 id="æ‰€æœ‰èŠ‚ç‚¹å®‰è£…Docker-kubeadm-kubelet"><a href="#æ‰€æœ‰èŠ‚ç‚¹å®‰è£…Docker-kubeadm-kubelet" class="headerlink" title="æ‰€æœ‰èŠ‚ç‚¹å®‰è£…Docker/kubeadm/kubelet"></a>æ‰€æœ‰èŠ‚ç‚¹å®‰è£…Docker/kubeadm/kubelet</h3><blockquote><p>Kubernetesé»˜è®¤CRIï¼ˆå®¹å™¨è¿è¡Œæ—¶ï¼‰ä¸ºDockerï¼Œå› æ­¤å…ˆå®‰è£…Dockerã€‚</p></blockquote><h4 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">$ yum -y install docker-ce-18.06.1.ce-3.el7</span><br><span class="line">$ systemctl <span class="built_in">enable</span> docker &amp;&amp; systemctl start docker</span><br><span class="line">$ docker --version</span><br><span class="line">Docker version 18.06.1-ce, build e68fc7a</span><br></pre></td></tr></table></figure><p>é•œåƒåŠ é€Ÿ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; /etc/docker/daemon.json &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;registry-mirrors&quot;: [&quot;https://reg-mirror.qiniu.com&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h4 id="kubeadm-kubelet-kubectl"><a href="#kubeadm-kubelet-kubectl" class="headerlink" title="kubeadm,kubelet,kubectl"></a>kubeadm,kubelet,kubectl</h4><p>å›½å†…é•œåƒä¸‹è½½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">repo_gpgcheck=0</span></span><br><span class="line"><span class="string">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>å®‰è£…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y kubelet-1.18.0 kubeadm-1.18.0 kubectl-1.18.0</span><br><span class="line">$ systemctl <span class="built_in">enable</span> kubelet</span><br></pre></td></tr></table></figure><h3 id="éƒ¨ç½²Kubernetes-Master"><a href="#éƒ¨ç½²Kubernetes-Master" class="headerlink" title="éƒ¨ç½²Kubernetes Master"></a>éƒ¨ç½²Kubernetes Master</h3><p>åœ¨192.168.58.11ï¼ˆMasterï¼‰æ‰§è¡Œã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm init \</span><br><span class="line">  --apiserver-advertise-address=192.168.58.11 \</span><br><span class="line">  --image-repository registry.aliyuncs.com/google_containers \</span><br><span class="line">  --kubernetes-version v1.18.0 \</span><br><span class="line">  --service-cidr=10.96.0.0/12 \</span><br><span class="line">  --pod-network-cidr=10.244.0.0/16</span><br></pre></td></tr></table></figure><blockquote><p>ç”±äºé»˜è®¤æ‹‰å–é•œåƒåœ°å€k8s.gcr.ioå›½å†…æ— æ³•è®¿é—®ï¼Œè¿™é‡ŒæŒ‡å®šé˜¿é‡Œäº‘é•œåƒä»“åº“åœ°å€ã€‚</p><p>pod-network-cidrä¸service-cidrè®¾ç½®ä¸åŒçš„ç½‘æ®µå³å¯ï¼Œä¸å¯ä¸æœ¬æœºç›¸å†²çªã€‚</p><p><font color="red"><strong>æ³¨æ„</strong>ï¼Œåªæœ‰ä¸€ä¸ªæ ¸å¿ƒæ˜¯ä¸èƒ½åˆå§‹åŒ–çš„ï¼ï¼ï¼</font></p></blockquote><p>è¿™æ¡å‘½ä»¤å°±æ˜¯æ‹‰å–kubernetesçš„å„ä¸ªç»„ä»¶çš„é•œåƒï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-11-16_21-08-35.png" alt="Snipaste_2020-11-16_21-08-35"></p><p><strong>Masteråˆå§‹åŒ–å®Œæˆåç”±æ­¤æç¤º</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-11-16_21-09-38.png" alt="Snipaste_2020-11-16_21-09-38"></p><p><strong>æ­¤æ—¶ï¼Œä½ çš„é›†ç¾¤è¿˜ä¸èƒ½ä½¿ç”¨ï¼Œä¸Šå›¾ä¸­è¿˜æœ‰æç¤ºä¿¡æ¯</strong></p><blockquote><p>To start using your cluster, you need to run the following as a regular user:</p></blockquote><p>ä½ éœ€è¦åœ¨Masteræ‰§è¡Œä¸€ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">$ sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">$ sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure><h3 id="åŠ å…¥Kubernetes-Node"><a href="#åŠ å…¥Kubernetes-Node" class="headerlink" title="åŠ å…¥Kubernetes Node"></a>åŠ å…¥Kubernetes Node</h3><p>ç”±Masteråˆå§‹åŒ–çš„ä¿¡æ¯å¯å¾—çŸ¥ï¼ŒNodeåŠ å…¥Masteré›†ç¾¤éœ€è¦æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.58.11:6443 --token bpx0wc.r7m0c9sp15cfu81r \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:3dd5733fa6ed0394a98b67c57fc512d6fe6776c7cb954a96673b24c8276cb885</span><br></pre></td></tr></table></figure><blockquote><p><font color="red">æ³¨æ„ï¼šä¸è¦å¤åˆ¶æˆ‘çš„tokenï¼Œä»ä½ çš„å‘½ä»¤è¡Œä¸­å¯»æ‰¾ï¼</font></p></blockquote><p><strong>ä¸¤ä¸ªnodeèŠ‚ç‚¹åŠ å…¥å®Œæˆä¹‹åï¼Œåœ¨MasteræŸ¥çœ‹èŠ‚ç‚¹</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-11-16_21-17-38.png" alt="Snipaste_2020-11-16_21-17-38"></p><p>å‘ç°ï¼Œä»–ä»¬çŠ¶æ€éƒ½æ˜¯<code>NotReady</code>ã€‚æ˜¯å› ä¸ºè¿˜æ²¡æœ‰é…ç½®æœ€åä¸€æ­¥ï¼šç½‘ç»œï¼</p><h3 id="éƒ¨ç½²CNIç½‘ç»œæ’ä»¶"><a href="#éƒ¨ç½²CNIç½‘ç»œæ’ä»¶" class="headerlink" title="éƒ¨ç½²CNIç½‘ç»œæ’ä»¶"></a>éƒ¨ç½²CNIç½‘ç»œæ’ä»¶</h3><p>MasterèŠ‚ç‚¹è¿è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure><p>é»˜è®¤é•œåƒåœ°å€æ— æ³•è®¿é—®ï¼Œsedå‘½ä»¤ä¿®æ”¹ä¸ºdocker hubé•œåƒä»“åº“ã€‚</p><p><strong>æŸ¥çœ‹æ˜¯å¦å®Œæˆ</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-11-16_21-25-16.png" alt="Snipaste_2020-11-16_21-25-16"></p><h3 id="æµ‹è¯•kubernetesé›†ç¾¤"><a href="#æµ‹è¯•kubernetesé›†ç¾¤" class="headerlink" title="æµ‹è¯•kubernetesé›†ç¾¤"></a>æµ‹è¯•kubernetesé›†ç¾¤</h3><p>åœ¨Kubernetesé›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ªpodï¼ŒéªŒè¯æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create deployment nginx --image=nginx</span><br><span class="line">$ kubectl expose deployment nginx --port=80 --<span class="built_in">type</span>=NodePort</span><br><span class="line">$ kubectl get pod,svc</span><br></pre></td></tr></table></figure><p>è®¿é—®ip:portï¼Œæˆ‘ä»¬å‘ç°ä¸‰å°æœºå™¨çš„è¿™ä¸ªç«¯å£éƒ½å¯ä»¥è®¿é—®åˆ°nginxã€‚</p><h2 id="äºŒè¿›åˆ¶éƒ¨ç½²"><a href="#äºŒè¿›åˆ¶éƒ¨ç½²" class="headerlink" title="äºŒè¿›åˆ¶éƒ¨ç½²"></a>äºŒè¿›åˆ¶éƒ¨ç½²</h2><p>ç•¥â€¦</p><h1 id="kubectlå‘½ä»¤è¡Œå·¥å…·"><a href="#kubectlå‘½ä»¤è¡Œå·¥å…·" class="headerlink" title="kubectlå‘½ä»¤è¡Œå·¥å…·"></a><code>kubectl</code>å‘½ä»¤è¡Œå·¥å…·</h1><p>kubectl æ˜¯ Kubernetes é›†ç¾¤çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œé€šè¿‡ kubectl èƒ½å¤Ÿ<font color="red">å¯¹é›†ç¾¤æœ¬èº«è¿›è¡Œç®¡ç†ï¼Œå¹¶èƒ½å¤Ÿåœ¨é›†ç¾¤ä¸Šè¿›è¡Œå®¹å™¨åŒ–åº”ç”¨çš„å®‰è£…éƒ¨ç½²ã€‚</font></p><blockquote><p><strong><code>kubectl </code>å‘½ä»¤çš„è¯­æ³•</strong></p><p><code>kubectl [command] [type] [name] [flag]</code></p><ul><li><p><strong>comand</strong>ï¼šæŒ‡å®šè¦å¯¹èµ„æºæ‰§è¡Œçš„æ“ä½œï¼Œä¾‹å¦‚ createã€getã€describe å’Œ delete</p></li><li><p><strong>TYPE</strong>ï¼šæŒ‡å®šèµ„æºç±»å‹ï¼Œèµ„æºç±»å‹æ˜¯å¤§å°å†™æ•æ„Ÿçš„ï¼Œå¼€å‘è€…èƒ½å¤Ÿä»¥å•æ•°ã€å¤æ•°å’Œç¼©ç•¥çš„å½¢å¼ã€‚ä¾‹å¦‚ï¼š</p><ul><li><code>kubectl get pod</code></li><li><code>kubectl get pods</code></li><li><code>kubectl get po</code></li></ul></li><li><p><strong>NAME</strong>ï¼šæŒ‡å®šèµ„æºçš„åç§°ï¼Œåç§°ä¹Ÿå¤§å°å†™æ•æ„Ÿçš„ã€‚å¦‚æœçœç•¥åç§°ï¼Œåˆ™ä¼šæ˜¾ç¤ºæ‰€æœ‰çš„èµ„æºï¼Œ ä¾‹å¦‚: <code>kubectl get pods</code></p></li><li><p><strong>flags</strong>ï¼šæŒ‡å®šå¯é€‰çš„å‚æ•°ã€‚ä¾‹å¦‚ï¼Œå¯ç”¨-s æˆ–è€…â€“server å‚æ•°æŒ‡å®š Kubernetes API </p><p>server çš„åœ°å€å’Œç«¯å£ã€‚ </p></li></ul></blockquote><p><strong>åŸºç¡€å‘½ä»¤</strong></p><table><thead><tr><th>å‘½ä»¤</th><th>æè¿°</th></tr></thead><tbody><tr><td>create</td><td>é€šè¿‡æ–‡ä»¶åæˆ–æ ‡å‡†è¾“å…¥åˆ›å»ºèµ„æº</td></tr><tr><td>expose</td><td>å°†ä¸€ä¸ªèµ„æºå…¬å¼€ä¸ºä¸€ä¸ªæ–°çš„Service</td></tr><tr><td>run</td><td>åœ¨é›†ç¾¤ä¸­è¿è¡Œä¸€ä¸ªç‰¹å®šçš„é•œåƒ</td></tr><tr><td>set</td><td>åœ¨å¯¹è±¡ä¸Šè®¾ç½®ç‰¹å®šçš„åŠŸèƒ½</td></tr><tr><td>get</td><td>æ˜¾ç¤ºä¸€ä¸ª/å¤šä¸ªèµ„æº</td></tr><tr><td>explain</td><td>æ–‡æ¡£å‚è€ƒèµ„æ–™</td></tr><tr><td>edit</td><td>ä½¿ç”¨é»˜è®¤çš„ç¼–è¾‘å™¨ç¼–è¾‘ä¸€ä¸ªèµ„æº</td></tr><tr><td>delete</td><td>é€šè¿‡æ–‡ä»¶åã€æ ‡å‡†è¾“å…¥ã€èµ„æºåç§°æˆ–æ ‡ç­¾é€‰æ‹©å™¨åˆ é™¤èµ„æº</td></tr></tbody></table><p><strong>éƒ¨ç½²å’Œé›†ç¾¤ç®¡ç†å‘½ä»¤</strong></p><table><thead><tr><th>å‘½ä»¤</th><th>æè¿°</th></tr></thead><tbody><tr><td>rollout</td><td>ç®¡ç†èµ„æºçš„å‘å¸ƒ</td></tr><tr><td>rolling-update</td><td>å¯¹ç»™å®šçš„å¤åˆ¶æ§åˆ¶å™¨æ»šåŠ¨æ›´æ–°</td></tr><tr><td>scale</td><td>æ‰©å®¹æˆ–ç¼©å®¹Podæ•°é‡ï¼ŒDeploymentã€ReplicaSetã€RCæˆ–Job</td></tr><tr><td>autoscale</td><td>åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨é€‰æ‹©æ‰©å®¹æˆ–ç¼©å®¹å¹¶è®¾ç½®Podæ•°é‡</td></tr><tr><td>certificate</td><td>ä¿®æ”¹è¯ä¹¦èµ„æº</td></tr><tr><td>cluster-info</td><td>æ˜¾ç¤ºé›†ç¾¤ä¿¡æ¯</td></tr><tr><td>top</td><td>æ˜¾ç¤ºèµ„æºä½¿ç”¨</td></tr><tr><td>cordon</td><td>æ ‡è®°èŠ‚ç‚¹ä¸å¯è°ƒåº¦</td></tr><tr><td>uncordon</td><td>æ ‡è®°èŠ‚ç‚¹å¯è°ƒåº¦</td></tr><tr><td>drain</td><td>é©±é€èŠ‚ç‚¹ä¸Šçš„åº”ç”¨ï¼Œå‡†å¤‡ä¸‹çº¿ç»´æŠ¤</td></tr><tr><td>taint</td><td>ä¿®æ”¹èŠ‚ç‚¹taintæ ‡è®°</td></tr></tbody></table><p><strong>æ•…éšœå’Œè°ƒè¯•å‘½ä»¤</strong></p><table><thead><tr><th>å‘½ä»¤</th><th>æè¿°</th></tr></thead><tbody><tr><td>exec</td><td>æ‰§è¡Œå‘½ä»¤åˆ°å®¹å™¨</td></tr></tbody></table><h1 id="kubernetes-é›†ç¾¤YAMLæ–‡ä»¶è¯¦è§£"><a href="#kubernetes-é›†ç¾¤YAMLæ–‡ä»¶è¯¦è§£" class="headerlink" title="kubernetes é›†ç¾¤YAMLæ–‡ä»¶è¯¦è§£"></a>kubernetes é›†ç¾¤YAMLæ–‡ä»¶è¯¦è§£</h1><p>k8såœ¨å¯åŠ¨èµ„æºæ—¶æœ‰è¯¸å¤šé…ç½®ï¼Œå…¨å†™åœ¨å‘½ä»¤è¡Œé‡Œå¾ˆä¸æ–¹ä¾¿ã€‚æ‰€ä»¥å¯ä»¥é€šè¿‡yamlæ–‡ä»¶é…ç½®ï¼Œåœ¨è¿è¡Œæ—¶åªç”¨æŒ‡å®šä¸€ä¸ªyamlæ–‡ä»¶å³å¯</p><blockquote><p>yamlä¹¦å†™æ ¼å¼</p><ul><li>ä½¿ç”¨ç©ºæ ¼åšä¸ºç¼©è¿›</li><li>ç¼©è¿›çš„ç©ºæ ¼æ•°ç›®ä¸é‡è¦ï¼Œåªè¦ç›¸åŒå±‚çº§çš„å…ƒç´ å·¦ä¾§å¯¹é½å³å¯</li><li>ä½ç‰ˆæœ¬ç¼©è¿›æ—¶ä¸å…è®¸ä½¿ç”¨ Tab é”®ï¼Œåªå…è®¸ä½¿ç”¨ç©ºæ ¼ </li><li>ä½¿ç”¨#æ ‡è¯†æ³¨é‡Šï¼Œä»è¿™ä¸ªå­—ç¬¦ä¸€ç›´åˆ°è¡Œå°¾ï¼Œéƒ½ä¼šè¢«è§£é‡Šå™¨å¿½ç•¥</li></ul></blockquote><hr><p>åœ¨ k8s ä¸­ï¼Œä¸€èˆ¬ä½¿ç”¨ YAML æ ¼å¼çš„æ–‡ä»¶æ¥åˆ›å»ºç¬¦åˆæˆ‘ä»¬é¢„æœŸæœŸæœ›çš„ pod,è¿™æ ·çš„ YAML æ–‡ä»¶ç§°ä¸º<strong>èµ„æºæ¸…å•</strong></p><h2 id="å¸¸ç”¨å­—æ®µ"><a href="#å¸¸ç”¨å­—æ®µ" class="headerlink" title="å¸¸ç”¨å­—æ®µ"></a>å¸¸ç”¨å­—æ®µ</h2><p><font color="red"><strong>å¿…é¡»å­˜åœ¨çš„å±æ€§</strong></font></p><table><thead><tr><th>å‚æ•°å</th><th>å­—æ®µç±»å‹</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>version</td><td>String</td><td>k8sçš„APIç‰ˆæœ¬ï¼Œé€šè¿‡<code>kubectl api-version</code>æŸ¥è¯¢</td></tr><tr><td>kind</td><td>String</td><td>æ–‡ä»¶å®šä¹‰çš„èµ„æºç±»å‹å’Œè§’è‰²ï¼Œæ¯”å¦‚ï¼šPod</td></tr><tr><td>metadata</td><td>Object</td><td>å…ƒæ•°æ®å¯¹è±¡ï¼Œå›ºå®šå€¼ä¸º<code>metadata</code></td></tr><tr><td>metadata.name</td><td>String</td><td>å…ƒæ•°æ®å¯¹è±¡çš„åå­—ï¼Œæœ‰æˆ‘ä»¬ç¼–å†™ï¼Œæ¯”å¦‚å‘½åPodçš„åå­—</td></tr><tr><td>metadata.namespace</td><td>String</td><td>å…ƒæ•°æ®å¯¹è±¡çš„å‘½åç©ºé—´ï¼Œè‡ªå®šä¹‰</td></tr><tr><td>Spec</td><td>Object</td><td>è¯¦ç»†å®šä¹‰å¯¹è±¡ï¼Œå›ºå®šå€¼å†™Spec</td></tr><tr><td>spec.container[]</td><td>list</td><td>å®¹å™¨åˆ—è¡¨å®šä¹‰ï¼Œå¤šä¸ªå®¹å™¨</td></tr><tr><td>spec.container[].name</td><td>String</td><td>å®¹å™¨å</td></tr><tr><td>spec.container[].image</td><td>String</td><td>å®¹å™¨ä½¿ç”¨çš„é•œåƒ</td></tr></tbody></table><p><strong>åˆ›å»ºNameSpace</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test</span></span><br></pre></td></tr></table></figure><p><strong>åˆ›å»ºPod</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-containers</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br></pre></td></tr></table></figure><h2 id="å¿«é€Ÿç¼–å†™yamlğŸ”º"><a href="#å¿«é€Ÿç¼–å†™yamlğŸ”º" class="headerlink" title="å¿«é€Ÿç¼–å†™yamlğŸ”º"></a>å¿«é€Ÿç¼–å†™yamlğŸ”º</h2><h3 id="ä»å¯åŠ¨èµ„æºå‘½ä»¤ä¸­å¯¼å‡ºyaml"><a href="#ä»å¯åŠ¨èµ„æºå‘½ä»¤ä¸­å¯¼å‡ºyaml" class="headerlink" title="ä»å¯åŠ¨èµ„æºå‘½ä»¤ä¸­å¯¼å‡ºyaml"></a>ä»å¯åŠ¨èµ„æºå‘½ä»¤ä¸­å¯¼å‡ºyaml</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create deployment web --image=nginx -o yaml --dry-run &gt; xxx.yaml</span><br></pre></td></tr></table></figure><blockquote><p>å¦‚æœä¸å†™<code>--dry-run</code>ï¼ŒPodçœŸä¼šè¿è¡Œã€‚å†™äº†åˆ™ä¸ä¼šè¿è¡Œï¼Œåªæ˜¯å¯¼å‡ºæ¨¡æ¿</p></blockquote><h3 id="ä»æ­£åœ¨è¿è¡Œçš„èµ„æºä¸­å¯¼å‡ºyaml"><a href="#ä»æ­£åœ¨è¿è¡Œçš„èµ„æºä¸­å¯¼å‡ºyaml" class="headerlink" title="ä»æ­£åœ¨è¿è¡Œçš„èµ„æºä¸­å¯¼å‡ºyaml"></a>ä»æ­£åœ¨è¿è¡Œçš„èµ„æºä¸­å¯¼å‡ºyaml</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get deploy xxx -o=yaml --<span class="built_in">export</span> &gt; xxx.yaml</span><br></pre></td></tr></table></figure><blockquote><p>æ­¤æ–¹å¼å¯¼å‡ºçš„yamlä¼šå¾ˆè¯¦ç»†ï¼Œå› ä¸ºæ˜¯å·²ç»éƒ¨ç½²å¥½çš„ç‰ˆæœ¬çš„yaml</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Kubernetes&quot;&gt;&lt;a href=&quot;#Kubernetes&quot; class=&quot;headerlink&quot; title=&quot;Kubernetes&quot;&gt;&lt;/a&gt;Kubernetes&lt;/h1&gt;&lt;h2 id=&quot;Kubernetesæ¦‚è¿°&quot;&gt;&lt;a href=&quot;#Kubernete</summary>
      
    
    
    
    <category term="Kubernetes" scheme="https://awslzhang.top/categories/Kubernetes/"/>
    
    
    <category term="Docker" scheme="https://awslzhang.top/tags/Docker/"/>
    
    <category term="Kubernetes" scheme="https://awslzhang.top/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Compose</title>
    <link href="https://awslzhang.top/2020/11/14/Compose/"/>
    <id>https://awslzhang.top/2020/11/14/Compose/</id>
    <published>2020-11-14T15:27:41.000Z</published>
    <updated>2021-01-01T05:49:59.916Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h1><p><code>Compose</code> é¡¹ç›®æ˜¯ <strong>Docker å®˜æ–¹çš„å¼€æºé¡¹ç›®</strong>ï¼Œè´Ÿè´£å®ç°<font color="red">å¯¹Docker å®¹å™¨é›†ç¾¤çš„å¿«é€Ÿç¼–æ’</font>ï¼Œéœ€è¦é¢å¤–å®‰è£…ã€‚ä»åŠŸèƒ½ä¸Šçœ‹ï¼Œè·Ÿ <code>OpenStack</code> ä¸­çš„ <code>Heat</code> ååˆ†ç±»ä¼¼ã€‚</p><p>å…¶ä»£ç ç›®å‰åœ¨ <a href="https://github.com/docker/compose">https://github.com/docker/compose</a> ä¸Šå¼€æºã€‚</p><p><code>Compose</code> å®šä½æ˜¯ ã€Œå®šä¹‰å’Œè¿è¡Œå¤šä¸ª Docker å®¹å™¨çš„åº”ç”¨ï¼ˆDefining and running multi-container Docker applicationsï¼‰ã€ï¼Œå…¶å‰èº«æ˜¯å¼€æºé¡¹ç›® Figã€‚</p><blockquote><p>å®˜æ–¹ä»‹ç»ï¼š</p><p>Compose is a tool for defining and running multi-container Docker applications. With Compose, you use a YAML file to configure your applicationâ€™s services. Then, with a single command, you create and start all the services from your configuration. To learn more about all the features of Compose, see <a href="https://docs.docker.com/compose/#features">the list of features</a>.</p><p>Compose works in all environments: production, staging, development, testing, as well as CI workflows. You can learn more about each case in <a href="https://docs.docker.com/compose/#common-use-cases">Common Use Cases</a>.</p><p>Using Compose is basically a three-step process:</p><ol><li>Define your appâ€™s environment with a <code>Dockerfile</code> so it can be reproduced anywhere.</li><li>Define the services that make up your app in <code>docker-compose.yml</code> so they can be run together in an isolated environment.</li><li>Run <code>docker-compose up</code> and Compose starts and runs your entire app.</li></ol><p>ç¿»è¯‘ï¼š</p><p>Composeæ˜¯ç”¨äºå®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨Dockeråº”ç”¨ç¨‹åºçš„å·¥å…·ã€‚é€šè¿‡Composeï¼Œæ‚¨å¯ä»¥<font color="red">ä½¿ç”¨YAMLæ–‡ä»¶æ¥é…ç½®åº”ç”¨ç¨‹åºçš„æœåŠ¡</font>ã€‚ç„¶åï¼Œä½¿ç”¨ä¸€ä¸ªå‘½ä»¤ï¼Œå°±å¯ä»¥<font color="red">ä»é…ç½®ä¸­åˆ›å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡</font>ã€‚è¦äº†è§£æœ‰å…³Composeçš„æ‰€æœ‰åŠŸèƒ½çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…<a href="https://docs.docker.com/compose/#features">åŠŸèƒ½åˆ—è¡¨</a>ã€‚</p><p>Composeå¯åœ¨æ‰€æœ‰ç¯å¢ƒä¸­å·¥ä½œï¼šç”Ÿäº§ï¼Œç™»å°ï¼Œå¼€å‘ï¼Œæµ‹è¯•ä»¥åŠCIå·¥ä½œæµã€‚æ‚¨å¯ä»¥åœ¨â€œ<a href="https://docs.docker.com/compose/#common-use-cases">å¸¸è§ç”¨ä¾‹â€ä¸­</a>äº†è§£æœ‰å…³æ¯ç§æƒ…å†µçš„æ›´å¤šä¿¡æ¯ã€‚</p><p><strong>ä½¿ç”¨ComposeåŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªä¸‰æ­¥è¿‡ç¨‹</strong>ï¼š</p><ol><li>ä½¿ç”¨å®šä¹‰æ‚¨çš„åº”ç”¨ç¯å¢ƒï¼Œ<font color="red"><code>Dockerfile</code></font>ä»¥ä¾¿å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹å¤åˆ¶ã€‚</li><li>å®šä¹‰ç»„æˆåº”ç”¨ç¨‹åºçš„æœåŠ¡ï¼Œ<font color="red"><code>docker-compose.yml</code></font> ä»¥ä¾¿å®ƒä»¬å¯ä»¥åœ¨éš”ç¦»çš„ç¯å¢ƒä¸­ä¸€èµ·è¿è¡Œã€‚<ol><li>é…ç½®æ–‡ä»¶ä¸­é…ç½®å¤šä¸ªæœåŠ¡(<code>Services</code>)</li></ol></li><li>Run <font color="red"><code>docker-compose up</code></font>and Composeå¯åŠ¨å¹¶è¿è¡Œæ‚¨çš„æ•´ä¸ªåº”ç”¨ç¨‹åºã€‚</li></ol></blockquote><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>æˆ‘ä»¬çŸ¥é“ä½¿ç”¨ä¸€ä¸ª <code>Dockerfile</code> æ¨¡æ¿æ–‡ä»¶ï¼Œå¯ä»¥è®©ç”¨æˆ·å¾ˆæ–¹ä¾¿çš„å®šä¹‰ä¸€ä¸ªå•ç‹¬çš„åº”ç”¨å®¹å™¨ã€‚ç„¶è€Œï¼Œåœ¨æ—¥å¸¸å·¥ä½œä¸­ï¼Œç»å¸¸ä¼šç¢°åˆ°éœ€è¦å¤šä¸ªå®¹å™¨ç›¸äº’é…åˆæ¥å®ŒæˆæŸé¡¹ä»»åŠ¡çš„æƒ…å†µã€‚ä¾‹å¦‚è¦å®ç°ä¸€ä¸ª Web é¡¹ç›®ï¼Œé™¤äº† Web æœåŠ¡å®¹å™¨æœ¬èº«ï¼Œå¾€å¾€è¿˜éœ€è¦å†åŠ ä¸Šåç«¯çš„æ•°æ®åº“æœåŠ¡å®¹å™¨ï¼Œç”šè‡³è¿˜åŒ…æ‹¬è´Ÿè½½å‡è¡¡å®¹å™¨ç­‰ã€‚</p><p><code>Compose</code> æ°å¥½æ»¡è¶³äº†è¿™æ ·çš„éœ€æ±‚ã€‚å®ƒå…è®¸ç”¨æˆ·é€šè¿‡ä¸€ä¸ªå•ç‹¬çš„ <code>docker-compose.yml</code> æ¨¡æ¿æ–‡ä»¶ï¼ˆYAML æ ¼å¼ï¼‰æ¥å®šä¹‰ä¸€ç»„ç›¸å…³è”çš„åº”ç”¨å®¹å™¨ä¸ºä¸€ä¸ªé¡¹ç›®ï¼ˆprojectï¼‰ã€‚</p><p><code>Compose</code> ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼š</p><ul><li>æœåŠ¡ (<code>service</code>)ï¼šä¸€ä¸ªåº”ç”¨çš„å®¹å™¨ï¼Œå®é™…ä¸Šå¯ä»¥åŒ…æ‹¬è‹¥å¹²è¿è¡Œç›¸åŒé•œåƒçš„å®¹å™¨å®ä¾‹ã€‚</li><li>é¡¹ç›® (<code>project</code>)ï¼šç”±ä¸€ç»„å…³è”çš„åº”ç”¨å®¹å™¨ç»„æˆçš„ä¸€ä¸ªå®Œæ•´ä¸šåŠ¡å•å…ƒï¼Œåœ¨ <code>docker-compose.yml</code> æ–‡ä»¶ä¸­å®šä¹‰ã€‚</li></ul><p><code>Compose</code> çš„é»˜è®¤ç®¡ç†å¯¹è±¡æ˜¯é¡¹ç›®ï¼Œé€šè¿‡å­å‘½ä»¤å¯¹é¡¹ç›®ä¸­çš„ä¸€ç»„å®¹å™¨è¿›è¡Œä¾¿æ·åœ°ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚</p><p><code>Compose</code> é¡¹ç›®ç”± Python ç¼–å†™ï¼Œå®ç°ä¸Šè°ƒç”¨äº† Docker æœåŠ¡æä¾›çš„ API æ¥å¯¹å®¹å™¨è¿›è¡Œç®¡ç†ã€‚å› æ­¤ï¼Œåªè¦æ‰€æ“ä½œçš„å¹³å°æ”¯æŒ Docker APIï¼Œå°±å¯ä»¥åœ¨å…¶ä¸Šåˆ©ç”¨ <code>Compose</code> æ¥è¿›è¡Œç¼–æ’ç®¡ç†ã€‚</p><p>ä½¿ç”¨<code>DockerCompose</code>å¯ä»¥ç®€åŒ–æˆ‘ä»¬çš„æ“ä½œï¼Œä¾‹å¦‚ï¼š</p><p>ä¸€ä¸ª<code>docker-compose.yml</code>çœ‹èµ·æ¥åƒè¿™æ ·ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;5000:5000&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">.:/code</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">logvolume01:/var/log</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">logvolume01:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>åŒæ—¶éƒ¨ç½²äº†<code>web</code>å’Œ<code>redis</code>æœåŠ¡ï¼</p><blockquote><p>å®é™…ç”Ÿäº§ç¯å¢ƒä¸ä¼šç›´æ¥é‡‡ç”¨dockerçš„ï¼Œéœ€è¦é‡‡ç”¨docker-composeï¼›å¦‚æœæ˜¯åˆ†å¸ƒå¼å¤šå°æœåŠ¡å™¨å¯èƒ½éœ€è¦k8sã€‚</p></blockquote><h2 id="å®‰è£…ä¸å¸è½½"><a href="#å®‰è£…ä¸å¸è½½" class="headerlink" title="å®‰è£…ä¸å¸è½½"></a>å®‰è£…ä¸å¸è½½</h2><p><code>Compose</code> æ”¯æŒ Linuxã€macOSã€Windows 10 ä¸‰å¤§å¹³å°ã€‚</p><p><code>Compose</code> å¯ä»¥é€šè¿‡ Python çš„åŒ…ç®¡ç†å·¥å…· <code>pip</code> è¿›è¡Œå®‰è£…ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä¸‹è½½ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ä½¿ç”¨ï¼Œç”šè‡³èƒ½å¤Ÿç›´æ¥åœ¨ Docker å®¹å™¨ä¸­è¿è¡Œã€‚</p><p><code>Docker Desktop for Mac/Windows</code> è‡ªå¸¦ <code>docker-compose</code> äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå®‰è£… Docker ä¹‹åå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚</p><p><strong>éªŒè¯å®‰è£…</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose version</span><br><span class="line">docker-compose version 1.25.5, build 8a1c60f6</span><br><span class="line">docker-py version: 4.1.0</span><br><span class="line">CPython version: 3.7.5</span><br><span class="line">OpenSSL version: OpenSSL 1.1.0l  10 Sep 2019</span><br></pre></td></tr></table></figure><h3 id="äºŒè¿›åˆ¶åŒ…å®‰è£…"><a href="#äºŒè¿›åˆ¶åŒ…å®‰è£…" class="headerlink" title="äºŒè¿›åˆ¶åŒ…å®‰è£…"></a>äºŒè¿›åˆ¶åŒ…å®‰è£…</h3><p>åœ¨ Linux ä¸Šçš„ä¹Ÿå®‰è£…ååˆ†ç®€å•ï¼Œä» <a href="https://github.com/docker/compose/releases">å®˜æ–¹ GitHub Release</a> å¤„ç›´æ¥ä¸‹è½½ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶å³å¯ã€‚</p><p>ä¾‹å¦‚ï¼Œåœ¨ Linux 64 ä½ç³»ç»Ÿä¸Šç›´æ¥ä¸‹è½½å¯¹åº”çš„äºŒè¿›åˆ¶åŒ…ã€‚</p><ol><li>ä¸‹è½½äºŒè¿›åˆ¶åŒ…</li><li>èµ‹äºˆäºŒè¿›åˆ¶åŒ…çš„æ‰§è¡Œæƒé™</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo curl -L https://github.com/docker/compose/releases/download/1.25.5/docker-compose-`uname -s`-`uname -m` &gt; /usr/<span class="built_in">local</span>/bin/docker-compose</span><br><span class="line"></span><br><span class="line">$ sudo chmod +x /usr/<span class="built_in">local</span>/bin/docker-compose</span><br></pre></td></tr></table></figure><h3 id="PIPå®‰è£…"><a href="#PIPå®‰è£…" class="headerlink" title="PIPå®‰è£…"></a>PIPå®‰è£…</h3><blockquote><p><em>æ³¨ï¼š</em> <code>x86_64</code> æ¶æ„çš„ Linux å»ºè®®æŒ‰ç…§ä¸Šè¾¹çš„æ–¹æ³•ä¸‹è½½äºŒè¿›åˆ¶åŒ…è¿›è¡Œå®‰è£…ï¼Œå¦‚æœæ‚¨è®¡ç®—æœºçš„æ¶æ„æ˜¯ <code>ARM</code> (ä¾‹å¦‚ï¼Œæ ‘è“æ´¾)ï¼Œå†ä½¿ç”¨ <code>pip</code> å®‰è£…ã€‚</p></blockquote><blockquote><p>æ—¢ç„¶è¯´åˆ°æ¶æ„ï¼Œè¿™é‡Œæ™®åŠä¸€ä¸‹ï¼š</p><ul><li><code>X86</code>æ˜¯Intelå¼€å‘çš„ä¸€ç§32ä½æŒ‡ä»¤é›†ï¼Œæ—©æœŸIntelå’Œamdçš„cpuéƒ½æ”¯æŒè¿™ç§æŒ‡ä»¤é›†</li><li><code>amd64</code>æ˜¯CPUè¿ˆå‘64ä½çš„æ—¶å€™ï¼Œç”±ADMç‡å…ˆåˆ¶é€ å‡ºäº†å…¼å®¹X86çš„CPUï¼ŒAMDç§°ä¹‹ä¸ºamd64</li><li><code>x64</code>ï¼šå½“æ—¶å› ä¸ºå…¼å®¹x86çš„CPUæ¶æ„è¢«amdç‡å…ˆå¼€å‘ï¼Œæ‰€ä»¥intelé€‰æ‹©äº†è®¾è®¡ä¸€ç§å…¨æ–°çš„æŒ‡ä»¤é›†x64ï¼Œä½†æ˜¯å¥½åƒè¢«å‘äº†ï¼Œåæ¥åœ¨ä¸å¾—ä¸åœ¨æ—¶æœºè½åçš„æƒ…å†µä¸‹ä¹Ÿå¼€å§‹æ”¯æŒäº†amd64æŒ‡ä»¤é›†ï¼Œä½†æ˜¯æ¢äº†ä¸ªåå­—å«<code>X86_64</code>ï¼›</li><li><code>arm</code>ï¼šè¿‡å»ç§°ä½œ<strong>é«˜çº§ç²¾ç®€æŒ‡ä»¤é›†æœºå™¨</strong>ï¼ŒARMå¤„ç†å™¨éå¸¸é€‚ç”¨äº<a href="https://zh.wikipedia.org/wiki/%E8%A1%8C%E5%8B%95%E9%80%9A%E8%A8%8A">ç§»åŠ¨é€šä¿¡</a>é¢†åŸŸï¼Œç¬¦åˆå…¶ä¸»è¦è®¾è®¡ç›®æ ‡ä¸ºä½æˆæœ¬ã€é«˜æ€§èƒ½ã€ä½è€—ç”µçš„ç‰¹æ€§ã€‚æ‰€ä»¥å¸¸ç”¨äºæ‰‹æœºï¼Œæ½œå…¥è®¾å¤‡(æ ‘è“æ´¾)ã€‚</li></ul><p>æ‰€ä»¥ï¼Œ<code>amd64</code>ã€<code>x64</code>ã€<code>X86_64</code>æ˜¯ä¸€ç§ä¸œè¥¿ã€‚</p></blockquote><p>è¿™ç§æ–¹å¼æ˜¯å°† Compose å½“ä½œä¸€ä¸ª Python åº”ç”¨æ¥ä» pip æºä¸­å®‰è£…ã€‚</p><p>æ‰§è¡Œå®‰è£…å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo pip install -U docker-compose</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹è¾“å‡ºï¼Œè¯´æ˜å®‰è£…æˆåŠŸã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Collecting docker-compose</span><br><span class="line">  Downloading docker-compose-1.25.5.tar.gz (149kB): 149kB downloaded</span><br><span class="line">...</span><br><span class="line">Successfully installed docker-compose cached-property requests texttable websocket-client docker-py dockerpty six enum34 backports.ssl-match-hostname ipaddress</span><br></pre></td></tr></table></figure><h3 id="å¸è½½"><a href="#å¸è½½" class="headerlink" title="å¸è½½"></a>å¸è½½</h3><p>å¦‚æœæ˜¯äºŒè¿›åˆ¶åŒ…æ–¹å¼å®‰è£…çš„ï¼Œåˆ é™¤äºŒè¿›åˆ¶æ–‡ä»¶å³å¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo rm /usr/<span class="built_in">local</span>/bin/docker-compose</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯é€šè¿‡ <code>pip</code> å®‰è£…çš„ï¼Œåˆ™æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å³å¯åˆ é™¤ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo pip uninstall docker-compose</span><br></pre></td></tr></table></figure><h2 id="å‘½ä»¤è¯´æ˜"><a href="#å‘½ä»¤è¯´æ˜" class="headerlink" title="å‘½ä»¤è¯´æ˜"></a>å‘½ä»¤è¯´æ˜</h2><h3 id="å‘½ä»¤å¯¹è±¡ä¸æ ¼å¼"><a href="#å‘½ä»¤å¯¹è±¡ä¸æ ¼å¼" class="headerlink" title="å‘½ä»¤å¯¹è±¡ä¸æ ¼å¼"></a>å‘½ä»¤å¯¹è±¡ä¸æ ¼å¼</h3><p>å¯¹äº Compose æ¥è¯´ï¼Œå¤§éƒ¨åˆ†å‘½ä»¤çš„å¯¹è±¡æ—¢å¯ä»¥æ˜¯é¡¹ç›®æœ¬èº«ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šä¸ºé¡¹ç›®ä¸­çš„æœåŠ¡æˆ–è€…å®¹å™¨ã€‚å¦‚æœæ²¡æœ‰ç‰¹åˆ«çš„è¯´æ˜ï¼Œå‘½ä»¤å¯¹è±¡å°†æ˜¯é¡¹ç›®ï¼Œè¿™æ„å‘³ç€é¡¹ç›®ä¸­æ‰€æœ‰çš„æœåŠ¡éƒ½ä¼šå—åˆ°å‘½ä»¤å½±å“ã€‚</p><p>æ‰§è¡Œ <code>docker-compose [COMMAND] --help</code> æˆ–è€… <code>docker-compose help [COMMAND]</code> å¯ä»¥æŸ¥çœ‹å…·ä½“æŸä¸ªå‘½ä»¤çš„ä½¿ç”¨æ ¼å¼ã€‚</p><p><code>docker-compose</code> å‘½ä»¤çš„åŸºæœ¬çš„ä½¿ç”¨æ ¼å¼æ˜¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose [-f&#x3D;&lt;arg&gt;...] [options] [COMMAND] [ARGS...]</span><br></pre></td></tr></table></figure><h3 id="å‘½ä»¤é€‰é¡¹"><a href="#å‘½ä»¤é€‰é¡¹" class="headerlink" title="å‘½ä»¤é€‰é¡¹"></a>å‘½ä»¤é€‰é¡¹</h3><ul><li><code>-f, --file FILE</code> æŒ‡å®šä½¿ç”¨çš„ Compose æ¨¡æ¿æ–‡ä»¶ï¼Œé»˜è®¤ä¸º <code>docker-compose.yml</code>ï¼Œå¯ä»¥å¤šæ¬¡æŒ‡å®šã€‚</li><li><code>-p, --project-name NAME</code> æŒ‡å®šé¡¹ç›®åç§°ï¼Œé»˜è®¤å°†ä½¿ç”¨æ‰€åœ¨ç›®å½•åç§°ä½œä¸ºé¡¹ç›®åã€‚</li><li><code>--verbose</code> è¾“å‡ºæ›´å¤šè°ƒè¯•ä¿¡æ¯ã€‚</li><li><code>-v, --version</code> æ‰“å°ç‰ˆæœ¬å¹¶é€€å‡ºã€‚</li></ul><h3 id="å‘½ä»¤ä½¿ç”¨è¯´æ˜"><a href="#å‘½ä»¤ä½¿ç”¨è¯´æ˜" class="headerlink" title="å‘½ä»¤ä½¿ç”¨è¯´æ˜"></a>å‘½ä»¤ä½¿ç”¨è¯´æ˜</h3><h4 id="build"><a href="#build" class="headerlink" title="build"></a><code>build</code></h4><p>æ ¼å¼ä¸º <code>docker-compose build [options] [SERVICE...]</code>ã€‚</p><p>æ„å»ºï¼ˆé‡æ–°æ„å»ºï¼‰é¡¹ç›®ä¸­çš„æœåŠ¡å®¹å™¨ã€‚</p><p>æœåŠ¡å®¹å™¨ä¸€æ—¦æ„å»ºåï¼Œå°†ä¼šå¸¦ä¸Šä¸€ä¸ªæ ‡è®°åï¼Œä¾‹å¦‚å¯¹äº web é¡¹ç›®ä¸­çš„ä¸€ä¸ª db å®¹å™¨ï¼Œå¯èƒ½æ˜¯ web_dbã€‚</p><p>å¯ä»¥éšæ—¶åœ¨é¡¹ç›®ç›®å½•ä¸‹è¿è¡Œ <code>docker-compose build</code> æ¥é‡æ–°æ„å»ºæœåŠ¡ã€‚</p><p>é€‰é¡¹åŒ…æ‹¬ï¼š</p><ul><li><code>--force-rm</code> åˆ é™¤æ„å»ºè¿‡ç¨‹ä¸­çš„ä¸´æ—¶å®¹å™¨ã€‚</li><li><code>--no-cache</code> æ„å»ºé•œåƒè¿‡ç¨‹ä¸­ä¸ä½¿ç”¨ cacheï¼ˆè¿™å°†åŠ é•¿æ„å»ºè¿‡ç¨‹ï¼‰ã€‚</li><li><code>--pull</code> å§‹ç»ˆå°è¯•é€šè¿‡ pull æ¥è·å–æ›´æ–°ç‰ˆæœ¬çš„é•œåƒã€‚</li></ul><h4 id="config"><a href="#config" class="headerlink" title="config"></a><code>config</code></h4><p>éªŒè¯ Compose æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œè‹¥æ­£ç¡®åˆ™æ˜¾ç¤ºé…ç½®ï¼Œè‹¥æ ¼å¼é”™è¯¯æ˜¾ç¤ºé”™è¯¯åŸå› ã€‚</p><h4 id="down"><a href="#down" class="headerlink" title="down"></a><code>down</code></h4><p>æ­¤å‘½ä»¤å°†ä¼šåœæ­¢ <code>up</code> å‘½ä»¤æ‰€å¯åŠ¨çš„å®¹å™¨ï¼Œå¹¶ç§»é™¤ç½‘ç»œ</p><h4 id="exec"><a href="#exec" class="headerlink" title="exec"></a><code>exec</code></h4><p>è¿›å…¥æŒ‡å®šçš„å®¹å™¨ã€‚</p><h4 id="help"><a href="#help" class="headerlink" title="help"></a><code>help</code></h4><p>è·å¾—ä¸€ä¸ªå‘½ä»¤çš„å¸®åŠ©ã€‚</p><h4 id="images"><a href="#images" class="headerlink" title="images"></a><code>images</code></h4><p>åˆ—å‡º Compose æ–‡ä»¶ä¸­åŒ…å«çš„é•œåƒã€‚</p><h4 id="logs"><a href="#logs" class="headerlink" title="logs"></a><code>logs</code></h4><p>æ ¼å¼ä¸º <code>docker-compose logs [options] [SERVICE...]</code>ã€‚</p><p>æŸ¥çœ‹æœåŠ¡å®¹å™¨çš„è¾“å‡ºã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œdocker-compose å°†å¯¹ä¸åŒçš„æœåŠ¡è¾“å‡ºä½¿ç”¨ä¸åŒçš„é¢œè‰²æ¥åŒºåˆ†ã€‚å¯ä»¥é€šè¿‡ <code>--no-color</code> æ¥å…³é—­é¢œè‰²ã€‚</p><p>è¯¥å‘½ä»¤åœ¨è°ƒè¯•é—®é¢˜çš„æ—¶å€™ååˆ†æœ‰ç”¨ã€‚</p><h4 id="ps"><a href="#ps" class="headerlink" title="ps"></a><code>ps</code></h4><p>æ ¼å¼ä¸º <code>docker-compose ps [options] [SERVICE...]</code>ã€‚</p><p>åˆ—å‡ºé¡¹ç›®ä¸­ç›®å‰çš„æ‰€æœ‰å®¹å™¨ã€‚</p><p>é€‰é¡¹ï¼š</p><ul><li><code>-q</code> åªæ‰“å°å®¹å™¨çš„ ID ä¿¡æ¯ã€‚</li></ul><h4 id="restart"><a href="#restart" class="headerlink" title="restart"></a><code>restart</code></h4><p>æ ¼å¼ä¸º <code>docker-compose restart [options] [SERVICE...]</code>ã€‚</p><p>é‡å¯é¡¹ç›®ä¸­çš„æœåŠ¡ã€‚</p><p>é€‰é¡¹ï¼š</p><ul><li><code>-t, --timeout TIMEOUT</code> æŒ‡å®šé‡å¯å‰åœæ­¢å®¹å™¨çš„è¶…æ—¶ï¼ˆé»˜è®¤ä¸º 10 ç§’ï¼‰ã€‚</li></ul><h4 id="rm"><a href="#rm" class="headerlink" title="rm"></a><code>rm</code></h4><p>æ ¼å¼ä¸º <code>docker-compose rm [options] [SERVICE...]</code>ã€‚</p><p>åˆ é™¤æ‰€æœ‰ï¼ˆåœæ­¢çŠ¶æ€çš„ï¼‰æœåŠ¡å®¹å™¨ã€‚æ¨èå…ˆæ‰§è¡Œ <code>docker-compose stop</code> å‘½ä»¤æ¥åœæ­¢å®¹å™¨ã€‚</p><p>é€‰é¡¹ï¼š</p><ul><li><code>-f, --force</code> å¼ºåˆ¶ç›´æ¥åˆ é™¤ï¼ŒåŒ…æ‹¬éåœæ­¢çŠ¶æ€çš„å®¹å™¨ã€‚ä¸€èˆ¬å°½é‡ä¸è¦ä½¿ç”¨è¯¥é€‰é¡¹ã€‚</li><li><code>-v</code> åˆ é™¤å®¹å™¨æ‰€æŒ‚è½½çš„æ•°æ®å·ã€‚</li></ul><h4 id="start"><a href="#start" class="headerlink" title="start"></a><code>start</code></h4><p>æ ¼å¼ä¸º <code>docker-compose start [SERVICE...]</code>ã€‚</p><p>å¯åŠ¨å·²ç»å­˜åœ¨çš„æœåŠ¡å®¹å™¨ã€‚</p><h4 id="stop"><a href="#stop" class="headerlink" title="stop"></a><code>stop</code></h4><p>æ ¼å¼ä¸º <code>docker-compose stop [options] [SERVICE...]</code>ã€‚</p><p>åœæ­¢å·²ç»å¤„äºè¿è¡ŒçŠ¶æ€çš„å®¹å™¨ï¼Œä½†ä¸åˆ é™¤å®ƒã€‚é€šè¿‡ <code>docker-compose start</code> å¯ä»¥å†æ¬¡å¯åŠ¨è¿™äº›å®¹å™¨ã€‚</p><p>é€‰é¡¹ï¼š</p><ul><li><code>-t, --timeout TIMEOUT</code> åœæ­¢å®¹å™¨æ—¶å€™çš„è¶…æ—¶ï¼ˆé»˜è®¤ä¸º 10 ç§’ï¼‰ã€‚</li></ul><h4 id="top"><a href="#top" class="headerlink" title="top"></a><code>top</code></h4><p>æŸ¥çœ‹å„ä¸ªæœåŠ¡å®¹å™¨å†…è¿è¡Œçš„è¿›ç¨‹ã€‚</p><h4 id="upğŸ”º"><a href="#upğŸ”º" class="headerlink" title="upğŸ”º"></a><code>up</code>ğŸ”º</h4><p>æ ¼å¼ä¸º <code>docker-compose up [options] [SERVICE...]</code>ã€‚</p><p>è¯¥å‘½ä»¤ååˆ†å¼ºå¤§ï¼Œå®ƒå°†å°è¯•è‡ªåŠ¨å®ŒæˆåŒ…æ‹¬æ„å»ºé•œåƒï¼Œï¼ˆé‡æ–°ï¼‰åˆ›å»ºæœåŠ¡ï¼Œå¯åŠ¨æœåŠ¡ï¼Œå¹¶å…³è”æœåŠ¡ç›¸å…³å®¹å™¨çš„ä¸€ç³»åˆ—æ“ä½œã€‚</p><p>é“¾æ¥çš„æœåŠ¡éƒ½å°†ä¼šè¢«è‡ªåŠ¨å¯åŠ¨ï¼Œé™¤éå·²ç»å¤„äºè¿è¡ŒçŠ¶æ€ã€‚</p><p>å¯ä»¥è¯´ï¼Œå¤§éƒ¨åˆ†æ—¶å€™éƒ½å¯ä»¥ç›´æ¥é€šè¿‡è¯¥å‘½ä»¤æ¥å¯åŠ¨ä¸€ä¸ªé¡¹ç›®ã€‚</p><p>é»˜è®¤æƒ…å†µï¼Œ<code>docker-compose up</code> å¯åŠ¨çš„å®¹å™¨éƒ½åœ¨å‰å°ï¼Œæ§åˆ¶å°å°†ä¼šåŒæ—¶æ‰“å°æ‰€æœ‰å®¹å™¨çš„è¾“å‡ºä¿¡æ¯ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿è¿›è¡Œè°ƒè¯•ã€‚</p><p>å½“é€šè¿‡ <code>Ctrl-C</code> åœæ­¢å‘½ä»¤æ—¶ï¼Œæ‰€æœ‰å®¹å™¨å°†ä¼šåœæ­¢ã€‚</p><p>å¦‚æœä½¿ç”¨ <code>docker-compose up -d</code>ï¼Œå°†ä¼šåœ¨åå°å¯åŠ¨å¹¶è¿è¡Œæ‰€æœ‰çš„å®¹å™¨ã€‚ä¸€èˆ¬æ¨èç”Ÿäº§ç¯å¢ƒä¸‹ä½¿ç”¨è¯¥é€‰é¡¹ã€‚</p><p>é»˜è®¤æƒ…å†µï¼Œå¦‚æœæœåŠ¡å®¹å™¨å·²ç»å­˜åœ¨ï¼Œ<code>docker-compose up</code> å°†ä¼šå°è¯•åœæ­¢å®¹å™¨ï¼Œç„¶åé‡æ–°åˆ›å»ºï¼ˆä¿æŒä½¿ç”¨ <code>volumes-from</code> æŒ‚è½½çš„å·ï¼‰ï¼Œä»¥ä¿è¯æ–°å¯åŠ¨çš„æœåŠ¡åŒ¹é… <code>docker-compose.yml</code> æ–‡ä»¶çš„æœ€æ–°å†…å®¹ã€‚å¦‚æœç”¨æˆ·ä¸å¸Œæœ›å®¹å™¨è¢«åœæ­¢å¹¶é‡æ–°åˆ›å»ºï¼Œå¯ä»¥ä½¿ç”¨ <code>docker-compose up --no-recreate</code>ã€‚è¿™æ ·å°†åªä¼šå¯åŠ¨å¤„äºåœæ­¢çŠ¶æ€çš„å®¹å™¨ï¼Œè€Œå¿½ç•¥å·²ç»è¿è¡Œçš„æœåŠ¡ã€‚å¦‚æœç”¨æˆ·åªæƒ³é‡æ–°éƒ¨ç½²æŸä¸ªæœåŠ¡ï¼Œå¯ä»¥ä½¿ç”¨ <code>docker-compose up --no-deps -d &lt;SERVICE_NAME&gt;</code> æ¥é‡æ–°åˆ›å»ºæœåŠ¡å¹¶åå°åœæ­¢æ—§æœåŠ¡ï¼Œå¯åŠ¨æ–°æœåŠ¡ï¼Œå¹¶ä¸ä¼šå½±å“åˆ°å…¶æ‰€ä¾èµ–çš„æœåŠ¡ã€‚</p><p>é€‰é¡¹ï¼š</p><ul><li><code>-d</code> åœ¨åå°è¿è¡ŒæœåŠ¡å®¹å™¨ã€‚</li><li><code>--no-color</code> ä¸ä½¿ç”¨é¢œè‰²æ¥åŒºåˆ†ä¸åŒçš„æœåŠ¡çš„æ§åˆ¶å°è¾“å‡ºã€‚</li><li><code>--no-deps</code> ä¸å¯åŠ¨æœåŠ¡æ‰€é“¾æ¥çš„å®¹å™¨ã€‚</li><li><code>--force-recreate</code> å¼ºåˆ¶é‡æ–°åˆ›å»ºå®¹å™¨ï¼Œä¸èƒ½ä¸ <code>--no-recreate</code> åŒæ—¶ä½¿ç”¨ã€‚</li><li><code>--no-recreate</code> å¦‚æœå®¹å™¨å·²ç»å­˜åœ¨äº†ï¼Œåˆ™ä¸é‡æ–°åˆ›å»ºï¼Œä¸èƒ½ä¸ <code>--force-recreate</code> åŒæ—¶ä½¿ç”¨ã€‚</li><li><code>--no-build</code> ä¸è‡ªåŠ¨æ„å»ºç¼ºå¤±çš„æœåŠ¡é•œåƒã€‚</li><li><code>-t, --timeout TIMEOUT</code> åœæ­¢å®¹å™¨æ—¶å€™çš„è¶…æ—¶ï¼ˆé»˜è®¤ä¸º 10 ç§’ï¼‰ã€‚</li></ul><h2 id="æ¨¡æ¿æ–‡ä»¶"><a href="#æ¨¡æ¿æ–‡ä»¶" class="headerlink" title="æ¨¡æ¿æ–‡ä»¶"></a>æ¨¡æ¿æ–‡ä»¶</h2><p>æ¨¡æ¿æ–‡ä»¶æ˜¯ä½¿ç”¨ <code>Compose</code> çš„æ ¸å¿ƒï¼Œæ¶‰åŠåˆ°çš„æŒ‡ä»¤å…³é”®å­—ä¹Ÿæ¯”è¾ƒå¤šã€‚ä½†å¤§å®¶ä¸ç”¨æ‹…å¿ƒï¼Œè¿™é‡Œé¢å¤§éƒ¨åˆ†æŒ‡ä»¤è·Ÿ <code>docker run</code> ç›¸å…³å‚æ•°çš„å«ä¹‰éƒ½æ˜¯ç±»ä¼¼çš„ã€‚</p><p>é»˜è®¤çš„æ¨¡æ¿æ–‡ä»¶åç§°ä¸º <code>docker-compose.yml</code>ï¼Œæ ¼å¼ä¸º YAML æ ¼å¼ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">webapp:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">examples/web</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">myweb</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/data&quot;</span></span><br></pre></td></tr></table></figure><p><font color="red">æ³¨æ„æ¯ä¸ªæœåŠ¡éƒ½å¿…é¡»é€šè¿‡ <code>image</code> æŒ‡ä»¤æŒ‡å®šé•œåƒæˆ– <code>build</code> æŒ‡ä»¤ï¼ˆéœ€è¦ Dockerfileï¼‰ç­‰æ¥è‡ªåŠ¨æ„å»ºç”Ÿæˆé•œåƒã€‚</font></p><p>å¦‚æœä½¿ç”¨ <code>build</code> æŒ‡ä»¤ï¼Œåœ¨ <code>Dockerfile</code> ä¸­è®¾ç½®çš„é€‰é¡¹(ä¾‹å¦‚ï¼š<code>CMD</code>, <code>EXPOSE</code>, <code>VOLUME</code>, <code>ENV</code> ç­‰) å°†ä¼šè‡ªåŠ¨è¢«è·å–ï¼Œæ— éœ€åœ¨ <code>docker-compose.yml</code> ä¸­é‡å¤è®¾ç½®ã€‚</p><p>æ¯ä¸ªæŒ‡ä»¤çš„ç”¨æ³•ï¼š<a href="https://yeasy.gitbook.io/docker_practice/compose/compose_file">https://yeasy.gitbook.io/docker_practice/compose/compose_file</a></p><ul><li><code>depends_on</code>ï¼š<a href="https://docs.docker.com/compose/compose-file/#depends_on">https://docs.docker.com/compose/compose-file/#depends_on</a></li></ul><h2 id="Composeä¸­çš„ç¯å¢ƒå˜é‡"><a href="#Composeä¸­çš„ç¯å¢ƒå˜é‡" class="headerlink" title="Composeä¸­çš„ç¯å¢ƒå˜é‡"></a>Composeä¸­çš„ç¯å¢ƒå˜é‡</h2><h3 id="åœ¨æ’°å†™æ–‡ä»¶æ›¿æ¢ç¯å¢ƒå˜é‡"><a href="#åœ¨æ’°å†™æ–‡ä»¶æ›¿æ¢ç¯å¢ƒå˜é‡" class="headerlink" title="åœ¨æ’°å†™æ–‡ä»¶æ›¿æ¢ç¯å¢ƒå˜é‡"></a>åœ¨æ’°å†™æ–‡ä»¶æ›¿æ¢ç¯å¢ƒå˜é‡</h3><p>å¯ä»¥åœ¨å¤–å£³ä¸­ä½¿ç”¨ç¯å¢ƒå˜é‡æ¥å¡«å……Composeæ–‡ä»¶ä¸­çš„å€¼ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">web:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">&quot;webapp:$&#123;TAG&#125;&quot;</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæ‚¨æœ‰å¤šä¸ªç¯å¢ƒå˜é‡ï¼Œåˆ™å¯ä»¥é€šè¿‡æä¾›ç¯å¢ƒå˜é‡æ–‡ä»¶çš„è·¯å¾„æ¥æ›¿æ¢å®ƒä»¬ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥<code>docker-compose</code> å‘½ä»¤å°†<code>.env</code>åœ¨æ‚¨è¿è¡Œè¯¥å‘½ä»¤çš„ç›®å½•ä¸­æŸ¥æ‰¾ä¸€ä¸ªåä¸ºçš„æ–‡ä»¶ã€‚é€šè¿‡å°†æ–‡ä»¶ä½œä¸ºå‚æ•°ï¼Œä½ å¯ä»¥å­˜å‚¨åœ¨ä»»ä½•åœ°æ–¹ï¼Œå¹¶é€‚å½“å‘½åï¼Œä¾‹å¦‚<code>.env.ci</code>ï¼Œ<code>.env.dev</code>ï¼Œ<code>.env.prod</code>ã€‚ä½¿ç”¨ä»¥ä¸‹<code>--env-file</code>é€‰é¡¹å®Œæˆæ–‡ä»¶è·¯å¾„çš„ä¼ é€’ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose --env-file ./config/.env.dev up </span><br></pre></td></tr></table></figure><h3 id="åœ¨å®¹å™¨ä¸­è®¾ç½®ç¯å¢ƒå˜é‡"><a href="#åœ¨å®¹å™¨ä¸­è®¾ç½®ç¯å¢ƒå˜é‡" class="headerlink" title="åœ¨å®¹å™¨ä¸­è®¾ç½®ç¯å¢ƒå˜é‡"></a>åœ¨å®¹å™¨ä¸­è®¾ç½®ç¯å¢ƒå˜é‡</h3><p>æ‚¨å¯ä»¥ä½¿ç”¨environmenté”®åœ¨æœåŠ¡çš„å®¹å™¨ä¸­è®¾ç½®ç¯å¢ƒå˜é‡ ï¼Œå°±åƒ <code>docker run -e VARIABLE=VALUE ...</code>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">web:</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">DEBUG=1</span></span><br></pre></td></tr></table></figure><h2 id="Composeç½‘ç»œ"><a href="#Composeç½‘ç»œ" class="headerlink" title="Composeç½‘ç»œ"></a>Composeç½‘ç»œ</h2><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒComposeä¸ºæ‚¨çš„åº”ç”¨è®¾ç½®å•ä¸ªç½‘ç»œã€‚ä¸ºæœåŠ¡æ¯ä¸ªå®¹å™¨åŠ å…¥é»˜è®¤ç½‘ç»œã€‚</p><blockquote><p><strong>æ³¨æ„</strong></p><p>ä¸ºåº”ç”¨ç¨‹åºçš„ç½‘ç»œæä¾›ä¸€ä¸ªåŸºäºâ€œé¡¹ç›®åç§°â€çš„åç§°ï¼Œè¯¥åç§°åŸºäºå…¶æ‰€åœ¨ç›®å½•çš„åç§°ã€‚æ‚¨å¯ä»¥ä½¿ç”¨<code>--project-name  flag</code>è¦†ç›–é¡¹ç›®åç§°ã€‚</p></blockquote><p>ä¾‹å¦‚ï¼Œå‡è®¾æ‚¨çš„åº”ç”¨ç¨‹åºä½äºåä¸ºçš„ç›®å½•ä¸­<code>myapp</code>ï¼Œå¹¶ä¸”æ‚¨çš„<code>docker-compose.yml</code>å¤–è§‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8000:8000&quot;</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8001:5432&quot;</span></span><br></pre></td></tr></table></figure><p>è¿è¡Œæ—¶<code>docker-compose up</code>ï¼Œå°†å‘ç”Ÿä»¥ä¸‹æƒ…å†µï¼š</p><ol><li><code>myapp_default</code>åˆ›å»ºä¸€ä¸ªåä¸ºçš„ç½‘ç»œã€‚</li><li>å®¹å™¨æ˜¯ä½¿ç”¨<code>web</code>çš„é…ç½®åˆ›å»ºçš„ã€‚å®ƒ<code>myapp_default</code>ä»¥åç§°<code>web</code>åŠ å…¥ç½‘ç»œ ã€‚</li><li>å®¹å™¨æ˜¯ä½¿ç”¨<code>db</code>çš„é…ç½®åˆ›å»ºçš„ã€‚å®ƒ<code>myapp_default</code>ä»¥åç§°<code>db</code>åŠ å…¥ç½‘ç»œ ã€‚</li></ol><p>ç°åœ¨ï¼Œæ¯ä¸ªå®¹å™¨éƒ½å¯ä»¥æŸ¥æ‰¾ä¸»æœºå<code>web</code>æˆ–<code>db</code>è·å–ç›¸åº”å®¹å™¨çš„IPåœ°å€ã€‚ä¾‹å¦‚ï¼Œ<code>web</code>çš„åº”ç”¨ç¨‹åºä»£ç å¯ä»¥è¿æ¥åˆ°URL<code>postgres://db:5432</code>å¹¶å¼€å§‹ä½¿ç”¨Postgresæ•°æ®åº“ã€‚</p><p>è¦æ³¨æ„åŒºåˆ†æ˜¯å¾ˆé‡è¦çš„<code>HOST_PORT</code>å’Œ<code>CONTAINER_PORT</code>ã€‚åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œå¯¹äº<code>db</code>ï¼Œ<code>HOST_PORT</code>isæ˜¯<code>8001</code>ï¼Œå®¹å™¨ç«¯å£ä¸º <code>5432</code>ï¼ˆpostgresé»˜è®¤ï¼‰ã€‚è”ç½‘çš„æœåŠ¡åˆ°æœåŠ¡é€šä¿¡ä½¿ç”¨<code>CONTAINER_PORT</code>ã€‚å½“<code>HOST_PORT</code>å®šä¹‰ï¼ŒæœåŠ¡ä»¥åŠè™«ç¾¤å¤–éƒ¨è®¿é—®ã€‚</p><p>åœ¨<code>web</code>å®¹å™¨å†…ï¼Œæ‚¨çš„è¿æ¥å­—ç¬¦ä¸²<code>db</code>å°†çœ‹èµ·æ¥åƒ <code>postgres://db:5432</code>ï¼Œè€Œåœ¨ä¸»æœºä¸Šï¼Œè¿æ¥å­—ç¬¦ä¸²å°†çœ‹èµ·æ¥åƒ<code>postgres://&#123;DOCKER_IP&#125;:8001</code>ã€‚</p><h3 id="è‡ªå®šä¹‰ç½‘ç»œ"><a href="#è‡ªå®šä¹‰ç½‘ç»œ" class="headerlink" title="è‡ªå®šä¹‰ç½‘ç»œ"></a>è‡ªå®šä¹‰ç½‘ç»œ</h3><h4 id="é…ç½®é»˜è®¤ç½‘ç»œ"><a href="#é…ç½®é»˜è®¤ç½‘ç»œ" class="headerlink" title="é…ç½®é»˜è®¤ç½‘ç»œ"></a>é…ç½®é»˜è®¤ç½‘ç»œ</h4><p>é™¤äº†ï¼ˆæˆ–åŒæ—¶ï¼‰æŒ‡å®šè‡ªå·±çš„ç½‘ç»œï¼Œæ‚¨è¿˜å¯ä»¥é€šè¿‡åœ¨<code>networks</code>namedä¸‹å®šä¹‰ä¸€ä¸ªæ¡ç›®æ¥æ›´æ”¹åº”ç”¨ç¨‹åºèŒƒå›´çš„é»˜è®¤ç½‘ç»œçš„è®¾ç½®<code>default</code>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8000:8000&quot;</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">default:</span></span><br><span class="line">    <span class="comment"># Use a custom driver</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">custom-driver-1</span></span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨ç°æœ‰ç½‘ç»œ"><a href="#ä½¿ç”¨ç°æœ‰ç½‘ç»œ" class="headerlink" title="ä½¿ç”¨ç°æœ‰ç½‘ç»œ"></a>ä½¿ç”¨ç°æœ‰ç½‘ç»œ</h4><p>å¦‚æœæ‚¨å¸Œæœ›å®¹å™¨åŠ å…¥ç°æœ‰ç½‘ç»œï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹<a href="https://docs.docker.com/compose/compose-file/compose-file-v2/#network-configuration-reference"><code>external</code>é€‰é¡¹</a>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">default:</span></span><br><span class="line">    <span class="attr">external:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">my-pre-existing-network</span></span><br></pre></td></tr></table></figure><p><code>[projectname]_default</code>Composeä¸ä¼šå°è¯•åˆ›å»ºä¸€ä¸ªåä¸ºçš„ç½‘ç»œï¼Œè€Œæ˜¯æŸ¥æ‰¾ä¸€ä¸ªåä¸ºçš„ç½‘ç»œ<code>my-pre-existing-network</code>å¹¶å°†æ‚¨çš„åº”ç”¨ç¨‹åºçš„å®¹å™¨è¿æ¥åˆ°è¯¥ç½‘ç»œã€‚</p><h2 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h2><h3 id="WordPress"><a href="#WordPress" class="headerlink" title="WordPress"></a>WordPress</h3><p><code>Compose</code> å¯ä»¥å¾ˆä¾¿æ·çš„è®© <code>Wordpress</code> è¿è¡Œåœ¨ä¸€ä¸ªç‹¬ç«‹çš„ç¯å¢ƒä¸­ã€‚</p><h3 id="åˆ›å»ºç©ºæ–‡ä»¶å¤¹"><a href="#åˆ›å»ºç©ºæ–‡ä»¶å¤¹" class="headerlink" title="åˆ›å»ºç©ºæ–‡ä»¶å¤¹"></a>åˆ›å»ºç©ºæ–‡ä»¶å¤¹</h3><p>å‡è®¾æ–°å»ºä¸€ä¸ªåä¸º <code>wordpress</code> çš„æ–‡ä»¶å¤¹ï¼Œç„¶åè¿›å…¥è¿™ä¸ªæ–‡ä»¶å¤¹ã€‚</p><h3 id="åˆ›å»º-docker-compose-yml-æ–‡ä»¶"><a href="#åˆ›å»º-docker-compose-yml-æ–‡ä»¶" class="headerlink" title="åˆ›å»º docker-compose.yml æ–‡ä»¶"></a>åˆ›å»º <code>docker-compose.yml</code> æ–‡ä»¶</h3><p><a href="https://github.com/yeasy/docker_practice/blob/master/compose/demo/wordpress/docker-compose.yml"><code>docker-compose.yml</code></a> æ–‡ä»¶å°†å¼€å¯ä¸€ä¸ª <code>wordpress</code> æœåŠ¡å’Œä¸€ä¸ªç‹¬ç«‹çš„ <code>MySQL</code> å®ä¾‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line">   <span class="attr">db:</span></span><br><span class="line">     <span class="attr">image:</span> <span class="string">mysql:8.0</span></span><br><span class="line">     <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--default_authentication_plugin=mysql_native_password</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--character-set-server=utf8mb4</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--collation-server=utf8mb4_unicode_ci</span>     </span><br><span class="line">     <span class="attr">volumes:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">db_data:/var/lib/mysql</span></span><br><span class="line">     <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">     <span class="attr">environment:</span></span><br><span class="line">       <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">somewordpress</span></span><br><span class="line">       <span class="attr">MYSQL_DATABASE:</span> <span class="string">wordpress</span></span><br><span class="line">       <span class="attr">MYSQL_USER:</span> <span class="string">wordpress</span></span><br><span class="line">       <span class="attr">MYSQL_PASSWORD:</span> <span class="string">wordpress</span></span><br><span class="line"></span><br><span class="line">   <span class="attr">wordpress:</span></span><br><span class="line">     <span class="attr">depends_on:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">     <span class="attr">image:</span> <span class="string">wordpress:latest</span></span><br><span class="line">     <span class="attr">ports:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">&quot;8000:80&quot;</span></span><br><span class="line">     <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">     <span class="attr">environment:</span></span><br><span class="line">       <span class="attr">WORDPRESS_DB_HOST:</span> <span class="string">db:3306</span></span><br><span class="line">       <span class="attr">WORDPRESS_DB_USER:</span> <span class="string">wordpress</span></span><br><span class="line">       <span class="attr">WORDPRESS_DB_PASSWORD:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">db_data:</span></span><br></pre></td></tr></table></figure><h3 id="æ„å»ºå¹¶è¿è¡Œé¡¹ç›®"><a href="#æ„å»ºå¹¶è¿è¡Œé¡¹ç›®" class="headerlink" title="æ„å»ºå¹¶è¿è¡Œé¡¹ç›®"></a>æ„å»ºå¹¶è¿è¡Œé¡¹ç›®</h3><p>è¿è¡Œ <code>docker-compose up -d</code> Compose å°±ä¼šæ‹‰å–é•œåƒå†åˆ›å»ºæˆ‘ä»¬æ‰€éœ€è¦çš„é•œåƒï¼Œç„¶åå¯åŠ¨ <code>wordpress</code> å’Œæ•°æ®åº“å®¹å™¨ã€‚ æ¥ç€æµè§ˆå™¨è®¿é—® <code>127.0.0.1:8000</code> ç«¯å£å°±èƒ½çœ‹åˆ° <code>WordPress</code> å®‰è£…ç•Œé¢äº†ã€‚</p><p><font color="red"></font></p><h1 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h1><p><a href="https://yeasy.gitbook.io/docker_practice/">https://yeasy.gitbook.io/docker_practice/</a></p><p><a href="https://docs.docker.com/compose/">https://docs.docker.com/compose/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Docker-Compose&quot;&gt;&lt;a href=&quot;#Docker-Compose&quot; class=&quot;headerlink&quot; title=&quot;Docker Compose&quot;&gt;&lt;/a&gt;Docker Compose&lt;/h1&gt;&lt;p&gt;&lt;code&gt;Compose&lt;/code&gt; é¡¹</summary>
      
    
    
    
    <category term="Docker" scheme="https://awslzhang.top/categories/Docker/"/>
    
    
    <category term="Docker" scheme="https://awslzhang.top/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>Dockerç½‘ç»œ</title>
    <link href="https://awslzhang.top/2020/11/13/Docker%E7%BD%91%E7%BB%9C/"/>
    <id>https://awslzhang.top/2020/11/13/Docker%E7%BD%91%E7%BB%9C/</id>
    <published>2020-11-13T11:35:04.000Z</published>
    <updated>2021-01-01T05:49:59.917Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Dockerç½‘ç»œ"><a href="#Dockerç½‘ç»œ" class="headerlink" title="Dockerç½‘ç»œ"></a>Dockerç½‘ç»œ</h1><blockquote><p>Docker å…è®¸é€šè¿‡å¤–éƒ¨è®¿é—®å®¹å™¨æˆ–å®¹å™¨äº’è”çš„æ–¹å¼æ¥æä¾›ç½‘ç»œæœåŠ¡ã€‚</p></blockquote><h2 id="å¤–éƒ¨è®¿é—®å®¹å™¨"><a href="#å¤–éƒ¨è®¿é—®å®¹å™¨" class="headerlink" title="å¤–éƒ¨è®¿é—®å®¹å™¨"></a>å¤–éƒ¨è®¿é—®å®¹å™¨</h2><p>å®¹å™¨ä¸­å¯ä»¥è¿è¡Œä¸€äº›ç½‘ç»œåº”ç”¨ï¼Œè¦è®©å¤–éƒ¨ä¹Ÿå¯ä»¥è®¿é—®è¿™äº›åº”ç”¨ï¼Œå¯ä»¥é€šè¿‡ <code>-P</code> æˆ– <code>-p</code> å‚æ•°æ¥æŒ‡å®šç«¯å£æ˜ å°„ã€‚</p><ul><li>å½“ä½¿ç”¨ <code>-P</code> æ ‡è®°æ—¶ï¼ŒDocker ä¼šéšæœºæ˜ å°„ä¸€ä¸ªç«¯å£åˆ°<font color="red">**å†…éƒ¨å®¹å™¨å¼€æ”¾çš„ç½‘ç»œç«¯å£(EXPOSEçš„ç«¯å£)**ã€‚</font></li><li>å½“ä½¿ç”¨<code>-p</code>æ ‡è®°æ—¶ï¼Œéœ€è¦åŒæ—¶æŒ‡å®šå®¿ä¸»æœºç«¯å£ä¸å®¹å™¨ç«¯å£ä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -P nginx</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>docker container ls</code> å¯ä»¥çœ‹åˆ°ï¼Œæœ¬åœ°ä¸»æœºçš„ 32769è¢«æ˜ å°„åˆ°äº†å®¹å™¨çš„ 80 ç«¯å£ã€‚æ­¤æ—¶è®¿é—®æœ¬æœºçš„ 32769ç«¯å£å³å¯è®¿é—®å®¹å™¨å†… NGINX é»˜è®¤é¡µé¢ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker container ls</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                   NAMES</span><br><span class="line">3dda28d1a931        nginx               <span class="string">&quot;/docker-entrypoint.â€¦&quot;</span>   24 seconds ago      Up 23 seconds       0.0.0.0:32769-&gt;80/tcp   romantic_volhard</span><br></pre></td></tr></table></figure><blockquote><p><code>-p</code> åˆ™å¯ä»¥æŒ‡å®šè¦æ˜ å°„çš„ç«¯å£ï¼Œå¹¶ä¸”ï¼Œåœ¨ä¸€ä¸ªæŒ‡å®šç«¯å£ä¸Šåªå¯ä»¥ç»‘å®šä¸€ä¸ªå®¹å™¨ã€‚æ”¯æŒçš„æ ¼å¼æœ‰ :</p></blockquote><ul><li><code>ip:hostPort:containerPort </code>ï¼šæ˜ å°„åˆ°æŒ‡å®šåœ°å€çš„æŒ‡å®šç«¯å£</li><li><code>ip::containerPort</code>ï¼šæ˜ å°„æ‰€æœ‰æ¥å£åœ°å€</li><li><code>hostPort:containerPort</code>ï¼šæ˜ å°„åˆ°æŒ‡å®šåœ°å€çš„ä»»æ„ç«¯å£</li></ul><h3 id="æŒ‡å®šæ˜ å°„åˆ†ç±»"><a href="#æŒ‡å®šæ˜ å°„åˆ†ç±»" class="headerlink" title="æŒ‡å®šæ˜ å°„åˆ†ç±»"></a>æŒ‡å®šæ˜ å°„åˆ†ç±»</h3><h4 id="æ˜ å°„æ‰€æœ‰æ¥å£åœ°å€"><a href="#æ˜ å°„æ‰€æœ‰æ¥å£åœ°å€" class="headerlink" title="æ˜ å°„æ‰€æœ‰æ¥å£åœ°å€"></a>æ˜ å°„æ‰€æœ‰æ¥å£åœ°å€</h4><p>ä½¿ç”¨ <code>hostPort:containerPort</code> æ ¼å¼æœ¬åœ°çš„ 80 ç«¯å£æ˜ å°„åˆ°å®¹å™¨çš„ 80 ç«¯å£ï¼Œå¯ä»¥æ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -p 80:80 nginx:alpine</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶é»˜è®¤ä¼šç»‘å®šæœ¬åœ°æ‰€æœ‰æ¥å£ä¸Šçš„æ‰€æœ‰åœ°å€ã€‚</p><h4 id="æ˜ å°„åˆ°æŒ‡å®šåœ°å€çš„æŒ‡å®šç«¯å£"><a href="#æ˜ å°„åˆ°æŒ‡å®šåœ°å€çš„æŒ‡å®šç«¯å£" class="headerlink" title="æ˜ å°„åˆ°æŒ‡å®šåœ°å€çš„æŒ‡å®šç«¯å£"></a>æ˜ å°„åˆ°æŒ‡å®šåœ°å€çš„æŒ‡å®šç«¯å£</h4><p>å¯ä»¥ä½¿ç”¨ <code>ip:hostPort:containerPort</code> æ ¼å¼æŒ‡å®šæ˜ å°„ä½¿ç”¨ä¸€ä¸ªç‰¹å®šåœ°å€ï¼Œæ¯”å¦‚ localhost åœ°å€ 127.0.0.1</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -p 127.0.0.1:80:80 nginx:alpine</span><br></pre></td></tr></table></figure><h4 id="æ˜ å°„åˆ°æŒ‡å®šåœ°å€çš„ä»»æ„ç«¯å£"><a href="#æ˜ å°„åˆ°æŒ‡å®šåœ°å€çš„ä»»æ„ç«¯å£" class="headerlink" title="æ˜ å°„åˆ°æŒ‡å®šåœ°å€çš„ä»»æ„ç«¯å£"></a>æ˜ å°„åˆ°æŒ‡å®šåœ°å€çš„ä»»æ„ç«¯å£</h4><p>ä½¿ç”¨ <code>ip::containerPort</code> ç»‘å®š localhost çš„ä»»æ„ç«¯å£åˆ°å®¹å™¨çš„ 80 ç«¯å£ï¼Œæœ¬åœ°ä¸»æœºä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ªç«¯å£ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -p 127.0.0.1::80 nginx:alpine</span><br></pre></td></tr></table></figure><p>è¿˜å¯ä»¥ä½¿ç”¨ <code>udp</code> æ ‡è®°æ¥æŒ‡å®š <code>udp</code> ç«¯å£</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -p 127.0.0.1:80:80/udp nginx:alpine</span><br></pre></td></tr></table></figure><p><strong>è¿™é‡Œæåˆ°äº†UDPç«¯å£å·ï¼Œç‰¹æ­¤è¯´æ˜TCPã€UDPéƒ½æœ‰ç«¯å£å·å¹¶äº’ä¸å½±å“ã€‚</strong></p><blockquote><p> é¡ºä¾¿æå‡ºç«¯å£å·çš„èŒƒå›´å¯åˆ†ä¸ºä¸‰ç§ï¼š</p><ul><li>Well-Known Portsï¼ˆå³å…¬è®¤ç«¯å£å·ï¼‰ï¼šçŸ¥åç«¯å£å·çš„èŒƒå›´æ˜¯ï¼š0-1023</li><li>Registered Portsï¼ˆå³æ³¨å†Œç«¯å£ï¼‰ï¼šæ³¨å†Œç«¯å£å·çš„èŒƒå›´æ˜¯ï¼š1024-49151</li><li>Dynamic, private or ephemeral portsï¼ˆå³åŠ¨æ€ã€ç§æœ‰æˆ–ä¸´æ—¶ç«¯å£å·ï¼‰ï¼šè¿™ä¸€æ®µçš„èŒƒå›´æ˜¯ï¼š49152â€“65535</li></ul></blockquote><h3 id="æŸ¥çœ‹æ˜ å°„ç«¯å£é…ç½®"><a href="#æŸ¥çœ‹æ˜ å°„ç«¯å£é…ç½®" class="headerlink" title="æŸ¥çœ‹æ˜ å°„ç«¯å£é…ç½®"></a>æŸ¥çœ‹æ˜ å°„ç«¯å£é…ç½®</h3><p>ä½¿ç”¨ <code>docker port</code> æ¥æŸ¥çœ‹å½“å‰æ˜ å°„çš„ç«¯å£é…ç½®ï¼Œä¹Ÿå¯ä»¥æŸ¥çœ‹åˆ°ç»‘å®šçš„åœ°å€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker port containerId</span><br><span class="line">80/tcp -&gt; 0.0.0.0:80</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼š</p><ul><li>å®¹å™¨æœ‰è‡ªå·±çš„å†…éƒ¨ç½‘ç»œå’Œ ip åœ°å€ï¼ˆä½¿ç”¨ <code>docker inspect</code> æŸ¥çœ‹ï¼ŒDocker è¿˜å¯ä»¥æœ‰ä¸€ä¸ªå¯å˜çš„ç½‘ç»œé…ç½®ã€‚ï¼‰</li><li><code>-p</code> æ ‡è®°å¯ä»¥å¤šæ¬¡ä½¿ç”¨æ¥ç»‘å®šå¤šä¸ªç«¯å£</li></ul></blockquote><p>ä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d \</span><br><span class="line">-p 80:80 \</span><br><span class="line">-p 443:443 \</span><br><span class="line">nginx:alpine</span><br></pre></td></tr></table></figure><h2 id="å®¹å™¨äº’è”"><a href="#å®¹å™¨äº’è”" class="headerlink" title="å®¹å™¨äº’è”"></a>å®¹å™¨äº’è”</h2><p>å¦‚æœä½ ä¹‹å‰æœ‰ <code>Docker</code> ä½¿ç”¨ç»éªŒï¼Œä½ å¯èƒ½å·²ç»ä¹ æƒ¯äº†ä½¿ç”¨ <code>--link</code> å‚æ•°æ¥ä½¿å®¹å™¨äº’è”ã€‚</p><p><code>--link</code>æ–¹å¼ä½¿å®¹å™¨äº’è”éœ€è¦å¯¹åŒæ–¹å®¹å™¨éƒ½åšå‡ºé™åˆ¶ï¼Œä¸å¥½æ“ä½œã€‚</p><p>éšç€ Docker ç½‘ç»œçš„å®Œå–„ï¼Œå¼ºçƒˆå»ºè®®å¤§å®¶å°†å®¹å™¨åŠ å…¥<font color="red"><strong>è‡ªå®šä¹‰çš„ Docker ç½‘ç»œæ¥è¿æ¥å¤šä¸ªå®¹å™¨</strong></font>ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ <code>--link</code> å‚æ•°ã€‚</p><h3 id="æ–°å»ºç½‘ç»œ"><a href="#æ–°å»ºç½‘ç»œ" class="headerlink" title="æ–°å»ºç½‘ç»œ"></a>æ–°å»ºç½‘ç»œ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker network create -d bridge my-net</span><br></pre></td></tr></table></figure><p><code>-d</code> å‚æ•°æŒ‡å®š Docker ç½‘ç»œç±»å‹ï¼Œæœ‰ <code>bridge</code> <code>overlay</code>ã€‚å…¶ä¸­ <code>overlay</code> ç½‘ç»œç±»å‹ç”¨äº <a href="">Swarm mode</a>ï¼Œåœ¨æœ¬å°èŠ‚ä¸­ä½ å¯ä»¥å¿½ç•¥å®ƒã€‚</p><h3 id="è¿æ¥å®¹å™¨"><a href="#è¿æ¥å®¹å™¨" class="headerlink" title="è¿æ¥å®¹å™¨"></a>è¿æ¥å®¹å™¨</h3><p>è¿è¡Œä¸€ä¸ªå®¹å™¨å¹¶è¿æ¥åˆ°æ–°å»ºçš„ <code>my-net</code> ç½‘ç»œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -it --rm --name busybox1 --network my-net busybox sh</span><br></pre></td></tr></table></figure><p>æ‰“å¼€æ–°çš„ç»ˆç«¯ï¼Œå†è¿è¡Œä¸€ä¸ªå®¹å™¨å¹¶åŠ å…¥åˆ° <code>my-net</code> ç½‘ç»œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -it --rm --name busybox2 --network my-net busybox sh</span><br></pre></td></tr></table></figure><p>å†æ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯æŸ¥çœ‹å®¹å™¨ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker container ls</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMESb47060aca56b        busybox             <span class="string">&quot;sh&quot;</span>                11 minutes ago      Up 11 minutes                           busybox28720575823ec        busybox             <span class="string">&quot;sh&quot;</span>                16 minutes ago      Up 16 minutes                           busybox1</span><br></pre></td></tr></table></figure><p>ä¸‹é¢é€šè¿‡ <code>ping</code> æ¥è¯æ˜ <code>busybox1</code> å®¹å™¨å’Œ <code>busybox2</code> å®¹å™¨å»ºç«‹äº†äº’è”å…³ç³»ã€‚</p><p>åœ¨ <code>busybox1</code> å®¹å™¨è¾“å…¥ä»¥ä¸‹å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># ping busybox2</span></span><br><span class="line">PING busybox2 (172.19.0.3): 56 data bytes</span><br><span class="line">64 bytes from 172.19.0.3: seq=0 ttl=64 time=0.072 ms</span><br><span class="line">64 bytes from 172.19.0.3: seq=1 ttl=64 time=0.118 ms</span><br></pre></td></tr></table></figure><p>ç”¨ ping æ¥æµ‹è¯•è¿æ¥ <code>busybox2</code> å®¹å™¨ï¼Œå®ƒä¼šè§£ææˆ <code>172.19.0.3</code>ã€‚</p><p>åŒç†åœ¨ <code>busybox2</code> å®¹å™¨æ‰§è¡Œ <code>ping busybox1</code>ï¼Œä¹Ÿä¼šæˆåŠŸè¿æ¥åˆ°ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># ping busybox1</span></span><br><span class="line">PING busybox1 (172.19.0.2): 56 data bytes</span><br><span class="line">64 bytes from 172.19.0.2: seq=0 ttl=64 time=0.064 ms</span><br><span class="line">64 bytes from 172.19.0.2: seq=1 ttl=64 time=0.143 ms</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œ<code>busybox1</code> å®¹å™¨å’Œ <code>busybox2</code> å®¹å™¨å»ºç«‹äº†äº’è”å…³ç³»ã€‚</p><h2 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h2><p>å¦‚æœä½ æœ‰å¤šä¸ªå®¹å™¨ä¹‹é—´éœ€è¦äº’ç›¸è¿æ¥ï¼Œæ¨èä½¿ç”¨Docker Compose</p><hr><h1 id="é«˜çº§ç½‘ç»œé…ç½®"><a href="#é«˜çº§ç½‘ç»œé…ç½®" class="headerlink" title="é«˜çº§ç½‘ç»œé…ç½®"></a>é«˜çº§ç½‘ç»œé…ç½®</h1><p>å½“ Docker å¯åŠ¨æ—¶ï¼Œä¼šè‡ªåŠ¨åœ¨ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ª <code>docker0</code> è™šæ‹Ÿç½‘æ¡¥ï¼Œå®é™…ä¸Šæ˜¯ Linux çš„ä¸€ä¸ª bridgeï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªè½¯ä»¶äº¤æ¢æœºï¼Œ<font color="red">æ‰€æœ‰ä¸æŒ‡å®šç½‘ç»œçš„å®¹å™¨éƒ½ä¼šä½¿ç”¨æ­¤ç½‘å¡ï¼ˆé»˜è®¤ç½‘å¡ï¼‰</font>ã€‚å®ƒä¼šåœ¨æŒ‚è½½åˆ°å®ƒçš„ç½‘å£ä¹‹é—´è¿›è¡Œè½¬å‘ã€‚</p><p>åŒæ—¶ï¼ŒDocker éšæœºåˆ†é…ä¸€ä¸ªæœ¬åœ°æœªå ç”¨çš„ç§æœ‰ç½‘æ®µï¼ˆåœ¨ <a href="https://tools.ietf.org/html/rfc1918">RFC1918</a> ä¸­å®šä¹‰ï¼‰ä¸­çš„ä¸€ä¸ªåœ°å€ç»™ <code>docker0</code> æ¥å£ã€‚æ¯”å¦‚å…¸å‹çš„ <code>172.17.42.1/16</code>ï¼Œæ©ç ä¸º <code>255.255.0.0</code>ã€‚æ­¤åå¯åŠ¨çš„å®¹å™¨å†…çš„ç½‘å£ä¹Ÿä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ªåŒä¸€ç½‘æ®µï¼ˆ<code>172.17.0.0/16</code>ï¼‰çš„åœ°å€ã€‚</p><blockquote><p><strong>æ³¨æ„</strong>ï¼šé»˜è®¤çš„<code>docker0</code>ç½‘ç»œå’Œè‡ªå®šä¹‰ç½‘ç»œæœ‰ä¸€ç‚¹ä¸åŒï¼Œä½¿ç”¨<code>docker0</code>ç½‘å¡çš„å®¹å™¨ä¸èƒ½å®ç°äº’è”ã€‚</p></blockquote><p>å½“åˆ›å»ºä¸€ä¸ª Docker å®¹å™¨çš„æ—¶å€™ï¼ŒåŒæ—¶ä¼šåˆ›å»ºäº†ä¸€å¯¹ <code>veth pair</code> æ¥å£ï¼ˆå½“æ•°æ®åŒ…å‘é€åˆ°ä¸€ä¸ªæ¥å£æ—¶ï¼Œå¦å¤–ä¸€ä¸ªæ¥å£ä¹Ÿå¯ä»¥æ”¶åˆ°ç›¸åŒçš„æ•°æ®åŒ…ï¼‰ã€‚è¿™å¯¹æ¥å£ä¸€ç«¯åœ¨å®¹å™¨å†…ï¼Œå³ <code>eth0</code>ï¼›å¦ä¸€ç«¯åœ¨æœ¬åœ°å¹¶è¢«æŒ‚è½½åˆ° <code>docker0</code> ç½‘æ¡¥ï¼Œåç§°ä»¥ <code>veth</code> å¼€å¤´ï¼ˆä¾‹å¦‚ <code>vethAQI2QT</code>ï¼‰ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä¸»æœºå¯ä»¥è·Ÿå®¹å™¨é€šä¿¡ï¼Œå®¹å™¨ä¹‹é—´ä¹Ÿå¯ä»¥ç›¸äº’é€šä¿¡ã€‚Docker å°±åˆ›å»ºäº†åœ¨ä¸»æœºå’Œæ‰€æœ‰å®¹å™¨ä¹‹é—´ä¸€ä¸ªè™šæ‹Ÿå…±äº«ç½‘ç»œã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/hostos.png"></p><p>æ¥ä¸‹æ¥çš„éƒ¨åˆ†å°†ä»‹ç»åœ¨ä¸€äº›åœºæ™¯ä¸­ï¼ŒDocker æ‰€æœ‰çš„ç½‘ç»œå®šåˆ¶é…ç½®ã€‚ä»¥åŠé€šè¿‡ Linux å‘½ä»¤æ¥è°ƒæ•´ã€è¡¥å……ã€ç”šè‡³æ›¿æ¢ Docker é»˜è®¤çš„ç½‘ç»œé…ç½®ã€‚</p><h2 id="å¿«é€Ÿé…ç½®æŒ‡å—"><a href="#å¿«é€Ÿé…ç½®æŒ‡å—" class="headerlink" title="å¿«é€Ÿé…ç½®æŒ‡å—"></a>å¿«é€Ÿé…ç½®æŒ‡å—</h2><p>æœ€åè¿™äº›é€‰é¡¹åªæœ‰åœ¨ <code>docker run</code> æ‰§è¡Œæ—¶ä½¿ç”¨ï¼Œå› ä¸ºå®ƒæ˜¯é’ˆå¯¹å®¹å™¨çš„ç‰¹æ€§å†…å®¹ã€‚</p><ul><li><code>-h HOSTNAME</code> æˆ– <code>--hostname=HOSTNAME</code> é…ç½®å®¹å™¨ä¸»æœºå</li><li><del><code>--link=CONTAINER_NAME:ALIAS</code> æ·»åŠ åˆ°å¦ä¸€ä¸ªå®¹å™¨çš„è¿æ¥</del></li><li><code>--net=bridge|none|container:NAME_or_ID|host</code> é…ç½®å®¹å™¨çš„æ¡¥æ¥æ¨¡å¼</li><li><code>-p SPEC</code> æˆ– <code>--publish=SPEC</code> æ˜ å°„å®¹å™¨ç«¯å£åˆ°å®¿ä¸»ä¸»æœº</li><li><code>-P or --publish-all=true|false</code> æ˜ å°„å®¹å™¨æ‰€æœ‰ç«¯å£åˆ°å®¿ä¸»ä¸»æœº</li></ul><h2 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h2><p><strong>åˆ›å»ºç½‘ç»œ</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker network create -d bridge --subnet 172.11.0.0/16 --gateway 172.11.0.1 mynet</span><br><span class="line">6ca441ff474f979f493774cf0c3c7379d5da03655e4da14bb8b5d80fe3e98d37</span><br></pre></td></tr></table></figure><p><strong>åˆ›å»º2ä¸ªä½¿ç”¨<code>mynet</code>çš„å®¹å™¨</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d --name tomcat-mynet-1 --network=mynet tomcat</span><br><span class="line">89a4b49863d4bcd4468a32105df3f8e6f0cec529bcad12264b17a18e636dc8ed</span><br><span class="line">$ docker run -d --name tomcat-mynet-2 --network=mynet tomcat</span><br><span class="line">e594cdd21b422b85306cca3389ca56610dd812a78f02b9977e6d022fcfd792e2</span><br></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹<code>mynet</code>ç½‘ç»œçš„ä½¿ç”¨æƒ…å†µ</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker network inspect mynet</span><br></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&quot;Containers&quot;: &#123;</span><br><span class="line">    &quot;39483e5272d244662e19aab9a5acaf4f935de7d4e123295c1a114629fbc2837b&quot;: &#123;</span><br><span class="line">        &quot;Name&quot;: &quot;tomcat-mynet-2&quot;,</span><br><span class="line">        &quot;EndpointID&quot;: &quot;868c73cf8b7b734a65837bf6eb6ed197c98a68b416f91ce7c2e7ea8f24cbba8d&quot;,</span><br><span class="line">        &quot;MacAddress&quot;: &quot;02:42:ac:0b:00:02&quot;,</span><br><span class="line">        &quot;IPv4Address&quot;: &quot;172.11.0.2/16&quot;,</span><br><span class="line">        &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;97cf9d5c3505d68546db70b67c65923103a05818243b00b6409f462515200136&quot;: &#123;</span><br><span class="line">        &quot;Name&quot;: &quot;tomcat-mynet-1&quot;,</span><br><span class="line">        &quot;EndpointID&quot;: &quot;bf315a5c26ab09131c88acefb291652c507b8c04d51e678d7370e108771eec55&quot;,</span><br><span class="line">        &quot;MacAddress&quot;: &quot;02:42:ac:0b:00:03&quot;,</span><br><span class="line">        &quot;IPv4Address&quot;: &quot;172.11.0.3/16&quot;,</span><br><span class="line">        &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æµ‹è¯•è‡ªå®šä¹‰ç½‘ç»œçš„å®¹å™¨äº’è”</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it tomcat-mynet-1 ping tomcat-mynet-2</span><br><span class="line">PING tomcat-mynet-2 (172.11.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from tomcat-mynet-2.mynet (172.11.0.2): icmp_seq=1 ttl=64 time=0.096 ms</span><br><span class="line">64 bytes from tomcat-mynet-2.mynet (172.11.0.2): icmp_seq=2 ttl=64 time=0.094 ms</span><br><span class="line">64 bytes from tomcat-mynet-2.mynet (172.11.0.2): icmp_seq=3 ttl=64 time=0.077 ms</span><br><span class="line">^C</span><br><span class="line">--- tomcat-mynet-2 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 31ms</span><br><span class="line">rtt min/avg/max/mdev = 0.077/0.089/0.096/0.008 ms</span><br><span class="line">$ docker <span class="built_in">exec</span> -it tomcat-mynet-2 ping tomcat-mynet-1</span><br><span class="line">PING tomcat-mynet-1 (172.11.0.3) 56(84) bytes of data.</span><br><span class="line">64 bytes from tomcat-mynet-1.mynet (172.11.0.3): icmp_seq=1 ttl=64 time=0.092 ms</span><br><span class="line">64 bytes from tomcat-mynet-1.mynet (172.11.0.3): icmp_seq=2 ttl=64 time=0.080 ms</span><br><span class="line">64 bytes from tomcat-mynet-1.mynet (172.11.0.3): icmp_seq=3 ttl=64 time=0.072 ms</span><br><span class="line">^C</span><br><span class="line">--- tomcat-mynet-1 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 38ms</span><br><span class="line">rtt min/avg/max/mdev = 0.072/0.081/0.092/0.011 ms</span><br></pre></td></tr></table></figure><p><strong>åˆ›å»ºä½¿ç”¨é»˜è®¤ç½‘ç»œçš„å®¹å™¨</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d --name tomcat-docker0 tomcat</span><br><span class="line">e8408dbf5c1e3ddbe0adfee16ab9c8965f9889c55299e50ce1db381401f26c2a</span><br></pre></td></tr></table></figure><p><strong>æµ‹è¯•ä¸åŒç½‘ç»œçš„å®¹å™¨çš„è¿é€šæ€§</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it tomcat-mynet-1 ping tomcat-docker0</span><br><span class="line">ping: tomcat-docker0: Name or service not known</span><br></pre></td></tr></table></figure><p>å‘ç°ä¸åŒç½‘ç»œå†…çš„å®¹å™¨å¹¶ä¸ç›¸é€šã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Œçœ‹ä¸‹å›¾ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-11-08_16-39-40.png" alt="Snipaste_2020-11-08_16-39-40"></p><h3 id="ç½‘ç»œæ‰“é€š"><a href="#ç½‘ç»œæ‰“é€š" class="headerlink" title="ç½‘ç»œæ‰“é€š"></a>ç½‘ç»œæ‰“é€š</h3><p>è§£å†³åŠæ³•ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-11-08_16-41-09.png" alt="Snipaste_2020-11-08_16-41-09"></p><p>åŸç†ï¼šå‡å¦‚ä½¿<code>tomcat-mynet-1</code>è¿æ¥åˆ°<code>tomcat-docker0</code>ï¼Œåˆ™åœ¨<code>tomcat-mynet-1</code>å·²æœ‰ç½‘ç»œçš„åŸºç¡€ä¸Šå†æ¬¡æ·»åŠ ä¸€ä¸ªdocker0ç½‘ç»œçš„IPã€‚<font color="red"><strong>å³ä¸€ä¸ªå®¹å™¨å¤šä¸ªIP</strong></font></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker network  connect bridge tomcat-mynet-1</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æˆ‘ä»¬æŸ¥çœ‹<code>tomcat-mynet-1</code>çš„ç½‘ç»œä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker inspect tomcat-mynet-1</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&quot;Networks&quot;: &#123;</span><br><span class="line">               &quot;bridge&quot;: &#123;</span><br><span class="line">                   &quot;IPAMConfig&quot;: &#123;&#125;,</span><br><span class="line">                   &quot;Links&quot;: null,</span><br><span class="line">                   &quot;Aliases&quot;: [],</span><br><span class="line">                   &quot;NetworkID&quot;: &quot;fe5399aad1b445bf0dce36a7ed705e597714226a4872986a49a70aea9443e795&quot;,</span><br><span class="line">                   &quot;EndpointID&quot;: &quot;4781b0bb8330308ba0c4d2e64c11edd29ab03cc8d0afadcca0ae3279af7b95a3&quot;,</span><br><span class="line">                   &quot;Gateway&quot;: &quot;172.17.0.1&quot;,</span><br><span class="line">                   &quot;IPAddress&quot;: &quot;172.17.0.3&quot;,</span><br><span class="line">                   &quot;IPPrefixLen&quot;: 16,</span><br><span class="line">                   &quot;IPv6Gateway&quot;: &quot;&quot;,</span><br><span class="line">                   &quot;GlobalIPv6Address&quot;: &quot;&quot;,</span><br><span class="line">                   &quot;GlobalIPv6PrefixLen&quot;: 0,</span><br><span class="line">                   &quot;MacAddress&quot;: &quot;02:42:ac:11:00:03&quot;,</span><br><span class="line">                   &quot;DriverOpts&quot;: &#123;&#125;</span><br><span class="line">               &#125;,</span><br><span class="line">               &quot;mynet&quot;: &#123;</span><br><span class="line">                   &quot;IPAMConfig&quot;: null,</span><br><span class="line">                   &quot;Links&quot;: null,</span><br><span class="line">                   &quot;Aliases&quot;: [</span><br><span class="line">                       &quot;97cf9d5c3505&quot;</span><br><span class="line">                   ],</span><br><span class="line">                   &quot;NetworkID&quot;: &quot;b2c091bf96ebf3ea4ff0ed3427d36b83c31632d8b52aaf2b67afda26b2c54a5f&quot;,</span><br><span class="line">                   &quot;EndpointID&quot;: &quot;bf315a5c26ab09131c88acefb291652c507b8c04d51e678d7370e108771eec55&quot;,</span><br><span class="line">                   &quot;Gateway&quot;: &quot;172.11.0.1&quot;,</span><br><span class="line">                   &quot;IPAddress&quot;: &quot;172.11.0.3&quot;,</span><br><span class="line">                   &quot;IPPrefixLen&quot;: 16,</span><br><span class="line">                   &quot;IPv6Gateway&quot;: &quot;&quot;,</span><br><span class="line">                   &quot;GlobalIPv6Address&quot;: &quot;&quot;,</span><br><span class="line">                   &quot;GlobalIPv6PrefixLen&quot;: 0,</span><br><span class="line">                   &quot;MacAddress&quot;: &quot;02:42:ac:0b:00:03&quot;,</span><br><span class="line">                   &quot;DriverOpts&quot;: null</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å‘ç°æ­¤å®¹å™¨åŒæ—¶æœ‰2ä¸ªIPï¼š</p><ul><li>172.11.0.3</li><li>172.17.0.3</li></ul><p><del>æ­£å› ä¸ºå®ƒä¹Ÿåœ¨ç½‘ç»œ<code>bridge</code>ä¸­ï¼Œæ‰€ä»¥å®ƒèƒ½è¿é€š<code>tomcat-docker0</code></del>ï¼Œå‘ç°ä¹Ÿè¿ä¸é€šï¼Œæ‰æƒ³åˆ°é»˜è®¤ç½‘å¡docker0==bridgeæ˜¯å®¹å™¨äº’è”ä¸æ”¯æŒçš„ã€‚</p><p>ä»¥ä¸‹æ–°å»ºä¸€ä¸ªç½‘ç»œ<code>mynet1</code>ï¼Œåˆ›å»ºå®¹å™¨<code>tomcat-mynet1-1</code>ï¼Œå¹¶å°†å®¹å™¨<code>tomcat-mynet-1</code>åŠ å…¥ç½‘ç»œ<code>mynet1</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker network create --subnet 172.13.0.0 --gateway 172.13.0.1 mynet1</span><br><span class="line">invalid subnet: invalid CIDR address: 172.13.0.0</span><br><span class="line">$ docker network create --subnet 172.13.0.0/16 --gateway 172.13.0.1 mynet1</span><br><span class="line">00e7d460e27849646a4be5fe5f2773ac698f014377391ccb3a8ea637f09c3e49</span><br><span class="line">$ docker run --name tomcat-mynet1-1 -d --network=mynet1 tomcat</span><br><span class="line">219598c82425458a509294e3efdc5d4f1ac8088ae8edbcc67297da641cfe138e</span><br><span class="line">$ docker network connect mynet1 tomcat-mynet-1</span><br></pre></td></tr></table></figure><p><font color="red"><strong>æµ‹è¯•ç½‘ç»œæ‰“é€š</strong></font></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it tomcat-mynet-1 ping tomcat-mynet1-1</span><br><span class="line">PING tomcat-mynet1-1 (172.13.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from tomcat-mynet1-1.mynet1 (172.13.0.2): icmp_seq=1 ttl=64 time=0.140 ms</span><br><span class="line">64 bytes from tomcat-mynet1-1.mynet1 (172.13.0.2): icmp_seq=2 ttl=64 time=0.081 ms</span><br><span class="line">^C</span><br><span class="line">--- tomcat-mynet1-1 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 5ms</span><br><span class="line">rtt min/avg/max/mdev = 0.081/0.110/0.140/0.031 ms</span><br><span class="line">$ docker <span class="built_in">exec</span> -it tomcat-mynet-2 ping tomcat-mynet1-1</span><br><span class="line">ping: tomcat-mynet1-1: Name or service not known</span><br></pre></td></tr></table></figure><blockquote><p>ç»“è®ºï¼šå‘ç°é…ç½®äº†ç½‘ç»œ<code>mynet1</code>çš„å®¹å™¨<code>tomcat-mynet-1</code>èƒ½è¿é€š<code>tomcat-mynet1-1</code>ï¼Œè€Œæ²¡æœ‰æ‰“é€šç½‘ç»œçš„å®¹å™¨<code>tomcat-mynet-2</code>åˆ™ä¸è¡Œã€‚<font color="red">è¿™è¯æ˜äº†æˆ‘ä»¬çš„é…ç½®æ˜¯æ­£ç¡®çš„ã€‚åŸç†ï¼šä¸€ä¸ªå®¹å™¨å¤šä¸ªIP</font></p></blockquote><blockquote><p>æ³¨æ„ï¼šå¦å¤–ä¸ä½¿ç”¨çš„ç½‘ç»œä¹Ÿå¯ä»¥é€šè¿‡<code>docker network prune</code>æ¥æ¸…é™¤ã€‚å®ƒä¸åƒæ•°æ®å·å ç”¨å¤§é‡ç©ºé—´ï¼Œä¹Ÿä¸ç”¨ç»å¸¸åœ¨æ„ã€‚</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Dockerç½‘ç»œ&quot;&gt;&lt;a href=&quot;#Dockerç½‘ç»œ&quot; class=&quot;headerlink&quot; title=&quot;Dockerç½‘ç»œ&quot;&gt;&lt;/a&gt;Dockerç½‘ç»œ&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;Docker å…è®¸é€šè¿‡å¤–éƒ¨è®¿é—®å®¹å™¨æˆ–å®¹å™¨äº’è”çš„æ–¹å¼æ¥æä¾›ç½‘ç»œæœåŠ¡ã€‚</summary>
      
    
    
    
    <category term="Docker" scheme="https://awslzhang.top/categories/Docker/"/>
    
    
    <category term="Docker" scheme="https://awslzhang.top/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>Dockeræ•°æ®å·</title>
    <link href="https://awslzhang.top/2020/11/13/Docker%E6%95%B0%E6%8D%AE%E5%8D%B7/"/>
    <id>https://awslzhang.top/2020/11/13/Docker%E6%95%B0%E6%8D%AE%E5%8D%B7/</id>
    <published>2020-11-13T11:33:38.000Z</published>
    <updated>2021-01-01T05:49:59.916Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®å·"><a href="#ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®å·" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®å·"></a>ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®å·</h1><p>è¿™å¾—ä» docker å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿè¯´èµ·ã€‚å‡ºäºæ•ˆç‡ç­‰ä¸€ç³»åˆ—åŸå› ï¼Œdocker å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿåœ¨å®¿ä¸»æœºä¸Šå­˜åœ¨çš„æ–¹å¼å¾ˆå¤æ‚ï¼Œè¿™ä¼šå¸¦æ¥ä¸‹é¢å‡ ä¸ªé—®é¢˜ï¼š</p><ul><li>ä¸èƒ½åœ¨å®¿ä¸»æœºä¸Šå¾ˆæ–¹ä¾¿åœ°è®¿é—®å®¹å™¨ä¸­çš„æ–‡ä»¶ã€‚</li><li>æ— æ³•åœ¨å¤šä¸ªå®¹å™¨ä¹‹é—´å…±äº«æ•°æ®ã€‚</li><li><font color="red">å½“å®¹å™¨åˆ é™¤æ—¶ï¼Œå®¹å™¨ä¸­äº§ç”Ÿçš„æ•°æ®å°†ä¸¢å¤±ã€‚</font></li></ul><p>è¿™æ ·æ¯”å¦‚è¯´ä½ å¯åŠ¨äº†ä¸€ä¸ªMySQLå®¹å™¨ï¼Œä¹‹åæ·»åŠ çš„æ•°æ®å…¨åœ¨å®¹å™¨ä¸­ï¼Œå½“æŸå¤©å®¹å™¨è¢«åˆ é™¤æ•°æ®éšä¹‹åˆ é™¤ï¼Œå¹¶ä¸èƒ½åšåˆ°æ•°æ®çš„æŒä¹…åŒ–ã€‚</p><hr><p>ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œdocker å¼•å…¥äº†<strong>æ•°æ®å·(volume) æœºåˆ¶</strong>ã€‚æ•°æ®å·æ˜¯å­˜åœ¨äºä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ä¸­çš„ç‰¹å®š<font color="red"><strong>æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹</strong></font>ï¼Œè¿™ä¸ªæ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ä»¥ç‹¬ç«‹äº docker æ–‡ä»¶ç³»ç»Ÿçš„å½¢å¼å­˜åœ¨äºå®¿ä¸»æœºä¸­ã€‚æ•°æ®å·çš„æœ€å¤§ç‰¹å®šæ˜¯ï¼š<font color="red"><strong>å…¶ç”Ÿå­˜å‘¨æœŸç‹¬ç«‹äºå®¹å™¨çš„ç”Ÿå­˜å‘¨æœŸ</strong></font></p><h1 id="æ•°æ®å·"><a href="#æ•°æ®å·" class="headerlink" title="æ•°æ®å·"></a>æ•°æ®å·</h1><p><code>æ•°æ®å·</code> æ˜¯ä¸€ä¸ªå¯ä¾›ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ä½¿ç”¨çš„ç‰¹æ®Šç›®å½•ï¼Œå®ƒç»•è¿‡ UFSï¼Œå¯ä»¥æä¾›å¾ˆå¤šæœ‰ç”¨çš„ç‰¹æ€§ï¼š</p><ul><li><code>æ•°æ®å·</code> å¯ä»¥åœ¨å®¹å™¨ä¹‹é—´å…±äº«å’Œé‡ç”¨</li><li>å¯¹ <code>æ•°æ®å·</code> çš„ä¿®æ”¹ä¼šç«‹é©¬ç”Ÿæ•ˆ</li><li>å¯¹ <code>æ•°æ®å·</code> çš„æ›´æ–°ï¼Œä¸ä¼šå½±å“é•œåƒ</li><li><code>æ•°æ®å·</code> é»˜è®¤ä¼šä¸€ç›´å­˜åœ¨ï¼Œå³ä½¿å®¹å™¨è¢«åˆ é™¤</li></ul><blockquote><p>æ³¨æ„ï¼š<code>æ•°æ®å·</code> çš„ä½¿ç”¨ï¼Œç±»ä¼¼äº Linux ä¸‹å¯¹ç›®å½•æˆ–æ–‡ä»¶è¿›è¡Œ mountï¼Œé•œåƒä¸­çš„è¢«æŒ‡å®šä¸ºæŒ‚è½½ç‚¹çš„ç›®å½•ä¸­çš„æ–‡ä»¶ä¼šå¤åˆ¶åˆ°æ•°æ®å·ä¸­ï¼ˆä»…æ•°æ®å·ä¸ºç©ºæ—¶ä¼šå¤åˆ¶ï¼‰ã€‚</p></blockquote><blockquote><p>æ³¨æ„ï¼šæŒ‚è½½æ•°æ®å·æ—¶ï¼Œåˆ†åˆ«å¯ä»¥æ˜¯ç›®å½•æˆ–æ–‡ä»¶ï¼Œå®ƒåªèƒ½åŒ…å«ä¸¤ç§å¯èƒ½ï¼šç›®å½•:ç›®å½•ï¼›æ–‡ä»¶:æ–‡ä»¶</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-11-12_15-10-00.png" alt="s"></p><h2 id="åˆ›å»ºä¸€ä¸ªæ•°æ®å·"><a href="#åˆ›å»ºä¸€ä¸ªæ•°æ®å·" class="headerlink" title="åˆ›å»ºä¸€ä¸ªæ•°æ®å·"></a>åˆ›å»ºä¸€ä¸ªæ•°æ®å·</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume create my-vol</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æ‰€æœ‰çš„ <code>æ•°æ®å·</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker volume ls</span><br><span class="line">DRIVER              VOLUME NAMElocal               my-vol</span><br></pre></td></tr></table></figure><p>åœ¨ä¸»æœºé‡Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹æŒ‡å®š <code>æ•°æ®å·</code> çš„ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ docker volume inspect my-vol</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&quot;Mountpoint&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/my-vol/_data&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;my-vol&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h2 id="å¯åŠ¨ä¸€ä¸ªæŒ‚è½½æ•°æ®å·çš„å®¹å™¨"><a href="#å¯åŠ¨ä¸€ä¸ªæŒ‚è½½æ•°æ®å·çš„å®¹å™¨" class="headerlink" title="å¯åŠ¨ä¸€ä¸ªæŒ‚è½½æ•°æ®å·çš„å®¹å™¨"></a>å¯åŠ¨ä¸€ä¸ªæŒ‚è½½æ•°æ®å·çš„å®¹å™¨</h2><p>æˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªæŒ‚åœ¨æ•°æ®å·çš„å®¹å™¨æ—¶ä¸€å®šè¦å‚ç…§å®˜æ–¹æ–‡æ¡£ï¼Œä»¥å®ç°MySQLçš„æŒä¹…åŒ–æ•°æ®ä¸ºç›®çš„æ¥å®ç°å¯åŠ¨ä¸€ä¸ªæŒ‚è½½æ•°æ®å·çš„å®¹å™¨ã€‚</p><p>é€šè¿‡è¿æ¥ï¼š<a href="https://hub.docker.com/_/mysql%E4%B8%AD%E7%9A%84%E5%86%85%E5%AE%B9%EF%BC%9A">https://hub.docker.com/_/mysqlä¸­çš„å†…å®¹ï¼š</a></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/mysql.png"></p><p>ä»¥ä¸Šå¾—çŸ¥MySQLçš„æ•°æ®å­˜æ”¾åœ¨å®¹å™¨ä¸­çš„<code>/var/lib/mysql</code>ç›®å½•ä¸­ï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥å°†å®¿ä¸»æœºçš„ä¸€ä¸ªç›®å½•å’Œå…¶ç»‘å®šã€‚å…·ä½“æœ‰å¤šç§æŒ‚è½½æ–¹å¼ï¼š</p><ul><li>åŒ¿åæŒ‚è½½</li><li>å…·åæŒ‚è½½</li><li>æŒ‡å®šç›®å½•æŒ‚è½½</li></ul><p>ä»¥æŒ‡å®šç›®å½•æŒ‚è½½ä¸ºä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --name some-mysql -v /my/own/datadir:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7</span><br></pre></td></tr></table></figure><h2 id="æŸ¥çœ‹æ•°æ®å·çš„å…·ä½“ä¿¡æ¯"><a href="#æŸ¥çœ‹æ•°æ®å·çš„å…·ä½“ä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹æ•°æ®å·çš„å…·ä½“ä¿¡æ¯"></a>æŸ¥çœ‹æ•°æ®å·çš„å…·ä½“ä¿¡æ¯</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker inspect some-mysql</span><br></pre></td></tr></table></figure><p>æˆªå–åˆ°æ•°æ®å·çš„ä¿¡æ¯ï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&quot;Mounts&quot;: [</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;bind&quot;</span>,</span><br><span class="line">               <span class="attr">&quot;Source&quot;</span>: <span class="string">&quot;/my/own/datadir&quot;</span>,</span><br><span class="line">               <span class="attr">&quot;Destination&quot;</span>: <span class="string">&quot;/var/lib/mysql&quot;</span>,</span><br><span class="line">               <span class="attr">&quot;Mode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">               <span class="attr">&quot;RW&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">               <span class="attr">&quot;Propagation&quot;</span>: <span class="string">&quot;rprivate&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       ]</span><br></pre></td></tr></table></figure><h2 id="åˆ é™¤æ•°æ®å·"><a href="#åˆ é™¤æ•°æ®å·" class="headerlink" title="åˆ é™¤æ•°æ®å·"></a>åˆ é™¤æ•°æ®å·</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker volume rm my-vol</span><br></pre></td></tr></table></figure><p><code>æ•°æ®å·</code> æ˜¯è¢«è®¾è®¡ç”¨æ¥æŒä¹…åŒ–æ•°æ®çš„ï¼Œ<font color="red">å®ƒçš„ç”Ÿå‘½å‘¨æœŸç‹¬ç«‹äºå®¹å™¨ï¼ŒDocker ä¸ä¼šåœ¨å®¹å™¨è¢«åˆ é™¤åè‡ªåŠ¨åˆ é™¤ <code>æ•°æ®å·</code>ï¼Œå¹¶ä¸”ä¹Ÿä¸å­˜åœ¨åƒåœ¾å›æ”¶è¿™æ ·çš„æœºåˆ¶æ¥å¤„ç†æ²¡æœ‰ä»»ä½•å®¹å™¨å¼•ç”¨çš„ <code>æ•°æ®å·</code>ã€‚</font>å¦‚æœéœ€è¦åœ¨åˆ é™¤å®¹å™¨çš„åŒæ—¶ç§»é™¤æ•°æ®å·ã€‚å¯ä»¥åœ¨åˆ é™¤å®¹å™¨çš„æ—¶å€™ä½¿ç”¨ <code>docker rm -v</code> è¿™ä¸ªå‘½ä»¤ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/volume.png"></p><hr><p><font color="red"><strong>æ— ä¸»çš„æ•°æ®å·å¯èƒ½ä¼šå æ®å¾ˆå¤šç©ºé—´ï¼Œè¦æ¸…ç†è¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤</strong></font></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker volume prune</span><br></pre></td></tr></table></figure><h1 id="æ•°æ®å·æŒ‚è½½ç§ç±»"><a href="#æ•°æ®å·æŒ‚è½½ç§ç±»" class="headerlink" title="æ•°æ®å·æŒ‚è½½ç§ç±»"></a>æ•°æ®å·æŒ‚è½½ç§ç±»</h1><h2 id="åŒ¿åæŒ‚è½½"><a href="#åŒ¿åæŒ‚è½½" class="headerlink" title="åŒ¿åæŒ‚è½½"></a>åŒ¿åæŒ‚è½½</h2><p>åŒ¿åæŒ‚è½½å°±æ˜¯åœ¨æ•°æ®å·æŒ‚è½½æ—¶ä¸æŒ‡å®šåç§°ï¼Œç›´æ¥è¾“å…¥è¦æŒ‚è½½çš„å®¹å™¨å†…çš„è·¯å¾„å³å¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --name some-mysql1 -v /var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7</span><br></pre></td></tr></table></figure><p><strong>é‚£ä¹ˆæ­¤å®¹å™¨çš„æ•°æ®å·æŒ‚è½½åˆ°å®¿ä¸»æœºçš„å“ªäº†ï¼Ÿ</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker inspect some-mysql1</span><br></pre></td></tr></table></figure><p>æˆªå–åˆ°æ•°æ®å·çš„ä¿¡æ¯ï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&quot;Mounts&quot;: [</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;volume&quot;</span>,</span><br><span class="line">               <span class="attr">&quot;Name&quot;</span>: <span class="string">&quot;8ca6908c31d8fdfe15bd9b2abad40e602d567980501cef921ea5437ae3df7bd6&quot;</span>,</span><br><span class="line">               <span class="attr">&quot;Source&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/8ca6908c31d8fdfe15bd9b2abad40e602d567980501cef921ea5437ae3df7bd6/_data&quot;</span>,</span><br><span class="line">               <span class="attr">&quot;Destination&quot;</span>: <span class="string">&quot;/var/lib/mysql&quot;</span>,</span><br><span class="line">               <span class="attr">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">               <span class="attr">&quot;Mode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">               <span class="attr">&quot;RW&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">               <span class="attr">&quot;Propagation&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       ]</span><br></pre></td></tr></table></figure><p>å‘ç°æ•°æ®å·åä¸ºï¼š<code>8ca6908c31d8fdfe15bd9b2abad40e602d567980501cef921ea5437ae3df7bd6</code>ï¼ŒæŒ‚è½½åˆ°äº†<code>/var/lib/docker/volumes/8ca6908c31d8fdfe15bd9b2abad40e602d567980501cef921ea5437ae3df7bd6/_data</code></p><h2 id="å…·åæŒ‚è½½"><a href="#å…·åæŒ‚è½½" class="headerlink" title="å…·åæŒ‚è½½"></a>å…·åæŒ‚è½½</h2><p>åŒ¿åæŒ‚è½½å°±æ˜¯åœ¨æ•°æ®å·æŒ‚è½½æ—¶æŒ‡å®šæ•°æ®å·åç§°(<strong>é‚£ä¹ˆæ­¤æ—¶å°±ä¸èƒ½è¾“å…¥å®¿ä¸»æœºè·¯å¾„äº†</strong>)ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --name some-mysql2 -v mydata:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7</span><br></pre></td></tr></table></figure><p><strong>é€šè¿‡æ•°æ®å·æŸ¥çœ‹å‘½ä»¤å¾—åˆ°æœ‰åç§°çš„æ•°æ®å·</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker volume ls</span><br><span class="line">DRIVER              VOLUME NAME</span><br><span class="line"><span class="built_in">local</span>               8ca6908c31d8fdfe15bd9b2abad40e602d567980501cef921ea5437ae3df7bd6</span><br><span class="line"><span class="built_in">local</span>               mydata</span><br></pre></td></tr></table></figure><h2 id="æŒ‡å®šç›®å½•æŒ‚è½½"><a href="#æŒ‡å®šç›®å½•æŒ‚è½½" class="headerlink" title="æŒ‡å®šç›®å½•æŒ‚è½½"></a>æŒ‡å®šç›®å½•æŒ‚è½½</h2><p>æ‰‹åŠ¨æŒ‡å®šå®¿ä¸»æœºçš„ç›®å½•/æ–‡ä»¶å’Œå®¹å™¨çš„ç›®å½•/æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --name some-mysql -v /my/own/datadir:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7</span><br></pre></td></tr></table></figure><hr><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æˆ‘ä»¬é€šè¿‡å…·åæŒ‚è½½å¯ä»¥æ–¹ä¾¿çš„æ‰¾åˆ°æˆ‘ä»¬çš„ä¸€ä¸ªå·ï¼Œå¤§å¤šæ•°æƒ…å†µåœ¨ä½¿ç”¨çš„ï¼Œä¸å»ºè®®å¤§å®¶ä½¿ç”¨åŒ¿åæŒ‚è½½</p><p>å¦‚ä½•ç¡®å®šæ˜¯åŒ¿åæŒ‚è½½è¿˜æ˜¯å…·åæŒ‚è½½å‘¢ï¼Ÿ</p><ul><li>-v å®¹å™¨å†…è·¯å¾„         #åŒ¿åæŒ‚è½½</li><li>-v å·åï¼šå®¹å™¨å†…è·¯å¾„      #å…·åæŒ‚è½½</li><li>-v /å®¿ä¸»æœºè·¯å¾„ï¼šå®¹å™¨å†…è·¯å¾„   #æŒ‡å®šè·¯å¾„æŒ‚è½½</li></ul><h1 id="æ•°æ®å·æƒé™"><a href="#æ•°æ®å·æƒé™" class="headerlink" title="æ•°æ®å·æƒé™"></a>æ•°æ®å·æƒé™</h1><p><strong>é€šè¿‡ <code>-v </code>å®¹å™¨å†…è·¯å¾„:ro rw æ”¹å˜è¯»å†™æƒé™</strong></p><ul><li><code>ro</code>ï¼šreadonly  #åªè¯»</li><li><code>rw</code>ï¼šreadwrite #å¯è¯»å¯å†™</li></ul><p>ä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -P --name nginx02 -v juming-nginx:/etc/nginx:ro  nginx</span><br></pre></td></tr></table></figure><blockquote><p>åªè¦çœ‹åˆ°roå°±è¯´æ˜è¿™ä¸ªè·¯å¾„åªèƒ½é€šè¿‡å®¿ä¸»æœºæ¥æ”¹å˜ï¼Œ<font color="red">å®¹å™¨å†…éƒ¨æ˜¯æ— æ³•æ“ä½œçš„</font></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®å·&quot;&gt;&lt;a href=&quot;#ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®å·&quot; class=&quot;headerlink&quot; title=&quot;ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®å·&quot;&gt;&lt;/a&gt;ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®å·&lt;/h1&gt;&lt;p&gt;è¿™å¾—ä» docker å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿè¯´èµ·ã€‚å‡ºäºæ•ˆç‡ç­‰ä¸€ç³»åˆ—åŸå› ï¼Œdocker å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿ</summary>
      
    
    
    
    <category term="Docker" scheme="https://awslzhang.top/categories/Docker/"/>
    
    
    <category term="Docker" scheme="https://awslzhang.top/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>æ„å»ºé•œåƒä¹‹Dockerfile</title>
    <link href="https://awslzhang.top/2020/11/07/%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F%E4%B9%8BDockerfile/"/>
    <id>https://awslzhang.top/2020/11/07/%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F%E4%B9%8BDockerfile/</id>
    <published>2020-11-07T03:27:38.000Z</published>
    <updated>2021-01-01T05:50:00.099Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h1><p>Dockeré€šè¿‡ä»ä¸€ä¸ª<code>Dockerfile</code>æ–‡æœ¬æ–‡ä»¶ä¸­è¯»å–æŒ‡ä»¤æ¥è‡ªåŠ¨æ„å»ºæ˜ åƒï¼Œè¯¥ æ–‡æœ¬æ–‡ä»¶æŒ‰é¡ºåºåŒ…å«æ„å»ºç»™å®šæ˜ åƒæ‰€éœ€çš„æ‰€æœ‰å‘½ä»¤ã€‚<code>Dockerfile</code>éµå¾ªç‰¹å®šçš„æ ¼å¼å’ŒæŒ‡ä»¤é›†ï¼Œæ‚¨å¯ä»¥åœ¨<a href="https://docs.docker.com/engine/reference/builder/">Dockerfileå‚è€ƒä¸­</a>æ‰¾åˆ°ã€‚</p><p>Dockeræ˜ åƒç”±åªè¯»å±‚ç»„æˆï¼Œæ¯ä¸ªåªè¯»å±‚ä»£è¡¨ä¸€ä¸ªDockerfileæŒ‡ä»¤ã€‚è¿™äº›å±‚æ˜¯å †å çš„ï¼Œæ¯ä¸ªå±‚éƒ½æ˜¯ä¸Šä¸€å±‚çš„å˜åŒ–çš„å¢é‡ã€‚è€ƒè™‘ä¸€ä¸‹<code>Dockerfile</code>ï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">18.04</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . /app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> make /app</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> python /app/app.py</span></span><br></pre></td></tr></table></figure><p>æ¯æ¡æŒ‡ä»¤åˆ›å»ºä¸€å±‚ï¼š</p><ul><li><code>FROM</code>ä»<code>ubuntu:18.04</code>Dockeræ˜ åƒåˆ›å»ºä¸€ä¸ªå›¾å±‚ã€‚</li><li><code>COPY</code> ä»Dockerå®¢æˆ·ç«¯çš„å½“å‰ç›®å½•æ·»åŠ æ–‡ä»¶ã€‚</li><li><code>RUN</code>ä½¿ç”¨æ„å»ºæ‚¨çš„åº”ç”¨ç¨‹åº<code>make</code>ã€‚</li><li><code>CMD</code> æŒ‡å®šè¦åœ¨å®¹å™¨ä¸­è¿è¡Œçš„å‘½ä»¤ã€‚</li></ul><p>è¿è¡Œå›¾åƒå¹¶ç”Ÿæˆå®¹å™¨æ—¶ï¼Œå¯ä»¥ åœ¨åŸºç¡€å±‚ä¹‹ä¸Šæ·»åŠ ä¸€ä¸ªæ–°çš„<em>å¯å†™å±‚</em>ï¼ˆâ€œå®¹å™¨å±‚â€ï¼‰ã€‚å¯¹è¿è¡Œä¸­çš„å®¹å™¨æ‰€åšçš„æ‰€æœ‰æ›´æ”¹ï¼ˆä¾‹å¦‚å†™å…¥æ–°æ–‡ä»¶ï¼Œä¿®æ”¹ç°æœ‰æ–‡ä»¶å’Œåˆ é™¤æ–‡ä»¶ï¼‰éƒ½å°†å†™å…¥æ­¤è–„å¯å†™å®¹å™¨å±‚ã€‚</p><h2 id="ç”¨æ³•"><a href="#ç”¨æ³•" class="headerlink" title="ç”¨æ³•"></a>ç”¨æ³•</h2><p><code>docker build</code>å‘½ä»¤ä»ä¸€ä¸ªæ„å»ºçš„å›¾åƒ<code>Dockerfile</code>å’Œä¸€ä¸ª<em>ä¸Šä¸‹æ–‡</em>ã€‚æ„å»ºçš„ä¸Šä¸‹æ–‡æ˜¯æŒ‡å®šä½ç½®<code>PATH</code>æˆ–çš„æ–‡ä»¶é›†<code>URL</code>ã€‚è¿™<code>PATH</code>æ˜¯æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸Šçš„ç›®å½•ã€‚è¯¥<code>URL</code>æ˜¯ä¸€ä¸ªGitä»“åº“çš„ä½ç½®ã€‚</p><p>ä¸Šä¸‹æ–‡æ˜¯é€’å½’å¤„ç†çš„ã€‚å› æ­¤ï¼Œ<code>PATH</code>åŒ…æ‹¬ä»»ä½•å­ç›®å½•ï¼Œå¹¶ä¸”<code>URL</code>åŒ…æ‹¬å­˜å‚¨åº“åŠå…¶å­æ¨¡å—ã€‚æ­¤ç¤ºä¾‹æ˜¾ç¤ºäº†ä¸€ä¸ªä½¿ç”¨å½“å‰ç›®å½•ä½œä¸ºä¸Šä¸‹æ–‡çš„æ„å»ºå‘½ä»¤ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker build .</span><br><span class="line"></span><br><span class="line">Sending build context to Docker daemon  6.51 MB</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>æ„å»ºæ˜¯ç”±Dockerå®ˆæŠ¤ç¨‹åºè€Œä¸æ˜¯CLIè¿è¡Œçš„ã€‚ç”Ÿæˆè¿‡ç¨‹è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯å°†æ•´ä¸ªä¸Šä¸‹æ–‡ï¼ˆé€’å½’ï¼‰å‘é€åˆ°å®ˆæŠ¤ç¨‹åºã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ<strong>æœ€å¥½ä»ç©ºç›®å½•å¼€å§‹ä½œä¸ºä¸Šä¸‹æ–‡ï¼Œå¹¶å°†Dockerfileä¿ç•™åœ¨è¯¥ç›®å½•ä¸­ã€‚ä»…æ·»åŠ æ„å»ºDockerfileæ‰€éœ€çš„æ–‡ä»¶ã€‚</strong></p><blockquote><p><strong>è­¦å‘Š</strong></p><p>ä¸è¦ç”¨ä½ çš„æ ¹ç›®å½•ä¸‹ï¼Œ<code>/</code>ä½œä¸º<code>PATH</code>å› ä¸ºå®ƒä¼šå¯¼è‡´ç”Ÿæˆåˆ°æ‚¨çš„ç¡¬ç›˜é©±åŠ¨å™¨çš„å…¨éƒ¨å†…å®¹ä¼ è¾“åˆ°ç å¤´å·¥äººå®ˆæŠ¤è¿›ç¨‹ã€‚</p></blockquote><p>è¦åœ¨æ„å»ºä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨æ–‡ä»¶ï¼Œ<code>Dockerfile</code>å¼•ç”¨æ˜¯æŒ‡æŒ‡ä»¤ï¼ˆä¾‹å¦‚ï¼Œ<code>COPY</code>æŒ‡ä»¤ï¼‰ä¸­æŒ‡å®šçš„æ–‡ä»¶ã€‚è¦æé«˜æ„å»ºçš„æ€§èƒ½ï¼Œè¯·é€šè¿‡å°†<code>.dockerignore</code>æ–‡ä»¶æ·»åŠ åˆ°ä¸Šä¸‹æ–‡ç›®å½•æ¥æ’é™¤æ–‡ä»¶å’Œç›®å½•ã€‚æœ‰å…³å¦‚ä½•<a href="https://docs.docker.com/engine/reference/builder/#dockerignore-file">åˆ›å»º<code>.dockerignore</code> æ–‡ä»¶çš„ä¿¡æ¯ï¼Œ</a>è¯·å‚é˜…æ­¤é¡µé¢ä¸Šçš„æ–‡æ¡£ã€‚</p><p>ä¼ ç»Ÿä¸Šï¼Œ<code>Dockerfile</code>ç§°ä¸ºï¼Œ<code>Dockerfile</code>å¹¶ä¸”ä½äºä¸Šä¸‹æ–‡çš„æ ¹ä¸­ã€‚æ‚¨å¯ä»¥ä½¿ç”¨<code>-f</code>æ ‡å¿—with<code>docker build</code>æŒ‡å‘æ–‡ä»¶ç³»ç»Ÿä¸­ä»»æ„ä½ç½®çš„Dockerfileã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -f &#x2F;path&#x2F;to&#x2F;a&#x2F;Dockerfile .</span><br></pre></td></tr></table></figure><p>å¦‚æœæ„å»ºæˆåŠŸï¼Œåˆ™å¯ä»¥æŒ‡å®šå­˜å‚¨æ–°æ˜ åƒçš„å­˜å‚¨åº“å’Œæ ‡è®°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t shykes&#x2F;myapp .</span><br></pre></td></tr></table></figure><p>è¦åœ¨æ„å»ºåå°†æ˜ åƒæ ‡è®°åˆ°å¤šä¸ªå­˜å‚¨åº“ä¸­ï¼Œè¯·åœ¨<code>-t</code>è¿è¡Œ<code>build</code>å‘½ä»¤æ—¶æ·»åŠ å¤šä¸ªå‚æ•°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t shykes&#x2F;myapp:1.0.2 -t shykes&#x2F;myapp:latest .</span><br></pre></td></tr></table></figure><p>åœ¨Dockerå®ˆæŠ¤ç¨‹åºè¿è¡Œä¸­çš„æŒ‡ä»¤ä¹‹å‰<code>Dockerfile</code>ï¼Œå®ƒä¼šå¯¹è¿›è¡Œåˆæ­¥éªŒè¯ï¼Œ<code>Dockerfile</code>å¦‚æœè¯­æ³•ä¸æ­£ç¡®ï¼Œåˆ™è¿”å›é”™è¯¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t test&#x2F;myapp .</span><br><span class="line"></span><br><span class="line">Sending build context to Docker daemon 2.048 kB</span><br><span class="line">Error response from daemon: Unknown instruction: RUNCMD</span><br></pre></td></tr></table></figure><p>Dockerå®ˆæŠ¤ç¨‹åºä»¥<code>Dockerfile</code>ä¸€å¯¹ä¸€çš„æ–¹å¼è¿è¡ŒæŒ‡ä»¤ï¼Œå¦‚æœ‰å¿…è¦ï¼Œå°†æ¯æ¡æŒ‡ä»¤çš„ç»“æœæäº¤åˆ°æ–°æ˜ åƒï¼Œç„¶åæœ€ç»ˆè¾“å‡ºæ–°æ˜ åƒçš„IDã€‚Dockerå®ˆæŠ¤ç¨‹åºå°†è‡ªåŠ¨æ¸…ç†æ‚¨å‘é€çš„ä¸Šä¸‹æ–‡ã€‚</p><p><strong>è¯·æ³¨æ„ï¼Œæ¯æ¡æŒ‡ä»¤éƒ½æ˜¯ç‹¬ç«‹è¿è¡Œçš„ï¼Œå¹¶ä¼šå¯¼è‡´åˆ›å»ºæ–°æ˜ åƒ-å› æ­¤<code>RUN cd /tmp</code>å¯¹ä¸‹ä¸€æ¡æŒ‡ä»¤ä¸ä¼šæœ‰ä»»ä½•å½±å“ã€‚</strong></p><p>Dockerå°†å°½å¯èƒ½é‡ç”¨ä¸­é—´æ˜ åƒï¼ˆç¼“å­˜ï¼‰ï¼Œä»¥<code>docker build</code>æ˜¾ç€åŠ é€Ÿè¯¥è¿‡ç¨‹ã€‚è¿™ç”±<code>Using cache</code>æ§åˆ¶å°è¾“å‡ºä¸­çš„æ¶ˆæ¯æŒ‡ç¤ºã€‚ï¼ˆæœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§<a href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/"><code>Dockerfile</code>æœ€ä½³åšæ³•æŒ‡å—</a>ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t svendowideit&#x2F;ambassador .</span><br><span class="line"></span><br><span class="line">Sending build context to Docker daemon 15.36 kB</span><br><span class="line">Step 1&#x2F;4 : FROM alpine:3.2</span><br><span class="line"> ---&gt; 31f630c65071</span><br><span class="line">Step 2&#x2F;4 : MAINTAINER SvenDowideit@home.org.au</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 2a1c91448f5f</span><br><span class="line">Step 3&#x2F;4 : RUN apk update &amp;&amp;      apk add socat &amp;&amp;        rm -r &#x2F;var&#x2F;cache&#x2F;</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 21ed6e7fbb73</span><br><span class="line">Step 4&#x2F;4 : CMD env | grep _TCP&#x3D; | (sed &#39;s&#x2F;.*_PORT_\([0-9]*\)_TCP&#x3D;tcp:\&#x2F;\&#x2F;\(.*\):\(.*\)&#x2F;socat -t 100000000 TCP4-LISTEN:\1,fork,reuseaddr TCP4:\2:\3 \&amp;&#x2F;&#39; &amp;&amp; echo wait) | sh</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 7ea8aef582cc</span><br><span class="line">Successfully built 7ea8aef582cc</span><br></pre></td></tr></table></figure><h2 id="è¯­æ³•"><a href="#è¯­æ³•" class="headerlink" title="è¯­æ³•"></a>è¯­æ³•</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-11-07_11-36-19.png" alt="Snipaste_2020-11-07_11-36-19"></p><ul><li><code>CMD</code>ï¼šæŒ‡å®šå®¹å™¨å¯åŠ¨æ—¶è¦è¿è¡Œçš„å‘½ä»¤ï¼Œåªæœ‰æœ€åä¸€ä¸ªç”Ÿæ•ˆï¼Œå¯ä»¥è¢«æ›¿ä»£</li><li><code>ENTRYPOINT</code>ï¼šæŒ‡å®šå®¹å™¨å¯åŠ¨æ—¶è¦è¿è¡Œçš„å‘½ä»¤ï¼Œå¯ä»¥è¿½åŠ å‘½ä»¤</li><li><code>COPY</code>ï¼šæ‹·è´å®¿ä¸»æœºæ–‡ä»¶åˆ°é•œåƒ</li><li><code>ENV</code>ï¼šæ„å»ºæ—¶è®¾ç½®ç¯å¢ƒå˜é‡</li></ul><hr><blockquote><p><strong><code>ENTRYPOINT</code>ä¸<code>CMD</code></strong></p></blockquote><p><strong>CMD</strong></p><p>å½“Dockerfileä¸­ä½¿ç”¨CMDæ—¶ï¼Œé•œåƒåœ¨ï½’ï½•ï½æˆå®¹å™¨æ—¶ï¼Œcmdä¼šè¢«æ‰§è¡Œï¼Œä½†æ˜¯å½“ä½¿ç”¨docker runå‘½ä»¤æ‰§è¡Œé•œåƒæ—¶å¦‚æœæ‰‹åŠ¨åŠ å…¥æ‰§è¡Œå‘½ä»¤(docker run xxx ls -al)åˆ™CMDçš„å‘½ä»¤ä¼šè¢«è¦†ç›–ï¼Œä¸ä¼šæ‰§è¡Œã€‚</p><p>å½“Dockerfileä¸­ä½¿ç”¨ENTRYPOINTæ—¶ï¼Œé•œåƒåœ¨ï½’ï½•ï½æˆå®¹å™¨æ—¶ï¼ŒENTRYPOINTä¼šè¢«æ‰§è¡Œï¼Œä½†æ˜¯å½“ä½¿ç”¨docker runå‘½ä»¤æ‰§è¡Œé•œåƒæ—¶å¦‚æœæ‰‹åŠ¨åŠ å…¥æ‰§è¡Œå‘½ä»¤(docker run xxx -l)åˆ™æ–°å†™çš„å‘½ä»¤ä¼šè¢«è¿½åŠ åˆ°ENTRYPOINTå‘½ä»¤ä¹‹åã€‚</p><table><thead><tr><th>Dockerfile/(CMD/ENTRYPOINT)</th><th>docker run xxx -l</th><th>docker run xxx ls -al</th></tr></thead><tbody><tr><td>CMD [â€œlsâ€,â€-aâ€]</td><td>é”™è¯¯</td><td>ls -al</td></tr><tr><td>ENTRYPOINT [â€œlsâ€,â€-aâ€]</td><td>ls -al</td><td>ls -a -alï¼ˆé”™è¯¯ï¼‰</td></tr></tbody></table><h2 id="æ„å»ºæ­¥éª¤"><a href="#æ„å»ºæ­¥éª¤" class="headerlink" title="æ„å»ºæ­¥éª¤"></a>æ„å»ºæ­¥éª¤</h2><ol><li>ç¼–å†™<code>Dockerfile</code></li><li>docker buildæ„å»ºé•œåƒ</li><li>docker runè¿è¡Œ</li><li>docker pushåˆ°xxx</li></ol><h2 id="æ ·ä¾‹"><a href="#æ ·ä¾‹" class="headerlink" title="æ ·ä¾‹"></a>æ ·ä¾‹</h2><h3 id="jdké•œåƒ"><a href="#jdké•œåƒ" class="headerlink" title="jdké•œåƒ"></a>jdké•œåƒ</h3><p>è™½ç„¶æœ‰å®˜æ–¹çš„jdkï¼Œä½†æ˜¯ä¸ºäº†å±•ç¤ºæ„å»ºï¼Œè¿™é‡Œåœ¨centosçš„åŸºç¡€ä¸Šæ„å»ºjdkï¼š</p><p><strong>1. åˆ›å»º<code>Dockerfile</code>ï¼Œå†…å®¹ä¸ºï¼š</strong></p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"><span class="keyword">MAINTAINER</span> xxx&lt;xxx@xxx.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum -y install wget</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir /usr/<span class="built_in">local</span>/java &amp;&amp; <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/java &amp;&amp; wget -P /usr/<span class="built_in">local</span>/java https://repo.huaweicloud.com/java/jdk/11.0.2+9/jdk-11.0.2_linux-x64_bin.tar.gz &amp;&amp; tar -zxvf *.gz</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME /usr/local/java/jdk-<span class="number">11.0</span>.<span class="number">2</span></span><br><span class="line"><span class="keyword">ENV</span> PATH $JAVA_HOME/bin:$PATH</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">source</span> /etc/profile</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">&quot;/bin/bash&quot;</span>]</span></span><br></pre></td></tr></table></figure><p><strong>2. æ„å»º-</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t myjdk:1.0 .</span><br></pre></td></tr></table></figure><p><strong>3. è¿è¡Œ</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it myjdk:1.0</span><br></pre></td></tr></table></figure><h2 id="Push-Docker-Hub"><a href="#Push-Docker-Hub" class="headerlink" title="Push Docker Hub"></a>Push Docker Hub</h2><ol><li>åˆ›å»ºè´¦å·</li><li><code>dockr login -u xxx</code></li><li><code>docker push [OPTIONS] NAME[:TAG]  </code></li></ol><hr>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Dockerfile&quot;&gt;&lt;a href=&quot;#Dockerfile&quot; class=&quot;headerlink&quot; title=&quot;Dockerfile&quot;&gt;&lt;/a&gt;Dockerfile&lt;/h1&gt;&lt;p&gt;Dockeré€šè¿‡ä»ä¸€ä¸ª&lt;code&gt;Dockerfile&lt;/code&gt;æ–‡æœ¬æ–‡ä»¶</summary>
      
    
    
    
    <category term="Docker" scheme="https://awslzhang.top/categories/Docker/"/>
    
    
    <category term="Docker" scheme="https://awslzhang.top/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•è®©åˆ«äººè®¿é—®åˆ°ä½ çš„æœ¬åœ°é¡¹ç›®-å†…ç½‘ç©¿é€</title>
    <link href="https://awslzhang.top/2020/10/21/%E5%A6%82%E4%BD%95%E8%AE%A9%E5%88%AB%E4%BA%BA%E8%AE%BF%E9%97%AE%E5%88%B0%E4%BD%A0%E7%9A%84%E6%9C%AC%E5%9C%B0%E9%A1%B9%E7%9B%AE-%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/"/>
    <id>https://awslzhang.top/2020/10/21/%E5%A6%82%E4%BD%95%E8%AE%A9%E5%88%AB%E4%BA%BA%E8%AE%BF%E9%97%AE%E5%88%B0%E4%BD%A0%E7%9A%84%E6%9C%AC%E5%9C%B0%E9%A1%B9%E7%9B%AE-%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/</id>
    <published>2020-10-21T13:28:55.000Z</published>
    <updated>2021-01-01T05:50:00.077Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>é¦–å…ˆè¯´ä¸‹åŸå§‹éœ€æ±‚ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼ŒIPv4 ç½‘ç»œåœ°å€æ•°é‡éå¸¸æœ‰é™ï¼Œå¤§çº¦åªæœ‰ 43 äº¿ä¸ªåœ°å€ï¼Œå…¨çƒäº’è”ç½‘å‘å±•åˆ°å¦‚ä»Šçš„ç¨‹åº¦ï¼Œæ˜¾ç„¶ä¸å¯èƒ½æ¯å°è®¾å¤‡éƒ½åˆ†é…åˆ° IPv4 åœ°å€ã€‚</p><p>é‚£ç°åœ¨å®¶åº­å®½å¸¦æ˜¯æ€ä¹ˆè¿æ¥ç½‘ç»œçš„å‘¢ï¼Ÿè¿™é‡Œä¸€èˆ¬ä¼šä½¿ç”¨ NATï¼ˆNetwork Address Translationï¼Œç½‘ç»œåœ°å€è½¬æ¢ï¼‰åœ¨ä¸€ä¸ª IPv4 åœ°å€å†…éƒ¨æ‰©å±•å‡ºä¸€ä¸ªå†…éƒ¨ç½‘ç»œï¼Œä½¿è¿™ä¸ªå†…éƒ¨ç½‘ç»œå¯ä»¥æ­£å¸¸è¿æ¥åˆ°äº’è”ç½‘ã€‚æ­¤æ—¶å†…éƒ¨è®¾å¤‡å¯ä»¥æ­£å¸¸è®¿é—®å…¨çƒ IPv4 åœ°å€ï¼ˆå³å…¬ç½‘åœ°å€ï¼‰ï¼Œä½†æ˜¯å¤–éƒ¨çš„è®¾å¤‡åªèƒ½æ‰¾åˆ°è¿™ä¸ªå†…éƒ¨ç½‘ç»œå…±ç”¨çš„å…¨çƒ IPv4 åœ°å€ï¼Œè€Œæ²¡æ³•æ‰¾åˆ°ç»è¿‡ NAT ä¹‹åçš„å†…éƒ¨è®¾å¤‡åœ°å€ã€‚</p><p>è€ƒè™‘åˆ°å¤§éƒ¨åˆ†ç”¨æˆ·çš„ä¸»è¦éœ€æ±‚æ˜¯è·å–äº’è”ç½‘ä¸Šçš„å„ç§èµ„æºï¼Œå¹¶æ²¡æœ‰å¯¹å¤–æä¾›æœåŠ¡çš„éœ€æ±‚ï¼Œç°åœ¨å›½å†…è¿è¥å•†åœ¨å¤§éƒ¨åˆ†åŸå¸‚é»˜è®¤å·²ç»ä¸ä¼šç»™å®¶åº­å®½å¸¦ç”¨æˆ·åŠ¨æ€åˆ†é…å…¬ç½‘åœ°å€ï¼Œè€Œæ˜¯æ¢æˆäº†ä¸€å±‚æˆ–å¤šå±‚ NAT åçš„å†…ç½‘åœ°å€ã€‚å¹¶ä¸”ä¸€èˆ¬ç”¨æˆ·å‘é€æ•°æ®çš„éœ€æ±‚è¿œå°äºè·å–æ•°æ®çš„éœ€æ±‚ï¼Œæ‰€ä»¥å®¶åº­å®½å¸¦çš„ä¸Šä¸‹è¡Œå¸¦å®½ä¸€èˆ¬æ˜¯ä¸å¯¹ç­‰çš„ï¼Œä¾‹å¦‚æŸåœ°ç”µä¿¡å®½å¸¦ 500M ä¸‹è¡Œå¸¦å®½å¯¹åº”çš„ä¸Šè¡Œå¸¦å®½åªæœ‰ 30Mã€‚</p><p>æ­¤æ—¶ï¼Œå¯¹äº==ä¸€äº›æœ‰è¿œç¨‹è¿æ¥ã€è·å– NAS æ–‡ä»¶==ï¼Œæˆ–è€…ä¸´æ—¶è°ƒè¯•æœåŠ¡éœ€æ±‚çš„ç”¨æˆ·å°±ä¸å¤ªå‹å¥½äº†ã€‚</p><p>æœ‰çš„ç”µä¿¡ç½‘ç»œæ˜¯å¯ä»¥æ‰“å®¢æœç”³è¯·å…¬ç½‘IPçš„ï¼Œä½†æ˜¯å®¶åº­å®½å¸¦å®ƒé™åˆ¶äº†å¤§éƒ¨åˆ†å¸¸ç”¨çš„ç«¯å£ã€‚</p><p>å†…ç½‘ç©¿é€å·¥å…·å°±æ˜¯ä¸ºäº†è§£å†³ä¸Šè¿°çš„æ²¡æœ‰å…¬ç½‘ IP çš„é—®é¢˜çš„ã€‚</p><p>é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯è®©ä½ åœ¨å…¬ç½‘ç¯å¢ƒä¸‹èƒ½è®¿é—®åˆ°ä½ çš„æœ¬åœ°ç½‘ç»œ(æœ¬åœ°éœ€è”ç½‘)ã€‚</p><h1 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h1><p>å®¶é‡Œéƒ¨ç½²äº†ä¸€ä¸ªåšå®¢åœ°å€ï¼Œæƒ³ä»å¤–é¢çš„ç½‘ç»œç›´æ¥è®¿é—®åˆ°åšå®¢ï¼Œä½†æ˜¯ç”±äºæ²¡æœ‰å…¬ç½‘IPï¼Œæ‰€ä»¥å¾—å¦å¯»ä»–è·¯-å†…ç½‘ç©¿é€ã€‚è™½è¯´æ˜¯å†…ç½‘ï¼Œä½†æ˜¯ä½ å®¶çš„ç½‘ç»œä¹Ÿå¿…é¡»è”ç½‘çš„ã€‚</p><h1 id="frpç®€ä»‹"><a href="#frpç®€ä»‹" class="headerlink" title="frpç®€ä»‹"></a>frpç®€ä»‹</h1><p>frp æ˜¯ä¸€ä¸ªå¯ç”¨äºå†…ç½‘ç©¿é€çš„é«˜æ€§èƒ½çš„åå‘ä»£ç†åº”ç”¨ï¼Œæ”¯æŒ tcp, udp, http, https åè®®</p><p>åç§°å…¶å®å°±æ˜¯ä½¿ç”¨äº† Fast Reverse Proxy çš„é¦–å­—æ¯ç¼©å†™ã€‚</p><p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å¯ä»¥éšæ—¶éšåœ°é€šè¿‡<strong>æœ‰å…¬ç½‘ IP çš„æœåŠ¡å™¨</strong>ä¸­è½¬è¿æ¥åˆ°<strong>è¿è¡Œ frpc ç¨‹åºçš„ä»»æ„æœºå™¨çš„ä»»æ„ç«¯å£</strong>ã€‚</p><p><a href="https://gofrp.org/docs/">frpå®˜ç½‘ä¸­æ–‡æ–‡æ¡£åœ°å€</a></p><h2 id="å‰ç½®æ¡ä»¶ğŸ”º"><a href="#å‰ç½®æ¡ä»¶ğŸ”º" class="headerlink" title="å‰ç½®æ¡ä»¶ğŸ”º"></a>å‰ç½®æ¡ä»¶ğŸ”º</h2><ul><li>å…·æœ‰å…¬ç½‘IPçš„äº‘æœåŠ¡å™¨</li><li>å®¶åº­ç½‘ç»œï¼Œèƒ½è”ç½‘</li><li><a href="https://github.com/fatedier/frp/releases">é¡¹ç›®frp</a></li><li>ä¸€ä¸ªè§£æåˆ°äº‘æœåŠ¡å™¨çš„åŸŸå(==è®¿é—®webæœåŠ¡éœ€è¦==ï¼Œå…¶ä½™ä¸éœ€è¦)</li></ul><h2 id="frpå®‰è£…"><a href="#frpå®‰è£…" class="headerlink" title="frpå®‰è£…"></a>frpå®‰è£…</h2><p><a href="https://gofrp.org/docs/setup/">https://gofrp.org/docs/setup/</a></p><h3 id="å®ç°åŠŸèƒ½"><a href="#å®ç°åŠŸèƒ½" class="headerlink" title="å®ç°åŠŸèƒ½"></a>å®ç°åŠŸèƒ½</h3><h5 id="é€šè¿‡-SSH-è®¿é—®å†…ç½‘æœºå™¨"><a href="#é€šè¿‡-SSH-è®¿é—®å†…ç½‘æœºå™¨" class="headerlink" title="é€šè¿‡ SSH è®¿é—®å†…ç½‘æœºå™¨"></a><a href="https://gofrp.org/docs/examples/ssh/">é€šè¿‡ SSH è®¿é—®å†…ç½‘æœºå™¨</a></h5><h5 id="é€šè¿‡è‡ªå®šä¹‰åŸŸåè®¿é—®å†…ç½‘çš„-Web-æœåŠ¡"><a href="#é€šè¿‡è‡ªå®šä¹‰åŸŸåè®¿é—®å†…ç½‘çš„-Web-æœåŠ¡" class="headerlink" title="é€šè¿‡è‡ªå®šä¹‰åŸŸåè®¿é—®å†…ç½‘çš„ Web æœåŠ¡"></a><a href="https://gofrp.org/docs/examples/vhost-http/">é€šè¿‡è‡ªå®šä¹‰åŸŸåè®¿é—®å†…ç½‘çš„ Web æœåŠ¡</a></h5><h1 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h1><p>å…¶ä»–çš„å†…ç½‘ç©¿é€è¿˜æœ‰ä¸€å†™ï¼š</p><ul><li><a href="https://github.com/ehang-io/nps">nps</a>ï¼šGithubå¼€æº</li><li><a href="http://www.ngrok.cc/">Ngfork</a>ï¼šä»˜è´¹ï¼Œæœ‰å…è´¹ç‰ˆæœ¬</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;é¦–å…ˆè¯´ä¸‹åŸå§‹éœ€æ±‚ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼ŒIPv4 ç½‘ç»œåœ°å€æ•°é‡éå¸¸æœ‰é™ï¼Œå¤§çº¦åªæœ‰ 43 äº¿ä¸ªåœ°å€ï¼Œå…¨çƒäº’è”ç½‘å‘å±•åˆ°å¦‚ä»Šçš„ç¨‹åº¦ï¼Œæ˜¾ç„¶ä¸å¯èƒ½æ¯å°è®¾å¤‡éƒ½åˆ†é…åˆ°</summary>
      
    
    
    
    <category term="ç½‘ç»œ" scheme="https://awslzhang.top/categories/%E7%BD%91%E7%BB%9C/"/>
    
    
    <category term="frp" scheme="https://awslzhang.top/tags/frp/"/>
    
  </entry>
  
  <entry>
    <title>ç‹‚ç¥è¯´ElasticSearch 7.xç¬”è®°ï¼ˆçº¯æ‰‹æ•²ï¼‰</title>
    <link href="https://awslzhang.top/2020/10/18/%E7%8B%82%E7%A5%9E%E8%AF%B4ElasticSearch-7-x%E7%AC%94%E8%AE%B0%EF%BC%88%E7%BA%AF%E6%89%8B%E6%95%B2%EF%BC%89/"/>
    <id>https://awslzhang.top/2020/10/18/%E7%8B%82%E7%A5%9E%E8%AF%B4ElasticSearch-7-x%E7%AC%94%E8%AE%B0%EF%BC%88%E7%BA%AF%E6%89%8B%E6%95%B2%EF%BC%89/</id>
    <published>2020-10-18T08:14:03.000Z</published>
    <updated>2021-01-01T05:50:00.104Z</updated>
    
    <content type="html"><![CDATA[<p><img src="" alt="ä¸‹è½½"></p><h1 id="å£°æ˜"><a href="#å£°æ˜" class="headerlink" title="å£°æ˜"></a>å£°æ˜</h1><p>æ­¤æ–‡ç« æ˜¯upä¸»-<strong>é‡è§ç‹‚ç¥è¯´</strong>çš„èµ„æ–™ï¼Œå°†ä»–çš„èµ„æ–™æ‹‰å–åœ¨è¿™æ˜¯ä¸ºäº†æ›´å¥½çš„æŸ¥æ‰¾èµ„æ–™ã€‚</p><p>è¿™æ˜¯å¤§ç¥çš„è®²è§£è§†é¢‘ï¼š<a href="https://www.bilibili.com/video/BV17a4y1x7zq?p=1">https://www.bilibili.com/video/BV17a4y1x7zq?p=1</a></p><h1 id="ç‹‚ç¥èŠElasticSearch-åˆçº§é˜¶æ®µ"><a href="#ç‹‚ç¥èŠElasticSearch-åˆçº§é˜¶æ®µ" class="headerlink" title="ç‹‚ç¥èŠElasticSearch(åˆçº§é˜¶æ®µ)"></a>ç‹‚ç¥èŠElasticSearch(åˆçº§é˜¶æ®µ)</h1><p>E L K</p><p>ç‰ˆæœ¬:Elasticsearch7.6.1 (å…¨ç½‘æœ€æ–°çš„)</p><p>6.X å’Œ 7.X åŒºåˆ«ååˆ†å¤§(åŸç”ŸAPI,RestFulé«˜çº§)</p><blockquote><p>æˆ‘ä»¬è¦è®²è§£ä»€ä¹ˆ?</p></blockquote><p>SQL: likeæŸ¥è¯¢%ç‹‚ç¥è¯´%,å¦‚æœæ˜¯å¤§æ•°æ®,å°±ååˆ†æ…¢!ç´¢å¼•!</p><p>Elasticsearch:æœç´¢(ç™¾åº¦,github,æ·˜å®ç”µå•†!)</p><ol><li>èŠä¸€ä¸ªäºº</li><li>è´§æ¯”ä¸‰å®¶</li><li>å®‰è£…</li><li>ç”Ÿæ€åœˆ</li><li>åˆ†è¯å™¨ ik</li><li>RestFulæ“ä½œ ES</li><li>CRUD</li><li>SpringBoot é›†æˆ ElasticSearch(ä»åŸç†åˆ†æ!)</li><li>çˆ¬è™«çˆ¬å–æ•°æ®(äº¬ä¸œ)</li><li>å®æˆ˜,æ¨¡æ‹Ÿå…¨æ–‡æ£€ç´¢!</li></ol><blockquote><p>ä»¥åä½ åªè¦éœ€è¦ç”¨åˆ°æœç´¢,å°±å¯ä»¥ç”¨ES!(å¤§æ•°æ®é‡çš„æƒ…å†µä¸‹ä½¿ç”¨!)</p></blockquote><p>å­¦äº†è¿™ä¸ªå°±ä¸éœ€è¦ç”¨MySQLæ¥æŸ¥äº†</p><h1 id="èŠèŠDougCutting"><a href="#èŠèŠDougCutting" class="headerlink" title="èŠèŠDougCutting"></a>èŠèŠDougCutting</h1><p>ä¸ºä»€ä¹ˆè¦è®²è¿™ä¸ªäºº,åé¢è¦èŠå¤§æ•°æ®</p><blockquote><p>æœ¬æ•…äº‹å†…å®¹æ¥è‡ªå…¬ä¼—å·ï¼šæ–°æ£è¯¾å ‚</p></blockquote><p>1998å¹´9æœˆ4å·,googleå…¬å¸åœ¨ç¾å›½ç¡…è°·æˆç«‹.æ­£å¦‚å¤§å®¶æ‰€çŸ¥,å®ƒæ˜¯ä¸€å®¶<strong>æœç´¢</strong>å¼•æ“èµ·å®¶çš„å…¬å¸</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596610550313.png" alt="1596610550313"></p><p>æ— ç‹¬æœ‰å¶,ä¸€ä½åå«DougCuttingçš„ç¾å›½å·¥ç¨‹å¸ˆ,ä¹Ÿè¿·ä¸Šäº†æœç´¢å¼•æ“.ä»–åšäº†ä¸€ä¸ªç”¨äºæ–‡æœ¬æœç´¢çš„å‡½æ•°åº“(å§‘ä¸”ç†è§£ä¸ºè½¯ä»¶çš„åŠŸèƒ½ç»„ä»¶),å‘½åä¸ºLucene.</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596610568104.png" alt="1596610568104"></p><p>Luceneä½¿ç”¨Javaå†™çš„,ç›®æ ‡æ˜¯ä¸ºå„ç§ä¸­å°å‹åº”ç”¨è½¯ä»¶åŠ å…¥å…¨æ–‡æ£€ç´¢åŠŸèƒ½.å› ä¸ºå¥½ç”¨è€Œä¸”å¼€æº(ä»£ç å…¬å¼€),éå¸¸å—ç¨‹åºå‘˜ä»¬ç¨€ç½•)</p><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­,googleç¡®å®æ‰¾åˆ°äº†ä¸å°‘å¥½çš„åŠæ³•,å¹¶ä¸”æ— ç§åœ°åˆ†äº«äº†å‡ºæ¥.</p><p>å¼€æºæ˜¯ä¸€ç§ç²¾ç¥!</p><p>2003å¹´,googleå‘è¡¨äº†ä¸€ç¯‡æŠ€æœ¯å­¦æœ¯è®ºæ–‡,å…¬å¼€ä»‹ç»äº†è‡ªå·±çš„è°·æ­Œæ–‡ä»¶ç³»ç»ŸGFS(google File System).è¿™æ˜¯googleå…¬å¸ä¸ºäº†å­˜å‚¨æµ·é‡æœç´ æ•°æ®è€Œè®¾è®¡çš„ä¸“ç”¨æ–‡ä»¶ç³»ç»Ÿ</p><p>ç¬¬äºŒå¹´,2004å¹´,Doug CuttingåŸºäºgoogleçš„GFSè®ºæ–‡,å®ç°äº†åˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨ç³»ç»Ÿ,å¹¶å°†å®ƒå‘½åä¸ºNDFS(Nutch Distributed File System)</p><p>è¿˜æ˜¯2004å¹´,googleåˆå‘è¡¨äº†ä¸€ç¯‡æŠ€æœ¯å­¦æœ¯è®ºæ–‡,ä»‹ç»è‡ªå·±çš„MapReduceç¼–ç¨‹æ¨¡å‹.è¿™ä¸ªç¼–ç¨‹æ¨¡å‹,ç”¨äºå¤§è§„æ¨¡æ•°æ®é›†(å¤§äº1TB)çš„å¹¶è¡Œåˆ†æè¿ç®—.</p><p>2005å¹´,Doug Cutting åˆåŸºäºMapReduce,åœ¨Nutchæœç´¢å¼•æ“å®ç°äº†è¯¥åŠŸèƒ½.</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596610581999.png" alt="1596610581999"></p><p>2006å¹´,å½“æ—¶ä¾ç„¶å¾ˆå‰å®³çš„Yahoo(é›…è™)å…¬å¸,æ‹›å®‰äº†Doug Cutting</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596610607769.png" alt="1596610607769"></p><p>æˆªå›¾</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596610720399.png" alt="1596610720399"></p><p>æˆ‘ä»¬ç»§ç»­å¾€ä¸‹è¯´.</p><p>è¿˜æ˜¯2006å¹´,googleæœ‰å‘è¡¨è®ºæ–‡äº†</p><p>è¿™æ¬¡,ä»–ä»¬ä»‹ç»è‡ªå·±çš„BigTable,è¿™æ˜¯ä¸€ç§åˆ†å¸ƒå¼çš„æ•°æ®å­˜å‚¨ç³»ç»Ÿ,ä¸€ç§ç”¨æ¥å¤„ç†æµ·é‡æ•°æ®çš„éå…³ç³»å‹æ•°æ®åº“.</p><p>Doug Cutting å½“ç„¶æ²¡æœ‰æ”¾è¿‡,åœ¨è‡ªå·±çš„hadoopç³»ç»Ÿé‡Œé¢,å¼•å…¥äº†BigTable,å¹¶å‘½åä¸ºHBase.</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596610829469.png" alt="1596610829469"></p><p>å¥½å§,åæ­£å°±æ˜¯ç´§è·ŸGoogleæ—¶ä»£æ­¥ä¼,ä½ å‡ºä»€ä¹ˆ,æˆ‘å­¦ä»€ä¹ˆ</p><p>æ‰€æœ‰,Hadoopçš„æ ¸å¿ƒéƒ¨åˆ†,åŸºæœ¬ä¸Šéƒ½æœ‰Googleçš„å½±å­.</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596610891867.png" alt="1596610891867"></p><p>2008å¹´1æœˆ,HadoopæˆåŠŸä¸Šä½,æˆä¸ºApacheåŸºé‡‘ä¼šçš„é¡¶çº§é¡¹ç›®.</p><p>åŒå¹´2æœˆ,Yahooå®£å¸ƒå»ºæˆäº†ä¸€ä¸ªæ‹¥æœ‰1Wä¸ªå†…æ ¸çš„Hadoopé›†ç¾¤,å¹¶å°†è‡ªå·±çš„æœç´¢å¼•æ“äº§å“éƒ¨ç½²åœ¨ä¸Šé¢.</p><p>7æœˆ,Hadoopæ‰“ç ´ä¸–ç•Œçºªå½•,æˆä¸ºæœ€å¿«æ’åº1TBæ•°æ®çš„ç³»ç»Ÿ,ç”¨æ—¶209ç§’.</p><h1 id="Elasticsearchæ¦‚è¿°"><a href="#Elasticsearchæ¦‚è¿°" class="headerlink" title="Elasticsearchæ¦‚è¿°"></a>Elasticsearchæ¦‚è¿°</h1><p>elasticsearch,ç®€ç§°ä¸ºes,esæ˜¯ä¸€ä¸ªå¼€æºçš„æ‰©å±•çš„åˆ†å¸ƒå¼å…¨æ–‡æ£€ç´¢å¼•æ“,ä»–å¯ä»¥è¿‘ä¹å®æ—¶çš„å­˜å‚¨,æ£€ç´¢æ•°æ®;æœ¬èº«æ‰©å±•æ€§å¾ˆå¥½,å¯ä»¥æ‰©å±•åˆ°ä¸Šç™¾å°æœåŠ¡å™¨,å¤„ç†PBçº§åˆ«(å¤§æ•°æ®æ—¶ä»£)çš„æ•°æ®.esä¹Ÿä½¿ç”¨Javaå¹¶å‘ä½¿ç”¨Luceneä½œä¸ºå…¶æ ¸å¿ƒæ¥å®ç°æ‰€æœ‰ç´¢å¼•å’Œæœç´¢çš„åŠŸèƒ½,ä½†æ˜¯å®ƒçš„ç›®çš„æ˜¯é€šè¿‡ç®€å•çš„RESTful API æ¥éšè—Luceneçš„å¤æ‚æ€§,ä»è€Œè®©å…¨æ–‡æœç´¢å˜å¾—ç®€å•.</p><p>æ®å›½é™…æƒå¨çš„æ•°æ®åº“äº§å“è¯„æµ‹æœºæ„DB Enginesçš„ç»Ÿè®¡,åœ¨2016å¹´1æœˆ,ElasticSearchå·²è¶…è¿‡Solrç­‰,æˆä¸ºæ’åç¬¬ä¸€çš„æœç´¢å¼•æ“ç±»åº”ç”¨</p><blockquote><p>å†å²</p></blockquote><p>å¤šå¹´å‰,ä¸€ä¸ªå«åšshay banonçš„åˆšç»“å©šä¸ä¹…çš„å¤±ä¸šå¼€å‘è€…,ç”±äºå¦»å­è¦å»ä¼¦æ•¦å­¦ä¹ å¨å¸ˆ,ä»–ä¾¿è·Ÿç€å»äº†.åœ¨ä»–æ‰¾å·¥ä½œçš„è¿‡ç¨‹ä¸­,ä¸ºäº†ç»™å¦»å­æ„å»ºä¸€ä¸ªé£Ÿè°±çš„æœç´¢å¼•æ“,ä»–å¼€å§‹æ„å»ºä¸€ä¸ªæ—©æœŸç‰ˆæœ¬çš„Lucene</p><p>ç›´æ¥ åŸºäºLuceneå·¥ä½œä¼šæ¯”è¾ƒå›°éš¾,æ‰€ä»¥Shayå¼€å§‹æŠ½è±¡Luceneä»£ç ä»¥ä¾¿Javaç¨‹åºå‘˜å¯ä»¥åœ¨åº”ç”¨ä¸­æ·»åŠ æœç´¢åŠŸèƒ½.ä»–å‘å¸ƒäº†ä»–çš„ç¬¬ä¸€ä¸ªå¼€æºé¡¹ç›®,å«åšâ€compassâ€ åæ¥Shayæ‰¾åˆ°ä¸€ä»½å·¥ä½œ,è¿™ä¸ªå·¥ä½œå¤„åœ¨é«˜æ€§èƒ½å’Œå†…å­˜æ•°æ®ç½‘ç»œçš„åˆ†å¸ƒå¼ç¯å¢ƒä¸­,å› æ­¤é«˜æ€§èƒ½çš„,å®æ—¶çš„,åˆ†å¸ƒå¼çš„æœç´¢å¼•æ“ä¹Ÿæ˜¯ç†æ‰€å½“ç„¶éœ€è¦çš„.ç„¶åä»–å†³å®šé‡å†™Compassåº“,ä½¿å…¶æˆä¸ºä¸€ä¸ªç‹¬ç«‹çš„æœåŠ¡å«åšElasticsearch.ç¬¬ä¸€ä¸ªå…¬å¼€ç‰ˆæœ¬å‡ºç°åœ¨2010å¹´2æœˆ,åœ¨é‚£ä¹‹åElasticsearchå·²ç»æˆä¸ºGithubä¸Šæœ€å—æ¬¢è¿çš„é¡¹ç›®ä¹‹ä¸€,ä»£ç è´¡çŒ®è€…è¶…è¿‡300äºº.ä¸€å®¶ä¸»è¥Elasticsearchçš„å…¬å¸å°±æ­¤æˆç«‹,ä»–ä»¬ä¸€è¾¹æä¾›å•†ä¸šæ”¯æŒ,ä¸€è¾¹å¼€å‘æ–°åŠŸèƒ½,ä¸è¿‡Elasticsearchå°†æ°¸è¿œå¼€æºä¸”å¯¹æ‰€æœ‰äººå¯ç”¨ Shayçš„å¦»å­ä¾ç„¶ç­‰å¾…ç€ä»–çš„é£Ÿè°±æœç´¢â€¦â€¦.</p><p><img src="http://victorfengming.gitee.io/course/elasticsearch/base/03-elasticsearch-%E6%A6%82%E8%BF%B0.assets/1597974189393.png" alt="1597974189393"></p><p>è°åœ¨ä½¿ç”¨</p><ol><li>ç»´åŸºç™¾ç§‘(ç™¾åº¦ç™¾ç§‘,å…¨æ–‡é«˜äº®,æ’åºæœç´ æ¨è,æƒé‡,ç™¾åº¦!)</li><li>The Guardian</li><li>Stack Overflow(å›½å¤–çš„ç¨‹åºå¼‚å¸¸å¤„ç†ç½‘ç«™)IT é—®é¢˜,ç¨‹åºçš„æŠ¥é”™,æäº¤ä¸Šå»,æœ‰äººä¼šè·Ÿä½ è®¨è®ºå’Œå›ç­”</li><li>Github</li><li>ç”µå•†ç½‘ç«™ æ·˜å®äº¬ä¸œ</li><li>æ—¥å¿—æ•°æ®åˆ†æ,logstashé‡‡é›†æ—¥å¿—,ESè¿›è¡Œå¤æ‚çš„æ•°æ®åˆ†æ,ELKæŠ€æœ¯,elasticsearch+logstach+kibana</li><li>å•†å“ä»·æ ¼ç›‘æ§ç½‘ç«™,ç”¨æˆ·è®¾å®š</li></ol><h1 id="Elasticsearchå’ŒSolrå·®åˆ«"><a href="#Elasticsearchå’ŒSolrå·®åˆ«" class="headerlink" title="Elasticsearchå’ŒSolrå·®åˆ«"></a>Elasticsearchå’ŒSolrå·®åˆ«</h1><p>Elasticsearchæ˜¯ä¸€ä¸ªå®æ—¶åˆ†å¸ƒå¼æœç´¢å’Œåˆ†æå¼•æ“.å®ƒè®©ä½ ä»¥å‰æ‰€æœªæœ‰çš„é€Ÿåº¦å¤„ç†å¤§æ•°æ®æˆä¸ºå¯èƒ½. ç»´åŸºç™¾ç§‘ä½¿ç”¨å®ƒæä¾›å…¨æ–‡æœç´¢å¹¶é«˜äº®å…³é”®å­—,ä»¥åŠè¾“å…¥å®æ—¶æœç´¢</p><p>Solrç®€ä»‹ Solræ˜¯Apacheä¸‹çš„ä¸€ä¸ªé¡¶çº§å¼€æºé¡¹ç›®,é‡‡ç”¨Javaå¼€å‘,å®ƒæ˜¯åŸºäºLuceneçš„å…¨æ–‡æœç´¢æœåŠ¡å™¨.solræä¾›äº†æ¯”Luceneæ›´ä¸ºä¸°å¯Œçš„æŸ¥è¯¢è¯­è¨€,åŒæ—¶å®ç°äº†å¯é…ç½®,å¯æ‰©å±•,å¹¶å¯¹ç´¢å¼•,æœç´¢æ€§èƒ½è¿›è¡Œä¼˜åŒ– ä»–å¯ä»¥ç‹¬ç«‹è¿è¡Œ,è¿è¡Œåœ¨tomcat ,jetyç­‰è¿™äº›Servletå®¹å™¨ä¸­ solrå¯¹å¤–æä¾›ç±»ä¼¼äºWeb-serverçš„APIæ¥å£</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596613190316.png" alt="1596613190316"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596613206055.png" alt="1596613206055"></p><p>éšç€æ•°æ®é‡çš„å¢åŠ ,solrçš„æœç´¢</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596613233807.png" alt="1596613233807"></p><p>50å€çš„æ•ˆç‡</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596613255957.png" alt="1596613255957"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597974203192.png" alt="1597974203192"></p><h2 id="ElasticSearch-vs-Solr-æ€»ç»“"><a href="#ElasticSearch-vs-Solr-æ€»ç»“" class="headerlink" title="ElasticSearch vs Solr æ€»ç»“"></a>ElasticSearch vs Solr æ€»ç»“</h2><ol><li>esåŸºæœ¬æ˜¯==å¼€ç®±å³ç”¨==(è§£å‹å°±å¯ä»¥ç”¨äº†!),éå¸¸ç®€å•.solrå®‰è£…ç•¥å¾®å¤æ‚ä¸€ä¸¢ä¸¢!</li><li>Solråˆ©ç”¨Zookeeperè¿›è¡Œåˆ†å¸ƒå¼ç®¡ç†,è€Œ==Elasticsearchè‡ªèº«å¸¦æœ‰åˆ†å¸ƒå¼åè°ƒç®¡ç†åŠŸèƒ½==.</li><li>solræ”¯æŒæ›´å¤šæ ¼å¼çš„æ•°æ®,æ¯”å¦‚JSON,XML,CSV, è€Œelasticsearchä»…ä»…æ”¯æŒjsonæ–‡ä»¶æ ¼å¼</li><li>Solrå®˜ç½‘æä¾›çš„åŠŸèƒ½å¾ˆå¤š,è€Œelasticsearchæœ¬èº«æ›´æ³¨é‡æ ¸å¿ƒåŠŸèƒ½,é«˜çº§åŠŸèƒ½å¤šæœ‰ç¬¬ä¸‰æ–¹æ’ä»¶æä¾›,ä¾‹å¦‚å›¾å½¢åŒ–ç•Œé¢éœ€è¦kibanaå‹å¥½è´¨å±‚æ”¯æ’‘</li><li>SolræŸ¥è¯¢å—,ä½†æ›´æ–°ç´¢å¼•æ—¶æ…¢(å³æ’å…¥åˆ é™¤æ…¢),ç”¨äºç”µå•†ç­‰æŸ¥è¯¢å¤šçš„åº”ç”¨;<ul><li>ESå»ºç«‹ç´¢å¼•å—(å³æŸ¥è¯¢æ…¢),å³==å®æ—¶æ€§æŸ¥è¯¢å¿«==,ç”¨äºfacebookæ–°æµªç­‰æœç´¢.</li><li>Solræ˜¯ä¼ ç»Ÿæœç´¢åº”ç”¨çš„æœ‰åŠ›è§£å†³æ–¹æ¡ˆ,ä½†Elasticsearchæ›´é€‚ç”¨äºæ–°å…´çš„å®æ—¶æœç´¢åº”ç”¨.</li></ul></li><li>Solræ¯”è¾ƒæˆç†Ÿ,æœ‰ä¸€ä¸ªæ›´å¤§,æ›´æˆç†Ÿçš„ç”¨æˆ·,å¼€å‘å¥½è´¡çŒ®è€…ç¤¾åŒº,è€ŒElasticsearchç›¸å¯¹å¼€å‘ç»´æŠ¤è€…è¾ƒå°‘,æ›´æ–°å¤ªå¿«,==å­¦ä¹ ä½¿ç”¨æˆæœ¬è¾ƒé«˜==.</li></ol><h1 id="Elasticsearchå®‰è£…"><a href="#Elasticsearchå®‰è£…" class="headerlink" title="Elasticsearchå®‰è£…"></a>Elasticsearchå®‰è£…</h1><blockquote><p>å£°æ˜:JDK1.8, æœ€ä½è¦æ±‚ , Elasticsearchå®¢æˆ·ç«¯,ç•Œé¢å·¥å…·!</p></blockquote><p><strong>Javaå¼€å‘,elasticsearchçš„ç‰ˆæœ¬å’Œæˆ‘ä»¬ä¹‹åå¯¹åº”çš„Javaçš„æ ¸å¿ƒjaråŒ…! ç‰ˆæœ¬å¯¹åº”! JDKç¯å¢ƒæ˜¯æ­£å¸¸çš„</strong></p><p><strong>è¿™é‡Œä¸€å®šè¦ä¿è¯</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596614089583.png" alt="1596614089583"></p><p>ä¸‹è½½</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596614104028.png" alt="1596614104028"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596614119890.png" alt="1596614119890"></p><p>ä¸€å®šè¦åœ¨æœåŠ¡å™¨ä¸Šé¢æ­å»º</p><p>ä¸‹è½½åœ°å€:<a href="https://www.elastic.co/cn/downloads/elasticsearch">https://www.elastic.co/cn/downloads/elasticsearch</a></p><p>å®˜ç½‘ä¸‹è½½å·¨æ…¢,ç¿»å¢™,ç½‘ç›˜ä¸­ä¸‹è½½å³å¯</p><p>åä¸ºäº‘: <a href="https://mirrors.huaweicloud.com/elasticsearch/7.6.2/">https://mirrors.huaweicloud.com/elasticsearch/7.6.2/</a></p><p>æˆ‘ä»¬å­¦ä¹ çš„è¯Windowå’ŒLinuxéƒ½å¯ä»¥å­¦ä¹  ==æˆ‘ä»¬è¿™é‡Œç°åœ¨windowä¸‹å­¦ä¹ ==</p><p>ELKä¸‰å‰‘å®¢,è§£å‹å³ç”¨!(webé¡¹ç›®! å‰ç«¯ç¯å¢ƒ! npm ä¸‹è½½ä¾èµ–)</p><p>Node.js python2</p><blockquote><p>windowä¸‹å®‰è£…!</p></blockquote><ol><li>elasticSearch</li><li>elasticSearch Headï¼šä¸€ä¸ªå‰ç«¯é¡¹ç›®</li><li>kibana</li></ol><p>è¿‡ç¨‹ï¼šç•¥</p><h1 id="ESæ ¸å¿ƒæ¦‚å¿µç†è§£"><a href="#ESæ ¸å¿ƒæ¦‚å¿µç†è§£" class="headerlink" title="ESæ ¸å¿ƒæ¦‚å¿µç†è§£"></a>ESæ ¸å¿ƒæ¦‚å¿µç†è§£</h1><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>åœ¨å‰é¢çš„å­¦ä¹ ä¸­,æˆ‘ä»¬æŒæ¡äº†esæ˜¯ä»€ä¹ˆ,åŒæ—¶ä¹ŸæŠŠesçš„æœåŠ¡å·²ç»å®‰è£…å¯åŠ¨,é‚£ä¹ˆesæ˜¯å¦‚ä½•å»å­˜å‚¨æ•°æ®,æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆ,åˆæ˜¯å¦‚ä½•å®ç°æœç´¢çš„å‘¢?æˆ‘ä»¬å…ˆæ¥èŠèŠElasticsearchçš„ç›¸å…³æ¦‚å¿µå§!</p><p><strong>é›†ç¾¤,èŠ‚ç‚¹,ç´¢å¼•,ç±»å‹,æ–‡æ¡£,åˆ†ç‰‡,æ˜ å°„</strong>æ˜¯ä»€ä¹ˆ</p><blockquote><p>elasticsearchæ˜¯é¢å‘æ–‡æ¡£çš„,å…³ç³»è¡Œæ•°æ®åº“å’Œelasticsearchå®¢è§‚çš„å¯¹æ¯”! ä¸€åˆ‡éƒ½æ˜¯json</p></blockquote><table><thead><tr><th>RelationalDB</th><th>Elasticsearch</th></tr></thead><tbody><tr><td>æ•°æ®åº“(database)</td><td>ç´¢å¼•(indices)</td></tr><tr><td>è¡¨(tables)</td><td>types(7ç‰ˆæœ¬ä»¥åŠä¹‹åä¼šè¢«æŠ›å¼ƒï¼Œé»˜è®¤_doc)</td></tr><tr><td>è¡Œ(rows)</td><td>documents</td></tr><tr><td>å­—æ®µ(columns)</td><td>fields</td></tr></tbody></table><p>é¢å‘æ–‡æ¡£ é¢å‘æ–‡æ¡£ é¢å‘æ–‡æ¡£ <del>~</del></p><p>elasticsearch(é›†ç¾¤)ä¸­å¯ä»¥åŒ…å«å¤šä¸ªç´¢å¼•(æ•°æ®åº“),æ¯ä¸ªç´¢å¼•ä¸­å¯ä»¥åŒ…å«å¤šä¸ªç±»å‹(è¡¨),æ¯ä¸ªç±»å‹å…ˆåˆåŒ…å«å¤šä¸ªæ–‡æ¡£(è¡Œ),æ¯ä¸ªæ–‡æ¡£ä¸­åˆåŒ…å«å¤šä¸ªå­—æ®µ(åˆ—).</p><h2 id="ç‰©ç†è®¾è®¡"><a href="#ç‰©ç†è®¾è®¡" class="headerlink" title="ç‰©ç†è®¾è®¡"></a>ç‰©ç†è®¾è®¡</h2><p>elasticsearchåœ¨åå°å§æ¯ä¸ª<strong>ç´¢å¼•åˆ’åˆ†æˆå¤šä¸ªåˆ†ç‰‡</strong>,æ¯ä¸ªåˆ†ç‰‡å¯ä»¥åœ¨é›†ç¾¤ä¸­çš„ä¸åŒæœåŠ¡å™¨é—´è¿ç§»</p><p><img src="http://victorfengming.gitee.io/course/elasticsearch/base/07-elasticsearch-es%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E7%90%86%E8%A7%A3.assets/1596629957996.png" alt="1596629957996"></p><h2 id="é€»è¾‘è®¾è®¡"><a href="#é€»è¾‘è®¾è®¡" class="headerlink" title="é€»è¾‘è®¾è®¡"></a>é€»è¾‘è®¾è®¡</h2><p>ä¸€ä¸ªç´¢å¼•ç±»å‹ä¸­,åŒ…å«å¤šä¸ªæ–‡æ¡£,æ¯”å¦‚æ‰€æ–‡æ¡£1,æ–‡æ¡£2.å½“æˆ‘ä»¬ç´¢å¼•ä¸€ç¯‡æ–‡ç« æ—¶,å¯ä»¥é€šè¿‡è¿™æ ·çš„ä¸€å„é¡ºåºæ‰¾åˆ°å®ƒ:ç´¢å¼•&gt;ç±»å‹</p><p><code>&gt;</code>æ–‡æ¡£id,é€šè¿‡è¿™ä¸ªç»„åˆæˆ‘ä»¬å°±èƒ½ç´¢å¼•åˆ°æŸä¸ªå…·ä½“çš„æ–‡æ¡£. æ³¨æ„: idä¸å¿…æ˜¯æ•´æ•°,å®é™…ä¸Šä»–æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸².</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æ–‡æ¡£</span><br></pre></td></tr></table></figure><table><thead><tr><th>user</th><th>name</th><th>age</th></tr></thead><tbody><tr><td>1</td><td>zhasna</td><td>18</td></tr><tr><td>2</td><td>kaugshen</td><td>23</td></tr><tr><td>3</td><td></td><td></td></tr></tbody></table><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597974203192.png" alt="1597974203192"></p><p>ä¹‹å‰è¯´elasticsearchæ˜¯é¢å‘æ–‡æ¡£çš„,nameå°±ä¹Ÿä¸ºè¿™ç´¢å¼•å’Œæœç´¢æ•°æ®çš„æœ€å°å•ä½æ˜¯æ–‡æ¡£,elasticsearchä¸­,æ–‡æ¡£æœ‰å‡ ä¸ªé‡è¦å±æ€§:</p><ul><li><p>è‡ªæˆ‘åŒ…å«,ä¸€ç¯‡æ–‡æ¡£åŒæ—¶åŒ…å«å­—æ®µå’Œå¯¹åº”å€¼,ä¹Ÿå°±æ˜¯åŒæ—¶åŒ…å«key:value!</p></li><li><p>å¯ä»¥æ˜¯å±‚æ¬¡å‹çš„,ä¸€ä¸ªæ–‡æ¡£ä¸­åŒ…å«æ–‡æ¡£,å¤æ‚çš„é€»è¾‘å®ä½“å°±æ˜¯è¿™ä¹ˆæ¥çš„!</p></li><li><p>çµæ´»çš„ç»“æ„,æ–‡æ¡£ä¸ä¾èµ–é¢„å…ˆå®šä¹‰çš„æ¨¡å¼,æˆ‘ä»¬çŸ¥é“å…³ç³»å‹æ•°æ®åº“ä¸­,è¦æå‰å®šä¹‰å­—æ®µæ‰èƒ½ä½¿ç”¨,åœ¨elasticsearchä¸­,å¯¹äºå­—æ®µæ˜¯éå¸¸çµæ´»çš„,æœ‰æ—¶å€™,æˆ‘ä»¬å¯ä»¥å¿½ç•¥è¯¥å­—æ®µ,æˆ–è€…åŠ¨æ€çš„æ·»åŠ ä¸€ä¸ªæ–°çš„å­—æ®µ.</p><p>å°½ç®¡æˆ‘ä»¬å¯ä»¥éšæ„çš„æ–°å¢æˆ–è€…å¿½ç•¥æŸä¸ªå­—æ®µ,ä½†æ˜¯,æ¯ä¸ªå­—æ®µçš„ç±»å‹éå¸¸é‡è¦,æ¯”å¦‚ä¸€ä¸ªå¹´é¾„å­—æ®µç±»å‹,å¯ä»¥æ˜¯å­—ç¬¦ä¸²ä¹Ÿå¯ä»¥æ˜¯æ•´å‹.å› ä¸ºelasticsearchä¼šä¿å­˜å­—æ®µå’Œç±»å‹ä¹‹é—´çš„æ˜ å°„åŠå…¶ä»–çš„è®¾ç½®.è¿™ç§æ˜ å°„å…·ä½“åˆ°æ¯ä¸ªæ˜ å°„çš„æ¯ç§ç±»å‹,è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨elasticsearchä¸­,ç±»å‹æœ‰æ—¶å€™ä¹Ÿç§°ä¸ºæ˜ å°„ç±»å‹.</p></li></ul><blockquote><p>ç±»å‹</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596630612189.png" alt="1596630612189"></p><p>ç±»å‹æ˜¯æ–‡æ¡£çš„é€»è¾‘å®¹å™¨,å°±åƒå…³ç³»å‹æ•°æ®åº“ä¸€æ ·,è¡¨æ ¼æ˜¯è¡Œçš„å®¹å™¨.ç±»å‹ä¸­å¯¹äºå­—æ®µçš„å®šä¹‰ç§°ä¸ºæ˜ å°„,æ¯”å¦‚nameæ˜ å°„ä¸ºå­—ç¬¦ä¸²ç±»å‹.æˆ‘ä»¬è¯´æ–‡æ¡£æ˜¯æ— æ¨¡å¼çš„,ä»–ä»¬ä¸éœ€è¦æ‹¥æœ‰æ˜ å°„ä¸­æ‰€å®šä¹‰çš„æ‰€æœ‰å­—æ®µ,æ¯”å¦‚æ–°å¢ä¸€ä¸ªå­—æ®µ,é‚£ä¹ˆelasticsearchæ˜¯æ€ä¹ˆåšçš„å‘¢?</p><p>elasticsearchä¼šè‡ªåŠ¨çš„å°†æ–°çš„å­—æ®µåŠ å…¥æ˜ å°„,ä½†æ˜¯è¿™ä¸ªå­—æ®µçš„ä¸ç¡®å®šå®ƒæ˜¯ä»€ä¹ˆç±»å‹,elasticsearchå°±å¼€å§‹çŒœ,å¦‚æœè¿™ä¸ªå€¼æ˜¯18,é‚£ä¹ˆelasticsearchä¼šè®¤ä¸ºä»–æ˜¯æ•´å‹.ä½†æ˜¯elasticsearchä¹Ÿå¯èƒ½çŒœä¸å¯¹,æ‰€æœ‰æœ€å®‰å…¨çš„æ–¹å¼å°±æ˜¯æå‰å®šä¹‰å¥½æ‰€éœ€è¦çš„æ˜ å°„,è¿™ç‚¹è·Ÿå…³ç³»å‹æ•°æ®åº“æ®Šé€”åŒå½’äº†,å…ˆå®šä¹‰å¥½å­—æ®µ,ç„¶ååœ¨ä½¿ç”¨,åˆ«æ•´ä»€ä¹ˆå¹ºè›¾å­.</p><blockquote><p>ç´¢å¼•</p></blockquote><p><strong>å°±æ˜¯æ•°æ®åº“</strong></p><p>ç´¢å¼•æ˜¯æ˜ å°„ç±»å‹çš„å®¹å™¨,elasticsearchä¸­çš„ç´¢å¼•æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„æ–‡æ¡£é›†åˆ.ç´¢å¼•å­˜å‚¨äº†æ˜ å°„ç±»å‹å­—æ®µå’Œå…¶ä»–è®¾ç½®,ç„¶åä»–ä»¬å‘—å­˜å‚¨åˆ°äº†å„ä¸ªåˆ†ç‰‡ä¸Šäº†.æˆ‘ä»¬æ¥ç ”ç©¶ä¸‹åˆ†ç‰‡æ˜¯å¦‚ä½•å·¥ä½œçš„.</p><h3 id="ç‰©ç†è®¾è®¡-èŠ‚ç‚¹å’Œåˆ†ç‰‡-å¦‚ä½•å·¥ä½œ"><a href="#ç‰©ç†è®¾è®¡-èŠ‚ç‚¹å’Œåˆ†ç‰‡-å¦‚ä½•å·¥ä½œ" class="headerlink" title="ç‰©ç†è®¾è®¡: èŠ‚ç‚¹å’Œåˆ†ç‰‡ å¦‚ä½•å·¥ä½œ"></a>ç‰©ç†è®¾è®¡: èŠ‚ç‚¹å’Œåˆ†ç‰‡ å¦‚ä½•å·¥ä½œ</h3><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596630840364.png" alt="1596630840364"></p><p>ä¸€ä¸ªé›†ç¾¤è‡³å°‘è¦æœ‰ä¸€ä¸ªèŠ‚ç‚¹,å„¿ä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯ä¸€ä¸ªelasticsearchè¿›ç¨‹,èŠ‚ç‚¹å¯ä»¥æœ‰å¤šä¸ªç´¢å¼•é»˜è®¤çš„,å¦‚æœä½ åˆ›å»ºç´¢å¼•,é‚£ä¹ˆç´¢å¼•å°†ä¼šæœ‰5ä¸ªåˆ†ç‰‡(primary shard,åˆç§°ä¸»åˆ†ç‰‡) æ„æˆçš„,æ¯ä¸ªä¸»åˆ†ç‰‡ä¼šæœ‰ä¸€ä¸ªå‰¯æœ¬(replica shard,åˆç§°å¤åˆ¶åˆ†ç‰‡)</p><p><img src="http://victorfengming.gitee.io/course/elasticsearch/base/07-elasticsearch-es%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E7%90%86%E8%A7%A3.assets/1596630793639.png" alt="1596630793639"></p><p><img src="http://victorfengming.gitee.io/course/elasticsearch/base/07-elasticsearch-es%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E7%90%86%E8%A7%A3.assets/1596630870602.png" alt="1596630870602"></p><blockquote><p>å€’æ’ç´¢å¼•</p></blockquote><p>elasticsearchä½¿ç”¨çš„æ˜¯ä¸€ç§ç§°ä¸ºå€’æ’ç´¢å¼•çš„ç»“æ„,é‡‡ç”¨Luceneå€’æ’ç´¢å¼•ä½œä¸ºåº•å±‚.è¿™ç§ç»“æ„é€‚ç”¨äºå¿«é€Ÿçš„å…¨æ–‡æœç´¢,ä¸€ä¸ªç´¢å¼•ç”±æ–‡æ¡£ä¸­æ‰€æœ‰ä¸é‡å¤çš„åˆ—è¡¨æ„æˆ,å¯¹äºæ¯ä¸€ä¸ªè¯,éƒ½æœ‰ä¸€ä¸ªåŒ…å«å®ƒçš„æ–‡æ¡£åˆ—è¡¨.ä¾‹å¦‚,ç°åœ¨æœ‰ä¸¤ä¸ªæ–‡æ¡£,æ¯ä¸ªæ–‡æ¡£åŒ…å«å¦‚ä¸‹å†…å®¹.</p><p><img src="http://victorfengming.gitee.io/course/elasticsearch/base/07-elasticsearch-es%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E7%90%86%E8%A7%A3.assets/1596631073200.png" alt="1596631073200"></p><p>ä¸ºäº†åˆ›å»ºå€’æ’ç´¢å¼•,æˆ‘ä»¬é¦–å…ˆè¦å°†æ¯ä¸ªæ–‡æ¡£æ‹†åˆ†æˆç‹¬ç«‹çš„è¯(æˆ–ç§°ä¸ºè¯æ¡æˆ–è€…tokens),ç„¶ååˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰ä¸é‡å¤çš„è¯æ¡çš„æ’åºåˆ—è¡¨,ç„¶ååˆ—å‡ºæ¯ä¸ªè¯æ¡å‡ºç°åœ¨å“ªä¸ªæ–‡æ¡£:</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596631181270.png" alt="1596631181270"></p><p>ä¸¤ä¸ªæ–‡æ¡£éƒ½åŒ¹é…,ä½†æ˜¯ç¬¬ä¸€ä¸ªæ–‡æ¡£æ¯”ç¬¬äºŒä¸ªåŒ¹é…ç¨‹åº¦æ›´é«˜.å¦‚æœæ²¡æœ‰åˆ«çš„æ¡ä»¶,ç°åœ¨,è¿™ä¸¤ä¸ªåŒ…å«å…³é”®å­—çš„æ–‡æ¡£éƒ½å°†è¿”å›.</p><p>å†æ¥çœ‹ä¸€ä¸ªç¤ºä¾‹,æ¯”å¦‚æˆ‘ä»¬é€šè¿‡åšå®¢æ ‡ç­¾æ¥æœç´¢åšå®¢æ–‡ç« .é‚£ä¹ˆå€’æ’ç´¢å¼•åˆ—è¡¨å°±æ˜¯è¿™æ ·çš„ä¸€ä¸ªç»“æ„:</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596631425757.png" alt="1596631425757"></p><p>å¦‚æœè¦æœç´¢å«æœ‰pythonæ ‡ç­¾çš„æ–‡ç« ,é‚£ç›¸å¯¹æŸ¥æ‰¾æ‰€æœ‰åŸå§‹æ•°æ®è€Œè¨€,æŸ¥æ‰¾å€’æ’ç´¢å¼•åçš„æ•°æ®å°†ä¼šå¿«çš„å¤š.åªéœ€è¦æŸ¥çœ‹æ ‡ç­¾è¿™ä¸€æ ,ç„¶åè·å–ç›¸å…³æ–‡ç« idå³å¯.</p><h1 id="IKåˆ†è¯å™¨æ’ä»¶"><a href="#IKåˆ†è¯å™¨æ’ä»¶" class="headerlink" title="IKåˆ†è¯å™¨æ’ä»¶"></a>IKåˆ†è¯å™¨æ’ä»¶</h1><h2 id="ä»€ä¹ˆæ˜¯åˆ†è¯å™¨"><a href="#ä»€ä¹ˆæ˜¯åˆ†è¯å™¨" class="headerlink" title="ä»€ä¹ˆæ˜¯åˆ†è¯å™¨"></a><strong>ä»€ä¹ˆæ˜¯åˆ†è¯å™¨</strong></h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596637415868.png" alt="1596637415868"></p><p>==å¦‚æœä½¿ç”¨ä¸­æ–‡,å»ºè®®ä½¿ç”¨ikåˆ†è¯å™¨==</p><p>IKä½“ç”¨äº†ä¸¤ä¸ªåˆ†è¯ç®—æ³•:<code>ik_smart</code>å’Œ,å…¶ä¸­ik_smartä¸ºæœ€å°‘(Ë‰â–½ï¿£ï½) åˆ‡~~åˆ†,ik_max_wordä¸ºæœ€ç»†ç²’åº¦åˆ’åˆ†! ä¸€ä¼šæˆ‘ä»¬æµ‹è¯•</p><blockquote><p>å®‰è£…</p></blockquote><ol><li><p><a href="https://github.com/medcl/elasticsearch-analysis-ik%EF%BC%8C%E7%89%88%E6%9C%AC%E9%9C%80%E8%A6%81%E5%92%8CElasticSearch%E7%89%88%E6%9C%AC%E5%AF%B9%E5%BA%94">https://github.com/medcl/elasticsearch-analysis-ikï¼Œç‰ˆæœ¬éœ€è¦å’ŒElasticSearchç‰ˆæœ¬å¯¹åº”</a></p></li><li><p>ä¸‹è½½å®Œæ¯•ä¹‹å,æ”¾å…¥åˆ°æˆ‘ä»¬çš„elasticsearchæ’ä»¶å³å¯</p><p><img src="http://victorfengming.gitee.io/course/elasticsearch/base/08-elasticsearch-IK%E5%88%86%E8%AF%8D%E5%99%A8%E6%8F%92%E4%BB%B6.assets/1596637767841.png" alt="1596637767841"></p><ol><li><p>é‡å¯è§‚å¯ŸES</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596674648793.png" alt="1596674648793"></p></li><li><p>elasticsearch-plugin å¯ä»¥é€šè¿‡è¿™ä¸ªå‘½ä»¤æ¥æŸ¥çœ‹åŠ è½½çš„æ’ä»¶</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596674703775.png" alt="1596674703775"></p></li><li><p>ä½¿ç”¨kibanaæµ‹è¯•!</p><p>æŸ¥çœ‹ä¸åŒçš„åˆ†è¯å™¨æ•ˆæœ</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596674979545.png" alt="1596674979545"></p></li></ol></li></ol><h2 id="ikåˆ†è¯å™¨å¢åŠ æˆ‘ä»¬è‡ªå·±çš„é…ç½®"><a href="#ikåˆ†è¯å™¨å¢åŠ æˆ‘ä»¬è‡ªå·±çš„é…ç½®" class="headerlink" title="ikåˆ†è¯å™¨å¢åŠ æˆ‘ä»¬è‡ªå·±çš„é…ç½®"></a>ikåˆ†è¯å™¨å¢åŠ æˆ‘ä»¬è‡ªå·±çš„é…ç½®</h2><p>è¿™ç§è‡ªå·±éœ€è¦çš„è¯,éœ€è¦è‡ªå·±åŠ åˆ°æˆ‘ä»¬çš„åˆ†è¯å™¨å­—å…¸ä¸­!</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596675349989.png" alt="1596675349989"></p><p>é‡å¯ES,çœ‹ç»†èŠ‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596675426305.png" alt="1596675426305"></p><p>å†æ¬¡æµ‹è¯•ä¸€ä¸‹ç‹‚ç¥è¯´,</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596675486318.png" alt="1596675486318"></p><p>ä»¥åçš„è¯æˆ‘ä»¬éœ€è¦è‡ªå·±é…ç½®è‡ªå·±çš„è¯,åªéœ€è¦åœ¨è‡ªå®šä¹‰çš„dicæ–‡ä»¶ä¸­è¿›è¡Œé…ç½®å³å¯!</p><h1 id="Resté£æ ¼è¯´æ˜"><a href="#Resté£æ ¼è¯´æ˜" class="headerlink" title="Resté£æ ¼è¯´æ˜"></a>Resté£æ ¼è¯´æ˜</h1><p>ä¸€ç§è½¯ä»¶æ¶æ„é£æ ¼,è€Œä¸æ˜¯æ ‡å‡†,åªæ˜¯æä¾›äº†ä¸€ç»„è®¾è®¡åŸåˆ™å’Œçº¦æŸæ¡ä»¶.å®ƒä¸»è¦ç”¨äºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº¤äº’ç±»çš„è½¯ä»¶.åŸºäºè¿™ä¸ªé£æ ¼è®¾è®¡çš„è½¯ä»¶å¯ä»¥æ›´ç®€æ´,æ›´æœ‰å±‚æ¬¡,æ›´æ˜“äºå®ç°ç¼“å­˜ç­‰æœºåˆ¶.</p><p>åŸºæœ¬Resté£æ ¼å‘½ä»¤è¯´æ˜</p><table><thead><tr><th>method</th><th>urlåœ°å€</th><th>æè¿°</th></tr></thead><tbody><tr><td>PUT</td><td>127.0.01:9200/ç´¢å¼•åç§°/_create/æ–‡æ¡£id</td><td>åˆ›å»ºæ–‡æ¡£ï¼ˆæŒ‡å®šidï¼‰</td></tr><tr><td>POST</td><td>127.0.01:9200/ç´¢å¼•åç§°/_doc</td><td>åˆ›å»ºæ–‡æ¡£</td></tr><tr><td>POST</td><td>127.0.01:9200/ç´¢å¼•åç§°/_update/æ–‡æ¡£id</td><td>ä¿®æ”¹æ–‡æ¡£</td></tr><tr><td>DELETE</td><td>127.0.01:9200/ç´¢å¼•åç§°</td><td>åˆ é™¤ç´¢å¼•</td></tr><tr><td>DELETE</td><td>127.0.01:9200/ç´¢å¼•åç§°/_doc/æ–‡æ¡£id</td><td>åˆ é™¤æ–‡æ¡£</td></tr></tbody></table><blockquote><p>åŸºç¡€æµ‹è¯•</p></blockquote><h2 id="å…³äºç´¢å¼•çš„åŸºæœ¬æ“ä½œ"><a href="#å…³äºç´¢å¼•çš„åŸºæœ¬æ“ä½œ" class="headerlink" title="å…³äºç´¢å¼•çš„åŸºæœ¬æ“ä½œ"></a>å…³äºç´¢å¼•çš„åŸºæœ¬æ“ä½œ</h2><h3 id="ç´¢å¼•indices"><a href="#ç´¢å¼•indices" class="headerlink" title="ç´¢å¼•indices"></a>ç´¢å¼•indices</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># id</span><br><span class="line">PUT &#x2F;test&#x2F;_create&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;zxj1&quot;,</span><br><span class="line">  &quot;age&quot;:18</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># wu id</span><br><span class="line">POST &#x2F;test&#x2F;_doc</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;zxj1&quot;,</span><br><span class="line">  &quot;age&quot;:18</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201018173524585.png" alt="image-20201018173524585"></p><h3 id="æ˜ å°„mapping"><a href="#æ˜ å°„mapping" class="headerlink" title="æ˜ å°„mapping"></a>æ˜ å°„mapping</h3><p>é‚£ä¹ˆnameè¿™ä¸ªå­—æ®µç”¨ä¸ç”¨æŒ‡å®šç±»å‹å‘¢,æ¯•ç«Ÿæˆ‘ä»¬å…³ç³»å‹æ•°æ®åº“ æ˜¯éœ€è¦æŒ‡å®šç±»å‹æ˜ å°„çš„å•Š</p><p><img src="http://victorfengming.gitee.io/course/elasticsearch/base/09-elasticsearch-Rest%E9%A3%8E%E6%A0%BC.assets/1596676128844.png" alt="1596676128844"></p><ol><li><p>æŒ‡å®šå­—æ®µçš„ç±»å‹</p><p>è·å¾—è¿™ä¸ªè§„åˆ™! å¯é€šè¿‡GETè¯·æ±‚è·å–å…·ä½“çš„ä¿¡æ¯</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201018174140347.png" alt="image-20201018174140347"></p></li><li><p>ä¸ç»™ç´¢å¼•è®¾ç½®mappingçš„è¯ï¼ŒElasticSearchä¼šé»˜è®¤åŒ¹é…ï¼›å¦‚æœè‡ªå·±çš„æ–‡æ¡£å­—æ®µæ²¡æœ‰æŒ‡å®š,é‚£ä¹ˆESå°±ä¼šç»™æˆ‘ä»¬é…ç½®å­—æ®µç±»å‹</p></li></ol><h1 id="å…³äºæ–‡æ¡£çš„åŸºæœ¬æ“ä½œ"><a href="#å…³äºæ–‡æ¡£çš„åŸºæœ¬æ“ä½œ" class="headerlink" title="å…³äºæ–‡æ¡£çš„åŸºæœ¬æ“ä½œ"></a>å…³äºæ–‡æ¡£çš„åŸºæœ¬æ“ä½œ</h1><p><a href="https://www.bilibili.com/video/BV17a4y1x7zq?p=10">https://www.bilibili.com/video/BV17a4y1x7zq?p=10</a></p><h2 id="åŸºæœ¬æ“ä½œ"><a href="#åŸºæœ¬æ“ä½œ" class="headerlink" title="åŸºæœ¬æ“ä½œ"></a><strong>åŸºæœ¬æ“ä½œ</strong></h2><ol><li><p>æ·»åŠ æ•°æ®</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201018173524585.png" alt="image-20201018173524585"></p></li><li><p>è·å–æ•°æ®</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597891281730.png" alt="1597891281730"></p></li><li><p>æ›´æ–°æ•°æ® PUTï¼Œæ›´æ–°æ—¶æ˜¯è¦†ç›–æ›´æ–°ï¼Œæ²¡æœ‰æ›´æ–°çš„å­—æ®µä¼šè¢«è¦†ç›–ä¸ºç©ºï¼</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597891378076.png" alt="1597891378076"></p></li><li><p>Post _update,==æ¨èä½¿ç”¨è¿™ç§æ›´æ–°æ–¹å¼!==</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597891620183.png" alt="1597891620183"></p></li></ol><h2 id="ç®€å•åœ°æœç´¢"><a href="#ç®€å•åœ°æœç´¢" class="headerlink" title="ç®€å•åœ°æœç´¢!"></a>ç®€å•åœ°æœç´¢!</h2>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET test&#x2F;_doc&#x2F;2</span><br></pre></td></tr></table></figure><p>   ç®€å•çš„æ¡ä»¶æŸ¥è¯¢,å¯ä»¥æ ¹æ®é»˜è®¤çš„æ˜ å°„è§„åˆ™,äº§ç”ŸåŸºæœ¬çš„æŸ¥è¯¢</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201018175222885.png" alt="image-20201018175222885">   <img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597892169142.png" alt="1597892169142"></p><blockquote></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597974203192.png" alt="1597974203192"></p><h2 id="å¤æ‚æ“ä½œæœç´¢"><a href="#å¤æ‚æ“ä½œæœç´¢" class="headerlink" title="å¤æ‚æ“ä½œæœç´¢"></a>å¤æ‚æ“ä½œæœç´¢</h2><blockquote><p>select(æ’åº,åˆ†é¡µ,é«˜äº®,æ¨¡ç³ŠæŸ¥è¯¢,ç²¾å‡†æŸ¥è¯¢! )</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597892352276.png" alt="1597892352276"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597892367286.png" alt="1597892367286"></p><p>è¾“å‡ºç»“æœä¸æƒ³è¦é‚£ä¹ˆå¤š,select *</p><p>ç°åœ¨æ˜¯select name,age</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597892385326.png" alt="1597892385326"></p><p>å¯ä»¥æŒ‡å®šå­—æ®µ</p><p>ç»“æœçš„è¿‡æ»¤</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597892451582.png" alt="1597892451582"></p><p>æˆ‘ä»¬ä¹‹åä½¿ç”¨Javaæ“ä½œES,æ‰€æœ‰çš„æ–¹æ³•å’Œå¯¹è±¡å°±æ˜¯è¿™é‡Œé¢çš„key!</p><blockquote><p>æ’åº</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597892561417.png" alt="1597892561417"></p><blockquote><p>åˆ†é¡µæŸ¥è¯¢</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597892615017.png" alt="1597892615017"></p><p>æ•°æ®ä¸‹æ ‡è¿˜æ˜¯ä»0å¼€å§‹,å’Œä¹‹å‰æ‰€å­¦çš„æ•°æ®ç»“æ„éƒ½æ˜¯ä¸€æ ·çš„!</p><blockquote><p>å¸ƒå°”å€¼æŸ¥è¯¢</p></blockquote><p>must(and) ,æ‰€æœ‰æ¡ä»¶éƒ½è¦ç¬¦åˆ where id=1 and name=xxx</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597892730673.png" alt="1597892730673"></p><p>should (or) ,æ‰€æœ‰æ¡ä»¶éƒ½è¦ç¬¦åˆ where id=1 or name = xxx</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597892885428.png" alt="1597892885428"></p><p>must not (not)</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597892928930.png" alt="1597892928930"></p><p>è¿‡æ»¤å™¨ filter</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597892996458.png" alt="1597892996458"></p><ul><li>gt å¤§äº</li><li>gte å¤§äºç­‰äº</li><li>lt å°äº</li><li>lte å°äºç­‰äº</li></ul><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597893039013.png" alt="1597893039013"></p><p>åŒ¹é…å¤šä¸ªæ¡ä»¶</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597893096034.png" alt="1597893096034"></p><p>ç”¨ç©ºæ ¼åˆ†éš”ä¹Ÿè¡Œ</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597893131147.png" alt="1597893131147"></p><blockquote><p>ç²¾ç¡®æŸ¥è¯¢</p></blockquote><p>term æŸ¥è¯¢æ—¶ç›´æ¥é€šè¿‡å€’æ’ç´¢å¼•æŒ‡å®šçš„è¯æ¡è¿›ç¨‹ç²¾ç¡®æŸ¥æ‰¾çš„!</p><p>å…³äºåˆ†è¯:</p><p>term,ç›´æ¥æŸ¥è¯¢ç²¾ç¡®çš„</p><p>match,ä¼šä½¿ç”¨åˆ†è¯å™¨è§£æ! (å…ˆåˆ†æåˆ†æ¡£,ç„¶åå†é€šè¿‡åˆ†æçš„åˆ†æ¡£è¿›è¡ŒæŸ¥è¯¢! )</p><p><strong>ä¸¤ä¸ªç±»å‹ text keyword</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597893556500.png" alt="1597893556500"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597893572562.png" alt="1597893572562"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597893648565.png" alt="1597893648565"></p><blockquote><p>å¤šä¸ªå€¼åŒ¹é…ç²¾ç¡®æŸ¥è¯¢</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597900914957.png" alt="1597900914957"></p><blockquote><p>é«˜äº®æŸ¥è¯¢!</p></blockquote><p>æœç´¢çš„é«˜äº®æ¡ä»¶,ä¼šåœ¨HTMLé‡Œé¢è‡ªåŠ¨çš„åŠ ä¸Šæ ‡ç­¾</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597901143555.png" alt="1597901143555"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597905816361.png" alt="1597905816361"></p><h1 id="é›†æˆSpringBoot"><a href="#é›†æˆSpringBoot" class="headerlink" title="é›†æˆSpringBoot"></a>é›†æˆSpringBoot</h1><blockquote><p>æ‰¾æ–‡æ¡£!</p></blockquote><p><a href="https://proxies.app.aidoru.net/-----https://www.elastic.co/guide/index.html">https://proxies.app.aidoru.net/-----https://www.elastic.co/guide/index.html</a></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597906806327.png" alt="1597906806327"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597906105998.png" alt="1597906105998"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597906924635.png" alt="img"></p><ol><li><p>æ‰¾åˆ°åŸç”Ÿçš„ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ol><ol start="2"><li><p>æ‰¾å¯¹è±¡</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597907115554.png" alt="1597907115554"></p></li><li><p>åˆ†æè¿™ä¸ªç±»ä¸­çš„æ–¹æ³•å³å¯</p><blockquote><p>é…ç½®åŸºæœ¬çš„é¡¹ç›®</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597907258818.png" alt="1597907258818"></p><blockquote><p>é—®é¢˜:ä¸€å®šè¦ä¿è¯æˆ‘ä»¬å¯¼å…¥çš„ä¾èµ–å’Œæˆ‘ä»¬çš„ESç‰ˆæœ¬ä¸€è‡´</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597907493787.png" alt="1597907493787"></p></li></ol><p>æŒ‰ç…§å®˜ç½‘çš„æ“ä½œæˆ‘ä»¬è¦æ„å»ºä¸€ä¸ªå¯¹è±¡</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597907737591.png" alt="1597907737591"></p><p>åˆ†ææºç </p><p>ç‹‚ç¥çš„Springæ­¥éª¤:</p><ol><li><p>æ‰¾å¯¹è±¡</p></li><li><p>æ”¾åˆ°springä¸­å¾…ç”¨</p></li><li><p>å¦‚æœæ˜¯springboot,é‚£å°±å…ˆåˆ†ææºç </p><p>xxxAutoConfiguration,xxxProperties</p></li></ol><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597908504743.png" alt="1597908504743"></p><p>æºç ä¸­æä¾›çš„å¯¹è±¡</p><p>è™½ç„¶è¿™é‡Œå¯¼å…¥äº†3ä¸ªç±»,é™æ€å†…éƒ¨ç±»,æ ¸å¿ƒç±»å°±ä¸€ä¸ª</p><h2 id="å…³äºç´¢å¼•çš„APIæ“ä½œè¯¦è§£"><a href="#å…³äºç´¢å¼•çš„APIæ“ä½œè¯¦è§£" class="headerlink" title="å…³äºç´¢å¼•çš„APIæ“ä½œè¯¦è§£"></a>å…³äºç´¢å¼•çš„APIæ“ä½œè¯¦è§£</h2><blockquote><p>å…·ä½“çš„Apiæµ‹è¯•!</p></blockquote><p><code>restHighLevelClient.indices().xxx()</code></p><ol><li><p>åˆ›å»ºç´¢å¼•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index create</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 1. æ„å»ºç´¢å¼•è¯·æ±‚å®ä½“ç±» å°±æ˜¯åˆ›å»ºç´¢å¼•æ—¶çš„&#123;&#125;</span></span><br><span class="line">    CreateIndexRequest springboot_index = <span class="keyword">new</span> CreateIndexRequest(<span class="string">&quot;springboot_index&quot;</span>);</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 2.æ‰§è¡Œåˆ›å»ºç´¢å¼•è¯·æ±‚,è¿”å›å“åº”</span></span><br><span class="line">    CreateIndexResponse createIndexResponse =</span><br><span class="line">            restHighLevelClient.indices().create(springboot_index, RequestOptions.DEFAULT);</span><br><span class="line">   </span><br><span class="line">    System.out.println(createIndexResponse);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åˆ¤æ–­ç´¢å¼•æ˜¯å¦å­˜åœ¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">getIndices</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">     <span class="comment">// 1. åˆ›å»ºè¯·æ±‚ä½“å†…å®¹å¯¹è±¡</span></span><br><span class="line">     GetIndexRequest srpingboot_index = <span class="keyword">new</span> GetIndexRequest(<span class="string">&quot;springboot_index&quot;</span>);</span><br><span class="line">   </span><br><span class="line">     <span class="comment">// 2. action</span></span><br><span class="line">     <span class="keyword">boolean</span> exists = restHighLevelClient.indices().exists(srpingboot_index,</span><br><span class="line">             RequestOptions.DEFAULT);</span><br><span class="line">     System.out.println(exists);</span><br><span class="line">     GetIndexResponse getIndexResponse = restHighLevelClient.indices().get(srpingboot_index,</span><br><span class="line">             RequestOptions.DEFAULT);</span><br><span class="line">     System.out.println(getIndexResponse);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li><li><p>åˆ é™¤ç´¢å¼•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">deleteIndices</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 1. åˆ›å»ºè¯·æ±‚ä½“å†…å®¹å¯¹è±¡,åˆ é™¤æ—¶ç´¢å¼•éœ€å­˜åœ¨ï¼</span></span><br><span class="line">    DeleteIndexRequest springboot_index = <span class="keyword">new</span> DeleteIndexRequest(<span class="string">&quot;springboot_index&quot;</span>);</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 2. action</span></span><br><span class="line">    AcknowledgedResponse delete = restHighLevelClient.indices().delete(springboot_index,</span><br><span class="line">            RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(delete.isAcknowledged());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºæ–‡æ¡£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">createDocument</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// put /index/_create/id &#123;...&#125;</span></span><br><span class="line">    <span class="comment">// 1. æ„å»ºåˆ›å»ºçš„æ–‡æ¡£çš„å†…å®¹</span></span><br><span class="line">    IndexRequest indexRequest = <span class="keyword">new</span> IndexRequest(<span class="string">&quot;springboot_index&quot;</span>);</span><br><span class="line">    indexRequest.timeout(<span class="string">&quot;1s&quot;</span>);</span><br><span class="line">    indexRequest.id(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="comment">// public IndexRequest source(String source, XContentType xContentType)</span></span><br><span class="line">    indexRequest.source(JSON.toJSONString(<span class="keyword">new</span> User(<span class="string">&quot;zxj&quot;</span>, <span class="number">18</span>)), XContentType.JSON);</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 2. å¼€å§‹è¯·æ±‚</span></span><br><span class="line">    IndexResponse index = restHighLevelClient.index(indexRequest, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(index.status());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>crudæ–‡æ¡£</p></li></ol><h2 id="å…³äºæ–‡æ¡£çš„APIæ“ä½œè¯¦è§£"><a href="#å…³äºæ–‡æ¡£çš„APIæ“ä½œè¯¦è§£" class="headerlink" title="å…³äºæ–‡æ¡£çš„APIæ“ä½œè¯¦è§£"></a>å…³äºæ–‡æ¡£çš„APIæ“ä½œè¯¦è§£</h2><blockquote><p>åˆ›å»ºæ–‡æ¡£</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">createDocument</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// put /index/_create/id &#123;...&#125;</span></span><br><span class="line">    <span class="comment">// 1. æ„å»ºåˆ›å»ºçš„æ–‡æ¡£çš„å†…å®¹</span></span><br><span class="line">    IndexRequest indexRequest = <span class="keyword">new</span> IndexRequest(<span class="string">&quot;springboot_index&quot;</span>);</span><br><span class="line">    indexRequest.timeout(<span class="string">&quot;1s&quot;</span>);</span><br><span class="line">    indexRequest.id(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="comment">// public IndexRequest source(String source, XContentType xContentType)</span></span><br><span class="line">    indexRequest.source(JSON.toJSONString(<span class="keyword">new</span> User(<span class="string">&quot;zxj&quot;</span>, <span class="number">18</span>)), XContentType.JSON);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. å¼€å§‹è¯·æ±‚</span></span><br><span class="line">    IndexResponse index = restHighLevelClient.index(indexRequest, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(index.status());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœ</p><p>è¿™é‡Œçš„è¿”å›çš„å…¨éƒ¨å†…å®¹å’Œæˆ‘ä»¬çš„å‘½ä»¤æ˜¯ä¸€æ ·çš„</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201018194243887.png" alt="image-20201018194243887"></p><blockquote><p>æ›´æ–°æ–‡æ¡£ä¿¡æ¯</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">updateDocument</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">       <span class="comment">// post /index/_update/id &#123;&quot;doc&quot;:&#123;...&#125;&#125;</span></span><br><span class="line">       <span class="comment">// 1. æ„å»ºä¿®æ”¹çš„æ–‡æ¡£çš„å†…å®¹,String index, String id</span></span><br><span class="line">       UpdateRequest updateRequest = <span class="keyword">new</span> UpdateRequest(<span class="string">&quot;springboot_index&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">       updateRequest.timeout(<span class="string">&quot;1s&quot;</span>);</span><br><span class="line">       updateRequest.doc(JSON.toJSONString(<span class="keyword">new</span> User(<span class="string">&quot;new Name&quot;</span>, <span class="number">18</span>)), XContentType.JSON);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 2. å¼€å§‹è¯·æ±‚</span></span><br><span class="line">       UpdateResponse updateResponse = restHighLevelClient.update(updateRequest, RequestOptions.DEFAULT);</span><br><span class="line">       System.out.println(updateResponse.status());</span><br><span class="line">       System.out.println(updateResponse.toString());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201018194653575.png" alt="image-20201018194653575"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201018194726197.png" alt="image-20201018194726197"></p><blockquote><p>åˆ é™¤æ–‡æ¡£è®°å½•</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">dropDocument</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">       <span class="comment">// delete /index/_doc/id</span></span><br><span class="line">       <span class="comment">// 1. æ„å»ºåˆ é™¤æ–‡æ¡£çš„å¯¹è±¡,String index, String id</span></span><br><span class="line">       DeleteRequest deleteRequest = <span class="keyword">new</span> DeleteRequest(<span class="string">&quot;springboot_index&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">       deleteRequest.timeout(<span class="string">&quot;1s&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 2. å¼€å§‹è¯·æ±‚</span></span><br><span class="line">       DeleteResponse delete = restHighLevelClient.delete(deleteRequest, RequestOptions.DEFAULT);</span><br><span class="line">       System.out.println(delete.status());</span><br><span class="line">       System.out.println(delete.toString());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201018195024638.png" alt="image-20201018195024638"></p><h3 id="æ‰¹é‡æ“ä½œ"><a href="#æ‰¹é‡æ“ä½œ" class="headerlink" title="æ‰¹é‡æ“ä½œ"></a>æ‰¹é‡æ“ä½œ</h3><blockquote><p>ç‰¹æ®Šçš„,çœŸçš„é¡¹ç›®ä¸€èˆ¬éƒ½ä¼šæ‰¹é‡æ’å…¥æ•°æ®</p></blockquote><p>æ‰¹é‡æ“ä½œbulkRequestæœ‰å¾ˆå¤šç±»å‹ï¼šä¾‹å¦‚ä¸‹è¿°ã€‚è¿™é‡Œåªå±•ç¤ºæ‰¹é‡å¢åŠ </p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201018195851648.png" alt="image-20201018195851648"></p><p>æ‰¹é‡æ·»åŠ æ–‡æ¡£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bulgRequest</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 1. æ„å»ºæ‰¹é‡è¯·æ±‚ä½“</span></span><br><span class="line">    BulkRequest bulkRequest = <span class="keyword">new</span> BulkRequest();</span><br><span class="line">    bulkRequest.timeout(<span class="string">&quot;10s&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        IndexRequest indexRequest = <span class="keyword">new</span> IndexRequest(<span class="string">&quot;springboot_index&quot;</span>);</span><br><span class="line">        indexRequest.source(JSON.toJSONString(<span class="keyword">new</span> User(<span class="string">&quot;zxj&quot;</span>+i, <span class="number">18</span>)), XContentType.JSON);</span><br><span class="line">        bulkRequest.add(indexRequest);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BulkResponse bulk = restHighLevelClient.bulk(bulkRequest, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(!bulk.hasFailures());</span><br><span class="line">    System.out.println(bulk.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æŸ¥è¯¢æœç´¢ğŸ”º"><a href="#æŸ¥è¯¢æœç´¢ğŸ”º" class="headerlink" title="æŸ¥è¯¢æœç´¢ğŸ”º"></a>æŸ¥è¯¢æœç´¢ğŸ”º</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;search/&#123;key&#125;/&#123;page&#125;/&#123;size&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; searchLists(<span class="meta">@PathVariable(&quot;key&quot;)</span> String keyword,</span><br><span class="line">                                             <span class="meta">@PathVariable(&quot;page&quot;)</span> Long page, <span class="meta">@PathVariable(</span></span><br><span class="line"><span class="meta">                                                     &quot;size&quot;)</span> Long size) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// æ„å»ºæœç´¢å¯¹è±¡</span></span><br><span class="line">    SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;jd1&quot;</span>);</span><br><span class="line">    <span class="comment">// æœç´¢æ¡ä»¶æ„é€ </span></span><br><span class="line">    SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    searchSourceBuilder.timeout(<span class="keyword">new</span> TimeValue(<span class="number">2L</span>, TimeUnit.SECONDS));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒ¹é…æŸ¥è¯¢</span></span><br><span class="line">    MatchQueryBuilder title = QueryBuilders.matchQuery(<span class="string">&quot;title&quot;</span>, keyword);</span><br><span class="line">    searchSourceBuilder.query(title);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// page</span></span><br><span class="line">    <span class="keyword">if</span> (page&lt;=<span class="number">1L</span>)&#123;</span><br><span class="line">        page = <span class="number">1L</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    searchSourceBuilder.from((<span class="keyword">int</span>) (page * size));</span><br><span class="line">    searchSourceBuilder.size(Math.toIntExact(size));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// highlight</span></span><br><span class="line">    HighlightBuilder highlightBuilder = <span class="keyword">new</span> HighlightBuilder();</span><br><span class="line">    highlightBuilder.field(<span class="string">&quot;title&quot;</span>); <span class="comment">// titleå­—æ®µé«˜äº®</span></span><br><span class="line">    highlightBuilder.requireFieldMatch(<span class="keyword">false</span>); <span class="comment">// å…³é”®å­—é«˜äº®ä¸€æ¬¡</span></span><br><span class="line">    highlightBuilder.preTags(<span class="string">&quot;&lt;span style=&#x27;color:red&#x27;&gt;&quot;</span>);</span><br><span class="line">    highlightBuilder.postTags(<span class="string">&quot;&lt;/span&gt;&quot;</span>);</span><br><span class="line">    searchSourceBuilder.highlighter(highlightBuilder);</span><br><span class="line"></span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">    ArrayList&lt;Map&lt;String, Object&gt;&gt; objects = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    SearchResponse searchResponse = restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : searchResponse.getHits().getHits()) &#123;</span><br><span class="line">        <span class="comment">// æŸ¥è¯¢ç»“æœ</span></span><br><span class="line">        Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†é«˜äº®çš„å­—æ®µè¦†ç›–æŸ¥è¯¢ç»“æœçš„è¯¥å­—æ®µ</span></span><br><span class="line">        HighlightField highlightField = hit.getHighlightFields().get(<span class="string">&quot;title&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (highlightField != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Text[] fragments = highlightField.fragments();</span><br><span class="line">            StringBuilder s = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="keyword">for</span> (Text fragment : fragments) &#123;</span><br><span class="line">                s.append(fragment);</span><br><span class="line">            &#125;</span><br><span class="line">            sourceAsMap.put(<span class="string">&quot;title&quot;</span>, s.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        objects.add(sourceAsMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> objects;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201020213945227.png" alt="image-20201020213945227"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;img src=&quot;&quot; alt=&quot;ä¸‹è½½&quot;&gt;&lt;/p&gt;
&lt;h1 id=&quot;å£°æ˜&quot;&gt;&lt;a href=&quot;#å£°æ˜&quot; class=&quot;headerlink&quot; title=&quot;å£°æ˜&quot;&gt;&lt;/a&gt;å£°æ˜&lt;/h1&gt;&lt;p&gt;æ­¤æ–‡ç« æ˜¯upä¸»-&lt;strong&gt;é‡è§ç‹‚ç¥è¯´&lt;/strong&gt;çš„èµ„æ–™ï¼Œå°†ä»–çš„èµ„æ–™æ‹‰å–</summary>
      
    
    
    
    <category term="å…¨æ–‡æœç´¢" scheme="https://awslzhang.top/categories/%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2/"/>
    
    
    <category term="ElasticSearch" scheme="https://awslzhang.top/tags/ElasticSearch/"/>
    
  </entry>
  
  <entry>
    <title>IDEAæ‰“åŒ…è„šæœ¬é—®é¢˜</title>
    <link href="https://awslzhang.top/2020/09/21/IDEA%E6%89%93%E5%8C%85%E8%84%9A%E6%9C%AC%E9%97%AE%E9%A2%98/"/>
    <id>https://awslzhang.top/2020/09/21/IDEA%E6%89%93%E5%8C%85%E8%84%9A%E6%9C%AC%E9%97%AE%E9%A2%98/</id>
    <published>2020-09-21T13:34:43.000Z</published>
    <updated>2021-01-01T05:49:59.943Z</updated>
    
    <content type="html"><![CDATA[<h1 id="é—®é¢˜æè¿°"><a href="#é—®é¢˜æè¿°" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h1><p><strong>shellè„šæœ¬æ‰§è¡Œé”™è¯¯ $â€™\râ€™:command not found</strong></p><p>è¿™æ˜¯åœ¨IDEAæ‰“åŒ…çš„è„šæœ¬ä¸­ï¼Œç§»åŠ¨åˆ°Linuxï¼Œè§£å‹ï¼Œæ‰§è¡Œè„šæœ¬æ—¶å‡ºç°çš„é”™è¯¯</p><h1 id="å‡ºç°åŸå› ä»¥åŠè§£å†³"><a href="#å‡ºç°åŸå› ä»¥åŠè§£å†³" class="headerlink" title="å‡ºç°åŸå› ä»¥åŠè§£å†³"></a>å‡ºç°åŸå› ä»¥åŠè§£å†³</h1><p>åœ¨æ–‡ä»¶ä¸­ä»»ä½•æ ·å¼éƒ½æ˜¯ç”¨å­—èŠ‚ä½“ç°çš„ï¼Œä¾‹å¦‚æ¢è¡Œï¼š</p><ul><li>åœ¨windowä¸­ï¼šå›è½¦+æ¢è¡Œ CRLF</li><li>åœ¨Linuxä¸­ï¼šæ¢è¡Œï¼šLF</li><li>è€ç‰ˆMacä¸­ï¼šå›è½¦ï¼šCRï¼Œä¹‹åä¹Ÿæ˜¯LF</li></ul><p>windowä¸‹å¼€å‘æœ‰ä¸€ä¸ªå¤§å‘ï¼Œå°±æ˜¯æ¢è¡Œé»˜è®¤æ˜¯<code>CRLF</code>ï¼Œä¹Ÿå°±æ˜¯å›è½¦æ¢è¡Œï¼Œä½†æ˜¯Linuxä¸‹åªæœ‰æ¢è¡Œ<code>LF</code>ï¼Œè¿™æ ·ä»£ç æäº¤åï¼Œä¼šå‡ºç°ç¼–è¯‘é—®é¢˜ï¼Œ<strong>æ‰€ä»¥æœ€å¥½çš„åŠæ³•æ˜¯åœ¨IntelliJä¸‹è®¾ç½®é»˜è®¤ä¸ºLF</strong>ã€‚é¦–å…ˆæˆ‘ä»¬å…ˆä»‹ç»CRLFï¼ŒLFå’ŒCRè¿™ä¸‰ç§ä¸œè¥¿ï¼ŒCRæ˜¯MACè€ç‰ˆæœ¬çš„åšæ³•ï¼Œå°±æ˜¯å›è½¦ï¼Œä½†æ˜¯åæ¥çš„MACç³»ç»Ÿç»Ÿä¸€æ¢æˆLFäº†ï¼ŒLFæ˜¯Linuxä¸‹çš„åšæ³•ï¼Œå°±æ˜¯æ¢è¡Œï¼Œè¿™ä¸ªåšæ³•æ¯”è¾ƒè‡ªç„¶ï¼Œä¸ºä»€ä¹ˆè¦å›è½¦æ¢è¡Œå‘¢ï¼Œ<strong>æ˜¯å§ã€‚å¾®è½¯é‡‡ç”¨çš„æ˜¯CRLFï¼Œçœ‹ä¸Šå»å¥½åƒæ˜¯å…¼å®¹äº†CRå’ŒLFï¼Œä½†æ˜¯å®é™…å®Œå…¨ä¸æ˜¯é‚£ä¹ˆå›äº‹ï¼Œå°±æ˜¯å›è½¦å¹¶æ¢è¡Œï¼Œå¥½é¸¡è‚‹å•Šï¼Œå¾®è½¯ä¸€ç›´ä¿æŒè¿™ç§åšæ³•</strong>ï¼Œå¼€å‘äººå‘˜å¤§å¤šåœ¨Linuxä¸‹ï¼Œæ‰€ä»¥å¯¹äºå¼€å‘äººå‘˜æ¥è¯´è¿˜æ˜¯æ¯”è¾ƒå‘çš„ã€‚ä¸‹é¢ä»‹ç»è®¾ç½®è¯¦è§£ï¼š</p><h2 id="File-gt-Settingsâ€¦"><a href="#File-gt-Settingsâ€¦" class="headerlink" title="File-&gt;Settingsâ€¦"></a>File-&gt;Settingsâ€¦</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/AGPaNgg.png" alt="AGPaNgg"></p><h2 id="Editor-gt-Code-Style"><a href="#Editor-gt-Code-Style" class="headerlink" title="Editor-&gt;Code Style"></a>Editor-&gt;Code Style</h2><p>å¯ä»¥çœ‹åˆ°ï¼Œé»˜è®¤æ˜¯System-Dependentï¼Œè¿™ä¸ªå…¶å®è¿˜æ˜¯å¾ˆç‰›å‰çš„ï¼Œæ ¹æ®ç³»ç»Ÿè‡ªåŠ¨é…ç½®ï¼Œä½†æ˜¯ä½ æ˜¯windowsç³»ç»Ÿï¼Œé»˜è®¤æ˜¯CRLFï¼ŒæœåŠ¡å™¨æ˜¯Linuxï¼Œä½ å°±å¾—è‡ªå·±æ¢äº†ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/JOQ6jZ4.png" alt="JOQ6jZ4"></p><p>æˆ‘ä»¬è®¾ç½®æˆä¸‹é¢è¿™æ ·ï¼Œä¿å­˜å°±å¥½äº†</p><p><strong>è¿™æ ·è®¾ç½®æ˜¯ä¹‹åæ–°å»ºçš„æ–‡ä»¶æœ‰æ•ˆæœ</strong></p><h2 id="ä¹‹å‰æ–‡ä»¶æœ‰æ•ˆ"><a href="#ä¹‹å‰æ–‡ä»¶æœ‰æ•ˆ" class="headerlink" title="ä¹‹å‰æ–‡ä»¶æœ‰æ•ˆ"></a>ä¹‹å‰æ–‡ä»¶æœ‰æ•ˆ</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/826328-20200409110931988-1979119311.png" alt="826328-20200409110931988-1979119311"></p><p><strong>File -&gt; Line Separators -&gt; LF</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/826328-20200409110953545-1889327721.png" alt="826328-20200409110953545-1889327721"></p><h1 id="å¤„ç†æ–¹å¼äºŒ"><a href="#å¤„ç†æ–¹å¼äºŒ" class="headerlink" title="å¤„ç†æ–¹å¼äºŒ"></a>å¤„ç†æ–¹å¼äºŒ</h1><p>é€šè¿‡ä¸€ä¸ªLinuxå‘½ä»¤ï¼Œå°†windowæ¢è¡Œç¬¦å˜ä¸ºLinuxæ¢è¡Œç¬¦</p><p><code>dos2unix  è„šæœ¬å</code></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;é—®é¢˜æè¿°&quot;&gt;&lt;a href=&quot;#é—®é¢˜æè¿°&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜æè¿°&quot;&gt;&lt;/a&gt;é—®é¢˜æè¿°&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;shellè„šæœ¬æ‰§è¡Œé”™è¯¯ $â€™\râ€™:command not found&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;è¿™æ˜¯</summary>
      
    
    
    
    
    <category term="IDEA" scheme="https://awslzhang.top/tags/IDEA/"/>
    
  </entry>
  
  <entry>
    <title>sparkå­¦ä¹ ç¬”è®°-SparkCoreè§£æ</title>
    <link href="https://awslzhang.top/2020/08/29/spark%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-SparkCore%E8%A7%A3%E6%9E%90/"/>
    <id>https://awslzhang.top/2020/08/29/spark%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-SparkCore%E8%A7%A3%E6%9E%90/</id>
    <published>2020-08-29T13:41:20.000Z</published>
    <updated>2021-01-01T05:50:00.043Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Spark-å†…æ ¸æ¦‚è¿°"><a href="#Spark-å†…æ ¸æ¦‚è¿°" class="headerlink" title="Spark å†…æ ¸æ¦‚è¿°"></a>Spark å†…æ ¸æ¦‚è¿°</h1><p>Sparkå†…æ ¸æ³›æŒ‡Sparkçš„æ ¸å¿ƒè¿è¡Œæœºåˆ¶ï¼ŒåŒ…æ‹¬<strong>Sparkæ ¸å¿ƒç»„ä»¶çš„è¿è¡Œæœºåˆ¶ã€Sparkä»»åŠ¡è°ƒåº¦æœºåˆ¶ã€Sparkå†…å­˜ç®¡ç†æœºåˆ¶ã€Sparkæ ¸å¿ƒåŠŸèƒ½çš„è¿è¡ŒåŸç†</strong>ç­‰ï¼Œç†Ÿç»ƒæŒæ¡Sparkå†…æ ¸åŸç†ï¼Œèƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°å®ŒæˆSparkä»£ç è®¾è®¡ï¼Œå¹¶èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å‡†ç¡®é”å®šé¡¹ç›®è¿è¡Œè¿‡ç¨‹ä¸­å‡ºç°çš„é—®é¢˜çš„ç—‡ç»“æ‰€åœ¨ã€‚</p><h2 id="Sparkæ ¸å¿ƒç»„ä»¶å›é¡¾"><a href="#Sparkæ ¸å¿ƒç»„ä»¶å›é¡¾" class="headerlink" title="Sparkæ ¸å¿ƒç»„ä»¶å›é¡¾"></a>Sparkæ ¸å¿ƒç»„ä»¶å›é¡¾</h2><h3 id="Driver"><a href="#Driver" class="headerlink" title="Driver"></a>Driver</h3><p><strong>Sparké©±åŠ¨å™¨èŠ‚ç‚¹</strong>ï¼Œç”¨äºæ‰§è¡ŒSparkä»»åŠ¡ä¸­çš„<strong>main</strong>æ–¹æ³•ï¼Œè´Ÿè´£å®é™…ä»£ç çš„æ‰§è¡Œå·¥ä½œã€‚Driveråœ¨Sparkä½œä¸šæ‰§è¡Œæ—¶ä¸»è¦è´Ÿè´£ï¼š</p><ol><li>å°†ç”¨æˆ·ç¨‹åºè½¬åŒ–ä¸ºä½œä¸šï¼ˆjobï¼‰ï¼›</li><li>åœ¨Executorä¹‹é—´è°ƒåº¦ä»»åŠ¡(task)ï¼›</li><li>è·Ÿè¸ªExecutorçš„æ‰§è¡Œæƒ…å†µï¼›</li><li>é€šè¿‡UIå±•ç¤ºæŸ¥è¯¢è¿è¡Œæƒ…å†µï¼›</li></ol><h3 id="Executor"><a href="#Executor" class="headerlink" title="Executor"></a>Executor</h3><p>Spark ExecutorèŠ‚ç‚¹æ˜¯ä¸€ä¸ªJVMè¿›ç¨‹ï¼Œè´Ÿè´£åœ¨ Spark ä½œä¸šä¸­è¿è¡Œå…·ä½“ä»»åŠ¡ï¼Œä»»åŠ¡å½¼æ­¤ä¹‹é—´ç›¸äº’ç‹¬ç«‹ã€‚Spark åº”ç”¨å¯åŠ¨æ—¶ï¼ŒExecutorèŠ‚ç‚¹è¢«åŒæ—¶å¯åŠ¨ï¼Œå¹¶ä¸”å§‹ç»ˆä¼´éšç€æ•´ä¸ª Spark åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸè€Œå­˜åœ¨ã€‚å¦‚æœæœ‰ExecutorèŠ‚ç‚¹å‘ç”Ÿäº†æ•…éšœæˆ–å´©æºƒï¼ŒSpark åº”ç”¨ä¹Ÿå¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œä¼šå°†å‡ºé”™èŠ‚ç‚¹ä¸Šçš„ä»»åŠ¡è°ƒåº¦åˆ°å…¶ä»–ExecutorèŠ‚ç‚¹ä¸Šç»§ç»­è¿è¡Œã€‚</p><p>Executoræœ‰ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š</p><ol><li>è´Ÿè´£<strong>è¿è¡Œç»„æˆSparkåº”ç”¨çš„ä»»åŠ¡</strong>ï¼Œå¹¶å°†ç»“æœè¿”å›ç»™é©±åŠ¨å™¨è¿›ç¨‹ï¼›</li><li>å®ƒä»¬é€šè¿‡è‡ªèº«çš„å—ç®¡ç†å™¨ï¼ˆBlock Managerï¼‰ä¸ºç”¨æˆ·ç¨‹åºä¸­è¦æ±‚ç¼“å­˜çš„ RDD æä¾›å†…å­˜å¼å­˜å‚¨ã€‚<strong>RDD æ˜¯ç›´æ¥ç¼“å­˜åœ¨Executorè¿›ç¨‹å†…çš„</strong>ï¼Œå› æ­¤ä»»åŠ¡å¯ä»¥åœ¨è¿è¡Œæ—¶å……åˆ†åˆ©ç”¨ç¼“å­˜æ•°æ®åŠ é€Ÿè¿ç®—ã€‚</li></ol><h2 id="Sparké€šç”¨è¿è¡Œæµç¨‹æ¦‚è¿°"><a href="#Sparké€šç”¨è¿è¡Œæµç¨‹æ¦‚è¿°" class="headerlink" title="Sparké€šç”¨è¿è¡Œæµç¨‹æ¦‚è¿°"></a>Sparké€šç”¨è¿è¡Œæµç¨‹æ¦‚è¿°</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830151813147.png" alt="image-20200830151813147"></p><p>å›¾1-1ä¸ºSparké€šç”¨è¿è¡Œæµç¨‹ï¼Œ<strong>ä¸è®ºSparkä»¥ä½•ç§æ¨¡å¼è¿›è¡Œéƒ¨ç½²ï¼Œä»»åŠ¡æäº¤åï¼Œéƒ½ä¼šå…ˆå¯åŠ¨Driverè¿›ç¨‹</strong>ï¼ŒéšåDriverè¿›ç¨‹å‘é›†ç¾¤ç®¡ç†å™¨æ³¨å†Œåº”ç”¨ç¨‹åºï¼Œä¹‹åé›†ç¾¤ç®¡ç†å™¨æ ¹æ®æ­¤ä»»åŠ¡çš„é…ç½®æ–‡ä»¶åˆ†é…Executorå¹¶å¯åŠ¨ï¼Œå½“Driveræ‰€éœ€çš„èµ„æºå…¨éƒ¨æ»¡è¶³åï¼Œ<strong>Driverå¼€å§‹æ‰§è¡Œmainå‡½æ•°ï¼ŒSparkæŸ¥è¯¢ä¸ºæ‡’æ‰§è¡Œï¼Œå½“æ‰§è¡Œåˆ°actionç®—å­æ—¶å¼€å§‹åå‘æ¨ç®—</strong>ï¼Œ<font color="red">æ ¹æ®å®½ä¾èµ–è¿›è¡Œstageçš„åˆ’åˆ†ï¼Œéšåæ¯ä¸€ä¸ªstageå¯¹åº”ä¸€ä¸ªtasksetï¼Œtasksetä¸­æœ‰å¤šä¸ªtaskï¼Œæ ¹æ®æœ¬åœ°åŒ–åŸåˆ™ï¼Œtaskä¼šè¢«åˆ†å‘åˆ°æŒ‡å®šçš„Executorå»æ‰§è¡Œ</font>ï¼Œåœ¨ä»»åŠ¡æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼ŒExecutorä¹Ÿä¼šä¸æ–­ä¸Driverè¿›è¡Œé€šä¿¡ï¼ŒæŠ¥å‘Šä»»åŠ¡è¿è¡Œæƒ…å†µã€‚</p><h1 id="Sparkéƒ¨ç½²æ¨¡å¼"><a href="#Sparkéƒ¨ç½²æ¨¡å¼" class="headerlink" title="Sparkéƒ¨ç½²æ¨¡å¼"></a>Sparkéƒ¨ç½²æ¨¡å¼</h1><p>Sparkæ”¯æŒ3ç§é›†ç¾¤ç®¡ç†å™¨ï¼ˆCluster Managerï¼‰ï¼Œåˆ†åˆ«ä¸ºï¼š</p><ol><li><code>Standaloneï¼š</code>ç‹¬ç«‹æ¨¡å¼ï¼ŒSparkåŸç”Ÿçš„ç®€å•é›†ç¾¤ç®¡ç†å™¨ï¼Œè‡ªå¸¦å®Œæ•´çš„æœåŠ¡ï¼Œå¯å•ç‹¬éƒ¨ç½²åˆ°ä¸€ä¸ªé›†ç¾¤ä¸­ï¼Œ<strong>æ— éœ€ä¾èµ–ä»»ä½•å…¶ä»–èµ„æºç®¡ç†ç³»ç»Ÿ</strong>ï¼Œä½¿ç”¨Standaloneå¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ­å»ºä¸€ä¸ªé›†ç¾¤ï¼›</li><li><code>Apache Mesosï¼š</code>ä¸€ä¸ªå¼ºå¤§çš„åˆ†å¸ƒå¼èµ„æºç®¡ç†æ¡†æ¶ï¼Œå®ƒå…è®¸å¤šç§ä¸åŒçš„æ¡†æ¶éƒ¨ç½²åœ¨å…¶ä¸Šï¼ŒåŒ…æ‹¬yarnï¼›</li><li><code>Hadoop YARNï¼š</code>ç»Ÿä¸€çš„èµ„æºç®¡ç†æœºåˆ¶ï¼Œåœ¨ä¸Šé¢å¯ä»¥è¿è¡Œå¤šå¥—è®¡ç®—æ¡†æ¶ï¼Œå¦‚map reduceã€stormç­‰ï¼Œ<font color="red">æ ¹æ®driveråœ¨é›†ç¾¤ä¸­çš„ä½ç½®ä¸åŒï¼Œåˆ†ä¸ºyarn clientå’Œyarn cluster</font>ã€‚</li></ol><p>å®é™…ä¸Šï¼Œé™¤äº†ä¸Šè¿°è¿™äº›é€šç”¨çš„é›†ç¾¤ç®¡ç†å™¨å¤–ï¼ŒSparkå†…éƒ¨ä¹Ÿæä¾›äº†ä¸€äº›æ–¹ä¾¿ç”¨æˆ·æµ‹è¯•å’Œå­¦ä¹ çš„ç®€å•é›†ç¾¤éƒ¨ç½²æ¨¡å¼ã€‚<font color="red"><strong>ç”±äºåœ¨å®é™…å·¥å‚ç¯å¢ƒä¸‹ä½¿ç”¨çš„ç»å¤§å¤šæ•°çš„é›†ç¾¤ç®¡ç†å™¨æ˜¯Hadoop YARNï¼Œå› æ­¤æˆ‘ä»¬å…³æ³¨çš„é‡ç‚¹æ˜¯Hadoop YARNæ¨¡å¼ä¸‹çš„Sparké›†ç¾¤éƒ¨ç½²ã€‚</strong></font></p><p>Sparkçš„è¿è¡Œæ¨¡å¼å–å†³äºä¼ é€’ç»™<code>SparkContext</code>çš„<font color="red"><code>MASTER</code>ç¯å¢ƒå˜é‡çš„å€¼</font>ï¼Œä¸ªåˆ«æ¨¡å¼è¿˜éœ€è¦è¾…åŠ©çš„ç¨‹åºæ¥å£æ¥é…åˆä½¿ç”¨ï¼Œç›®å‰æ”¯æŒçš„Masterå­—ç¬¦ä¸²åŠURLåŒ…æ‹¬ï¼š</p><table><thead><tr><th><strong>Master URL</strong></th><th><strong>Meaning</strong></th></tr></thead><tbody><tr><td><strong>local</strong></td><td>åœ¨æœ¬åœ°è¿è¡Œï¼Œåªæœ‰ä¸€ä¸ªå·¥ä½œè¿›ç¨‹ï¼Œæ— å¹¶è¡Œè®¡ç®—èƒ½åŠ›ã€‚</td></tr><tr><td><strong>local[K]</strong></td><td>åœ¨æœ¬åœ°è¿è¡Œï¼Œæœ‰Kä¸ªå·¥ä½œè¿›ç¨‹ï¼Œé€šå¸¸è®¾ç½®Kä¸ºæœºå™¨çš„CPUæ ¸å¿ƒæ•°é‡ã€‚</td></tr><tr><td><strong>local[*]</strong></td><td>åœ¨æœ¬åœ°è¿è¡Œï¼Œå·¥ä½œè¿›ç¨‹æ•°é‡ç­‰äºæœºå™¨çš„CPUæ ¸å¿ƒæ•°é‡ã€‚</td></tr><tr><td><strong>spark://HOST:PORT</strong></td><td>ä»¥Standaloneæ¨¡å¼è¿è¡Œï¼Œè¿™æ˜¯Sparkè‡ªèº«æä¾›çš„é›†ç¾¤è¿è¡Œæ¨¡å¼ï¼Œé»˜è®¤ç«¯å£å·: 7077ã€‚è¯¦ç»†æ–‡æ¡£è§:Spark  standalone clusterã€‚</td></tr><tr><td><strong>mesos://HOST:PORT</strong></td><td>åœ¨Mesosé›†ç¾¤ä¸Šè¿è¡Œï¼ŒDriverè¿›ç¨‹å’ŒWorkerè¿›ç¨‹è¿è¡Œåœ¨Mesosé›†ç¾¤ä¸Šï¼Œéƒ¨ç½²æ¨¡å¼å¿…é¡»ä½¿ç”¨å›ºå®šå€¼:â€“deploy-mode clusterã€‚è¯¦ç»†æ–‡æ¡£è§:MesosClusterDispatcher.</td></tr><tr><td><strong>yarn-client</strong></td><td>åœ¨Yarné›†ç¾¤ä¸Šè¿è¡Œï¼ŒDriverè¿›ç¨‹åœ¨æœ¬åœ°ï¼ŒExecutorè¿›ç¨‹åœ¨Yarné›†ç¾¤ä¸Šï¼Œéƒ¨ç½²æ¨¡å¼å¿…é¡»ä½¿ç”¨å›ºå®šå€¼:â€“deploy-mode  clientã€‚Yarné›†ç¾¤åœ°å€å¿…é¡»åœ¨HADOOP_CONF_DIR or YARN_CONF_DIRå˜é‡é‡Œå®šä¹‰ã€‚</td></tr><tr><td><strong>yarn-cluster</strong></td><td>åœ¨Yarné›†ç¾¤ä¸Šè¿è¡Œï¼ŒDriverè¿›ç¨‹åœ¨Yarné›†ç¾¤ä¸Šï¼ŒWorkè¿›ç¨‹ä¹Ÿåœ¨Yarné›†ç¾¤ä¸Šï¼Œéƒ¨ç½²æ¨¡å¼å¿…é¡»ä½¿ç”¨å›ºå®šå€¼:â€“deploy-mode clusterã€‚Yarné›†ç¾¤åœ°å€å¿…é¡»åœ¨HADOOP_CONF_DIR  or YARN_CONF_DIRå˜é‡é‡Œå®šä¹‰ã€‚</td></tr></tbody></table><p><strong>ç”¨æˆ·åœ¨æäº¤ä»»åŠ¡ç»™Sparkå¤„ç†æ—¶ï¼Œä»¥ä¸‹ä¸¤ä¸ªå‚æ•°å…±åŒå†³å®šäº†Sparkçš„è¿è¡Œæ–¹å¼ã€‚</strong></p><ul><li><code>master MASTER_URL</code> ï¼šå†³å®šäº†Sparkä»»åŠ¡æäº¤<font color="red">ç»™å“ªç§é›†ç¾¤å¤„ç†ã€‚</font></li><li><code>deploy-mode DEPLOY_MODE</code>ï¼šå†³å®šäº†Driverçš„è¿è¡Œæ–¹å¼ï¼Œ<font color="red">å¯é€‰å€¼ä¸ºClientæˆ–è€…Clusterã€‚</font></li></ul><h2 id="Standaloneæ¨¡å¼è¿è¡Œæœºåˆ¶"><a href="#Standaloneæ¨¡å¼è¿è¡Œæœºåˆ¶" class="headerlink" title="Standaloneæ¨¡å¼è¿è¡Œæœºåˆ¶"></a>Standaloneæ¨¡å¼è¿è¡Œæœºåˆ¶</h2><p>Standaloneé›†ç¾¤æœ‰<strong>å››ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†</strong>ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ol><li><code>Driver</code>ï¼šæ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œæˆ‘ä»¬<strong>ç¼–å†™çš„Sparkåº”ç”¨ç¨‹åºå°±è¿è¡Œåœ¨Driverä¸Š</strong>ï¼Œç”±Driverè¿›ç¨‹æ‰§è¡Œï¼›</li><li><code>Master(RM)</code>ï¼šæ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œ<strong>ä¸»è¦è´Ÿè´£èµ„æºçš„è°ƒåº¦å’Œåˆ†é…</strong>ï¼Œå¹¶è¿›è¡Œé›†ç¾¤çš„ç›‘æ§ç­‰èŒè´£ï¼›</li><li><code>Worker(NM)</code>ï¼šæ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œä¸€ä¸ªWorkerè¿è¡Œåœ¨é›†ç¾¤ä¸­çš„ä¸€å°æœåŠ¡å™¨ä¸Šï¼Œä¸»è¦è´Ÿè´£ä¸¤ä¸ªèŒè´£ï¼Œä¸€ä¸ªæ˜¯ç”¨è‡ªå·±çš„å†…å­˜å­˜å‚¨RDDçš„æŸä¸ªæˆ–æŸäº›partitionï¼›å¦ä¸€ä¸ªæ˜¯å¯åŠ¨å…¶ä»–è¿›ç¨‹å’Œçº¿ç¨‹ï¼ˆExecutorï¼‰ï¼Œå¯¹RDDä¸Šçš„partitionè¿›è¡Œå¹¶è¡Œçš„å¤„ç†å’Œè®¡ç®—ã€‚</li><li><code>Executor</code>ï¼šæ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œä¸€ä¸ªWorkerä¸Šå¯ä»¥è¿è¡Œå¤šä¸ªExecutorï¼ŒExecutoré€šè¿‡å¯åŠ¨å¤šä¸ªçº¿ç¨‹ï¼ˆtaskï¼‰æ¥æ‰§è¡Œå¯¹RDDçš„partitionè¿›è¡Œå¹¶è¡Œè®¡ç®—ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œæˆ‘ä»¬å¯¹RDDå®šä¹‰çš„ä¾‹å¦‚mapã€flatMapã€reduceç­‰ç®—å­æ“ä½œã€‚</li></ol><h3 id="Standalone-Clientæ¨¡å¼"><a href="#Standalone-Clientæ¨¡å¼" class="headerlink" title="Standalone Clientæ¨¡å¼"></a>Standalone Clientæ¨¡å¼</h3><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830152737351.png" alt="image-20200830152737351"></p><p>åœ¨Standalone Clientæ¨¡å¼ä¸‹ï¼Œ<font color="red"><strong>Driveråœ¨ä»»åŠ¡æäº¤çš„æœ¬åœ°æœºå™¨ä¸Šè¿è¡Œ</strong></font>ï¼š</p><ol><li>Driverå¯åŠ¨ä¼šå‘Masteræ³¨å†Œåº”ç”¨ç¨‹åº</li><li>Masteræ ¹æ®submitè„šæœ¬çš„èµ„æºéœ€æ±‚æ‰¾åˆ°å†…éƒ¨èµ„æºè‡³å°‘å¯ä»¥å¯åŠ¨ä¸€ä¸ªExecutorçš„æ‰€æœ‰Worker</li><li>Workerä¹‹é—´åˆ†é…Executor</li><li>Executorå¼€å¯å®Œæ¯•åå‘Driveråé¦ˆ</li><li><font color="red">Driverå¼€å§‹æ‰§è¡Œmainå‡½æ•°ï¼Œä¹‹åæ‰§è¡Œåˆ°Actionç®—å­æ—¶ï¼Œå¼€å§‹åˆ’åˆ†stageï¼Œæ¯ä¸ªstageç”Ÿæˆå¯¹åº”çš„taskSetï¼Œä¹‹åå°†taskåˆ†å‘åˆ°å„ä¸ªExecutorä¸Šæ‰§è¡Œã€‚</font></li></ol><h3 id="Standalone-Clusteræ¨¡å¼"><a href="#Standalone-Clusteræ¨¡å¼" class="headerlink" title="Standalone Clusteræ¨¡å¼"></a>Standalone Clusteræ¨¡å¼</h3><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830154509558.png" alt="image-20200830154509558"></p><p>åœ¨Standalone Clusteræ¨¡å¼ä¸‹ï¼Œ<font color="red"><strong>ä»»åŠ¡æäº¤åï¼ŒMasterä¼šæ‰¾åˆ°ä¸€ä¸ªWorkerå¯åŠ¨Driverè¿›ç¨‹</strong></font></p><ol><li>Driverå¯åŠ¨ä¼šå‘Masteræ³¨å†Œåº”ç”¨ç¨‹åº</li><li>Masteræ ¹æ®submitè„šæœ¬çš„èµ„æºéœ€æ±‚æ‰¾åˆ°å†…éƒ¨èµ„æºè‡³å°‘å¯ä»¥å¯åŠ¨ä¸€ä¸ªExecutorçš„æ‰€æœ‰Worker</li><li>Workerä¹‹é—´åˆ†é…Executor</li><li>Executorå¼€å¯å®Œæ¯•åå‘Driveråé¦ˆ</li><li><font color="red">Driverå¼€å§‹æ‰§è¡Œmainå‡½æ•°ï¼Œä¹‹åæ‰§è¡Œåˆ°Actionç®—å­æ—¶ï¼Œå¼€å§‹åˆ’åˆ†stageï¼Œæ¯ä¸ªstageç”Ÿæˆå¯¹åº”çš„taskSetï¼Œä¹‹åå°†taskåˆ†å‘åˆ°å„ä¸ªExecutorä¸Šæ‰§è¡Œã€‚</font></li></ol><h2 id="Yarnæ¨¡å¼è¿è¡Œæœºåˆ¶ğŸ”º"><a href="#Yarnæ¨¡å¼è¿è¡Œæœºåˆ¶ğŸ”º" class="headerlink" title="Yarnæ¨¡å¼è¿è¡Œæœºåˆ¶ğŸ”º"></a>Yarnæ¨¡å¼è¿è¡Œæœºåˆ¶ğŸ”º</h2><h3 id="YARN-Clientæ¨¡å¼"><a href="#YARN-Clientæ¨¡å¼" class="headerlink" title="YARN Clientæ¨¡å¼"></a>YARN Clientæ¨¡å¼</h3><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830155921502.png" alt="image-20200830155921502"></p><p>åœ¨YARN Clientæ¨¡å¼ä¸‹ï¼Œ<font color="red"><strong>Driveråœ¨ä»»åŠ¡æäº¤çš„æœ¬åœ°æœºå™¨ä¸Šè¿è¡Œ</strong></font></p><ol><li>Driverå¯åŠ¨åä¼šå’ŒResourceManageré€šè®¯ç”³è¯·å¯åŠ¨ApplicationMaster</li><li>ResourceManageråˆ†é…containerï¼Œåœ¨åˆé€‚çš„NodeManagerä¸Šå¯åŠ¨ApplicationMaster</li><li>ApplicationMasterçš„åŠŸèƒ½ç›¸å½“äºä¸€ä¸ª<font color="red"><code>ExecutorLaucher</code></font>ï¼Œåªè´Ÿè´£å‘ResourceManagerç”³è¯·Executorå†…å­˜ã€‚</li><li>ResourceManageræ¥åˆ°ApplicationMasterçš„èµ„æºç”³è¯·åä¼šåˆ†é…containerï¼Œç„¶åApplicationMasteråœ¨èµ„æºåˆ†é…æŒ‡å®šçš„NodeManagerä¸Šå¯åŠ¨Executorè¿›ç¨‹</li><li><font color="red">Executorè¿›ç¨‹å¯åŠ¨åä¼šå‘Driveråå‘æ³¨å†Œ</font></li><li>Driverå¼€å§‹æ‰§è¡Œmainå‡½æ•°ï¼Œä¹‹åæ‰§è¡Œåˆ°Actionç®—å­æ—¶ï¼Œè§¦å‘ä¸€ä¸ªjobï¼Œå¹¶æ ¹æ®å®½ä¾èµ–å¼€å§‹åˆ’åˆ†stageï¼Œæ¯ä¸ªstageç”Ÿæˆå¯¹åº”çš„taskSetï¼Œä¹‹åå°†taskåˆ†å‘åˆ°å„ä¸ªExecutorä¸Šæ‰§è¡Œã€‚</li></ol><h3 id="YARN-Clusteræ¨¡å¼ğŸ”º"><a href="#YARN-Clusteræ¨¡å¼ğŸ”º" class="headerlink" title="YARN Clusteræ¨¡å¼ğŸ”º"></a>YARN Clusteræ¨¡å¼ğŸ”º</h3><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830160157808.png" alt="image-20200830160157808"></p><p>åœ¨YARN Clusteræ¨¡å¼ä¸‹ï¼Œ<font color="red"><strong>ä»»åŠ¡æäº¤åä¼šå’ŒResourceManageré€šè®¯ç”³è¯·å¯åŠ¨ApplicationMaster</strong></font></p><ol><li>éšåResourceManageråˆ†é…containerï¼Œåœ¨åˆé€‚çš„NodeManagerä¸Šå¯åŠ¨ApplicationMasterï¼Œæ­¤æ—¶çš„ApplicationMasterå°±æ˜¯Driverã€‚</li><li>Driverå¯åŠ¨åå‘ResourceManagerç”³è¯·Executorå†…å­˜</li><li>ResourceManageræ¥åˆ°ApplicationMasterçš„èµ„æºç”³è¯·åä¼šåˆ†é…containerï¼Œç„¶ååœ¨åˆé€‚çš„NodeManagerä¸Šå¯åŠ¨Executorè¿›ç¨‹</li><li>Executorè¿›ç¨‹å¯åŠ¨åä¼šå‘Driveråå‘æ³¨å†Œ</li><li>Driverå¼€å§‹æ‰§è¡Œmainå‡½æ•°ï¼Œä¹‹åæ‰§è¡Œåˆ°Actionç®—å­æ—¶ï¼Œè§¦å‘ä¸€ä¸ªjobï¼Œå¹¶æ ¹æ®å®½ä¾èµ–å¼€å§‹åˆ’åˆ†stageï¼Œæ¯ä¸ªstageç”Ÿæˆå¯¹åº”çš„taskSetï¼Œä¹‹åå°†taskåˆ†å‘åˆ°å„ä¸ªExecutorä¸Šæ‰§è¡Œã€‚</li></ol><h1 id="YARN-Clusteræ¨¡å¼æºä»£ç è§£è¯»ğŸ”ºğŸ”º"><a href="#YARN-Clusteræ¨¡å¼æºä»£ç è§£è¯»ğŸ”ºğŸ”º" class="headerlink" title="YARN Clusteræ¨¡å¼æºä»£ç è§£è¯»ğŸ”ºğŸ”º"></a>YARN Clusteræ¨¡å¼æºä»£ç è§£è¯»ğŸ”ºğŸ”º</h1><h2 id="Spark-Submit"><a href="#Spark-Submit" class="headerlink" title="Spark Submit"></a>Spark Submit</h2><p><strong>1. YARN Clusterçš„è®¡ç®—ç”±å‘½ä»¤å¼€å§‹ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bin/spark-submit \</span><br><span class="line">--class org.apache.spark.examples.SparkPi \</span><br><span class="line">--executor-memory 1G \</span><br><span class="line">--total-executor-cores 2 \</span><br><span class="line">-- master MASTER_URL yarn\</span><br><span class="line">-- deploy-mode cluster \</span><br><span class="line">./examples/jars/spark-examples_2.11-2.1.1.jar \</span><br><span class="line">100</span><br></pre></td></tr></table></figure><p><em>è°ƒç”¨å‘½ä»¤çš„æœ¬è´¨å°±æ˜¯å¯åŠ¨äº†SparkSubmitçš„è¿›ç¨‹ï¼Œé€šè¿‡Javaå‘½ä»¤ï¼š</em></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830162407076.png" alt="image-20200830162407076"></p><p><font color="red"><em>æ‰€ä»¥ï¼Œå½“æ‰§è¡Œåï¼Œæ­¤èŠ‚ç‚¹ä¼šç«‹é©¬å¼€å¯äº†ä¸€ä¸ªè¿›ç¨‹ï¼š<code>SparkSubmit</code></em></font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830162517111.png" alt="image-20200830162517111"></p><h3 id="SparkSubmitArgumentså‚æ•°å°è£…"><a href="#SparkSubmitArgumentså‚æ•°å°è£…" class="headerlink" title="SparkSubmitArgumentså‚æ•°å°è£…"></a>SparkSubmitArgumentså‚æ•°å°è£…</h3><p>å› ä¸º<code>SparkSubmit</code>æ˜¯é€šè¿‡<code>java xxx</code>å‘½ä»¤æ‰§è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç›´æ¥æŸ¥çœ‹å®ƒçš„mainæ–¹æ³•ï¼š</p><p>å›¾ä¸­åœˆå‡ºçš„éƒ¨åˆ†æ˜¯ä»£ç çš„å‚æ•°éªŒè¯ï¼Œå®ƒé™åˆ¶äº†éƒ¨ç½²æ¨¡å¼å¿…é¡»æ˜¯<code>client</code>ã€<code>cluster</code>çš„ä¸€ç§</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830163439950.png" alt="image-20200830163439950"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830163544480.png" alt="image-20200830163544480"></p><h3 id="submitæäº¤"><a href="#submitæäº¤" class="headerlink" title="submitæäº¤"></a>submitæäº¤</h3><p>ä¹‹åå‚æ•°éªŒè¯å®Œæ¯•åï¼Œæ ¹æ®æäº¤çŠ¶æ€ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®šå®ƒæ‰§è¡Œäº†<code>case SparkSubmitAction.SUBMIT =&gt; submit(appArgs)</code></p><p>submitå‡½æ•°ä¸­åˆ†åˆ«è°ƒç”¨äº†ï¼š</p><ul><li><code>prepareSubmitEnvironment</code></li><li><code>doRunMain</code></li></ul><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830164234921.png" alt="image-20200830164234921"></p><h4 id="prepareSubmitEnvironmentæäº¤ç¯å¢ƒå‡†å¤‡"><a href="#prepareSubmitEnvironmentæäº¤ç¯å¢ƒå‡†å¤‡" class="headerlink" title="prepareSubmitEnvironmentæäº¤ç¯å¢ƒå‡†å¤‡"></a>prepareSubmitEnvironmentæäº¤ç¯å¢ƒå‡†å¤‡</h4><p>åœ¨<code>prepareSubmitEnvironment</code>æ–¹æ³•çš„æºä»£ç ä¸­æˆ‘ä»¬æ‰¾åˆ°äº†å…³é”®éƒ¨åˆ†</p><p>å‘ç°<code>prepareSubmitEnvironment</code>çš„è¿”å›å€¼<code>childMainClass</code>è¢«èµ‹å€¼ä¸ºäº†<font color="red">**<code>org.apache.spark.deploy.yarn.Client</code>**</font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830164713753.png" alt="image-20200830164713753"></p><h4 id="doRunMain"><a href="#doRunMain" class="headerlink" title="doRunMain"></a>doRunMain</h4><p>åœ¨è¿è¡Œ<code>doRunMain</code>æ–¹æ³•å†…éƒ¨æ—¶å°†<code>prepareSubmitEnvironment</code>æ–¹æ³•çš„è¿”å›å€¼<code>childMainClass</code>ä¼ å…¥äº†æ–°æ–¹æ³•<code>runMain</code>ï¼Œæ­¤æ—¶å®ƒçš„å€¼æ˜¯**<code>org.apache.spark.deploy.yarn.Client</code>**</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830165235145.png" alt="image-20200830165235145"></p><h5 id="runMain"><a href="#runMain" class="headerlink" title="runMain"></a>runMain</h5><p>å‘ç°æ­¤æ–¹æ³•å¯¹ä¼ å…¥çš„<code>childMainClass</code>å³ï¼š**<code>org.apache.spark.deploy.yarn.Client</code><strong>è¿›è¡Œäº†è¿”å›è·å–å®ä½“ç±»ï¼Œ<font color="red">**å¹¶ä¸”åˆ¤æ–­å®ƒçš„mainæ–¹æ³•ï¼Œå¹¶è°ƒç”¨ï¼ï¼ï¼</strong></font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830165939807.png" alt="image-20200830165939807"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830170053716.png" alt="image-20200830170053716"></p><h2 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h2><p>ä¸Šé¢è¯´åˆ°Spark Submitçš„mainæ–¹æ³•é‡Œé¢ä»¥åå°„è°ƒç”¨äº†<code>org.apache.spark.deploy.yarn.Client</code>çš„mainæ–¹æ³•ï¼Œä¸‹é¢å¼€å§‹æŸ¥çœ‹<code>org.apache.spark.deploy.yarn.Client</code>çš„mainæ–¹æ³•ã€‚</p><p>å‘ç°ï¼š</p><ol><li>æ‰§è¡Œäº†å‚æ•°å°è£…</li><li>å¼€å¯çº¿ç¨‹æ‰§è¡ŒClientçš„é€»è¾‘ï¼Œæ³¨æ„è¿™é‡Œä¸æ˜¯ä»¥javaå‘½ä»¤æ‰§è¡Œçš„ï¼Œæ‰€ä»¥ä¸ä¼šå¼€å¯è¿›ç¨‹ï¼Œè€Œæ˜¯ä»¥çº¿ç¨‹æ–¹å¼æ‰§è¡Œçš„ï¼Œåªä¼šå¼€å¯ä¸€ä¸ªçº¿ç¨‹ã€‚</li></ol><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830170750827.png" alt="image-20200830170750827"></p><h3 id="ClientArguments"><a href="#ClientArguments" class="headerlink" title="ClientArguments"></a>ClientArguments</h3><p>å‚æ•°å°è£…æ—¶ï¼Œå¯¹æˆ‘ä»¬æœ€å¼€å§‹sparksubmitæ—¶æŒ‡å®šçš„classè¿›è¡Œäº†å°è£…</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830170956395.png" alt="image-20200830170956395"></p><h3 id="run"><a href="#run" class="headerlink" title="run"></a>run</h3><p><code>new Client(args, sparkConf).run()</code>ï¼Œä»¥çº¿ç¨‹çš„æ–¹å¼è¿è¡Œäº†Clientçº¿ç¨‹çš„é€»è¾‘ã€‚</p><p>ä¸Šé¢å¯ä»¥åˆ†ä¸ºä¸¤ç§é€»è¾‘ï¼š</p><ol><li>new Client</li><li>client.run</li></ol><h4 id="new-Client"><a href="#new-Client" class="headerlink" title="new Client"></a>new Client</h4><p>æŸ¥çœ‹å®ƒçš„æ„é€ æ–¹æ³•ï¼Œå‘ç°å®ƒåˆ›å»ºäº†å¯¹è±¡<code>private val yarnClient = YarnClient.createYarnClient</code></p><p>å†æ¬¡æŸ¥çœ‹å¯¹è±¡<code>YarnClient</code>çš„å†…å®¹ï¼Œå‘ç°å®ƒæœ‰RMï¼ŒResourceManagerçš„åœ°å€ã€‚</p><p><font color="red"><strong>æ‰€ä»¥ï¼ŒClientç±»å¯ä»¥é€šè¿‡å¯¹è±¡<code>yarnClient </code>æ¥ä¸<code>ResourceManager</code>è¿›è¡Œäº¤äº’ã€‚</strong></font></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">ApplicationClientProtocol</span> rmClient;</span><br><span class="line">  <span class="keyword">protected</span> <span class="type">InetSocketAddress</span> rmAddress;</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830171947757.png" alt="image-20200830171947757"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830172001381.png" alt="image-20200830172001381"></p><h4 id="client-run"><a href="#client-run" class="headerlink" title="client.run"></a><strong>client.run</strong></h4><p>å‘ç°æ–¹æ³•<code>submitApplication</code>è¿”å›äº†appIdï¼ŒappIdæ˜¯Yarnä¸­çš„æ¦‚å¿µï¼Œæ˜¯ä¸€ä¸ªå”¯ä¸€IDï¼Œæ¯ä¸ªæ‰§è¡Œä»»åŠ¡å”¯ä¸€çš„å¯¹åº”ä¸€ä¸ªã€‚<font color="red">æ‰€ä»¥<code>submitApplication</code>æ˜¯ä¸€ä¸ªä¸Yarnäº¤äº’å¹¶è·å–åˆ°appIdçš„æ–¹æ³•ã€‚</font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830172804937.png" alt="image-20200830172804937"></p><p>ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»¥spark-shellçš„yarn clientæ¨¡å¼è¿è¡Œçš„å°±æœ‰appIdã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830173010937.png" alt="image-20200830173010937"></p><h5 id="submitApplicationğŸ”º"><a href="#submitApplicationğŸ”º" class="headerlink" title="submitApplicationğŸ”º"></a>submitApplicationğŸ”º</h5><p>[ä¸Šè¿°çš„yarnClient](#new Client)æ˜¯ä¸€ä¸ªä¿å­˜ç€RMåœ°å€çš„å¯¹è±¡ï¼Œå®ƒåœ¨submitApplicationæ–¹æ³•ä¸­å¼€å§‹å¯¹RMè¿›è¡Œäº†è¿æ¥ã€‚</p><ol><li>åŒæ—¶å‘RMè¿›è¡Œäº†èµ„æºçš„ç”³è¯·ï¼Œé€šè¿‡RMçš„åé¦ˆ<code>newAppResponse</code>å¾—åˆ°äº†Yarnçš„å”¯ä¸€id</li><li>æ„å»ºåº”ç”¨AMçš„æŒ‡ä»¤</li><li>ç”³è¯·RMæ‰§è¡Œåº”ç”¨ï¼ï¼ï¼</li></ol><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830173429640.png" alt="image-20200830173429640"></p><h6 id="createContainerLaunchContextğŸ”º"><a href="#createContainerLaunchContextğŸ”º" class="headerlink" title="createContainerLaunchContextğŸ”º"></a>createContainerLaunchContextğŸ”º</h6><p><font color="red"><strong>AMæ‰§è¡Œå°è£…æŒ‡ä»¤ï¼Œcommand</strong></font></p><p>æ­¤æ–¹æ³•æ˜¯<code>logInfo(&quot;Setting up container launch context for our AM&quot;)</code>ï¼Œå¯åŠ¨context for our AMçš„æŒ‡ä»¤å†…å®¹ã€‚</p><p>å‘ç°ï¼š</p><ol><li>clusteræ¨¡å¼æ„å»ºçš„Javaå‘½ä»¤å¯åŠ¨çš„æ˜¯<code>org.apache.spark.deploy.yarn.ApplicationMaster</code></li><li>clientæ¨¡å¼æ„å»ºçš„Javaå‘½ä»¤å¯åŠ¨çš„æ˜¯<code>org.apache.spark.deploy.yarn.ExecutorLauncher</code></li></ol><p><font color="red"><strong>æ³¨æ„ï¼šå› ä¸ºæ˜¯ä»¥Javaå‘½ä»¤é€šçŸ¥RMå¯åŠ¨çš„ï¼ŒRMä¼šå¯»æ‰¾ä¸€ä¸ªNMæ¥é€šè¿‡Javaå‘½ä»¤å¯åŠ¨ï¼Œæ‰€ä»¥ä»¥<code>ApplicationMaster</code>ä¸ºä¾‹ï¼Œå®ƒå¯åŠ¨çš„åº”è¯¥æ˜¯è¿›ç¨‹ã€‚</strong></font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830174128613.png" alt="image-20200830174128613"></p><p>ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»¥spark-shellçš„yarn clientæ¨¡å¼è¿è¡Œçš„å¯åŠ¨çš„æ˜¯<code>ExecutorLauncher</code>ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830174427258.png" alt="image-20200830174427258"></p><h2 id="ApplicationMasterğŸ”º"><a href="#ApplicationMasterğŸ”º" class="headerlink" title="ApplicationMasterğŸ”º"></a>ApplicationMasterğŸ”º</h2><p><font color="red"><strong>ApplicationMasteræ˜¯ä»¥è¿›ç¨‹å¯åŠ¨çš„</strong></font></p><p>ä¸Šé¢å¾—çŸ¥ï¼Œé€šè¿‡javaå‘½ä»¤çš„æ–¹æ³•å¼€å¯äº†ä¸€å°NMæ‰§è¡ŒAMï¼Œæ‰€ä»¥ä¸‹é¢æŸ¥çœ‹AMçš„mainï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830180331230.png" alt="image-20200830180331230"></p><h3 id="master-run"><a href="#master-run" class="headerlink" title="master.run"></a>master.run</h3><p>æ­¤æ–¹æ³•ä¸­çš„å…³é”®ç‚¹ï¼šåœ¨AMä¸­è¿è¡Œ</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830180521026.png" alt="image-20200830180521026"></p><h4 id="runDriver"><a href="#runDriver" class="headerlink" title="runDriver"></a>runDriver</h4><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830180708534.png" alt="image-20200830180708534"></p><h5 id="startUserApplicationï¼šå¯åŠ¨Driverç±»çš„main"><a href="#startUserApplicationï¼šå¯åŠ¨Driverç±»çš„main" class="headerlink" title="startUserApplicationï¼šå¯åŠ¨Driverç±»çš„main"></a>startUserApplicationï¼šå¯åŠ¨Driverç±»çš„main</h5><p>æ­¤æ–¹æ³•æ˜¯å¯åŠ¨Driverç±»ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è‡ªå·±ç¼–å†™çš„å¸¦æœ‰<code>sparkContext</code>çš„ç±»ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æœ€å¼€å§‹spark-submitæäº¤æ—¶classçš„å‚æ•°çš„ç±»ã€‚</p><ol><li>é€šè¿‡ä¸€ç›´ä¼ é€’çš„å‚æ•°ï¼Œå¼€å§‹è·å–æˆ‘ä»¬ç¼–å†™çš„ç±»</li><li>è·å–åˆ°ç±»åï¼Œé€šè¿‡åå°„è·å–åˆ°mainå‡½æ•°</li><li>ç„¶åé€šè¿‡åå°„è°ƒç”¨mainå‡½æ•°</li></ol><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830180856820.png" alt="image-20200830180856820"></p><h5 id="registerAM"><a href="#registerAM" class="headerlink" title="registerAM"></a>registerAM</h5><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830182105200.png" alt="image-20200830182105200"></p><h6 id="allocateResources"><a href="#allocateResources" class="headerlink" title="allocateResources"></a>allocateResources</h6><p>RMå‘AMç”³è¯·èµ„æºï¼š</p><p>ç”±ä¸Šé¢å¯çŸ¥amClientæ˜¯å­˜å‚¨äº†AMåœ°å€çš„å¯¹è±¡ï¼Œç”±æ­¤å¯¹è±¡è¿æ¥AMè·å–å¯åˆ†é…çš„èµ„æº</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830182245257.png" alt="image-20200830182245257"></p><h6 id="handleAllocatedContainersåˆ†é…å¼€å¯å®¹å™¨"><a href="#handleAllocatedContainersåˆ†é…å¼€å¯å®¹å™¨" class="headerlink" title="handleAllocatedContainersåˆ†é…å¼€å¯å®¹å™¨"></a>handleAllocatedContainersåˆ†é…å¼€å¯å®¹å™¨</h6><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830182438026.png" alt="image-20200830182438026"></p><h6 id="runAllocatedContainers"><a href="#runAllocatedContainers" class="headerlink" title="runAllocatedContainers"></a>runAllocatedContainers</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Launches executors in the allocated containers.</span><br></pre></td></tr></table></figure><p>åœ¨æ¯ä¸ªåˆ†é…çš„å®¹å™¨ä¸­å¯åŠ¨æ‰§è¡Œç¨‹åºã€‚çœ‹åˆ°å¯åŠ¨äº†ä¸€ä¸ªExecutorRunnableçš„çº¿ç¨‹åœ¨çº¿ç¨‹æ± é‡Œã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830182553599.png" alt="image-20200830182553599"></p><h6 id="ExecutorRunnable"><a href="#ExecutorRunnable" class="headerlink" title="ExecutorRunnable"></a>ExecutorRunnable</h6><p>çœ‹åˆ°æ­¤çº¿ç¨‹çš„é€»è¾‘å°±æ˜¯é€šè¿‡<code>nmClient</code>è¿æ¥NMèŠ‚ç‚¹å¼€å§‹<code>container</code></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830182659297.png" alt="image-20200830182659297"></p><p><font color="red"><strong>é‚£ä¹ˆï¼Œæ˜¯å¦‚ä½•å¼€å¯Containerå®¹å™¨å‘¢</strong></font></p><h6 id="startContainerğŸ”º"><a href="#startContainerğŸ”º" class="headerlink" title="startContainerğŸ”º"></a>startContainerğŸ”º</h6><p>å‘ç°æ­¤æ–¹æ³•ä¸­åˆè°ƒç”¨äº†æ–¹æ³•<code>val commands = prepareCommand()</code>æ¥<font color="red">ç”ŸæˆJavaå‘½ä»¤è¡Œå‘½ä»¤æ¥å¼€å¯<code>org.apache.spark.executor.CoarseGrainedExecutorBackend</code></font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830183133066.png" alt="image-20200830183133066"></p><p><font color="red"><strong>æ‰€ä»¥Containerå®¹å™¨ä¸­å¼€å¯äº†<code>CoarseGrainedExecutorBackend</code>ï¼Œå®ƒæ˜¯æ¥è®¡ç®—ä»»åŠ¡çš„ï¼Œå³Executorçš„åå°ã€‚</strong></font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830183322800.png" alt="image-20200830183322800"></p><h2 id="CoarseGrainedExecutorBackend"><a href="#CoarseGrainedExecutorBackend" class="headerlink" title="CoarseGrainedExecutorBackend"></a>CoarseGrainedExecutorBackend</h2><p><font color="red"><strong>CoarseGrainedExecutorBackendæ˜¯ä»¥è¿›ç¨‹å¯åŠ¨çš„</strong></font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830183429858.png" alt="image-20200830183429858"></p><h3 id="run-1"><a href="#run-1" class="headerlink" title="run"></a>run</h3><p>å‘ç°å®ƒæ–°å»ºäº†ä¸€ä¸ªè®¡ç®—<strong>ç»ˆç«¯</strong>ç¯å¢ƒï¼Œé€šè¿‡æŸ¥çœ‹å®ƒçš„ç±»æ—¶ï¼š<code>CoarseGrainedExecutorBackend</code></p><p>å‘ç°äº†æ–°çš„å±æ€§<code>var executor: Executor = null</code>ï¼Œè¿™æ—¶å‘ç°æ­¤å¯¹è±¡æ‰æ˜¯è®¡ç®—çš„æ ¹æœ¬ï¼ï¼ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830183711553.png" alt="image-20200830183711553"></p><p>å‘ç°å®ƒç»§æ‰¿äº†<code>ThreadSafeRpcEndpoint</code>ï¼Œè€Œ<code>ThreadSafeRpcEndpoint</code>ç»ˆç«¯æœ‰å››ä¸ªç”Ÿå‘½å‘¨æœŸï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830183921529.png" alt="image-20200830183921529"></p><p>å› ä¸ºCoarseGrainedExecutorBackendç»§æ‰¿äº†å®ƒï¼Œæ‰€ä»¥ä»–ä¹Ÿæ˜¯ä¸ªç»ˆç«¯ï¼Œä¸”CoarseGrainedExecutorBackendå¼€å¯åä¼šæ‰§è¡ŒonStartä¸­å®šä¹‰çš„äº‹æƒ…ï¼šåœ¨Containerçš„CoarseGrainedExecutorBackendåˆ›å»ºå®Œæ¯•åä¼šå‘Driveræ‰€åœ¨çš„ç»ˆç«¯å‘é€Executorå¯åŠ¨å®Œæ¯•çš„ä¿¡æ¯</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830184011123.png" alt="image-20200830184011123"></p><p>è€Œæˆ‘ä»¬Driverçš„æ”¶åˆ°ä¿¡æ¯åï¼Œä¼šåé¦ˆç»™CoarseGrainedExecutorBackendï¼ŒCoarseGrainedExecutorBackendæ”¶åˆ°ä¿¡æ¯åæ‰§è¡Œä»¥ä¸‹å†…å®¹ï¼Œåˆ›å»ºè®¡ç®—å¯¹è±¡ï¼Œä¸Šé¢è®²åˆ°CoarseGrainedExecutorBackendå¹¶ä¸æ˜¯ä¸€ä¸ªè®¡ç®—å¯¹è±¡ï¼Œæœ‰ç€è®¡ç®—ä½œç”¨çš„æ˜¯å®ƒçš„å±æ€§<code>executor</code>ï¼Œè¿™æ—¶åˆ›å»º<code>executor</code>å±æ€§</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830184231615.png" alt="image-20200830184231615"></p><p>ä»¥ä¸Šèµ„æºè°ƒåº¦å®Œäº‹ï¼ŒExecutorå·²ç»å¯åŠ¨</p><h2 id="æ€»ç»“ğŸ”º"><a href="#æ€»ç»“ğŸ”º" class="headerlink" title="æ€»ç»“ğŸ”º"></a>æ€»ç»“ğŸ”º</h2><p>ä¸Šé¢çš„æºç å·²ç»å®Œå…¨çš„è§£é‡Šäº†ä¸‹å›¾ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830185102697.png" alt="image-20200830185102697"></p><p>ç”±æºç çš„æµç¨‹å¯çœ‹å‡ºå…±å¯åŠ¨äº†ä»¥ä¸‹å‡ ç§è¿›ç¨‹ï¼š</p><ol><li>spark-submitï¼šå‘å¸ƒä»»åŠ¡çš„å®¢æˆ·ç«¯å¯åŠ¨</li><li>ApplicationMasterï¼šRMéšæœºæ‰¾ä¸€å°NMå¯åŠ¨</li><li>CoarseGrainedExecutorBackendï¼šAMç”³è¯·åˆ°çš„NMä¸­çš„Containerä¸­å¯åŠ¨ï¼Œæ­¤è¿›ç¨‹ä¸­çš„CoarseGrainedExecutorBackendå¯¹è±¡çš„Executorå±æ€§æ‰æ˜¯è®¡ç®—çš„å±æ€§</li></ol><hr><h1 id="Spark-ä»»åŠ¡è°ƒåº¦æœºåˆ¶"><a href="#Spark-ä»»åŠ¡è°ƒåº¦æœºåˆ¶" class="headerlink" title="Spark ä»»åŠ¡è°ƒåº¦æœºåˆ¶"></a>Spark ä»»åŠ¡è°ƒåº¦æœºåˆ¶</h1><p>åœ¨å·¥å‚ç¯å¢ƒä¸‹ï¼ŒSparké›†ç¾¤çš„éƒ¨ç½²æ–¹å¼ä¸€èˆ¬ä¸ºYARN-Clusteræ¨¡å¼ï¼Œä¹‹åçš„å†…æ ¸åˆ†æå†…å®¹ä¸­æˆ‘ä»¬é»˜è®¤é›†ç¾¤çš„éƒ¨ç½²æ–¹å¼ä¸ºYARN-Clusteræ¨¡å¼ã€‚</p><h2 id="Sparkä»»åŠ¡æäº¤æµç¨‹"><a href="#Sparkä»»åŠ¡æäº¤æµç¨‹" class="headerlink" title="Sparkä»»åŠ¡æäº¤æµç¨‹"></a>Sparkä»»åŠ¡æäº¤æµç¨‹</h2><p>åœ¨ä¸Šä¸€ç« ä¸­æˆ‘ä»¬è®²è§£äº†Spark YARN-Clusteræ¨¡å¼ä¸‹çš„ä»»åŠ¡æäº¤æµç¨‹</p><p>ä¸‹é¢çš„æ—¶åºå›¾æ¸…æ™°åœ°è¯´æ˜äº†ä¸€ä¸ªSparkåº”ç”¨ç¨‹åºä»æäº¤åˆ°è¿è¡Œçš„å®Œæ•´æµç¨‹ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830185555274.png" alt="image-20200830185555274"></p><p>æäº¤ä¸€ä¸ªSparkåº”ç”¨ç¨‹åºï¼Œé¦–å…ˆé€šè¿‡Clientå‘ResourceManagerè¯·æ±‚å¯åŠ¨ä¸€ä¸ªApplicationï¼ŒåŒæ—¶æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„èµ„æºæ»¡è¶³Applicationçš„éœ€æ±‚ï¼Œå¦‚æœèµ„æºæ¡ä»¶æ»¡è¶³ï¼Œåˆ™å‡†å¤‡ApplicationMasterçš„å¯åŠ¨ä¸Šä¸‹æ–‡ï¼Œäº¤ç»™ResourceManagerï¼Œå¹¶å¾ªç¯ç›‘æ§ApplicationçŠ¶æ€ã€‚</p><p>å½“æäº¤çš„èµ„æºé˜Ÿåˆ—ä¸­æœ‰èµ„æºæ—¶ï¼ŒResourceManagerä¼šåœ¨æŸä¸ªNodeManagerä¸Šå¯åŠ¨ApplicationMasterè¿›ç¨‹ï¼Œ<font color="red">ApplicationMasterä¼šå•ç‹¬å¯åŠ¨Driveråå°çº¿ç¨‹ï¼Œå½“Driverå¯åŠ¨åï¼ŒApplicationMasterä¼šé€šè¿‡æœ¬åœ°çš„RPCè¿æ¥Driver</font>ï¼Œå¹¶å¼€å§‹å‘ResourceManagerç”³è¯·Containerèµ„æºè¿è¡ŒExecutorè¿›ç¨‹ï¼ˆä¸€ä¸ªExecutorå¯¹åº”ä¸ä¸€ä¸ªContainerï¼‰ï¼Œå½“ResourceManagerè¿”å›Containerèµ„æºï¼ŒApplicationMasteråˆ™åœ¨å¯¹åº”çš„Containerä¸Šå¯åŠ¨Executorã€‚</p><p>Driverçº¿ç¨‹ä¸»è¦æ˜¯åˆå§‹åŒ–SparkContextå¯¹è±¡ï¼Œå‡†å¤‡è¿è¡Œæ‰€éœ€çš„ä¸Šä¸‹æ–‡ï¼Œç„¶åä¸€æ–¹é¢ä¿æŒä¸ApplicationMasterçš„RPCè¿æ¥ï¼Œé€šè¿‡ApplicationMasterç”³è¯·èµ„æºï¼Œå¦ä¸€æ–¹é¢æ ¹æ®ç”¨æˆ·ä¸šåŠ¡é€»è¾‘å¼€å§‹è°ƒåº¦ä»»åŠ¡ï¼Œå°†ä»»åŠ¡ä¸‹å‘åˆ°å·²æœ‰çš„ç©ºé—²Executorä¸Šã€‚</p><p>å½“ResourceManagerå‘ApplicationMasterè¿”å›Containerèµ„æºæ—¶ï¼ŒApplicationMasterå°±å°è¯•åœ¨å¯¹åº”çš„Containerä¸Šå¯åŠ¨Executorè¿›ç¨‹ï¼Œ<font color="red">Executorè¿›ç¨‹èµ·æ¥åï¼Œä¼šå‘Driveråå‘æ³¨å†Œï¼Œæ³¨å†ŒæˆåŠŸåä¿æŒä¸Driverçš„å¿ƒè·³ï¼ŒåŒæ—¶ç­‰å¾…Driveråˆ†å‘ä»»åŠ¡ï¼Œå½“åˆ†å‘çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå°†ä»»åŠ¡çŠ¶æ€ä¸ŠæŠ¥ç»™Driverã€‚</font></p><p>ä»ä¸Šè¿°æ—¶åºå›¾å¯çŸ¥ï¼ŒClientåªè´Ÿè´£æäº¤Applicationå¹¶ç›‘æ§Applicationçš„çŠ¶æ€ã€‚å¯¹äºSparkçš„ä»»åŠ¡è°ƒåº¦ä¸»è¦æ˜¯é›†ä¸­åœ¨ä¸¤ä¸ªæ–¹é¢: <strong>èµ„æºç”³è¯·å’Œä»»åŠ¡åˆ†å‘</strong>ï¼Œå…¶ä¸»è¦æ˜¯é€šè¿‡ApplicationMasterã€Driverä»¥åŠExecutorä¹‹é—´æ¥å®Œæˆã€‚</p><h2 id="Sparkä»»åŠ¡è°ƒåº¦æ¦‚è¿°ğŸ”º"><a href="#Sparkä»»åŠ¡è°ƒåº¦æ¦‚è¿°ğŸ”º" class="headerlink" title="Sparkä»»åŠ¡è°ƒåº¦æ¦‚è¿°ğŸ”º"></a>Sparkä»»åŠ¡è°ƒåº¦æ¦‚è¿°ğŸ”º</h2><p>å½“Driverèµ·æ¥åï¼ŒDriveråˆ™ä¼šæ ¹æ®ç”¨æˆ·ç¨‹åºé€»è¾‘å‡†å¤‡ä»»åŠ¡ï¼Œå¹¶æ ¹æ®Executorèµ„æºæƒ…å†µé€æ­¥åˆ†å‘ä»»åŠ¡ã€‚åœ¨è¯¦ç»†é˜è¿°ä»»åŠ¡è°ƒåº¦å‰ï¼Œé¦–å…ˆè¯´æ˜ä¸‹Sparké‡Œçš„å‡ ä¸ªæ¦‚å¿µã€‚ä¸€ä¸ªSparkåº”ç”¨ç¨‹åºåŒ…æ‹¬Jobã€Stageä»¥åŠTaskä¸‰ä¸ªæ¦‚å¿µï¼š</p><ul><li> Jobæ˜¯ä»¥Actionæ–¹æ³•ä¸ºç•Œï¼Œé‡åˆ°ä¸€ä¸ªActionæ–¹æ³•åˆ™è§¦å‘ä¸€ä¸ªJobï¼›</li><li>Stageæ˜¯Jobçš„å­é›†ï¼Œä»¥RDDå®½ä¾èµ–(å³Shuffle)ä¸ºç•Œï¼Œé‡åˆ°Shuffleåšä¸€æ¬¡åˆ’åˆ†ï¼›</li><li> Taskæ˜¯Stageçš„å­é›†ï¼Œä»¥å¹¶è¡Œåº¦(åˆ†åŒºæ•°)æ¥è¡¡é‡ï¼Œåˆ†åŒºæ•°æ˜¯å¤šå°‘ï¼Œåˆ™æœ‰å¤šå°‘ä¸ªtaskã€‚</li></ul><p>Sparkçš„ä»»åŠ¡è°ƒåº¦æ€»ä½“æ¥è¯´åˆ†ä¸¤è·¯è¿›è¡Œï¼Œ<font color="red"><strong>ä¸€è·¯æ˜¯Stageçº§çš„è°ƒåº¦ï¼Œä¸€è·¯æ˜¯Taskçº§çš„è°ƒåº¦</strong></font>ï¼Œæ€»ä½“è°ƒåº¦æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830190028855.png" alt="image-20200830190028855"></p><p>Spark RDDé€šè¿‡å…¶Transactionsæ“ä½œï¼Œå½¢æˆäº†RDDè¡€ç¼˜å…³ç³»å›¾ï¼Œå³DAGï¼Œæœ€åé€šè¿‡Actionçš„è°ƒç”¨ï¼Œè§¦å‘Jobå¹¶è°ƒåº¦æ‰§è¡Œã€‚</p><p><font color="red"><strong>DAGSchedulerè´Ÿè´£Stageçº§çš„è°ƒåº¦</strong></font>ï¼Œä¸»è¦æ˜¯å°†jobåˆ‡åˆ†æˆè‹¥å¹²Stagesï¼Œå¹¶å°†æ¯ä¸ªStageæ‰“åŒ…æˆTaskSetäº¤ç»™TaskSchedulerè°ƒåº¦ã€‚</p><p><font color="red"><strong>TaskSchedulerè´Ÿè´£Taskçº§çš„è°ƒåº¦</strong></font>ï¼Œå°†DAGSchedulerç»™è¿‡æ¥çš„TaskSetæŒ‰ç…§æŒ‡å®šçš„è°ƒåº¦ç­–ç•¥åˆ†å‘åˆ°Executorä¸Šæ‰§è¡Œï¼Œè°ƒåº¦è¿‡ç¨‹ä¸­SchedulerBackendè´Ÿè´£æä¾›å¯ç”¨èµ„æºï¼Œå…¶ä¸­<strong>SchedulerBackendæœ‰å¤šç§å®ç°ï¼Œåˆ†åˆ«å¯¹æ¥ä¸åŒçš„èµ„æºç®¡ç†ç³»ç»Ÿ</strong>ã€‚</p><p>ä¸‹é¢è¿™å¼ å›¾æè¿°äº†Spark-On-Yarnæ¨¡å¼ä¸‹åœ¨ä»»åŠ¡è°ƒåº¦æœŸé—´ï¼ŒApplicationMasterã€Driverä»¥åŠExecutorå†…éƒ¨æ¨¡å—çš„äº¤äº’è¿‡ç¨‹ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830190229195.png" alt="image-20200830190229195"></p><h2 id="Spark-Stageçº§è°ƒåº¦ğŸ”º"><a href="#Spark-Stageçº§è°ƒåº¦ğŸ”º" class="headerlink" title="Spark Stageçº§è°ƒåº¦ğŸ”º"></a>Spark Stageçº§è°ƒåº¦ğŸ”º</h2><p>Sparkçš„ä»»åŠ¡è°ƒåº¦æ˜¯ä»DAGåˆ‡å‰²å¼€å§‹ï¼Œä¸»è¦æ˜¯ç”±DAGScheduleræ¥å®Œæˆã€‚å½“é‡åˆ°ä¸€ä¸ªActionæ“ä½œåå°±ä¼šè§¦å‘ä¸€ä¸ªJobçš„è®¡ç®—ï¼Œå¹¶äº¤ç»™DAGScheduleræ¥æäº¤ï¼Œä¸‹å›¾æ˜¯æ¶‰åŠåˆ°Jobæäº¤çš„ç›¸å…³æ–¹æ³•è°ƒç”¨æµç¨‹å›¾ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830190303628.png" alt="image-20200830190303628"></p><p><font color="red">**<code>dag.submit</code>**æäº¤stageæ—¶å…ˆæäº¤ç¬¬ä¸€ä¸ªStageï¼Œåœ¨Stageåˆ‡åˆ†é˜¶æ®µé™¤äº†æœ€åä¸€ä¸ªStageå«<code>ResultStage</code>åªè¿›è¡ŒShuffle Readï¼Œå…¶ä½™Stageå‡ç§°ä¸º<code>ShuffleMapStage</code>å‡è¿›è¡ŒShuffle Readå’ŒWriteï¼Œé™¤äº†ç¬¬ä¸€ä¸ªä¸è¿›è¡ŒRead</font></p><p>Jobç”±æœ€ç»ˆçš„RDDå’ŒActionæ–¹æ³•å°è£…è€Œæˆï¼ŒSparkContextå°†Jobäº¤ç»™DAGScheduleræäº¤ï¼Œå®ƒä¼šæ ¹æ®RDDçš„è¡€ç¼˜å…³ç³»æ„æˆçš„DAGè¿›è¡Œåˆ‡åˆ†ï¼Œå°†ä¸€ä¸ªJobåˆ’åˆ†ä¸ºè‹¥å¹²Stagesï¼Œ<font color="red">å…·ä½“åˆ’åˆ†ç­–ç•¥æ˜¯ï¼Œç”±æœ€ç»ˆçš„RDDä¸æ–­é€šè¿‡ä¾èµ–å›æº¯åˆ¤æ–­çˆ¶ä¾èµ–æ˜¯å¦æ˜¯å®½ä¾èµ–ï¼Œå³ä»¥Shuffleä¸ºç•Œï¼Œåˆ’åˆ†Stageï¼Œçª„ä¾èµ–çš„RDDä¹‹é—´è¢«åˆ’åˆ†åˆ°åŒä¸€ä¸ªStageä¸­ï¼Œå¯ä»¥è¿›è¡Œpipelineå¼çš„è®¡ç®—</font></p><p>å¦‚å›¾ç´«è‰²æµç¨‹éƒ¨åˆ†ã€‚åˆ’åˆ†çš„Stagesåˆ†ä¸¤ç±»ï¼Œä¸€ç±»å«åšResultStageï¼Œ<strong>ä¸ºDAGæœ€ä¸‹æ¸¸çš„Stage</strong>ï¼Œç”±Actionæ–¹æ³•å†³å®šï¼Œ<strong>å¦ä¸€ç±»å«åšShuffleMapStageï¼Œä¸ºä¸‹æ¸¸Stageå‡†å¤‡æ•°æ®</strong>ï¼Œä¸‹é¢çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­WordCountã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830190837690.png" alt="image-20200830190837690"></p><p>Jobç”±saveAsTextFileè§¦å‘ï¼Œè¯¥Jobç”±RDD-3å’ŒsaveAsTextFileæ–¹æ³•ç»„æˆï¼Œæ ¹æ®RDDä¹‹é—´çš„ä¾èµ–å…³ç³»ä»RDD-3å¼€å§‹å›æº¯æœç´¢ï¼Œç›´åˆ°æ²¡æœ‰ä¾èµ–çš„RDD-0ï¼Œ<strong>åœ¨å›æº¯æœç´¢è¿‡ç¨‹ä¸­ï¼ŒRDD-3ä¾èµ–RDD-2ï¼Œå¹¶ä¸”æ˜¯å®½ä¾èµ–</strong>ï¼Œæ‰€ä»¥åœ¨RDD-2å’ŒRDD-3ä¹‹é—´åˆ’åˆ†Stageï¼ŒRDD-3è¢«åˆ’åˆ°æœ€åä¸€ä¸ªStageï¼Œå³ResultStageä¸­ï¼ŒRDD-2ä¾èµ–RDD-1ï¼ŒRDD-1ä¾èµ–RDD-0ï¼Œè¿™äº›ä¾èµ–éƒ½æ˜¯çª„ä¾èµ–ï¼Œæ‰€ä»¥å°†RDD-0ã€RDD-1å’ŒRDD-2åˆ’åˆ†åˆ°åŒä¸€ä¸ªStage<strong>ï¼Œå³ShuffleMapStageä¸­ï¼Œå®é™…æ‰§è¡Œçš„æ—¶å€™ï¼Œæ•°æ®è®°å½•ä¼šä¸€æ°”å‘µæˆåœ°æ‰§è¡ŒRDD-0åˆ°RDD-2çš„è½¬åŒ–</strong>ã€‚ä¸éš¾çœ‹å‡ºï¼Œå…¶æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ·±åº¦ä¼˜å…ˆæœç´¢ç®—æ³•ã€‚</p><p><font color="red">ä¸€ä¸ªStageæ˜¯å¦è¢«æäº¤ï¼Œéœ€è¦åˆ¤æ–­å®ƒçš„çˆ¶Stageæ˜¯å¦æ‰§è¡Œï¼Œåªæœ‰åœ¨çˆ¶Stageæ‰§è¡Œå®Œæ¯•æ‰èƒ½æäº¤å½“å‰Stageï¼Œå¦‚æœä¸€ä¸ªStageæ²¡æœ‰çˆ¶Stageï¼Œé‚£ä¹ˆä»è¯¥Stageå¼€å§‹æäº¤ã€‚Stageæäº¤æ—¶ä¼šå°†Taskä¿¡æ¯ï¼ˆåˆ†åŒºä¿¡æ¯ä»¥åŠæ–¹æ³•ç­‰ï¼‰åºåˆ—åŒ–å¹¶è¢«æ‰“åŒ…æˆTaskSetäº¤ç»™TaskScheduler</font>ï¼Œä¸€ä¸ªPartitionå¯¹åº”ä¸€ä¸ªTaskï¼Œå¦ä¸€æ–¹é¢TaskSchedulerä¼šç›‘æ§Stageçš„è¿è¡ŒçŠ¶æ€ï¼Œåªæœ‰Executorä¸¢å¤±æˆ–è€…Taskç”±äºFetchå¤±è´¥æ‰éœ€è¦é‡æ–°æäº¤å¤±è´¥çš„Stageä»¥è°ƒåº¦è¿è¡Œå¤±è´¥çš„ä»»åŠ¡ï¼Œå…¶ä»–ç±»å‹çš„Taskå¤±è´¥ä¼šåœ¨TaskSchedulerçš„è°ƒåº¦è¿‡ç¨‹ä¸­é‡è¯•ã€‚</p><p>ç›¸å¯¹æ¥è¯´DAGScheduleråšçš„äº‹æƒ…è¾ƒä¸ºç®€å•ï¼Œä»…ä»…æ˜¯åœ¨Stageå±‚é¢ä¸Šåˆ’åˆ†DAGï¼Œæäº¤Stageå¹¶ç›‘æ§ç›¸å…³çŠ¶æ€ä¿¡æ¯ã€‚TaskScheduleråˆ™ç›¸å¯¹è¾ƒä¸ºå¤æ‚ï¼Œä¸‹é¢è¯¦ç»†é˜è¿°å…¶ç»†èŠ‚ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>DAGSchedulerå°±æ˜¯å¯¹æ•´ä¸ªJobè¿›è¡Œäº†Stageçš„åˆ‡åˆ†ï¼Œå¹¶å¯¹æ¯ä¸ªStageçš„å¤šä¸ªTaskå°è£…ä¸ºTaskSetäº¤ç»™TaskSchedulerã€‚</p><p>DAGScheduleråœ¨æäº¤Stageæ—¶ï¼Œä»ç¬¬ä¸€ä¸ªå¾€åæäº¤ï¼Œå› ä¸ºæ¯ä¸ªStageä¹‹é—´éƒ½å­˜åœ¨Shuffleï¼Œéœ€è¦ä¸Šä¸ªStageçš„Shuffle Wrtireçš„æ•°æ®</p><h2 id="Spark-Taskçº§è°ƒåº¦"><a href="#Spark-Taskçº§è°ƒåº¦" class="headerlink" title="Spark Taskçº§è°ƒåº¦"></a>Spark Taskçº§è°ƒåº¦</h2><p>Spark Taskçš„è°ƒåº¦æ˜¯ç”±TaskScheduleræ¥å®Œæˆï¼Œç”±å‰æ–‡å¯çŸ¥ï¼ŒDAGSchedulerå°†Stageæ‰“åŒ…åˆ°TaskSetäº¤ç»™TaskSchedulerï¼ŒTaskSchedulerä¼šå°†TaskSetå°è£…ä¸ºTaskSetManageråˆ°è°ƒåº¦é˜Ÿåˆ—ä¸­ï¼ŒTaskSetManagerç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830191254343.png" alt="image-20200830191254343"></p><p><font color="red"><strong>TaskSetManagerè´Ÿè´£ç›‘æ§ç®¡ç†åŒä¸€ä¸ªStageä¸­çš„Tasksï¼ŒTaskSchedulerå°±æ˜¯ä»¥TaskSetManagerä¸ºå•å…ƒæ¥è°ƒåº¦ä»»åŠ¡ã€‚</strong></font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830191444090.png" alt="image-20200830191444090"></p><p>å‰é¢ä¹Ÿæåˆ°ï¼Œ<font color="red">TaskScheduleråˆå§‹åŒ–åä¼šå¯åŠ¨SchedulerBackendï¼Œå®ƒè´Ÿè´£è·Ÿå¤–ç•Œæ‰“äº¤é“ï¼Œæ¥æ”¶Executorçš„æ³¨å†Œä¿¡æ¯ï¼Œå¹¶ç»´æŠ¤Executorçš„çŠ¶æ€</font>ï¼Œæ‰€ä»¥è¯´SchedulerBackendæ˜¯ç®¡â€œè·å–ä»»åŠ¡â€çš„ï¼ŒåŒæ—¶å®ƒåœ¨å¯åŠ¨åä¼šå®šæœŸåœ°å»â€œè¯¢é—®â€TaskScheduleræœ‰æ²¡æœ‰ä»»åŠ¡è¦è¿è¡Œï¼ŒTaskScheduleråœ¨SchedulerBackendâ€œé—®â€å®ƒçš„æ—¶å€™ï¼Œä¼šä»è°ƒåº¦é˜Ÿåˆ—ä¸­æŒ‰ç…§æŒ‡å®šçš„è°ƒåº¦ç­–ç•¥é€‰æ‹©TaskSetManagerå»è°ƒåº¦è¿è¡Œï¼Œå¤§è‡´æ–¹æ³•è°ƒç”¨æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830191635299.png" alt="image-20200830191635299"></p><p>SchedulerBackEndæ”¶åˆ°å¾…æ‰§è¡Œçš„ä»»åŠ¡åä»TaskSetPoolï¼Œå¼€å§‹è”ç³»Executorå¼€å§‹æ‰§è¡Œ</p><h3 id="è°ƒåº¦ç­–ç•¥"><a href="#è°ƒåº¦ç­–ç•¥" class="headerlink" title="è°ƒåº¦ç­–ç•¥"></a>è°ƒåº¦ç­–ç•¥</h3><p>å‰é¢è®²åˆ°ï¼ŒTaskSchedulerä¼šå…ˆæŠŠDAGSchedulerç»™è¿‡æ¥çš„TaskSetå°è£…æˆTaskSetManageræ‰”åˆ°ä»»åŠ¡é˜Ÿåˆ—é‡Œï¼Œç„¶åå†ä»ä»»åŠ¡é˜Ÿåˆ—é‡ŒæŒ‰ç…§ä¸€å®šçš„è§„åˆ™æŠŠå®ƒä»¬å–å‡ºæ¥åœ¨SchedulerBackendç»™è¿‡æ¥çš„Executorä¸Šè¿è¡Œã€‚<font color="red">è¿™ä¸ªè°ƒåº¦è¿‡ç¨‹å®é™…ä¸Šè¿˜æ˜¯æ¯”è¾ƒç²—ç²’åº¦çš„ï¼Œæ˜¯é¢å‘TaskSetManagerçš„</font></p><p>TaskScheduleræ˜¯ä»¥æ ‘çš„æ–¹å¼æ¥ç®¡ç†ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ ‘ä¸­çš„èŠ‚ç‚¹ç±»å‹ä¸ºSchdulableï¼Œå¶å­èŠ‚ç‚¹ä¸ºTaskSetManagerï¼Œéå¶å­èŠ‚ç‚¹ä¸ºPoolï¼Œä¸‹å›¾æ˜¯å®ƒä»¬ä¹‹é—´çš„ç»§æ‰¿å…³ç³»ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830192011398.png" alt="image-20200830192011398"></p><p>TaskScheduleræ”¯æŒä¸¤ç§è°ƒåº¦ç­–ç•¥ï¼Œ<strong>ä¸€ç§æ˜¯FIFOï¼Œä¹Ÿæ˜¯é»˜è®¤çš„è°ƒåº¦ç­–ç•¥ï¼Œå¦ä¸€ç§æ˜¯FAIR</strong>ã€‚åœ¨TaskScheduleråˆå§‹åŒ–è¿‡ç¨‹ä¸­ä¼šå®ä¾‹åŒ–rootPoolï¼Œè¡¨ç¤ºæ ‘çš„æ ¹èŠ‚ç‚¹ï¼Œæ˜¯Poolç±»å‹ã€‚</p><h3 id="å¤±è´¥é‡è¯•å’Œé»‘åå•"><a href="#å¤±è´¥é‡è¯•å’Œé»‘åå•" class="headerlink" title="å¤±è´¥é‡è¯•å’Œé»‘åå•"></a>å¤±è´¥é‡è¯•å’Œé»‘åå•</h3><p>é™¤äº†é€‰æ‹©åˆé€‚çš„Taskè°ƒåº¦è¿è¡Œå¤–ï¼Œè¿˜éœ€è¦ç›‘æ§Taskçš„æ‰§è¡ŒçŠ¶æ€ï¼Œå‰é¢ä¹Ÿæåˆ°ï¼Œä¸å¤–éƒ¨æ‰“äº¤é“çš„æ˜¯<code>SchedulerBackend</code>ï¼ŒTaskè¢«æäº¤åˆ°Executorå¯åŠ¨æ‰§è¡Œåï¼ŒExecutorä¼šå°†æ‰§è¡ŒçŠ¶æ€ä¸ŠæŠ¥ç»™SchedulerBackendï¼ŒSchedulerBackendåˆ™å‘Šè¯‰TaskSchedulerï¼ŒTaskScheduleræ‰¾åˆ°è¯¥Taskå¯¹åº”çš„TaskSetManagerï¼Œå¹¶é€šçŸ¥åˆ°è¯¥TaskSetManagerï¼Œè¿™æ ·TaskSetManagerå°±çŸ¥é“Taskçš„å¤±è´¥ä¸æˆåŠŸçŠ¶æ€ï¼Œ<font color="red">å¯¹äºå¤±è´¥çš„Taskï¼Œä¼šè®°å½•å®ƒå¤±è´¥çš„æ¬¡æ•°ï¼Œå¦‚æœå¤±è´¥æ¬¡æ•°è¿˜æ²¡æœ‰è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œé‚£ä¹ˆå°±æŠŠå®ƒæ”¾å›å¾…è°ƒåº¦çš„Taskæ± å­ä¸­ï¼Œå¦åˆ™æ•´ä¸ªApplicationå¤±è´¥ã€‚</font></p><p><font color="red">åœ¨è®°å½•Taskå¤±è´¥æ¬¡æ•°è¿‡ç¨‹ä¸­ï¼Œä¼šè®°å½•å®ƒä¸Šä¸€æ¬¡å¤±è´¥æ‰€åœ¨çš„Executor Idå’ŒHostï¼Œè¿™æ ·ä¸‹æ¬¡å†è°ƒåº¦è¿™ä¸ªTaskæ—¶ï¼Œä¼šä½¿ç”¨é»‘åå•æœºåˆ¶ï¼Œé¿å…å®ƒè¢«è°ƒåº¦åˆ°ä¸Šä¸€æ¬¡å¤±è´¥çš„èŠ‚ç‚¹ä¸Šï¼Œèµ·åˆ°ä¸€å®šçš„å®¹é”™ä½œç”¨ã€‚</font>é»‘åå•è®°å½•Taskä¸Šä¸€æ¬¡å¤±è´¥æ‰€åœ¨çš„Executor Idå’ŒHostï¼Œä»¥åŠå…¶å¯¹åº”çš„â€œæ‹‰é»‘â€æ—¶é—´ï¼Œâ€œæ‹‰é»‘â€æ—¶é—´æ˜¯æŒ‡è¿™æ®µæ—¶é—´å†…ä¸è¦å†å¾€è¿™ä¸ªèŠ‚ç‚¹ä¸Šè°ƒåº¦è¿™ä¸ªTaskäº†ã€‚</p><h1 id="Spark-Shuffleè§£æ"><a href="#Spark-Shuffleè§£æ" class="headerlink" title="Spark Shuffleè§£æ"></a>Spark Shuffleè§£æ</h1><h2 id="Shuffleè¦ç‚¹"><a href="#Shuffleè¦ç‚¹" class="headerlink" title="Shuffleè¦ç‚¹"></a>Shuffleè¦ç‚¹</h2><h3 id="ShuffleMapStageä¸ResultStage"><a href="#ShuffleMapStageä¸ResultStage" class="headerlink" title="ShuffleMapStageä¸ResultStage"></a>ShuffleMapStageä¸ResultStage</h3><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200831205831081.png" alt="image-20200831205831081"></p><p>åœ¨åˆ’åˆ†stageæ—¶ï¼Œæœ€åä¸€ä¸ªstageç§°ä¸ºfinalStageï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªResultStageå¯¹è±¡ï¼Œå‰é¢çš„æ‰€æœ‰stageè¢«ç§°ä¸ºShuffleMapStageã€‚</p><p>ShuffleMapStageçš„ç»“æŸä¼´éšç€shuffleæ–‡ä»¶çš„å†™ç£ç›˜ã€‚é™¤äº†ç¬¬ä¸€ä¸ªShuffleMapStageï¼Œå‰©ä½™çš„ä¹Ÿéƒ½ä¼šè¯»è¯»ç›˜ã€‚</p><p>ResultStageåŸºæœ¬ä¸Šå¯¹åº”ä»£ç ä¸­çš„actionç®—å­ï¼Œå³å°†ä¸€ä¸ªå‡½æ•°åº”ç”¨åœ¨RDDçš„å„ä¸ªpartitionçš„æ•°æ®é›†ä¸Šï¼Œæ„å‘³ç€ä¸€ä¸ªjobçš„è¿è¡Œç»“æŸã€‚</p><h3 id="Shuffleä¸­ä»»åŠ¡ä¸ªæ•°"><a href="#Shuffleä¸­ä»»åŠ¡ä¸ªæ•°" class="headerlink" title="Shuffleä¸­ä»»åŠ¡ä¸ªæ•°"></a>Shuffleä¸­ä»»åŠ¡ä¸ªæ•°</h3><p>æˆ‘ä»¬çŸ¥é“ï¼ŒSpark Shuffleåˆ†ä¸ºmapé˜¶æ®µå’Œreduceé˜¶æ®µï¼Œæˆ–è€…ç§°ä¹‹ä¸º<code>ShuffleRead</code>é˜¶æ®µå’Œ<code>ShuffleWrite</code>é˜¶æ®µï¼Œé‚£ä¹ˆå¯¹äºä¸€æ¬¡Shuffleï¼Œmapè¿‡ç¨‹å’Œreduceè¿‡ç¨‹éƒ½ä¼šç”±è‹¥å¹²ä¸ªtaskæ¥æ‰§è¡Œï¼Œé‚£ä¹ˆmap taskå’Œreduce taskçš„æ•°é‡æ˜¯å¦‚ä½•ç¡®å®šçš„å‘¢ï¼Ÿ</p><p>å‡è®¾Sparkä»»åŠ¡ä»HDFSä¸­è¯»å–æ•°æ®ï¼Œ<font color="red">é‚£ä¹ˆåˆå§‹RDDåˆ†åŒºä¸ªæ•°ç”±è¯¥æ–‡ä»¶çš„splitä¸ªæ•°å†³å®š</font>ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªsplitå¯¹åº”ç”Ÿæˆçš„RDDçš„ä¸€ä¸ªpartitionï¼Œæˆ‘ä»¬å‡è®¾åˆå§‹partitionä¸ªæ•°ä¸ºNã€‚</p><p>åˆå§‹RDDç»è¿‡ä¸€ç³»åˆ—ç®—å­è®¡ç®—åï¼ˆ<strong>å‡è®¾æ²¡æœ‰æ‰§è¡Œrepartitionå’Œcoalesceç®—å­è¿›è¡Œé‡åˆ†åŒº</strong>ï¼Œåˆ™åˆ†åŒºä¸ªæ•°ä¸å˜ï¼Œä»ä¸ºNï¼Œå¦‚æœç»è¿‡é‡åˆ†åŒºç®—å­ï¼Œé‚£ä¹ˆåˆ†åŒºä¸ªæ•°å˜ä¸ºMï¼‰ï¼Œæˆ‘ä»¬å‡è®¾åˆ†åŒºä¸ªæ•°ä¸å˜ï¼Œ<font color="red">å½“æ‰§è¡Œåˆ°Shuffleæ“ä½œæ—¶ï¼Œmapç«¯çš„taskä¸ªæ•°å’Œpartitionä¸ªæ•°ä¸€è‡´ï¼Œå³map taskä¸ºNä¸ªã€‚</font></p><p><font color="red"><strong>reduceç«¯çš„stageé»˜è®¤å–spark.default.parallelismè¿™ä¸ªé…ç½®é¡¹çš„å€¼ä½œä¸ºåˆ†åŒºæ•°ï¼Œå¦‚æœæ²¡æœ‰é…ç½®ï¼Œåˆ™ä»¥mapç«¯çš„æœ€åä¸€ä¸ªRDDçš„åˆ†åŒºæ•°ä½œä¸ºå…¶åˆ†åŒºæ•°ï¼ˆä¹Ÿå°±æ˜¯Nï¼‰ï¼Œé‚£ä¹ˆåˆ†åŒºæ•°å°±å†³å®šäº†reduceç«¯çš„taskçš„ä¸ªæ•°ã€‚</strong></font></p><h3 id="Reduceç«¯æ•°æ®çš„è¯»å–"><a href="#Reduceç«¯æ•°æ®çš„è¯»å–" class="headerlink" title="Reduceç«¯æ•°æ®çš„è¯»å–"></a>Reduceç«¯æ•°æ®çš„è¯»å–</h3><p>æ ¹æ®stageçš„åˆ’åˆ†æˆ‘ä»¬çŸ¥é“ï¼Œmapç«¯taskå’Œreduceç«¯taskä¸åœ¨ç›¸åŒçš„stageä¸­ï¼Œmap taskä½äºShuffleMapStageï¼Œreduce taskä½äºResultStageï¼Œmap taskä¼šå…ˆæ‰§è¡Œï¼Œé‚£ä¹ˆåæ‰§è¡Œçš„reduce taskå¦‚ä½•çŸ¥é“ä»å“ªé‡Œå»æ‹‰å–map taskè½ç›˜åçš„æ•°æ®å‘¢ï¼Ÿ</p><p>reduceç«¯çš„æ•°æ®æ‹‰å–è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li>map task æ‰§è¡Œå®Œæ¯•åä¼šå°†è®¡ç®—çŠ¶æ€ä»¥åŠç£ç›˜å°æ–‡ä»¶ä½ç½®ç­‰ä¿¡æ¯å°è£…åˆ°MapStatuså¯¹è±¡ä¸­ï¼Œç„¶åç”±æœ¬è¿›ç¨‹ä¸­çš„MapOutPutTrackerWorkerå¯¹è±¡å°†mapStatuså¯¹è±¡å‘é€ç»™Driverè¿›ç¨‹çš„MapOutPutTrackerMasterå¯¹è±¡ï¼›</li><li>åœ¨reduce taskå¼€å§‹æ‰§è¡Œä¹‹å‰ä¼šå…ˆè®©æœ¬è¿›ç¨‹ä¸­çš„MapOutputTrackerWorkerå‘Driverè¿›ç¨‹ä¸­çš„MapoutPutTrakcerMasterå‘åŠ¨è¯·æ±‚ï¼Œè¯·æ±‚ç£ç›˜å°æ–‡ä»¶ä½ç½®ä¿¡æ¯ï¼›</li><li> å½“æ‰€æœ‰çš„Map taskæ‰§è¡Œå®Œæ¯•åï¼ŒDriverè¿›ç¨‹ä¸­çš„MapOutPutTrackerMasterå°±æŒæ¡äº†æ‰€æœ‰çš„ç£ç›˜å°æ–‡ä»¶çš„ä½ç½®ä¿¡æ¯ã€‚æ­¤æ—¶MapOutPutTrackerMasterä¼šå‘Šè¯‰MapOutPutTrackerWorkerç£ç›˜å°æ–‡ä»¶çš„ä½ç½®ä¿¡æ¯ï¼›</li><li>å®Œæˆä¹‹å‰çš„æ“ä½œä¹‹åï¼Œç”±BlockTransforServiceå»Executor0æ‰€åœ¨çš„èŠ‚ç‚¹æ‹‰æ•°æ®ï¼Œé»˜è®¤ä¼šå¯åŠ¨äº”ä¸ªå­çº¿ç¨‹ã€‚æ¯æ¬¡æ‹‰å–çš„æ•°æ®é‡ä¸èƒ½è¶…è¿‡48Mï¼ˆreduce taskæ¯æ¬¡æœ€å¤šæ‹‰å–48Mæ•°æ®ï¼Œå°†æ‹‰æ¥çš„æ•°æ®å­˜å‚¨åˆ°Executorå†…å­˜çš„20%å†…å­˜ä¸­ï¼‰ã€‚</li></ol><h2 id="HashShuffle"><a href="#HashShuffle" class="headerlink" title="HashShuffle"></a>HashShuffle</h2><p>ä»¥ä¸‹çš„è®¨è®ºéƒ½å‡è®¾æ¯ä¸ªExecutoræœ‰1ä¸ªCPU coreã€‚</p><h3 id="æœªç»ä¼˜åŒ–çš„HashShuffleManager"><a href="#æœªç»ä¼˜åŒ–çš„HashShuffleManager" class="headerlink" title="æœªç»ä¼˜åŒ–çš„HashShuffleManager"></a>æœªç»ä¼˜åŒ–çš„HashShuffleManager</h3><p>é»˜è®¤shuffleå‰ååˆ†åŒºæ˜¯ä¸å˜çš„ï¼Œæ‰€ä»¥æ²¡æœ‰ä¼˜åŒ–åçš„HashShuffleManageræ¯ä¸ªTaskä»»åŠ¡éƒ½ä¼šç”Ÿæˆnä¸ªæ–‡ä»¶ï¼Œnæ˜¯åˆ†åŒºæ•°ï¼Œä½†æ˜¯è¿™æ ·ç”Ÿæˆçš„æ–‡ä»¶å¤ªå¤šï¼Œæ•ˆç‡å¤ªæ…¢</p><p>shuffle writeé˜¶æ®µï¼Œä¸»è¦å°±æ˜¯åœ¨ä¸€ä¸ªstageç»“æŸè®¡ç®—ä¹‹åï¼Œä¸ºäº†ä¸‹ä¸€ä¸ªstageå¯ä»¥æ‰§è¡Œshuffleç±»çš„ç®—å­ï¼ˆæ¯”å¦‚reduceByKeyï¼‰ï¼Œè€Œå°†æ¯ä¸ªtaskå¤„ç†çš„æ•°æ®æŒ‰keyè¿›è¡Œâ€œåˆ’åˆ†â€ã€‚<font color="red">æ‰€è°“â€œåˆ’åˆ†â€ï¼Œå°±æ˜¯å¯¹ç›¸åŒçš„keyæ‰§è¡Œhashç®—æ³•ï¼Œä»è€Œå°†ç›¸åŒkeyéƒ½å†™å…¥åŒä¸€ä¸ªç£ç›˜æ–‡ä»¶ä¸­ï¼Œè€Œæ¯ä¸€ä¸ªç£ç›˜æ–‡ä»¶éƒ½åªå±äºä¸‹æ¸¸stageçš„ä¸€ä¸ªtaskã€‚</font>åœ¨å°†æ•°æ®å†™å…¥ç£ç›˜ä¹‹å‰ï¼Œä¼šå…ˆå°†æ•°æ®å†™å…¥å†…å­˜ç¼“å†²ä¸­ï¼Œå½“å†…å­˜ç¼“å†²å¡«æ»¡ä¹‹åï¼Œæ‰ä¼šæº¢å†™åˆ°ç£ç›˜æ–‡ä»¶ä¸­å»ã€‚</p><p><font color="red"><strong>ä¸‹ä¸€ä¸ªstageçš„taskæœ‰å¤šå°‘ä¸ªï¼Œå½“å‰stageçš„æ¯ä¸ªtaskå°±è¦åˆ›å»ºå¤šå°‘ä»½ç£ç›˜æ–‡ä»¶ã€‚</strong></font>æ¯”å¦‚ä¸‹ä¸€ä¸ªstageæ€»å…±æœ‰100ä¸ªtaskï¼Œé‚£ä¹ˆå½“å‰stageçš„æ¯ä¸ªtaskéƒ½è¦åˆ›å»º100ä»½ç£ç›˜æ–‡ä»¶ã€‚å¦‚æœå½“å‰stageæœ‰50ä¸ªtaskï¼Œæ€»å…±æœ‰10ä¸ªExecutorï¼Œæ¯ä¸ªExecutoræ‰§è¡Œ5ä¸ªtaskï¼Œé‚£ä¹ˆæ¯ä¸ªExecutorä¸Šæ€»å…±å°±è¦åˆ›å»º500ä¸ªç£ç›˜æ–‡ä»¶ï¼Œæ‰€æœ‰Executorä¸Šä¼šåˆ›å»º5000ä¸ªç£ç›˜æ–‡ä»¶ã€‚ç”±æ­¤å¯è§ï¼Œæœªç»ä¼˜åŒ–çš„shuffle writeæ“ä½œæ‰€äº§ç”Ÿçš„ç£ç›˜æ–‡ä»¶çš„æ•°é‡æ˜¯æå…¶æƒŠäººçš„ã€‚</p><p>shuffle readé˜¶æ®µï¼Œé€šå¸¸å°±æ˜¯ä¸€ä¸ªstageåˆšå¼€å§‹æ—¶è¦åšçš„äº‹æƒ…ã€‚<font color="red">æ­¤æ—¶è¯¥stageçš„æ¯ä¸€ä¸ªtaskå°±éœ€è¦å°†ä¸Šä¸€ä¸ªstageçš„è®¡ç®—ç»“æœä¸­çš„æ‰€æœ‰ç›¸åŒkeyï¼Œä»å„ä¸ªèŠ‚ç‚¹ä¸Šé€šè¿‡ç½‘ç»œéƒ½æ‹‰å–åˆ°è‡ªå·±æ‰€åœ¨çš„èŠ‚ç‚¹ä¸Šï¼Œç„¶åè¿›è¡Œkeyçš„èšåˆæˆ–è¿æ¥ç­‰æ“ä½œã€‚</font>ç”±äºshuffle writeçš„è¿‡ç¨‹ä¸­ï¼Œmap taskç»™ä¸‹æ¸¸stageçš„æ¯ä¸ªreduce taskéƒ½åˆ›å»ºäº†ä¸€ä¸ªç£ç›˜æ–‡ä»¶ï¼Œå› æ­¤shuffle readçš„è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªreduce taskåªè¦ä»ä¸Šæ¸¸stageçš„æ‰€æœ‰map taskæ‰€åœ¨èŠ‚ç‚¹ä¸Šï¼Œæ‹‰å–å±äºè‡ªå·±çš„é‚£ä¸€ä¸ªç£ç›˜æ–‡ä»¶å³å¯ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200831213230836.png" alt="image-20200831213230836"></p><h3 id="ä¼˜åŒ–åçš„HashShuffleManager"><a href="#ä¼˜åŒ–åçš„HashShuffleManager" class="headerlink" title="ä¼˜åŒ–åçš„HashShuffleManager"></a>ä¼˜åŒ–åçš„HashShuffleManager</h3><p>ä¸ºäº†ä¼˜åŒ–HashShuffleManageræˆ‘ä»¬å¯ä»¥è®¾ç½®ä¸€ä¸ªå‚æ•°ï¼Œspark.shuffle. consolidateFilesï¼Œè¯¥å‚æ•°é»˜è®¤å€¼ä¸ºfalseï¼Œå°†å…¶è®¾ç½®ä¸ºtrueå³å¯å¼€å¯ä¼˜åŒ–æœºåˆ¶ï¼Œé€šå¸¸æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨HashShuffleManagerï¼Œé‚£ä¹ˆéƒ½å»ºè®®å¼€å¯è¿™ä¸ªé€‰é¡¹ã€‚</p><p>å¼€å¯consolidateæœºåˆ¶ä¹‹åï¼Œåœ¨shuffle writeè¿‡ç¨‹ä¸­ï¼Œtaskå°±ä¸æ˜¯ä¸ºä¸‹æ¸¸stageçš„æ¯ä¸ªtaskåˆ›å»ºä¸€ä¸ªç£ç›˜æ–‡ä»¶äº†ï¼Œæ­¤æ—¶ä¼šå‡ºç°<strong>shuffleFileGroup</strong>çš„æ¦‚å¿µï¼Œ<font color="red">æ¯ä¸ªshuffleFileGroupä¼šå¯¹åº”ä¸€æ‰¹ç£ç›˜æ–‡ä»¶ï¼Œç£ç›˜æ–‡ä»¶çš„æ•°é‡ä¸ä¸‹æ¸¸stageçš„taskæ•°é‡æ˜¯ç›¸åŒçš„ã€‚</font>ä¸€ä¸ªExecutorä¸Šæœ‰å¤šå°‘ä¸ªCPU coreï¼Œå°±å¯ä»¥å¹¶è¡Œæ‰§è¡Œå¤šå°‘ä¸ªtaskã€‚è€Œç¬¬ä¸€æ‰¹å¹¶è¡Œæ‰§è¡Œçš„æ¯ä¸ªtaskéƒ½ä¼šåˆ›å»ºä¸€ä¸ªshuffleFileGroupï¼Œå¹¶å°†æ•°æ®å†™å…¥å¯¹åº”çš„ç£ç›˜æ–‡ä»¶å†…ã€‚</p><p>å½“Executorçš„CPU coreæ‰§è¡Œå®Œä¸€æ‰¹taskï¼Œ<font color="red">æ¥ç€æ‰§è¡Œä¸‹ä¸€æ‰¹taskæ—¶ï¼Œä¸‹ä¸€æ‰¹taskå°±ä¼šå¤ç”¨ä¹‹å‰å·²æœ‰çš„shuffleFileGroupï¼ŒåŒ…æ‹¬å…¶ä¸­çš„ç£ç›˜æ–‡ä»¶ï¼Œ</font>ä¹Ÿå°±æ˜¯è¯´ï¼Œæ­¤æ—¶taskä¼šå°†æ•°æ®å†™å…¥å·²æœ‰çš„ç£ç›˜æ–‡ä»¶ä¸­ï¼Œè€Œä¸ä¼šå†™å…¥æ–°çš„ç£ç›˜æ–‡ä»¶ä¸­ã€‚å› æ­¤ï¼Œconsolidateæœºåˆ¶å…è®¸ä¸åŒçš„taskå¤ç”¨åŒä¸€æ‰¹ç£ç›˜æ–‡ä»¶ï¼Œè¿™æ ·å°±å¯ä»¥æœ‰æ•ˆå°†å¤šä¸ªtaskçš„ç£ç›˜æ–‡ä»¶è¿›è¡Œä¸€å®šç¨‹åº¦ä¸Šçš„åˆå¹¶ï¼Œä»è€Œå¤§å¹…åº¦å‡å°‘ç£ç›˜æ–‡ä»¶çš„æ•°é‡ï¼Œè¿›è€Œæå‡shuffle writeçš„æ€§èƒ½ã€‚</p><p>ä¹Ÿå°±æ˜¯Executorçš„æ¯ä¸ªæ ¸coreä¼šåˆ›å»ºnä¸ªæ–‡ä»¶ï¼Œnæ˜¯ä¸‹ä¸ªstageçš„å¹¶è¡Œåº¦ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200831213702651.png" alt="image-20200831213702651"></p><h2 id="SortShuffleè§£æğŸ”º"><a href="#SortShuffleè§£æğŸ”º" class="headerlink" title="SortShuffleè§£æğŸ”º"></a>SortShuffleè§£æğŸ”º</h2><p>SortShuffleManagerçš„è¿è¡Œæœºåˆ¶ä¸»è¦åˆ†æˆä¸¤ç§ï¼Œ<strong>ä¸€ç§æ˜¯æ™®é€šè¿è¡Œæœºåˆ¶ï¼Œå¦ä¸€ç§æ˜¯bypassè¿è¡Œæœºåˆ¶ã€‚</strong><font color="red">å½“shuffle read taskçš„æ•°é‡å°äºç­‰äºspark.shuffle.sort. bypassMergeThresholdå‚æ•°çš„å€¼æ—¶ï¼ˆé»˜è®¤ä¸º200ï¼‰ï¼Œå°±ä¼šå¯ç”¨bypassæœºåˆ¶ã€‚</font></p><h3 id="æ™®é€šè¿è¡Œæœºåˆ¶"><a href="#æ™®é€šè¿è¡Œæœºåˆ¶" class="headerlink" title="æ™®é€šè¿è¡Œæœºåˆ¶"></a>æ™®é€šè¿è¡Œæœºåˆ¶</h3><p>åœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œ<font color="red">æ•°æ®ä¼šå…ˆå†™å…¥ä¸€ä¸ªå†…å­˜æ•°æ®ç»“æ„ä¸­ï¼Œ</font>æ­¤æ—¶æ ¹æ®ä¸åŒçš„shuffleç®—å­ï¼Œå¯èƒ½é€‰ç”¨ä¸åŒçš„æ•°æ®ç»“æ„ã€‚<strong>å¦‚æœæ˜¯reduceByKeyè¿™ç§èšåˆç±»çš„shuffleç®—å­ï¼Œé‚£ä¹ˆä¼šé€‰ç”¨Mapæ•°æ®ç»“æ„</strong>ï¼Œä¸€è¾¹é€šè¿‡Mapè¿›è¡Œèšåˆï¼Œä¸€è¾¹å†™å…¥å†…å­˜ï¼›<strong>å¦‚æœæ˜¯joinè¿™ç§æ™®é€šçš„shuffleç®—å­ï¼Œé‚£ä¹ˆä¼šé€‰ç”¨Arrayæ•°æ®ç»“æ„</strong>ï¼Œç›´æ¥å†™å…¥å†…å­˜ã€‚æ¥ç€ï¼Œæ¯å†™ä¸€æ¡æ•°æ®è¿›å…¥å†…å­˜æ•°æ®ç»“æ„ä¹‹åï¼Œå°±ä¼šåˆ¤æ–­ä¸€ä¸‹ï¼Œæ˜¯å¦è¾¾åˆ°äº†æŸä¸ªä¸´ç•Œé˜ˆå€¼ã€‚<strong>å¦‚æœè¾¾åˆ°ä¸´ç•Œé˜ˆå€¼çš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šå°è¯•å°†å†…å­˜æ•°æ®ç»“æ„ä¸­çš„æ•°æ®æº¢å†™åˆ°ç£ç›˜ï¼Œç„¶åæ¸…ç©ºå†…å­˜æ•°æ®ç»“æ„ã€‚</strong></p><p><font color="red">åœ¨æº¢å†™åˆ°ç£ç›˜æ–‡ä»¶ä¹‹å‰ï¼Œä¼šå…ˆæ ¹æ®keyå¯¹å†…å­˜æ•°æ®ç»“æ„ä¸­å·²æœ‰çš„æ•°æ®è¿›è¡Œæ’åºã€‚æ’åºè¿‡åï¼Œä¼šåˆ†æ‰¹å°†æ•°æ®å†™å…¥ç£ç›˜æ–‡ä»¶ã€‚</font>é»˜è®¤çš„batchæ•°é‡æ˜¯10000æ¡ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ’åºå¥½çš„æ•°æ®ï¼Œä¼šä»¥æ¯æ‰¹1ä¸‡æ¡æ•°æ®çš„å½¢å¼åˆ†æ‰¹å†™å…¥ç£ç›˜æ–‡ä»¶ã€‚å†™å…¥ç£ç›˜æ–‡ä»¶æ˜¯é€šè¿‡Javaçš„BufferedOutputStreamå®ç°çš„ã€‚BufferedOutputStreamæ˜¯Javaçš„ç¼“å†²è¾“å‡ºæµï¼Œé¦–å…ˆä¼šå°†æ•°æ®ç¼“å†²åœ¨å†…å­˜ä¸­ï¼Œå½“å†…å­˜ç¼“å†²æ»¡æº¢ä¹‹åå†ä¸€æ¬¡å†™å…¥ç£ç›˜æ–‡ä»¶ä¸­ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ç£ç›˜IOæ¬¡æ•°ï¼Œæå‡æ€§èƒ½ã€‚</p><p><font color="red">ä¸€ä¸ªtaskå°†æ‰€æœ‰æ•°æ®å†™å…¥å†…å­˜æ•°æ®ç»“æ„çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå‘ç”Ÿå¤šæ¬¡ç£ç›˜æº¢å†™æ“ä½œï¼Œä¹Ÿå°±ä¼šäº§ç”Ÿå¤šä¸ªä¸´æ—¶æ–‡ä»¶ã€‚æœ€åä¼šå°†ä¹‹å‰æ‰€æœ‰çš„ä¸´æ—¶ç£ç›˜æ–‡ä»¶éƒ½è¿›è¡Œåˆå¹¶ï¼Œè¿™å°±æ˜¯mergeè¿‡ç¨‹ï¼Œæ­¤æ—¶ä¼šå°†ä¹‹å‰æ‰€æœ‰ä¸´æ—¶ç£ç›˜æ–‡ä»¶ä¸­çš„æ•°æ®è¯»å–å‡ºæ¥ï¼Œç„¶åä¾æ¬¡å†™å…¥æœ€ç»ˆçš„ç£ç›˜æ–‡ä»¶ä¹‹ä¸­ã€‚</font>æ­¤å¤–ï¼Œç”±äºä¸€ä¸ªtaskå°±åªå¯¹åº”ä¸€ä¸ªç£ç›˜æ–‡ä»¶ï¼Œ<strong>ä¹Ÿå°±æ„å‘³ç€è¯¥taskä¸ºä¸‹æ¸¸stageçš„taskå‡†å¤‡çš„æ•°æ®éƒ½åœ¨è¿™ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œå› æ­¤è¿˜ä¼šå•ç‹¬å†™ä¸€ä»½ç´¢å¼•æ–‡ä»¶</strong>ï¼Œå…¶ä¸­æ ‡è¯†äº†ä¸‹æ¸¸å„ä¸ªtaskçš„æ•°æ®åœ¨æ–‡ä»¶ä¸­çš„start offsetä¸end offsetã€‚</p><p>è¿™ä¸Kafkaä¸­çš„Partitionçš„ç´¢å¼•æ–‡ä»¶ã€æ—¥å¿—æ–‡ä»¶æ€æƒ³ç±»ä¼¼ï¼Œé€šè¿‡ç´¢å¼•æ¥ä½¿æ–‡ä»¶è¯»å–åŠ å¿«</p><p>æ™®é€šè¿è¡Œæœºåˆ¶çš„SortShuffleManagerå·¥ä½œåŸç†å¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200831214716757.png" alt="image-20200831214716757"></p><p><font color="red">*<em>æ€»ç»“æ¥è¯´ï¼Œæœ‰å‡ ä¸ªå¹¶è¡Œä»»åŠ¡å°±æœ‰å‡ ä¸ªæ–‡ä»¶ï¼Œç›¸å¯¹äºä¼˜åŒ–åçš„HashShuffleManagerï¼Œå®ƒæ˜¯æœ‰å‡ ä¸ªæ ¸å¿ƒï¼Œæ—¢æœ‰å‡ ä¸ªæ ¸å¿ƒ</em>å¹¶è¡Œåº¦ï¼ˆä¸»è¦å–å†³äºå¹¶è¡Œåº¦ï¼‰çš„æ–‡ä»¶ã€‚**</font></p><h3 id="ByPassæœºåˆ¶"><a href="#ByPassæœºåˆ¶" class="headerlink" title="ByPassæœºåˆ¶"></a>ByPassæœºåˆ¶</h3><p>bypassè¿è¡Œæœºåˆ¶çš„è§¦å‘æ¡ä»¶å¦‚ä¸‹ï¼š</p><ul><li>shuffle map taskæ•°é‡å°äºspark.shuffle.sort.bypassMergeThresholdå‚æ•°çš„å€¼ã€‚</li><li>ä¸æ˜¯èšåˆç±»çš„shuffleç®—å­ã€‚</li></ul><p>æ­¤æ—¶ï¼Œæ¯ä¸ªtaskä¼šä¸ºæ¯ä¸ªä¸‹æ¸¸taskéƒ½åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç£ç›˜æ–‡ä»¶ï¼Œå¹¶å°†æ•°æ®æŒ‰keyè¿›è¡Œhashç„¶åæ ¹æ®keyçš„hashå€¼ï¼Œå°†keyå†™å…¥å¯¹åº”çš„ç£ç›˜æ–‡ä»¶ä¹‹ä¸­ã€‚å½“ç„¶ï¼Œå†™å…¥ç£ç›˜æ–‡ä»¶æ—¶ä¹Ÿæ˜¯å…ˆå†™å…¥å†…å­˜ç¼“å†²ï¼Œç¼“å†²å†™æ»¡ä¹‹åå†æº¢å†™åˆ°ç£ç›˜æ–‡ä»¶çš„ã€‚æœ€åï¼ŒåŒæ ·ä¼šå°†æ‰€æœ‰ä¸´æ—¶ç£ç›˜æ–‡ä»¶éƒ½åˆå¹¶æˆä¸€ä¸ªç£ç›˜æ–‡ä»¶ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ç´¢å¼•æ–‡ä»¶ã€‚</p><p><font color="red">è¯¥è¿‡ç¨‹çš„ç£ç›˜å†™æœºåˆ¶å…¶å®è·Ÿæœªç»ä¼˜åŒ–çš„HashShuffleManageræ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œå› ä¸ºéƒ½è¦åˆ›å»ºæ•°é‡æƒŠäººçš„ç£ç›˜æ–‡ä»¶ï¼Œåªæ˜¯åœ¨æœ€åä¼šåšä¸€ä¸ªç£ç›˜æ–‡ä»¶çš„åˆå¹¶è€Œå·²ã€‚</font>å› æ­¤å°‘é‡çš„æœ€ç»ˆç£ç›˜æ–‡ä»¶ï¼Œä¹Ÿè®©è¯¥æœºåˆ¶ç›¸å¯¹æœªç»ä¼˜åŒ–çš„HashShuffleManageræ¥è¯´ï¼Œshuffle readçš„æ€§èƒ½ä¼šæ›´å¥½ã€‚</p><p>è€Œè¯¥æœºåˆ¶ä¸æ™®é€šSortShuffleManagerè¿è¡Œæœºåˆ¶çš„ä¸åŒåœ¨äºï¼š</p><ol><li>ç¬¬ä¸€ï¼Œ<strong>ç£ç›˜å†™æœºåˆ¶ä¸åŒï¼›</strong></li><li>ç¬¬äºŒï¼Œ<strong>ä¸ä¼šè¿›è¡Œæ’åºã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯ç”¨è¯¥æœºåˆ¶çš„æœ€å¤§å¥½å¤„åœ¨äºï¼Œshuffle writeè¿‡ç¨‹ä¸­ï¼Œä¸éœ€è¦è¿›è¡Œæ•°æ®çš„æ’åºæ“ä½œï¼Œä¹Ÿå°±èŠ‚çœæ‰äº†è¿™éƒ¨åˆ†çš„æ€§èƒ½å¼€é”€ã€‚</strong></li></ol><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200831214852355.png" alt="image-20200831214852355"></p><h1 id="Sparkå†…å­˜ç®¡ç†"><a href="#Sparkå†…å­˜ç®¡ç†" class="headerlink" title="Sparkå†…å­˜ç®¡ç†"></a>Sparkå†…å­˜ç®¡ç†</h1><p>åœ¨æ‰§è¡ŒSpark çš„åº”ç”¨ç¨‹åºæ—¶ï¼ŒSpark é›†ç¾¤ä¼šå¯åŠ¨ Driver å’Œ Executor ä¸¤ç§ JVM è¿›ç¨‹ï¼Œå‰è€…ä¸ºä¸»æ§è¿›ç¨‹ï¼Œè´Ÿè´£åˆ›å»º Spark ä¸Šä¸‹æ–‡ï¼Œæäº¤ Spark ä½œä¸šï¼ˆJobï¼‰ï¼Œå¹¶å°†ä½œä¸šè½¬åŒ–ä¸ºè®¡ç®—ä»»åŠ¡ï¼ˆTaskï¼‰ï¼Œåœ¨å„ä¸ª Executor è¿›ç¨‹é—´åè°ƒä»»åŠ¡çš„è°ƒåº¦ï¼Œåè€…è´Ÿè´£åœ¨å·¥ä½œèŠ‚ç‚¹ä¸Šæ‰§è¡Œå…·ä½“çš„è®¡ç®—ä»»åŠ¡ï¼Œå¹¶å°†ç»“æœè¿”å›ç»™ Driverï¼ŒåŒæ—¶ä¸ºéœ€è¦æŒä¹…åŒ–çš„ RDD æä¾›å­˜å‚¨åŠŸèƒ½ã€‚ç”±äº Driver çš„å†…å­˜ç®¡ç†ç›¸å¯¹æ¥è¯´è¾ƒä¸ºç®€å•ï¼Œæœ¬èŠ‚ä¸»è¦å¯¹ Executor çš„å†…å­˜ç®¡ç†è¿›è¡Œåˆ†æï¼Œä¸‹æ–‡ä¸­çš„ Spark å†…å­˜å‡ç‰¹æŒ‡ Executor çš„å†…å­˜ã€‚</p><h2 id="å†…å­˜ç©ºé—´åˆ†é…"><a href="#å†…å­˜ç©ºé—´åˆ†é…" class="headerlink" title="å†…å­˜ç©ºé—´åˆ†é…"></a>å†…å­˜ç©ºé—´åˆ†é…</h2><h3 id="ç»Ÿä¸€å†…å­˜ç®¡ç†"><a href="#ç»Ÿä¸€å†…å­˜ç®¡ç†" class="headerlink" title="ç»Ÿä¸€å†…å­˜ç®¡ç†"></a>ç»Ÿä¸€å†…å­˜ç®¡ç†</h3><p>Spark 1.6 ä¹‹åå¼•å…¥çš„ç»Ÿä¸€å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œå­˜å‚¨å†…å­˜å’Œæ‰§è¡Œå†…å­˜å…±äº«åŒä¸€å—ç©ºé—´ï¼Œå¯ä»¥åŠ¨æ€å ç”¨å¯¹æ–¹çš„ç©ºé—²åŒºåŸŸï¼Œç»Ÿä¸€å†…å­˜ç®¡ç†çš„å †å†…å†…å­˜ç»“æ„å¦‚å›¾æ‰€ç¤ºï¼š</p><p><strong>å †å¤–å†…å­˜</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200831215139324.png" alt="image-20200831215139324"></p><p><strong>å †å†…å†…å­˜</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200831215144277.png" alt="image-20200831215144277"></p><ul><li>storageï¼šå­˜å‚¨RDDç¼“å­˜</li><li>Executorï¼šè¿›è¡Œè®¡ç®—éœ€è¦çš„å†…å­˜</li><li>Otherï¼šç”¨æˆ·è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„å’Œæœªç¼“å­˜çš„RDD</li></ul><p><font color="red">å…¶ä¸­æœ€é‡è¦çš„ä¼˜åŒ–åœ¨äºåŠ¨æ€å ç”¨æœºåˆ¶ï¼Œå…¶è§„åˆ™å¦‚ä¸‹ï¼š</font></p><ol><li>   è®¾å®šåŸºæœ¬çš„å­˜å‚¨å†…å­˜å’Œæ‰§è¡Œå†…å­˜åŒºåŸŸï¼ˆspark.storage.storageFraction å‚æ•°ï¼‰ï¼Œè¯¥è®¾å®šç¡®å®šäº†åŒæ–¹å„è‡ªæ‹¥æœ‰çš„ç©ºé—´çš„èŒƒå›´ï¼›</li><li>   åŒæ–¹çš„ç©ºé—´éƒ½ä¸è¶³æ—¶ï¼Œåˆ™å­˜å‚¨åˆ°ç¡¬ç›˜ï¼›è‹¥å·±æ–¹ç©ºé—´ä¸è¶³è€Œå¯¹æ–¹ç©ºä½™æ—¶ï¼Œå¯å€Ÿç”¨å¯¹æ–¹çš„ç©ºé—´;ï¼ˆå­˜å‚¨ç©ºé—´ä¸è¶³æ˜¯æŒ‡ä¸è¶³ä»¥æ”¾ä¸‹ä¸€ä¸ªå®Œæ•´çš„ Blockï¼‰</li><li>   <strong>æ‰§è¡Œå†…å­˜çš„ç©ºé—´è¢«å¯¹æ–¹å ç”¨åï¼Œå¯è®©å¯¹æ–¹å°†å ç”¨çš„éƒ¨åˆ†è½¬å­˜åˆ°ç¡¬ç›˜ï¼Œç„¶åâ€å½’è¿˜â€å€Ÿç”¨çš„ç©ºé—´ï¼›</strong></li><li>   <strong>å­˜å‚¨å†…å­˜çš„ç©ºé—´è¢«å¯¹æ–¹å ç”¨åï¼Œæ— æ³•è®©å¯¹æ–¹â€å½’è¿˜â€ï¼Œå› ä¸ºéœ€è¦è€ƒè™‘ Shuffle è¿‡ç¨‹ä¸­çš„å¾ˆå¤šå› ç´ ï¼Œå®ç°èµ·æ¥è¾ƒä¸ºå¤æ‚ã€‚</strong></li></ol><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200831215719557.png" alt="image-20200831215719557"></p><p><font color="red"></font></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Spark-å†…æ ¸æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#Spark-å†…æ ¸æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;Spark å†…æ ¸æ¦‚è¿°&quot;&gt;&lt;/a&gt;Spark å†…æ ¸æ¦‚è¿°&lt;/h1&gt;&lt;p&gt;Sparkå†…æ ¸æ³›æŒ‡Sparkçš„æ ¸å¿ƒè¿è¡Œæœºåˆ¶ï¼ŒåŒ…æ‹¬&lt;strong&gt;Sparkæ ¸</summary>
      
    
    
    
    <category term="Spark" scheme="https://awslzhang.top/categories/Spark/"/>
    
    
    <category term="Spark" scheme="https://awslzhang.top/tags/Spark/"/>
    
  </entry>
  
  <entry>
    <title>sparkå­¦ä¹ ç¬”è®°-SparkStreaming</title>
    <link href="https://awslzhang.top/2020/08/26/spark%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-SparkStreaming/"/>
    <id>https://awslzhang.top/2020/08/26/spark%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-SparkStreaming/</id>
    <published>2020-08-26T14:09:19.000Z</published>
    <updated>2021-01-01T05:50:00.043Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Spark-Streamingæ¦‚è¿°"><a href="#Spark-Streamingæ¦‚è¿°" class="headerlink" title="Spark Streamingæ¦‚è¿°"></a>Spark Streamingæ¦‚è¿°</h1><h2 id="Spark-Streamingæ˜¯ä»€ä¹ˆ"><a href="#Spark-Streamingæ˜¯ä»€ä¹ˆ" class="headerlink" title="Spark Streamingæ˜¯ä»€ä¹ˆ"></a>Spark Streamingæ˜¯ä»€ä¹ˆ</h2><p>Spark Streamingç”¨äºæµå¼æ•°æ®çš„å¤„ç†ã€‚Spark Streamingæ”¯æŒçš„æ•°æ®è¾“å…¥æºå¾ˆå¤šï¼Œ<font color="red">ä¾‹å¦‚ï¼šKafkaã€Flumeã€Twitterã€ZeroMQå’Œç®€å•çš„TCPå¥—æ¥å­—ç­‰ç­‰</font>ã€‚æ•°æ®è¾“å…¥åå¯ä»¥ç”¨Sparkçš„é«˜åº¦æŠ½è±¡åŸè¯­å¦‚ï¼š<strong>mapã€reduceã€joinã€windowç­‰è¿›è¡Œè¿ç®—</strong>ã€‚è€Œç»“æœä¹Ÿèƒ½ä¿å­˜åœ¨å¾ˆå¤šåœ°æ–¹ï¼Œ<strong>å¦‚HDFSï¼Œæ•°æ®åº“</strong>ç­‰ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200828193447365.png" alt="image-20200828193447365"></p><p>å’ŒSparkåŸºäºRDDçš„æ¦‚å¿µå¾ˆç›¸ä¼¼ï¼ŒSpark Streamingä½¿ç”¨<font color="red">ç¦»æ•£åŒ–æµ(discretized stream)</font>ä½œä¸ºæŠ½è±¡è¡¨ç¤ºï¼Œå«ä½œDStreamã€‚DStream æ˜¯éšæ—¶é—´æ¨ç§»è€Œæ”¶åˆ°çš„æ•°æ®çš„åºåˆ—ã€‚åœ¨å†…éƒ¨ï¼Œ<strong>æ¯ä¸ªæ—¶é—´åŒºé—´æ”¶åˆ°çš„æ•°æ®éƒ½ä½œä¸º RDD å­˜åœ¨</strong>ï¼Œè€ŒDStreamæ˜¯ç”±è¿™äº›RDDæ‰€ç»„æˆçš„åºåˆ—(å› æ­¤å¾—åâ€œ<strong>ç¦»æ•£åŒ–</strong>â€)ã€‚</p><p><font color="red"><strong>æ³¨æ„</strong>ï¼šç¦»æ•£åŒ–çš„åä¹‰è¯å°±æ˜¯è¿ç»­ï¼Œè¿™è¯æ˜SparkStreamingå¹¶ä¸æ˜¯çœŸæ­£çš„å®æ—¶å¤„ç†(æ¥ä¸€æ¡è®¡ç®—ä¸€æ¡)ï¼Œè€Œæ˜¯æ¯æ¬¡è®¡ç®—å°æ‰¹é‡çš„æ•°æ®ï¼Œå°æ‰¹é‡çš„æ•°æ®å€¼å¾—å°±æ˜¯ä¸€å®šé‡‡é›†å‘¨æœŸä¹‹å†…çš„æ•°æ®ã€‚</font></p><h1 id="DStreamå…¥é—¨"><a href="#DStreamå…¥é—¨" class="headerlink" title="DStreamå…¥é—¨"></a>DStreamå…¥é—¨</h1><p><code>DStream</code>æ˜¯SparkStreamingè®¡ç®—çš„æŠ½è±¡ã€‚ä¾‹å¦‚ï¼šSpark Coreè®¡ç®—ä¸­çš„RDDï¼ŒSparkSQLä¸­çš„DSã€DFã€‚</p><h2 id="æ— çŠ¶æ€çš„WordCountæ¡ˆä¾‹å®æ“"><a href="#æ— çŠ¶æ€çš„WordCountæ¡ˆä¾‹å®æ“" class="headerlink" title="æ— çŠ¶æ€çš„WordCountæ¡ˆä¾‹å®æ“"></a>æ— çŠ¶æ€çš„WordCountæ¡ˆä¾‹å®æ“</h2><p>éœ€æ±‚ï¼šä½¿ç”¨netcatå·¥å…·å‘9999ç«¯å£ä¸æ–­çš„å‘é€æ•°æ®ï¼Œé€šè¿‡SparkStreamingè¯»å–ç«¯å£æ•°æ®å¹¶ç»Ÿè®¡ä¸åŒå•è¯å‡ºç°çš„æ¬¡æ•°</p><p><strong>pom</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-streaming_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>scala</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">WordCount</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.åˆ›å»ºSparkConfå¹¶è®¾ç½®Appåç§°</span></span><br><span class="line">    <span class="keyword">val</span> conf: <span class="type">SparkConf</span> = <span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">&quot;WC&quot;</span>).setMaster(<span class="string">&quot;local[*]&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.åˆå§‹åŒ–SparkStreamingContext</span></span><br><span class="line">    <span class="keyword">val</span> ssc = <span class="keyword">new</span> <span class="type">StreamingContext</span>(conf, <span class="type">Seconds</span>(<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.é€šè¿‡ç›‘æ§ç«¯å£åˆ›å»ºDStreamï¼Œè¯»è¿›æ¥çš„æ•°æ®ä¸ºä¸€è¡Œè¡Œ</span></span><br><span class="line">    <span class="keyword">val</span> lineStreams: <span class="type">ReceiverInputDStream</span>[<span class="type">String</span>] = ssc.socketTextStream(<span class="string">&quot;192.168.0.201&quot;</span>, <span class="number">9999</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†æ¯ä¸€è¡Œæ•°æ®åšåˆ‡åˆ†ï¼Œå½¢æˆä¸€ä¸ªä¸ªå•è¯</span></span><br><span class="line">    <span class="keyword">val</span> wordStreams: <span class="type">DStream</span>[<span class="type">String</span>] = lineStreams.flatMap(_.split(<span class="string">&quot; &quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†å•è¯æ˜ å°„æˆå…ƒç»„ï¼ˆword,1ï¼‰</span></span><br><span class="line">    <span class="keyword">val</span> wordAndOneStreams: <span class="type">DStream</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = wordStreams.map((_, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†ç›¸åŒçš„å•è¯æ¬¡æ•°åšç»Ÿè®¡</span></span><br><span class="line">    <span class="keyword">val</span> wordAndCountStreams: <span class="type">DStream</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = wordAndOneStreams.reduceByKey(_+_)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ‰“å°</span></span><br><span class="line">    wordAndCountStreams.print()</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯åŠ¨SparkStreamingContextçš„æ”¶é›†å™¨ï¼Œæ”¶é›†å™¨å¿…é¡»ä¸€ç›´å¼€å¯ï¼Œæ‰èƒ½æ”¶é›†åˆ°æ•°æ®</span></span><br><span class="line">    ssc.start()</span><br><span class="line">    <span class="comment">// ä¸»ç¨‹åºç­‰å¾…æ”¶é›†å™¨å…³é—­ï¼Œç„¶åä¸»ç¨‹åºå…³é—­</span></span><br><span class="line">    ssc.awaitTermination()</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200828195052616.png" alt="image-20200828195052616"></p><p><font color="red">æ³¨æ„ï¼šå¦‚æœç¨‹åºè¿è¡Œæ—¶ï¼Œlogæ—¥å¿—å¤ªå¤šï¼Œå¯ä»¥å°†spark confç›®å½•ä¸‹çš„log4jæ–‡ä»¶é‡Œé¢çš„æ—¥å¿—çº§åˆ«æ”¹æˆWARNã€‚å¹¶åŠ å…¥åˆ°é¡¹ç›®ä¸­</font></p><hr><p><strong>ç¨‹åºè§£æ</strong></p><p><code>Discretized Stream</code>æ˜¯Spark Streamingçš„åŸºç¡€æŠ½è±¡ï¼Œä»£è¡¨æŒç»­æ€§çš„æ•°æ®æµå’Œç»è¿‡å„ç§SparkåŸè¯­æ“ä½œåçš„ç»“æœæ•°æ®æµã€‚åœ¨å†…éƒ¨å®ç°ä¸Šï¼Œ<strong>DStreamæ˜¯ä¸€ç³»åˆ—è¿ç»­çš„RDDæ¥è¡¨ç¤º</strong>ã€‚æ¯ä¸ªRDDå«æœ‰ä¸€æ®µæ—¶é—´é—´éš”å†…çš„æ•°æ®ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200828195323123.png" alt="image-20200828195323123"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200828195402058.png" alt="image-20200828195402058"></p><h1 id="DStreamåˆ›å»º"><a href="#DStreamåˆ›å»º" class="headerlink" title="DStreamåˆ›å»º"></a>DStreamåˆ›å»º</h1><p>Spark StreamingåŸç”Ÿæ”¯æŒä¸€äº›ä¸åŒçš„æ•°æ®æºã€‚ä¸€äº›â€œæ ¸å¿ƒâ€æ•°æ®æºå·²ç»è¢«æ‰“åŒ…åˆ°<code>Spark Streaming </code>çš„ Maven å·¥ä»¶ä¸­ï¼Œè€Œå…¶ä»–çš„ä¸€äº›åˆ™å¯ä»¥é€šè¿‡<code>spark-streaming-kafka</code>ç­‰é™„åŠ å·¥ä»¶è·å–ã€‚æ¯ä¸ªæ¥æ”¶å™¨éƒ½ä»¥ Spark æ‰§è¡Œå™¨ç¨‹åºä¸­<font color="red"><strong>ä¸€ä¸ªé•¿æœŸè¿è¡Œçš„ä»»åŠ¡çš„å½¢å¼è¿è¡Œï¼Œå› æ­¤ä¼šå æ®åˆ†é…ç»™åº”ç”¨çš„ CPU æ ¸å¿ƒã€‚</strong>æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æœ‰å¯ç”¨çš„ CPU æ ¸å¿ƒæ¥å¤„ç†æ•°æ®ã€‚</font>è¿™æ„å‘³ç€å¦‚æœè¦è¿è¡Œå¤šä¸ªæ¥æ”¶å™¨ï¼Œ<strong>å°±å¿…é¡»è‡³å°‘æœ‰å’Œæ¥æ”¶å™¨æ•°ç›®ç›¸åŒçš„æ ¸å¿ƒæ•°</strong>ï¼Œè¿˜è¦åŠ ä¸Šç”¨æ¥å®Œæˆè®¡ç®—æ‰€éœ€è¦çš„æ ¸å¿ƒæ•°ã€‚</p><p><font color="bule">ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨æµè®¡ç®—åº”ç”¨ä¸­è¿è¡Œ 10 ä¸ªæ¥æ”¶å™¨ï¼Œé‚£ä¹ˆè‡³å°‘éœ€è¦ä¸ºåº”ç”¨åˆ†é… 11 ä¸ª CPU æ ¸å¿ƒã€‚æ‰€ä»¥å¦‚æœåœ¨æœ¬åœ°æ¨¡å¼è¿è¡Œï¼Œ**ä¸è¦ä½¿ç”¨local[1]**ã€‚</font>å› ä¸º1ä¸ªæ ¸å¿ƒæ— æ³•åŒæ—¶æ»¡è¶³æ¥æ”¶å™¨å’Œè®¡ç®—çš„ä»»åŠ¡ã€‚</p><h2 id="æ–‡ä»¶æ•°æ®æº"><a href="#æ–‡ä»¶æ•°æ®æº" class="headerlink" title="æ–‡ä»¶æ•°æ®æº"></a>æ–‡ä»¶æ•°æ®æº</h2><h3 id="ç”¨æ³•åŠè¯´æ˜"><a href="#ç”¨æ³•åŠè¯´æ˜" class="headerlink" title="ç”¨æ³•åŠè¯´æ˜"></a>ç”¨æ³•åŠè¯´æ˜</h3><p>æ–‡ä»¶æ•°æ®æµï¼šèƒ½å¤Ÿè¯»å–æ‰€æœ‰HDFS APIå…¼å®¹çš„æ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶ï¼Œé€šè¿‡fileStreamæ–¹æ³•è¿›è¡Œè¯»å–ï¼ŒSpark Streaming å°†ä¼šç›‘æ§ dataDirectory ç›®å½•å¹¶ä¸æ–­å¤„ç†ç§»åŠ¨è¿›æ¥çš„æ–‡ä»¶ï¼Œã€‚<font color="red"><strong>è®°ä½ç›®å‰ä¸æ”¯æŒåµŒå¥—ç›®å½•</strong></font></p><p>ä¸€èˆ¬ä¸ä¼šä½¿ç”¨ï¼Œå› ä¸ºFLumeæ˜¯ä¸€å¥—å¤„ç†æ–‡ä»¶æ—¥å¿—çš„æ”¶é›†ç³»ç»Ÿï¼Œç”¨å®ƒä¼šå¥½ï¼Œä½†æ˜¯å®ƒåˆæ²¡æœ‰Kafkaå¥½ï¼Œå› ä¸ºFlumeæ˜¯æ¨æ•°æ®ï¼Œä¸è€ƒè™‘è®¡ç®—èŠ‚ç‚¹çš„å¤„ç†èƒ½åŠ›ï¼Œæœ‰å¯èƒ½é€ æˆè®¡ç®—èŠ‚ç‚¹ä¸­æ•°æ®çš„å †ç§¯ï¼Œè€ŒKafkaä¸ä¼šï¼Œæ˜¯è®¡ç®—èŠ‚ç‚¹ä¸»åŠ¨è¯»å–Kafkaæ•°æ®ï¼Œè®¡ç®—èƒ½åŠ›å¤šå¤§ï¼Œè¯»å–å¤šå°‘æ•°æ®ã€‚</p><p><code>streamingContext.textFileStream(dataDirectory)</code></p><p><font color="red"><strong>æ³¨æ„äº‹é¡¹</strong></font></p><ol><li>æ–‡ä»¶éœ€è¦æœ‰ç›¸åŒçš„æ•°æ®æ ¼å¼ï¼›</li><li>æ–‡ä»¶è¿›å…¥ <code>dataDirectory</code>çš„æ–¹å¼éœ€è¦é€šè¿‡ç§»åŠ¨æˆ–è€…é‡å‘½åæ¥å®ç°ï¼›</li><li>ä¸€æ—¦æ–‡ä»¶ç§»åŠ¨è¿›ç›®å½•ï¼Œåˆ™ä¸èƒ½å†ä¿®æ”¹ï¼Œå³ä¾¿ä¿®æ”¹äº†ä¹Ÿä¸ä¼šè¯»å–æ–°æ•°æ®ï¼›</li></ol><h2 id="è‡ªå®šä¹‰æ•°æ®æº"><a href="#è‡ªå®šä¹‰æ•°æ®æº" class="headerlink" title="è‡ªå®šä¹‰æ•°æ®æº"></a>è‡ªå®šä¹‰æ•°æ®æº</h2><h3 id="ç”¨æ³•åŠè¯´æ˜-1"><a href="#ç”¨æ³•åŠè¯´æ˜-1" class="headerlink" title="ç”¨æ³•åŠè¯´æ˜"></a>ç”¨æ³•åŠè¯´æ˜</h3><p>éœ€è¦ç»§æ‰¿<code>Receiver</code>ï¼Œå¹¶å®ç°<code>onStart</code>ã€<code>onStop</code>æ–¹æ³•æ¥è‡ªå®šä¹‰æ•°æ®æºé‡‡é›†ã€‚</p><h3 id="æ¡ˆä¾‹å®æ“"><a href="#æ¡ˆä¾‹å®æ“" class="headerlink" title="æ¡ˆä¾‹å®æ“"></a>æ¡ˆä¾‹å®æ“</h3><p>æˆ‘ä»¬å·²ä¸Šé¢çš„è¯»å–æŸä¸ªå¥—æ¥å­—çš„æ•°æ®çš„æ•°æ®æºä¸ºä¾‹ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.&#123;<span class="type">BufferedReader</span>, <span class="type">InputStreamReader</span>&#125;</span><br><span class="line"><span class="keyword">import</span> java.net.<span class="type">Socket</span></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.<span class="type">StandardCharsets</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.storage.<span class="type">StorageLevel</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.receiver.<span class="type">Receiver</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomerReceiver</span>(<span class="params">host: <span class="type">String</span>, port: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">Receiver</span>[<span class="type">String</span>](<span class="params"><span class="type">StorageLevel</span>.<span class="type">MEMORY_ONLY</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//æœ€åˆå¯åŠ¨çš„æ—¶å€™ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ï¼Œä½œç”¨ä¸ºï¼šè¯»æ•°æ®å¹¶å°†æ•°æ®å‘é€ç»™Spark</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">onStart</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="type">Thread</span>(<span class="string">&quot;Socket Receiver&quot;</span>) &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>() &#123;</span><br><span class="line">        receive()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;.start()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//è¯»æ•°æ®å¹¶å°†æ•°æ®å‘é€ç»™Spark</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">receive</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªSocket</span></span><br><span class="line">    <span class="keyword">var</span> socket: <span class="type">Socket</span> = <span class="keyword">new</span> <span class="type">Socket</span>(host, port)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®šä¹‰ä¸€ä¸ªå˜é‡ï¼Œç”¨æ¥æ¥æ”¶ç«¯å£ä¼ è¿‡æ¥çš„æ•°æ®</span></span><br><span class="line">    <span class="keyword">var</span> input: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªBufferedReaderç”¨äºè¯»å–ç«¯å£ä¼ æ¥çš„æ•°æ®</span></span><br><span class="line">    <span class="keyword">val</span> reader = <span class="keyword">new</span> <span class="type">BufferedReader</span>(<span class="keyword">new</span> <span class="type">InputStreamReader</span>(socket.getInputStream, <span class="type">StandardCharsets</span>.<span class="type">UTF_8</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¯»å–æ•°æ®</span></span><br><span class="line">    input = reader.readLine()</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å½“receiveræ²¡æœ‰å…³é—­å¹¶ä¸”è¾“å…¥æ•°æ®ä¸ä¸ºç©ºï¼Œåˆ™å¾ªç¯å‘é€æ•°æ®ç»™Spark</span></span><br><span class="line">    <span class="keyword">while</span> (!isStopped() &amp;&amp; input != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å°†è¯»åˆ°çš„æ•°æ®åŠ å…¥æ•°æ®æºä¸­å­˜å‚¨</span></span><br><span class="line">      store(input)</span><br><span class="line">      input = reader.readLine()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·³å‡ºå¾ªç¯åˆ™å…³é—­èµ„æº</span></span><br><span class="line">    reader.close()</span><br><span class="line">    socket.close()</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é‡å¯ä»»åŠ¡</span></span><br><span class="line">    restart(<span class="string">&quot;restart&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">onStop</span></span>(): <span class="type">Unit</span> = &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨è‡ªå®šä¹‰çš„æ•°æ®æºé‡‡é›†æ•°æ®</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">SparkConf</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.&#123;<span class="type">Seconds</span>, <span class="type">StreamingContext</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.dstream.<span class="type">DStream</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">FileStream</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.åˆå§‹åŒ–Sparké…ç½®ä¿¡æ¯</span></span><br><span class="line"><span class="type">Val</span> sparkConf = <span class="keyword">new</span> <span class="type">SparkConf</span>().setMaster(<span class="string">&quot;local[*]&quot;</span>)</span><br><span class="line">.setAppName(<span class="string">&quot;StreamWordCount&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.åˆå§‹åŒ–SparkStreamingContext</span></span><br><span class="line">    <span class="keyword">val</span> ssc = <span class="keyword">new</span> <span class="type">StreamingContext</span>(sparkConf, <span class="type">Seconds</span>(<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">//3.åˆ›å»ºè‡ªå®šä¹‰receiverçš„Streaming</span></span><br><span class="line"><span class="keyword">val</span> lineStream = ssc.receiverStream(<span class="keyword">new</span> <span class="type">CustomerReceiver</span>(<span class="string">&quot;hadoop102&quot;</span>, <span class="number">9999</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4.å°†æ¯ä¸€è¡Œæ•°æ®åšåˆ‡åˆ†ï¼Œå½¢æˆä¸€ä¸ªä¸ªå•è¯</span></span><br><span class="line">    <span class="keyword">val</span> wordStreams = lineStream.flatMap(_.split(<span class="string">&quot;\t&quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.å°†å•è¯æ˜ å°„æˆå…ƒç»„ï¼ˆword,1ï¼‰</span></span><br><span class="line">    <span class="keyword">val</span> wordAndOneStreams = wordStreams.map((_, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6.å°†ç›¸åŒçš„å•è¯æ¬¡æ•°åšç»Ÿè®¡</span></span><br><span class="line">    <span class="keyword">val</span> wordAndCountStreams] = wordAndOneStreams.reduceByKey(_ + _)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//7.æ‰“å°</span></span><br><span class="line">    wordAndCountStreams.print()</span><br><span class="line"></span><br><span class="line">    <span class="comment">//8.å¯åŠ¨SparkStreamingContext</span></span><br><span class="line">    ssc.start()</span><br><span class="line">    ssc.awaitTermination()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Kafkaæ•°æ®æºğŸ”º"><a href="#Kafkaæ•°æ®æºğŸ”º" class="headerlink" title="Kafkaæ•°æ®æºğŸ”º"></a>Kafkaæ•°æ®æºğŸ”º</h2><h3 id="ç”¨æ³•åŠè¯´æ˜-2"><a href="#ç”¨æ³•åŠè¯´æ˜-2" class="headerlink" title="ç”¨æ³•åŠè¯´æ˜"></a>ç”¨æ³•åŠè¯´æ˜</h3><p><font color="red">åœ¨å·¥ç¨‹ä¸­éœ€è¦å¼•å…¥ Maven å·¥ä»¶Â· spark- streaming-kafka_2.10 Â·æ¥ä½¿ç”¨å®ƒ</font>ã€‚åŒ…å†…æä¾›çš„ <code>KafkaUtils </code>å¯¹è±¡å¯ä»¥åœ¨ <code>StreamingContext</code> å’Œ<code>JavaStreamingContext</code>ä¸­ä»¥ä½ çš„ Kafka æ¶ˆæ¯åˆ›å»ºå‡º DStreamã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-streaming-kafka-0-8_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç”±äº <code>KafkaUtils</code> å¯ä»¥è®¢é˜…å¤šä¸ªä¸»é¢˜ï¼Œå› æ­¤å®ƒåˆ›å»ºå‡ºçš„ DStream ç”±æˆå¯¹çš„ä¸»é¢˜å’Œæ¶ˆæ¯ç»„æˆã€‚è¦åˆ›å»ºå‡ºä¸€ä¸ªæµæ•°æ®ï¼Œéœ€è¦ä½¿ç”¨ ï¼š</p><ol><li><code>StreamingContext </code>å®ä¾‹</li><li>ä¸€ä¸ªç”±é€—å·éš”å¼€çš„<code>ZooKeeper</code>ä¸»æœºåˆ—è¡¨å­—ç¬¦ä¸²</li><li>æ¶ˆè´¹è€…ç»„çš„åå­—(å”¯ä¸€åå­—)</li><li>ä»¥åŠä¸€ä¸ªä»ä¸»é¢˜åˆ°é’ˆå¯¹è¿™ä¸ªä¸»é¢˜çš„æ¥æ”¶å™¨çº¿ç¨‹æ•°çš„æ˜ å°„è¡¨æ¥è°ƒç”¨<code>createStream()</code>æ–¹æ³•ã€‚</li></ol><p>å› ä¸ºKafkaçš„topicæœ‰åˆ†åŒºæ•°çš„æ¦‚å¿µï¼Œæ‰€æœ‰åˆ†åŒºçš„æ•°æ®åˆèµ·æ¥ä¾¿æ˜¯æ•´ä¸ªtopicçš„æ•°æ®ï¼Œè€Œtopicçš„åˆ†åŒºè‡³å¤šè¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹<font color="red">ï¼Œæ‰€ä»¥å¯åŠ¨çš„æ¶ˆè´¹è€…çš„çº¿ç¨‹åº”è¯¥&lt;=topicçš„åˆ†åŒºæ•°ã€‚</font></p><p><code>// Map of (topic_name to numPartitions) to consume. Each partition is consumed in its own thread   </code></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">//3.é€šè¿‡ç›‘æ§ç«¯å£åˆ›å»ºDStreamï¼Œè¯»è¿›æ¥çš„æ•°æ®ä¸ºä¸€è¡Œè¡Œ</span></span><br><span class="line"><span class="comment">//    lineStreams = k-v  valueæ‰æ˜¯kafkaè¾“å…¥çš„æ•°æ®</span></span><br><span class="line">    <span class="keyword">val</span> lineStreams: <span class="type">ReceiverInputDStream</span>[(<span class="type">String</span>, <span class="type">String</span>)] = <span class="type">KafkaUtils</span>.createStream(</span><br><span class="line">      ssc,</span><br><span class="line">      <span class="string">&quot;192.168.0.201:2181&quot;</span>,</span><br><span class="line">      <span class="string">&quot;group1&quot;</span>,</span><br><span class="line">      <span class="type">Map</span>((<span class="string">&quot;myTopic&quot;</span>, <span class="number">3</span>))</span><br><span class="line">    )</span><br><span class="line"><span class="comment">// Map of (topic_name to numPartitions) to consume. Each partition is consumed in its own thread              </span></span><br></pre></td></tr></table></figure><h3 id="WCæ— çŠ¶æ€çš„æ¡ˆä¾‹å®æ“"><a href="#WCæ— çŠ¶æ€çš„æ¡ˆä¾‹å®æ“" class="headerlink" title="WCæ— çŠ¶æ€çš„æ¡ˆä¾‹å®æ“"></a>WCæ— çŠ¶æ€çš„æ¡ˆä¾‹å®æ“</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Kafka</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="comment">//1.åˆ›å»ºSparkConfå¹¶è®¾ç½®Appåç§°</span></span><br><span class="line">    <span class="keyword">val</span> conf: <span class="type">SparkConf</span> = <span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">&quot;WC&quot;</span>).setMaster(<span class="string">&quot;local[*]&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.åˆå§‹åŒ–SparkStreamingContext</span></span><br><span class="line">    <span class="keyword">val</span> ssc = <span class="keyword">new</span> <span class="type">StreamingContext</span>(conf, <span class="type">Seconds</span>(<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.é€šè¿‡ç›‘æ§ç«¯å£åˆ›å»ºDStreamï¼Œè¯»è¿›æ¥çš„æ•°æ®ä¸ºä¸€è¡Œè¡Œ</span></span><br><span class="line"><span class="comment">//    lineStreams = k-v  valueæ‰æ˜¯kafkaè¾“å…¥çš„æ•°æ®</span></span><br><span class="line">    <span class="keyword">val</span> lineStreams: <span class="type">ReceiverInputDStream</span>[(<span class="type">String</span>, <span class="type">String</span>)] = <span class="type">KafkaUtils</span>.createStream(</span><br><span class="line">      ssc,</span><br><span class="line">      <span class="string">&quot;192.168.0.201:2181&quot;</span>,</span><br><span class="line">      <span class="string">&quot;group1&quot;</span>,</span><br><span class="line">      <span class="type">Map</span>((<span class="string">&quot;myTopic&quot;</span>, <span class="number">3</span>))</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†æ¯ä¸€è¡Œæ•°æ®åšåˆ‡åˆ†ï¼Œå½¢æˆä¸€ä¸ªä¸ªå•è¯</span></span><br><span class="line">    <span class="keyword">val</span> wordStreams: <span class="type">DStream</span>[<span class="type">String</span>] = lineStreams.flatMap(_._2.split(<span class="string">&quot; &quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†å•è¯æ˜ å°„æˆå…ƒç»„ï¼ˆword,1ï¼‰</span></span><br><span class="line">    <span class="keyword">val</span> wordAndOneStreams: <span class="type">DStream</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = wordStreams.map((_, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†ç›¸åŒçš„å•è¯æ¬¡æ•°åšç»Ÿè®¡</span></span><br><span class="line">    <span class="keyword">val</span> wordAndCountStreams: <span class="type">DStream</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = wordAndOneStreams.reduceByKey(_+_)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ‰“å°</span></span><br><span class="line">    wordAndCountStreams.print()</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯åŠ¨SparkStreamingContextçš„æ”¶é›†å™¨ï¼Œæ”¶é›†å™¨å¿…é¡»ä¸€ç›´å¼€å¯ï¼Œæ‰èƒ½æ”¶é›†åˆ°æ•°æ®</span></span><br><span class="line">    ssc.start()</span><br><span class="line">    <span class="comment">// ä¸»ç¨‹åºç­‰å¾…æ”¶é›†å™¨å…³é—­ï¼Œç„¶åä¸»ç¨‹åºå…³é—­</span></span><br><span class="line">    ssc.awaitTermination()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>Kafka</code>çš„æ“ä½œ</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop201 kafka]$ bin/kafka-topics.sh --zookeeper hadoop201:2181 --create --replication-factor 3 --partitions 3 --topic myTopic</span><br><span class="line"></span><br><span class="line">[hadoop@hadoop201 kafka]$ bin/kafka-console-producer.sh --broker-list hadoop202:9092 --topic myTopic</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>ideaç¨‹åºæ‰§è¡Œ</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200828203819133.png" alt="image-20200828203819133"></p><p><font color="red"><strong>æ³¨æ„</strong>ï¼šä¸Šé¢æ‰€æœ‰çš„ç¨‹åºéƒ½æ˜¯æ— çŠ¶æ€çš„è®¡ç®—ï¼Œå³æ¯ä¸ªé‡‡é›†å‘¨æœŸä¹‹é—´çš„æ•°æ®äº’ä¸å½±å“ï¼Œä½†è¿™æ˜¯ä¸åˆç†çš„ï¼Œæµå¼å¤„ç†åº”è¯¥æ±‡æ€»æ‰€æœ‰çš„æ•°æ®è¿›è¡Œç»Ÿè®¡è®¡ç®—ã€‚è¿™ç§°ä¸º<strong>æœ‰çŠ¶æ€çš„è®¡ç®—</strong>ï¼Œä¸‹é¢å¼€å§‹æœ‰çŠ¶æ€çš„è®¡ç®—</font></p><h1 id="DStreamçš„è½¬æ¢"><a href="#DStreamçš„è½¬æ¢" class="headerlink" title="DStreamçš„è½¬æ¢"></a>DStreamçš„è½¬æ¢</h1><h2 id="æ— çŠ¶æ€çš„è½¬æ¢"><a href="#æ— çŠ¶æ€çš„è½¬æ¢" class="headerlink" title="æ— çŠ¶æ€çš„è½¬æ¢"></a>æ— çŠ¶æ€çš„è½¬æ¢</h2><p>æ— çŠ¶æ€è½¬åŒ–æ“ä½œå°±æ˜¯æŠŠç®€å•çš„RDDè½¬åŒ–æ“ä½œåº”ç”¨åˆ°æ¯ä¸ªæ‰¹æ¬¡ä¸Šï¼Œä¹Ÿå°±æ˜¯è½¬åŒ–DStreamä¸­çš„æ¯ä¸€ä¸ªRDDã€‚éƒ¨åˆ†æ— çŠ¶æ€è½¬åŒ–æ“ä½œåˆ—åœ¨äº†ä¸‹è¡¨ä¸­ã€‚</p><p><font color="red"><strong>æ³¨æ„</strong>ï¼Œé’ˆå¯¹é”®å€¼å¯¹çš„DStreamè½¬åŒ–æ“ä½œ(æ¯”å¦‚ reduceByKey())è¦æ·»åŠ import StreamingContext._æ‰èƒ½åœ¨Scalaä¸­ä½¿ç”¨ã€‚</font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200829144132973.png" alt="image-20200829144132973"></p><p>éœ€è¦è®°ä½çš„æ˜¯ï¼Œå°½ç®¡è¿™äº›å‡½æ•°çœ‹èµ·æ¥åƒä½œç”¨åœ¨æ•´ä¸ªæµä¸Šä¸€æ ·ï¼Œä½†äº‹å®ä¸Šæ¯ä¸ªDStreamåœ¨å†…éƒ¨æ˜¯ç”±è®¸å¤šRDD(æ‰¹æ¬¡)ç»„æˆï¼Œä¸”æ— çŠ¶æ€è½¬åŒ–æ“ä½œæ˜¯åˆ†åˆ«<strong>åº”ç”¨åˆ°æ¯ä¸ªRDDä¸Šçš„</strong>ã€‚<strong>ä¾‹å¦‚ï¼ŒreduceByKey()ä¼šå½’çº¦æ¯ä¸ªæ—¶é—´åŒºé—´ä¸­çš„æ•°æ®ï¼Œ<font color="red">ä½†ä¸ä¼šå½’çº¦ä¸åŒåŒºé—´ä¹‹é—´çš„æ•°æ®</font>ã€‚</strong> </p><p>ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ä¹‹å‰çš„wordcountç¨‹åºä¸­ï¼Œæˆ‘ä»¬åªä¼šç»Ÿè®¡5ç§’å†…æ¥æ”¶åˆ°çš„æ•°æ®çš„å•è¯ä¸ªæ•°ï¼Œè€Œä¸ä¼šç´¯åŠ ã€‚ </p><h2 id="æœ‰çŠ¶æ€çš„è½¬æ¢ğŸ”º"><a href="#æœ‰çŠ¶æ€çš„è½¬æ¢ğŸ”º" class="headerlink" title="æœ‰çŠ¶æ€çš„è½¬æ¢ğŸ”º"></a>æœ‰çŠ¶æ€çš„è½¬æ¢ğŸ”º</h2><h3 id="UpdateStateByKey"><a href="#UpdateStateByKey" class="headerlink" title="UpdateStateByKey"></a>UpdateStateByKey</h3><p>UpdateStateByKeyåŸè¯­ç”¨äºè®°å½•å†å²è®°å½•ï¼Œ<font color="red">æœ‰æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ DStream ä¸­è·¨æ‰¹æ¬¡ç»´æŠ¤çŠ¶æ€(ä¾‹å¦‚æµè®¡ç®—ä¸­ç´¯åŠ wordcount)ã€‚</font>é’ˆå¯¹è¿™ç§æƒ…å†µï¼ŒupdateStateByKey() ä¸ºæˆ‘ä»¬æä¾›äº†å¯¹ä¸€ä¸ªçŠ¶æ€å˜é‡çš„è®¿é—®ï¼Œ<font color="red"><strong>ç”¨äºé”®å€¼å¯¹å½¢å¼çš„ DStreamã€‚</strong></font></p><p>updateStateByKey() çš„ç»“æœä¼šæ˜¯ä¸€ä¸ªæ–°çš„ DStreamï¼Œå…¶å†…éƒ¨çš„ RDD åºåˆ—æ˜¯ç”±æ¯ä¸ªæ—¶é—´åŒºé—´å¯¹åº”çš„(é”®ï¼ŒçŠ¶æ€)å¯¹ç»„æˆçš„ã€‚</p><p>updateStateByKeyæ“ä½œä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨ç”¨æ–°ä¿¡æ¯è¿›è¡Œæ›´æ–°æ—¶ä¿æŒä»»æ„çš„çŠ¶æ€ã€‚ä¸ºä½¿ç”¨è¿™ä¸ªåŠŸèƒ½ï¼Œä½ éœ€è¦ï¼š </p><ol><li>æŒ‡å®šæ£€æŸ¥ç‚¹ç›®å½•ï¼Œå› ä¸ºæ¯æ¬¡è®¡ç®—æ—¶ä¼šç”¨åˆ°ä¹‹å‰çš„æ•°æ®ï¼Œè€Œä¸æ–­ç´¯åŠ çš„ä¹‹å‰çš„æ•°æ®æ˜¯ä¸èƒ½æ”¾å…¥å†…å­˜çš„ï¼Œæ‰€ä»¥è¦è®¾ç½®ç›®å½•å­˜æ”¾è¿™äº›æ•°æ®ã€‚</li></ol><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">updateStateByKey</span></span>[<span class="type">S</span>: <span class="type">ClassTag</span>](updateFunc: (<span class="type">Seq</span>[<span class="type">V</span>], <span class="type">Option</span>[<span class="type">S</span>]) =&gt; <span class="type">Option</span>[<span class="type">S</span>])</span><br></pre></td></tr></table></figure><ol><li>å¯ä»¥çœ‹åˆ°æ³›å‹å’Œå‚æ•°ï¼Œå…¶ä¸­æ³›å‹æ˜¯ä¹‹å‰çš„æ•°æ®çš„æ­¤KEYçš„Valueçš„ç±»å‹</li><li>å‚æ•°ä¸­ï¼šSeqåºåˆ—æ˜¯æœ€æ–°çš„é‡‡é›†å‘¨æœŸçš„æ•°æ®ç›¸åŒkeyçš„é›†åˆ</li><li>Option{S}æ˜¯ä¹‹å‰è®¡ç®—å¥½çš„æ­¤KEYå¯¹åº”çš„æœ€åValueï¼Œä¸ºä»€ä¹ˆæ˜¯Optionï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è®¡ç®—ï¼Œåˆ™ä»–æ˜¯ç©º</li></ol><p><strong>æ”¹è‰¯çš„WC</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Kafka</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="comment">//1.åˆ›å»ºSparkConfå¹¶è®¾ç½®Appåç§°</span></span><br><span class="line">    <span class="keyword">val</span> conf: <span class="type">SparkConf</span> = <span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">&quot;WC&quot;</span>).setMaster(<span class="string">&quot;local[*]&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.åˆå§‹åŒ–SparkStreamingContext  Seconds(5)é‡‡é›†å‘¨æœŸï¼Œ5Sç”Ÿæˆä¸€ä¸ªDStreamå³RDD</span></span><br><span class="line">    <span class="keyword">val</span> ssc = <span class="keyword">new</span> <span class="type">StreamingContext</span>(conf, <span class="type">Seconds</span>(<span class="number">5</span>))</span><br><span class="line">    ssc.sparkContext.setCheckpointDir(<span class="string">&quot;test&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.é€šè¿‡ç›‘æ§ç«¯å£åˆ›å»ºDStreamï¼Œè¯»è¿›æ¥çš„æ•°æ®ä¸ºä¸€è¡Œè¡Œ</span></span><br><span class="line">    <span class="comment">//    lineStreams = k-v  valueæ‰æ˜¯kafkaè¾“å…¥çš„æ•°æ®</span></span><br><span class="line">    <span class="keyword">val</span> lineStreams: <span class="type">ReceiverInputDStream</span>[(<span class="type">String</span>, <span class="type">String</span>)] = <span class="type">KafkaUtils</span>.createStream(</span><br><span class="line">      ssc,</span><br><span class="line">      <span class="string">&quot;192.168.0.201:2181&quot;</span>,</span><br><span class="line">      <span class="string">&quot;group1&quot;</span>,</span><br><span class="line">      <span class="type">Map</span>((<span class="string">&quot;myTopic&quot;</span>, <span class="number">3</span>))</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†æ¯ä¸€è¡Œæ•°æ®åšåˆ‡åˆ†ï¼Œå½¢æˆä¸€ä¸ªä¸ªå•è¯</span></span><br><span class="line">    <span class="keyword">val</span> wordStreams: <span class="type">DStream</span>[<span class="type">String</span>] = lineStreams.flatMap(_._2.split(<span class="string">&quot; &quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†å•è¯æ˜ å°„æˆå…ƒç»„ï¼ˆword,1ï¼‰</span></span><br><span class="line">    <span class="keyword">val</span> wordAndOneStreams: <span class="type">DStream</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = wordStreams.map((_, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    def updateStateByKey[S: ClassTag](updateFunc: (Seq[V], Option[S]) =&gt; Option[S])</span></span><br><span class="line">    <span class="comment">//  å¯ä»¥çœ‹åˆ°æ³›å‹å’Œå‚æ•°ï¼Œå…¶ä¸­æ³›å‹æ˜¯ä¹‹å‰çš„æ•°æ®çš„æ­¤KEYçš„Valueçš„ç±»å‹ï¼Œå…¶ä¸­</span></span><br><span class="line">    <span class="comment">// å‚æ•°ä¸­ï¼šSeqåºåˆ—æ˜¯æœ€æ–°çš„é‡‡é›†å‘¨æœŸçš„æ•°æ®ç›¸åŒkeyçš„é›†åˆï¼ŒOption&#123;S&#125;æ˜¯ä¹‹å‰è®¡ç®—å¥½çš„æ­¤KEYå¯¹åº”çš„æœ€åValueï¼Œä¸ºä»€ä¹ˆæ˜¯Optionï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è®¡ç®—ï¼Œåˆ™ä»–æ˜¯ç©º</span></span><br><span class="line">    <span class="comment">// å®šä¹‰æ›´æ–°çŠ¶æ€æ–¹æ³•ï¼Œå‚æ•°valuesä¸ºå½“å‰æ‰¹æ¬¡å•è¯é¢‘åº¦ï¼Œstateä¸ºä»¥å¾€æ‰¹æ¬¡å•è¯é¢‘åº¦</span></span><br><span class="line">    <span class="keyword">val</span> value: <span class="type">DStream</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = wordAndOneStreams.updateStateByKey &#123;</span><br><span class="line">      <span class="keyword">case</span> (seq, buffer) =&gt;</span><br><span class="line">        <span class="type">Some</span>(seq.sum + buffer.getOrElse(<span class="number">0</span>))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    value.print()</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯åŠ¨SparkStreamingContextçš„æ”¶é›†å™¨ï¼Œæ”¶é›†å™¨å¿…é¡»ä¸€ç›´å¼€å¯ï¼Œæ‰èƒ½æ”¶é›†åˆ°æ•°æ®</span></span><br><span class="line">    ssc.start()</span><br><span class="line">    <span class="comment">// ä¸»ç¨‹åºç­‰å¾…æ”¶é›†å™¨å…³é—­ï¼Œç„¶åä¸»ç¨‹åºå…³é—­</span></span><br><span class="line">    ssc.awaitTermination()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200829152850299.png" alt="image-20200829152850299"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200829153242722.png" alt="image-20200829153242722"></p><p>å¯ä»¥å‘ç°æ•°å€¼ä¸€ç›´åœ¨å˜å¤§</p><h3 id="Window-Operations"><a href="#Window-Operations" class="headerlink" title="Window Operations"></a>Window Operations</h3><p><code>Window Operations</code>å¯ä»¥è®¾<strong>ç½®çª—å£çš„å¤§å°</strong>å’Œ<strong>æ»‘åŠ¨çª—å£çš„é—´éš”</strong>æ¥åŠ¨æ€çš„è·å–å½“å‰Steamingçš„å…è®¸çŠ¶æ€ã€‚åŸºäºçª—å£çš„æ“ä½œä¼šåœ¨ä¸€ä¸ªæ¯” StreamingContext çš„æ‰¹æ¬¡é—´éš”æ›´é•¿çš„æ—¶é—´èŒƒå›´å†…ï¼Œé€šè¿‡æ•´åˆå¤šä¸ªæ‰¹æ¬¡çš„ç»“æœï¼Œè®¡ç®—å‡ºæ•´ä¸ªçª—å£çš„ç»“æœã€‚</p><p><strong>å…¶ä¸­ï¼š</strong></p><ol><li>çª—å£çš„å¤§å°å¿…é¡»æ˜¯é‡‡é›†å‘¨æœŸçš„æ•´æ•°å€</li><li>æ»‘åŠ¨çª—å£çš„é—´éš”å¿…é¡»æ˜¯é‡‡é›†å‘¨æœŸçš„æ•´æ•°å€</li></ol><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200829153601198.png" alt="image-20200829153601198"></p><p>ä¾‹å¦‚ï¼šä¸Šå›¾çª—å£å¤§å°å°±æ˜¯é‡‡é›†å‘¨æœŸçš„ä¸‰å€ï¼›æ»‘åŠ¨çª—å£çš„é—´éš”åˆ™æ˜¯é‡‡é›†å‘¨æœŸçš„ä¸¤å€</p><p><font color="red"><strong>æ³¨æ„ï¼šæ‰€æœ‰åŸºäºçª—å£çš„æ“ä½œéƒ½éœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«ä¸ºçª—å£æ—¶é•¿ä»¥åŠæ»‘åŠ¨æ­¥é•¿ï¼Œä¸¤è€…éƒ½å¿…é¡»æ˜¯ StreamContext çš„æ‰¹æ¬¡é—´éš”çš„æ•´æ•°å€</strong></font></p><p><code>window(windowLength, slideInterval)</code>: åŸºäºå¯¹æºDStreamçª—åŒ–çš„æ‰¹æ¬¡è¿›è¡Œè®¡ç®—è¿”å›ä¸€ä¸ªæ–°çš„Dstream</p><h2 id="å…¶ä»–é‡è¦æ“ä½œğŸ”º"><a href="#å…¶ä»–é‡è¦æ“ä½œğŸ”º" class="headerlink" title="å…¶ä»–é‡è¦æ“ä½œğŸ”º"></a>å…¶ä»–é‡è¦æ“ä½œğŸ”º</h2><h3 id="TransformğŸ”º"><a href="#TransformğŸ”º" class="headerlink" title="TransformğŸ”º"></a>TransformğŸ”º</h3><p>TransformåŸè¯­å…è®¸DStreamä¸Šæ‰§è¡Œä»»æ„çš„RDD-to-RDDå‡½æ•°ã€‚å³ä½¿è¿™äº›å‡½æ•°å¹¶æ²¡æœ‰åœ¨DStreamçš„APIä¸­æš´éœ²å‡ºæ¥ï¼Œé€šè¿‡è¯¥å‡½æ•°å¯ä»¥æ–¹ä¾¿çš„æ‰©å±•Spark APIã€‚<strong>è¯¥å‡½æ•°æ¯ä¸€æ‰¹æ¬¡è°ƒåº¦ä¸€æ¬¡</strong>ã€‚å…¶å®ä¹Ÿå°±æ˜¯å¯¹DStreamä¸­çš„RDDåº”ç”¨è½¬æ¢ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200829154426732.png" alt="image-20200829154426732"></p><h1 id="DStreamè¾“å‡º"><a href="#DStreamè¾“å‡º" class="headerlink" title="DStreamè¾“å‡º"></a>DStreamè¾“å‡º</h1><p>è¾“å‡ºæ“ä½œæŒ‡å®šäº†å¯¹æµæ•°æ®ç»è½¬åŒ–æ“ä½œå¾—åˆ°çš„æ•°æ®æ‰€è¦æ‰§è¡Œçš„æ“ä½œ(ä¾‹å¦‚æŠŠç»“æœæ¨å…¥å¤–éƒ¨æ•°æ®åº“æˆ–è¾“å‡ºåˆ°å±å¹•ä¸Š)ã€‚ä¸RDDä¸­çš„æƒ°æ€§æ±‚å€¼ç±»ä¼¼ï¼Œå¦‚æœä¸€ä¸ªDStreamåŠå…¶æ´¾ç”Ÿå‡ºçš„DStreaméƒ½æ²¡æœ‰è¢«æ‰§è¡Œè¾“å‡ºæ“ä½œï¼Œé‚£ä¹ˆè¿™äº›DStreamå°±éƒ½ä¸ä¼šè¢«æ±‚å€¼ã€‚ <font color="red">å¦‚æœStreamingContextä¸­æ²¡æœ‰è®¾å®šè¾“å‡ºæ“ä½œï¼Œæ•´ä¸ªcontextå°±éƒ½ä¸ä¼šå¯åŠ¨ã€‚</font></p><p>è¾“å‡ºæ“ä½œå¦‚ä¸‹ï¼š</p><ol><li>print()ï¼šåœ¨è¿è¡Œæµç¨‹åºçš„é©±åŠ¨ç»“ç‚¹ä¸Šæ‰“å°DStreamä¸­æ¯ä¸€æ‰¹æ¬¡æ•°æ®çš„æœ€å¼€å§‹10ä¸ªå…ƒç´ ã€‚è¿™ç”¨äºå¼€å‘å’Œè°ƒè¯•ã€‚åœ¨Python APIä¸­ï¼ŒåŒæ ·çš„æ“ä½œå«print()ã€‚</li><li>saveAsTextFiles(prefix, [suffix])ï¼šä»¥textæ–‡ä»¶å½¢å¼å­˜å‚¨è¿™ä¸ªDStreamçš„å†…å®¹ã€‚æ¯ä¸€æ‰¹æ¬¡çš„å­˜å‚¨æ–‡ä»¶ååŸºäºå‚æ•°ä¸­çš„prefixå’Œsuffixã€‚â€prefix-Time_IN_MS[.suffix]â€. </li><li>saveAsObjectFiles(prefix, [suffix])ï¼šä»¥Javaå¯¹è±¡åºåˆ—åŒ–çš„æ–¹å¼å°†Streamä¸­çš„æ•°æ®ä¿å­˜ä¸º SequenceFiles . æ¯ä¸€æ‰¹æ¬¡çš„å­˜å‚¨æ–‡ä»¶ååŸºäºå‚æ•°ä¸­çš„ä¸ºâ€prefix-TIME_IN_MS[.suffix]â€. Pythonä¸­ç›®å‰ä¸å¯ç”¨ã€‚</li><li>saveAsHadoopFiles(prefix, [suffix])ï¼šå°†Streamä¸­çš„æ•°æ®ä¿å­˜ä¸º Hadoop files. æ¯ä¸€æ‰¹æ¬¡çš„å­˜å‚¨æ–‡ä»¶ååŸºäºå‚æ•°ä¸­çš„ä¸ºâ€prefix-TIME_IN_MS[.suffix]â€ã€‚<br>Python API Pythonä¸­ç›®å‰ä¸å¯ç”¨ã€‚</li><li>foreachRDD(func)ï¼š<strong>è¿™æ˜¯æœ€é€šç”¨çš„è¾“å‡ºæ“ä½œ</strong>ï¼Œå³å°†å‡½æ•° func ç”¨äºäº§ç”Ÿäº streamçš„æ¯ä¸€ä¸ªRDDã€‚å…¶ä¸­å‚æ•°ä¼ å…¥çš„å‡½æ•°funcåº”è¯¥å®ç°å°†æ¯ä¸€ä¸ªRDDä¸­æ•°æ®æ¨é€åˆ°å¤–éƒ¨ç³»ç»Ÿï¼Œå¦‚å°†RDDå­˜å…¥æ–‡ä»¶æˆ–è€…é€šè¿‡ç½‘ç»œå°†å…¶å†™å…¥æ•°æ®åº“ã€‚æ³¨æ„ï¼šå‡½æ•°funcåœ¨è¿è¡Œæµåº”ç”¨çš„é©±åŠ¨ä¸­è¢«æ‰§è¡Œï¼ŒåŒæ—¶å…¶ä¸­ä¸€èˆ¬å‡½æ•°RDDæ“ä½œä»è€Œå¼ºåˆ¶å…¶å¯¹äºæµRDDçš„è¿ç®—ã€‚</li></ol><p><font color="red"></font></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Spark-Streamingæ¦‚è¿°&quot;&gt;&lt;a href=&quot;#Spark-Streamingæ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;Spark Streamingæ¦‚è¿°&quot;&gt;&lt;/a&gt;Spark Streamingæ¦‚è¿°&lt;/h1&gt;&lt;h2 id=&quot;Spark</summary>
      
    
    
    
    <category term="Spark" scheme="https://awslzhang.top/categories/Spark/"/>
    
    
    <category term="Spark" scheme="https://awslzhang.top/tags/Spark/"/>
    
  </entry>
  
  <entry>
    <title>sparkå­¦ä¹ ç¬”è®°-SparkSQL</title>
    <link href="https://awslzhang.top/2020/08/24/spark%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-SparkSQL/"/>
    <id>https://awslzhang.top/2020/08/24/spark%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-SparkSQL/</id>
    <published>2020-08-24T13:10:34.000Z</published>
    <updated>2021-01-01T05:50:00.043Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Spark-SQLæ¦‚è¿°"><a href="#Spark-SQLæ¦‚è¿°" class="headerlink" title="Spark SQLæ¦‚è¿°"></a>Spark SQLæ¦‚è¿°</h1><h2 id="ä»€ä¹ˆæ˜¯Spark-SQL"><a href="#ä»€ä¹ˆæ˜¯Spark-SQL" class="headerlink" title="ä»€ä¹ˆæ˜¯Spark SQL"></a>ä»€ä¹ˆæ˜¯Spark SQL</h2><p>park SQLæ˜¯Sparkç”¨æ¥å¤„ç†ç»“æ„åŒ–æ•°æ®çš„ä¸€ä¸ªæ¨¡å—ï¼Œå®ƒæä¾›äº†2ä¸ªç¼–ç¨‹æŠ½è±¡ï¼š<font color="red">DataFrameå’ŒDataSet</font>ï¼Œå¹¶ä¸”ä½œä¸ºåˆ†å¸ƒå¼SQLæŸ¥è¯¢å¼•æ“çš„ä½œç”¨ã€‚</p><p>å°†Spark SQLè½¬æ¢æˆRDDï¼Œç„¶åæäº¤åˆ°é›†ç¾¤æ‰§è¡Œï¼Œæ‰§è¡Œæ•ˆç‡éå¸¸å¿«ï¼</p><h2 id="Spark-SQLçš„ç‰¹ç‚¹"><a href="#Spark-SQLçš„ç‰¹ç‚¹" class="headerlink" title="Spark SQLçš„ç‰¹ç‚¹"></a>Spark SQLçš„ç‰¹ç‚¹</h2><ul><li>æ˜“æ•´åˆ</li><li>ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ–¹å¼</li><li>å…¼å®¹Hive</li><li>æ ‡å‡†çš„æ•°æ®è¿æ¥</li></ul><h2 id="ä»€ä¹ˆæ˜¯DataFrame"><a href="#ä»€ä¹ˆæ˜¯DataFrame" class="headerlink" title="ä»€ä¹ˆæ˜¯DataFrame"></a>ä»€ä¹ˆæ˜¯DataFrame</h2><p>ä¸RDDç±»ä¼¼ï¼ŒDataFrameä¹Ÿæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ•°æ®å®¹å™¨ã€‚ç„¶è€ŒDataFrameæ›´åƒä¼ ç»Ÿæ•°æ®åº“çš„äºŒç»´è¡¨æ ¼ï¼Œé™¤äº†æ•°æ®ä»¥å¤–ï¼Œ<strong>è¿˜è®°å½•æ•°æ®çš„ç»“æ„ä¿¡æ¯ï¼Œå³schema</strong>ã€‚åŒæ—¶ï¼Œä¸Hiveç±»ä¼¼ï¼ŒDataFrameä¹Ÿæ”¯æŒåµŒå¥—æ•°æ®ç±»å‹ï¼ˆstructã€arrayå’Œmapï¼‰ã€‚ä»APIæ˜“ç”¨æ€§çš„è§’åº¦ä¸Šçœ‹ï¼ŒDataFrame APIæä¾›çš„æ˜¯ä¸€å¥—é«˜å±‚çš„å…³ç³»æ“ä½œï¼Œæ¯”å‡½æ•°å¼çš„RDD APIè¦æ›´åŠ å‹å¥½ï¼Œé—¨æ§›æ›´ä½ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200824211402757.png" alt="image-20200824211402757"></p><p>ä¸Šå›¾ç›´è§‚åœ°ä½“ç°äº†DataFrameå’ŒRDDçš„åŒºåˆ«ã€‚å·¦ä¾§çš„RDD[Person]è™½ç„¶ä»¥Personä¸ºç±»å‹å‚æ•°ï¼Œä½†Sparkæ¡†æ¶æœ¬èº«ä¸äº†è§£Personç±»çš„å†…éƒ¨ç»“æ„ã€‚è€Œå³ä¾§çš„DataFrameå´æä¾›äº†è¯¦ç»†çš„ç»“æ„ä¿¡æ¯ï¼Œä½¿å¾—Spark SQLå¯ä»¥æ¸…æ¥šåœ°çŸ¥é“è¯¥æ•°æ®é›†ä¸­åŒ…å«å“ªäº›åˆ—ï¼Œæ¯åˆ—çš„åç§°å’Œç±»å‹å„æ˜¯ä»€ä¹ˆã€‚DataFrameæ˜¯ä¸ºæ•°æ®æä¾›äº†Schemaçš„è§†å›¾ã€‚å¯ä»¥æŠŠå®ƒå½“åšæ•°æ®åº“ä¸­çš„ä¸€å¼ è¡¨æ¥å¯¹å¾…ï¼ŒDataFrameä¹Ÿæ˜¯æ‡’æ‰§è¡Œçš„ã€‚æ€§èƒ½ä¸Šæ¯”RDDè¦é«˜ï¼Œä¸»è¦åŸå› ï¼š</p><p><font color="red">ä¼˜åŒ–çš„æ‰§è¡Œè®¡åˆ’ï¼šæŸ¥è¯¢è®¡åˆ’é€šè¿‡Spark catalyst optimiserè¿›è¡Œä¼˜åŒ–ã€‚</font></p><p><font color="red">ä½†æ˜¯DataFrameåªå­˜å‚¨äº†ç»“æ„ä¿¡æ¯ï¼Œå³åœ¨æ¯ä¸€è¡Œä¸­ï¼Œåªèƒ½é€šè¿‡ç´¢å¼•æ¥è®¿é—®å…ƒç´ ï¼Œå¹¶ä¸èƒ½é€šè¿‡ç±»å‹è®¿é—®ã€‚å› ä¸ºDataFrameä¸ä¿å­˜ç±»å‹ä¿¡æ¯ã€‚</font></p><h2 id="ä»€ä¹ˆæ˜¯DataSet"><a href="#ä»€ä¹ˆæ˜¯DataSet" class="headerlink" title="ä»€ä¹ˆæ˜¯DataSet"></a>ä»€ä¹ˆæ˜¯DataSet</h2><ol><li>æ˜¯Dataframe APIçš„ä¸€ä¸ªæ‰©å±•ï¼Œæ˜¯Sparkæœ€æ–°çš„æ•°æ®æŠ½è±¡ã€‚</li><li>ç”¨æˆ·å‹å¥½çš„APIé£æ ¼ï¼Œæ—¢å…·æœ‰ç±»å‹å®‰å…¨æ£€æŸ¥ä¹Ÿå…·æœ‰Dataframeçš„æŸ¥è¯¢ä¼˜åŒ–ç‰¹æ€§ã€‚</li><li>Datasetæ”¯æŒç¼–è§£ç å™¨ï¼Œå½“éœ€è¦è®¿é—®éå †ä¸Šçš„æ•°æ®æ—¶å¯ä»¥é¿å…ååºåˆ—åŒ–æ•´ä¸ªå¯¹è±¡ï¼Œæé«˜äº†æ•ˆç‡ã€‚</li><li><font color="red">æ ·ä¾‹ç±»è¢«ç”¨æ¥åœ¨Datasetä¸­å®šä¹‰æ•°æ®çš„ç»“æ„ä¿¡æ¯ï¼Œæ ·ä¾‹ç±»ä¸­æ¯ä¸ªå±æ€§çš„åç§°ç›´æ¥æ˜ å°„åˆ°DataSetä¸­çš„å­—æ®µåç§°ã€‚</font></li><li>Dataframeæ˜¯Datasetçš„ç‰¹åˆ—ï¼ŒDataFrame=Dataset[Row] ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡asæ–¹æ³•å°†Dataframeè½¬æ¢ä¸ºDatasetã€‚Rowæ˜¯ä¸€ä¸ªç±»å‹ï¼Œè·ŸCarã€Personè¿™äº›çš„ç±»å‹ä¸€æ ·ï¼Œæ‰€æœ‰çš„è¡¨ç»“æ„ä¿¡æ¯æˆ‘éƒ½ç”¨Rowæ¥è¡¨ç¤ºã€‚</li><li><font color="red"><strong>DataSetæ˜¯å¼ºç±»å‹çš„</strong>ã€‚æ¯”å¦‚å¯ä»¥æœ‰Dataset[Car]ï¼ŒDataset[Person].</font></li><li><font color="red">DataFrameåªæ˜¯çŸ¥é“å­—æ®µï¼Œä½†æ˜¯ä¸çŸ¥é“å­—æ®µçš„ç±»å‹ï¼Œæ‰€ä»¥åœ¨æ‰§è¡Œè¿™äº›æ“ä½œçš„æ—¶å€™æ˜¯æ²¡åŠæ³•åœ¨ç¼–è¯‘çš„æ—¶å€™æ£€æŸ¥æ˜¯å¦ç±»å‹å¤±è´¥çš„ï¼Œæ¯”å¦‚ä½ å¯ä»¥å¯¹ä¸€ä¸ªStringè¿›è¡Œå‡æ³•æ“ä½œï¼Œåœ¨æ‰§è¡Œçš„æ—¶å€™æ‰æŠ¥é”™</font>ï¼Œè€ŒDataSetä¸ä»…ä»…çŸ¥é“å­—æ®µï¼Œ<strong>è€Œä¸”çŸ¥é“å­—æ®µç±»å‹ï¼Œæ‰€ä»¥æœ‰æ›´ä¸¥æ ¼çš„é”™è¯¯æ£€æŸ¥ã€‚å°±è·ŸJSONå¯¹è±¡å’Œç±»å¯¹è±¡ä¹‹é—´çš„ç±»æ¯”</strong>ã€‚</li></ol><h2 id="RDDã€DataFrameã€DataSetğŸ”º"><a href="#RDDã€DataFrameã€DataSetğŸ”º" class="headerlink" title="RDDã€DataFrameã€DataSetğŸ”º"></a>RDDã€DataFrameã€DataSetğŸ”º</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200824213514197.png" alt="image-20200824213514197"></p><ul><li>RDDï¼šæ²¡æœ‰ç»“æ„å’Œç±»å‹</li><li>DataFrameï¼šæœ‰ç»“æ„æ²¡ç±»å‹ã€‚æ‰€ä»¥ç”±DFå˜ä¸ºRDDæ—¶ï¼ŒRDDå­˜å‚¨çš„æ˜¯ROWå¯¹è±¡ï¼Œæ­¤æ—¶åªèƒ½é€šè¿‡ç´¢å¼•è·å–å€¼ï¼Œå› ä¸ºå®ƒä¸å­˜å‚¨ç±»å‹</li><li>DataSetï¼šæœ‰ç»“æ„å’Œç±»å‹ã€‚æ‰€ä»¥DSå˜RDDæ—¶ï¼ŒRDDå­˜å‚¨çš„æ˜¯ç¡®å®šçš„ç±»ï¼Œå¯ä»¥é€šè¿‡ç±»è®¿é—®ç¡®å®šç±»å‹çš„å±æ€§</li></ul><p>ç”±äºä¸Šè¿°ä¸‰è€…çš„å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®šï¼š</p><ol><li>RDDè½¬æ¢DFæ—¶ï¼Œéœ€è¦è¯´æ˜ç»“æ„</li><li>RDDè½¬æ¢DSæ—¶ï¼Œéœ€è¦è¯´æ˜ç»“æ„å’Œç±»å‹ã€‚(ç±»åŒæ—¶åŒ…å«ç»“æ„å’Œç±»å‹)</li><li>DFè½¬RDDæ—¶ï¼Œç›´æ¥è½¬æ¢ï¼ŒRDDå­˜å‚¨ROW</li><li>DSè½¬RDDæ—¶ï¼Œç›´æ¥è½¬æ¢ï¼ŒRDDå­˜å‚¨å…·ä½“çš„ç±»</li></ol><h1 id="SparkSQLç¼–ç¨‹"><a href="#SparkSQLç¼–ç¨‹" class="headerlink" title="SparkSQLç¼–ç¨‹"></a>SparkSQLç¼–ç¨‹</h1><h2 id="SparkSessionæ–°çš„èµ·å§‹ç‚¹"><a href="#SparkSessionæ–°çš„èµ·å§‹ç‚¹" class="headerlink" title="SparkSessionæ–°çš„èµ·å§‹ç‚¹"></a>SparkSessionæ–°çš„èµ·å§‹ç‚¹</h2><p>åœ¨è€çš„ç‰ˆæœ¬ä¸­ï¼ŒSparkSQLæä¾›ä¸¤ç§SQLæŸ¥è¯¢èµ·å§‹ç‚¹ï¼šä¸€ä¸ªå«<code>SQLContext</code>ï¼Œç”¨äºSparkè‡ªå·±æä¾›çš„SQLæŸ¥è¯¢ï¼›ä¸€ä¸ªå«<code>HiveContext</code>ï¼Œç”¨äºè¿æ¥Hiveçš„æŸ¥è¯¢ã€‚</p><p>SparkSessionæ˜¯Sparkæœ€æ–°çš„SQLæŸ¥è¯¢èµ·å§‹ç‚¹ï¼Œå®è´¨ä¸Šæ˜¯SQLContextå’ŒHiveContextçš„ç»„åˆï¼Œæ‰€ä»¥åœ¨SQLContextå’ŒHiveContextä¸Šå¯ç”¨çš„APIåœ¨SparkSessionä¸ŠåŒæ ·æ˜¯å¯ä»¥ä½¿ç”¨çš„ã€‚<font color="red">**<code>SparkSession</code>å†…éƒ¨å°è£…äº†<code>sparkContext</code>ï¼Œæ‰€ä»¥è®¡ç®—å®é™…ä¸Šæ˜¯ç”±sparkContextå®Œæˆçš„ã€‚**</font></p><h2 id="DataFrame"><a href="#DataFrame" class="headerlink" title="DataFrame"></a>DataFrame</h2><p>DataFrameåªä¼šçŸ¥é“æ•°æ®çš„æ•´ä½“ç»“æ„ï¼Œå½“ä½ æŸ¥è¯¢ä¸€ä¸ªåˆ—å<code>name</code>æ—¶<strong>ï¼Œæ­¤æ—¶å®ƒå¹¶ä¸çŸ¥é“å®ƒçš„ç±»å‹ï¼Œå¦‚æœä½ è¿›è¡Œæ“ä½œç¼–è¯‘æ—¶ä¸ä¼šå‡ºé”™ï¼Œå½“è¿è¡Œæ—¶æ‰æœ‰å¯èƒ½å‡ºé”™ã€‚</strong></p><h3 id="åˆ›å»º"><a href="#åˆ›å»º" class="headerlink" title="åˆ›å»º"></a>åˆ›å»º</h3><p>åœ¨Spark SQLä¸­<code>SparkSession</code>æ˜¯åˆ›å»º<code>DataFrame</code>å’Œæ‰§è¡ŒSQL<strong>çš„å…¥å£</strong>ï¼Œåˆ›å»ºDataFrameæœ‰ä¸‰ç§æ–¹å¼ï¼š</p><ul><li>é€šè¿‡Sparkçš„æ•°æ®æºè¿›è¡Œåˆ›å»ºï¼›</li><li>ä»ä¸€ä¸ªå­˜åœ¨çš„RDDè¿›è¡Œè½¬æ¢ï¼›</li><li>è¿˜å¯ä»¥ä»Hive Tableè¿›è¡ŒæŸ¥è¯¢è¿”å›ã€‚</li></ul><h4 id="Sparkæ•°æ®æºåˆ›å»º"><a href="#Sparkæ•°æ®æºåˆ›å»º" class="headerlink" title="Sparkæ•°æ®æºåˆ›å»º"></a><strong>Sparkæ•°æ®æºåˆ›å»º</strong></h4><p>æŸ¥çœ‹Sparkæ•°æ®æºè¿›è¡Œåˆ›å»ºçš„æ–‡ä»¶æ ¼å¼</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; spark.read.</span><br><span class="line">csv   format   jdbc   json   load   option   options   orc   parquet   schema   table   text   textFile</span><br></pre></td></tr></table></figure><p><strong>è¯»å–jsonæ–‡ä»¶åˆ›å»ºDataFrame</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; <span class="keyword">val</span> df = spark.read.json(<span class="string">&quot;file:///home/hadoop/test.json&quot;</span>)</span><br><span class="line">df: org.apache.spark.sql.<span class="type">DataFrame</span> = [age: bigint, name: string]</span><br><span class="line"></span><br><span class="line">scala&gt; df.show</span><br><span class="line">+---+--------+</span><br><span class="line">|age|    name|</span><br><span class="line">+---+--------+</span><br><span class="line">| <span class="number">20</span>|zhangsan|</span><br><span class="line">| <span class="number">40</span>|    lisi|</span><br><span class="line">+---+--------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scala&gt;</span><br></pre></td></tr></table></figure><h4 id="RDDåˆ›å»º"><a href="#RDDåˆ›å»º" class="headerlink" title="RDDåˆ›å»º"></a>RDDåˆ›å»º</h4><p><a href="#RDD%E8%BD%ACDataFrame">ç‚¹å‡»è·³è½¬</a></p><h3 id="SQLé£æ ¼è¯­æ³•ğŸ”º"><a href="#SQLé£æ ¼è¯­æ³•ğŸ”º" class="headerlink" title="SQLé£æ ¼è¯­æ³•ğŸ”º"></a>SQLé£æ ¼è¯­æ³•ğŸ”º</h3><p>å¦‚æœæƒ³ä»¥SQLå½¢å¼è¯»å–æ•°æ®ï¼Œå°±å¿…é¡»æœ‰è¡¨ï¼Œä¸Šé¢æˆ‘ä»¬åˆ›å»ºçš„å¯¹è±¡<code>df</code>å¹¶ä¸æ˜¯è¡¨æ˜ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡è¿™ä¸ªå¯¹è±¡æ¥åˆ›å»ºä¸€ä¸ªä¸´æ—¶è§†å›¾<font color="red">ï¼Œæ—¢ç„¶æ˜¯è§†å›¾ï¼Œå¿…ç„¶åªå¯ä»¥æŸ¥è¯¢ã€‚</font>ç„¶åå°±å¯ä»¥é€šè¿‡è§†å›¾åæ¥ç¼–å†™SQLæ¥æŸ¥è¯¢äº†ï¼ï¼</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; df.create</span><br><span class="line">createGlobalTempView   createOrReplaceTempView   createTempView</span><br><span class="line"></span><br><span class="line">scala&gt; df.createTempView(<span class="string">&quot;table&quot;</span>)</span><br><span class="line"></span><br><span class="line">scala&gt; spark.sql(<span class="string">&quot;select * from table where age=40&quot;</span>).show</span><br><span class="line">+---+----+</span><br><span class="line">|age|name|</span><br><span class="line">+---+----+</span><br><span class="line">| <span class="number">40</span>|lisi|</span><br><span class="line">+---+----+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scala&gt;</span><br></pre></td></tr></table></figure><p><font color="red"><strong>æ³¨æ„</strong>ï¼šä¸´æ—¶è¡¨æ˜¯SessionèŒƒå›´å†…çš„ï¼ŒSessioné€€å‡ºåï¼Œè¡¨å°±å¤±æ•ˆäº†ã€‚</font>å¦‚æœæƒ³åº”ç”¨èŒƒå›´å†…æœ‰æ•ˆï¼Œå¯ä»¥ä½¿ç”¨å…¨å±€è¡¨ã€‚æ³¨æ„ä½¿ç”¨å…¨å±€è¡¨æ—¶éœ€è¦å…¨è·¯å¾„è®¿é—®ï¼Œå¦‚ï¼šglobal_temp.people</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; spark.newSession.sql(<span class="string">&quot;select * from table where age=40&quot;</span>).show <span class="comment">// é”™è¯¯</span></span><br><span class="line">scala&gt; df.createGlobalTempView(<span class="string">&quot;tmp&quot;</span>)</span><br><span class="line"></span><br><span class="line">scala&gt; spark.newSession.sql(<span class="string">&quot;select * from global_temp.tmp&quot;</span>).show</span><br><span class="line">+---+--------+</span><br><span class="line">|age|    name|</span><br><span class="line">+---+--------+</span><br><span class="line">| <span class="number">20</span>|zhangsan|</span><br><span class="line">| <span class="number">40</span>|    lisi|</span><br><span class="line">+---+--------+</span><br><span class="line"></span><br><span class="line">scala&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¦‚æœä½¿ç”¨å…¨å±€è¡¨çš„è¯ï¼Œæ— è®ºå“ªä¸ªSessionç¯å¢ƒéƒ½å¿…é¡»ä½¿ç”¨<code>global_temp.xxx</code>å½¢å¼è®¿é—®ã€‚</p><h3 id="DSLé£æ ¼è¯­æ³•"><a href="#DSLé£æ ¼è¯­æ³•" class="headerlink" title="DSLé£æ ¼è¯­æ³•"></a>DSLé£æ ¼è¯­æ³•</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; df.select(<span class="string">&quot;name&quot;</span>).show</span><br><span class="line">+--------+</span><br><span class="line">|    name|</span><br><span class="line">+--------+</span><br><span class="line">|zhangsan|</span><br><span class="line">|    lisi|</span><br><span class="line">+--------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scala&gt; df.select($<span class="string">&quot;age&quot;</span>+<span class="number">1</span>).show</span><br><span class="line">+---------+</span><br><span class="line">|(age + <span class="number">1</span>)|</span><br><span class="line">+---------+</span><br><span class="line">|       <span class="number">21</span>|</span><br><span class="line">|       <span class="number">41</span>|</span><br><span class="line">+---------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scala&gt;</span><br></pre></td></tr></table></figure><ul><li><code>select</code>ï¼šåªæŸ¥çœ‹æŒ‡å®šåˆ—æ•°æ®</li><li><code>select($&quot;&quot;)</code>ï¼šä»¥æ­¤åˆ—ä¸ºå˜é‡è¿›è¡Œå…¶ä»–è®¡ç®—</li></ul><h3 id="RDDè½¬DataFrame"><a href="#RDDè½¬DataFrame" class="headerlink" title="RDDè½¬DataFrame"></a>RDDè½¬DataFrame</h3><p>æ³¨æ„ï¼šå¦‚æœéœ€è¦RDDä¸DFæˆ–è€…DSä¹‹é—´æ“ä½œï¼Œ<font color="red">é‚£ä¹ˆéƒ½éœ€è¦å¼•å…¥<code> import spark.implicits._</code>Â <strong>ã€sparkä¸æ˜¯åŒ…åï¼Œè€Œæ˜¯sparkSessionå¯¹è±¡çš„åç§°ã€‘</strong></font></p><p><strong>å‰ç½®æ¡ä»¶ï¼š<font color="red">å¯¼å…¥éšå¼è½¬æ¢å¹¶åˆ›å»ºä¸€ä¸ªRDD</font></strong></p><p><strong>1. é€šè¿‡æ‰‹åŠ¨æŒ‡å®šç»“æ„</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; <span class="keyword">import</span> spark.implicits._</span><br><span class="line"><span class="keyword">import</span> spark.implicits._</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> rdd = sc.makeRDD(<span class="number">1</span> to <span class="number">10</span>)</span><br><span class="line">rdd: org.apache.spark.rdd.<span class="type">RDD</span>[<span class="type">Int</span>] = <span class="type">ParallelCollectionRDD</span>[<span class="number">20</span>] at makeRDD at &lt;console&gt;:<span class="number">27</span></span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> df = rdd.toDF(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">df: org.apache.spark.sql.<span class="type">DataFrame</span> = [id: int]</span><br><span class="line"></span><br><span class="line">scala&gt; df.show</span><br><span class="line">+---+</span><br><span class="line">| id|</span><br><span class="line">+---+</span><br><span class="line">|  <span class="number">1</span>|</span><br><span class="line">|  <span class="number">2</span>|</span><br><span class="line">|  <span class="number">3</span>|</span><br><span class="line">|  <span class="number">4</span>|</span><br><span class="line">|  <span class="number">5</span>|</span><br><span class="line">|  <span class="number">6</span>|</span><br><span class="line">|  <span class="number">7</span>|</span><br><span class="line">|  <span class="number">8</span>|</span><br><span class="line">|  <span class="number">9</span>|</span><br><span class="line">| <span class="number">10</span>|</span><br><span class="line">+---+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scala&gt;</span><br></pre></td></tr></table></figure><p><strong>2. é€šè¿‡æ ·ä¾‹ç±»æŒ‡å®šç»“æ„ï¼Œç±»åŒæ—¶åŒ…å«ç»“æ„å’Œç±»å‹</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; <span class="keyword">import</span> spark.implicits._</span><br><span class="line"><span class="keyword">import</span> spark.implicits._</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> rdd = sc.makeRDD(<span class="type">List</span>((<span class="string">&quot;zhangsan&quot;</span>,<span class="number">20</span>), (<span class="string">&quot;lisi&quot;</span>,<span class="number">20</span>)))</span><br><span class="line">rdd: org.apache.spark.rdd.<span class="type">RDD</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = <span class="type">ParallelCollectionRDD</span>[<span class="number">24</span>] at makeRDD at &lt;console&gt;:<span class="number">27</span></span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">user</span>(<span class="params">name:<span class="type">String</span>, age:<span class="type">Int</span></span>)</span></span><br><span class="line"><span class="class"><span class="title">defined</span> <span class="title">class</span> <span class="title">user</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">scala&gt;</span> <span class="title">val</span> <span class="title">mapRdd</span> </span>= rdd.map(x=&gt;&#123;user(x._1, x._2)&#125;)</span><br><span class="line">mapRdd: org.apache.spark.rdd.<span class="type">RDD</span>[user] = <span class="type">MapPartitionsRDD</span>[<span class="number">25</span>] at map at &lt;console&gt;:<span class="number">31</span></span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> df = mapRdd.toDF</span><br><span class="line">df: org.apache.spark.sql.<span class="type">DataFrame</span> = [name: string, age: int]</span><br><span class="line"></span><br><span class="line">scala&gt; df.show</span><br><span class="line">+--------+---+</span><br><span class="line">|    name|age|</span><br><span class="line">+--------+---+</span><br><span class="line">|zhangsan| <span class="number">20</span>|</span><br><span class="line">|    lisi| <span class="number">20</span>|</span><br><span class="line">+--------+---+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scala&gt;</span><br></pre></td></tr></table></figure><h3 id="DataFrameè½¬RDD"><a href="#DataFrameè½¬RDD" class="headerlink" title="DataFrameè½¬RDD"></a>DataFrameè½¬RDD</h3><p>DataFrameï¼šæœ‰ç»“æ„æ²¡ç±»å‹ã€‚æ‰€ä»¥ç”±DFå˜ä¸ºRDDæ—¶ï¼ŒRDDå­˜å‚¨çš„æ˜¯ROWå¯¹è±¡ï¼Œæ­¤æ—¶åªèƒ½é€šè¿‡ç´¢å¼•è·å–å€¼ï¼Œå› ä¸ºå®ƒä¸å­˜å‚¨ç±»å‹</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; <span class="keyword">val</span> dfToRDD = df.rdd</span><br><span class="line">dfToRDD: org.apache.spark.rdd.<span class="type">RDD</span>[org.apache.spark.sql.<span class="type">Row</span>] = <span class="type">MapPartitionsRDD</span>[<span class="number">35</span>] at rdd at &lt;console&gt;:<span class="number">35</span></span><br><span class="line"></span><br><span class="line">scala&gt; dfToRDD.collect</span><br><span class="line">res11: <span class="type">Array</span>[org.apache.spark.sql.<span class="type">Row</span>] = <span class="type">Array</span>([zhangsan,<span class="number">20</span>], [lisi,<span class="number">20</span>])</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¯·æ³¨æ„<code>Row</code>å¯¹è±¡ï¼Œå®ƒåªèƒ½ç´¢å¼•è®¿é—®å…ƒç´ ï¼Œè€Œä¸”å®ƒä¸çŸ¥é“å­—æ®µçš„ç±»å‹</p><h2 id="DataSet"><a href="#DataSet" class="headerlink" title="DataSet"></a>DataSet</h2><h3 id="åˆ›å»º-1"><a href="#åˆ›å»º-1" class="headerlink" title="åˆ›å»º"></a>åˆ›å»º</h3><p><font color="red">å› ä¸º<code>DataSet</code>åˆ›å»ºæ—¶åŒæ—¶éœ€è¦ç»“æ„å’Œç±»å‹ï¼Œè¿™æ—¶å°±éœ€è¦ä½¿ç”¨åˆ°æ ·ä¾‹ç±»äº†ï¼Œå› ä¸ºç±»æ—¢æœ‰ç»“æ„åˆæœ‰ç±»å‹ã€‚</font>é€šè¿‡ç±»åˆ›å»ºDataSetå¾ˆæ–¹ä¾¿ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; <span class="keyword">import</span> spark.implicits._</span><br><span class="line"><span class="keyword">import</span> spark.implicits._</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span>(<span class="params">name: <span class="type">String</span>, age: <span class="type">Long</span></span>)</span></span><br><span class="line"><span class="class"><span class="title">defined</span> <span class="title">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">scala&gt;</span>  <span class="title">val</span> <span class="title">caseClassDS</span> </span>= <span class="type">Seq</span>(<span class="type">Person</span>(<span class="string">&quot;Andy&quot;</span>, <span class="number">32</span>)).toDS()</span><br><span class="line">caseClassDS: org.apache.spark.sql.<span class="type">Dataset</span>[<span class="type">Person</span>] = [name: string, age: bigint]</span><br><span class="line"></span><br><span class="line">scala&gt;</span><br></pre></td></tr></table></figure><h3 id="RDDè½¬DataSet"><a href="#RDDè½¬DataSet" class="headerlink" title="RDDè½¬DataSet"></a>RDDè½¬DataSet</h3><p>SparkSQLèƒ½å¤Ÿè‡ªåŠ¨å°†åŒ…å«æœ‰<code>case</code>ç±»çš„RDDè½¬æ¢æˆDataFrameï¼Œ<code>case</code>ç±»å®šä¹‰äº†tableçš„ç»“æ„ï¼Œ<font color="red"><strong>caseç±»å±æ€§é€šè¿‡åå°„å˜æˆäº†è¡¨çš„åˆ—åã€‚</strong></font></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; <span class="keyword">import</span> spark.implicits._</span><br><span class="line"><span class="keyword">import</span> spark.implicits._</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> rdd = sc.makeRDD(<span class="type">List</span>((<span class="string">&quot;zhangsan&quot;</span>,<span class="number">20</span>), (<span class="string">&quot;lisi&quot;</span>,<span class="number">20</span>)))</span><br><span class="line">rdd: org.apache.spark.rdd.<span class="type">RDD</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = <span class="type">ParallelCollectionRDD</span>[<span class="number">24</span>] at makeRDD at &lt;console&gt;:<span class="number">27</span></span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">user</span>(<span class="params">name:<span class="type">String</span>, age:<span class="type">Int</span></span>)</span></span><br><span class="line"><span class="class"><span class="title">defined</span> <span class="title">class</span> <span class="title">user</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">scala&gt;</span> <span class="title">val</span> <span class="title">mapRdd</span> </span>= rdd.map(x=&gt;&#123;user(x._1, x._2)&#125;)</span><br><span class="line">mapRdd: org.apache.spark.rdd.<span class="type">RDD</span>[user] = <span class="type">MapPartitionsRDD</span>[<span class="number">25</span>] at map at &lt;console&gt;:<span class="number">31</span></span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> ds = mapRdd.toDS</span><br></pre></td></tr></table></figure><h3 id="DataSetè½¬RDD"><a href="#DataSetè½¬RDD" class="headerlink" title="DataSetè½¬RDD"></a>DataSetè½¬RDD</h3><p>è°ƒç”¨rddæ–¹æ³•å³å¯ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span>(<span class="params">name: <span class="type">String</span>, age: <span class="type">Long</span></span>)</span></span><br><span class="line"><span class="class"><span class="title">defined</span> <span class="title">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">scala&gt;</span>  <span class="title">val</span> <span class="title">caseClassDS</span> </span>= <span class="type">Seq</span>(<span class="type">Person</span>(<span class="string">&quot;Andy&quot;</span>, <span class="number">32</span>)).toDS()</span><br><span class="line">caseClassDS: org.apache.spark.sql.<span class="type">Dataset</span>[<span class="type">Person</span>] = [name: string, age: bigint]</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> rdd = caseClassDS.rdd</span><br><span class="line">rdd: org.apache.spark.rdd.<span class="type">RDD</span>[<span class="type">Person</span>] = <span class="type">MapPartitionsRDD</span>[<span class="number">39</span>] at rdd at &lt;console&gt;:<span class="number">30</span></span><br><span class="line"></span><br><span class="line">scala&gt;</span><br></pre></td></tr></table></figure><h2 id="DataSetä¸DataFrameçš„äº’æ“ä½œ"><a href="#DataSetä¸DataFrameçš„äº’æ“ä½œ" class="headerlink" title="DataSetä¸DataFrameçš„äº’æ“ä½œ"></a>DataSetä¸DataFrameçš„äº’æ“ä½œ</h2><ol><li>DataFrameä¸DataSetç›¸æ¯”çš„è¯å°‘äº†ç±»å‹ï¼Œæ‰€ä»¥å°†DFçš„ç»“æ„æ·»åŠ ç±»å‹å³å¯ï¼Œå¯ä»¥é€šè¿‡<font color="red"><strong>caseç±»å±æ€§é€šè¿‡åå°„å˜æˆäº†è¡¨çš„åˆ—åã€‚</strong></font>ä¸»è¦æ“ä½œ<code>df.as[ç±»]</code></li><li>DataSetä¸DataFrameç›¸æ¯”çš„è¯ï¼Œå•¥ä¹Ÿä¸ç¼ºï¼Œç›´æ¥è½¬æ¢å³å¯ï¼š<code>ds.toDF</code></li></ol><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span>(<span class="params">name: <span class="type">String</span>, age: <span class="type">Long</span></span>)</span></span><br><span class="line"><span class="class"><span class="title">defined</span> <span class="title">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">scala&gt;</span>  <span class="title">val</span> <span class="title">caseClassDS</span> </span>= <span class="type">Seq</span>(<span class="type">Person</span>(<span class="string">&quot;Andy&quot;</span>, <span class="number">32</span>)).toDS()</span><br><span class="line">caseClassDS: org.apache.spark.sql.<span class="type">Dataset</span>[<span class="type">Person</span>] = [name: string, age: bigint]</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> df = caseClassDS.toDF</span><br><span class="line">df: org.apache.spark.sql.<span class="type">DataFrame</span> = [name: string, age: bigint]</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> ds = df.as[<span class="type">Person</span>]</span><br><span class="line">ds: org.apache.spark.sql.<span class="type">Dataset</span>[<span class="type">Person</span>] = [name: string, age: bigint]</span><br><span class="line"></span><br><span class="line">scala&gt;</span><br></pre></td></tr></table></figure><h1 id="Ideaåˆ›å»ºSpark-SQLç¨‹åº"><a href="#Ideaåˆ›å»ºSpark-SQLç¨‹åº" class="headerlink" title="Ideaåˆ›å»ºSpark SQLç¨‹åº"></a>Ideaåˆ›å»ºSpark SQLç¨‹åº</h1><p>IDEAä¸­ç¨‹åºçš„æ‰“åŒ…å’Œè¿è¡Œæ–¹å¼éƒ½å’Œ<code>SparkCore</code>ç±»ä¼¼ï¼Œéœ€è¦æ³¨æ„<code>Spark SQL</code>ç¨‹åºéœ€è¦å¼•å…¥ä»¥ä¸‹åŒ…ï¼Œ<font color="red"><code>SparkCore</code>çš„åŒ…ä¸­æ˜¯æ²¡æœ‰<code>SparkSQL</code>çš„å¼€å‘ç¯å¢ƒçš„</font></p><p><strong>Mavenä¾èµ–ä¸­éœ€è¦æ·»åŠ æ–°çš„ä¾èµ–é¡¹ï¼š</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-sql_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>ç¨‹åºç¯å¢ƒä¸‰éƒ¨æ›²</strong></p><ol><li>ç¯å¢ƒé…ç½®å¯¹è±¡<code>sparkConfig</code></li><li>SparkSQLç¯å¢ƒ<code>sparkSession</code></li><li>DFä¸DSçš„ç›¸äº’éšå¼è½¬æ¢å¯¼å…¥<code>import spark.implicits._</code></li></ol><p>æ³¨æ„ï¼šå¦‚æœéœ€è¦RDDä¸DFæˆ–è€…DSä¹‹é—´æ“ä½œï¼Œ<font color="red">é‚£ä¹ˆéƒ½éœ€è¦å¼•å…¥<code> import spark.implicits._</code> <strong>ã€sparkä¸æ˜¯åŒ…åï¼Œè€Œæ˜¯sparkSessionå¯¹è±¡çš„åç§°ã€‘</strong></font></p><p><strong>ç¨‹åºå¦‚ä¸‹</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">SparkSql</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºé…ç½®å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">val</span> config: <span class="type">SparkConf</span> = <span class="keyword">new</span> <span class="type">SparkConf</span>().setMaster(<span class="string">&quot;local[*]&quot;</span>).setAppName(<span class="string">&quot;sql&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºSparkSQLç¯å¢ƒ</span></span><br><span class="line">    <span class="keyword">val</span> spark: <span class="type">SparkSession</span> = <span class="type">SparkSession</span>.builder().config(config).getOrCreate()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éšå¼è½¬æ¢</span></span><br><span class="line">    <span class="keyword">import</span> spark.implicits._</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SparkSessionåŒ…å«äº†SparkContext</span></span><br><span class="line">    <span class="keyword">val</span> initRDD: <span class="type">RDD</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = spark.sparkContext.makeRDD(<span class="type">List</span>((<span class="string">&quot;zhangsan&quot;</span>, <span class="number">20</span>), (<span class="string">&quot;zhang&quot;</span>, <span class="number">30</span>)))</span><br><span class="line">    <span class="keyword">val</span> df: <span class="type">DataFrame</span> = initRDD.map(x =&gt; person(x._1, x._2)).toDF()</span><br><span class="line">    <span class="keyword">val</span> ds: <span class="type">Dataset</span>[person] = initRDD.map(x =&gt; person(x._1, x._2)).toDS()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> rdd: <span class="type">RDD</span>[<span class="type">Row</span>] = df.rdd</span><br><span class="line">    <span class="keyword">val</span> rdd1: <span class="type">RDD</span>[person] = ds.rdd</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">person</span>(<span class="params">name:<span class="type">String</span>, age:<span class="type">Int</span></span>)</span></span><br></pre></td></tr></table></figure><p><font color="red"></font></p><h1 id="ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°"><a href="#ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°" class="headerlink" title="ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°"></a>ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°</h1><h2 id="UDF"><a href="#UDF" class="headerlink" title="UDF"></a>UDF</h2><p>ä¸€å¯¹ä¸€ã€‚</p><p>å¾ˆç®€å•ï¼Œç›´æ¥é‡‡ç”¨åŒ¿åå‡½æ•°å³å¯ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">SparkSql</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºé…ç½®å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">val</span> config: <span class="type">SparkConf</span> = <span class="keyword">new</span> <span class="type">SparkConf</span>().setMaster(<span class="string">&quot;local[*]&quot;</span>).setAppName(<span class="string">&quot;udf&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºSparkSQLç¯å¢ƒ</span></span><br><span class="line">    <span class="keyword">val</span> spark: <span class="type">SparkSession</span> = <span class="type">SparkSession</span>.builder().config(config).getOrCreate()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éšå¼è½¬æ¢</span></span><br><span class="line">    <span class="keyword">import</span> spark.implicits._</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SparkSessionåŒ…å«äº†SparkContext</span></span><br><span class="line">    <span class="keyword">val</span> initRDD: <span class="type">RDD</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = spark.sparkContext.makeRDD(<span class="type">List</span>((<span class="string">&quot;zhangsan&quot;</span>, <span class="number">20</span>), (<span class="string">&quot;zhang&quot;</span>, <span class="number">30</span>)))</span><br><span class="line">    <span class="keyword">val</span> df: <span class="type">DataFrame</span> = initRDD.map(x =&gt; person(x._1, x._2)).toDF()</span><br><span class="line">    <span class="keyword">val</span> ds: <span class="type">Dataset</span>[person] = initRDD.map(x =&gt; person(x._1, x._2)).toDS()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --------dfä¸dsä½¿ç”¨æ–¹æ³•ä¸€è‡´ --------------</span></span><br><span class="line">    ds.createTempView(<span class="string">&quot;ds_table&quot;</span>)</span><br><span class="line">    spark.udf.register(<span class="string">&quot;addName&quot;</span>, (x:<span class="type">String</span>)=&gt; <span class="string">&quot;Name:&quot;</span>+x)</span><br><span class="line">    spark.sql(<span class="string">&quot;select addName(name) from ds_table&quot;</span>).show()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">person</span>(<span class="params">name:<span class="type">String</span>, age:<span class="type">Int</span></span>)</span></span><br></pre></td></tr></table></figure><h2 id="UDAF"><a href="#UDAF" class="headerlink" title="UDAF"></a>UDAF</h2><p>ç”¨æˆ·è‡ªå®šä¹‰èšåˆå‡½æ•°</p><p><code>å¼ºç±»å‹çš„Dataset</code>å’Œ<code>å¼±ç±»å‹çš„DataFrame</code>éƒ½æä¾›äº†ç›¸å…³çš„èšåˆå‡½æ•°ï¼Œ å¦‚ count()ï¼ŒcountDistinct()ï¼Œavg()ï¼Œmax()ï¼Œmin()ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œç”¨æˆ·å¯ä»¥è®¾å®š<strong>è‡ªå·±çš„è‡ªå®šä¹‰èšåˆå‡½æ•°</strong>ã€‚</p><h3 id="å¼±ç±»å‹è‡ªå®šä¹‰å‡½æ•°"><a href="#å¼±ç±»å‹è‡ªå®šä¹‰å‡½æ•°" class="headerlink" title="å¼±ç±»å‹è‡ªå®šä¹‰å‡½æ•°"></a>å¼±ç±»å‹è‡ªå®šä¹‰å‡½æ•°</h3><p>å¼±ç±»å‹ç”¨æˆ·è‡ªå®šä¹‰èšåˆå‡½æ•°ï¼šé€šè¿‡ç»§æ‰¿<code>UserDefinedAggregateFunction</code>æ¥å®ç°ç”¨æˆ·è‡ªå®šä¹‰èšåˆå‡½æ•°ã€‚ä¸‹é¢å±•ç¤ºä¸€ä¸ªæ±‚å¹³å‡å·¥èµ„çš„è‡ªå®šä¹‰èšåˆå‡½æ•°ã€‚</p><p>ç¼ºç‚¹ï¼šéœ€è¦è‡ªå·±æ‰‹åŠ¨è¾“å…¥å„ç§ç±»å‹ï¼Œåœ¨ç¼–å†™é€»è¾‘æ—¶åªèƒ½é€šè¿‡ç´¢å¼•æ‹¿åˆ°å€¼ï¼Œå¿…é¡»å’Œè®¾ç½®ç±»å‹æ—¶é¡ºåºä¸€è‡´ï¼Œå¦åˆ™è¿è¡Œæ—¶åå‡ºç°é—®é¢˜ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">SparkSql</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºé…ç½®å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">val</span> config: <span class="type">SparkConf</span> = <span class="keyword">new</span> <span class="type">SparkConf</span>().setMaster(<span class="string">&quot;local[*]&quot;</span>).setAppName(<span class="string">&quot;udf&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºSparkSQLç¯å¢ƒ</span></span><br><span class="line">    <span class="keyword">val</span> spark: <span class="type">SparkSession</span> = <span class="type">SparkSession</span>.builder().config(config).getOrCreate()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éšå¼è½¬æ¢</span></span><br><span class="line">    <span class="keyword">import</span> spark.implicits._</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SparkSessionåŒ…å«äº†SparkContext</span></span><br><span class="line">    <span class="keyword">val</span> initRDD: <span class="type">RDD</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = spark.sparkContext.makeRDD(<span class="type">List</span>((<span class="string">&quot;zhangsan&quot;</span>, <span class="number">20</span>), (<span class="string">&quot;zhang&quot;</span>, <span class="number">30</span>)))</span><br><span class="line">    <span class="keyword">val</span> df: <span class="type">DataFrame</span> = initRDD.map(x =&gt; person(x._1, x._2)).toDF()</span><br><span class="line">    <span class="keyword">val</span> ds: <span class="type">Dataset</span>[person] = initRDD.map(x =&gt; person(x._1, x._2)).toDS()</span><br><span class="line"></span><br><span class="line">    ds.createTempView(<span class="string">&quot;ds_table&quot;</span>)</span><br><span class="line">    <span class="comment">// æ³¨å†Œèšåˆå‡½æ•°</span></span><br><span class="line">    <span class="keyword">val</span> avg = <span class="keyword">new</span> myAvg</span><br><span class="line">    spark.udf.register(<span class="string">&quot;myavg&quot;</span>, avg)</span><br><span class="line">    <span class="comment">// å¼±ç±»å‹å¯ä»¥é€šè¿‡sqlæˆ–è€…DSLä¸¤ç§æ¨¡å¼æŸ¥è¯¢ï¼Œé€šè¿‡SQLå› ä¸ºå®ƒçš„è¾“å…¥åªæ˜¯ä¸€ä¸ªå€¼è€Œå·²</span></span><br><span class="line">    spark.sql(<span class="string">&quot;select myavg(age) from ds_table&quot;</span>).show()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">person</span>(<span class="params">name: <span class="type">String</span>, age: <span class="type">Int</span></span>)</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">myAvg</span> <span class="keyword">extends</span> <span class="title">UserDefinedAggregateFunction</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è¾“å…¥å€¼çš„ç±»å‹</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">inputSchema</span></span>: <span class="type">StructType</span> = &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="type">StructType</span>().add(<span class="string">&quot;age&quot;</span>, <span class="type">LongType</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç”¨æˆ·è‡ªå®šä¹‰å¤„ç†å‡½æ•°å†…éƒ¨ä½¿ç”¨çš„å˜é‡çš„ç±»å‹</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">bufferSchema</span></span>: <span class="type">StructType</span> = &#123;</span><br><span class="line">    <span class="comment">// è®°ä½é¡ºåºï¼Œåé¢çš„æ“ä½œå…¨æ˜¯æœ‰åºçš„</span></span><br><span class="line">    <span class="keyword">new</span> <span class="type">StructType</span>().add(<span class="string">&quot;sum&quot;</span>, <span class="type">LongType</span>).add(<span class="string">&quot;count&quot;</span>, <span class="type">LongType</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿”å›çš„ç±»å‹</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">dataType</span></span>: <span class="type">DataType</span> = <span class="type">DoubleType</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯¹äºç›¸åŒçš„è¾“å…¥æ˜¯å¦ä¸€ç›´è¿”å›ç›¸åŒçš„è¾“å‡ºï¼›å‡½æ•°çš„ç¨³å®šæ€§</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">deterministic</span></span>: <span class="type">Boolean</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// çœ‹åˆ°bufferå°±æ˜¯å·¥ä½œåŒºï¼Œå‡½æ•°å†…éƒ¨å˜é‡çš„åˆå§‹åŒ–</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span>(buffer: <span class="type">MutableAggregationBuffer</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    buffer(<span class="number">0</span>) = <span class="number">0</span>L <span class="comment">// sum</span></span><br><span class="line">    buffer(<span class="number">1</span>) = <span class="number">0</span>L <span class="comment">// count</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// bufferæ˜¯å·¥ä½œåŒºï¼Œinputæ˜¯å‡½æ•°çš„è¾“å…¥ã€‚è¿™ä¸ªå‡½æ•°å°±æ˜¯æ¯æ¬¡æ¥æ–°çš„è¾“å…¥å€¼æ—¶ï¼Œå‡½æ•°å†…éƒ¨å˜é‡çš„å˜åŒ–</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">update</span></span>(buffer: <span class="type">MutableAggregationBuffer</span>, input: <span class="type">Row</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    buffer(<span class="number">0</span>) = buffer.getLong(<span class="number">0</span>) + input.getLong(<span class="number">0</span>) <span class="comment">// sum</span></span><br><span class="line">    buffer(<span class="number">1</span>) = buffer.getLong(<span class="number">1</span>) + <span class="number">1</span> <span class="comment">// count</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤šä¸ªExecutoræ‰§è¡Œåï¼Œå½¢æˆå¤šä¸ªbuffer  æœ€ååˆå¹¶åˆ°ä¸€èµ·</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">merge</span></span>(buffer1: <span class="type">MutableAggregationBuffer</span>, buffer2: <span class="type">Row</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    buffer1(<span class="number">0</span>) = buffer1.getLong(<span class="number">0</span>) + buffer2.getLong(<span class="number">0</span>)</span><br><span class="line">    buffer1(<span class="number">1</span>) = buffer1.getLong(<span class="number">1</span>) + buffer2.getLong(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æœ€åçš„ç»“æœ</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">evaluate</span></span>(buffer: <span class="type">Row</span>): <span class="type">Any</span> = &#123;</span><br><span class="line">    buffer.getLong(<span class="number">0</span>).toDouble / buffer.getLong(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> <font color="red"><strong>å¼±ç±»å‹å¯ä»¥é€šè¿‡sqlæˆ–è€…DSLä¸¤ç§æ¨¡å¼æŸ¥è¯¢ï¼Œé€šè¿‡SQLå› ä¸ºå®ƒçš„è¾“å…¥åªæ˜¯ä¸€ä¸ªå€¼è€Œå·²</strong></font></p><h3 id="å¼ºç±»å‹è‡ªå®šä¹‰å‡½æ•°"><a href="#å¼ºç±»å‹è‡ªå®šä¹‰å‡½æ•°" class="headerlink" title="å¼ºç±»å‹è‡ªå®šä¹‰å‡½æ•°"></a>å¼ºç±»å‹è‡ªå®šä¹‰å‡½æ•°</h3><p>å¼ºç±»å‹ç”¨æˆ·è‡ªå®šä¹‰èšåˆå‡½æ•°ï¼šé€šè¿‡ç»§æ‰¿<code>Aggregator</code>æ¥å®ç°å¼ºç±»å‹è‡ªå®šä¹‰èšåˆå‡½æ•°ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">SparkSql</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºé…ç½®å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">val</span> config: <span class="type">SparkConf</span> = <span class="keyword">new</span> <span class="type">SparkConf</span>().setMaster(<span class="string">&quot;local[*]&quot;</span>).setAppName(<span class="string">&quot;udf&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºSparkSQLç¯å¢ƒ</span></span><br><span class="line">    <span class="keyword">val</span> spark: <span class="type">SparkSession</span> = <span class="type">SparkSession</span>.builder().config(config).getOrCreate()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éšå¼è½¬æ¢</span></span><br><span class="line">    <span class="keyword">import</span> spark.implicits._</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SparkSessionåŒ…å«äº†SparkContext</span></span><br><span class="line">    <span class="keyword">val</span> initRDD: <span class="type">RDD</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = spark.sparkContext.makeRDD(<span class="type">List</span>((<span class="string">&quot;zhangsan&quot;</span>, <span class="number">20</span>), (<span class="string">&quot;zhang&quot;</span>, <span class="number">30</span>)))</span><br><span class="line">    <span class="keyword">val</span> df: <span class="type">DataFrame</span> = initRDD.map(x =&gt; person(x._1, x._2)).toDF()</span><br><span class="line">    <span class="keyword">val</span> ds: <span class="type">Dataset</span>[person] = initRDD.map(x =&gt; person(x._1, x._2)).toDS()</span><br><span class="line"></span><br><span class="line">    ds.createTempView(<span class="string">&quot;ds_table&quot;</span>)</span><br><span class="line">    <span class="comment">// æ³¨å†Œèšåˆå‡½æ•°</span></span><br><span class="line">    <span class="keyword">val</span> avg = <span class="keyword">new</span> <span class="type">StrongAvg</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä½†æ˜¯ä¸èƒ½ä½¿ç”¨SQLå½¢å¼ï¼Œå› ä¸ºæˆ‘ä»¬å¼ºç±»å‹è¾“å…¥çš„å€¼æ˜¯ä¸€ä¸ªç±»ï¼Œç”¨sqlç¼–å†™å¦‚ä½•ä¼ é€ç»™å‡½æ•°ç»“æ„åŠ ç±»å‹ï¼Œé‚£ä¹ˆé€šè¿‡æœ‰ç»“æ„å’Œç±»å‹çš„åªæœ‰DS</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨DSçš„DSLæ–¹å¼æŸ¥è¯¢</span></span><br><span class="line">    <span class="comment">// å°†èšåˆå‡½æ•°è½¬æ¢ä¸ºæŸ¥è¯¢åˆ—</span></span><br><span class="line">    <span class="keyword">val</span> value: <span class="type">TypedColumn</span>[person, <span class="type">Double</span>] = avg.toColumn.name(<span class="string">&quot;avg&quot;</span>)</span><br><span class="line"></span><br><span class="line">    ds.select(value).show()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">person</span>(<span class="params">name: <span class="type">String</span>, age: <span class="type">Int</span></span>)</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="comment">// !!!å› ä¸ºæ ·ä¾‹ç±»å±æ€§é»˜è®¤valï¼Œéœ€è¦æ‰‹åŠ¨è®¾ç½®ä¸ºvar</span></span></span><br><span class="line"><span class="class"><span class="title">case</span> <span class="title">class</span> <span class="title">dealwith</span>(<span class="params">var sum: <span class="type">Long</span>, var count: <span class="type">Long</span></span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myAvg</span> <span class="keyword">extends</span> <span class="title">UserDefinedAggregateFunction</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è¾“å…¥å€¼çš„ç±»å‹</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">inputSchema</span></span>: <span class="type">StructType</span> = &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="type">StructType</span>().add(<span class="string">&quot;age&quot;</span>, <span class="type">LongType</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç”¨æˆ·è‡ªå®šä¹‰å¤„ç†å‡½æ•°å†…éƒ¨ä½¿ç”¨çš„å˜é‡çš„ç±»å‹</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">bufferSchema</span></span>: <span class="type">StructType</span> = &#123;</span><br><span class="line">    <span class="comment">// è®°ä½é¡ºåºï¼Œåé¢çš„æ“ä½œå…¨æ˜¯æœ‰åºçš„</span></span><br><span class="line">    <span class="keyword">new</span> <span class="type">StructType</span>().add(<span class="string">&quot;sum&quot;</span>, <span class="type">LongType</span>).add(<span class="string">&quot;count&quot;</span>, <span class="type">LongType</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿”å›çš„ç±»å‹</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">dataType</span></span>: <span class="type">DataType</span> = <span class="type">DoubleType</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯¹äºç›¸åŒçš„è¾“å…¥æ˜¯å¦ä¸€ç›´è¿”å›ç›¸åŒçš„è¾“å‡ºï¼›å‡½æ•°çš„ç¨³å®šæ€§</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">deterministic</span></span>: <span class="type">Boolean</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// çœ‹åˆ°bufferå°±æ˜¯å·¥ä½œåŒºï¼Œå‡½æ•°å†…éƒ¨å˜é‡çš„åˆå§‹åŒ–</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span>(buffer: <span class="type">MutableAggregationBuffer</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    buffer(<span class="number">0</span>) = <span class="number">0</span>L <span class="comment">// sum</span></span><br><span class="line">    buffer(<span class="number">1</span>) = <span class="number">0</span>L <span class="comment">// count</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// bufferæ˜¯å·¥ä½œåŒºï¼Œinputæ˜¯å‡½æ•°çš„è¾“å…¥ã€‚è¿™ä¸ªå‡½æ•°å°±æ˜¯æ¯æ¬¡æ¥æ–°çš„è¾“å…¥å€¼æ—¶ï¼Œå‡½æ•°å†…éƒ¨å˜é‡çš„å˜åŒ–</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">update</span></span>(buffer: <span class="type">MutableAggregationBuffer</span>, input: <span class="type">Row</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    buffer(<span class="number">0</span>) = buffer.getLong(<span class="number">0</span>) + input.getLong(<span class="number">0</span>) <span class="comment">// sum</span></span><br><span class="line">    buffer(<span class="number">1</span>) = buffer.getLong(<span class="number">1</span>) + <span class="number">1</span> <span class="comment">// count</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤šä¸ªExecutoræ‰§è¡Œåï¼Œå½¢æˆå¤šä¸ªbuffer  æœ€ååˆå¹¶åˆ°ä¸€èµ·</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">merge</span></span>(buffer1: <span class="type">MutableAggregationBuffer</span>, buffer2: <span class="type">Row</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    buffer1(<span class="number">0</span>) = buffer1.getLong(<span class="number">0</span>) + buffer2.getLong(<span class="number">0</span>)</span><br><span class="line">    buffer1(<span class="number">1</span>) = buffer1.getLong(<span class="number">1</span>) + buffer2.getLong(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æœ€åçš„ç»“æœ</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">evaluate</span></span>(buffer: <span class="type">Row</span>): <span class="type">Any</span> = &#123;</span><br><span class="line">    buffer.getLong(<span class="number">0</span>).toDouble / buffer.getLong(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Aggregator[-IN, BUF, OUT]</span></span><br><span class="line"><span class="comment">// æ³›å‹åˆ†åˆ«ä¸ºè¾“å…¥ç±»å‹ï¼Œå¤„ç†ç±»å‹ï¼Œè¾“å‡ºç±»å‹ã€‚å› ä¸ºå¼ºç±»å‹æ‰€ä»¥éœ€è¦æŒ‡å®šç±»å‹ï¼Œè¿™æ ·å°±èƒ½ç›´æ¥é€šè¿‡å¯¹è±¡è®¿é—®åˆ°æ¯ä¸ªå€¼ï¼Œä¸æ˜¯é€šè¿‡ç´¢å¼•</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StrongAvg</span> <span class="keyword">extends</span> <span class="title">Aggregator</span>[person, dealwith, <span class="type">Double</span>] </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆå§‹å€¼ï¼Œå› ä¸ºè¿”å›dealwithï¼Œæ‰€ä»¥æ˜¯å¤„ç†é€»è¾‘ç±»çš„åˆå§‹åŒ–</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">zero</span></span>: dealwith = dealwith(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿™ä¸ªå‡½æ•°å°±æ˜¯æ¯æ¬¡æ¥æ–°çš„è¾“å…¥å€¼æ—¶ï¼Œå‡½æ•°å†…éƒ¨å˜é‡çš„å˜åŒ–</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">reduce</span></span>(b: dealwith, a: person): dealwith = &#123;</span><br><span class="line">    b.sum = b.sum + a.age</span><br><span class="line">    b.count = b.count + <span class="number">1</span></span><br><span class="line">    b</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤šä¸ªExecutoræ‰§è¡Œåï¼Œå½¢æˆå¤šä¸ªdealwith  æœ€ååˆå¹¶åˆ°ä¸€èµ·</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">merge</span></span>(b1: dealwith, b2: dealwith): dealwith = &#123;</span><br><span class="line">    b1.sum = b1.sum + b2.sum</span><br><span class="line">    b1.count = b1.count + b2.count</span><br><span class="line">    b1</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">finish</span></span>(reduction: dealwith): <span class="type">Double</span> = &#123;</span><br><span class="line">    reduction.sum.toDouble / reduction.count</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è½¬ç å¯¹è±¡è®¾ç½®ï¼Œå›ºå®šå¥—è·¯ï¼Œç¬¬ä¸‰æ–¹ä½¿ç”¨ Encoders.product!!!</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">bufferEncoder</span></span>: <span class="type">Encoder</span>[dealwith] = <span class="type">Encoders</span>.product</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è½¬ç å¯¹è±¡è®¾ç½®</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">outputEncoder</span></span>: <span class="type">Encoder</span>[<span class="type">Double</span>] = <span class="type">Encoders</span>.scalaDouble</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Spark-SQLæ•°æ®æº"><a href="#Spark-SQLæ•°æ®æº" class="headerlink" title="Spark SQLæ•°æ®æº"></a>Spark SQLæ•°æ®æº</h1><h2 id="é€šç”¨åŠ è½½-ä¿å­˜æ–¹æ³•"><a href="#é€šç”¨åŠ è½½-ä¿å­˜æ–¹æ³•" class="headerlink" title="é€šç”¨åŠ è½½/ä¿å­˜æ–¹æ³•"></a>é€šç”¨åŠ è½½/ä¿å­˜æ–¹æ³•</h2><h3 id="æ‰‹åŠ¨æŒ‡å®šé€‰é¡¹"><a href="#æ‰‹åŠ¨æŒ‡å®šé€‰é¡¹" class="headerlink" title="æ‰‹åŠ¨æŒ‡å®šé€‰é¡¹"></a>æ‰‹åŠ¨æŒ‡å®šé€‰é¡¹</h3><p>park SQLçš„DataFrameæ¥å£æ”¯æŒå¤šç§æ•°æ®æºçš„æ“ä½œã€‚ä¸€ä¸ªDataFrameå¯ä»¥è¿›è¡ŒRDDsæ–¹å¼çš„æ“ä½œï¼Œä¹Ÿå¯ä»¥è¢«æ³¨å†Œä¸ºä¸´æ—¶è¡¨ã€‚<strong>æŠŠDataFrameæ³¨å†Œä¸ºä¸´æ—¶è¡¨ä¹‹åï¼Œå°±å¯ä»¥å¯¹è¯¥DataFrameæ‰§è¡ŒSQLæŸ¥è¯¢ã€‚</strong>\</p><p>Spark SQLçš„<font color="red"><strong>é»˜è®¤æ•°æ®æºä¸ºParquetæ ¼å¼</strong></font>ã€‚æ•°æ®æºä¸ºParquetæ–‡ä»¶æ—¶ï¼ŒSpark SQLå¯ä»¥æ–¹ä¾¿çš„æ‰§è¡Œæ‰€æœ‰çš„æ“ä½œã€‚ä¿®æ”¹é…ç½®é¡¹<code>spark.sql.sources.default</code>ï¼Œå¯ä¿®æ”¹é»˜è®¤æ•°æ®æºæ ¼å¼ã€‚</p><p><font color="red">å½“æ•°æ®æºæ ¼å¼ä¸æ˜¯<code>parquet</code>æ ¼å¼æ–‡ä»¶æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨æŒ‡å®šæ•°æ®æºçš„æ ¼å¼</font>ã€‚æ•°æ®æºæ ¼å¼éœ€è¦æŒ‡å®šå…¨åï¼ˆä¾‹å¦‚ï¼šorg.apache.spark.sql.parquetï¼‰ï¼Œå¦‚æœæ•°æ®æºæ ¼å¼ä¸ºå†…ç½®æ ¼å¼ï¼Œåˆ™åªéœ€è¦æŒ‡å®šç®€ç§°å®šjson, parquet, jdbc, orc, libsvm, csv, textæ¥æŒ‡å®šæ•°æ®çš„æ ¼å¼ã€‚</p><p><strong>ä¸¤ç§æ–¹å¼ï¼š</strong></p><ol><li>å¯ä»¥é€šè¿‡SparkSessionæä¾›çš„read.loadæ–¹æ³•ç”¨äºé€šç”¨åŠ è½½æ•°æ®ï¼Œä½¿ç”¨writeå’Œsaveä¿å­˜æ•°æ®</li><li>read.xxx()</li></ol><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//    spark.read.csv()</span></span><br><span class="line"><span class="comment">//    spark.read.json()</span></span><br><span class="line">    </span><br><span class="line">    spark.read.format(<span class="string">&quot;csv&quot;</span>).load()</span><br><span class="line">    spark.read.format(<span class="string">&quot;json&quot;</span>).load()</span><br></pre></td></tr></table></figure><h3 id="æ–‡ä»¶ä¿å­˜é€‰é¡¹"><a href="#æ–‡ä»¶ä¿å­˜é€‰é¡¹" class="headerlink" title="æ–‡ä»¶ä¿å­˜é€‰é¡¹"></a>æ–‡ä»¶ä¿å­˜é€‰é¡¹</h3><p>å¯ä»¥é‡‡ç”¨<code>SaveMode</code>æ‰§è¡Œå­˜å‚¨æ“ä½œï¼Œ<code>SaveMode</code>å®šä¹‰äº†å¯¹æ•°æ®çš„å¤„ç†æ¨¡å¼ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™äº›ä¿å­˜æ¨¡å¼ä¸ä½¿ç”¨ä»»ä½•é”å®šï¼Œä¸æ˜¯åŸå­æ“ä½œã€‚æ­¤å¤–ï¼Œå½“ä½¿ç”¨<code>Overwrite</code>æ–¹å¼æ‰§è¡Œæ—¶ï¼Œåœ¨è¾“å‡ºæ–°æ•°æ®ä¹‹å‰åŸæ•°æ®å°±å·²ç»è¢«åˆ é™¤ã€‚SaveModeè¯¦ç»†ä»‹ç»å¦‚ä¸‹è¡¨ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200826201904989.png" alt="image-20200826201904989"></p><h2 id="JSONæ–‡ä»¶"><a href="#JSONæ–‡ä»¶" class="headerlink" title="JSONæ–‡ä»¶"></a>JSONæ–‡ä»¶</h2><p>Spark SQL èƒ½å¤Ÿè‡ªåŠ¨æ¨æµ‹ JSONæ•°æ®é›†çš„ç»“æ„ï¼Œå¹¶å°†å®ƒåŠ è½½ä¸ºä¸€ä¸ªDataset[Row]. å¯ä»¥é€šè¿‡SparkSession.read.json()å»åŠ è½½ä¸€ä¸ª ä¸€ä¸ªJSON æ–‡ä»¶ã€‚</p><p><font color="red"><strong>æ³¨æ„ï¼šè¿™ä¸ªJSONæ–‡ä»¶ä¸æ˜¯ä¸€ä¸ªä¼ ç»Ÿçš„JSONæ–‡ä»¶ï¼Œæ¯ä¸€è¡Œéƒ½å¾—æ˜¯ä¸€ä¸ªJSONä¸²ã€‚</strong></font></p><p><code>spark.read.format(&quot;json&quot;).load()</code></p><h2 id="Parquetæ–‡ä»¶"><a href="#Parquetæ–‡ä»¶" class="headerlink" title="Parquetæ–‡ä»¶"></a>Parquetæ–‡ä»¶</h2><p><code>Parquet</code>æ˜¯ä¸€ç§æµè¡Œçš„åˆ—å¼å­˜å‚¨æ ¼å¼ï¼Œå¯ä»¥é«˜æ•ˆåœ°å­˜å‚¨å…·æœ‰åµŒå¥—å­—æ®µçš„è®°å½•ã€‚Parquetæ ¼å¼ç»å¸¸åœ¨Hadoopç”Ÿæ€åœˆä¸­è¢«ä½¿ç”¨ï¼Œå®ƒä¹Ÿæ”¯æŒSpark SQLçš„å…¨éƒ¨æ•°æ®ç±»å‹ã€‚<font color="red">Spark SQL æä¾›äº†ç›´æ¥è¯»å–å’Œå­˜å‚¨ Parquet æ ¼å¼æ–‡ä»¶çš„æ–¹æ³•ã€‚ (é»˜è®¤)</font></p><p><code>spark.read.load(xxx)</code>ï¼Œä¸ç”¨æŒ‡å®šç±»å‹ï¼Œé»˜è®¤<code>Parquet</code></p><p><code>peopleDF.write.mode.parquet(&quot;hdfs://hadoop102:9000/people.parquet&quot;)</code></p><h2 id="JDBC"><a href="#JDBC" class="headerlink" title="JDBC"></a>JDBC</h2><p>Spark SQLå¯ä»¥é€šè¿‡JDBCä»å…³ç³»å‹æ•°æ®åº“ä¸­è¯»å–æ•°æ®çš„æ–¹å¼åˆ›å»ºDataFrameï¼Œé€šè¿‡å¯¹DataFrameä¸€ç³»åˆ—çš„è®¡ç®—åï¼Œè¿˜å¯ä»¥å°†æ•°æ®å†å†™å›å…³ç³»å‹æ•°æ®åº“ä¸­ã€‚</p><p><font color="red">æ³¨æ„:éœ€è¦å°†ç›¸å…³çš„æ•°æ®åº“é©±åŠ¨æ”¾åˆ°sparkçš„ç±»è·¯å¾„ä¸‹ã€‚å¦‚æœä½¿ç”¨Spark-Shellçš„è¯</font></p><h3 id="è¯»æ–¹å¼ä¸€"><a href="#è¯»æ–¹å¼ä¸€" class="headerlink" title="è¯»æ–¹å¼ä¸€"></a>è¯»æ–¹å¼ä¸€</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> jdbcDF = spark.read</span><br><span class="line">.format(<span class="string">&quot;jdbc&quot;</span>)</span><br><span class="line">.option(<span class="string">&quot;url&quot;</span>, <span class="string">&quot;jdbc:mysql://hadoop102:3306/rdd&quot;</span>)</span><br><span class="line">.option(<span class="string">&quot;dbtable&quot;</span>, <span class="string">&quot;rddtable&quot;</span>)</span><br><span class="line">.option(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;root&quot;</span>)</span><br><span class="line">.option(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;000000&quot;</span>)</span><br><span class="line">.load()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="è¯»æ–¹å¼äºŒ"><a href="#è¯»æ–¹å¼äºŒ" class="headerlink" title="è¯»æ–¹å¼äºŒ"></a>è¯»æ–¹å¼äºŒ</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> connectionProperties = <span class="keyword">new</span> <span class="type">Properties</span>()</span><br><span class="line">connectionProperties.put(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;root&quot;</span>)</span><br><span class="line">connectionProperties.put(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;000000&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> jdbcDF2 = spark.read.jdbc(<span class="string">&quot;jdbc:mysql://hadoop102:3306/rdd&quot;</span>, <span class="string">&quot;rddtable&quot;</span>,connectionProperties)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="å†™æ–¹å¼ä¸€"><a href="#å†™æ–¹å¼ä¸€" class="headerlink" title="å†™æ–¹å¼ä¸€"></a>å†™æ–¹å¼ä¸€</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">jdbcDF.write.mode(xxx)</span><br><span class="line">.format(<span class="string">&quot;jdbc&quot;</span>)</span><br><span class="line">.option(<span class="string">&quot;url&quot;</span>, <span class="string">&quot;jdbc:mysql://hadoop102:3306/rdd&quot;</span>)</span><br><span class="line">.option(<span class="string">&quot;dbtable&quot;</span>, <span class="string">&quot;dftable&quot;</span>)</span><br><span class="line">.option(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;root&quot;</span>)</span><br><span class="line">.option(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;000000&quot;</span>)</span><br><span class="line">.save()</span><br></pre></td></tr></table></figure><h3 id="å†™æ–¹å¼äºŒ"><a href="#å†™æ–¹å¼äºŒ" class="headerlink" title="å†™æ–¹å¼äºŒ"></a>å†™æ–¹å¼äºŒ</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbcDF2.write.jdbc(<span class="string">&quot;jdbc:mysql://hadoop102:3306/rdd&quot;</span>, <span class="string">&quot;db&quot;</span>, connectionProperties)</span><br></pre></td></tr></table></figure><h2 id="Hiveæ•°æ®ä»“åº“"><a href="#Hiveæ•°æ®ä»“åº“" class="headerlink" title="Hiveæ•°æ®ä»“åº“"></a>Hiveæ•°æ®ä»“åº“</h2><p>Apache Hiveæ˜¯Hadoopä¸Šçš„SQLå¼•æ“ï¼Œ<strong>Spark SQLç¼–è¯‘æ—¶å¯ä»¥åŒ…å«Hiveæ”¯æŒï¼Œä¹Ÿå¯ä»¥ä¸åŒ…å«</strong>ã€‚åŒ…å«Hiveæ”¯æŒçš„Spark SQLå¯ä»¥<strong>æ”¯æŒHiveè¡¨è®¿é—®ã€UDF(ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°)ä»¥åŠ Hive æŸ¥è¯¢è¯­è¨€(HiveQL/HQL)ç­‰</strong>ã€‚éœ€è¦å¼ºè°ƒçš„ä¸€ç‚¹æ˜¯ï¼Œå¦‚æœè¦åœ¨Spark SQLä¸­åŒ…å«Hiveçš„åº“ï¼Œå¹¶ä¸éœ€è¦äº‹å…ˆå®‰è£…Hiveã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæœ€å¥½è¿˜æ˜¯åœ¨ç¼–è¯‘Spark SQLæ—¶å¼•å…¥Hiveæ”¯æŒï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨è¿™äº›ç‰¹æ€§äº†ã€‚å¦‚æœä½ ä¸‹è½½çš„æ˜¯äºŒè¿›åˆ¶ç‰ˆæœ¬çš„ Sparkï¼Œå®ƒåº”è¯¥å·²ç»åœ¨ç¼–è¯‘æ—¶æ·»åŠ äº† Hive æ”¯æŒã€‚ </p><p><font color="red">è‹¥è¦æŠŠSpark SQLè¿æ¥åˆ°ä¸€ä¸ªéƒ¨ç½²å¥½çš„Hiveä¸Šï¼Œä½ å¿…é¡»æŠŠhive-site.xmlå¤åˆ¶åˆ° Sparkçš„é…ç½®æ–‡ä»¶ç›®å½•ä¸­($SPARK_HOME/conf)</font>ã€‚å³ä½¿æ²¡æœ‰éƒ¨ç½²å¥½Hiveï¼ŒSpark SQLä¹Ÿå¯ä»¥è¿è¡Œã€‚<font color="red"> éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä½ æ²¡æœ‰éƒ¨ç½²å¥½Hiveï¼ŒSpark SQLä¼šåœ¨å½“å‰çš„å·¥ä½œç›®å½•ä¸­åˆ›å»ºå‡ºè‡ªå·±çš„Hive å…ƒæ•°æ®ä»“åº“ï¼Œå«ä½œ metastore_dbã€‚</font>æ­¤å¤–ï¼Œå¦‚æœä½ å°è¯•ä½¿ç”¨ HiveQL ä¸­çš„ CREATE TABLE (å¹¶é CREATE EXTERNAL TABLE)è¯­å¥æ¥åˆ›å»ºè¡¨ï¼Œè¿™äº›è¡¨ä¼šè¢«æ”¾åœ¨ä½ é»˜è®¤çš„æ–‡ä»¶ç³»ç»Ÿä¸­çš„ /user/hive/warehouse ç›®å½•ä¸­(å¦‚æœä½ çš„ classpath ä¸­æœ‰é…å¥½çš„ hdfs-site.xmlï¼Œé»˜è®¤çš„æ–‡ä»¶ç³»ç»Ÿå°±æ˜¯ HDFSï¼Œå¦åˆ™å°±æ˜¯æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ)ã€‚</p><h3 id="å†…åµŒçš„Hiveåº”ç”¨"><a href="#å†…åµŒçš„Hiveåº”ç”¨" class="headerlink" title="å†…åµŒçš„Hiveåº”ç”¨"></a>å†…åµŒçš„Hiveåº”ç”¨</h3><p>å¦‚æœè¦ä½¿ç”¨å†…åµŒçš„Hiveï¼Œä»€ä¹ˆéƒ½ä¸ç”¨åšï¼Œç›´æ¥ç”¨å°±å¯ä»¥äº†ã€‚ </p><p>å¯ä»¥é€šè¿‡æ·»åŠ å‚æ•°åˆæ¬¡æŒ‡å®šæ•°æ®ä»“åº“åœ°å€ï¼šâ€“conf </p><p><font color="red"><strong>æ³¨æ„ï¼š</strong>å¦‚æœä½ ä½¿ç”¨çš„æ˜¯å†…éƒ¨çš„Hiveï¼Œåœ¨Spark2.0ä¹‹åï¼Œspark.sql.warehouse.dirç”¨äºæŒ‡å®šæ•°æ®ä»“åº“çš„åœ°å€ï¼Œå¦‚æœä½ éœ€è¦æ˜¯ç”¨HDFSä½œä¸ºè·¯å¾„ï¼Œé‚£ä¹ˆéœ€è¦å°†core-site.xmlå’Œhdfs-site.xml åŠ å…¥åˆ°Spark confç›®å½•ï¼Œå¦åˆ™åªä¼šåˆ›å»ºmasterèŠ‚ç‚¹ä¸Šçš„warehouseç›®å½•ï¼ŒæŸ¥è¯¢æ—¶ä¼šå‡ºç°æ–‡ä»¶æ‰¾ä¸åˆ°çš„é—®é¢˜ï¼Œè¿™æ˜¯éœ€è¦ä½¿ç”¨HDFSï¼Œåˆ™éœ€è¦å°†metastoreåˆ é™¤ï¼Œé‡å¯é›†ç¾¤ã€‚</font></p><h3 id="å¤–éƒ¨çš„Hiveåº”ç”¨"><a href="#å¤–éƒ¨çš„Hiveåº”ç”¨" class="headerlink" title="å¤–éƒ¨çš„Hiveåº”ç”¨"></a>å¤–éƒ¨çš„Hiveåº”ç”¨</h3><p>å¦‚æœæƒ³è¿æ¥å¤–éƒ¨å·²ç»éƒ¨ç½²å¥½çš„Hiveï¼Œéœ€è¦é€šè¿‡ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ã€‚</p><ol><li>å°†Hiveä¸­çš„hive-site.xmlæ‹·è´æˆ–è€…è½¯è¿æ¥åˆ°Sparkå®‰è£…ç›®å½•ä¸‹çš„confç›®å½•ä¸‹ã€‚</li><li>æ‰“å¼€spark shellï¼Œæ³¨æ„å¸¦ä¸Šè®¿é—®Hiveå…ƒæ•°æ®åº“çš„JDBCå®¢æˆ·ç«¯</li></ol><p><code>bin/spark-shell --jars mysql-connector-java-5.1.27-bin.jar</code></p><p>åˆæˆ–è€…å°†æ­¤jaråŒ…æ”¾å…¥sparkçš„ä¾èµ–ç›®å½•</p><h3 id="Spark-SQL-CLI"><a href="#Spark-SQL-CLI" class="headerlink" title="Spark SQL CLI"></a>Spark SQL CLI</h3><p>Spark SQL CLIå¯ä»¥å¾ˆæ–¹ä¾¿çš„åœ¨æœ¬åœ°è¿è¡ŒHiveå…ƒæ•°æ®æœåŠ¡ä»¥åŠä»å‘½ä»¤è¡Œæ‰§è¡ŒæŸ¥è¯¢ä»»åŠ¡ã€‚åœ¨Sparkç›®å½•ä¸‹æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å¯åŠ¨Spark SQL CLIï¼š</p><p><code>./bin/spark-sql</code></p><h3 id="ä»£ç ä¸­ä½¿ç”¨Hive"><a href="#ä»£ç ä¸­ä½¿ç”¨Hive" class="headerlink" title="ä»£ç ä¸­ä½¿ç”¨Hive"></a>ä»£ç ä¸­ä½¿ç”¨Hive</h3><p><strong>pom</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.spark/spark-hive --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-hive_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.hive/hive-exec --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hive<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hive-exec<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>åˆ›å»ºSparkSessionæ—¶éœ€è¦æ·»åŠ hiveæ”¯æŒ</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> warehouseLocation: <span class="type">String</span> = <span class="keyword">new</span> <span class="type">File</span>(<span class="string">&quot;spark-warehouse&quot;</span>).getAbsolutePath</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> spark = <span class="type">SparkSession</span></span><br><span class="line">.builder()</span><br><span class="line">.appName(<span class="string">&quot;Spark Hive Example&quot;</span>)</span><br><span class="line">.config(<span class="string">&quot;spark.sql.warehouse.dir&quot;</span>, warehouseLocation)</span><br><span class="line">.enableHiveSupport() <span class="comment">// æ·»åŠ hiveæ”¯æŒ</span></span><br><span class="line">.getOrCreate()</span><br></pre></td></tr></table></figure><p><font color="red"><strong>æ³¨æ„ï¼š</strong>è“è‰²éƒ¨åˆ†ä¸ºä½¿ç”¨å†…ç½®Hiveéœ€è¦æŒ‡å®šä¸€ä¸ªHiveä»“åº“åœ°å€ã€‚è‹¥ä½¿ç”¨çš„æ˜¯å¤–éƒ¨Hiveï¼Œåˆ™éœ€è¦<strong>å°†hive-site.xmlæ·»åŠ åˆ°ClassPathä¸‹</strong>ã€‚</font></p><p><font color="red"></font></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Spark-SQLæ¦‚è¿°&quot;&gt;&lt;a href=&quot;#Spark-SQLæ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;Spark SQLæ¦‚è¿°&quot;&gt;&lt;/a&gt;Spark SQLæ¦‚è¿°&lt;/h1&gt;&lt;h2 id=&quot;ä»€ä¹ˆæ˜¯Spark-SQL&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯Sp</summary>
      
    
    
    
    <category term="Spark" scheme="https://awslzhang.top/categories/Spark/"/>
    
    
    <category term="Spark" scheme="https://awslzhang.top/tags/Spark/"/>
    
  </entry>
  
</feed>
