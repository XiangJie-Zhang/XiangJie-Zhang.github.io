<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>zxj</title>
  
  <subtitle>Viva La Vida</subtitle>
  <link href="https://awslzhang.top/atom.xml" rel="self"/>
  
  <link href="https://awslzhang.top/"/>
  <updated>2021-02-02T13:35:45.576Z</updated>
  <id>https://awslzhang.top/</id>
  
  <author>
    <name>Xiangjie</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Apiå’ŒSQL</title>
    <link href="https://awslzhang.top/2021/01/10/Api%E5%92%8CSQL/"/>
    <id>https://awslzhang.top/2021/01/10/Api%E5%92%8CSQL/</id>
    <published>2021-01-10T03:51:40.000Z</published>
    <updated>2021-02-02T13:35:45.576Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ•´ä½“ä»‹ç»"><a href="#æ•´ä½“ä»‹ç»" class="headerlink" title="æ•´ä½“ä»‹ç»"></a>æ•´ä½“ä»‹ç»</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110115741903.png" alt="image-20210110115741903"></p><p>Flinkæœ‰ä¸‰å±‚APIï¼Œè¶Šé¡¶å±‚è¶ŠæŠ½è±¡ï¼ˆæ–¹ä¾¿ï¼‰ï¼Œä½†ä¸çµæ´»</p><ul><li>SQLï¼šæœ¬æ–‡</li><li>DataStreamï¼š<a href="#">Post not found: Flink Apiå­¦ä¹  è¿™é‡Œ</a></li><li>ProcessFunctionï¼š<a href="#">Post not found: Flinkçš„æ—¶é—´è¯­ä¹‰å’Œwatermark è¿™é‡Œ</a></li></ul><h2 id="ä»€ä¹ˆæ˜¯Table-APIå’ŒFlink-SQL"><a href="#ä»€ä¹ˆæ˜¯Table-APIå’ŒFlink-SQL" class="headerlink" title="ä»€ä¹ˆæ˜¯Table APIå’ŒFlink SQL"></a>ä»€ä¹ˆæ˜¯Table APIå’ŒFlink SQL</h2><p>Flink æœ¬èº«æ˜¯æ‰¹æµç»Ÿä¸€çš„å¤„ç†æ¡†æ¶ï¼Œæ‰€ä»¥ Table API å’Œ SQLï¼Œå°±æ˜¯<strong>æ‰¹æµç»Ÿä¸€çš„ä¸Šå±‚å¤„ç† API</strong>ã€‚ ç›®å‰åŠŸèƒ½å°šæœªå®Œå–„ï¼Œå¤„äºæ´»è·ƒçš„å¼€å‘é˜¶æ®µã€‚ </p><p>Table API æ˜¯ä¸€å¥—å†…åµŒåœ¨ Java å’Œ Scala è¯­è¨€ä¸­çš„æŸ¥è¯¢ APIï¼Œå®ƒå…è®¸æˆ‘ä»¬ä»¥éå¸¸ç›´è§‚çš„æ–¹å¼ï¼Œ ç»„åˆæ¥è‡ªä¸€äº›å…³ç³»è¿ç®—ç¬¦çš„æŸ¥è¯¢ï¼ˆæ¯”å¦‚ selectã€filter å’Œ joinï¼‰ã€‚è€Œå¯¹äº Flink SQLï¼Œå°±æ˜¯ç›´æ¥å¯ ä»¥åœ¨ä»£ç ä¸­å†™ SQLï¼Œæ¥å®ç°ä¸€äº›æŸ¥è¯¢ï¼ˆQueryï¼‰æ“ä½œã€‚Flink çš„ SQL æ”¯æŒï¼ŒåŸºäºå®ç°äº† SQL æ ‡ å‡†çš„ Apache Calciteï¼ˆApache å¼€æº SQL è§£æå·¥å…·ï¼‰ã€‚</p><p> æ— è®ºè¾“å…¥æ˜¯æ‰¹è¾“å…¥è¿˜æ˜¯æµå¼è¾“å…¥ï¼Œåœ¨è¿™ä¸¤å¥— API ä¸­ï¼ŒæŒ‡å®šçš„æŸ¥è¯¢éƒ½å…·æœ‰ç›¸åŒçš„è¯­ä¹‰ï¼Œå¾— åˆ°ç›¸åŒçš„ç»“æœã€‚</p><blockquote><p>Flink SQLåœ¨1.10ç‰ˆæœ¬æ‰ç¨³å®šä¸‹æ¥ï¼Œ1.11ç‰ˆæœ¬</p></blockquote><h2 id="éœ€è¦å¼•å…¥çš„ä¾èµ–"><a href="#éœ€è¦å¼•å…¥çš„ä¾èµ–" class="headerlink" title="éœ€è¦å¼•å…¥çš„ä¾èµ–"></a>éœ€è¦å¼•å…¥çš„ä¾èµ–</h2><p>Table APIå’ŒSQLéœ€è¦å¼•å…¥çš„ä¾èµ–æœ‰ä¸¤ä¸ªï¼šplannerå’Œbridgeã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-table-planner_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-table-planner_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>flink-table-plannerï¼šplannerè®¡åˆ’å™¨ï¼Œæ˜¯table APIæœ€ä¸»è¦çš„éƒ¨åˆ†ï¼Œæä¾›äº†è¿è¡Œæ—¶ç¯å¢ƒå’Œç”Ÿæˆç¨‹åºæ‰§è¡Œè®¡åˆ’çš„plannerï¼›</li><li>flink-table-api-scala-bridgeï¼šbridgeæ¡¥æ¥å™¨ï¼Œä¸»è¦è´Ÿè´£table APIå’Œ DataStream/DataSet APIçš„è¿æ¥æ”¯æŒï¼ŒæŒ‰ç…§è¯­è¨€åˆ†javaå’Œscalaã€‚</li></ul><blockquote><p>planneré‡ŒåŒ…å«bridgeåŒ…ã€‚</p><p>è€ŒFlinkæœ‰ä¸¤ç§ç‰ˆæœ¬çš„planner</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110130012436.png" alt="image-20210110130012436"></p><h2 id="ä¸åŒç‰ˆæœ¬çš„PlannerğŸ”º"><a href="#ä¸åŒç‰ˆæœ¬çš„PlannerğŸ”º" class="headerlink" title="ä¸åŒç‰ˆæœ¬çš„PlannerğŸ”º"></a>ä¸åŒç‰ˆæœ¬çš„PlannerğŸ”º</h2><p>è€ŒFlinkæœ‰ä¸¤ç§ç‰ˆæœ¬çš„plannerï¼š</p><ol><li>planner</li><li>planner-blink</li></ol><blockquote><p>plannerå’Œplanner-blinkçš„æ¶æ„éƒ½ä¸ç›¸åŒï¼Œplanner-blinkçœŸæ­£çš„å®ç°äº†æµæ‰¹ç»Ÿä¸€ã€‚</p></blockquote><p>å¿…é¡»é€‰æ‹©ä¸€ç§ä½¿ç”¨ï¼Œä¸¤è€…ä¸å…¼å®¹ã€‚</p><ol><li>æ‰¹æµç»Ÿä¸€ï¼š<strong>Blinkå°†æ‰¹å¤„ç†ä½œä¸šï¼Œè§†ä¸ºæµå¼å¤„ç†çš„ç‰¹æ®Šæƒ…å†µã€‚</strong>æ‰€ä»¥ï¼Œblinkä¸æ”¯æŒè¡¨å’ŒDataSetä¹‹é—´çš„è½¬æ¢ï¼Œæ‰¹å¤„ç†ä½œä¸šå°†ä¸è½¬æ¢ä¸ºDataSetåº”ç”¨ç¨‹åºï¼Œè€Œæ˜¯è·Ÿæµå¤„ç†ä¸€æ ·ï¼Œè½¬æ¢ä¸ºDataStreamç¨‹åºæ¥å¤„ç†ã€‚</li><li>å› ä¸ºæ‰¹æµç»Ÿä¸€ï¼ŒBlink plannerä¹Ÿä¸æ”¯æŒBatchTableSourceï¼Œè€Œä½¿ç”¨æœ‰ç•Œçš„StreamTableSourceä»£æ›¿ã€‚</li><li>Blink planneråªæ”¯æŒå…¨æ–°çš„ç›®å½•ï¼Œä¸æ”¯æŒå·²å¼ƒç”¨çš„ExternalCatalogã€‚</li><li>æ—§plannerå’ŒBlink plannerçš„FilterableTableSourceå®ç°ä¸å…¼å®¹ã€‚æ—§çš„plannerä¼šæŠŠPlannerExpressionsä¸‹æ¨åˆ°filterableTableSourceä¸­ï¼Œè€Œblink planneråˆ™ä¼šæŠŠExpressionsä¸‹æ¨ã€‚</li><li>åŸºäºå­—ç¬¦ä¸²çš„é”®å€¼é…ç½®é€‰é¡¹ä»…é€‚ç”¨äºBlink plannerã€‚</li><li>PlannerConfigåœ¨ä¸¤ä¸ªplannerä¸­çš„å®ç°ä¸åŒ</li><li>Blink plannerä¼šå°†å¤šä¸ªsinkä¼˜åŒ–åœ¨ä¸€ä¸ªDAGä¸­ï¼ˆä»…åœ¨TableEnvironmentä¸Šå—æ”¯æŒï¼Œè€Œåœ¨StreamTableEnvironmentä¸Šä¸å—æ”¯æŒï¼‰ã€‚è€Œæ—§plannerçš„ä¼˜åŒ–æ€»æ˜¯å°†æ¯ä¸€ä¸ªsinkæ”¾åœ¨ä¸€ä¸ªæ–°çš„DAGä¸­ï¼Œå…¶ä¸­æ‰€æœ‰DAGå½¼æ­¤ç‹¬ç«‹ã€‚</li><li>æ—§çš„plannerä¸æ”¯æŒç›®å½•ç»Ÿè®¡ï¼Œè€ŒBlink planneræ”¯æŒã€‚</li></ol><h1 id="APIè°ƒç”¨"><a href="#APIè°ƒç”¨" class="headerlink" title="APIè°ƒç”¨"></a>APIè°ƒç”¨</h1><h2 id="è¡¨ç¯å¢ƒåˆ›å»ºğŸ”º"><a href="#è¡¨ç¯å¢ƒåˆ›å»ºğŸ”º" class="headerlink" title="è¡¨ç¯å¢ƒåˆ›å»ºğŸ”º"></a>è¡¨ç¯å¢ƒåˆ›å»ºğŸ”º</h2><p>é€šè¿‡ä¸‹é¢ä½¿ç”¨ä¸åŒçš„planneråˆ›å»ºè¡¨ç¯å¢ƒæ•‘æ©é‚£ä¸ªç†è§£1ï¼Œ2ç‚¹çš„ä¸åŒã€‚ï¼ˆçœŸæ­£å®ç°æµæ‰¹ç»Ÿä¸€ï¼‰</p><h3 id="é»˜è®¤ğŸ”º"><a href="#é»˜è®¤ğŸ”º" class="headerlink" title="é»˜è®¤ğŸ”º"></a>é»˜è®¤ğŸ”º</h3><p>1.10é»˜è®¤plannerï¼Œ1.11ä»¥åŠä»¥åé»˜è®¤blinkã€‚</p><p>åˆ›å»ºè¡¨ç¯å¢ƒæœ€ç®€å•çš„æ–¹å¼ï¼Œå°±æ˜¯åŸºäºæµå¤„ç†æ‰§è¡Œç¯å¢ƒï¼Œè°ƒcreateæ–¹æ³•ç›´æ¥åˆ›å»ºï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line"><span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶åˆ›å»ºå‡ºæ¥çš„æ˜¯æµå¤„ç†çš„ç¯å¢ƒ</p><blockquote><p>æˆ‘ä½¿ç”¨çš„ç‰ˆæœ¬æ˜¯1.12.0ï¼ˆflinkï¼‰</p></blockquote><h3 id="planner"><a href="#planner" class="headerlink" title="planner"></a>planner</h3><p>ä¸»è¦åŸºäº<code>def create(executionEnvironment : org.apache.flink.streaming.api.scala.StreamExecutionEnvironment, settings : org.apache.flink.table.api.EnvironmentSettings) : org.apache.flink.table.api.bridge.scala.StreamTableEnvironment</code>æ–¹æ³•</p><h4 id="æ‰¹å¤„ç†ç¯å¢ƒ"><a href="#æ‰¹å¤„ç†ç¯å¢ƒ" class="headerlink" title="æ‰¹å¤„ç†ç¯å¢ƒ"></a>æ‰¹å¤„ç†ç¯å¢ƒ</h4><p>åŸºäºè€ç‰ˆæœ¬çš„æ‰¹å¤„ç†ï¼Œå› ä¸ºè€ç‰ˆæœ¬ä¸æ˜¯æµæ‰¹ç»Ÿä¸€ï¼Œæ‰€ä»¥åˆ›å»ºæ‰¹å¤„ç†ç¯å¢ƒä¸å¾—ä½¿ç”¨<code>StreamTableEnvironment</code>ã€‚è€Œä¸”å®ƒçš„å‚æ•°ä¹Ÿä¸èƒ½æ˜¯æµå¤„ç†çš„ç¯å¢ƒ<code>StreamExecutionEnvironment</code>ï¼Œå¾—æ˜¯æ‰¹å¤„ç†çš„ç¯å¢ƒï¼š<code>ExecutionEnvironment</code></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">TableEnvCreate</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> batchEnv: <span class="type">ExecutionEnvironment</span> = <span class="type">ExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    <span class="keyword">val</span> batchTableEnv: <span class="type">BatchTableEnvironment</span> = <span class="type">BatchTableEnvironment</span>.create(batchEnv)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æµå¤„ç†ç¯å¢ƒ"><a href="#æµå¤„ç†ç¯å¢ƒ" class="headerlink" title="æµå¤„ç†ç¯å¢ƒ"></a>æµå¤„ç†ç¯å¢ƒ</h4><p>åŸºäºè€ç‰ˆæœ¬çš„æµå¤„ç†</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">TableEnvCreate</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    </span><br><span class="line">   </span><br><span class="line">    <span class="keyword">val</span> settings: <span class="type">EnvironmentSettings</span> = <span class="type">EnvironmentSettings</span>.newInstance()</span><br><span class="line">      .useOldPlanner()</span><br><span class="line">      .inStreamingMode()</span><br><span class="line">      .build()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> environment: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env, settings)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="blinkğŸ”º"><a href="#blinkğŸ”º" class="headerlink" title="blinkğŸ”º"></a>blinkğŸ”º</h3><h4 id="æ‰¹å¤„ç†ç¯å¢ƒ-1"><a href="#æ‰¹å¤„ç†ç¯å¢ƒ-1" class="headerlink" title="æ‰¹å¤„ç†ç¯å¢ƒ"></a>æ‰¹å¤„ç†ç¯å¢ƒ</h4><p>å› ä¸ºFlinkçš„blink planneræ˜¯æµæ‰¹ç»Ÿä¸€çš„ï¼Œæ‰€ä»¥å®ƒä¸éœ€è¦ä½¿ç”¨<code>BatchTableEnvironment</code>æ¥åˆ›å»ºç¯å¢ƒï¼Œå®ƒåªéœ€è¦é€šè¿‡ç»Ÿä¸€çš„ç¯å¢ƒ<code>TableEnvironment</code>æ¥åˆ›å»ºï¼Œåªéœ€è¦å°†å‚æ•°å£°æ˜ä¸ºæµå¤„ç†è¿˜æ˜¯æ‰¹å¤„ç†å³å¯</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">TableEnvCreate</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> settings: <span class="type">EnvironmentSettings</span> = <span class="type">EnvironmentSettings</span>.newInstance()</span><br><span class="line">      .useBlinkPlanner()</span><br><span class="line">      .inBatchMode()</span><br><span class="line">      .build()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> environment: <span class="type">TableEnvironment</span> = <span class="type">TableEnvironment</span>.create(settings)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="æµå¤„ç†ç¯å¢ƒ-1"><a href="#æµå¤„ç†ç¯å¢ƒ-1" class="headerlink" title="æµå¤„ç†ç¯å¢ƒ"></a>æµå¤„ç†ç¯å¢ƒ</h4><p>åŸºäºæ–°ç‰ˆæœ¬çš„æµå¤„ç†</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">TableEnvCreate</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> settings: <span class="type">EnvironmentSettings</span> = <span class="type">EnvironmentSettings</span>.newInstance()</span><br><span class="line">      .useBlinkPlanner()</span><br><span class="line">      .inStreamingMode()</span><br><span class="line">      .build()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> environment: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env, settings)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åŸºæœ¬ç¨‹åºç»“æ„"><a href="#åŸºæœ¬ç¨‹åºç»“æ„" class="headerlink" title="åŸºæœ¬ç¨‹åºç»“æ„"></a>åŸºæœ¬ç¨‹åºç»“æ„</h2><p>Table API å’Œ SQL çš„ç¨‹åºç»“æ„ï¼Œä¸æµå¼å¤„ç†çš„ç¨‹åºç»“æ„ç±»ä¼¼ï¼›ä¹Ÿå¯ä»¥è¿‘ä¼¼åœ°è®¤ä¸ºæœ‰è¿™ä¹ˆå‡ æ­¥ï¼šé¦–å…ˆåˆ›å»ºæ‰§è¡Œç¯å¢ƒï¼Œç„¶åå®šä¹‰sourceã€transformå’Œsinkã€‚</p><p>å…·ä½“æ“ä½œæµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> tableEnv = ...  <span class="comment">// åˆ›å»ºè¡¨çš„æ‰§è¡Œç¯å¢ƒ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€å¼ è¡¨ï¼Œç”¨äºè¯»å–æ•°æ®</span></span><br><span class="line">tableEnv.connect(...).createTemporaryTable(<span class="string">&quot;inputTable&quot;</span>)</span><br><span class="line"><span class="comment">// æ³¨å†Œä¸€å¼ è¡¨ï¼Œç”¨äºæŠŠè®¡ç®—ç»“æœè¾“å‡º</span></span><br><span class="line">tableEnv.connect(...).createTemporaryTable(<span class="string">&quot;outputTable&quot;</span>)</span><br><span class="line"><span class="comment">// é€šè¿‡ Table API æŸ¥è¯¢ç®—å­ï¼Œå¾—åˆ°ä¸€å¼ ç»“æœè¡¨</span></span><br><span class="line"><span class="keyword">val</span> result = tableEnv.from(<span class="string">&quot;inputTable&quot;</span>).select(...)</span><br><span class="line"><span class="comment">// é€šè¿‡ SQLæŸ¥è¯¢è¯­å¥ï¼Œå¾—åˆ°ä¸€å¼ ç»“æœè¡¨</span></span><br><span class="line"><span class="keyword">val</span> sqlResult  = tableEnv.sqlQuery(<span class="string">&quot;SELECT ... FROM inputTable ...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†ç»“æœè¡¨å†™å…¥è¾“å‡ºè¡¨ä¸­</span></span><br><span class="line">result.insertInto(<span class="string">&quot;outputTable&quot;</span>)</span><br></pre></td></tr></table></figure><ol><li>åˆ›å»ºè¡¨æ‰§è¡Œç¯å¢ƒ</li><li>åˆ›å»ºä¸€å¼ è¡¨ï¼Œç”¨äºè¯»å–æ•°æ®</li><li>æ³¨å†Œä¸€å¼ è¡¨ï¼Œç”¨äºæŠŠè®¡ç®—ç»“æœè¾“å‡º</li><li>é€šè¿‡ Table API æŸ¥è¯¢ç®—å­ï¼Œå¾—åˆ°ä¸€å¼ ç»“æœè¡¨ || é€šè¿‡ SQLæŸ¥è¯¢è¯­å¥ï¼Œå¾—åˆ°ä¸€å¼ ç»“æœè¡¨</li><li>å°†ç»“æœè¡¨å†™å…¥è¾“å‡ºè¡¨ä¸­</li></ol><blockquote><p>å¦‚æœä½¿ç”¨Table APIçš„è¯ï¼Œå¿…é¡»å¾—é€šè¿‡envåˆ›å»ºä¸€ä¸ªTableç±»å‹çš„å¯¹è±¡ï¼Œé€šè¿‡å…¶æ‰èƒ½æ‰§è¡ŒAPIæ“ä½œ</p><p>å¦‚æœä½¿ç”¨SQLå¯¹è±¡çš„è¯ï¼Œå¿…é¡»é€šè¿‡envåˆ›å»º<code>createTemporaryTable</code>ä¸´æ—¶è¡¨åˆ°ç¯å¢ƒä¸­ï¼Œæ‰èƒ½ä½¿ç”¨SQLå¼€å§‹è®¡ç®—</p></blockquote><h2 id="åœ¨-Catalog-ä¸­æ³¨å†Œè¡¨"><a href="#åœ¨-Catalog-ä¸­æ³¨å†Œè¡¨" class="headerlink" title="åœ¨ Catalog ä¸­æ³¨å†Œè¡¨"></a>åœ¨ Catalog ä¸­æ³¨å†Œè¡¨</h2><h3 id="è¡¨ï¼ˆTableï¼‰çš„æ¦‚å¿µ"><a href="#è¡¨ï¼ˆTableï¼‰çš„æ¦‚å¿µ" class="headerlink" title="è¡¨ï¼ˆTableï¼‰çš„æ¦‚å¿µ"></a>è¡¨ï¼ˆTableï¼‰çš„æ¦‚å¿µ</h3><p>TableEnvironment å¯ä»¥æ³¨å†Œç›®å½• Catalogï¼Œå¹¶å¯ä»¥åŸºäº Catalog æ³¨å†Œè¡¨ã€‚å®ƒä¼šç»´æŠ¤ä¸€ä¸ª Catalog-Table è¡¨ä¹‹é—´çš„ mapã€‚</p><p>è¡¨ï¼ˆTableï¼‰æ˜¯ç”±ä¸€ä¸ªâ€œæ ‡è¯†ç¬¦â€æ¥æŒ‡å®šçš„ï¼Œç”± 3 éƒ¨åˆ†ç»„æˆï¼š<strong>Catalog åã€æ•°æ®åº“ï¼ˆdatabaseï¼‰ åå’Œå¯¹è±¡åï¼ˆè¡¨åï¼‰</strong>ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šç›®å½•æˆ–æ•°æ®åº“ï¼Œå°±ä½¿ç”¨å½“å‰çš„é»˜è®¤å€¼ã€‚</p><p>è¡¨å¯ä»¥æ˜¯å¸¸è§„çš„ï¼ˆTableï¼Œè¡¨ï¼‰ï¼Œæˆ–è€…è™šæ‹Ÿçš„ï¼ˆViewï¼Œè§†å›¾ï¼‰ã€‚</p><ul><li>å¸¸è§„è¡¨ï¼ˆTableï¼‰ä¸€èˆ¬å¯ä»¥ ç”¨æ¥æè¿°å¤–éƒ¨æ•°æ®ï¼Œæ¯”å¦‚æ–‡ä»¶ã€æ•°æ®åº“è¡¨æˆ–æ¶ˆæ¯é˜Ÿåˆ—çš„æ•°æ®ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä» DataStream è½¬ æ¢è€Œæ¥ã€‚ï¼ˆç”¨äºSourceã€Sinkçš„è¡¨ï¼‰</li><li>è§†å›¾å¯ä»¥ä»ç°æœ‰çš„è¡¨ä¸­åˆ›å»ºï¼Œé€šå¸¸æ˜¯ table API æˆ–è€… SQL æŸ¥è¯¢çš„ä¸€ä¸ªç»“æœï¼ˆ<code>createTemporaryTable</code>ï¼‰</li></ul><h3 id="åˆ›å»ºè¡¨ğŸ”º"><a href="#åˆ›å»ºè¡¨ğŸ”º" class="headerlink" title="åˆ›å»ºè¡¨ğŸ”º"></a>åˆ›å»ºè¡¨ğŸ”º</h3><h4 id="å¤–éƒ¨ç³»ç»Ÿåˆ›å»º"><a href="#å¤–éƒ¨ç³»ç»Ÿåˆ›å»º" class="headerlink" title="å¤–éƒ¨ç³»ç»Ÿåˆ›å»º"></a>å¤–éƒ¨ç³»ç»Ÿåˆ›å»º</h4><p>ç°åœ¨1.12æ–¹æ³•<code>connect</code>å¥½åƒå·²ç»è¢«åºŸå¼ƒï¼Œä½†æ˜¯è¿˜èƒ½ç”¨ã€‚</p><p>æºç ä¸­éå¸¸æ¸…æ™°çš„å‘Šè¯‰æˆ‘ä»¬åº”è¯¥ä½¿ç”¨CREATE TABLE DDLæ¥æ„å»ºSOURCE TABLEã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¼˜å…ˆä½¿ç”¨DDLæ–¹å¼æ¥æ„å»ºTABLEã€‚è€Œä¸”ï¼Œå®˜æ–¹çš„å„ç§APIå¼€å§‹éƒ½æ˜¯ä»¥DDLæ¥æ„å»ºäº†ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110142836238.png" alt="image-20210110142836238"></p><p>å…·ä½“ä½¿ç”¨æ–¹æ³•è¯·æŸ¥çœ‹å®˜æ–¹ï¼š<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/filesystem.html">Apache Flink 1.12 Documentation: FileSystem SQL Connector</a></p><hr><p><del>ç›´æ¥è°ƒç”¨ tableEnv.connect()å°±å¯ä»¥ï¼Œé‡Œé¢å‚æ•°è¦ä¼  å…¥ä¸€ä¸ª ConnectorDescriptorï¼Œä¹Ÿå°±æ˜¯ connector æè¿°å™¨ã€‚å¯¹äºæ–‡ä»¶ç³»ç»Ÿçš„ connector è€Œè¨€ï¼Œflink å†…éƒ¨å·²ç»æä¾›äº†ï¼Œå°±å«åš FileSystem()ã€‚å¹¶è°ƒç”¨<code>createTemporaryTable</code>æ–¹æ³•ï¼Œåœ¨Catalogæ³¨å†Œè¡¨</del></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110141247564.png" alt="image-20210110141247564"></p><h5 id="æ–‡ä»¶ç³»ç»Ÿ"><a href="#æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="æ–‡ä»¶ç³»ç»Ÿ"></a>æ–‡ä»¶ç³»ç»Ÿ</h5><p><strong>ä¸¾ä¾‹ï¼Œè¯»å–æœ¬åœ°æ–‡ä»¶ç³»ç»ŸCSVæ ¼å¼æ–‡ä»¶</strong></p><p>éœ€è¦é¢å¤–å¯¼å…¥åŒ…</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-csv<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.table</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.<span class="type">Expressions</span>.$</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.<span class="type">Table</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.bridge.scala.<span class="type">StreamTableEnvironment</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">FromFileSystemByDdl</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileSystemSql: <span class="type">String</span> = <span class="string">&quot;CREATE TABLE fs_table &quot;</span> +</span><br><span class="line">      <span class="string">&quot;(id STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot; ts STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;  temp DOUBLE) &quot;</span> +</span><br><span class="line">      <span class="string">&quot; WITH (&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;connector&#x27;=&#x27;filesystem&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;path&#x27;=&#x27;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;format&#x27;=&#x27;csv&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//    å¯ä»¥ä½¿ç”¨ TableEnvironment ä¸­çš„ executeSql() æ–¹æ³•æ‰§è¡Œ CREATE è¯­å¥ã€‚ è‹¥ CREATE æ“ä½œæ‰§è¡ŒæˆåŠŸï¼ŒexecuteSql() æ–¹æ³•è¿”å› â€˜OKâ€™ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    ä»¥ä¸‹çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•åœ¨ TableEnvironment ä¸­æ‰§è¡Œä¸€ä¸ª CREATE è¯­å¥ã€‚</span></span><br><span class="line">    tableEnv.executeSql(fileSystemSql)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tableå¯¹è±¡æ²¡æœ‰æ–¹æ³•toAppendStreamçš„ï¼Œ åªæœ‰é€šè¿‡å¯¼å…¥éšå¼è½¬æ¢çš„åŒ…æ‰å¯ä»¥å®ç°æ­¤åŠŸèƒ½</span></span><br><span class="line">    <span class="keyword">import</span> org.apache.flink.table.api.bridge.scala.tableConversions</span><br><span class="line">    <span class="comment">// SQLå½¢å¼</span></span><br><span class="line">    tableEnv.sqlQuery(<span class="string">&quot;select * from fs_table&quot;</span>).toAppendStream[(<span class="type">String</span>, <span class="type">String</span>, <span class="type">Double</span>)].print()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Table APIå½¢å¼</span></span><br><span class="line">    <span class="keyword">val</span> table: <span class="type">Table</span> = tableEnv.from(<span class="string">&quot;fs_table&quot;</span>)</span><br><span class="line">    table.select($(<span class="string">&quot;id&quot;</span>), $(<span class="string">&quot;ts&quot;</span>), $(<span class="string">&quot;temp&quot;</span>)).toAppendStream[(<span class="type">String</span>, <span class="type">String</span>, <span class="type">Double</span>)].print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p><strong>éœ€è¦æ³¨æ„çš„ç‚¹</strong></p><ol><li>ä½¿ç”¨ TableEnvironment ä¸­çš„ executeSql() æ–¹æ³•æ‰§è¡Œ CREATE è¯­å¥ã€‚ è‹¥ CREATE æ“ä½œæ‰§è¡ŒæˆåŠŸï¼ŒexecuteSql() æ–¹æ³•è¿”å› â€˜OKâ€™ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</li><li>åœ¨è®¡ç®—Tableè¾“å‡ºæ—¶ï¼Œ<strong>Tableæ²¡æœ‰æ‰“å°åˆ°æ§åˆ¶å°çš„æ–¹æ³•ï¼Œå¿…é¡»è½¬æ¢ä¸ºæµæ‰èƒ½è¾“å‡º</strong></li><li>Tableå¯¹è±¡æ²¡æœ‰æ–¹æ³•toAppendStreamçš„ï¼Œ åªæœ‰é€šè¿‡å¯¼å…¥éšå¼è½¬æ¢çš„åŒ…æ‰å¯ä»¥å®ç°æ­¤åŠŸèƒ½</li><li>Table APIå·²ç»ä¸çŸ¥é“å‚æ•°ä¸ºStringçš„æ–¹æ³•ï¼Œéœ€è¦é€šè¿‡<code>($(&quot;id&quot;)</code>å½¢å¼ä½¿ç”¨</li></ol></blockquote><h4 id="DataStreamè½¬æ¢"><a href="#DataStreamè½¬æ¢" class="headerlink" title="DataStreamè½¬æ¢"></a>DataStreamè½¬æ¢</h4><p>ä¸€èˆ¬éƒ½é€šè¿‡DATa Streamè½¬æ¢è€Œæ¥ï¼š</p><p>åŒ…ä¸è¦åˆ°å¯¼é”™</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.&#123;<span class="type">DataStream</span>, <span class="type">StreamExecutionEnvironment</span>, createTypeInformation&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.<span class="type">Expressions</span>.$</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.<span class="type">Table</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.bridge.scala._</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">FromDataStreamByFileSystem</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–æµï¼Œæœ¬åœ°æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">val</span> inputStream: <span class="type">DataStream</span>[(<span class="type">String</span>, <span class="type">String</span>, <span class="type">String</span>)] = env.readTextFile(<span class="string">&quot;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&quot;</span>, <span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">      .map(r =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> strings: <span class="type">Array</span>[<span class="type">String</span>] = r.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        (strings(<span class="number">0</span>), strings(<span class="number">1</span>), strings(<span class="number">2</span>))</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æµè½¬æ¢ä¸ºè¡¨</span></span><br><span class="line">    <span class="keyword">val</span> inputTable: <span class="type">Table</span> = tableEnv.fromDataStream(inputStream, $(<span class="string">&quot;id&quot;</span>), $(<span class="string">&quot;ts&quot;</span>), $(<span class="string">&quot;temp&quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sql,å¿…é¡»åœ¨ç¯å¢ƒä¸­åˆ›å»ºäº†è¡¨ä¹‹åæ‰èƒ½ç”¨</span></span><br><span class="line">    tableEnv.createTemporaryView(<span class="string">&quot;myTable&quot;</span>, inputTable)</span><br><span class="line">    tableEnv.sqlQuery(<span class="string">&quot;select * from myTable&quot;</span>)</span><br><span class="line">        .toAppendStream[(<span class="type">String</span>, <span class="type">String</span>, <span class="type">String</span>)].print(<span class="string">&quot;sql&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// table api</span></span><br><span class="line">    inputTable.select($(<span class="string">&quot;id&quot;</span>), $(<span class="string">&quot;ts&quot;</span>), $(<span class="string">&quot;temp&quot;</span>)).toAppendStream[(<span class="type">String</span>, <span class="type">String</span>, <span class="type">String</span>)].print(<span class="string">&quot;tableApi&quot;</span>)</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>æ•°æ®ç±»å‹å’ŒSchemaçš„å¯¹åº”å…³ç³»</em></p><p>åŸºäºä½ç½®ï¼š</p><p><code> tableEnv.fromDataStream(inputStream, $(&quot;id&quot;), $(&quot;ts&quot;), $(&quot;temp&quot;))</code></p><h3 id="åˆ›å»ºä¸´æ—¶è§†å›¾"><a href="#åˆ›å»ºä¸´æ—¶è§†å›¾" class="headerlink" title="åˆ›å»ºä¸´æ—¶è§†å›¾"></a>åˆ›å»ºä¸´æ—¶è§†å›¾</h3><p><strong>åŸºäºDataStream</strong></p><p><code>def createTemporaryView[T](path : scala.Predef.String, dataStream : org.apache.flink.streaming.api.scala.DataStream[T]) : scala.Unit</code></p><p><strong>åŸºäºè¡¨</strong></p><p><code>void createTemporaryView(String path, Table view);</code></p><h3 id="è¾“å‡ºè¡¨ğŸ”º"><a href="#è¾“å‡ºè¡¨ğŸ”º" class="headerlink" title="è¾“å‡ºè¡¨ğŸ”º"></a>è¾“å‡ºè¡¨ğŸ”º</h3><p>å¯¹äºç»‘å®šå¤–éƒ¨ç³»ç»Ÿçš„ä¸¤ä¸ªè¡¨è¿›è¡Œä¸€ä¸‹æ“ä½œå³å¯è¾“å‡ºï¼š</p><p><code>inputTable.executeInsert(&quot;table_other&quot;)</code></p><p>ä½†æ˜¯å»ºè®®ä»¥ä¸‹é¢çš„æµç¨‹è¾“å‡ºï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110161619800.png" alt="image-20210110161619800"></p><h1 id="æ›´æ–°æ¨¡å¼ğŸ”º"><a href="#æ›´æ–°æ¨¡å¼ğŸ”º" class="headerlink" title="æ›´æ–°æ¨¡å¼ğŸ”º"></a>æ›´æ–°æ¨¡å¼ğŸ”º</h1><p>åœ¨æµå¤„ç†è¿‡ç¨‹ä¸­ï¼Œè¡¨çš„å¤„ç†å¹¶ä¸åƒä¼ ç»Ÿå®šä¹‰çš„é‚£æ ·ç®€å•ã€‚ç”±ä¸Šé¢çš„æè¿°å¯çŸ¥Tableå¯¹è±¡å¹¶æ²¡æœ‰è¾“å‡ºåˆ°æ§åˆ¶å°çš„æ–¹æ³•ï¼Œå®ƒåªèƒ½é€šè¿‡è½¬æ¢ä¸ºæµæ‰å¯ä»¥è¾“å‡ºåˆ°æ§åˆ¶å°ã€‚</p><p>å¯¹äºæµå¼æŸ¥è¯¢ï¼ˆStreaming Queriesï¼‰ï¼Œéœ€è¦å£°æ˜å¦‚ä½•åœ¨ï¼ˆåŠ¨æ€ï¼‰è¡¨å’Œå¤–éƒ¨è¿æ¥å™¨ä¹‹é—´æ‰§è¡Œè½¬æ¢ã€‚ä¸å¤–éƒ¨ç³»ç»Ÿäº¤æ¢çš„æ¶ˆæ¯ç±»å‹ï¼Œç”±æ›´æ–°æ¨¡å¼ï¼ˆupdate modeï¼‰æŒ‡å®šã€‚</p><p><strong>Flink Table APIä¸­çš„æ›´æ–°æ¨¡å¼æœ‰ä»¥ä¸‹ä¸‰ç§ï¼š</strong></p><ol><li>è¿½åŠ æ¨¡å¼ï¼ˆAppend Modeï¼‰ï¼šåœ¨è¿½åŠ æ¨¡å¼ä¸‹ï¼Œè¡¨ï¼ˆåŠ¨æ€è¡¨ï¼‰å’Œå¤–éƒ¨è¿æ¥å™¨åªäº¤æ¢æ’å…¥ï¼ˆInsertï¼‰æ¶ˆæ¯ã€‚å³ï¼Œtableçš„ä¸€æ¡ä¿¡æ¯å‘é€åå°±ä¸ä¼šæ›´å˜</li><li>æ’¤å›æ¨¡å¼ï¼ˆRetract Modeï¼‰ï¼šåœ¨æ’¤å›æ¨¡å¼ä¸‹ï¼Œè¡¨å’Œå¤–éƒ¨è¿æ¥å™¨äº¤æ¢çš„æ˜¯ï¼šæ·»åŠ ï¼ˆAddï¼‰å’Œæ’¤å›ï¼ˆRetractï¼‰æ¶ˆæ¯ã€‚å³ï¼šä¸€èˆ¬èšåˆæ“ä½œæ—¶ï¼ˆæœªå¼€çª—æ—¶ï¼‰æ˜¯ä¸€æ¡è®°å½•æ¥äº†å°±èšåˆä¸€æ¬¡ï¼Œå½“å†æ¬¡æ¥ä¸€ä¸ªå·²ç»èšåˆè¿‡çš„æ•°æ®æ—¶å°±ä¼šå¯¹ä»¥å‰çš„æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œè€Œå®ƒæ˜¯é€šè¿‡æ’¤å›ä¹‹å‰çš„ç»“æœå’Œæ’å…¥æœ€æ–°çš„ç»“æœå®ç°æœ€æ–°çš„èšåˆç»“æœçš„ã€‚</li><li>Upsertï¼ˆæ›´æ–°æ’å…¥ï¼‰æ¨¡å¼ï¼šåœ¨Upsertæ¨¡å¼ä¸‹ï¼ŒåŠ¨æ€è¡¨å’Œå¤–éƒ¨è¿æ¥å™¨äº¤æ¢Upsertå’ŒDeleteæ¶ˆæ¯ã€‚</li></ol><p><em>Upsertæ¨¡å¼</em></p><p>è¿™ä¸ªæ¨¡å¼éœ€è¦ä¸€ä¸ªå”¯ä¸€çš„keyï¼Œé€šè¿‡è¿™ä¸ªkeyå¯ä»¥ä¼ é€’æ›´æ–°æ¶ˆæ¯ã€‚ä¸ºäº†æ­£ç¡®åº”ç”¨æ¶ˆæ¯ï¼Œå¤–éƒ¨è¿æ¥å™¨éœ€è¦çŸ¥é“è¿™ä¸ªå”¯ä¸€keyçš„å±æ€§</p><p>å³ï¼šä¸€èˆ¬èšåˆæ“ä½œæ—¶ï¼ˆæœªå¼€çª—æ—¶ï¼‰æ˜¯ä¸€æ¡è®°å½•æ¥äº†å°±èšåˆä¸€æ¬¡ï¼Œå½“å†æ¬¡æ¥ä¸€ä¸ªå·²ç»èšåˆè¿‡çš„æ•°æ®æ—¶å°±ä¼šå¯¹ä»¥å‰çš„æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œè€Œå®ƒæ˜¯é€šè¿‡keyå”¯ä¸€ç¡®å®šæ˜¯æ›´æ–°è¿˜æ˜¯æ’å…¥çš„ï¼›è¿˜èƒ½åˆ é™¤ï¼ˆDeleteï¼‰ç¼–ç ä¸ºDeleteä¿¡æ¯ã€‚</p><hr><p>å„ä¸ªæ¨¡å¼æ”¯æŒçš„å¤–éƒ¨ç³»ç»Ÿï¼š</p><ol><li>è¿½åŠ æ¨¡å¼ï¼ˆAppend Modeï¼‰ï¼šæ§åˆ¶å°ã€æ–‡ä»¶ã€DBã€Redisã€ElasticSearch</li><li>æ’¤å›æ¨¡å¼ï¼ˆRetract Modeï¼‰ï¼šæ§åˆ¶å°ã€DBã€Redisã€ElasticSearch</li><li>Upsertï¼ˆæ›´æ–°æ’å…¥ï¼‰æ¨¡å¼ï¼šæ§åˆ¶å°ã€DBã€Redisã€ElasticSearch</li></ol><h2 id="å°†è¡¨è½¬ä¸ºDataStream"><a href="#å°†è¡¨è½¬ä¸ºDataStream" class="headerlink" title="å°†è¡¨è½¬ä¸ºDataStream"></a>å°†è¡¨è½¬ä¸ºDataStream</h2><p>æ­¤æ—¶å°±éœ€è¦æ ¹æ®Tableçš„æ“ä½œæ¥é€‰æ‹©ä¸åŒçš„æ›´æ–°æ¨¡å¼</p><p>Table APIä¸­è¡¨åˆ°DataStreamæœ‰ä¸¤ç§æ¨¡å¼ï¼š</p><ol><li>è¿½åŠ æ¨¡å¼ï¼ˆAppend Modeï¼‰</li><li>æ’¤å›æ¨¡å¼ï¼ˆRetract Modeï¼‰<ol><li>å¾—åˆ°çš„æ•°æ®ä¼šå¢åŠ ä¸€ä¸ªBooleanç±»å‹çš„æ ‡è¯†ä½ï¼ˆè¿”å›çš„ç¬¬ä¸€ä¸ªå­—æ®µï¼‰ï¼Œç”¨å®ƒæ¥è¡¨ç¤ºåˆ°åº•æ˜¯æ–°å¢çš„æ•°æ®ï¼ˆInsertï¼‰ï¼Œè¿˜æ˜¯è¢«åˆ é™¤çš„æ•°æ®ï¼ˆè€æ•°æ®ï¼ŒDeleteï¼‰ã€‚</li></ol></li></ol><blockquote><p>åœ¨ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦ä½¿ç”¨æ’¤å›æ¨¡å¼ï¼ˆRetract Modeï¼‰</p><p>ä¸€èˆ¬èšåˆæ“ä½œæ—¶ï¼ˆæœªå¼€çª—æ—¶ï¼‰æ˜¯ä¸€æ¡è®°å½•æ¥äº†å°±èšåˆä¸€æ¬¡ï¼Œå½“å†æ¬¡æ¥ä¸€ä¸ªå·²ç»èšåˆè¿‡çš„æ•°æ®æ—¶å°±ä¼šå¯¹ä»¥å‰çš„æ•°æ®è¿›è¡Œæ›´æ–°</p><p>æ‰€ä»¥æ’¤å›æ¨¡å¼ï¼ˆRetract Modeï¼‰æ˜¯é€šè¿‡æ’¤å›ä¹‹å‰çš„ç»“æœå’Œæ’å…¥æœ€æ–°çš„ç»“æœå®ç°æœ€æ–°çš„èšåˆç»“æœçš„ã€‚</p><p>è€Œæ­¤æ—¶è¿½åŠ æ¨¡å¼ï¼ˆAppend Modeï¼‰åªèƒ½æ·»åŠ ä¸èƒ½æ›´æ”¹ï¼Œæ‰€ä»¥ä¸é€‚åˆæ²¡æœ‰å¼€çª—çš„èšåˆæƒ…å†µçš„</p><p>ä½†æ˜¯ä¸ºä»€ä¹ˆè¦åˆ¶å®šæ²¡æœ‰å¼€çª—ï¼Ÿ</p><p><font color="red">å› ä¸ºæ²¡æœ‰å¼€çª—æ˜¯æ¥ä¸€æ¡èšåˆä¸€æ¡çš„ï¼Œè€Œå¼€çª—æ˜¯æ¥ä¸€æ¡èšåˆä¸€æ¡ï¼Œä½†æ˜¯å¼€åˆ›ç»“æŸåæ‰å¼€å§‹å†™å…¥æµï¼Œæ‰€ä»¥å†™å…¥çš„æµçš„æ•°æ®ä¹Ÿä¸ä¼šå˜ï¼Œæ‰€ä»¥è¿™æ—¶å€™æ”¯æŒè¿½åŠ æ¨¡å¼ï¼ˆAppend Modeï¼‰</font></p></blockquote><p>ä¾‹å­è¯æ˜ï¼š</p><ol><li>æ²¡æœ‰èšåˆæ“ä½œçš„ä½¿ç”¨è¿½åŠ æ¨¡å¼ï¼ˆAppend Modeï¼‰è½¬ä¸º<code>toAppendStream</code></li><li>æœ‰èšåˆæ“ä½œçš„ä½¿ç”¨è¿½åŠ æ¨¡å¼ï¼ˆAppend Modeï¼‰è½¬ä¸º<code>toAppendStream</code>ï¼Œé”™è¯¯</li><li>æœ‰èšåˆæ“ä½œçš„ä½¿ç”¨æ’¤å›æ¨¡å¼ï¼ˆRetract Modeï¼‰è½¬ä¸º<code>toRetractStream</code>ï¼Œæ­£ç¡®</li></ol><p><strong>1.</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">FromDataStreamByFileSystem</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–æµï¼Œæœ¬åœ°æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">val</span> inputStream: <span class="type">DataStream</span>[(<span class="type">String</span>, <span class="type">String</span>, <span class="type">String</span>)] = env.readTextFile(<span class="string">&quot;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&quot;</span>, <span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">      .map(r =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> strings: <span class="type">Array</span>[<span class="type">String</span>] = r.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        (strings(<span class="number">0</span>), strings(<span class="number">1</span>), strings(<span class="number">2</span>))</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æµè½¬æ¢ä¸ºè¡¨</span></span><br><span class="line">    <span class="keyword">val</span> inputTable: <span class="type">Table</span> = tableEnv.fromDataStream(inputStream, $(<span class="string">&quot;id&quot;</span>), $(<span class="string">&quot;ts&quot;</span>), $(<span class="string">&quot;temp&quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sql,å¿…é¡»åœ¨ç¯å¢ƒä¸­åˆ›å»ºäº†è¡¨ä¹‹åæ‰èƒ½ç”¨</span></span><br><span class="line">    tableEnv.createTemporaryView(<span class="string">&quot;myTable&quot;</span>, inputTable)</span><br><span class="line">    tableEnv.sqlQuery(<span class="string">&quot;select * from myTable&quot;</span>)</span><br><span class="line">        .toAppendStream[(<span class="type">String</span>, <span class="type">String</span>, <span class="type">String</span>)].print(<span class="string">&quot;sql&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// table api</span></span><br><span class="line">    inputTable.select($(<span class="string">&quot;id&quot;</span>), $(<span class="string">&quot;ts&quot;</span>), $(<span class="string">&quot;temp&quot;</span>)).toAppendStream[(<span class="type">String</span>, <span class="type">String</span>, <span class="type">String</span>)].print(<span class="string">&quot;tableApi&quot;</span>)</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2.</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">CountExample</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileSystemSql: <span class="type">String</span> = <span class="string">&quot;CREATE TABLE fs_table &quot;</span> +</span><br><span class="line">      <span class="string">&quot;(id STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot; ts STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;  temp DOUBLE) &quot;</span> +</span><br><span class="line">      <span class="string">&quot; WITH (&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;connector&#x27;=&#x27;filesystem&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;path&#x27;=&#x27;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;format&#x27;=&#x27;csv&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//    å¯ä»¥ä½¿ç”¨ TableEnvironment ä¸­çš„ executeSql() æ–¹æ³•æ‰§è¡Œ CREATE è¯­å¥ã€‚ è‹¥ CREATE æ“ä½œæ‰§è¡ŒæˆåŠŸï¼ŒexecuteSql() æ–¹æ³•è¿”å› â€˜OKâ€™ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//    ä»¥ä¸‹çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•åœ¨ TableEnvironment ä¸­æ‰§è¡Œä¸€ä¸ª CREATE è¯­å¥ã€‚</span></span><br><span class="line">    tableEnv.executeSql(fileSystemSql)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tableå¯¹è±¡æ²¡æœ‰æ–¹æ³•toAppendStreamçš„ï¼Œ åªæœ‰é€šè¿‡å¯¼å…¥éšå¼è½¬æ¢çš„åŒ…æ‰å¯ä»¥å®ç°æ­¤åŠŸèƒ½</span></span><br><span class="line">    <span class="keyword">import</span> org.apache.flink.table.api.bridge.scala.tableConversions</span><br><span class="line">    <span class="comment">// SQLå½¢å¼</span></span><br><span class="line">    tableEnv.sqlQuery(<span class="string">&quot;select id,avg(temp) from fs_table group by id&quot;</span>).toAppendStream[(<span class="type">String</span>,</span><br><span class="line">      <span class="type">Double</span>)]</span><br><span class="line">      .print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110163624481.png" alt="image-20210110163624481"></p><blockquote><p>æ„æ€æ˜¯ï¼Œ<code>toAppendStream</code>ä¸æ”¯æŒupdateï¼Œæ‰€ä»¥å¾—ä½¿ç”¨<code>toRetractStream</code></p></blockquote><p><strong>3.</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">CountExample</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileSystemSql: <span class="type">String</span> = <span class="string">&quot;CREATE TABLE fs_table &quot;</span> +</span><br><span class="line">      <span class="string">&quot;(id STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot; ts STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;  temp DOUBLE) &quot;</span> +</span><br><span class="line">      <span class="string">&quot; WITH (&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;connector&#x27;=&#x27;filesystem&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;path&#x27;=&#x27;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;format&#x27;=&#x27;csv&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//    å¯ä»¥ä½¿ç”¨ TableEnvironment ä¸­çš„ executeSql() æ–¹æ³•æ‰§è¡Œ CREATE è¯­å¥ã€‚ è‹¥ CREATE æ“ä½œæ‰§è¡ŒæˆåŠŸï¼ŒexecuteSql() æ–¹æ³•è¿”å› â€˜OKâ€™ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//    ä»¥ä¸‹çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•åœ¨ TableEnvironment ä¸­æ‰§è¡Œä¸€ä¸ª CREATE è¯­å¥ã€‚</span></span><br><span class="line">    tableEnv.executeSql(fileSystemSql)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tableå¯¹è±¡æ²¡æœ‰æ–¹æ³•toAppendStreamçš„ï¼Œ åªæœ‰é€šè¿‡å¯¼å…¥éšå¼è½¬æ¢çš„åŒ…æ‰å¯ä»¥å®ç°æ­¤åŠŸèƒ½</span></span><br><span class="line">    <span class="keyword">import</span> org.apache.flink.table.api.bridge.scala.tableConversions</span><br><span class="line">    <span class="comment">// SQLå½¢å¼</span></span><br><span class="line">    tableEnv.sqlQuery(<span class="string">&quot;select id,avg(temp) from fs_table group by id&quot;</span>).toRetractStream[(<span class="type">String</span>,</span><br><span class="line">      <span class="type">Double</span>)]</span><br><span class="line">      .print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110163733258.png" alt="image-20210110163733258"></p><p>trueå’Œfalseä»£è¡¨æ˜¯æœ¬åˆ†ç»„çš„èšåˆæ˜¯ç¬¬ä¸€æ¬¡æ¥è¿˜æ˜¯ç¬¬næ¬¡æ¥</p><ol><li>ç¬¬ä¸€ä¸ªçº¢æ¡†ä»£è¡¨idä¸ºsensor1çš„æ•°æ®ç¬¬ä¸€ä¸ªèšåˆ</li><li>ç¬¬äºŒä¸ªçº¢æ¡†ä»£è¡¨idä¸ºsensor1çš„æ•°æ®ç¬¬äºŒæ¬¡èšåˆå‰æ’¤å›ä¹‹å‰çš„ç»“æœ</li><li>ç¬¬äºŒä¸ªçº¢æ¡†ä¸‹é¢çš„ç¬¬ä¸€ä¸ªæ•°æ®ä»£è¡¨idä¸ºsensor1çš„æ•°æ®ç¬¬äºŒæ¬¡èšåˆåçš„æ›´æ–°ç»“æœ</li></ol><h1 id="æµå¤„ç†ä¸­çš„ç‰¹æ®Šæ¦‚å¿µğŸ”º"><a href="#æµå¤„ç†ä¸­çš„ç‰¹æ®Šæ¦‚å¿µğŸ”º" class="headerlink" title="æµå¤„ç†ä¸­çš„ç‰¹æ®Šæ¦‚å¿µğŸ”º"></a>æµå¤„ç†ä¸­çš„ç‰¹æ®Šæ¦‚å¿µğŸ”º</h1><p>Table APIå’ŒSQLï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯åŸºäºå…³ç³»å‹è¡¨çš„æ“ä½œæ–¹å¼ï¼›è€Œå…³ç³»å‹è¡¨ã€å…³ç³»ä»£æ•°ï¼Œä»¥åŠSQLæœ¬èº«ï¼Œä¸€èˆ¬æ˜¯æœ‰ç•Œçš„ï¼Œæ›´é€‚åˆæ‰¹å¤„ç†çš„åœºæ™¯ã€‚è¿™å°±å¯¼è‡´åœ¨è¿›è¡Œæµå¤„ç†çš„è¿‡ç¨‹ä¸­ï¼Œç†è§£ä¼šç¨å¾®å¤æ‚ä¸€äº›ï¼Œéœ€è¦å¼•å…¥ä¸€äº›ç‰¹æ®Šæ¦‚å¿µã€‚</p><h2 id="æµå¤„ç†å’Œå…³ç³»ä»£æ•°ï¼ˆè¡¨ï¼ŒåŠ-SQLï¼‰çš„åŒºåˆ«"><a href="#æµå¤„ç†å’Œå…³ç³»ä»£æ•°ï¼ˆè¡¨ï¼ŒåŠ-SQLï¼‰çš„åŒºåˆ«" class="headerlink" title="æµå¤„ç†å’Œå…³ç³»ä»£æ•°ï¼ˆè¡¨ï¼ŒåŠ SQLï¼‰çš„åŒºåˆ«"></a>æµå¤„ç†å’Œå…³ç³»ä»£æ•°ï¼ˆè¡¨ï¼ŒåŠ SQLï¼‰çš„åŒºåˆ«</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110164925069.png" alt="image-20210110164925069"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå…¶å®å…³ç³»ä»£æ•°ï¼ˆä¸»è¦å°±æ˜¯æŒ‡å…³ç³»å‹æ•°æ®åº“ä¸­çš„è¡¨ï¼‰å’Œ SQLï¼Œä¸»è¦å°±æ˜¯é’ˆå¯¹æ‰¹ å¤„ç†çš„ï¼Œè¿™å’Œæµå¤„ç†æœ‰å¤©ç”Ÿçš„éš”é˜‚ã€‚</p><h2 id="åŠ¨æ€è¡¨ï¼ˆDynamic-Tablesï¼‰"><a href="#åŠ¨æ€è¡¨ï¼ˆDynamic-Tablesï¼‰" class="headerlink" title="åŠ¨æ€è¡¨ï¼ˆDynamic Tablesï¼‰"></a>åŠ¨æ€è¡¨ï¼ˆDynamic Tablesï¼‰</h2><p>å› ä¸ºæµå¤„ç†é¢å¯¹çš„æ•°æ®ï¼Œæ˜¯è¿ç»­ä¸æ–­çš„ï¼Œè¿™å’Œæˆ‘ä»¬ç†Ÿæ‚‰çš„å…³ç³»å‹æ•°æ®åº“ä¸­ä¿å­˜çš„â€œè¡¨â€ å®Œå…¨ä¸åŒã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬æŠŠæµæ•°æ®è½¬æ¢æˆ Tableï¼Œç„¶åæ‰§è¡Œç±»ä¼¼äº table çš„ select æ“ä½œï¼Œç»“ æœå°±ä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œè€Œæ˜¯éšç€æ–°æ•°æ®çš„åˆ°æ¥ï¼Œä¼šä¸åœæ›´æ–°ã€‚ </p><p>æˆ‘ä»¬å¯ä»¥éšç€æ–°æ•°æ®çš„åˆ°æ¥ï¼Œä¸åœåœ°åœ¨ä¹‹å‰çš„åŸºç¡€ä¸Šæ›´æ–°ç»“æœã€‚è¿™æ ·å¾—åˆ°çš„è¡¨ï¼Œåœ¨ Flink Table API æ¦‚å¿µé‡Œï¼Œå°±å«åš<strong>â€œåŠ¨æ€è¡¨â€ï¼ˆDynamic Tablesï¼‰</strong>ã€‚</p><p>åŠ¨æ€è¡¨æ˜¯ Flink å¯¹æµæ•°æ®çš„ Table API å’Œ SQL æ”¯æŒçš„æ ¸å¿ƒæ¦‚å¿µã€‚ä¸è¡¨ç¤ºæ‰¹å¤„ç†æ•°æ®çš„é™æ€ è¡¨ä¸åŒï¼ŒåŠ¨æ€è¡¨æ˜¯éšæ—¶é—´å˜åŒ–çš„ã€‚åŠ¨æ€è¡¨å¯ä»¥åƒé™æ€çš„æ‰¹å¤„ç†è¡¨ä¸€æ ·è¿›è¡ŒæŸ¥è¯¢ï¼ŒæŸ¥è¯¢ä¸€ä¸ªåŠ¨ æ€è¡¨ä¼šäº§ç”ŸæŒç»­æŸ¥è¯¢ï¼ˆContinuous Queryï¼‰ã€‚è¿ç»­æŸ¥è¯¢æ°¸è¿œä¸ä¼šç»ˆæ­¢ï¼Œå¹¶ä¼šç”Ÿæˆå¦ä¸€ä¸ªåŠ¨æ€è¡¨ã€‚ æŸ¥è¯¢ï¼ˆQueryï¼‰ä¼šä¸æ–­æ›´æ–°å…¶åŠ¨æ€ç»“æœè¡¨ï¼Œä»¥åæ˜ å…¶åŠ¨æ€è¾“å…¥è¡¨ä¸Šçš„æ›´æ”¹ã€‚</p><h2 id="æµå¼æŒç»­æŸ¥è¯¢çš„è¿‡ç¨‹"><a href="#æµå¼æŒç»­æŸ¥è¯¢çš„è¿‡ç¨‹" class="headerlink" title="æµå¼æŒç»­æŸ¥è¯¢çš„è¿‡ç¨‹"></a>æµå¼æŒç»­æŸ¥è¯¢çš„è¿‡ç¨‹</h2><p>ä¸‹å›¾æ˜¾ç¤ºäº†æµã€åŠ¨æ€è¡¨å’Œè¿ç»­æŸ¥è¯¢çš„å…³ç³»ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110165032290.png" alt="image-20210110165032290"></p><p>æµå¼æŒç»­æŸ¥è¯¢çš„è¿‡ç¨‹ä¸ºï¼š </p><ol><li>æµè¢«è½¬æ¢ä¸ºåŠ¨æ€è¡¨ã€‚</li><li>å¯¹åŠ¨æ€è¡¨è®¡ç®—è¿ç»­æŸ¥è¯¢ï¼Œç”Ÿæˆæ–°çš„åŠ¨æ€è¡¨ã€‚</li><li>ç”Ÿæˆçš„åŠ¨æ€è¡¨è¢«è½¬æ¢å›æµ</li></ol><h3 id="å°†æµè½¬æ¢æˆè¡¨ï¼ˆTableï¼‰"><a href="#å°†æµè½¬æ¢æˆè¡¨ï¼ˆTableï¼‰" class="headerlink" title="å°†æµè½¬æ¢æˆè¡¨ï¼ˆTableï¼‰"></a>å°†æµè½¬æ¢æˆè¡¨ï¼ˆTableï¼‰</h3><p>ä¸ºäº†å¤„ç†å¸¦æœ‰å…³ç³»æŸ¥è¯¢çš„æµï¼Œå¿…é¡»å…ˆå°†å…¶è½¬æ¢ä¸ºè¡¨ã€‚ </p><p>ä»æ¦‚å¿µä¸Šè®²ï¼Œæµçš„æ¯ä¸ªæ•°æ®è®°å½•ï¼Œéƒ½è¢«è§£é‡Šä¸ºå¯¹ç»“æœè¡¨çš„æ’å…¥ï¼ˆInsertï¼‰ä¿®æ”¹ã€‚å› ä¸ºæµ å¼æŒç»­ä¸æ–­çš„ï¼Œè€Œä¸”ä¹‹å‰çš„è¾“å‡ºç»“æœæ— æ³•æ”¹å˜ã€‚æœ¬è´¨ä¸Šï¼Œæˆ‘ä»¬å…¶å®æ˜¯ä»ä¸€ä¸ªã€åªæœ‰æ’å…¥æ“ä½œ çš„ changelogï¼ˆæ›´æ–°æ—¥å¿—ï¼‰æµï¼Œæ¥æ„å»ºä¸€ä¸ªè¡¨ã€‚ </p><p>ä¸ºäº†æ›´å¥½åœ°è¯´æ˜åŠ¨æ€è¡¨å’ŒæŒç»­æŸ¥è¯¢çš„æ¦‚å¿µï¼Œæˆ‘ä»¬æ¥ä¸¾ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ã€‚ æ¯”å¦‚ï¼Œæˆ‘ä»¬ç°åœ¨çš„è¾“å…¥æ•°æ®ï¼Œå°±æ˜¯ç”¨æˆ·åœ¨ç½‘ç«™ä¸Šçš„è®¿é—®è¡Œä¸ºï¼Œæ•°æ®ç±»å‹ï¼ˆSchemaï¼‰å¦‚ ä¸‹ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line"> user: VARCHAR, <span class="comment">// ç”¨æˆ·å</span></span><br><span class="line"> cTime: TIMESTAMP, <span class="comment">// è®¿é—®æŸä¸ª URL çš„æ—¶é—´æˆ³</span></span><br><span class="line"> url: VARCHAR <span class="comment">// ç”¨æˆ·è®¿é—®çš„ URL</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>ä¸‹å›¾æ˜¾ç¤ºäº†å¦‚ä½•å°†è®¿é—® URL äº‹ä»¶æµï¼Œæˆ–è€…å«ç‚¹å‡»äº‹ä»¶æµï¼ˆå·¦ä¾§ï¼‰è½¬æ¢ä¸ºè¡¨ï¼ˆå³ä¾§ï¼‰ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110165202118.png" alt="image-20210110165202118"></p><p>éšç€æ’å…¥æ›´å¤šçš„è®¿é—®äº‹ä»¶æµè®°å½•ï¼Œç”Ÿæˆçš„è¡¨å°†ä¸æ–­å¢é•¿ã€‚</p><h3 id="æŒç»­æŸ¥è¯¢ï¼ˆContinuous-Queryï¼‰"><a href="#æŒç»­æŸ¥è¯¢ï¼ˆContinuous-Queryï¼‰" class="headerlink" title="æŒç»­æŸ¥è¯¢ï¼ˆContinuous Queryï¼‰"></a>æŒç»­æŸ¥è¯¢ï¼ˆContinuous Queryï¼‰</h3><p>æŒç»­æŸ¥è¯¢ï¼Œä¼šåœ¨åŠ¨æ€è¡¨ä¸Šåšè®¡ç®—å¤„ç†ï¼Œå¹¶ä½œä¸ºç»“æœç”Ÿæˆæ–°çš„åŠ¨æ€è¡¨ã€‚ä¸æ‰¹å¤„ç†æŸ¥è¯¢ä¸åŒï¼Œ è¿ç»­æŸ¥è¯¢ä»ä¸ç»ˆæ­¢ï¼Œå¹¶æ ¹æ®è¾“å…¥è¡¨ä¸Šçš„æ›´æ–°æ›´æ–°å…¶ç»“æœè¡¨ã€‚ </p><p>åœ¨ä»»ä½•æ—¶é—´ç‚¹ï¼Œè¿ç»­æŸ¥è¯¢çš„ç»“æœåœ¨è¯­ä¹‰ä¸Šï¼Œç­‰åŒäºåœ¨è¾“å…¥è¡¨çš„å¿«ç…§ä¸Šï¼Œä»¥æ‰¹å¤„ç†æ¨¡å¼æ‰§ è¡Œçš„åŒä¸€æŸ¥è¯¢çš„ç»“æœã€‚</p><p> åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å±•ç¤ºäº†å¯¹ç‚¹å‡»äº‹ä»¶æµä¸­çš„ä¸€ä¸ªæŒç»­æŸ¥è¯¢ã€‚</p><p> è¿™ä¸ª Query å¾ˆç®€å•ï¼Œæ˜¯ä¸€ä¸ªåˆ†ç»„èšåˆåš count ç»Ÿè®¡çš„æŸ¥è¯¢ã€‚å®ƒå°†ç”¨æˆ·å­—æ®µä¸Šçš„ clicks è¡¨ åˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡è®¿é—®çš„ url æ•°ã€‚å›¾ä¸­æ˜¾ç¤ºäº†éšç€æ—¶é—´çš„æ¨ç§»ï¼Œå½“ clicks è¡¨è¢«å…¶ä»–è¡Œæ›´æ–°æ—¶å¦‚ä½• è®¡ç®—æŸ¥è¯¢ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110165244001.png" alt="image-20210110165244001"></p><blockquote><p>è¾“å…¥çš„è¡¨å’Œè®¡ç®—åçš„è¡¨éƒ½æ˜¯åŠ¨æ€è¡¨</p></blockquote><h3 id="å°†åŠ¨æ€è¡¨è½¬æ¢æˆæµ"><a href="#å°†åŠ¨æ€è¡¨è½¬æ¢æˆæµ" class="headerlink" title="å°†åŠ¨æ€è¡¨è½¬æ¢æˆæµ"></a>å°†åŠ¨æ€è¡¨è½¬æ¢æˆæµ</h3><p>ä¸å¸¸è§„çš„æ•°æ®åº“è¡¨ä¸€æ ·ï¼ŒåŠ¨æ€è¡¨å¯ä»¥é€šè¿‡æ’å…¥ï¼ˆInsertï¼‰ã€æ›´æ–°ï¼ˆUpdateï¼‰å’Œåˆ é™¤ï¼ˆDeleteï¼‰ æ›´æ”¹ï¼Œè¿›è¡ŒæŒç»­çš„ä¿®æ”¹ã€‚å°†åŠ¨æ€è¡¨è½¬æ¢ä¸ºæµæˆ–å°†å…¶å†™å…¥å¤–éƒ¨ç³»ç»Ÿæ—¶ï¼Œéœ€è¦å¯¹è¿™äº›æ›´æ”¹è¿›è¡Œç¼– ç ã€‚</p><p>Flink çš„ Table API å’Œ SQL æ”¯æŒä¸‰ç§æ–¹å¼å¯¹åŠ¨æ€è¡¨çš„æ›´æ”¹è¿›è¡Œç¼–ç ï¼š</p><p><strong>ä»…è¿½åŠ ï¼ˆAppend-onlyï¼‰æµ</strong></p><p>ä»…é€šè¿‡æ’å…¥ï¼ˆInsertï¼‰æ›´æ”¹ï¼Œæ¥ä¿®æ”¹çš„åŠ¨æ€è¡¨ï¼Œå¯ä»¥ç›´æ¥è½¬æ¢ä¸ºâ€œä»…è¿½åŠ â€æµã€‚è¿™ä¸ªæµ ä¸­å‘å‡ºçš„æ•°æ®ï¼Œå°±æ˜¯åŠ¨æ€è¡¨ä¸­æ–°å¢çš„æ¯ä¸€è¡Œã€‚</p><p><strong>æ’¤å›ï¼ˆRetractï¼‰æµ</strong></p><p>Retract æµæ˜¯åŒ…å«ä¸¤ç±»æ¶ˆæ¯çš„æµï¼Œæ·»åŠ ï¼ˆAddï¼‰æ¶ˆæ¯å’Œæ’¤å›ï¼ˆRetractï¼‰æ¶ˆæ¯ã€‚</p><p>åŠ¨æ€è¡¨é€šè¿‡å°† INSERT ç¼–ç ä¸º add æ¶ˆæ¯ã€DELETE ç¼–ç ä¸º retract æ¶ˆæ¯ã€UPDATE ç¼–ç ä¸ºè¢« æ›´æ”¹è¡Œï¼ˆå‰ä¸€è¡Œï¼‰çš„ retract æ¶ˆæ¯å’Œæ›´æ–°åè¡Œï¼ˆæ–°è¡Œï¼‰çš„ add æ¶ˆæ¯ï¼Œè½¬æ¢ä¸º retract æµã€‚</p><p>ä¸‹å›¾æ˜¾ç¤ºäº†å°†åŠ¨æ€è¡¨è½¬æ¢ä¸º Retract æµçš„è¿‡ç¨‹ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110165516501.png" alt="image-20210110165516501"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110165545721.png" alt="image-20210110165545721"></p><p><strong>Upsertï¼ˆæ›´æ–°æ’å…¥ï¼‰æµ</strong></p><p>Upsert æµåŒ…å«ä¸¤ç§ç±»å‹çš„æ¶ˆæ¯ï¼šUpsert æ¶ˆæ¯å’Œ delete æ¶ˆæ¯ã€‚è½¬æ¢ä¸º upsert æµçš„åŠ¨æ€è¡¨ï¼Œ éœ€è¦æœ‰å”¯ä¸€çš„é”®ï¼ˆkeyï¼‰ã€‚</p><p>é€šè¿‡å°† INSERT å’Œ UPDATE æ›´æ”¹ç¼–ç ä¸º upsert æ¶ˆæ¯ï¼Œå°† DELETE æ›´æ”¹ç¼–ç ä¸º DELETE æ¶ˆæ¯ï¼Œ å°±å¯ä»¥å°†å…·æœ‰å”¯ä¸€é”®ï¼ˆUnique Keyï¼‰çš„åŠ¨æ€è¡¨è½¬æ¢ä¸ºæµã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210110165603473.png" alt="image-20210110165603473"></p><p>è¿™äº›æ¦‚å¿µæˆ‘ä»¬ä¹‹å‰éƒ½å·²æåˆ°è¿‡ã€‚<font color="red">éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä»£ç é‡Œå°†åŠ¨æ€è¡¨è½¬æ¢ä¸º DataStream æ—¶ï¼Œä»…æ”¯æŒ Append å’Œ Retract æµã€‚</font>è€Œå‘å¤–éƒ¨ç³»ç»Ÿè¾“å‡ºåŠ¨æ€è¡¨çš„ TableSink æ¥å£ï¼Œåˆ™å¯ä»¥æœ‰ä¸ åŒçš„å®ç°ï¼Œ<strong>æ¯”å¦‚ä¹‹å‰æˆ‘ä»¬è®²åˆ°çš„ ESï¼Œå°±å¯ä»¥æœ‰ Upsert æ¨¡å¼</strong></p><h2 id="æ—¶é—´ç‰¹æ€§ğŸ”º"><a href="#æ—¶é—´ç‰¹æ€§ğŸ”º" class="headerlink" title="æ—¶é—´ç‰¹æ€§ğŸ”º"></a>æ—¶é—´ç‰¹æ€§ğŸ”º</h2><p>åŸºäºæ—¶é—´çš„æ“ä½œï¼ˆæ¯”å¦‚ Table API å’Œ SQL ä¸­çª—å£æ“ä½œï¼‰ï¼Œéœ€è¦å®šä¹‰ç›¸å…³çš„æ—¶é—´è¯­ä¹‰å’Œæ—¶é—´ æ•°æ®æ¥æºçš„ä¿¡æ¯ã€‚æ‰€ä»¥ï¼ŒTable å¯ä»¥æä¾›ä¸€ä¸ªé€»è¾‘ä¸Šçš„æ—¶é—´å­—æ®µï¼Œç”¨äºåœ¨è¡¨å¤„ç†ç¨‹åºä¸­ï¼ŒæŒ‡ ç¤ºæ—¶é—´å’Œè®¿é—®ç›¸åº”çš„æ—¶é—´æˆ³ã€‚ </p><p>æ—¶é—´å±æ€§ï¼Œå¯ä»¥æ˜¯æ¯ä¸ªè¡¨ schema çš„ä¸€éƒ¨åˆ†ã€‚ä¸€æ—¦å®šä¹‰äº†æ—¶é—´å±æ€§ï¼Œå®ƒå°±å¯ä»¥ä½œä¸ºä¸€ä¸ª å­—æ®µå¼•ç”¨ï¼Œå¹¶ä¸”å¯ä»¥åœ¨åŸºäºæ—¶é—´çš„æ“ä½œä¸­ä½¿ç”¨ã€‚</p><p> æ—¶é—´å±æ€§çš„è¡Œä¸ºç±»ä¼¼äºå¸¸è§„æ—¶é—´æˆ³ï¼Œå¯ä»¥è®¿é—®ï¼Œå¹¶ä¸”è¿›è¡Œè®¡ç®—ã€‚</p><h3 id="å¤„ç†æ—¶é—´ï¼ˆProcessing-Timeï¼‰"><a href="#å¤„ç†æ—¶é—´ï¼ˆProcessing-Timeï¼‰" class="headerlink" title="å¤„ç†æ—¶é—´ï¼ˆProcessing Timeï¼‰"></a>å¤„ç†æ—¶é—´ï¼ˆProcessing Timeï¼‰</h3><p>å¤„ç†æ—¶é—´è¯­ä¹‰ä¸‹ï¼Œå…è®¸è¡¨å¤„ç†ç¨‹åºæ ¹æ®æœºå™¨çš„æœ¬åœ°æ—¶é—´ç”Ÿæˆç»“æœã€‚å®ƒæ˜¯æ—¶é—´çš„æœ€ç®€å•æ¦‚ å¿µã€‚å®ƒæ—¢ä¸éœ€è¦æå–æ—¶é—´æˆ³ï¼Œä¹Ÿä¸éœ€è¦ç”Ÿæˆ watermarkã€‚</p><p> å®šä¹‰å¤„ç†æ—¶é—´å±æ€§æœ‰ä¸‰ç§æ–¹æ³•ï¼š</p><ol><li>åœ¨ DataStream è½¬åŒ–æ—¶ç›´æ¥æŒ‡å®šï¼›</li><li><del>åœ¨å®šä¹‰ Table Schema æ—¶æŒ‡å®šï¼›å·²ç»åºŸå¼ƒconnectæ–¹æ³•</del></li><li>åœ¨åˆ›å»ºè¡¨çš„ DDL ä¸­æŒ‡å®š</li></ol><h4 id="DataStream-è½¬åŒ–æˆ-Table-æ—¶æŒ‡å®š"><a href="#DataStream-è½¬åŒ–æˆ-Table-æ—¶æŒ‡å®š" class="headerlink" title="DataStream è½¬åŒ–æˆ Table æ—¶æŒ‡å®š"></a>DataStream è½¬åŒ–æˆ Table æ—¶æŒ‡å®š</h4><p>ç”± DataStream è½¬æ¢æˆè¡¨æ—¶ï¼Œå¯ä»¥åœ¨åé¢æŒ‡å®šå­—æ®µåæ¥å®šä¹‰ Schemaã€‚åœ¨å®šä¹‰ Schema æœŸ é—´ï¼Œå¯ä»¥ç”¨.proctimeï¼Œå®šä¹‰å¤„ç†æ—¶é—´å­—æ®µã€‚</p><p> æ³¨æ„ï¼Œè¿™ä¸ª proctime å±æ€§åªèƒ½é€šè¿‡<strong>é™„åŠ é€»è¾‘å­—æ®µ</strong>ï¼Œæ¥æ‰©å±•ç‰©ç† schemaã€‚å› æ­¤ï¼Œåªèƒ½åœ¨ schema å®šä¹‰çš„æœ«å°¾å®šä¹‰å®ƒã€‚</p><blockquote><p>å³ï¼šproctime å±æ€§ä¸èƒ½ä½¿ç”¨å·²æœ‰çš„å­—æ®µ</p></blockquote><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">ProcessTimeForDataStream</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–æµï¼Œæœ¬åœ°æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">val</span> inputStream: <span class="type">DataStream</span>[(<span class="type">String</span>, <span class="type">String</span>, <span class="type">String</span>)] = env.readTextFile(<span class="string">&quot;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&quot;</span>, <span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">      .map(r =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> strings: <span class="type">Array</span>[<span class="type">String</span>] = r.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        (strings(<span class="number">0</span>), strings(<span class="number">1</span>), strings(<span class="number">2</span>))</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æµè½¬æ¢ä¸ºè¡¨</span></span><br><span class="line">    <span class="keyword">val</span> inputTable: <span class="type">Table</span> = tableEnv.fromDataStream(inputStream, $(<span class="string">&quot;id&quot;</span>), $(<span class="string">&quot;ts&quot;</span>), $(<span class="string">&quot;temp&quot;</span>), $(<span class="string">&quot;pt&quot;</span>).proctime())</span><br><span class="line"></span><br><span class="line">    inputTable.toAppendStream[(<span class="type">String</span>, <span class="type">String</span>, <span class="type">String</span>, <span class="type">Timestamp</span>)].print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºè¡¨çš„-DDL-ä¸­æŒ‡å®š"><a href="#åˆ›å»ºè¡¨çš„-DDL-ä¸­æŒ‡å®š" class="headerlink" title="åˆ›å»ºè¡¨çš„ DDL ä¸­æŒ‡å®š"></a>åˆ›å»ºè¡¨çš„ DDL ä¸­æŒ‡å®š</h4><p>åœ¨åˆ›å»ºè¡¨çš„ DDL ä¸­ï¼Œå¢åŠ ä¸€ä¸ªå­—æ®µå¹¶æŒ‡å®šæˆ proctimeï¼Œä¹Ÿå¯ä»¥æŒ‡å®šå½“å‰çš„æ—¶é—´å­—æ®µã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">ProcessTimeForDdl</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileSystemSql: <span class="type">String</span> = <span class="string">&quot;CREATE TABLE fs_table &quot;</span> +</span><br><span class="line">      <span class="string">&quot;(id STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot; ts STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;  temp DOUBLE, &quot;</span> +</span><br><span class="line">      <span class="string">&quot; pt AS PROCTIME()) &quot;</span> +</span><br><span class="line">      <span class="string">&quot; WITH (&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;connector&#x27;=&#x27;filesystem&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;path&#x27;=&#x27;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;format&#x27;=&#x27;csv&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//    å¯ä»¥ä½¿ç”¨ TableEnvironment ä¸­çš„ executeSql() æ–¹æ³•æ‰§è¡Œ CREATE è¯­å¥ã€‚ è‹¥ CREATE æ“ä½œæ‰§è¡ŒæˆåŠŸï¼ŒexecuteSql() æ–¹æ³•è¿”å› â€˜OKâ€™ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//    ä»¥ä¸‹çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•åœ¨ TableEnvironment ä¸­æ‰§è¡Œä¸€ä¸ª CREATE è¯­å¥ã€‚</span></span><br><span class="line">    tableEnv.executeSql(fileSystemSql)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tableå¯¹è±¡æ²¡æœ‰æ–¹æ³•toAppendStreamçš„ï¼Œ åªæœ‰é€šè¿‡å¯¼å…¥éšå¼è½¬æ¢çš„åŒ…æ‰å¯ä»¥å®ç°æ­¤åŠŸèƒ½</span></span><br><span class="line">    <span class="keyword">import</span> org.apache.flink.table.api.bridge.scala.tableConversions</span><br><span class="line">    <span class="comment">// SQLå½¢å¼</span></span><br><span class="line">    tableEnv.sqlQuery(<span class="string">&quot;select * from fs_table&quot;</span>).toAppendStream[(<span class="type">String</span>, <span class="type">String</span>, <span class="type">Double</span>, <span class="type">Timestamp</span>)]</span><br><span class="line">      .print()</span><br><span class="line">    </span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›´æ¥åœ¨å®šä¹‰è¡¨å­—æ®µçš„æ—¶å€™ï¼Œå¤šåŠ ä¸€åˆ—å³å¯ï¼š<code>pt AS PROCTIME()</code></p><blockquote><p>æ³¨æ„ï¼šè¿è¡Œè¿™æ®µ DDLï¼Œå¿…é¡»ä½¿ç”¨ Blink Plannerã€‚</p></blockquote><h3 id="äº‹ä»¶æ—¶é—´ï¼ˆEvent-Timeï¼‰"><a href="#äº‹ä»¶æ—¶é—´ï¼ˆEvent-Timeï¼‰" class="headerlink" title="äº‹ä»¶æ—¶é—´ï¼ˆEvent Timeï¼‰"></a>äº‹ä»¶æ—¶é—´ï¼ˆEvent Timeï¼‰</h3><p>äº‹ä»¶æ—¶é—´è¯­ä¹‰ï¼Œå…è®¸è¡¨å¤„ç†ç¨‹åºæ ¹æ®æ¯ä¸ªè®°å½•ä¸­åŒ…å«çš„æ—¶é—´ç”Ÿæˆç»“æœã€‚è¿™æ ·å³ä½¿åœ¨æœ‰ä¹± åºäº‹ä»¶æˆ–è€…å»¶è¿Ÿäº‹ä»¶æ—¶ï¼Œä¹Ÿå¯ä»¥è·å¾—æ­£ç¡®çš„ç»“æœã€‚ </p><p>ä¸ºäº†å¤„ç†æ— åºäº‹ä»¶ï¼Œå¹¶åŒºåˆ†æµä¸­çš„å‡†æ—¶å’Œè¿Ÿåˆ°äº‹ä»¶ï¼›Flink éœ€è¦ä»äº‹ä»¶æ•°æ®ä¸­ï¼Œæå–æ—¶ é—´æˆ³ï¼Œå¹¶ç”¨æ¥æ¨è¿›äº‹ä»¶æ—¶é—´çš„è¿›å±•ï¼ˆwatermarkï¼‰ã€‚</p><h4 id="DataStream-è½¬åŒ–æˆ-Table-æ—¶æŒ‡å®š-1"><a href="#DataStream-è½¬åŒ–æˆ-Table-æ—¶æŒ‡å®š-1" class="headerlink" title="DataStream è½¬åŒ–æˆ Table æ—¶æŒ‡å®š"></a>DataStream è½¬åŒ–æˆ Table æ—¶æŒ‡å®š</h4><p>åœ¨å£°æ˜DataSteamæ—¶ç›´æ¥æŒ‡å®šWaterMarkå’Œæ—¶é—´æˆ³ã€‚ç„¶ååœ¨è½¬æ¢ä¸ºTableæ—¶ï¼Œæ·»åŠ æ–°çš„å­—æ®µæˆ–è€…è¦†ç›–å·²æœ‰å­—æ®µ</p><p>åœ¨DataStreamè½¬æ¢æˆTableï¼Œschemaçš„å®šä¹‰æœŸé—´ï¼Œä½¿ç”¨.rowtimeå¯ä»¥å®šä¹‰äº‹ä»¶æ—¶é—´å±æ€§ã€‚ <strong>æ³¨æ„ï¼Œå¿…é¡»åœ¨è½¬æ¢çš„æ•°æ®æµä¸­åˆ†é…æ—¶é—´æˆ³å’Œ watermarkã€‚</strong> </p><p>åœ¨å°†æ•°æ®æµè½¬æ¢ä¸ºè¡¨æ—¶ï¼Œæœ‰ä¸¤ç§å®šä¹‰æ—¶é—´å±æ€§çš„æ–¹æ³•ã€‚æ ¹æ®æŒ‡å®šçš„<code>.rowtime </code>å­—æ®µåæ˜¯å¦ å­˜åœ¨äºæ•°æ®æµçš„æ¶æ„ä¸­ï¼Œtimestamp å­—æ®µå¯ä»¥ï¼š </p><ul><li><p>ä½œä¸ºæ–°å­—æ®µè¿½åŠ åˆ° schema </p></li><li><p>æ›¿æ¢ç°æœ‰å­—æ®µ</p></li></ul><p>åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œå®šä¹‰çš„äº‹ä»¶æ—¶é—´æˆ³å­—æ®µï¼Œéƒ½å°†ä¿å­˜ DataStream ä¸­äº‹ä»¶æ—¶é—´æˆ³çš„å€¼ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">EventTimeForDataStream</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">// é»˜è®¤äº‹ä»¶æ—¶é—´ï¼Œä¸æŒ‡å®š</span></span><br><span class="line">    println(env.getStreamTimeCharacteristic)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–æµï¼Œæœ¬åœ°æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">val</span> inputStream: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = env.addSource(<span class="keyword">new</span> <span class="type">SensorSource</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®æ°´ä½çº¿</span></span><br><span class="line"><span class="comment">//    val watermark: DataStream[SensorReading] = inputStream.assignAscendingTimestamps(_.timestamp)</span></span><br><span class="line">    <span class="keyword">val</span> value: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = inputStream.assignTimestampsAndWatermarks(<span class="type">WatermarkStrategy</span>.forMonotonousTimestamps()</span><br><span class="line">      .withTimestampAssigner(<span class="keyword">new</span> <span class="type">SerializableTimestampAssigner</span>[<span class="type">SensorReading</span>] &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(t: <span class="type">SensorReading</span>, l: <span class="type">Long</span>): <span class="type">Long</span> = t.timestamp</span><br><span class="line">      &#125;))</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æµè½¬æ¢ä¸ºè¡¨</span></span><br><span class="line">    <span class="keyword">val</span> inputTable: <span class="type">Table</span> = tableEnv</span><br><span class="line">      .fromDataStream(value,</span><br><span class="line">        $<span class="string">&quot;id&quot;</span>, $<span class="string">&quot;temperature&quot;</span>, $<span class="string">&quot;timestamp&quot;</span>, $<span class="string">&quot;rt&quot;</span>.rowtime())</span><br><span class="line"></span><br><span class="line">    inputTable.printSchema()</span><br><span class="line">    inputTable.toAppendStream[<span class="type">Row</span>].print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210111201410740.png" alt="image-20210111201410740"></p><p>åœ¨æˆ‘ä»¬æ›´æ”¹äº†Flink1.12ç‰ˆæœ¬åï¼Œè®¾ç½®æ—¶é—´æ—¶é—´æ–¹æ³•è¢«åºŸå¼ƒï¼ŒåŸå› æ˜¯ï¼ŒFlink1.12ç‰ˆæœ¬é»˜è®¤æ˜¯äº‹ä»¶æ—¶é—´ï¼Œå¦‚æœæƒ³è¦é‡‘åº¸çš„è¯è¯·ä½¿ç”¨<code>org.apache.flink.api.common.ExecutionConfig#setAutoWatermarkInterval(long</code></p><hr><p>åŒæ—¶å‘ç°è®¾ç½®æ°´ä½çº¿çš„æ–¹æ³•ä¹Ÿè¿‡æœŸäº†ï¼Œè¿™æ˜¯æœ€æ–°çš„è¯´æ³•ã€‚<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/event_timestamps_watermarks.html">Apache Flink 1.12 Documentation: ç”Ÿæˆ Watermark</a></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> setting: <span class="type">WatermarkStrategy</span>[(<span class="type">String</span>, <span class="type">Long</span>, <span class="type">String</span>)] = <span class="type">WatermarkStrategy</span></span><br><span class="line">.forBoundedOutOfOrderness[(<span class="type">String</span>, <span class="type">Long</span>, <span class="type">String</span>)](<span class="type">Duration</span>.ofSeconds(<span class="number">20</span>))</span><br><span class="line">.withTimestampAssigner(<span class="keyword">new</span> <span class="type">SerializableTimestampAssigner</span>[(<span class="type">String</span>, <span class="type">Long</span>, <span class="type">String</span>)] &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(element: (<span class="type">String</span>, <span class="type">Long</span>, <span class="type">String</span>), recordTimestamp: <span class="type">Long</span>): <span class="type">Long</span> = element._2 * <span class="number">1000</span></span><br><span class="line">&#125;)</span><br><span class="line">inputStream.assignTimestampsAndWatermarks(setting)</span><br></pre></td></tr></table></figure><p><strong>é‡è¦ï¼š</strong></p><p>å¦‚æœç¼–è¯‘æ—¶æç¤ºä»¥ä¸‹ä¿¡æ¯ï¼š<code>Static methods in interface require -target:jvm-1.8</code></p><p>åˆ™å¯ä»¥é€šè¿‡ä¿®æ”¹pomæ–‡ä»¶ä¸­çš„scala Compilerå‚æ•°æ¥ä¿®æ”¹æ­¤é—®é¢˜ï¼ŒåŠ å…¥<code>-target:jvm-1.8</code>ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Scala Compiler --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.alchim31.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>scala-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>testCompile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">args</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-nobootcp<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-target:jvm-1.8<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">args</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åˆæˆ–è€…åœ¨</p><p>In Intellij IDEA (15 CE) add this scalac compiler option:</p><p><em>Build, Execution, Deployment</em> -&gt; <em>Compiler</em> -&gt; <em>Scala Compiler</em> -&gt; <em>Your Project</em></p><p><em>Additional compiler options</em>: <code>-target:jvm-1.8</code> (was empty).</p><h4 id="å®šä¹‰-Table-Schema-æ—¶æŒ‡å®š"><a href="#å®šä¹‰-Table-Schema-æ—¶æŒ‡å®š" class="headerlink" title="å®šä¹‰ Table Schema æ—¶æŒ‡å®š"></a><del>å®šä¹‰ Table Schema æ—¶æŒ‡å®š</del></h4><p><del>è¿™ç§æ–¹</del>æ³•åªè¦åœ¨connectåå®šä¹‰ Schema çš„æ—¶å€™ï¼Œå°†äº‹ä»¶æ—¶é—´å­—æ®µï¼Œå¹¶æŒ‡å®šæˆ rowtime å°±å¯ä»¥äº†ã€‚connectå·²åºŸå¼ƒ</p><h4 id="åˆ›å»ºè¡¨çš„-DDL-ä¸­æŒ‡å®š-1"><a href="#åˆ›å»ºè¡¨çš„-DDL-ä¸­æŒ‡å®š-1" class="headerlink" title="åˆ›å»ºè¡¨çš„ DDL ä¸­æŒ‡å®š"></a>åˆ›å»ºè¡¨çš„ DDL ä¸­æŒ‡å®š</h4><p>äº‹ä»¶æ—¶é—´å±æ€§ï¼Œæ˜¯ä½¿ç”¨ CREATE TABLE DDL ä¸­çš„ WARDMARK è¯­å¥å®šä¹‰çš„ã€‚watermark è¯­ å¥ï¼Œå®šä¹‰ç°æœ‰äº‹ä»¶æ—¶é—´å­—æ®µä¸Šçš„ watermark ç”Ÿæˆè¡¨è¾¾å¼ï¼Œè¯¥è¡¨è¾¾å¼å°†äº‹ä»¶æ—¶é—´å­—æ®µæ ‡è®°ä¸ºäº‹ ä»¶æ—¶é—´å±æ€§ã€‚</p><p><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/sql/create.html#watermark">Apache Flink 1.12 Documentation: CREATE è¯­å¥</a></p><blockquote><p><code>WATERMARK</code> å®šä¹‰äº†è¡¨çš„äº‹ä»¶æ—¶é—´å±æ€§ï¼Œå…¶å½¢å¼ä¸º <code>WATERMARK FOR rowtime_column_name AS watermark_strategy_expression</code> ã€‚</p><p><code>rowtime_column_name</code> æŠŠä¸€ä¸ªç°æœ‰çš„åˆ—å®šä¹‰ä¸ºä¸€ä¸ªä¸ºè¡¨æ ‡è®°äº‹ä»¶æ—¶é—´çš„å±æ€§ã€‚è¯¥åˆ—çš„ç±»å‹å¿…é¡»ä¸º <code>TIMESTAMP(3)</code>ï¼Œä¸”æ˜¯ schema ä¸­çš„é¡¶å±‚åˆ—ï¼Œå®ƒä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªè®¡ç®—åˆ—ã€‚</p><p><code>watermark_strategy_expression</code> å®šä¹‰äº† watermark çš„ç”Ÿæˆç­–ç•¥ã€‚å®ƒå…è®¸ä½¿ç”¨åŒ…æ‹¬è®¡ç®—åˆ—åœ¨å†…çš„ä»»æ„éæŸ¥è¯¢è¡¨è¾¾å¼æ¥è®¡ç®— watermark ï¼›è¡¨è¾¾å¼çš„è¿”å›ç±»å‹å¿…é¡»æ˜¯ <code>TIMESTAMP(3)</code>ï¼Œè¡¨ç¤ºäº†ä» Epoch ä»¥æ¥çš„ç»è¿‡çš„æ—¶é—´ã€‚ è¿”å›çš„ watermark åªæœ‰å½“å…¶ä¸ä¸ºç©ºä¸”å…¶å€¼å¤§äºä¹‹å‰å‘å‡ºçš„æœ¬åœ° watermark æ—¶æ‰ä¼šè¢«å‘å‡ºï¼ˆä»¥ä¿è¯ watermark é€’å¢ï¼‰ã€‚æ¯æ¡è®°å½•çš„ watermark ç”Ÿæˆè¡¨è¾¾å¼è®¡ç®—éƒ½ä¼šç”±æ¡†æ¶å®Œæˆã€‚ æ¡†æ¶ä¼šå®šæœŸå‘å‡ºæ‰€ç”Ÿæˆçš„æœ€å¤§çš„ watermark ï¼Œå¦‚æœå½“å‰ watermark ä»ç„¶ä¸å‰ä¸€ä¸ª watermark ç›¸åŒã€ä¸ºç©ºã€æˆ–è¿”å›çš„ watermark çš„å€¼å°äºæœ€åä¸€ä¸ªå‘å‡ºçš„ watermark ï¼Œåˆ™æ–°çš„ watermark ä¸ä¼šè¢«å‘å‡ºã€‚ Watermark æ ¹æ® <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/config.html#pipeline-auto-watermark-interval"><code>pipeline.auto-watermark-interval</code></a> ä¸­æ‰€é…ç½®çš„é—´éš”å‘å‡ºã€‚ è‹¥ watermark çš„é—´éš”æ˜¯ <code>0ms</code> ï¼Œé‚£ä¹ˆæ¯æ¡è®°å½•éƒ½ä¼šäº§ç”Ÿä¸€ä¸ª watermarkï¼Œä¸” watermark ä¼šåœ¨ä¸ä¸ºç©ºå¹¶å¤§äºä¸Šä¸€ä¸ªå‘å‡ºçš„ watermark æ—¶å‘å‡ºã€‚</p><p>ä½¿ç”¨äº‹ä»¶æ—¶é—´è¯­ä¹‰æ—¶ï¼Œè¡¨å¿…é¡»åŒ…å«äº‹ä»¶æ—¶é—´å±æ€§å’Œ watermark ç­–ç•¥ã€‚</p><p>Flink æä¾›äº†å‡ ç§å¸¸ç”¨çš„ watermark ç­–ç•¥ã€‚</p><ul><li><p>ä¸¥æ ¼é€’å¢æ—¶é—´æˆ³ï¼š <code>WATERMARK FOR rowtime_column AS rowtime_column</code>ã€‚</p><p>å‘å‡ºåˆ°ç›®å‰ä¸ºæ­¢å·²è§‚å¯Ÿåˆ°çš„æœ€å¤§æ—¶é—´æˆ³çš„ watermark ï¼Œæ—¶é—´æˆ³å¤§äºæœ€å¤§æ—¶é—´æˆ³çš„è¡Œè¢«è®¤ä¸ºæ²¡æœ‰è¿Ÿåˆ°ã€‚</p></li><li><p>é€’å¢æ—¶é—´æˆ³ï¼š <code>WATERMARK FOR rowtime_column AS rowtime_column - INTERVAL &#39;0.001&#39; SECOND</code>ã€‚</p><p>å‘å‡ºåˆ°ç›®å‰ä¸ºæ­¢å·²è§‚å¯Ÿåˆ°çš„æœ€å¤§æ—¶é—´æˆ³å‡ 1 çš„ watermark ï¼Œæ—¶é—´æˆ³å¤§äºæˆ–ç­‰äºæœ€å¤§æ—¶é—´æˆ³çš„è¡Œè¢«è®¤ä¸ºæ²¡æœ‰è¿Ÿåˆ°ã€‚</p></li><li><p>æœ‰ç•Œä¹±åºæ—¶é—´æˆ³ï¼š <code>WATERMARK FOR rowtime_column AS rowtime_column - INTERVAL &#39;string&#39; timeUnit</code>ã€‚</p><p>å‘å‡ºåˆ°ç›®å‰ä¸ºæ­¢å·²è§‚å¯Ÿåˆ°çš„æœ€å¤§æ—¶é—´æˆ³å‡å»æŒ‡å®šå»¶è¿Ÿçš„ watermark ï¼Œä¾‹å¦‚ï¼Œ <code>WATERMARK FOR rowtime_column AS rowtime_column - INTERVAL &#39;5&#39; SECOND</code> æ˜¯ä¸€ä¸ª 5 ç§’å»¶è¿Ÿçš„ watermark ç­–ç•¥ã€‚</p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Orders (</span><br><span class="line">    <span class="string">`user`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">    product <span class="keyword">STRING</span>,</span><br><span class="line">    order_time <span class="built_in">TIMESTAMP</span>(<span class="number">3</span>),</span><br><span class="line">    WATERMARK <span class="keyword">FOR</span> order_time <span class="keyword">AS</span> order_time - <span class="built_in">INTERVAL</span> <span class="string">&#x27;5&#x27;</span> <span class="keyword">SECOND</span></span><br><span class="line">) <span class="keyword">WITH</span> ( . . . );</span><br></pre></td></tr></table></figure><p>æ³¨æ„ç‚¹ï¼šè¢«ä½œä¸ºæ—¶é—´æˆ³çš„å­—æ®µéœ€è¦æ˜¯<code>TIMESTAMP</code>ç±»å‹ï¼Œä¸”åœ¨å£°æ˜WATERMARKæ—¶çš„å­—æ®µä¹Ÿéœ€è¦æ˜¯<code>TIMESTAMP</code></p></blockquote><p>ä¾‹å¦‚ï¼šè¯»å–æœ¬åœ°æ–‡ä»¶ä¿¡æ¯æ—¶ç›´æ¥æŒ‡å®šWatermarkï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.table</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.eventtime._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.bridge.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.types.<span class="type">Row</span></span><br><span class="line"><span class="keyword">import</span> org.example.source.&#123;<span class="type">SensorReading</span>, <span class="type">SensorSource</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">EventTimeForDdl</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">// é»˜è®¤äº‹ä»¶æ—¶é—´ï¼Œä¸æŒ‡å®š</span></span><br><span class="line">    println(env.getStreamTimeCharacteristic)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileSystemSql: <span class="type">String</span> = <span class="string">&quot;CREATE TABLE fs_table &quot;</span> +</span><br><span class="line">      <span class="string">&quot;(id STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;ts BIGINT,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;  temp DOUBLE, &quot;</span> +</span><br><span class="line">      <span class="string">&quot; order_time as  TO_TIMESTAMP( FROM_UNIXTIME(ts) ) ,&quot;</span> +</span><br><span class="line">      <span class="string">&quot; WATERMARK FOR order_time AS order_time - INTERVAL &#x27;5&#x27; SECOND) &quot;</span> +</span><br><span class="line">      <span class="string">&quot; WITH (&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;connector&#x27;=&#x27;filesystem&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;path&#x27;=&#x27;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;format&#x27;=&#x27;csv&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">    tableEnv.executeSql(fileSystemSql)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> table: <span class="type">Table</span> = tableEnv.from(<span class="string">&quot;fs_table&quot;</span>)</span><br><span class="line">    table.printSchema()</span><br><span class="line">    table.toAppendStream[<span class="type">Row</span>].print()</span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210112223123100.png" alt="image-20210112223123100"></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sensor_1,1547718199,35.8</span><br><span class="line">sensor_6,1547718201,15.4</span><br><span class="line">sensor_7,1547718202,6.7</span><br><span class="line">sensor_10,1547718205,38.1</span><br><span class="line">sensor_1,1547718207,36.3</span><br><span class="line">sensor_1,1547718209,32.8</span><br><span class="line">sensor_1,1547718212,37.1</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„</p><p><font color="red">åœ¨å£°æ˜Watermarkæ—¶éœ€è¦è®¾ç½®çš„æ˜¯æ—¶é—´æˆ³çš„ç±»å‹ï¼Œå¦‚æœæºæ•°æ®ä¸æ˜¯æ—¶é—´æˆ³ç±»å‹ï¼Œéœ€è¦æ–°å¢ä¸€ä¸ªé€»è¾‘åˆ—ï¼Œæ¥å°†å…¶ä»–çš„æ—¶é—´åˆ—è½¬æ¢ä¸ºæ—¶é—´æˆ³ç±»å‹ï¼Œå†ç»™è®¾ç½®WaterMark</font></p><p>è¿™é‡Œ FROM_UNIXTIME æ˜¯ç³»ç»Ÿå†…ç½®çš„æ—¶é—´å‡½æ•°ï¼Œç”¨æ¥å°†ä¸€ä¸ªæ•´æ•°ï¼ˆç§’æ•°ï¼‰è½¬æ¢æˆ â€œYYYY-MM-DD hh:mm:ssâ€æ ¼å¼ï¼ˆé»˜è®¤ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºç¬¬äºŒä¸ª String å‚æ•°ä¼ å…¥ï¼‰çš„æ—¥æœŸæ—¶é—´ å­—ç¬¦ä¸²ï¼ˆdate time stringï¼‰ï¼›ç„¶åå†ç”¨ TO_TIMESTAMP å°†å…¶è½¬æ¢æˆ Timestampã€‚</p></blockquote><h1 id="çª—å£ğŸ”º"><a href="#çª—å£ğŸ”º" class="headerlink" title="çª—å£ğŸ”º"></a>çª—å£ğŸ”º</h1><p>æ—¶é—´è¯­ä¹‰ï¼Œè¦é…åˆçª—å£æ“ä½œæ‰èƒ½å‘æŒ¥ä½œç”¨ã€‚æœ€ä¸»è¦çš„ç”¨é€”ï¼Œå½“ç„¶å°±æ˜¯å¼€çª—å£ã€æ ¹æ®æ—¶é—´ æ®µåšè®¡ç®—äº†ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹ Table API å’Œ SQL ä¸­ï¼Œæ€ä¹ˆåˆ©ç”¨æ—¶é—´å­—æ®µåšçª—å£æ“ä½œã€‚ åœ¨ Table API å’Œ SQL ä¸­ï¼Œä¸»è¦æœ‰ä¸¤ç§çª—å£ï¼š</p><ol><li>Group Windows ï¼šåˆ†ç»„çª—å£</li><li>Over Windowsï¼šOverçª—å£ï¼Œå’Œæˆ‘ä»¬åœ¨RDBMSè¯´çš„å¼€çª—å‡½æ•°æ˜¯ä¸€æ ·çš„</li></ol><h2 id="åˆ†ç»„çª—å£ï¼ˆGroup-Windowsï¼‰"><a href="#åˆ†ç»„çª—å£ï¼ˆGroup-Windowsï¼‰" class="headerlink" title="åˆ†ç»„çª—å£ï¼ˆGroup Windowsï¼‰"></a>åˆ†ç»„çª—å£ï¼ˆGroup Windowsï¼‰</h2><p>åˆ†ç»„çª—å£ï¼ˆGroup Windowsï¼‰ä¼šæ ¹æ®æ—¶é—´æˆ–è¡Œè®¡æ•°é—´éš”ï¼Œå°†è¡Œèšåˆåˆ°æœ‰é™çš„ç»„ï¼ˆGroupï¼‰ ä¸­ï¼Œå¹¶å¯¹æ¯ä¸ªç»„çš„æ•°æ®æ‰§è¡Œä¸€æ¬¡èšåˆå‡½æ•°ã€‚</p><p> Table API ä¸­çš„ Group Windows éƒ½æ˜¯ä½¿ç”¨.windowï¼ˆw:GroupWindowï¼‰å­å¥å®šä¹‰çš„ï¼Œå¹¶ä¸” å¿…é¡»ç”± as å­å¥æŒ‡å®šä¸€ä¸ªåˆ«åã€‚ä¸ºäº†æŒ‰çª—å£å¯¹è¡¨è¿›è¡Œåˆ†ç»„ï¼Œçª—å£çš„åˆ«åå¿…é¡»åœ¨ group by å­å¥ ä¸­ï¼Œåƒå¸¸è§„çš„åˆ†ç»„å­—æ®µä¸€æ ·å¼•ç”¨ã€‚</p><p>Table API æä¾›äº†ä¸€ç»„å…·æœ‰ç‰¹å®šè¯­ä¹‰çš„é¢„å®šä¹‰ Window ç±»ï¼Œè¿™äº›ç±»ä¼šè¢«è½¬æ¢ä¸ºåº•å±‚ DataStream æˆ– DataSet çš„çª—å£æ“ä½œã€‚ </p><p>Table API æ”¯æŒçš„çª—å£å®šä¹‰ï¼Œå’Œæˆ‘ä»¬ç†Ÿæ‚‰çš„ä¸€æ ·ï¼Œä¸»è¦ä¹Ÿæ˜¯ä¸‰ç§ï¼šæ»šåŠ¨ï¼ˆTumblingï¼‰ã€æ»‘ åŠ¨ï¼ˆSlidingï¼‰å’Œä¼šè¯ï¼ˆSessionï¼‰ã€‚</p><blockquote><p>æ³¨æ„çš„æ˜¯ï¼Œåˆ†ç»„èšåˆåçš„Tableå¯ä»¥è½¬æ¢ä¸ºAppendæµï¼Œå› ä¸ºçª—å£è®¡ç®—å®Œåæ‰ä¼šè¾“å‡ºï¼Œå¹¶ä¸ä¼šæ›´æ”¹å·²ç»å…³é—­çš„çª—å£çš„æ•°å€¼</p></blockquote><h3 id="æ»šåŠ¨çª—å£"><a href="#æ»šåŠ¨çª—å£" class="headerlink" title="æ»šåŠ¨çª—å£"></a>æ»šåŠ¨çª—å£</h3><p><strong><em>Table API</em></strong></p><p>æ»šåŠ¨çª—å£ï¼ˆTumbling windowsï¼‰è¦ç”¨ Tumble ç±»æ¥å®šä¹‰ï¼Œå¦å¤–è¿˜æœ‰ä¸‰ä¸ªæ–¹æ³•ï¼š</p><ul><li>overï¼šå®šä¹‰çª—å£é•¿åº¦</li><li>onï¼šç”¨æ¥åˆ†ç»„ï¼ˆæŒ‰æ—¶é—´é—´éš”ï¼‰æˆ–è€…æ’åºï¼ˆæŒ‰è¡Œæ•°ï¼‰çš„æ—¶é—´å­—æ®µ</li><li>asï¼šåˆ«åï¼Œå¿…é¡»å‡ºç°åœ¨åé¢çš„ groupBy ä¸­</li></ul><p>ä½¿ç”¨Table APIè¿›è¡Œåˆ†ç»„æ—¶ï¼Œä¸DataTreamçš„æ“ä½œæœ‰æ‰€ä¸åŒï¼Œä»–éœ€è¦å…ˆå¼€çª—å½¢æˆä¸€ä¸ªé€»è¾‘å­—æ®µçª—å£wï¼Œä¹‹åä½¿ç”¨<code>group by</code>æ­£å¼å¼€çª—æ ï¼Œæ­¤æ—¶å¿…é¡»åŸºäºçª—å£é€»è¾‘wå’Œå…¶ä»–éœ€è¦åˆ†ç»„çš„å¯¹è±¡æ¥åˆ†ç»„ã€‚</p><p>ä¾‹å¦‚ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.<span class="type">Expressions</span>.lit</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.&#123;$, <span class="type">Table</span>, <span class="type">Tumble</span>, <span class="type">WithOperations</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.bridge.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.types.<span class="type">Row</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">TumbleWindowApi</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">// é»˜è®¤äº‹ä»¶æ—¶é—´ï¼Œä¸æŒ‡å®š</span></span><br><span class="line">    println(env.getStreamTimeCharacteristic)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileSystemSql: <span class="type">String</span> = <span class="string">&quot;CREATE TABLE fs_table &quot;</span> +</span><br><span class="line">      <span class="string">&quot;(id STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;ts BIGINT,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;  temp DOUBLE, &quot;</span> +</span><br><span class="line">      <span class="string">&quot; order_time as  TO_TIMESTAMP( FROM_UNIXTIME(ts) ) ,&quot;</span> +</span><br><span class="line">      <span class="string">&quot; WATERMARK FOR order_time AS order_time - INTERVAL &#x27;5&#x27; SECOND) &quot;</span> +</span><br><span class="line">      <span class="string">&quot; WITH (&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;connector&#x27;=&#x27;filesystem&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;path&#x27;=&#x27;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;format&#x27;=&#x27;csv&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">    tableEnv.executeSql(fileSystemSql)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> table: <span class="type">Table</span> = tableEnv.from(<span class="string">&quot;fs_table&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> table1: <span class="type">Table</span> = table.window(<span class="type">Tumble</span>.over(lit(<span class="number">1</span>).hour()).on($(<span class="string">&quot;order_time&quot;</span>)).as($(<span class="string">&quot;w&quot;</span>)))</span><br><span class="line">      .groupBy($(<span class="string">&quot;w&quot;</span>), $(<span class="string">&quot;id&quot;</span>))</span><br><span class="line">      .select($(<span class="string">&quot;id&quot;</span>), $(<span class="string">&quot;temp&quot;</span>).count, $(<span class="string">&quot;w&quot;</span>).`end`())</span><br><span class="line"></span><br><span class="line">    table1.toAppendStream[<span class="type">Row</span>].print()</span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„çš„æ˜¯ï¼Œåˆ†ç»„èšåˆåçš„Tableå¯ä»¥è½¬æ¢ä¸ºAppendæµï¼Œå› ä¸ºçª—å£è®¡ç®—å®Œåæ‰ä¼šè¾“å‡ºï¼Œå¹¶ä¸ä¼šæ›´æ”¹å·²ç»å…³é—­çš„çª—å£çš„æ•°å€¼.</p><hr><p><strong><em>SQL</em></strong></p><p><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/sql/queries.html#%E5%88%86%E7%BB%84%E7%AA%97%E5%8F%A3">Apache Flink 1.12 Documentation: æŸ¥è¯¢è¯­å¥</a></p><p>SQL æŸ¥è¯¢çš„åˆ†ç»„çª—å£æ˜¯é€šè¿‡ <code>GROUP BY</code> å­å¥å®šä¹‰çš„ã€‚ç±»ä¼¼äºä½¿ç”¨å¸¸è§„ <code>GROUP BY</code> è¯­å¥çš„æŸ¥è¯¢ï¼Œçª—å£åˆ†ç»„è¯­å¥çš„ <code>GROUP BY</code> å­å¥ä¸­å¸¦æœ‰ä¸€ä¸ªçª—å£å‡½æ•°ä¸ºæ¯ä¸ªåˆ†ç»„è®¡ç®—å‡ºä¸€ä¸ªç»“æœã€‚ä»¥ä¸‹æ˜¯æ‰¹å¤„ç†è¡¨å’Œæµå¤„ç†è¡¨æ”¯æŒçš„åˆ†ç»„çª—å£å‡½æ•°ï¼š</p><table><thead><tr><th align="left">åˆ†ç»„çª—å£å‡½æ•°</th><th align="left">æè¿°</th></tr></thead><tbody><tr><td align="left"><code>TUMBLE(time_attr, interval)</code></td><td align="left">å®šä¹‰ä¸€ä¸ªæ»šåŠ¨çª—å£ã€‚æ»šåŠ¨çª—å£æŠŠè¡Œåˆ†é…åˆ°æœ‰å›ºå®šæŒç»­æ—¶é—´ï¼ˆ <code>interval</code> ï¼‰çš„ä¸é‡å çš„è¿ç»­çª—å£ã€‚æ¯”å¦‚ï¼Œ5 åˆ†é’Ÿçš„æ»šåŠ¨çª—å£ä»¥ 5 åˆ†é’Ÿä¸ºé—´éš”å¯¹è¡Œè¿›è¡Œåˆ†ç»„ã€‚æ»šåŠ¨çª—å£å¯ä»¥å®šä¹‰åœ¨äº‹ä»¶æ—¶é—´ï¼ˆæ‰¹å¤„ç†ã€æµå¤„ç†ï¼‰æˆ–å¤„ç†æ—¶é—´ï¼ˆæµå¤„ç†ï¼‰ä¸Šã€‚</td></tr><tr><td align="left"><code>HOP(time_attr, interval, interval)</code></td><td align="left">å®šä¹‰ä¸€ä¸ªè·³è·ƒçš„æ—¶é—´çª—å£ï¼ˆåœ¨ Table API ä¸­ç§°ä¸ºæ»‘åŠ¨çª—å£ï¼‰ã€‚æ»‘åŠ¨çª—å£æœ‰ä¸€ä¸ªå›ºå®šçš„æŒç»­æ—¶é—´ï¼ˆ ç¬¬äºŒä¸ª <code>interval</code> å‚æ•° ï¼‰ä»¥åŠä¸€ä¸ªæ»‘åŠ¨çš„é—´éš”ï¼ˆç¬¬ä¸€ä¸ª <code>interval</code> å‚æ•° ï¼‰ã€‚è‹¥æ»‘åŠ¨é—´éš”å°äºçª—å£çš„æŒç»­æ—¶é—´ï¼Œæ»‘åŠ¨çª—å£åˆ™ä¼šå‡ºç°é‡å ï¼›å› æ­¤ï¼Œè¡Œå°†ä¼šè¢«åˆ†é…åˆ°å¤šä¸ªçª—å£ä¸­ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªå¤§å°ä¸º 15 åˆ†ç»„çš„æ»‘åŠ¨çª—å£ï¼Œå…¶æ»‘åŠ¨é—´éš”ä¸º 5 åˆ†é’Ÿï¼Œå°†ä¼šæŠŠæ¯ä¸€è¡Œæ•°æ®åˆ†é…åˆ° 3 ä¸ª 15 åˆ†é’Ÿçš„çª—å£ä¸­ã€‚æ»‘åŠ¨çª—å£å¯ä»¥å®šä¹‰åœ¨äº‹ä»¶æ—¶é—´ï¼ˆæ‰¹å¤„ç†ã€æµå¤„ç†ï¼‰æˆ–å¤„ç†æ—¶é—´ï¼ˆæµå¤„ç†ï¼‰ä¸Šã€‚</td></tr><tr><td align="left"><code>SESSION(time_attr, interval)</code></td><td align="left">å®šä¹‰ä¸€ä¸ªä¼šè¯æ—¶é—´çª—å£ã€‚ä¼šè¯æ—¶é—´çª—å£æ²¡æœ‰ä¸€ä¸ªå›ºå®šçš„æŒç»­æ—¶é—´ï¼Œä½†æ˜¯å®ƒä»¬çš„è¾¹ç•Œä¼šæ ¹æ® <code>interval</code> æ‰€å®šä¹‰çš„ä¸æ´»è·ƒæ—¶é—´æ‰€ç¡®å®šï¼›å³ä¸€ä¸ªä¼šè¯æ—¶é—´çª—å£åœ¨å®šä¹‰çš„é—´éš”æ—¶é—´å†…æ²¡æœ‰æ—¶é—´å‡ºç°ï¼Œè¯¥çª—å£ä¼šè¢«å…³é—­ã€‚ä¾‹å¦‚æ—¶é—´çª—å£çš„é—´éš”æ—¶é—´æ˜¯ 30 åˆ†é’Ÿï¼Œå½“å…¶ä¸æ´»è·ƒçš„æ—¶é—´è¾¾åˆ°30åˆ†é’Ÿåï¼Œè‹¥è§‚æµ‹åˆ°æ–°çš„è®°å½•ï¼Œåˆ™ä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„ä¼šè¯æ—¶é—´çª—å£ï¼ˆå¦åˆ™è¯¥è¡Œæ•°æ®ä¼šè¢«æ·»åŠ åˆ°å½“å‰çš„çª—å£ï¼‰ï¼Œä¸”è‹¥åœ¨ 30 åˆ†é’Ÿå†…æ²¡æœ‰è§‚æµ‹åˆ°æ–°çºªå½•ï¼Œè¿™ä¸ªçª—å£å°†ä¼šè¢«å…³é—­ã€‚ä¼šè¯æ—¶é—´çª—å£å¯ä»¥ä½¿ç”¨äº‹ä»¶æ—¶é—´ï¼ˆæ‰¹å¤„ç†ã€æµå¤„ç†ï¼‰æˆ–å¤„ç†æ—¶é—´ï¼ˆæµå¤„ç†ï¼‰ã€‚</td></tr></tbody></table><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.<span class="type">Table</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.bridge.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.types.<span class="type">Row</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">TumbleWindowSql</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">// é»˜è®¤äº‹ä»¶æ—¶é—´ï¼Œä¸æŒ‡å®š</span></span><br><span class="line">    println(env.getStreamTimeCharacteristic)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileSystemSql: <span class="type">String</span> = <span class="string">&quot;CREATE TABLE fs_table &quot;</span> +</span><br><span class="line">      <span class="string">&quot;(id STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;ts BIGINT,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;  temp DOUBLE, &quot;</span> +</span><br><span class="line">      <span class="string">&quot; row_time as  TO_TIMESTAMP( FROM_UNIXTIME(ts) ) ,&quot;</span> +</span><br><span class="line">      <span class="string">&quot; WATERMARK FOR row_time AS row_time - INTERVAL &#x27;5&#x27; SECOND) &quot;</span> +</span><br><span class="line">      <span class="string">&quot; WITH (&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;connector&#x27;=&#x27;filesystem&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;path&#x27;=&#x27;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;format&#x27;=&#x27;csv&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">    tableEnv.executeSql(fileSystemSql)</span><br><span class="line"></span><br><span class="line">    tableEnv.from(<span class="string">&quot;fs_table&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> table1: <span class="type">Table</span> = tableEnv.sqlQuery(</span><br><span class="line">      <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">        |SELECT</span></span><br><span class="line"><span class="string">        |  id,</span></span><br><span class="line"><span class="string">        |  TUMBLE_START(row_time, INTERVAL &#x27;1&#x27; HOUR) as wStart,</span></span><br><span class="line"><span class="string">        |  SUM(temp)</span></span><br><span class="line"><span class="string">        | FROM fs_table</span></span><br><span class="line"><span class="string">        | GROUP BY TUMBLE(row_time, INTERVAL &#x27;1&#x27; HOUR), id</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span>.stripMargin)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    table1.toAppendStream[<span class="type">Row</span>].print()</span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ»‘åŠ¨çª—å£"><a href="#æ»‘åŠ¨çª—å£" class="headerlink" title="æ»‘åŠ¨çª—å£"></a>æ»‘åŠ¨çª—å£</h3><p><strong><em>Table API</em></strong></p><p>æ»‘åŠ¨çª—å£ï¼ˆSliding windowsï¼‰è¦ç”¨ Slide ç±»æ¥å®šä¹‰ï¼Œå¦å¤–è¿˜æœ‰å››ä¸ªæ–¹æ³•</p><ol><li>overï¼šå®šä¹‰çª—å£é•¿åº¦</li><li>everyï¼šå®šä¹‰æ»‘åŠ¨æ­¥é•¿</li><li> onï¼šç”¨æ¥åˆ†ç»„ï¼ˆæŒ‰æ—¶é—´é—´éš”ï¼‰æˆ–è€…æ’åºï¼ˆæŒ‰è¡Œæ•°ï¼‰çš„æ—¶é—´å­—æ®µ</li><li> asï¼šåˆ«åï¼Œå¿…é¡»å‡ºç°åœ¨åé¢çš„ groupBy ä¸­</li></ol><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.<span class="type">Expressions</span>.&#123;$, lit&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.&#123;<span class="type">Slide</span>, <span class="type">Table</span>, <span class="type">Tumble</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.bridge.scala.&#123;<span class="type">StreamTableEnvironment</span>, tableConversions&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.types.<span class="type">Row</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">SlideWindowApi</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">// é»˜è®¤äº‹ä»¶æ—¶é—´ï¼Œä¸æŒ‡å®š</span></span><br><span class="line">    println(env.getStreamTimeCharacteristic)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileSystemSql: <span class="type">String</span> = <span class="string">&quot;CREATE TABLE fs_table &quot;</span> +</span><br><span class="line">      <span class="string">&quot;(id STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;ts BIGINT,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;  temp DOUBLE, &quot;</span> +</span><br><span class="line">      <span class="string">&quot; row_time as  TO_TIMESTAMP( FROM_UNIXTIME(ts) ) ,&quot;</span> +</span><br><span class="line">      <span class="string">&quot; WATERMARK FOR row_time AS row_time - INTERVAL &#x27;5&#x27; SECOND) &quot;</span> +</span><br><span class="line">      <span class="string">&quot; WITH (&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;connector&#x27;=&#x27;filesystem&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;path&#x27;=&#x27;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;format&#x27;=&#x27;csv&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">    tableEnv.executeSql(fileSystemSql)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> table: <span class="type">Table</span> = tableEnv.from(<span class="string">&quot;fs_table&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sum0  è®¡ç®—å¼ä¸ºç©ºçš„ç©º  å–0</span></span><br><span class="line">    <span class="keyword">val</span> table1: <span class="type">Table</span> = table.window(<span class="type">Slide</span>.over(lit(<span class="number">1</span>).hour()).every(lit(<span class="number">5</span>).minute()).on($(<span class="string">&quot;row_time&quot;</span>)).as(<span class="string">&quot;w&quot;</span>))</span><br><span class="line">      .groupBy($(<span class="string">&quot;w&quot;</span>), $(<span class="string">&quot;id&quot;</span>))</span><br><span class="line">      .select($(<span class="string">&quot;id&quot;</span>), $(<span class="string">&quot;temp&quot;</span>).sum0(), $(<span class="string">&quot;w&quot;</span>).start(), $(<span class="string">&quot;w&quot;</span>).`end`())</span><br><span class="line"></span><br><span class="line">    table1.toAppendStream[<span class="type">Row</span>].print()</span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><em>SQL</em></strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.<span class="type">Table</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.bridge.scala.&#123;<span class="type">StreamTableEnvironment</span>, tableConversions&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.types.<span class="type">Row</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">SlideWindowSql</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">// é»˜è®¤äº‹ä»¶æ—¶é—´ï¼Œä¸æŒ‡å®š</span></span><br><span class="line">    println(env.getStreamTimeCharacteristic)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileSystemSql: <span class="type">String</span> = <span class="string">&quot;CREATE TABLE fs_table &quot;</span> +</span><br><span class="line">      <span class="string">&quot;(id STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;ts BIGINT,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;  temp DOUBLE, &quot;</span> +</span><br><span class="line">      <span class="string">&quot; row_time as  TO_TIMESTAMP( FROM_UNIXTIME(ts) ) ,&quot;</span> +</span><br><span class="line">      <span class="string">&quot; WATERMARK FOR row_time AS row_time - INTERVAL &#x27;5&#x27; SECOND) &quot;</span> +</span><br><span class="line">      <span class="string">&quot; WITH (&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;connector&#x27;=&#x27;filesystem&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;path&#x27;=&#x27;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;format&#x27;=&#x27;csv&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">    tableEnv.executeSql(fileSystemSql)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> table1: <span class="type">Table</span> = tableEnv.sqlQuery(</span><br><span class="line">      <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">        |SELECT</span></span><br><span class="line"><span class="string">        |  id,</span></span><br><span class="line"><span class="string">        |  HOP_START(row_time, INTERVAL &#x27;1&#x27; MINUTE, INTERVAL &#x27;1&#x27; HOUR) as wStart,</span></span><br><span class="line"><span class="string">        |  HOP_END(row_time, INTERVAL &#x27;1&#x27; MINUTE, INTERVAL &#x27;1&#x27; HOUR) as wStart,</span></span><br><span class="line"><span class="string">        |  SUM(temp)</span></span><br><span class="line"><span class="string">        | FROM fs_table</span></span><br><span class="line"><span class="string">        | GROUP BY HOP(row_time, INTERVAL &#x27;1&#x27; MINUTE, INTERVAL &#x27;1&#x27; HOUR), id</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span>.stripMargin)</span><br><span class="line"></span><br><span class="line">    table1.toAppendStream[<span class="type">Row</span>].print()</span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="ä¼šè¯çª—å£"><a href="#ä¼šè¯çª—å£" class="headerlink" title="ä¼šè¯çª—å£"></a>ä¼šè¯çª—å£</h3><p>ä¼šè¯çª—å£ï¼ˆSession windowsï¼‰è¦ç”¨ Session ç±»æ¥å®šä¹‰ï¼Œå¦å¤–è¿˜æœ‰ä¸‰ä¸ªæ–¹æ³•ï¼š</p><ol><li>withGapï¼šä¼šè¯æ—¶é—´é—´éš” </li><li>onï¼šç”¨æ¥åˆ†ç»„ï¼ˆæŒ‰æ—¶é—´é—´éš”ï¼‰æˆ–è€…æ’åºï¼ˆæŒ‰è¡Œæ•°ï¼‰çš„æ—¶é—´å­—æ®µ </li><li>asï¼šåˆ«åï¼Œå¿…é¡»å‡ºç°åœ¨åé¢çš„ groupBy ä¸­</li></ol><p><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/sql/queries.html#%E5%88%86%E7%BB%84%E7%AA%97%E5%8F%A3">Apache Flink 1.12 Documentation: æŸ¥è¯¢è¯­å¥</a></p><h2 id="Over-Windows"><a href="#Over-Windows" class="headerlink" title="Over Windows"></a>Over Windows</h2><p>ç”±äº Over æœ¬æ¥å°±æ˜¯ SQL å†…ç½®æ”¯æŒçš„è¯­æ³•ï¼Œæ‰€ä»¥è¿™åœ¨ SQL ä¸­å±äºåŸºæœ¬çš„èšåˆæ“ä½œã€‚</p><p>æ‰€æœ‰ èšåˆå¿…é¡»åœ¨åŒä¸€çª—å£ä¸Šå®šä¹‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¿…é¡»æ˜¯ç›¸åŒçš„åˆ†åŒºã€æ’åºå’ŒèŒƒå›´ã€‚ç›®å‰ä»…æ”¯æŒåœ¨å½“ å‰è¡ŒèŒƒå›´ä¹‹å‰çš„çª—å£ï¼ˆæ— è¾¹ç•Œå’Œæœ‰è¾¹ç•Œï¼‰ã€‚</p><p>æ³¨æ„ï¼ŒORDER BY å¿…é¡»åœ¨å•ä¸€çš„æ—¶é—´å±æ€§ä¸ŠæŒ‡å®šã€‚</p><blockquote><p>å’Œå¸¸è§æ•°æ®åº“çš„å¼€åˆ›å‡½æ•°ä¸€æ ·ï¼Œå¯¹æœ€åçš„ç»“æœè¿›è¡ŒæŒ‡å®šèŒƒå›´å†…çš„å¼€çª—ï¼Œè®¡ç®—åçš„ç»“æœå½¢æˆæ–°çš„é€»è¾‘åˆ—ã€‚å’Œåˆ†ç»„å¼€çª—èšåˆçš„åŒºåˆ«æ˜¯å¹¶ä¸æ”¹å˜ä¹‹é—´çš„ç»“æœè¡Œæ•°ã€‚</p></blockquote><p>å¼€çª—å¯ä»¥æ˜¯æœ‰ç•Œçš„ä¹Ÿå¯ä»¥æ˜¯æ— ç•Œçš„ï¼š</p><ul><li>æ— ç•Œï¼šä¸å¯¹è¡Œæ•°è¿›è¡Œé™åˆ¶</li><li>æœ‰ç•Œï¼šæ’åºå¥½çš„åŸºç¡€ä¸Šè¿›è¡Œè¡Œæ•°çš„æˆªå–ï¼Œç›®å‰åªæ”¯æŒåˆ°æœ¬è¡Œï¼Œå› ä¸ºæ˜¯æµå¤„ç†ï¼Œä¸å¯èƒ½ç­‰ä¸‹ä¸€æ¡ç»“æœåˆ°äº†ä¹‹åæ‰å¼€çª—è®¡ç®—<ul><li> <code>ROWS BETWEEN 2 PRECEDING AND CURRENT ROW</code></li></ul></li></ul><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(amount) <span class="keyword">OVER</span> (</span><br><span class="line"> <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">user</span></span><br><span class="line"> <span class="keyword">ORDER</span> <span class="keyword">BY</span> proctime</span><br><span class="line"> <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">2</span> <span class="keyword">PRECEDING</span> <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="keyword">ROW</span>)</span><br><span class="line"><span class="keyword">FROM</span> Orders</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ä¹Ÿå¯ä»¥åšå¤šä¸ªèšåˆ</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(amount) <span class="keyword">OVER</span> w, <span class="keyword">SUM</span>(amount) <span class="keyword">OVER</span> w</span><br><span class="line"><span class="keyword">FROM</span> Orders</span><br><span class="line"><span class="keyword">WINDOW</span> w <span class="keyword">AS</span> (</span><br><span class="line"> <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">user</span></span><br><span class="line"> <span class="keyword">ORDER</span> <span class="keyword">BY</span> proctime</span><br><span class="line"> <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">2</span> <span class="keyword">PRECEDING</span> <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="keyword">ROW</span>)</span><br></pre></td></tr></table></figure><h1 id="å‡½æ•°"><a href="#å‡½æ•°" class="headerlink" title="å‡½æ•°"></a>å‡½æ•°</h1><p>Flink Table å’Œ SQL å†…ç½®äº†å¾ˆå¤š SQL ä¸­æ”¯æŒçš„å‡½æ•°ï¼›å¦‚æœæœ‰æ— æ³•æ»¡è¶³çš„éœ€è¦ï¼Œåˆ™å¯ä»¥å® ç°ç”¨æˆ·è‡ªå®šä¹‰çš„å‡½æ•°ï¼ˆUDFï¼‰æ¥è§£å†³ã€‚</p><h2 id="å†…ç½®å‡½æ•°"><a href="#å†…ç½®å‡½æ•°" class="headerlink" title="å†…ç½®å‡½æ•°"></a>å†…ç½®å‡½æ•°</h2><p>Flink Table API å’Œ SQL ä¸ºç”¨æˆ·æä¾›äº†ä¸€ç»„ç”¨äºæ•°æ®è½¬æ¢çš„å†…ç½®å‡½æ•°ã€‚SQL ä¸­æ”¯æŒçš„å¾ˆå¤š å‡½æ•°ï¼ŒTable API å’Œ SQL éƒ½å·²ç»åšäº†å®ç°ï¼Œå…¶å®ƒè¿˜åœ¨å¿«é€Ÿå¼€å‘æ‰©å±•ä¸­ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€äº›å…¸å‹å‡½æ•°çš„ä¸¾ä¾‹ï¼Œå…¨éƒ¨çš„å†…ç½®å‡½æ•°ï¼Œå¯ä»¥å‚è€ƒå®˜ç½‘ä»‹ç»ã€‚<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/functions/systemFunctions.html">Apache Flink 1.12 Documentation: ç³»ç»Ÿï¼ˆå†…ç½®ï¼‰å‡½æ•°</a></p><p><strong><em>æ¯”è¾ƒå‡½æ•°</em></strong></p><p>SQL</p><ul><li> value1 = value2 </li><li>value1 &gt; value2 </li></ul><p>Table APIï¼š </p><ul><li>ANY1 === ANY2</li><li>ANY1 &gt; ANY2</li></ul><p><strong><em>é€»è¾‘å‡½æ•°</em></strong></p><p>SQLï¼š </p><ul><li>boolean1 OR boolean2</li><li> boolean IS FALSE </li><li>NOT boolean </li></ul><p>Table APIï¼š</p><ul><li> BOOLEAN1 || BOOLEAN2 </li><li>OOLEAN.isFalse </li><li>!BOOLEAN</li></ul><p><strong><em>ç®—æœ¯å‡½æ•°</em></strong></p><p>SQLï¼š </p><ul><li><p>numeric1 + numeric2 </p></li><li><p>POWER(numeric1, numeric2)</p><p>Table APIï¼š</p></li><li><p>NUMERIC1 + NUMERIC2 </p></li><li><p>NUMERIC1.power(NUMERIC2)</p></li></ul><p><strong><em>å­—ç¬¦ä¸²å‡½æ•°</em></strong></p><p>SQLï¼š </p><ul><li>string1 || string2 </li><li>UPPER(string)</li><li> CHAR_LENGTH(string) </li></ul><p>Table APIï¼š</p><ul><li>STRING1 + STRING2 </li><li>STRING.upperCase() </li><li>STRING.charLength()</li></ul><p><strong><em>æ—¶é—´å‡½æ•°</em></strong></p><p>SQLï¼š </p><ul><li>DATE string </li><li>TIMESTAMP string </li><li>CURRENT_TIME </li><li>INTERVAL string range </li></ul><p>Table APIï¼š </p><ul><li>STRING.toDate </li><li>STRING.toTimestamp </li><li>currentTime() </li><li>NUMERIC.days </li><li>NUMERIC.minutes</li></ul><p><strong><em>èšåˆå‡½æ•°</em></strong></p><p>SQLï¼š</p><ul><li>COUNT(*) </li><li>SUM([ ALL | DISTINCT ] expression) </li><li>RANK() </li><li>ROW_NUMBER() </li></ul><p>Table APIï¼š </p><ul><li>FIELD.count </li><li>FIELD.sum0 </li></ul><h2 id="UDF"><a href="#UDF" class="headerlink" title="UDF"></a>UDF</h2><p><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/functions/udfs.html">Apache Flink 1.12 Documentation: è‡ªå®šä¹‰å‡½æ•°</a></p><p>ç”¨æˆ·å®šä¹‰å‡½æ•°ï¼ˆUser-defined Functionsï¼ŒUDFï¼‰æ˜¯ä¸€ä¸ªé‡è¦çš„ç‰¹æ€§ï¼Œå› ä¸ºå®ƒä»¬æ˜¾è‘—åœ°æ‰© å±•äº†æŸ¥è¯¢ï¼ˆQueryï¼‰çš„è¡¨è¾¾èƒ½åŠ›ã€‚ä¸€äº›ç³»ç»Ÿå†…ç½®å‡½æ•°æ— æ³•è§£å†³çš„éœ€æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ UDF æ¥è‡ª å®šä¹‰å®ç°ã€‚</p><p><font color="red">åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç”¨æˆ·å®šä¹‰çš„å‡½æ•°å¿…é¡»å…ˆæ³¨å†Œï¼Œç„¶åæ‰èƒ½åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨ã€‚</font></p><p>ä¸éœ€è¦ä¸“é—¨ä¸º Scala çš„ Table API æ³¨å†Œå‡½æ•°ã€‚ å‡½æ•°é€šè¿‡è°ƒç”¨ registerFunctionï¼ˆï¼‰æ–¹æ³•åœ¨ TableEnvironment ä¸­æ³¨å†Œã€‚å½“ç”¨æˆ·å®šä¹‰çš„å‡½æ•° è¢«æ³¨å†Œæ—¶ï¼Œå®ƒè¢«æ’å…¥åˆ° TableEnvironment çš„å‡½æ•°ç›®å½•ä¸­ï¼Œè¿™æ · Table API æˆ– SQL è§£æå™¨å°±å¯ ä»¥è¯†åˆ«å¹¶æ­£ç¡®åœ°è§£é‡Šå®ƒã€‚</p><p>å½“å‰ Flink æœ‰å¦‚ä¸‹å‡ ç§å‡½æ•°ï¼š</p><ul><li><em>æ ‡é‡å‡½æ•°</em> å°†æ ‡é‡å€¼è½¬æ¢æˆä¸€ä¸ªæ–°æ ‡é‡å€¼ï¼›</li><li><em>è¡¨å€¼å‡½æ•°</em> å°†æ ‡é‡å€¼è½¬æ¢æˆæ–°çš„è¡Œæ•°æ®ï¼›</li><li><em>èšåˆå‡½æ•°</em> å°†å¤šè¡Œæ•°æ®é‡Œçš„æ ‡é‡å€¼è½¬æ¢æˆä¸€ä¸ªæ–°æ ‡é‡å€¼ï¼›</li><li><em>è¡¨å€¼èšåˆå‡½æ•°</em> å°†å¤šè¡Œæ•°æ®é‡Œçš„æ ‡é‡å€¼è½¬æ¢æˆæ–°çš„è¡Œæ•°æ®ï¼›</li><li><em>å¼‚æ­¥è¡¨å€¼å‡½æ•°</em> æ˜¯å¼‚æ­¥æŸ¥è¯¢å¤–éƒ¨æ•°æ®ç³»ç»Ÿçš„ç‰¹æ®Šå‡½æ•°ã€‚</li></ul><h3 id="æ ‡é‡å‡½æ•°ï¼ˆScalar-Functionsï¼‰"><a href="#æ ‡é‡å‡½æ•°ï¼ˆScalar-Functionsï¼‰" class="headerlink" title="æ ‡é‡å‡½æ•°ï¼ˆScalar Functionsï¼‰"></a>æ ‡é‡å‡½æ•°ï¼ˆScalar Functionsï¼‰</h3><p>è‡ªå®šä¹‰æ ‡é‡å‡½æ•°å¯ä»¥æŠŠ 0 åˆ°å¤šä¸ªæ ‡é‡å€¼æ˜ å°„æˆ 1 ä¸ªæ ‡é‡å€¼ï¼Œ<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/types.html">æ•°æ®ç±»å‹</a>é‡Œåˆ—å‡ºçš„ä»»ä½•æ•°æ®ç±»å‹éƒ½å¯ä½œä¸ºæ±‚å€¼æ–¹æ³•çš„å‚æ•°å’Œè¿”å›å€¼ç±»å‹ã€‚</p><p>æƒ³è¦å®ç°è‡ªå®šä¹‰æ ‡é‡å‡½æ•°ï¼Œä½ éœ€è¦æ‰©å±• <code>org.apache.flink.table.functions</code> é‡Œé¢çš„ <code>ScalarFunction</code> å¹¶ä¸”å®ç°ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ±‚å€¼æ–¹æ³•ã€‚æ ‡é‡å‡½æ•°çš„è¡Œä¸ºå–å†³äºä½ å†™çš„æ±‚å€¼æ–¹æ³•ã€‚æ±‚å€¼æ–¹æ³•å¿…é¡»æ˜¯ <code>public</code> çš„ï¼Œè€Œä¸”åå­—å¿…é¡»æ˜¯ <code>eval</code>ã€‚</p><p>ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•å®ç°ä¸€ä¸ªæ±‚å“ˆå¸Œå€¼çš„å‡½æ•°å¹¶åœ¨æŸ¥è¯¢é‡Œè°ƒç”¨å®ƒï¼Œè¯¦æƒ…å¯å‚è€ƒ<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/functions/udfs.html#%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97">å¼€å‘æŒ‡å—</a>ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.bridge.scala.&#123;<span class="type">StreamTableEnvironment</span>, tableConversions&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.&#123;<span class="type">FieldExpression</span>, call&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.functions.<span class="type">ScalarFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.types.<span class="type">Row</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">MyScalarFunction</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">// é»˜è®¤äº‹ä»¶æ—¶é—´ï¼Œä¸æŒ‡å®š</span></span><br><span class="line">    println(env.getStreamTimeCharacteristic)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileSystemSql: <span class="type">String</span> = <span class="string">&quot;CREATE TABLE fs_table &quot;</span> +</span><br><span class="line">      <span class="string">&quot;(id STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;ts BIGINT,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;  temp DOUBLE, &quot;</span> +</span><br><span class="line">      <span class="string">&quot; row_time as  TO_TIMESTAMP( FROM_UNIXTIME(ts) ) ,&quot;</span> +</span><br><span class="line">      <span class="string">&quot; WATERMARK FOR row_time AS row_time - INTERVAL &#x27;5&#x27; SECOND) &quot;</span> +</span><br><span class="line">      <span class="string">&quot; WITH (&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;connector&#x27;=&#x27;filesystem&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;path&#x27;=&#x27;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;format&#x27;=&#x27;csv&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">    tableEnv.executeSql(fileSystemSql)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. åœ¨ Table API é‡Œä¸ç»æ³¨å†Œç›´æ¥â€œå†…è”â€è°ƒç”¨å‡½æ•°</span></span><br><span class="line">    tableEnv.from(<span class="string">&quot;fs_table&quot;</span>).select($<span class="string">&quot;id&quot;</span>, call(classOf[<span class="type">HashFunction</span>], $<span class="string">&quot;id&quot;</span>))</span><br><span class="line">      .toAppendStream[<span class="type">Row</span>].print()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. æ³¨å†Œå‡½æ•°</span></span><br><span class="line">    tableEnv.createTemporarySystemFunction(<span class="string">&quot;HashFunction&quot;</span>, classOf[<span class="type">HashFunction</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.1 åœ¨ Table API é‡Œè°ƒç”¨æ³¨å†Œå¥½çš„å‡½æ•°</span></span><br><span class="line">    tableEnv.from(<span class="string">&quot;fs_table&quot;</span>).select($<span class="string">&quot;id&quot;</span>, call(<span class="string">&quot;HashFunction&quot;</span>, $<span class="string">&quot;id&quot;</span>))</span><br><span class="line">      .toAppendStream[<span class="type">Row</span>].print()</span><br><span class="line">    <span class="comment">// 2.2 åœ¨ SQL é‡Œè°ƒç”¨æ³¨å†Œå¥½çš„å‡½æ•°</span></span><br><span class="line">    tableEnv.sqlQuery(<span class="string">&quot;SELECT id, HashFunction(id) FROM fs_table&quot;</span>)</span><br><span class="line">      .toAppendStream[<span class="type">Row</span>].print()</span><br><span class="line">    </span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">HashFunction</span> <span class="keyword">extends</span> <span class="title">ScalarFunction</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">eval</span></span>(a: <span class="type">String</span>): <span class="type">Int</span> = &#123;</span><br><span class="line">      a.hashCode</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è¡¨å‡½æ•°ï¼ˆTable-Functionsï¼‰"><a href="#è¡¨å‡½æ•°ï¼ˆTable-Functionsï¼‰" class="headerlink" title="è¡¨å‡½æ•°ï¼ˆTable Functionsï¼‰"></a>è¡¨å‡½æ•°ï¼ˆTable Functionsï¼‰</h3><p>è·Ÿè‡ªå®šä¹‰æ ‡é‡å‡½æ•°ä¸€æ ·ï¼Œè‡ªå®šä¹‰è¡¨å€¼å‡½æ•°çš„è¾“å…¥å‚æ•°ä¹Ÿå¯ä»¥æ˜¯ 0 åˆ°å¤šä¸ªæ ‡é‡ã€‚<font color="red">ä½†æ˜¯è·Ÿæ ‡é‡å‡½æ•°åªèƒ½è¿”å›ä¸€ä¸ªå€¼ä¸åŒçš„æ˜¯ï¼Œå®ƒå¯ä»¥è¿”å›ä»»æ„å¤šè¡Œã€‚è¿”å›çš„æ¯ä¸€è¡Œå¯ä»¥åŒ…å« 1 åˆ°å¤šåˆ—</font>ï¼Œå¦‚æœè¾“å‡ºè¡ŒåªåŒ…å« 1 åˆ—ï¼Œä¼šçœç•¥ç»“æ„åŒ–ä¿¡æ¯å¹¶ç”Ÿæˆæ ‡é‡å€¼ï¼Œè¿™ä¸ªæ ‡é‡å€¼åœ¨è¿è¡Œé˜¶æ®µä¼šéšå¼åœ°åŒ…è£…è¿›è¡Œé‡Œã€‚</p><p>è¦å®šä¹‰ä¸€ä¸ªè¡¨å€¼å‡½æ•°ï¼Œä½ éœ€è¦æ‰©å±• <code>org.apache.flink.table.functions</code> ä¸‹çš„ <code>TableFunction</code>ï¼Œå¯ä»¥é€šè¿‡å®ç°å¤šä¸ªåä¸º <code>eval</code> çš„æ–¹æ³•å¯¹æ±‚å€¼æ–¹æ³•è¿›è¡Œé‡è½½ã€‚åƒå…¶ä»–å‡½æ•°ä¸€æ ·ï¼Œè¾“å…¥å’Œè¾“å‡ºç±»å‹ä¹Ÿå¯ä»¥é€šè¿‡åå°„è‡ªåŠ¨æå–å‡ºæ¥ã€‚è¡¨å€¼å‡½æ•°è¿”å›çš„è¡¨çš„ç±»å‹å–å†³äº <code>TableFunction</code> ç±»çš„æ³›å‹å‚æ•° <code>T</code>ï¼Œä¸åŒäºæ ‡é‡å‡½æ•°ï¼Œè¡¨å€¼å‡½æ•°çš„æ±‚å€¼æ–¹æ³•æœ¬èº«ä¸åŒ…å«è¿”å›ç±»å‹ï¼Œè€Œæ˜¯é€šè¿‡ <code>collect(T)</code> æ–¹æ³•æ¥å‘é€è¦è¾“å‡ºçš„è¡Œã€‚</p><p>åœ¨ Table API ä¸­ï¼Œè¡¨å€¼å‡½æ•°æ˜¯é€šè¿‡ <code>.joinLateral(...)</code> æˆ–è€… <code>.leftOuterJoinLateral(...)</code> æ¥ä½¿ç”¨çš„ã€‚<code>joinLateral</code> ç®—å­ä¼šæŠŠå¤–è¡¨ï¼ˆç®—å­å·¦ä¾§çš„è¡¨ï¼‰çš„æ¯ä¸€è¡Œè·Ÿè·Ÿè¡¨å€¼å‡½æ•°è¿”å›çš„æ‰€æœ‰è¡Œï¼ˆä½äºç®—å­å³ä¾§ï¼‰è¿›è¡Œ ï¼ˆcrossï¼‰joinã€‚<code>leftOuterJoinLateral</code> ç®—å­ä¹Ÿæ˜¯æŠŠå¤–è¡¨ï¼ˆç®—å­å·¦ä¾§çš„è¡¨ï¼‰çš„æ¯ä¸€è¡Œè·Ÿè¡¨å€¼å‡½æ•°è¿”å›çš„æ‰€æœ‰è¡Œï¼ˆä½äºç®—å­å³ä¾§ï¼‰è¿›è¡Œï¼ˆcrossï¼‰joinï¼Œ<strong>å¹¶ä¸”å¦‚æœè¡¨å€¼å‡½æ•°è¿”å› 0 è¡Œä¹Ÿä¼šä¿ç•™å¤–è¡¨çš„è¿™ä¸€è¡Œã€‚</strong></p><blockquote><p>å³<code>leftOuterJoinLateral</code> ï¼Œåœ¨è¡¨å‡½æ•°è¿”å›0è¡Œæ—¶ï¼ŒåŸè¡¨çš„æ­¤è¡Œä¹Ÿä¼šä¿ç•™ï¼Œè€Œ<code>joinLateral</code>ä¸ä¼š</p></blockquote><p>åœ¨ SQL é‡Œé¢ç”¨ <code>JOIN</code> æˆ–è€… ä»¥ <code>ON TRUE</code> ä¸ºæ¡ä»¶çš„ <code>LEFT JOIN</code> æ¥é…åˆ <code>LATERAL TABLE(&lt;TableFunction&gt;)</code> çš„ä½¿ç”¨ã€‚</p><blockquote><p>LEFT JOIN LATERAL TABLEå’Œ FROM MyTable, LATERAL TABLEå’Œä¸Šé¢ä¸€ä¸ªæ„æ€ã€‚LEFT JOINå½“è¡¨å‡½æ•°ä¸è¿”å›å€¼æ—¶ï¼Œè¡Œä¼šè¢«ä¿ç•™ï¼Œè¡¨å‡½æ•°æœ¬è¯¥è¿”å›çš„å€¼ä¸ºnullï¼Œè€Œ FROM MyTable, LATERALç›´æ¥ä¸ä¿ç•™è¡¨å‡½æ•°æ²¡æœ‰è¿”å›å€¼è¡Œ</p></blockquote><blockquote><p>Table API ä¸ºä»€ä¹ˆéœ€è¦Lateralï¼ŒSQLä¸ºä»€ä¹ˆéœ€è¦<code>JOIN</code> ã€‚å› ä¸ºå¦‚æœä½ å°†ä¸€åˆ—ç»è¿‡è¡¨å‡½æ•°å½¢æˆäº†å¤šè¡Œï¼Œé‚£ä¹ˆæ²¡æœ‰ç»è¿‡æ­¤æ“ä½œçš„åˆ—è¿˜æ˜¯åŸæ¥çš„è¡Œï¼Œä¸ºäº†å¡«å……è¿™äº›åˆ—çš„å€¼ï¼Œéœ€è¦å’Œä»¥å‰çš„æ•°æ®è¿›è¡Œjoin</p></blockquote><p>ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•å®ç°ä¸€ä¸ªåˆ†éš”å‡½æ•°å¹¶åœ¨æŸ¥è¯¢é‡Œè°ƒç”¨å®ƒï¼Œå°†idå­—æ®µä»¥_åˆ†å‰²ï¼Œè¾“å‡ºæ¯ä¸ªè¢«åˆ†å‰²çš„å€¼å’Œé•¿åº¦ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.table.udf</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.annotation.&#123;<span class="type">DataTypeHint</span>, <span class="type">FunctionHint</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.bridge.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.functions.<span class="type">TableFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.types.<span class="type">Row</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">MyTableFunction</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">// é»˜è®¤äº‹ä»¶æ—¶é—´ï¼Œä¸æŒ‡å®š</span></span><br><span class="line">    println(env.getStreamTimeCharacteristic)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileSystemSql: <span class="type">String</span> = <span class="string">&quot;CREATE TABLE MyTable &quot;</span> +</span><br><span class="line">      <span class="string">&quot;(id STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;ts BIGINT,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;  temp DOUBLE, &quot;</span> +</span><br><span class="line">      <span class="string">&quot; row_time as  TO_TIMESTAMP( FROM_UNIXTIME(ts) ) ,&quot;</span> +</span><br><span class="line">      <span class="string">&quot; WATERMARK FOR row_time AS row_time - INTERVAL &#x27;5&#x27; SECOND) &quot;</span> +</span><br><span class="line">      <span class="string">&quot; WITH (&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;connector&#x27;=&#x27;filesystem&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;path&#x27;=&#x27;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;format&#x27;=&#x27;csv&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">    tableEnv.executeSql(fileSystemSql)</span><br><span class="line">    <span class="keyword">val</span> table: <span class="type">Table</span> = tableEnv.from(<span class="string">&quot;MyTable&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. åœ¨ Table API é‡Œä¸ç»æ³¨å†Œç›´æ¥â€œå†…è”â€è°ƒç”¨å‡½æ•°</span></span><br><span class="line"><span class="comment">//    å³`leftOuterJoinLateral` ï¼Œåœ¨è¡¨å‡½æ•°è¿”å›0è¡Œæ—¶ï¼ŒåŸè¡¨çš„æ­¤è¡Œä¹Ÿä¼šä¿ç•™ï¼Œè€Œ`joinLateral`ä¸ä¼š</span></span><br><span class="line">    table</span><br><span class="line">      .joinLateral(call(classOf[<span class="type">SplitFunction</span>], $<span class="string">&quot;id&quot;</span>))</span><br><span class="line">      .select($<span class="string">&quot;id&quot;</span>, $<span class="string">&quot;word&quot;</span>, $<span class="string">&quot;length&quot;</span>)</span><br><span class="line">      .toAppendStream[<span class="type">Row</span>].print()</span><br><span class="line"></span><br><span class="line">    table</span><br><span class="line">      .leftOuterJoinLateral(call(classOf[<span class="type">SplitFunction</span>], $<span class="string">&quot;myField&quot;</span>))</span><br><span class="line">      .select($<span class="string">&quot;myField&quot;</span>, $<span class="string">&quot;word&quot;</span>, $<span class="string">&quot;length&quot;</span>)</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">    <span class="comment">// ä¸‹é¢çš„è°ƒç”¨æ–¹å¼éƒ½éœ€è¦æ³¨å†Œä¹‹å</span></span><br><span class="line">    tableEnv.createTemporarySystemFunction(<span class="string">&quot;SplitFunction&quot;</span>, classOf[<span class="type">SplitFunction</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. åœ¨ Table API é‡Œè°ƒç”¨æ³¨å†Œå¥½çš„å‡½æ•°</span></span><br><span class="line">    table</span><br><span class="line">      .joinLateral(call(<span class="string">&quot;SplitFunction&quot;</span>, $<span class="string">&quot;myField&quot;</span>))</span><br><span class="line">      .select($<span class="string">&quot;myField&quot;</span>, $<span class="string">&quot;word&quot;</span>, $<span class="string">&quot;length&quot;</span>)</span><br><span class="line">    table</span><br><span class="line">      .leftOuterJoinLateral(call(<span class="string">&quot;SplitFunction&quot;</span>, $<span class="string">&quot;myField&quot;</span>))</span><br><span class="line">      .select($<span class="string">&quot;myField&quot;</span>, $<span class="string">&quot;word&quot;</span>, $<span class="string">&quot;length&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//     3.åœ¨ SQL é‡Œè°ƒç”¨æ³¨å†Œå¥½çš„å‡½æ•°// åœ¨ SQL é‡Œè°ƒç”¨æ³¨å†Œå¥½çš„å‡½æ•°</span></span><br><span class="line">    tableEnv.sqlQuery(<span class="string">&quot;SELECT id, word, length &quot;</span> + <span class="string">&quot;FROM MyTable, LATERAL TABLE(SplitFunction&quot;</span> +</span><br><span class="line">      <span class="string">&quot;(id))&quot;</span>).toAppendStream[<span class="type">Row</span>].print()</span><br><span class="line">    tableEnv.sqlQuery(<span class="string">&quot;SELECT id, word, length &quot;</span> + <span class="string">&quot;FROM MyTable &quot;</span> + <span class="string">&quot;LEFT JOIN LATERAL TABLE&quot;</span> +</span><br><span class="line">      <span class="string">&quot;(SplitFunction(id)) ON TRUE&quot;</span>).toAppendStream[<span class="type">Row</span>].print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å‡½æ•°ç±»çš„æ‰€æœ‰æ±‚å€¼æ–¹æ³•æŒ‡å®šåŒä¸€ä¸ªè¾“å‡ºç±»å‹</span></span><br><span class="line">  <span class="meta">@FunctionHint</span>(output = <span class="keyword">new</span> <span class="type">DataTypeHint</span>(<span class="string">&quot;ROW&lt;word STRING, length INT&gt;&quot;</span>))</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">SplitFunction</span> <span class="keyword">extends</span> <span class="title">TableFunction</span>[<span class="type">Row</span>] </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">eval</span></span>(str: <span class="type">String</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="comment">// use collect(...) to emit a row</span></span><br><span class="line">      str.split(<span class="string">&quot;_&quot;</span>).foreach(s =&gt; collect(<span class="type">Row</span>.of(s, <span class="type">Int</span>.box(s.length))))</span><br><span class="line"><span class="comment">//      if (!str.equalsIgnoreCase(&quot;sensor_6&quot;))&#123;</span></span><br><span class="line"><span class="comment">//        str.split(&quot;_&quot;).foreach(s =&gt; collect(Row.of(s, Int.box(s.length))))</span></span><br><span class="line"><span class="comment">//      &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="èšåˆå‡½æ•°ï¼ˆAggregate-Functionsï¼‰"><a href="#èšåˆå‡½æ•°ï¼ˆAggregate-Functionsï¼‰" class="headerlink" title="èšåˆå‡½æ•°ï¼ˆAggregate Functionsï¼‰"></a>èšåˆå‡½æ•°ï¼ˆAggregate Functionsï¼‰</h3><p>è‡ªå®šä¹‰èšåˆå‡½æ•°ï¼ˆUDAGGï¼‰æ˜¯æŠŠä¸€ä¸ªè¡¨ï¼ˆä¸€è¡Œæˆ–è€…å¤šè¡Œï¼Œæ¯è¡Œå¯ä»¥æœ‰ä¸€åˆ—æˆ–è€…å¤šåˆ—ï¼‰èšåˆæˆä¸€ä¸ªæ ‡é‡å€¼ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210113212645785.png" alt="image-20210113212645785"></p><p>ä¸Šé¢çš„å›¾ç‰‡å±•ç¤ºäº†ä¸€ä¸ªèšåˆçš„ä¾‹å­ã€‚å‡è®¾ä½ æœ‰ä¸€ä¸ªå…³äºé¥®æ–™çš„è¡¨ã€‚è¡¨é‡Œé¢æœ‰ä¸‰ä¸ªå­—æ®µï¼Œåˆ†åˆ«æ˜¯ <code>id</code>ã€<code>name</code>ã€<code>price</code>ï¼Œè¡¨é‡Œæœ‰ 5 è¡Œæ•°æ®ã€‚å‡è®¾ä½ éœ€è¦æ‰¾åˆ°æ‰€æœ‰é¥®æ–™é‡Œæœ€è´µçš„é¥®æ–™çš„ä»·æ ¼ï¼Œå³æ‰§è¡Œä¸€ä¸ª <code>max()</code> èšåˆã€‚ä½ éœ€è¦éå†æ‰€æœ‰ 5 è¡Œæ•°æ®ï¼Œè€Œç»“æœå°±åªæœ‰ä¸€ä¸ªæ•°å€¼ã€‚</p><p>è‡ªå®šä¹‰èšåˆå‡½æ•°æ˜¯é€šè¿‡æ‰©å±• <code>AggregateFunction</code> æ¥å®ç°çš„ã€‚<code>AggregateFunction</code> çš„å·¥ä½œè¿‡ç¨‹å¦‚ä¸‹ã€‚é¦–å…ˆï¼Œå®ƒéœ€è¦ä¸€ä¸ª <code>accumulator</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå­˜å‚¨äº†èšåˆçš„ä¸­é—´ç»“æœã€‚é€šè¿‡è°ƒç”¨ <code>AggregateFunction</code> çš„ <code>createAccumulator()</code> æ–¹æ³•åˆ›å»ºä¸€ä¸ªç©ºçš„ accumulatorã€‚æ¥ä¸‹æ¥ï¼Œå¯¹äºæ¯ä¸€è¡Œæ•°æ®ï¼Œä¼šè°ƒç”¨ <code>accumulate()</code> æ–¹æ³•æ¥æ›´æ–° accumulatorã€‚å½“æ‰€æœ‰çš„æ•°æ®éƒ½å¤„ç†å®Œäº†ä¹‹åï¼Œé€šè¿‡è°ƒç”¨ <code>getValue</code> æ–¹æ³•æ¥è®¡ç®—å’Œè¿”å›æœ€ç»ˆçš„ç»“æœã€‚</p><p><strong>ä¸‹é¢å‡ ä¸ªæ–¹æ³•æ˜¯æ¯ä¸ª <code>AggregateFunction</code> å¿…é¡»è¦å®ç°çš„ï¼š</strong></p><ul><li><code>createAccumulator()</code></li><li><code>accumulate()</code></li><li><code>getValue()</code></li></ul><p>Flink çš„ç±»å‹æ¨å¯¼åœ¨é‡åˆ°å¤æ‚ç±»å‹çš„æ—¶å€™å¯èƒ½ä¼šæ¨å¯¼å‡ºé”™è¯¯çš„ç»“æœï¼Œæ¯”å¦‚é‚£äº›éåŸºæœ¬ç±»å‹å’Œæ™®é€šçš„ POJO ç±»å‹çš„å¤æ‚ç±»å‹ã€‚æ‰€ä»¥è·Ÿ <code>ScalarFunction</code> å’Œ <code>TableFunction</code> ä¸€æ ·ï¼Œ<code>AggregateFunction</code> ä¹Ÿæä¾›äº† <code>AggregateFunction#getResultType()</code> å’Œ <code>AggregateFunction#getAccumulatorType()</code> æ¥åˆ†åˆ«æŒ‡å®šè¿”å›å€¼ç±»å‹å’Œ accumulator çš„ç±»å‹ï¼Œä¸¤ä¸ªå‡½æ•°çš„è¿”å›å€¼ç±»å‹ä¹Ÿéƒ½æ˜¯ <code>TypeInformation</code>ã€‚</p><p>é™¤äº†ä¸Šé¢çš„æ–¹æ³•ï¼Œè¿˜æœ‰å‡ ä¸ªæ–¹æ³•å¯ä»¥é€‰æ‹©å®ç°ã€‚è¿™äº›æ–¹æ³•æœ‰äº›å¯ä»¥è®©æŸ¥è¯¢æ›´åŠ é«˜æ•ˆï¼Œè€Œæœ‰äº›æ˜¯åœ¨æŸäº›ç‰¹å®šåœºæ™¯ä¸‹å¿…é¡»è¦å®ç°çš„ã€‚ä¾‹å¦‚ï¼Œ<font color="red">å¦‚æœèšåˆå‡½æ•°ç”¨åœ¨ä¼šè¯çª—å£ï¼ˆå½“ä¸¤ä¸ªä¼šè¯çª—å£åˆå¹¶çš„æ—¶å€™éœ€è¦ merge ä»–ä»¬çš„ accumulatorï¼‰çš„è¯ï¼Œ<code>merge()</code> æ–¹æ³•å°±æ˜¯å¿…é¡»è¦å®ç°çš„ã€‚</font></p><p><strong><code>AggregateFunction</code> çš„ä»¥ä¸‹æ–¹æ³•åœ¨æŸäº›åœºæ™¯ä¸‹æ˜¯å¿…é¡»å®ç°çš„ï¼š</strong></p><ul><li><code>retract()</code> åœ¨ bounded <code>OVER</code> çª—å£ä¸­æ˜¯å¿…é¡»å®ç°çš„ã€‚</li><li><code>merge()</code> åœ¨è®¸å¤šæ‰¹å¼èšåˆå’Œä¼šè¯ä»¥åŠæ»šåŠ¨çª—å£èšåˆä¸­æ˜¯å¿…é¡»å®ç°çš„ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿™ä¸ªæ–¹æ³•å¯¹äºä¼˜åŒ–ä¹Ÿå¾ˆå¤šå¸®åŠ©ã€‚ä¾‹å¦‚ï¼Œä¸¤é˜¶æ®µèšåˆä¼˜åŒ–å°±éœ€è¦æ‰€æœ‰çš„ <code>AggregateFunction</code> éƒ½å®ç° <code>merge</code> æ–¹æ³•ã€‚</li><li><code>resetAccumulator()</code> åœ¨è®¸å¤šæ‰¹å¼èšåˆä¸­æ˜¯å¿…é¡»å®ç°çš„ã€‚</li></ul><p><code>AggregateFunction</code> çš„æ‰€æœ‰æ–¹æ³•éƒ½å¿…é¡»æ˜¯ <code>public</code> çš„ï¼Œä¸èƒ½æ˜¯ <code>static</code> çš„ï¼Œè€Œä¸”åå­—å¿…é¡»è·Ÿä¸Šé¢å†™çš„ä¸€æ ·ã€‚<code>createAccumulator</code>ã€<code>getValue</code>ã€<code>getResultType</code> ä»¥åŠ <code>getAccumulatorType</code> è¿™å‡ ä¸ªå‡½æ•°æ˜¯åœ¨æŠ½è±¡ç±» <code>AggregateFunction</code> ä¸­å®šä¹‰çš„ï¼Œè€Œå…¶ä»–å‡½æ•°éƒ½æ˜¯çº¦å®šçš„æ–¹æ³•ã€‚å¦‚æœè¦å®šä¹‰ä¸€ä¸ªèšåˆå‡½æ•°ï¼Œä½ éœ€è¦æ‰©å±• <code>org.apache.flink.table.functions.AggregateFunction</code>ï¼Œå¹¶ä¸”å®ç°ä¸€ä¸ªï¼ˆæˆ–è€…å¤šä¸ªï¼‰<code>accumulate</code> æ–¹æ³•ã€‚<code>accumulate</code> æ–¹æ³•å¯ä»¥é‡è½½ï¼Œæ¯ä¸ªæ–¹æ³•çš„å‚æ•°ç±»å‹ä¸åŒï¼Œå¹¶ä¸”æ”¯æŒå˜é•¿å‚æ•°ã€‚</p><hr><p>è‡ªå®šä¹‰å®ç°avgèšåˆï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.table.udf</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.annotation.&#123;<span class="type">DataTypeHint</span>, <span class="type">FunctionHint</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.<span class="type">Expressions</span>.lit</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.bridge.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.api.&#123;$, <span class="type">Table</span>, <span class="type">Tumble</span>, <span class="type">WithOperations</span>, call&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.table.functions.<span class="type">AggregateFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.types.<span class="type">Row</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">MyAggregateFunction</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">// é»˜è®¤äº‹ä»¶æ—¶é—´ï¼Œä¸æŒ‡å®š</span></span><br><span class="line">    println(env.getStreamTimeCharacteristic)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> tableEnv: <span class="type">StreamTableEnvironment</span> = <span class="type">StreamTableEnvironment</span>.create(env)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileSystemSql: <span class="type">String</span> = <span class="string">&quot;CREATE TABLE MyTable &quot;</span> +</span><br><span class="line">      <span class="string">&quot;(id STRING,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;ts BIGINT,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;  temp DOUBLE, &quot;</span> +</span><br><span class="line">      <span class="string">&quot; row_time as  TO_TIMESTAMP( FROM_UNIXTIME(ts) ) ,&quot;</span> +</span><br><span class="line">      <span class="string">&quot; WATERMARK FOR row_time AS row_time - INTERVAL &#x27;5&#x27; SECOND) &quot;</span> +</span><br><span class="line">      <span class="string">&quot; WITH (&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;connector&#x27;=&#x27;filesystem&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;path&#x27;=&#x27;D:\\Projects\\Flink-Table\\src\\main\\resources\\sensor.txt&#x27;,&quot;</span> +</span><br><span class="line">      <span class="string">&quot;&#x27;format&#x27;=&#x27;csv&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">    tableEnv.executeSql(fileSystemSql)</span><br><span class="line">    <span class="keyword">val</span> table: <span class="type">Table</span> = tableEnv.from(<span class="string">&quot;MyTable&quot;</span>)</span><br><span class="line"></span><br><span class="line">    tableEnv.createTemporarySystemFunction(<span class="string">&quot;myavg&quot;</span>, classOf[<span class="type">MyAvg</span>])</span><br><span class="line">    table.window(<span class="type">Tumble</span>.over(lit(<span class="number">1</span>).hour()).on($(<span class="string">&quot;row_time&quot;</span>)).as(<span class="string">&quot;w&quot;</span>))</span><br><span class="line">      .groupBy($(<span class="string">&quot;w&quot;</span>), $(<span class="string">&quot;id&quot;</span>))</span><br><span class="line">      .select($(<span class="string">&quot;id&quot;</span>).as(<span class="string">&quot;test&quot;</span>), call(<span class="string">&quot;myavg&quot;</span>, $(<span class="string">&quot;temp&quot;</span>)).as(<span class="string">&quot;avg&quot;</span>))</span><br><span class="line">      .toAppendStream[<span class="type">Row</span>].print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">CountAccumulator</span>(<span class="params">var count: <span class="type">Long</span>, var sum: <span class="type">Double</span></span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MyAvg</span> <span class="keyword">extends</span> <span class="title">AggregateFunction</span>[<span class="type">Double</span>, <span class="type">CountAccumulator</span>] </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸åŠ æŠ¥é”™</span></span><br><span class="line">    <span class="meta">@FunctionHint</span>(</span><br><span class="line">      input = <span class="type">Array</span>(<span class="keyword">new</span> <span class="type">DataTypeHint</span>(<span class="string">&quot;DOUBLE&quot;</span>)),</span><br><span class="line">      output = <span class="keyword">new</span> <span class="type">DataTypeHint</span>(<span class="string">&quot;DOUBLE&quot;</span>)</span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">accumulate</span></span>(acc: <span class="type">CountAccumulator</span>, param: <span class="type">Double</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">      acc.sum = acc.sum + param</span><br><span class="line">      acc.count = acc.count + <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getValue</span></span>(accumulator: <span class="type">CountAccumulator</span>): <span class="type">Double</span> = accumulator.sum / accumulator.count</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">createAccumulator</span></span>(): <span class="type">CountAccumulator</span> = <span class="type">CountAccumulator</span>(<span class="number">0</span>L, <span class="number">0.0</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è¡¨èšåˆå‡½æ•°ï¼ˆTable-Aggregate-Functionsï¼‰"><a href="#è¡¨èšåˆå‡½æ•°ï¼ˆTable-Aggregate-Functionsï¼‰" class="headerlink" title="è¡¨èšåˆå‡½æ•°ï¼ˆTable Aggregate Functionsï¼‰"></a>è¡¨èšåˆå‡½æ•°ï¼ˆTable Aggregate Functionsï¼‰</h3><p>= è¡¨å‡½æ•° + èšåˆå‡½æ•°</p><p>ç•¥ã€‚</p><hr><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@FunctionHint(output &#x3D; new DataTypeHint(&quot;ROW&lt;word STRING, length INT&gt;&quot;))</span><br></pre></td></tr></table></figure><p>æŒºé‡è¦çš„</p><p><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/functions/udfs.html#%E7%B1%BB%E5%9E%8B%E6%8E%A8%E5%AF%BC">Apache Flink 1.12 Documentation: è‡ªå®šä¹‰å‡½æ•°</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;æ•´ä½“ä»‹ç»&quot;&gt;&lt;a href=&quot;#æ•´ä½“ä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;æ•´ä½“ä»‹ç»&quot;&gt;&lt;/a&gt;æ•´ä½“ä»‹ç»&lt;/h1&gt;&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h</summary>
      
    
    
    
    <category term="Flink" scheme="https://awslzhang.top/categories/Flink/"/>
    
    
    <category term="Flink" scheme="https://awslzhang.top/tags/Flink/"/>
    
  </entry>
  
  <entry>
    <title>FlinkçŠ¶æ€ç¼–ç¨‹å’Œå®¹é”™æœºåˆ¶</title>
    <link href="https://awslzhang.top/2021/01/02/Flink%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/"/>
    <id>https://awslzhang.top/2021/01/02/Flink%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/</id>
    <published>2021-01-02T10:06:02.000Z</published>
    <updated>2021-01-04T14:06:37.882Z</updated>
    
    <content type="html"><![CDATA[<h1 id="FlinkçŠ¶æ€ç®¡ç†"><a href="#FlinkçŠ¶æ€ç®¡ç†" class="headerlink" title="FlinkçŠ¶æ€ç®¡ç†"></a>FlinkçŠ¶æ€ç®¡ç†</h1><p>æµå¼è®¡ç®—åˆ†ä¸º<strong>æ— çŠ¶æ€å’Œæœ‰çŠ¶æ€</strong>ä¸¤ç§æƒ…å†µã€‚æ— çŠ¶æ€çš„è®¡ç®—è§‚å¯Ÿæ¯ä¸ªç‹¬ç«‹äº‹ä»¶ï¼Œå¹¶æ ¹æ®æœ€åä¸€ä¸ªäº‹ä»¶è¾“å‡ºç»“æœã€‚ä¾‹å¦‚ï¼Œæµå¤„ç†åº”ç”¨ç¨‹åºä»ä¼ æ„Ÿå™¨æ¥æ”¶æ¸©åº¦è¯»æ•°ï¼Œå¹¶åœ¨æ¸©åº¦è¶…è¿‡90åº¦æ—¶å‘å‡ºè­¦å‘Šã€‚æœ‰çŠ¶æ€çš„è®¡ç®—åˆ™ä¼šåŸºäºå¤šä¸ªäº‹ä»¶è¾“å‡ºç»“æœã€‚ä»¥ä¸‹æ˜¯ä¸€äº›ä¾‹å­ã€‚</p><ul><li>æ‰€æœ‰ç±»å‹çš„çª—å£ã€‚ä¾‹å¦‚ï¼Œè®¡ç®—è¿‡å»ä¸€å°æ—¶çš„å¹³å‡æ¸©åº¦ï¼Œå°±æ˜¯æœ‰çŠ¶æ€çš„è®¡ç®—ã€‚</li><li>æ‰€æœ‰ç”¨äºå¤æ‚äº‹ä»¶å¤„ç†çš„çŠ¶æ€æœºã€‚ä¾‹å¦‚ï¼Œè‹¥åœ¨ä¸€åˆ†é’Ÿå†…æ”¶åˆ°ä¸¤ä¸ªç›¸å·®20åº¦ä»¥ä¸Šçš„æ¸©åº¦è¯»æ•°ï¼Œåˆ™å‘å‡ºè­¦å‘Šï¼Œè¿™æ˜¯æœ‰çŠ¶æ€çš„è®¡ç®—ã€‚</li><li>æµä¸æµä¹‹é—´çš„æ‰€æœ‰å…³è”æ“ä½œï¼Œä»¥åŠæµä¸é™æ€è¡¨æˆ–åŠ¨æ€è¡¨ä¹‹é—´çš„å…³è”æ“ä½œï¼Œéƒ½æ˜¯æœ‰çŠ¶æ€çš„è®¡ç®—ã€‚</li></ul><p>ä¸‹å›¾å±•ç¤ºäº†æ— çŠ¶æ€æµå¤„ç†å’Œæœ‰çŠ¶æ€æµå¤„ç†çš„ä¸»è¦åŒºåˆ«ã€‚æ— çŠ¶æ€æµå¤„ç†åˆ†åˆ«æ¥æ”¶æ¯æ¡æ•°æ®è®°å½•(å›¾ä¸­çš„é»‘æ¡)ï¼Œ<font color="red">ç„¶åæ ¹æ®æœ€æ–°è¾“å…¥çš„æ•°æ®ç”Ÿæˆè¾“å‡ºæ•°æ®(ç™½æ¡)</font>ã€‚æœ‰çŠ¶æ€æµå¤„ç†ä¼šç»´æŠ¤çŠ¶æ€(æ ¹æ®æ¯æ¡è¾“å…¥è®°å½•è¿›è¡Œæ›´æ–°)ï¼Œ<font color="red">å¹¶åŸºäºæœ€æ–°è¾“å…¥çš„è®°å½•å’Œå½“å‰çš„çŠ¶æ€å€¼ç”Ÿæˆè¾“å‡ºè®°å½•(ç°æ¡)ã€‚</font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210103155758486.png" alt="image-20210103155758486"></p><p>ä¸Šå›¾ä¸­è¾“å…¥æ•°æ®ç”±é»‘æ¡è¡¨ç¤ºã€‚æ— çŠ¶æ€æµå¤„ç†æ¯æ¬¡åªè½¬æ¢ä¸€æ¡è¾“å…¥è®°å½•ï¼Œå¹¶ä¸”ä»…æ ¹æ®æœ€æ–°çš„è¾“å…¥è®°å½•è¾“å‡ºç»“æœ(ç™½æ¡)ã€‚æœ‰çŠ¶æ€ æµå¤„ç†ç»´æŠ¤æ‰€æœ‰å·²å¤„ç†è®°å½•çš„çŠ¶æ€å€¼ï¼Œå¹¶æ ¹æ®æ¯æ¡æ–°è¾“å…¥çš„è®°å½•æ›´æ–°çŠ¶æ€ï¼Œå› æ­¤è¾“å‡ºè®°å½•(ç°æ¡)åæ˜ çš„æ˜¯ç»¼åˆè€ƒè™‘å¤šä¸ªäº‹ä»¶ä¹‹åçš„ç»“æœã€‚</p><p>å°½ç®¡æ— çŠ¶æ€çš„è®¡ç®—å¾ˆé‡è¦ï¼Œä½†æ˜¯æµå¤„ç†å¯¹æœ‰çŠ¶æ€çš„è®¡ç®—æ›´æ„Ÿå…´è¶£ã€‚äº‹å®ä¸Šï¼Œæ­£ç¡®åœ°å®ç°æœ‰çŠ¶æ€çš„è®¡ç®—æ¯”å®ç°æ— çŠ¶æ€çš„è®¡ç®—éš¾å¾—å¤šã€‚æ—§çš„æµå¤„ç†ç³»ç»Ÿå¹¶ä¸æ”¯æŒæœ‰çŠ¶æ€çš„è®¡ç®—ï¼Œè€Œæ–°ä¸€ä»£çš„æµå¤„ç†ç³»ç»Ÿåˆ™å°†çŠ¶æ€åŠå…¶æ­£ç¡®æ€§è§†ä¸ºé‡ä¸­ä¹‹é‡.</p><h2 id="æœ‰çŠ¶æ€çš„ç®—å­å’Œåº”ç”¨ç¨‹åº"><a href="#æœ‰çŠ¶æ€çš„ç®—å­å’Œåº”ç”¨ç¨‹åº" class="headerlink" title="æœ‰çŠ¶æ€çš„ç®—å­å’Œåº”ç”¨ç¨‹åº"></a>æœ‰çŠ¶æ€çš„ç®—å­å’Œåº”ç”¨ç¨‹åº</h2><p>Flinkå†…ç½®çš„å¾ˆå¤šç®—å­ï¼Œæ•°æ®æºsourceï¼Œæ•°æ®å­˜å‚¨sinkéƒ½æ˜¯æœ‰çŠ¶æ€çš„ï¼Œæµä¸­çš„æ•°æ®éƒ½æ˜¯buffer recordsï¼Œä¼šä¿å­˜ä¸€å®šçš„å…ƒç´ æˆ–è€…å…ƒæ•°æ®ã€‚ä¾‹å¦‚: ProcessWindowFunctionä¼šç¼“å­˜è¾“å…¥æµçš„æ•°æ®ï¼ŒProcessFunctionä¼šä¿å­˜è®¾ç½®çš„å®šæ—¶å™¨ä¿¡æ¯ç­‰ç­‰ã€‚</p><p>åœ¨Flinkä¸­ï¼Œ<font color="red"><strong>çŠ¶æ€å§‹ç»ˆä¸ç‰¹å®šç®—å­ç›¸å…³è”</strong></font>ã€‚æ€»çš„æ¥è¯´ï¼Œæœ‰ä¸¤ç§ç±»å‹çš„çŠ¶æ€ï¼š</p><ol><li>ç®—å­çŠ¶æ€ï¼ˆoperator stateï¼‰</li><li>é”®æ§çŠ¶æ€ï¼ˆkeyed stateï¼‰</li></ol><blockquote><p>å³Flinkçš„çŠ¶æ€æ˜¯ç”±ç®—å­ç»´æŠ¤çš„ï¼Œæ¯ä¸ªç®—å­çš„çŠ¶æ€éƒ½æ˜¯æœ¬ç®—å­çš„ï¼Œå…¶ä»–ç®—å­è®¿é—®ä¸åˆ°æœ¬ç®—å­çš„ã€‚</p><p>ç®—å­çŠ¶æ€å’Œé”®æ§çŠ¶æ€çš„åŒºåˆ«å°±æ˜¯ï¼š</p><ol><li>ç®—å­çŠ¶æ€çš„çŠ¶æ€æ˜¯å’Œç®—å­ç»‘å®šçš„ï¼Œç®—å­çš„çŠ¶æ€çš„è®¿é—®æƒé™æ˜¯æ­¤ç®—å­å¤„ç†çš„æ‰€æœ‰æ•°æ®ã€‚ä¸€ä¸ªç®—å­ä¸€ä¸ªçŠ¶æ€ã€‚å¹¶è¡Œåº¦å¢åŠ ï¼Œç®—å­å°±å¢åŠ ï¼ŒçŠ¶æ€å°±å¢åŠ </li><li>é”®æ§çŠ¶æ€çš„çŠ¶æ€æ˜¯å’Œkeyç»‘å®šçš„ï¼Œè®¿é—®æƒé™æ˜¯ç›¸åº”keyçš„æ•°æ®æ‰èƒ½è®¿é—®åˆ°å¯¹åº”keyçš„çŠ¶æ€ã€‚</li></ol></blockquote><hr><p>Flinkçš„çŠ¶æ€è¯´ç™½äº†å°±ç›¸å½“äºæœ¬åœ°å˜é‡ï¼Œä½†æ˜¯Flinkæä¾›äº†å¯¹å®ƒçš„ç®¡ç†ï¼šä¸€è‡´æ€§ã€æ•…éšœã€é«˜æ•ˆç‡å­˜å‚¨è®¿é—®ã€‚æ‰€ä»¥å½“ç¨‹åºæ•…éšœæ—¶ï¼ŒFlinkçš„ç®¡ç†æœºåˆ¶å¯ä»¥å®ç°ä»è¿œç¨‹è¯»å–ä¹‹å‰ä¿å­˜çš„çŠ¶æ€ç»§ç»­å¼€å§‹è®¡ç®—ï¼Œè€Œä¸æ˜¯çŠ¶æ€ä¸¢å¤±é‡æ–°è®¡ç®—ã€‚</p><h3 id="ç®—å­çŠ¶æ€ï¼ˆoperator-stateï¼‰"><a href="#ç®—å­çŠ¶æ€ï¼ˆoperator-stateï¼‰" class="headerlink" title="ç®—å­çŠ¶æ€ï¼ˆoperator stateï¼‰"></a>ç®—å­çŠ¶æ€ï¼ˆoperator stateï¼‰</h3><p>ç®—å­çŠ¶æ€çš„ä½œç”¨èŒƒå›´é™å®šä¸ºç®—å­ä»»åŠ¡ã€‚è¿™æ„å‘³ç€ç”±<strong>åŒä¸€å¹¶è¡Œä»»åŠ¡æ‰€å¤„ç†çš„æ‰€æœ‰æ•°æ®éƒ½å¯ä»¥è®¿é—®åˆ°ç›¸åŒçš„çŠ¶æ€</strong>ï¼ŒçŠ¶æ€å¯¹äºåŒä¸€ä»»åŠ¡è€Œè¨€æ˜¯å…±äº«çš„ã€‚ç®—å­çŠ¶æ€ä¸èƒ½ç”±ç›¸åŒæˆ–ä¸åŒç®—å­çš„å¦ä¸€ä¸ªä»»åŠ¡è®¿é—®ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210103161006283.png" alt="image-20210103161006283"></p><p>ç»“åˆå›¾æ¥è®²å°±æ˜¯å› ä¸ºå¹¶è¡Œåº¦taskçš„å¤šä¸ªä»»åŠ¡ï¼Œä¸åŒçš„ä»»åŠ¡ä¹‹é—´çš„çŠ¶æ€ä¸èƒ½è®¿é—®ã€‚è€Œç›¸åŒä»»åŠ¡ã€åˆ†åŒºä¸­è¢«å¤„ç†çš„æ•°æ®éƒ½å¯ä»¥è®¿é—®æœ¬ä»»åŠ¡ã€åˆ†åŒºä¸­çš„çŠ¶æ€ã€‚</p><h4 id="çŠ¶æ€æ•°æ®ç»“æ„"><a href="#çŠ¶æ€æ•°æ®ç»“æ„" class="headerlink" title="çŠ¶æ€æ•°æ®ç»“æ„"></a>çŠ¶æ€æ•°æ®ç»“æ„</h4><p>Flinkä¸ºç®—å­çŠ¶æ€æä¾›ä¸‰ç§åŸºæœ¬æ•°æ®ç»“æ„ï¼š</p><ol><li>åˆ—è¡¨çŠ¶æ€ï¼ˆList stateï¼‰ï¼šå°†çŠ¶æ€è¡¨ç¤ºä¸ºä¸€ç»„æ•°æ®çš„åˆ—è¡¨</li><li>è”åˆåˆ—è¡¨çŠ¶æ€ï¼ˆUnion list stateï¼‰ä¹Ÿå°†çŠ¶æ€è¡¨ç¤ºä¸ºæ•°æ®çš„åˆ—è¡¨ã€‚å®ƒä¸å¸¸è§„åˆ—è¡¨çŠ¶æ€çš„åŒºåˆ«åœ¨äºï¼Œåœ¨å‘ç”Ÿæ•…éšœæ—¶ï¼Œæˆ–è€…ä»ä¿å­˜ç‚¹ï¼ˆsavepointï¼‰å¯åŠ¨åº”ç”¨ç¨‹åºæ—¶å¦‚ä½•æ¢å¤ã€‚</li><li>å¹¿æ’­çŠ¶æ€ï¼ˆBroadcast stateï¼‰ï¼šå¦‚æœä¸€ä¸ªç®—å­æœ‰å¤šé¡¹ä»»åŠ¡ï¼Œè€Œå®ƒçš„æ¯é¡¹ä»»åŠ¡çŠ¶æ€åˆéƒ½ç›¸åŒï¼Œé‚£ä¹ˆè¿™ç§ç‰¹æ®Šæƒ…å†µæœ€é€‚åˆåº”ç”¨å¹¿æ’­çŠ¶æ€ã€‚</li></ol><h4 id="å¦‚ä½•ä½¿ç”¨"><a href="#å¦‚ä½•ä½¿ç”¨" class="headerlink" title="å¦‚ä½•ä½¿ç”¨"></a>å¦‚ä½•ä½¿ç”¨</h4><p>åªéœ€è¦å®ç°<code>ListCheckpointed</code>æ¥å£å³å¯ï¼Œå¹¶å®ç°å¿«ç…§å­˜å‚¨å’Œæ•…éšœæ¢å¤çš„æ–¹æ³•ã€‚å…¶ä½™å°±æ˜¯å’Œä½¿ç”¨æ­£å¸¸æœ¬åœ°å˜é‡ä¸€è‡´ã€‚</p><hr><p>ä¸€èˆ¬æ¥è®²ï¼ŒMapç®—å­è¿›è¡Œçš„éƒ½æ˜¯æ— çŠ¶æ€çš„è®¡ç®—ï¼Œè¿™æ¬¡æˆ‘ä»¬é€šè¿‡çŠ¶æ€å˜é‡é€šè¿‡mapçš„æ–¹å¼æ¥å±•ç°ï¼Œé€šè¿‡è®¡ç®—å…ƒç´ ä¸ªæ•°ï¼Œè¿™ä¸ªè®¡ç®—å’Œä¹‹å‰çš„æ•°æ®æœ‰è”ç³»ï¼Œæ‰€ä»¥éœ€è¦FlinkçŠ¶æ€å˜é‡</p><p>å½“ç„¶å¯ä»¥ç›´æ¥ä½¿ç”¨æœ¬åœ°å˜é‡ï¼Œç®—å­çŠ¶æ€çš„çŠ¶æ€å˜é‡å’Œæœ¬åœ°å˜é‡æœ¬èº«å‡ ä¹æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨çŠ¶æ€å˜é‡çš„è¯ï¼Œå¯¹äºç¨‹åºçš„checkpointä¿å­˜çš„å¼‚å¸¸æ¢å¤æœ‰æ•ˆæœï¼Œæ‰€ä»¥è¯·çœ‹ä¾‹å­ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.flink.transform</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util</span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Collections</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.<span class="type">MapFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.checkpoint.<span class="type">ListCheckpointed</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.example.flink.source.&#123;<span class="type">SensorReading</span>, <span class="type">SensorSource</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">OperatorState</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> value: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = env.addSource(<span class="keyword">new</span> <span class="type">SensorSource</span>)</span><br><span class="line">    value.map(<span class="keyword">new</span> <span class="type">MyMap</span>).print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MyMap</span> <span class="keyword">extends</span> <span class="title">MapFunction</span>[<span class="type">SensorReading</span>, <span class="type">Integer</span>] <span class="keyword">with</span> <span class="title">ListCheckpointed</span>[<span class="type">Integer</span>] </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> count: <span class="type">Integer</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">map</span></span>(t: <span class="type">SensorReading</span>): <span class="type">Integer</span> = &#123;</span><br><span class="line">      count = count + <span class="number">1</span></span><br><span class="line">      count</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®¹é”™æ¢å¤æ—¶ï¼Œæ‰¾åˆ°ä¹‹å‰å­˜å‚¨çš„å˜é‡</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">restoreState</span></span>(list: util.<span class="type">List</span>[<span class="type">Integer</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="keyword">import</span> collection.<span class="type">JavaConverters</span>._</span><br><span class="line">      list.asScala.foreach(count += _)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯¹çŠ¶æ€å˜é‡è¿›è¡Œå¿«ç…§å­˜å‚¨</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">snapshotState</span></span>(l: <span class="type">Long</span>, l1: <span class="type">Long</span>): util.<span class="type">List</span>[<span class="type">Integer</span>] = <span class="type">Collections</span>.singletonList(count)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é”®æ§çŠ¶æ€ï¼ˆkeyed-stateï¼‰"><a href="#é”®æ§çŠ¶æ€ï¼ˆkeyed-stateï¼‰" class="headerlink" title="é”®æ§çŠ¶æ€ï¼ˆkeyed stateï¼‰"></a>é”®æ§çŠ¶æ€ï¼ˆkeyed stateï¼‰</h3><p>é”®æ§çŠ¶æ€æ˜¯æ ¹æ®è¾“å…¥æ•°æ®æµä¸­<strong>å®šä¹‰çš„é”®ï¼ˆkeyï¼‰æ¥ç»´æŠ¤å’Œè®¿é—®çš„</strong>ã€‚<strong>Flinkä¸ºæ¯ä¸ªé”®å€¼ç»´æŠ¤ä¸€ä¸ªçŠ¶æ€å®ä¾‹ï¼Œå¹¶å°†å…·æœ‰ç›¸åŒé”®çš„æ‰€æœ‰æ•°æ®ï¼Œéƒ½åˆ†åŒºåˆ°åŒä¸€ä¸ªç®—å­ä»»åŠ¡ä¸­ï¼Œè¿™ä¸ªä»»åŠ¡ä¼šç»´æŠ¤å’Œå¤„ç†è¿™ä¸ªkeyå¯¹åº”çš„çŠ¶æ€ã€‚</strong>å½“ä»»åŠ¡å¤„ç†ä¸€æ¡æ•°æ®æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨å°†çŠ¶æ€çš„è®¿é—®èŒƒå›´é™å®šä¸ºå½“å‰æ•°æ®çš„keyã€‚<strong>å› æ­¤ï¼Œå…·æœ‰ç›¸åŒkeyçš„æ‰€æœ‰æ•°æ®éƒ½ä¼šè®¿é—®ç›¸åŒçš„çŠ¶æ€</strong>ã€‚Keyed Stateå¾ˆç±»ä¼¼äºä¸€ä¸ªåˆ†å¸ƒå¼çš„key-value mapæ•°æ®ç»“æ„ï¼Œ<font color="red"><strong>åªèƒ½ç”¨äºKeyedStreamï¼ˆkeyByç®—å­å¤„ç†ä¹‹åï¼‰ã€‚</strong></font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210103161339404.png" alt="image-20210103161339404"></p><h4 id="çŠ¶æ€æ•°æ®ç»“æ„-1"><a href="#çŠ¶æ€æ•°æ®ç»“æ„-1" class="headerlink" title="çŠ¶æ€æ•°æ®ç»“æ„"></a>çŠ¶æ€æ•°æ®ç»“æ„</h4><p>Flinkçš„Keyed Stateæ”¯æŒä»¥ä¸‹æ•°æ®ç±»å‹ï¼š</p><ol><li>ValueState[T]ä¿å­˜å•ä¸ªçš„å€¼ï¼Œå€¼çš„ç±»å‹ä¸ºTã€‚</li><li>ListState[T]ä¿å­˜ä¸€ä¸ªåˆ—è¡¨ï¼Œåˆ—è¡¨é‡Œçš„å…ƒç´ çš„æ•°æ®ç±»å‹ä¸ºTã€‚åŸºæœ¬æ“ä½œå¦‚ä¸‹ï¼š</li><li> MapState[K, V]ä¿å­˜Key-Valueå¯¹ã€‚</li><li>ReducingState[T]</li><li>AggregatingState[I, O]</li></ol><h4 id="å¦‚ä½•ä½¿ç”¨-1"><a href="#å¦‚ä½•ä½¿ç”¨-1" class="headerlink" title="å¦‚ä½•ä½¿ç”¨"></a>å¦‚ä½•ä½¿ç”¨</h4><p>å…¶å®åœ¨Flinkæ—¶é—´è¯­ä¹‰ä¸€æ–‡ä¸­å·²ç»ä½¿ç”¨äº†é”®æ§çŠ¶æ€ï¼Œå³1Så†…æ¸©åº¦è¿ç»­ä¸Šå‡æŠ¥è­¦ç¤ºä¾‹ã€‚</p><p>åœ¨ä»£ç ä¸­è¿™æ ·ä½¿ç”¨ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210103163621295.png" alt="image-20210103163621295"></p><p>å¤§å®¶å¯èƒ½æ³¨æ„åˆ°ï¼š</p><ol><li><code>getRuntimeContext</code>æ–¹æ³•ï¼Œå³å¦‚æœä½¿ç”¨é”®æ§çŠ¶æ€çš„è¯ï¼Œ<strong>å¿…é¡»ç»§æ‰¿å¯Œå‡½æ•°</strong></li><li>é”®æ§çŠ¶æ€çš„å£°æ˜å’Œèµ‹å€¼ä¸æ˜¯åœ¨ä¸€èµ·çš„ï¼Œè¿™æ˜¯å› ä¸ºå¦‚æœå£°æ˜å’Œèµ‹å€¼åœ¨ä¸€èµ·ï¼Œé‚£ä¹ˆå˜é‡åˆå§‹åŒ–æ—¶å°±è¦è°ƒç”¨<code>getRuntimeContext</code>ï¼Œä½†æ˜¯åœ¨æ²¡æœ‰è¿è¡Œåˆ°è¿™é‡Œæ—¶ï¼Œ<code>getRuntimeContext</code>æ˜¯æ²¡æœ‰å€¼çš„ï¼Œæ‰€ä»¥è¿™æ—¶æœ‰ä¸¤ç§è§£å†³åŠæ³•ï¼š<ol><li>ä½¿ç”¨scalaçš„lazyæ‡’åŠ è½½</li><li>èµ‹å€¼å†…å®¹å†™åœ¨open()æ–¹æ³•ä¸­</li></ol></li></ol><p>ç»§ä¸Šé¢çš„ä¾‹å­ï¼Œé€šè¿‡é”®æ§çŠ¶æ€å®ç°ï¼Œ<strong>è¿™æ—¶è®¡ç®—çš„æ˜¯æ¯ä¸ªkeyçš„æ•°é‡</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.flink.transform</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.<span class="type">RichMapFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.&#123;<span class="type">ValueState</span>, <span class="type">ValueStateDescriptor</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.scala.typeutils.<span class="type">Types</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.example.flink.source.&#123;<span class="type">SensorReading</span>, <span class="type">SensorSource</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">KeyedState</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> value: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = env.addSource(<span class="keyword">new</span> <span class="type">SensorSource</span>).keyBy(_.id)</span><br><span class="line">    value.map(<span class="keyword">new</span> <span class="type">MyMap</span>).print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MyMap</span> <span class="keyword">extends</span> <span class="title">RichMapFunction</span>[<span class="type">SensorReading</span>, <span class="type">Integer</span>] </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">lazy</span> <span class="keyword">private</span> <span class="keyword">val</span> count: <span class="type">ValueState</span>[<span class="type">Integer</span>] = getRuntimeContext.getState(<span class="keyword">new</span> <span class="type">ValueStateDescriptor</span>[<span class="type">Integer</span>](<span class="string">&quot;count&quot;</span>, <span class="type">Types</span>.of[<span class="type">Integer</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">map</span></span>(t: <span class="type">SensorReading</span>): <span class="type">Integer</span> = &#123;</span><br><span class="line">      <span class="keyword">if</span> (count.value()==<span class="literal">null</span>) count.update(<span class="number">0</span>)</span><br><span class="line">      <span class="keyword">val</span> integer: <span class="type">Integer</span> = count.value() + <span class="number">1</span></span><br><span class="line">      count.update(integer)</span><br><span class="line">      integer</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="çŠ¶æ€åç«¯"><a href="#çŠ¶æ€åç«¯" class="headerlink" title="çŠ¶æ€åç«¯"></a>çŠ¶æ€åç«¯</h2><p>çŠ¶æ€çš„å­˜å‚¨ã€è®¿é—®ä»¥åŠç»´æŠ¤ï¼Œç”±ä¸€ä¸ªå¯æ’å…¥çš„ç»„ä»¶å†³å®šï¼Œè¿™ä¸ªç»„ä»¶å°± å«åšçŠ¶æ€åç«¯ï¼ˆstate backendï¼‰</p><p>çŠ¶æ€åç«¯ä¸»è¦è´Ÿè´£ä¸¤ä»¶äº‹ï¼šæœ¬åœ°çš„çŠ¶æ€ç®¡ç†ï¼Œä»¥åŠå°†æ£€æŸ¥ç‚¹ ï¼ˆcheckpointï¼‰çŠ¶æ€å†™å…¥è¿œç¨‹å­˜å‚¨</p><p>ç”±äºæœ‰æ•ˆçš„çŠ¶æ€è®¿é—®å¯¹äºå¤„ç†æ•°æ®çš„ä½å»¶è¿Ÿè‡³å…³é‡è¦ï¼Œ<strong>å› æ­¤æ¯ä¸ªå¹¶è¡Œ ä»»åŠ¡éƒ½ä¼šåœ¨æœ¬åœ°ç»´æŠ¤å…¶çŠ¶æ€</strong>ï¼Œä»¥ç¡®ä¿å¿«é€Ÿçš„çŠ¶æ€è®¿é—®</p><h3 id="é€‰æ‹©ä¸€ä¸ªçŠ¶æ€åç«¯"><a href="#é€‰æ‹©ä¸€ä¸ªçŠ¶æ€åç«¯" class="headerlink" title="é€‰æ‹©ä¸€ä¸ªçŠ¶æ€åç«¯"></a><strong>é€‰æ‹©ä¸€ä¸ªçŠ¶æ€åç«¯</strong></h3><h4 id="MemoryStateBackend"><a href="#MemoryStateBackend" class="headerlink" title="MemoryStateBackend"></a><em>MemoryStateBackend</em></h4><p>å†…å­˜çº§çš„çŠ¶æ€åç«¯ï¼Œä¼šå°†é”®æ§çŠ¶æ€ä½œä¸ºå†…å­˜ä¸­çš„å¯¹è±¡è¿›è¡Œç®¡ç†ï¼Œå°†å®ƒä»¬å­˜å‚¨åœ¨ TaskManager çš„ å†…å­˜ä¸Šï¼Œè€Œå°† checkpoint å­˜å‚¨åœ¨ JobManager çš„å†…å­˜ ä¸­ </p><p>ç‰¹ç‚¹ï¼šå¿«é€Ÿã€ä½å»¶è¿Ÿï¼Œä½†ä¸ç¨³å®š</p><h4 id="FsStateBackend"><a href="#FsStateBackend" class="headerlink" title="FsStateBackend"></a><em>FsStateBackend</em></h4><p>å°† checkpoint å­˜åˆ°è¿œç¨‹çš„æŒä¹…åŒ–æ–‡ä»¶ç³»ç»Ÿï¼ˆFileSystemï¼‰ä¸Šï¼Œè€Œå¯¹äºæœ¬åœ°çŠ¶ æ€ï¼Œè·Ÿ MemoryStateBackend ä¸€æ ·ï¼Œä¹Ÿä¼šå­˜åœ¨ TaskManager çš„å†…å­˜ä¸Š</p><p> åŒæ—¶æ‹¥æœ‰å†…å­˜çº§çš„æœ¬åœ°è®¿é—®é€Ÿåº¦ï¼Œå’Œæ›´å¥½çš„å®¹é”™ä¿è¯</p><h4 id="RocksDBStateBackend"><a href="#RocksDBStateBackend" class="headerlink" title="RocksDBStateBackend"></a><em>RocksDBStateBackend</em></h4><p>å°†æ‰€æœ‰çŠ¶æ€åºåˆ—åŒ–åï¼Œå­˜å…¥æœ¬åœ°çš„ RocksDB ä¸­å­˜å‚¨</p><p>TaskManagerçš„çŠ¶æ€åªæ˜¯è¿›è¡Œç¼“å­˜ï¼Œå¹¶ä¸çœŸæ­£çš„å­˜åœ¨äºå†…å­˜</p><h3 id="å¦‚ä½•ä½¿ç”¨-2"><a href="#å¦‚ä½•ä½¿ç”¨-2" class="headerlink" title="å¦‚ä½•ä½¿ç”¨"></a>å¦‚ä½•ä½¿ç”¨</h3><p><code>env.setStateBackend(new FsStateBackend(&quot;&quot;))</code></p><p>Flinkå®˜æ–¹å¯ä»¥æ”¯æŒ<em>FsStateBackend</em>ã€<em>MemoryStateBackend</em>ï¼Œç¬¬ä¸‰ä¸ªä¹Ÿæ”¯æŒï¼Œä¸è¿‡éœ€è¦å¯¼åŒ…</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-statebackend-rocksdb_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="çŠ¶æ€ä¸€è‡´æ€§"><a href="#çŠ¶æ€ä¸€è‡´æ€§" class="headerlink" title="çŠ¶æ€ä¸€è‡´æ€§"></a>çŠ¶æ€ä¸€è‡´æ€§</h2><p>å½“åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¼•å…¥çŠ¶æ€æ—¶ï¼Œè‡ªç„¶ä¹Ÿå¼•å…¥äº†ä¸€è‡´æ€§é—®é¢˜ã€‚åªå¬çŠ¶æ€ä¸€è‡´æ€§æœ‰ç‚¹éš¾å¬æ‡‚ï¼Œå®ƒæœ¬è´¨å°±æ˜¯<font color="red"><strong>æˆåŠŸå¤„ç†æ•…éšœå¹¶æ¢å¤å‰åçš„ç»“æœçš„æ­£ç¡®æ€§çº§åˆ«</strong></font>ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´åœ¨æˆåŠŸå¤„ç†æ•…éšœå¹¶æ¢å¤ä¹‹åå¾—åˆ°çš„ç»“æœï¼Œä¸æ²¡æœ‰å‘ç”Ÿä»»ä½•æ•…éšœæ—¶å¾—åˆ°çš„ç»“æœç›¸æ¯”ï¼Œå‰è€…åˆ°åº•æœ‰å¤šæ­£ç¡®ï¼Ÿä¸¾ä¾‹æ¥è¯´ï¼Œå‡è®¾è¦å¯¹æœ€è¿‘ä¸€å°æ—¶ç™»å½•çš„ç”¨æˆ·è®¡æ•°ã€‚åœ¨ç³»ç»Ÿç»å†æ•…éšœä¹‹åï¼Œè®¡æ•°ç»“æœæ˜¯å¤šå°‘ï¼Ÿå¦‚æœæœ‰åå·®ï¼Œæ˜¯æœ‰æ¼æ‰çš„è®¡æ•°ï¼ˆæœ€å¤šä¸€æ¬¡ï¼‰è¿˜æ˜¯é‡å¤è®¡æ•°ï¼ˆæœ€å°‘ä¸€æ¬¡ï¼‰ï¼Ÿ</p><h3 id="ä¸€è‡´æ€§çº§åˆ«"><a href="#ä¸€è‡´æ€§çº§åˆ«" class="headerlink" title="ä¸€è‡´æ€§çº§åˆ«"></a>ä¸€è‡´æ€§çº§åˆ«</h3><p>åœ¨æµå¤„ç†ä¸­ï¼Œä¸€è‡´æ€§å¯ä»¥åˆ†ä¸º3ä¸ªçº§åˆ«ï¼š</p><ol><li><code>at-most-once</code>: è¿™å…¶å®æ˜¯æ²¡æœ‰æ­£ç¡®æ€§ä¿éšœçš„å§”å©‰è¯´æ³•â€”â€”æ•…éšœå‘ç”Ÿä¹‹åï¼Œè®¡æ•°ç»“æœå¯èƒ½ä¸¢å¤±ã€‚åŒæ ·çš„è¿˜æœ‰udpã€‚</li><li><code>at-least-once</code>: è¿™è¡¨ç¤ºè®¡æ•°ç»“æœå¯èƒ½å¤§äºæ­£ç¡®å€¼ï¼Œä½†ç»ä¸ä¼šå°äºæ­£ç¡®å€¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè®¡æ•°ç¨‹åºåœ¨å‘ç”Ÿæ•…éšœåå¯èƒ½å¤šç®—ï¼Œä½†æ˜¯ç»ä¸ä¼šå°‘ç®—ã€‚</li><li><code>exactly-once</code>: è¿™æŒ‡çš„æ˜¯ç³»ç»Ÿä¿è¯åœ¨å‘ç”Ÿæ•…éšœåå¾—åˆ°çš„è®¡æ•°ç»“æœä¸æ­£ç¡®å€¼ä¸€è‡´ã€‚</li></ol><p>Flinkçš„ä¸€ä¸ªé‡å¤§ä»·å€¼åœ¨äºï¼Œ<strong>å®ƒæ—¢ä¿è¯äº†exactly-onceï¼Œä¹Ÿå…·æœ‰ä½å»¶è¿Ÿå’Œé«˜ååçš„å¤„ç†èƒ½åŠ›ã€‚</strong></p><h3 id="ç«¯åˆ°ç«¯çš„ä¸€è‡´æ€§ğŸ”º"><a href="#ç«¯åˆ°ç«¯çš„ä¸€è‡´æ€§ğŸ”º" class="headerlink" title="ç«¯åˆ°ç«¯çš„ä¸€è‡´æ€§ğŸ”º"></a>ç«¯åˆ°ç«¯çš„ä¸€è‡´æ€§ğŸ”º</h3><p>ç›®å‰æˆ‘ä»¬çœ‹åˆ°çš„ä¸€è‡´æ€§ä¿è¯éƒ½æ˜¯ç”±æµå¤„ç†å™¨å®ç°çš„ï¼Œ<strong>ä¹Ÿå°±æ˜¯è¯´éƒ½æ˜¯åœ¨ Flink æµå¤„ç†å™¨å†…éƒ¨ä¿è¯çš„</strong>ï¼›è€Œåœ¨çœŸå®åº”ç”¨ä¸­ï¼Œæµå¤„ç†åº”ç”¨é™¤äº†æµå¤„ç†å™¨ä»¥å¤–è¿˜åŒ…å«äº†æ•°æ®æºï¼ˆä¾‹å¦‚ Kafkaï¼‰å’Œè¾“å‡ºåˆ°æŒä¹…åŒ–ç³»ç»Ÿã€‚</p><p>å³ç«¯åˆ°ç«¯ä¸€è‡´æ€§æŒ‡çš„æ˜¯ä»Source-Flinkå†…éƒ¨ç¨‹åº-SinkæŒä¹…åŒ–ç³»ç»Ÿï¼ŒçŠ¶æ€çš„ä¸€è‡´æ€§å³ç»“æœçš„æ­£ç¡®æ€§è´¯ç©¿äº†æ•´ä¸ªæµå¤„ç†åº”ç”¨çš„å§‹ç»ˆã€‚</p><p>æ¯ä¸€ä¸ªç»„ä»¶éƒ½ä¿è¯äº†å®ƒè‡ªå·±çš„ä¸€è‡´æ€§ï¼Œ<font color="red">æ•´ä¸ªç«¯åˆ°ç«¯çš„ä¸€è‡´æ€§çº§åˆ«å–å†³äºæ‰€æœ‰ç»„ä»¶ä¸­ä¸€è‡´æ€§æœ€å¼±çš„ç»„ä»¶</font>ã€‚å…·ä½“å¯ä»¥åˆ’åˆ†å¦‚ä¸‹ï¼š</p><ul><li>å†…éƒ¨ä¿è¯ â€”â€” <strong>ä¾èµ–checkpoint</strong></li><li>source ç«¯ â€”â€” éœ€è¦å¤–éƒ¨æº<strong>å¯é‡è®¾æ•°æ®çš„è¯»å–ä½ç½®</strong></li><li>sink ç«¯ â€”â€” éœ€è¦ä¿è¯ä»æ•…éšœæ¢å¤æ—¶ï¼Œ<strong>æ•°æ®ä¸ä¼šé‡å¤å†™å…¥å¤–éƒ¨ç³»ç»Ÿ</strong></li></ul><p>è€Œå¯¹äºsinkç«¯ï¼Œåˆæœ‰ä¸¤ç§å…·ä½“çš„å®ç°æ–¹å¼ï¼š</p><ol><li>å¹‚ç­‰ï¼ˆIdempotentï¼‰å†™å…¥ã€‚</li><li>äº‹åŠ¡æ€§ï¼ˆTransactionalï¼‰å†™å…¥ã€‚</li></ol><h4 id="å¹‚ç­‰å†™å…¥"><a href="#å¹‚ç­‰å†™å…¥" class="headerlink" title="å¹‚ç­‰å†™å…¥"></a>å¹‚ç­‰å†™å…¥</h4><p>æ‰€è°“å¹‚ç­‰æ“ä½œï¼Œæ˜¯è¯´ä¸€ä¸ªæ“ä½œï¼Œå¯ä»¥é‡å¤æ‰§è¡Œå¾ˆå¤šæ¬¡ï¼Œä½†åªå¯¼è‡´ä¸€æ¬¡ç»“æœæ›´æ”¹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåé¢å†é‡å¤æ‰§è¡Œå°±ä¸èµ·ä½œç”¨äº†ã€‚</p><p>ä½†æ˜¯å®ƒçš„ç»“æœä¼šæœ‰ä¸€ä¸ªæ¸å˜çš„æµç¨‹ï¼Œä¾‹å¦‚æ±‚æœ€å¤§æ¸©åº¦ï¼š</p><p>1-&gt;2-&gt;10ï¼Œæ­¤æ—¶æ•…éšœä»ä¸Šä¸€æ£€æŸ¥ç‚¹å¤„é‡æ–°è®¡ç®—ï¼Œ2-&gt;10-&gt;12ã€‚æœ€ç»ˆçš„SInkæ•°æ®æµä¸º1-&gt;2-&gt;10-&gt;2-&gt;10-&gt;12ã€‚è™½ç„¶æœ€ç»ˆç»“æœæ— è¯¯ï¼Œä½†æ˜¯æµç¨‹çœ‹èµ·æ¥ä¸å¥½ï¼Œå¦‚æœè¿™äº›æ•°æ®è¦å®æ—¶å±•ç¤ºï¼Œåˆ™ä¼šç»™äººè¯¯è§£ã€‚</p><h4 id="äº‹åŠ¡æ€§å†™å…¥ğŸ”º"><a href="#äº‹åŠ¡æ€§å†™å…¥ğŸ”º" class="headerlink" title="äº‹åŠ¡æ€§å†™å…¥ğŸ”º"></a>äº‹åŠ¡æ€§å†™å…¥ğŸ”º</h4><p>éœ€è¦æ„å»ºäº‹åŠ¡æ¥å†™å…¥å¤–éƒ¨ç³»ç»Ÿï¼Œæ„å»ºçš„äº‹åŠ¡å¯¹åº”ç€ checkpointï¼Œç­‰åˆ° checkpoint çœŸæ­£å®Œæˆçš„æ—¶å€™ï¼Œæ‰æŠŠæ‰€æœ‰å¯¹åº”çš„ç»“æœå†™å…¥ sink ç³»ç»Ÿä¸­ã€‚</p><p>å¯¹äºäº‹åŠ¡æ€§å†™å…¥ï¼Œå…·ä½“åˆæœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼šé¢„å†™æ—¥å¿—ï¼ˆWALï¼‰å’Œä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰ã€‚DataStream API æä¾›äº†<code>GenericWriteAheadSink</code>æ¨¡æ¿ç±»å’Œ<code>TwoPhaseCommitSinkFunction </code>æ¥å£ï¼Œå¯ä»¥æ–¹ä¾¿åœ°å®ç°è¿™ä¸¤ç§æ–¹å¼çš„äº‹åŠ¡æ€§å†™å…¥ã€‚</p><blockquote><p>é¢„å†™æ—¥å¿—ï¼ˆWALï¼‰å¹¶ä¸æ˜¯çœŸæ­£çš„<code>exactly-once</code>ï¼Œå½“æ‰¹é‡å†™å…¥Sinkæ—¶ï¼Œå¦‚æœä¸­é€”å‡ºé”™ï¼Œä»checkpointå›æ”¾æ•°æ®ï¼Œåˆ™ä¼šå¯¼è‡´æ•°æ®é‡å¤æ’å…¥</p><p>ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰æ‰æ˜¯çœŸæ­£çš„<code>exactly-once</code>ï¼Œä½†æ˜¯å®ƒéœ€è¦å†™å…¥çš„ç³»ç»Ÿæ”¯æŒäº‹åŠ¡ï¼Œå¹¶ä¸”äº‹åŠ¡çš„è¶…æ—¶æ—¶é—´æœ€å¥½å’Œcheckpointçš„è¶…æ—¶æ—¶é—´ä¸€è‡´ã€‚</p><p>[ä¸¤é˜¶æ®µæäº¤ä¿è¯ExactlyOnce](#Exactly-once ä¸¤é˜¶æ®µæäº¤)</p></blockquote><p><strong>ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰</strong></p><ul><li>å¯¹äºæ¯ä¸ª checkpointï¼Œsink ä»»åŠ¡ä¼šå¯åŠ¨ä¸€ä¸ªäº‹åŠ¡ï¼Œå¹¶å°†æ¥ä¸‹æ¥æ‰€æœ‰ æ¥æ”¶çš„æ•°æ®æ·»åŠ åˆ°äº‹åŠ¡é‡Œ</li><li>ç„¶åå°†è¿™äº›æ•°æ®å†™å…¥å¤–éƒ¨ sink ç³»ç»Ÿï¼Œä½†ä¸æäº¤å®ƒä»¬ â€”â€” è¿™æ—¶åªæ˜¯ â€œé¢„æäº¤â€</li><li>å½“å®ƒæ”¶åˆ° checkpoint å®Œæˆçš„é€šçŸ¥æ—¶ï¼Œå®ƒæ‰æ­£å¼æäº¤äº‹åŠ¡ï¼Œå®ç°ç»“æœ çš„çœŸæ­£å†™å…¥</li><li>è¿™ç§æ–¹å¼çœŸæ­£å®ç°äº† exactly-onceï¼Œå®ƒéœ€è¦ä¸€ä¸ªæä¾›äº‹åŠ¡æ”¯æŒçš„å¤–éƒ¨ sink ç³»ç»Ÿã€‚Flink æä¾›äº† TwoPhaseCommitSinkFunction æ¥å£</li></ul><h3 id="ä¸åŒ-Source-å’Œ-Sink-çš„ä¸€è‡´æ€§ä¿è¯"><a href="#ä¸åŒ-Source-å’Œ-Sink-çš„ä¸€è‡´æ€§ä¿è¯" class="headerlink" title="ä¸åŒ Source å’Œ Sink çš„ä¸€è‡´æ€§ä¿è¯"></a>ä¸åŒ Source å’Œ Sink çš„ä¸€è‡´æ€§ä¿è¯</h3><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210104211430912.png" alt="image-20210104211430912"></p><h3 id="Flink-Kafka-ç«¯åˆ°ç«¯çŠ¶æ€ä¸€è‡´æ€§çš„ä¿è¯"><a href="#Flink-Kafka-ç«¯åˆ°ç«¯çŠ¶æ€ä¸€è‡´æ€§çš„ä¿è¯" class="headerlink" title="Flink+Kafka ç«¯åˆ°ç«¯çŠ¶æ€ä¸€è‡´æ€§çš„ä¿è¯"></a>Flink+Kafka ç«¯åˆ°ç«¯çŠ¶æ€ä¸€è‡´æ€§çš„ä¿è¯</h3><ul><li>å†…éƒ¨ â€”â€” åˆ©ç”¨ checkpoint æœºåˆ¶ï¼ŒæŠŠçŠ¶æ€å­˜ç›˜ï¼Œå‘ç”Ÿæ•…éšœçš„æ—¶å€™ä»¥æ¢ å¤ï¼Œä¿è¯å†…éƒ¨çš„çŠ¶æ€ä¸€è‡´æ€§</li><li>source â€”â€” kafka consumer ä½œä¸º sourceï¼Œå¯ä»¥å°†åç§»é‡ä¿å­˜ä¸‹æ¥ï¼Œ å¦‚æœåç»­ä»»åŠ¡å‡ºç°äº†æ•…éšœï¼Œæ¢å¤çš„æ—¶å€™å¯ä»¥ç”±è¿æ¥å™¨é‡ç½®åç§»é‡ï¼Œé‡æ–° æ¶ˆè´¹æ•°æ®ï¼Œä¿è¯ä¸€è‡´æ€§</li><li>sink â€”â€” kafka producer ä½œä¸ºsinkï¼Œé‡‡ç”¨ä¸¤é˜¶æ®µæäº¤ sinkï¼Œéœ€è¦å®ç° ä¸€ä¸ª TwoPhaseCommitSinkFunction</li></ul><h1 id="å®¹é”™æœºåˆ¶"><a href="#å®¹é”™æœºåˆ¶" class="headerlink" title="å®¹é”™æœºåˆ¶"></a>å®¹é”™æœºåˆ¶</h1><p>Flinkå…·ä½“å¦‚ä½•ä¿è¯exactly-onceå‘¢? å®ƒä½¿ç”¨ä¸€ç§è¢«ç§°ä¸ºâ€æ£€æŸ¥ç‚¹â€ï¼ˆcheckpointï¼‰çš„ç‰¹æ€§ï¼Œåœ¨å‡ºç°æ•…éšœæ—¶å°†ç³»ç»Ÿé‡ç½®å›æ­£ç¡®çŠ¶æ€ã€‚</p><p>è¯´åˆ°å®¹é”™æœºåˆ¶ï¼Œå°±æ˜¯Flinkåº”ç”¨ç¨‹åºåœ¨é‡åˆ°é—®é¢˜æ—¶çš„è®¡ç®—ç»“æœæ˜¯å¦è¿˜æ­£ç¡®çš„é—®é¢˜ã€‚</p><p><strong>Flinkå®¹é”™æœºåˆ¶çš„æ ¸å¿ƒå°±æ˜¯åº”ç”¨çŠ¶æ€çš„ä¸€è‡´æ€§æ£€æŸ¥ç‚¹</strong>ï¼Œå®ƒæ˜¯é€šè¿‡åº”ç”¨çŠ¶æ€çš„ä¸€è‡´æ€§æ£€æŸ¥ç‚¹æ¥å®ç°æ•…éšœæ¢å¤çš„ï¼</p><p>æœ‰çŠ¶æ€æµåº”ç”¨çš„ä¸€è‡´æ£€æŸ¥ç‚¹ï¼Œå…¶å®å°±æ˜¯æ‰€æœ‰ä»»åŠ¡çš„çŠ¶æ€ï¼Œåœ¨æŸä¸ªæ—¶é—´ç‚¹çš„ä¸€ä»½ æ‹·è´ï¼ˆä¸€ä»½å¿«ç…§ï¼‰ï¼›<font color="red"><strong>è¿™ä¸ªæ—¶é—´ç‚¹ï¼Œåº”è¯¥æ˜¯æ‰€æœ‰ä»»åŠ¡éƒ½æ°å¥½å¤„ç†å®Œä¸€ä¸ªç›¸åŒçš„è¾“ å…¥æ•°æ®çš„æ—¶å€™</strong>ï¼Œè€Œä¸æ˜¯åŒä¸€æ—¶åˆ»åŒæ—¶å­˜å‚¨å„ä¸ªç®—å­çš„çŠ¶æ€</font>ã€‚</p><blockquote><p>å¦‚æœä¸æ˜¯è¿™æ ·å¿…ç„¶ä¼šå¯¼è‡´æ•…éšœæ—¶æœ‰çš„ç®—å­è®¡ç®—äº†æ•°æ®næœ‰çš„æ²¡æœ‰è®¡ç®—ï¼Œé‚£ä¹ˆæ•…éšœæ¢å¤æ—¶æ•°æ®nè¿˜è¦è¢«é‡æ”¾å—ï¼Œè¡¥å……æ”¾ä¹‹å‰æ²¡æœ‰è®¡ç®—çš„ç®—å­ä¸¢å¤±äº†æ­¤æ•°æ®ï¼Œé‡æ”¾çš„è¯ä¹‹å‰è®¡ç®—äº†æ­¤æ•°æ®çš„ç®—å­é‡å¤è®¡ç®—äº†æ­¤æ•°æ®ã€‚</p></blockquote><h2 id="ä»æ£€æŸ¥ç‚¹æ¢å¤çŠ¶æ€"><a href="#ä»æ£€æŸ¥ç‚¹æ¢å¤çŠ¶æ€" class="headerlink" title="ä»æ£€æŸ¥ç‚¹æ¢å¤çŠ¶æ€"></a>ä»æ£€æŸ¥ç‚¹æ¢å¤çŠ¶æ€</h2><p>åœ¨æ‰§è¡Œæµåº”ç”¨ç¨‹åºæœŸé—´ï¼ŒFlink ä¼šå®šæœŸä¿å­˜çŠ¶æ€çš„ä¸€è‡´æ£€æŸ¥ç‚¹</p><p>å¦‚æœå‘ç”Ÿæ•…éšœï¼Œ Flink å°†ä¼šä½¿ç”¨æœ€è¿‘çš„æ£€æŸ¥ç‚¹æ¥ä¸€è‡´æ¢å¤åº”ç”¨ç¨‹åºçš„çŠ¶æ€ï¼Œå¹¶ é‡æ–°å¯åŠ¨å¤„ç†æµç¨‹ï¼š</p><blockquote><p>é‡åˆ°æ•…éšœä¹‹åï¼Œç¬¬ä¸€æ­¥å°±æ˜¯é‡å¯åº”ç”¨</p></blockquote><blockquote><p>ç¬¬äºŒæ­¥æ˜¯ä» checkpoint ä¸­è¯»å–çŠ¶æ€ï¼Œå°†çŠ¶æ€é‡ç½®</p><p>ä»æ£€æŸ¥ç‚¹é‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åºåï¼Œå…¶å†…éƒ¨çŠ¶æ€ä¸æ£€æŸ¥ç‚¹å®Œæˆæ—¶çš„çŠ¶æ€å®Œå…¨ç›¸åŒ</p></blockquote><blockquote><p>ç¬¬ä¸‰æ­¥ï¼šå¼€å§‹æ¶ˆè´¹å¹¶å¤„ç†æ£€æŸ¥ç‚¹åˆ°å‘ç”Ÿæ•…éšœä¹‹é—´çš„æ‰€æœ‰æ•°æ®</p><p>è¿™ç§æ£€æŸ¥ç‚¹çš„ä¿å­˜å’Œæ¢å¤æœºåˆ¶å¯ä»¥ä¸ºåº”ç”¨ç¨‹åºçŠ¶æ€æä¾›<strong>â€œç²¾ç¡®ä¸€æ¬¡â€ ï¼ˆexactly-onceï¼‰çš„ä¸€è‡´æ€§</strong>ï¼Œå› ä¸ºæ‰€æœ‰ç®—å­éƒ½ä¼šä¿å­˜æ£€æŸ¥ç‚¹å¹¶æ¢å¤å…¶æ‰€æœ‰çŠ¶ æ€ï¼Œè¿™æ ·ä¸€æ¥æ‰€æœ‰çš„è¾“å…¥æµå°±éƒ½ä¼šè¢«é‡ç½®åˆ°æ£€æŸ¥ç‚¹å®Œæˆæ—¶çš„ä½ç½®ï¼ˆä½†æ˜¯éœ€è¦Sourceçš„ç»„ä»¶æ”¯æŒæ•°æ®å›æ”¾ï¼Œå¦‚æœæ˜¯sockæµçš„è¯å°±GGäº†ï¼‰</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210104212513441.png" alt="image-20210104212513441"></p><h2 id="æ£€æŸ¥ç‚¹çš„å®ç°ç®—æ³•ğŸ”º"><a href="#æ£€æŸ¥ç‚¹çš„å®ç°ç®—æ³•ğŸ”º" class="headerlink" title="æ£€æŸ¥ç‚¹çš„å®ç°ç®—æ³•ğŸ”º"></a>æ£€æŸ¥ç‚¹çš„å®ç°ç®—æ³•ğŸ”º</h2><p>æ£€æŸ¥ç‚¹çš„å®ç°ç®—æ³•æœ‰ï¼š</p><ol><li>æš‚åœåº”ç”¨ï¼Œä¿å­˜çŠ¶æ€åˆ°æ£€æŸ¥ç‚¹ï¼Œå†é‡æ–°æ¢å¤åº”ç”¨ï¼ˆFlinkä¸æ˜¯è¿™ä¸€ç§ï¼‰</li><li>å¼‚æ­¥ï¼ŒåŸºäº Chandy-Lamport ç®—æ³•çš„åˆ†å¸ƒå¼å¿«ç…§ï¼Œå°†æ£€æŸ¥ç‚¹çš„ä¿å­˜å’Œæ•°æ®å¤„ç†åˆ†ç¦»å¼€ï¼Œä¸æš‚åœæ•´ä¸ªåº”ç”¨ï¼ˆFlinkï¼‰</li></ol><blockquote><p>å³æ¯ä¸ªç®—å­éƒ½å•ç‹¬çš„å»ä¿å­˜çŠ¶æ€åˆ°çŠ¶æ€åç«¯ï¼Œåœ¨ç®—å­åœ¨è·å–åˆ°æ£€æŸ¥ç‚¹å±éšœæ—¶ï¼Œç›´æ¥å°†çŠ¶æ€æ›´æ–°åˆ°çŠ¶æ€åç«¯ï¼Œç„¶åç»§ç»­è®¡ç®—åé¢çš„æ•°æ®ï¼Œè€Œæ£€æŸ¥ç‚¹å±éšœä¹Ÿå‘é€ç»™åé¢çš„ç®—å­ï¼Œåé¢çš„ç®—å­ä¹Ÿå’Œå‰é¢ç®—å­çš„å¤„ç†é€»è¾‘ä¸€æ ·ï¼Œæ‰€ä»¥åŒä¸€æ£€æŸ¥ç‚¹çš„å„ä¸ªç®—å­çš„çŠ¶æ€å¹¶ä¸æ˜¯åŒä¸€æ—¶åˆ»ä¿å­˜åˆ°çŠ¶æ€åç«¯çš„ã€‚</p></blockquote><p><strong>Flink æ£€æŸ¥ç‚¹ç®—æ³•</strong></p><p>æ£€æŸ¥ç‚¹åˆ†ç•Œçº¿ï¼ˆCheckpoint Barrierï¼‰</p><ul><li>Flink çš„æ£€æŸ¥ç‚¹ç®—æ³•ç”¨åˆ°äº†ä¸€ç§ç§°ä¸º<strong>åˆ†ç•Œçº¿ï¼ˆbarrierï¼‰</strong>çš„ç‰¹æ®Šæ•°æ®å½¢å¼ï¼ˆç±»ä¼¼äºWaterMarkï¼‰ï¼Œ ç”¨æ¥æŠŠä¸€æ¡æµä¸Š<strong>æ•°æ®æŒ‰ç…§ä¸åŒçš„æ£€æŸ¥ç‚¹åˆ†å¼€</strong></li><li><strong>åˆ†ç•Œçº¿ä¹‹å‰åˆ°æ¥çš„æ•°æ®å¯¼è‡´çš„çŠ¶æ€æ›´æ”¹ï¼Œéƒ½ä¼šè¢«åŒ…å«åœ¨å½“å‰åˆ†ç•Œçº¿æ‰€å± çš„æ£€æŸ¥ç‚¹ä¸­ï¼›è€ŒåŸºäºåˆ†ç•Œçº¿ä¹‹åçš„æ•°æ®å¯¼è‡´çš„æ‰€æœ‰æ›´æ”¹ï¼Œå°±ä¼šè¢«åŒ…å«åœ¨ ä¹‹åçš„æ£€æŸ¥ç‚¹ä¸­</strong></li></ul><h3 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h3><p>ç°åœ¨æ˜¯ä¸€ä¸ªæœ‰ä¸¤ä¸ªè¾“å…¥æµçš„åº”ç”¨ç¨‹åºï¼Œç”¨å¹¶è¡Œçš„ä¸¤ä¸ª Source ä»»åŠ¡æ¥è¯»å–</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210104213222043.png" alt="image-20210104213222043"></p><p>ç„¶åç”±JobManageråè°ƒå‘å‡ºç»™æ‰€æœ‰å¹¶è¡Œçš„Sourceä»»åŠ¡å‘é€ä¸€æ¡å¸¦æœ‰æ–°æ£€æŸ¥ç‚¹ ID çš„æ¶ˆæ¯ï¼Œé€šè¿‡è¿™ ç§æ–¹å¼æ¥å¯åŠ¨æ£€æŸ¥ç‚¹</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210104213323571.png" alt="image-20210104213323571"></p><p>æ•°æ®æºå°†å®ƒä»¬çš„çŠ¶æ€å†™å…¥æ£€æŸ¥ç‚¹ï¼Œå¹¶å‘å‡ºä¸€ä¸ªæ£€æŸ¥ç‚¹ barrierã€‚çŠ¶æ€åç«¯åœ¨çŠ¶æ€å­˜å…¥æ£€æŸ¥ç‚¹ä¹‹åï¼Œä¼šè¿”å›é€šçŸ¥ç»™ source ä»»åŠ¡ï¼Œsource ä»»åŠ¡å°±ä¼š å‘ JobManager ç¡®è®¤æ£€æŸ¥ç‚¹å®Œæˆã€‚</p><p>ä¾‹å¦‚ä¸‹å›¾ï¼ŒSource1ã€Source2åœ¨ç»è¿‡Barrieråï¼Œç›´æ¥å°†çŠ¶æ€å‘é€åˆ°çŠ¶æ€åç«¯ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210104213517551.png" alt="image-20210104213517551"></p><p>ä½†æ˜¯ï¼Œç”±äºå¹¶è¡Œåº¦ï¼ŒBarrierçš„ä¼ é€’ä¹Ÿæ˜¯å’ŒWaterMarkç±»ä¼¼çš„ï¼Œ<font color="red">éƒ½æ˜¯å¹¿æ’­çš„æ–¹å¼å‘é€ç»™ä¸‹æ¸¸æ‰€æœ‰ç®—å­</font>ã€‚<font color="red">ä¸‹æ¸¸ç®—å­æ¥æ”¶åˆ°ä¸Šæ¸¸æ‰€æœ‰çš„Barrierå</font>æ‰å¼€å§‹å°†å½“å‰çŠ¶æ€å‘é€ç»™StateBackendã€‚<strong>è¿™è¢«ç§°ä¸ºåˆ†ç•Œçº¿å¯¹é½</strong></p><p>æ—¢ç„¶ä¸‹æ¸¸ç®—å­æ¥æ”¶åˆ°ä¸Šæ¸¸çš„æ‰€æœ‰Barrieråæ‰å¼€å§‹ä¿å­˜çŠ¶æ€ï¼Œé‚£å°±å¿…ç„¶é¢ä¸´ç€Barrieråˆ°è¾¾å…ˆåçš„é—®é¢˜ï¼Œå¦‚ä¸‹å›¾<code>Sum Even</code>éœ€è¦æ¥æ”¶åˆ°è“2ä¸é»„2æ‰èƒ½ä¿å­˜çŠ¶æ€ã€‚</p><ol><li>ä½†æ˜¯å¦‚æœæ­¤æ—¶çš„åˆ°è¾¾é¡ºåºä¸ºè“2ï¼ŒSource1çš„æ•°æ®4ï¼Œé»„2ï¼›åˆ™Source1çš„æ•°æ®4ä¸ä¼šè¢«åŠ å…¥çŠ¶æ€è€Œæ˜¯è¢«ç¼“å­˜</li><li>ä½†æ˜¯å¦‚æœæ­¤æ—¶çš„åˆ°è¾¾é¡ºåºä¸ºè“2ï¼ŒSource2çš„æ•°æ®4ï¼Œé»„2ï¼›åˆ™Source2çš„æ•°æ®4ä¼šè¢«åŠ å…¥çŠ¶æ€</li></ol><blockquote><p>å¯¹äºbarrierå·²ç»åˆ°è¾¾çš„åˆ†åŒºï¼Œç»§ç»­åˆ°è¾¾çš„æ•°æ®ä¼šè¢«ç¼“å­˜</p><p>è€Œbarrierå°šæœªåˆ°è¾¾çš„åˆ†åŒºï¼Œæ•°æ®ä¼šè¢«æ­£å¸¸å¤„ç†</p><hr><p>å› ä¸ºå¯¹äºbarrierå·²ç»åˆ°è¾¾çš„åˆ†åŒºï¼Œå¦‚æœç»§ç»­è®¡ç®—åŠ å…¥çŠ¶æ€çš„è¯ï¼Œå½“æ£€æŸ¥ç‚¹æ•…éšœæ¢å¤æ—¶ç»§ç»­åŠ å…¥çš„æ•°æ®ä¼šè¢«é‡æ”¾ï¼Œå†æ¬¡åŠ å…¥çŠ¶æ€ï¼Œå°±å¯¼è‡´äº†è¿™ä¸ªæ•°æ®è¢«è®¡ç®—äº†2æ¬¡ï¼Œå°±ä¸æ˜¯exactly onceäº†</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210104214139282.png" alt="image-20210104214139282"></p><p>å½“æ”¶åˆ°æ‰€æœ‰è¾“å…¥åˆ†åŒºçš„ barrier æ—¶ï¼Œä»»åŠ¡å°±å°†å…¶çŠ¶æ€ä¿å­˜åˆ°çŠ¶æ€åç«¯çš„æ£€æŸ¥ç‚¹ä¸­ï¼Œ ç„¶åå°† barrier ç»§ç»­å‘ä¸‹æ¸¸è½¬å‘ã€‚å‘ä¸‹æ¸¸è½¬å‘æ£€æŸ¥ç‚¹ barrier åï¼Œä»»åŠ¡ç»§ç»­æ­£å¸¸çš„æ•°æ®å¤„ç†</p><p>Sink ä»»åŠ¡å‘ JobManager ç¡®è®¤çŠ¶æ€ä¿å­˜åˆ° checkpoint å®Œæ¯•</p><p>å½“æ‰€æœ‰ä»»åŠ¡éƒ½ç¡®è®¤å·²æˆåŠŸå°†çŠ¶æ€ä¿å­˜åˆ°æ£€æŸ¥ç‚¹æ—¶ï¼Œæ£€æŸ¥ç‚¹å°±çœŸæ­£å®Œæˆäº†</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210104214755905.png" alt="image-20210104214755905"></p><h2 id="ä¿å­˜ç‚¹"><a href="#ä¿å­˜ç‚¹" class="headerlink" title="ä¿å­˜ç‚¹"></a>ä¿å­˜ç‚¹</h2><p>æ˜¯Flinkç‰¹æœ‰çš„åŠŸèƒ½ï¼Œå®ƒä¸æ£€æŸ¥ç‚¹çš„åŒºåˆ«å°±æ˜¯ä¸€ä¸ªæ˜¯æ‰‹åŠ¨è§¦å‘çš„ï¼›ä¸€ä¸ªæ˜¯JobManagerå‘¨æœŸæ€§è§¦å‘çš„ã€‚</p><p>ä¿å­˜ç‚¹å°±æ˜¯è‡ªå®šä¹‰çš„é•œåƒä¿å­˜åŠŸèƒ½ï¼Œå°†æ•°æ®ä¿å­˜åˆ°æŒ‡å®šåœ°æ–¹ã€‚å¯ä»¥é€šè¿‡æ•°æ®å¯åŠ¨ç¨‹åº</p><p><strong>ç‰¹ç‚¹ï¼š</strong></p><ol><li>åŸåˆ™ä¸Šï¼Œåˆ›å»ºä¿å­˜ç‚¹ä½¿ç”¨çš„ç®—æ³•ä¸æ£€æŸ¥ç‚¹å®Œå…¨ç›¸åŒï¼Œå› æ­¤ä¿å­˜ç‚¹å¯ä»¥è®¤ ä¸ºå°±æ˜¯å…·æœ‰ä¸€äº›é¢å¤–å…ƒæ•°æ®çš„æ£€æŸ¥ç‚¹</li><li>Flinkä¸ä¼šè‡ªåŠ¨åˆ›å»ºä¿å­˜ç‚¹ï¼Œå› æ­¤ç”¨æˆ·ï¼ˆæˆ–è€…å¤–éƒ¨è°ƒåº¦ç¨‹åºï¼‰å¿…é¡»æ˜ç¡®åœ° è§¦å‘åˆ›å»ºæ“ä½œ</li></ol><h3 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h3><p><strong>1. æœ‰è®¡åˆ’çš„å¤‡ä»½</strong></p><p><strong>2. Flinkç‰ˆæœ¬è¿ç§»</strong></p><p>Flinkå‡çº§æ—¶ï¼Œä¹‹å‰çš„Flinkç¨‹åºä¸å¯èƒ½é‡å¯ï¼Œè¿™æ ·ä»¥å‰è®¡ç®—çš„æ•°æ®è¢«ä¸¢å¤±æ˜¯ä¸è¢«å…è®¸çš„ï¼Œåœ¨Flinkå‡çº§å‰è®¾ç½®ä¸€ä¸ªä¿å­˜ç‚¹ï¼Œç„¶åFLinkç‰ˆæœ¬æ›´æ–°åï¼Œä½¿ç”¨æ–°ç‰ˆFlinkå‘½ä»¤å¼€å¯Flinkåº”ç”¨ç¨‹åºé€šè¿‡ä¿å­˜ç‚¹åŠ è½½æ•°æ®ï¼Œåšåˆ°æ•°æ®ä¸ä¸¢å¤±</p><p><strong>3. æš‚åœå’Œé‡å¯åº”ç”¨</strong></p><p>èµ„æºä¸å……è¶³æ—¶ï¼Œåœè°ƒä¸é‡è¦çš„ä»»åŠ¡å¹¶æ·»åŠ ä¿å­˜ç‚¹ã€‚å¾…èµ„æºå……è¶³æ—¶å†æ¬¡å¼€å§‹å¹¶åŠ è½½ä¹‹å‰æ•°æ®ã€‚</p><h2 id="å®¹é”™æœºåˆ¶çš„å¼€å¯ğŸ”º"><a href="#å®¹é”™æœºåˆ¶çš„å¼€å¯ğŸ”º" class="headerlink" title="å®¹é”™æœºåˆ¶çš„å¼€å¯ğŸ”º"></a>å®¹é”™æœºåˆ¶çš„å¼€å¯ğŸ”º</h2><p><strong>1. æ£€æŸ¥ç‚¹é»˜è®¤ä¸å¼€å¯ï¼Œæ‰‹åŠ¨å¼€å¯</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env.enableCheckpointing(<span class="number">5000</span>)</span><br></pre></td></tr></table></figure><p>å‚æ•°ä¸ºæ£€æŸ¥ç‚¹çš„é—´éš”ï¼Œæ¯5000msäº§ç”Ÿä¸€ä¸ªæ£€æŸ¥ç‚¹</p><p><strong>2. æ·»åŠ çŠ¶æ€åç«¯ç»„ä»¶ï¼ŒæŒ‡å®šæ£€æŸ¥ç‚¹ä¿å­˜ä½ç½®</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env.setStateBackend(<span class="keyword">new</span> <span class="type">FsStateBackend</span>(<span class="string">&quot;file:///ã€‚ã€‚ã€‚ã€‚&quot;</span>))</span><br></pre></td></tr></table></figure><hr><p>Checkpointçš„è®¾ç½®ï¼š</p><ol><li><code>env.getCheckpointConfig.setCheckpointTimeout(60000)</code>ï¼šæ£€æŸ¥ç‚¹è¶…æ—¶æ—¶é—´</li><li><code>env.getCheckpointConfig.setMaxConcurrentCheckpoints(2)</code>ï¼šåŒæ—¶å­˜åœ¨çš„ä¿å­˜ç‚¹</li><li><code>env.getCheckpointConfig.setMinPauseBetweenCheckpoints(100)</code>ï¼šä¸Šä¸€æ£€æŸ¥ç‚¹ç»“æŸåå’Œä¸‹ä¸€æ£€æŸ¥ç‚¹äº§ç”Ÿå‰çš„æœ€å°ç­‰å¾…æ—¶é—´ï¼›<strong>å¦‚æœåœ¨æ­¤ç­‰å¾…æ—¶é—´å†…æ­£å¥½ç”±äºæ£€æŸ¥ç‚¹æ—¶é—´é—´éš”è¯¥äº§ç”Ÿä¸‹ä¸€æ£€æŸ¥ç‚¹äº†ï¼Œåˆ™ä¸‹ä¸€æ£€æŸ¥ç‚¹çš„äº§ç”Ÿæ—¶é—´å˜æ›´ä¸ºæœ€å°ç­‰å¾…æ—¶é—´è¿‡å»ä¹‹åã€‚</strong></li></ol><h2 id="é‡å¯ç­–ç•¥"><a href="#é‡å¯ç­–ç•¥" class="headerlink" title="é‡å¯ç­–ç•¥"></a>é‡å¯ç­–ç•¥</h2><p>Flinkç¨‹åºæ•…éšœæ—¶ï¼Œé‡å¯å¹¶ä¸èƒ½è§£å†³ä¸€åˆ‡é—®é¢˜ã€‚é‚£ä¹ˆæœ‰æ•ˆçš„é‡å¯ç­–ç•¥å°±æ˜¯æœ‰å¿…è¦çš„ã€‚</p><p>è®¾ç½®é‡å¯ç­–ç•¥ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env.setRestartStrategy()</span><br></pre></td></tr></table></figure><p>æœ‰ä¸‹é¢å‡ ä¸ªç­–ç•¥ï¼š</p><ol><li>ä¸é‡å¯</li><li>å›æ»šé‡å¯ï¼šç”±èµ„æºç®¡ç†å™¨å†³å®š</li><li>å›ºå®šå»¶è¿Ÿé‡å¯ï¼šå¯è®¾ç½®é‡å¯æ¬¡æ•°å’Œé‡å¯é—´éš”</li><li>å¤±è´¥ç‡é‡å¯ï¼šå¯è®¾ç½®é‡å¯æ¬¡æ•°ã€é‡å¯é—´éš”ã€æŒ‡å®šçš„æ—¶é—´ä¹‹å†…</li></ol><h1 id="Exactly-once-ä¸¤é˜¶æ®µæäº¤"><a href="#Exactly-once-ä¸¤é˜¶æ®µæäº¤" class="headerlink" title="Exactly-once ä¸¤é˜¶æ®µæäº¤"></a>Exactly-once ä¸¤é˜¶æ®µæäº¤</h1><p>JobManager åè°ƒå„ä¸ª TaskManager è¿›è¡Œ checkpoint å­˜å‚¨</p><p>checkpointä¿å­˜åœ¨ StateBackendä¸­ï¼Œé»˜è®¤StateBackendæ˜¯å†…å­˜çº§çš„ï¼Œä¹Ÿå¯ä»¥æ”¹ ä¸ºæ–‡ä»¶çº§çš„è¿›è¡ŒæŒä¹…åŒ–ä¿å­˜</p><p>å½“ checkpoint å¯åŠ¨æ—¶ï¼ŒJobManager ä¼šå°†æ£€æŸ¥ç‚¹åˆ†ç•Œçº¿ï¼ˆbarrierï¼‰æ³¨å…¥æ•°æ®æµ</p><p>barrierä¼šåœ¨ç®—å­é—´ä¼ é€’ä¸‹å»</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210104211640764.png" alt="image-20210104211640764"></p><p>æ¯ä¸ªç®—å­ä¼šå¯¹å½“å‰çš„çŠ¶æ€åšä¸ªå¿«ç…§ï¼Œä¿å­˜åˆ°çŠ¶æ€åç«¯</p><p>checkpoint æœºåˆ¶å¯ä»¥ä¿è¯å†…éƒ¨çš„çŠ¶æ€ä¸€è‡´æ€§</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210104211739784.png" alt="image-20210104211739784"></p><p>æ¯ä¸ªå†…éƒ¨çš„ transform ä»»åŠ¡é‡åˆ° barrier æ—¶ï¼Œéƒ½ä¼šæŠŠçŠ¶æ€å­˜åˆ° checkpoint é‡Œ</p><p>sink ä»»åŠ¡é¦–å…ˆæŠŠæ•°æ®å†™å…¥å¤–éƒ¨ kafkaï¼Œè¿™äº›æ•°æ®éƒ½å±äº<strong>é¢„æäº¤çš„äº‹åŠ¡</strong>ï¼›é‡åˆ° barrier æ—¶ï¼Œ<strong>æŠŠçŠ¶æ€ä¿å­˜åˆ°çŠ¶æ€åç«¯ï¼Œå¹¶å¼€å¯æ–°çš„é¢„æäº¤äº‹åŠ¡</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210104211815182.png" alt="image-20210104211815182"></p><p>å½“æ‰€æœ‰ç®—å­ä»»åŠ¡çš„å¿«ç…§å®Œæˆï¼Œä¹Ÿå°±æ˜¯è¿™æ¬¡çš„ checkpoint å®Œæˆæ—¶ï¼ŒJobManager ä¼šå‘æ‰€æœ‰ä»»åŠ¡å‘é€šçŸ¥ï¼Œç¡®è®¤è¿™æ¬¡ checkpoint å®Œæˆ</p><p>sink ä»»åŠ¡æ”¶åˆ°ç¡®è®¤é€šçŸ¥ï¼Œæ­£å¼æäº¤ä¹‹å‰çš„äº‹åŠ¡ï¼Œkafka ä¸­æœªç¡®è®¤æ•°æ®æ”¹ä¸ºâ€œå·²ç¡® è®¤â€</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210104211830889.png" alt="image-20210104211830889"></p><p><strong>Exactly-once ä¸¤é˜¶æ®µæäº¤æ­¥éª¤</strong></p><ol><li>ç¬¬ä¸€æ¡æ•°æ®æ¥äº†ä¹‹åï¼Œå¼€å¯ä¸€ä¸ª kafka çš„äº‹åŠ¡ï¼ˆtransactionï¼‰ï¼Œæ­£å¸¸å†™å…¥ kafka åˆ† åŒºæ—¥å¿—ä½†æ ‡è®°ä¸ºæœªæäº¤ï¼Œè¿™å°±æ˜¯â€œé¢„æäº¤â€ </li><li>jobmanager è§¦å‘ checkpoint æ“ä½œï¼Œbarrier ä» source å¼€å§‹å‘ä¸‹ä¼ é€’ï¼Œé‡åˆ° barrier çš„ç®—å­å°†çŠ¶æ€å­˜å…¥çŠ¶æ€åç«¯ï¼Œå¹¶é€šçŸ¥ jobmanager </li><li>sink è¿æ¥å™¨æ”¶åˆ° barrierï¼Œä¿å­˜å½“å‰çŠ¶æ€ï¼Œå­˜å…¥ checkpointï¼Œé€šçŸ¥ jobmanagerï¼Œ å¹¶å¼€å¯ä¸‹ä¸€é˜¶æ®µçš„äº‹åŠ¡ï¼Œç”¨äºæäº¤ä¸‹ä¸ªæ£€æŸ¥ç‚¹çš„æ•°æ®</li><li>jobmanager æ”¶åˆ°æ‰€æœ‰ä»»åŠ¡çš„é€šçŸ¥ï¼Œå‘å‡ºç¡®è®¤ä¿¡æ¯ï¼Œè¡¨ç¤º checkpoint å®Œæˆ</li><li> sink ä»»åŠ¡æ”¶åˆ° jobmanager çš„ç¡®è®¤ä¿¡æ¯ï¼Œæ­£å¼æäº¤è¿™æ®µæ—¶é—´çš„æ•°æ®</li><li> å¤–éƒ¨kafkaå…³é—­äº‹åŠ¡ï¼Œæäº¤çš„æ•°æ®å¯ä»¥æ­£å¸¸æ¶ˆè´¹äº†ã€‚</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;FlinkçŠ¶æ€ç®¡ç†&quot;&gt;&lt;a href=&quot;#FlinkçŠ¶æ€ç®¡ç†&quot; class=&quot;headerlink&quot; title=&quot;FlinkçŠ¶æ€ç®¡ç†&quot;&gt;&lt;/a&gt;FlinkçŠ¶æ€ç®¡ç†&lt;/h1&gt;&lt;p&gt;æµå¼è®¡ç®—åˆ†ä¸º&lt;strong&gt;æ— çŠ¶æ€å’Œæœ‰çŠ¶æ€&lt;/strong&gt;ä¸¤ç§æƒ…å†µã€‚æ— çŠ¶æ€çš„è®¡ç®—è§‚</summary>
      
    
    
    
    <category term="Flink" scheme="https://awslzhang.top/categories/Flink/"/>
    
    
    <category term="Flink" scheme="https://awslzhang.top/tags/Flink/"/>
    
  </entry>
  
  <entry>
    <title>Flinkçš„æ—¶é—´è¯­ä¹‰å’Œwatermark</title>
    <link href="https://awslzhang.top/2020/12/23/Flink%E6%97%B6%E9%97%B4%E8%AF%AD%E4%B9%89%E5%92%8CWaterMark/"/>
    <id>https://awslzhang.top/2020/12/23/Flink%E6%97%B6%E9%97%B4%E8%AF%AD%E4%B9%89%E5%92%8CWaterMark/</id>
    <published>2020-12-23T10:59:07.000Z</published>
    <updated>2021-01-03T06:54:32.814Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æˆ‘ä»¬å°†ä»‹ç»æ—¶é—´è¯­ä¹‰ï¼Œå¹¶æè¿°æµä¸­ä¸åŒçš„æ—¶é—´æ¦‚å¿µã€‚æˆ‘ä»¬å°†è®¨è®ºæµå¤„ç†å™¨åœ¨ä¹±åºäº‹ä»¶æµçš„æƒ…å†µä¸‹å¦‚ä½•æä¾›å‡†ç¡®çš„è®¡ç®—ç»“æœï¼Œä»¥åŠæˆ‘ä»¬å¦‚ä½•å¤„ç†å†å²äº‹ä»¶æµï¼Œå¦‚ä½•åœ¨æµä¸­è¿›è¡Œæ—¶é—´æ—…è¡Œã€‚</p><blockquote><p>æ—¶é—´æ—…è¡Œã€‚ä¹±åºäº‹ä»¶æµï¼Œæ›´æœ‰å¤è€æ•°æ®çš„äº‹ä»¶ã€‚</p></blockquote><h2 id="ä¸åŒçš„æ—¶é—´è¯­ä¹‰"><a href="#ä¸åŒçš„æ—¶é—´è¯­ä¹‰" class="headerlink" title="ä¸åŒçš„æ—¶é—´è¯­ä¹‰"></a>ä¸åŒçš„æ—¶é—´è¯­ä¹‰</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-23_19-05-44.png" alt="Snipaste_2020-12-23_19-05-44"></p><ul><li>Event Timeï¼šäº‹ä»¶çš„åˆ›å»ºäº‹ä»¶ã€‚ï¼ˆé™¤äº†æœªå¼€æºçš„Google DataFlowå¤–ï¼ŒFlinkæ˜¯å”¯ä¸€æ”¯æŒäº‹ä»¶æ—¶é—´çš„ï¼‰</li><li>Ingestion Timeï¼šæ•°æ®è¿›å…¥Flinkçš„æ—¶é—´</li><li>Processing Timeï¼šæ‰§è¡Œæ“ä½œç®—å­çš„<strong>æœ¬åœ°ç³»ç»Ÿæ—¶é—´</strong>ï¼Œä¸æœºå™¨ç›¸å…³</li></ul><h2 id="æ›´åŠ å½¢è±¡çš„äº‹ä»¶æ—¶é—´"><a href="#æ›´åŠ å½¢è±¡çš„äº‹ä»¶æ—¶é—´" class="headerlink" title="æ›´åŠ å½¢è±¡çš„äº‹ä»¶æ—¶é—´"></a>æ›´åŠ å½¢è±¡çš„äº‹ä»¶æ—¶é—´</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-23_19-07-29.png" alt="Snipaste_2020-12-23_19-07-29"></p><p>1977-2015æ˜¯å¤„ç†æ—¶é—´ã€æ˜Ÿçƒå¤§æˆ˜1-æ˜Ÿçƒå¤§æˆ˜7æ˜¯äº‹ä»¶æ—¶é—´ã€‚</p><ul><li>ä¸åŒçš„æ—¶é—´è¯­ä¹‰æœ‰ä¸åŒçš„åº”ç”¨åœºåˆ</li><li>æˆ‘ä»¬å¾€å¾€æ›´å…³å¿ƒäº‹ä»¶æ—¶é—´ï¼ˆEvent Timeï¼‰</li></ul><hr><h1 id="äº‹ä»¶æ—¶é—´"><a href="#äº‹ä»¶æ—¶é—´" class="headerlink" title="äº‹ä»¶æ—¶é—´"></a>äº‹ä»¶æ—¶é—´</h1><p>äº‹ä»¶æ—¶é—´æ˜¯æµä¸­çš„äº‹ä»¶å®é™…å‘ç”Ÿçš„æ—¶é—´ã€‚äº‹ä»¶æ—¶é—´åŸºäºæµä¸­çš„äº‹ä»¶æ‰€åŒ…å«çš„æ—¶é—´æˆ³ã€‚<font color="red">é€šå¸¸æƒ…å†µä¸‹ï¼Œåœ¨äº‹ä»¶è¿›å…¥æµå¤„ç†ç¨‹åºå‰ï¼Œäº‹ä»¶æ•°æ®å°±å·²ç»åŒ…å«äº†æ—¶é—´æˆ³</font>ã€‚ä¸‹å›¾å±•ç¤ºäº†äº‹ä»¶æ—¶é—´çª—å£å°†ä¼šæ­£ç¡®çš„å°†äº‹ä»¶åˆ†å‘åˆ°çª—å£ä¸­å»ã€‚å¯ä»¥å¦‚å®ååº”äº‹æƒ…æ˜¯æ€ä¹ˆå‘ç”Ÿçš„ã€‚å³ä½¿äº‹ä»¶å¯èƒ½å­˜åœ¨å»¶è¿Ÿã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/spaf_0213.png"></p><p>äº‹ä»¶æ—¶é—´ä½¿å¾—è®¡ç®—ç»“æœçš„è¿‡ç¨‹ä¸éœ€è¦ä¾èµ–å¤„ç†æ•°æ®çš„é€Ÿåº¦ã€‚åŸºäºäº‹ä»¶æ—¶é—´çš„æ“ä½œæ˜¯å¯ä»¥é¢„æµ‹çš„ï¼Œè€Œè®¡ç®—ç»“æœä¹Ÿæ˜¯ç¡®å®šçš„ã€‚æ— è®ºæµå¤„ç†ç¨‹åºå¤„ç†æµæ•°æ®çš„é€Ÿåº¦å¿«æˆ–æ˜¯æ…¢ï¼Œæ— è®ºäº‹ä»¶åˆ°è¾¾æµå¤„ç†ç¨‹åºçš„é€Ÿåº¦å¿«æˆ–æ˜¯æ…¢ï¼Œäº‹ä»¶æ—¶é—´çª—å£çš„è®¡ç®—ç»“æœéƒ½æ˜¯ä¸€æ ·çš„ã€‚å› ä¸ºå®ƒé‡‡ç”¨çš„æ˜¯äº‹ä»¶ä¸­çš„æ—¶é—´</p><p><font color="red">å¦‚æœä½¿ç”¨äº‹ä»¶æ—¶é—´ï¼Œå³ä½¿ç¢°åˆ°äº†äº‹ä»¶ä¹±åºåˆ°è¾¾çš„æƒ…å†µï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¿è¯ç»“æœçš„æ­£ç¡®æ€§</font>ã€‚è¿˜æœ‰ï¼Œå½“æˆ‘ä»¬åœ¨å¤„ç†å¯ä»¥é‡æ’­çš„æµæ•°æ®æ—¶ï¼Œç”±äºæ—¶é—´æˆ³çš„ç¡®å®šæ€§ï¼Œæˆ‘ä»¬å¯ä»¥å¿«è¿›è¿‡å»ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥é‡æ’­ä¸€æ¡æµï¼Œç„¶ååˆ†æå†å²æ•°æ®ï¼Œå°±å¥½åƒæµä¸­çš„äº‹ä»¶æ˜¯å®æ—¶å‘ç”Ÿä¸€æ ·ã€‚å¦å¤–ï¼Œæˆ‘ä»¬å¯ä»¥å¿«è¿›å†å²æ•°æ®æ¥ä½¿æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºè¿½ä¸Šç°åœ¨çš„äº‹ä»¶ï¼Œç„¶ååº”ç”¨ç¨‹åºä»ç„¶æ˜¯ä¸€ä¸ªå®æ—¶å¤„ç†ç¨‹åºï¼Œè€Œä¸”ä¸šåŠ¡é€»è¾‘ä¸éœ€è¦æ”¹å˜ã€‚</p><h2 id="ä»£ç ä¸­è®¾ç½®äº‹ä»¶æ—¶é—´"><a href="#ä»£ç ä¸­è®¾ç½®äº‹ä»¶æ—¶é—´" class="headerlink" title="ä»£ç ä¸­è®¾ç½®äº‹ä»¶æ—¶é—´"></a>ä»£ç ä¸­è®¾ç½®äº‹ä»¶æ—¶é—´</h2><p>æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ä»£ç ä¸­ï¼Œå¯¹æ‰§è¡Œç¯å¢ƒè°ƒç”¨<code>setStreamTimeCharacteristic</code>æ–¹æ³•ï¼Œè®¾ç½®æµçš„æ—¶é—´ç‰¹æ€§ï¼›å…·ä½“çš„æ—¶é—´ï¼Œ<strong>è¿˜éœ€è¦ä»æ•°æ®ä¸­æå–æ—¶é—´æˆ³ï¼ˆtimestampï¼‰</strong>ï¼ˆ<font color="red">å¿…é¡»</font>ï¼‰</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line"><span class="comment">// è®¾ç½®æµçš„æ—¶é—´ç‰¹å¾</span></span><br><span class="line">env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">EventTime</span>)</span><br></pre></td></tr></table></figure><p><strong>æå–æ—¶é—´æˆ³+è®¾ç½®æ°´ä½çº¿</strong></p><p><a href="#%E6%B0%B4%E4%BD%8D%E7%BA%BF%E7%9A%84%E5%BC%95%E5%85%A5">æŸ¥çœ‹</a></p><h2 id="äº‹ä»¶æ—¶é—´æ€ä¹ˆè§£å†³ä¹±åºæ•°æ®"><a href="#äº‹ä»¶æ—¶é—´æ€ä¹ˆè§£å†³ä¹±åºæ•°æ®" class="headerlink" title="äº‹ä»¶æ—¶é—´æ€ä¹ˆè§£å†³ä¹±åºæ•°æ®"></a>äº‹ä»¶æ—¶é—´æ€ä¹ˆè§£å†³ä¹±åºæ•°æ®</h2><p>ä¹±åºæ•°æ®ä¼šè®©çª—å£è®¡ç®—ä¸å‡†ç¡®</p><p>å¦‚å›¾ï¼Œè¢«åœ†åœˆåœˆä½å¾—æ•°æ®æ˜¯å½“å‰äº‹ä»¶å¾—äº‹ä»¶æ—¶é—´ï¼ˆå‘ç”Ÿäº‹ä»¶å¾—æ—¶é—´ï¼‰ï¼Œè€Œäº‹ä»¶å¾—é¡ºåºå°±æ˜¯äº‹ä»¶åˆ°è¾¾Flinkå¾—é¡ºåºã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-23_19-34-40.png" alt="Snipaste_2020-12-23_19-34-40"></p><p>å‡å¦‚ï¼Œæˆ‘ä»¬å¼€äº†ä¸€ä¸ªæ—¶é—´é•¿åº¦ä¸º5så¾—äº‹ä»¶æ—¶é—´çª—å£ã€‚å› ä¸ºæ˜¯äº‹ä»¶æ—¶é—´çª—å£ï¼Œå½“äº‹ä»¶æ—¶é—´ä¸º5så¾—äº‹ä»¶åˆ°è¾¾æ—¶ï¼Œæˆ‘ä»¬è¿™ä¸ª0-5å¾—æ—¶é—´çª—å£å°±èƒ½å…³é—­äº†å—ï¼Œå°±èƒ½è®¤ä¸ºè¿™ä¸ªçª—å£å¾—æ•°æ®éƒ½åˆ°è¾¾äº†å—ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ä¸èƒ½çš„ï¼Œå¦‚æœæ˜¯å¤„ç†æ—¶é—´çš„çª—å£ï¼Œé‚£ä¹ˆè¿‡äº†5Sçª—å£å°±ç›´æ¥å…³é—­äº†ï¼Œå®ƒä½¿ç”¨æœºå™¨æ—¶é—´ã€‚ä½†æ˜¯äº‹ä»¶æ—¶é—´çª—å£ä½¿ç”¨çš„æ˜¯äº‹ä»¶çš„æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´ä»–åœ¨æ•°æ®é‡Œï¼Œè™½ç„¶ç¬¬5sçš„æ•°æ®åˆ°äº†ï¼Œä½†æ²¡äººèƒ½ä¿è¯5Sä¹‹å‰çš„æ•°æ®ä¼šä¸ä¼šç”±äºç½‘ç»œã€åˆ†å¸ƒå¼ç­‰åŸå› è¿Ÿåˆ°ï¼Œä¼šå¯¼è‡´ä¹±åºæ•°æ®çš„äº§ç”Ÿï¼Œæˆ–è€…ç¬¬5sæœ‰æ²¡æœ‰å¤šæ¡æ•°æ®ã€‚</p><p>é‚£ä¹ˆå¦‚æœæ˜¯äº‹ä»¶äº‹ä»¶çª—å£å¾—è¯ï¼Œè¿™ä¸ªçª—å£å°±æ°¸ä¹…ä¸å…³é—­å—ï¼Œè¿™æ ·å¤§é‡çª—å£åœ¨å¤„ç†ï¼Œä¼šæ‹–å®ç¨‹åºçš„ã€‚</p><p><font color="red"><strong>è¿™æ—¶å€™æå‡ºäº†æ°´ä½çº¿çš„æ¦‚å¿µï¼Œæ¥ä»£è¡¨äº‹ä»¶æ—¶é—´æ•°æ®æµçš„æ—¶é—´æµåŠ¨è¿›åº¦ã€‚</strong></font></p><h1 id="æ°´ä½çº¿ï¼ˆWaterMarkï¼‰ğŸ”º"><a href="#æ°´ä½çº¿ï¼ˆWaterMarkï¼‰ğŸ”º" class="headerlink" title="æ°´ä½çº¿ï¼ˆWaterMarkï¼‰ğŸ”º"></a>æ°´ä½çº¿ï¼ˆWaterMarkï¼‰ğŸ”º</h1><p>æå‡ºæ°´ä½çº¿ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥åˆ—ä¸¾å‡ ä¸ªäº‹ä»¶æ—¶é—´çª—å£å¾—é—®é¢˜ï¼š</p><ul><li>æ€æ ·é¿å…ä¹±åºæ•°æ®å¸¦æ¥è®¡ç®—ä¸æ­£ç¡®ï¼Ÿ<ul><li>Watermark æ˜¯ç”¨äºå¤„ç†ä¹±åºäº‹ä»¶çš„ï¼Œè€Œæ­£ç¡®çš„å¤„ç†ä¹±åºäº‹ä»¶ï¼Œé€šå¸¸ç”¨Watermark æœºåˆ¶ç»“åˆ window æ¥å®ç°ï¼›</li></ul></li><li>æˆ‘ä»¬åº”è¯¥æ€æ ·å»å†³å®šä½•æ—¶è§¦å‘äº‹ä»¶æ—¶é—´çª—å£çš„è®¡ç®—ï¼Ÿï¼ˆæ€ä¹ˆå…³é—­æ—¶é—´çª—å£ï¼‰</li></ul><p><strong>watermark ç”¨æ¥è®©ç¨‹åºè‡ªå·±å¹³è¡¡å»¶è¿Ÿå’Œç»“æœæ­£ç¡®æ€§</strong></p><p>åœ¨æœ¬å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä¼šçœ‹åˆ°å¦‚ä½•ä½¿ç”¨æ°´ä½çº¿æ¥è®¾ç½®äº‹ä»¶æ—¶é—´çª—å£çš„è¡Œä¸ºã€‚</p><hr><p>æ°´ä½çº¿æ˜¯æ—¶é—´å…¨å±€è¿›åº¦çš„åº¦é‡æ ‡å‡†ã€‚<strong>ç³»ç»Ÿå¯ä»¥ç¡®ä¿¡åœ¨ä¸€ä¸ªæ—¶é—´ç‚¹ä¹‹åï¼Œä¸ä¼šæœ‰æ—©äºè¿™ä¸ªæ—¶é—´ç‚¹å‘ç”Ÿçš„äº‹ä»¶åˆ°æ¥äº†ã€‚</strong>æœ¬è´¨ä¸Šï¼Œæ°´ä½çº¿æä¾›äº†ä¸€ä¸ªé€»è¾‘æ—¶é’Ÿï¼Œè¿™ä¸ªé€»è¾‘æ—¶é’Ÿå‘Šè¯‰ç³»ç»Ÿå½“å‰çš„äº‹ä»¶æ—¶é—´ã€‚å½“ä¸€ä¸ªè¿ç®—ç¬¦æ¥æ”¶åˆ°å«æœ‰æ—¶é—´Tçš„æ°´ä½çº¿æ—¶ï¼Œè¿™ä¸ªè¿ç®—ç¬¦ä¼šè®¤ä¸ºæ—©äºæ—¶é—´Tçš„å‘ç”Ÿçš„äº‹ä»¶å·²ç»å…¨éƒ¨éƒ½åˆ°è¾¾äº†ã€‚<strong>å¯¹äºäº‹ä»¶æ—¶é—´çª—å£å’Œä¹±åºäº‹ä»¶çš„å¤„ç†ï¼Œæ°´ä½çº¿éå¸¸é‡è¦ã€‚</strong><font color="red">è¿ç®—ç¬¦ä¸€æ—¦æ¥æ”¶åˆ°æ°´ä½çº¿ï¼Œè¿ç®—ç¬¦ä¼šè®¤ä¸ºä¸€æ®µæ—¶é—´å†…å‘ç”Ÿçš„æ‰€æœ‰äº‹ä»¶éƒ½å·²ç»è§‚å¯Ÿåˆ°ï¼Œå¯ä»¥è§¦å‘é’ˆå¯¹è¿™æ®µæ—¶é—´å†…æ‰€æœ‰äº‹ä»¶çš„è®¡ç®—äº†ã€‚</font></p><blockquote><p><strong>ç³»ç»Ÿå¯ä»¥ç¡®ä¿¡åœ¨ä¸€ä¸ªæ—¶é—´ç‚¹ä¹‹åï¼Œä¸ä¼šæœ‰æ—©äºè¿™ä¸ªæ—¶é—´ç‚¹å‘ç”Ÿçš„äº‹ä»¶åˆ°æ¥äº†ã€‚</strong></p><p>ï¼ˆåªæ˜¯è¿™æ ·è§„å®šçš„ï¼Œå®é™…ä¸Šè¿˜æ˜¯æœ‰å¯èƒ½æœ‰æ—©äºè¿™ä¸ªæ—¶é—´ç‚¹å‘ç”Ÿçš„äº‹ä»¶åˆ°æ¥ï¼Œè¿™æ—¶äº‹ä»¶è¢«ç§°ä¸ºè¿Ÿåˆ°äº‹ä»¶ï¼Œé»˜è®¤è¿Ÿåˆ°äº‹ä»¶è¢«ä¸¢å¼ƒã€‚åé¢æœ‰å•ç‹¬çš„è¿Ÿåˆ°äº‹ä»¶çš„å¤„ç†ç« èŠ‚ï¼‰</p></blockquote><h2 id="æ°´ä½çº¿ä½œç”¨"><a href="#æ°´ä½çº¿ä½œç”¨" class="headerlink" title="æ°´ä½çº¿ä½œç”¨"></a>æ°´ä½çº¿ä½œç”¨</h2><p>æ°´ä½çº¿æä¾›äº†ä¸€ç§<strong>ç»“æœå¯ä¿¡åº¦å’Œå»¶æ—¶ä¹‹é—´çš„å¦¥å</strong>ã€‚æ¿€è¿›çš„æ°´ä½çº¿è®¾ç½®å¯ä»¥ä¿è¯ä½å»¶è¿Ÿï¼Œä½†ç»“æœçš„å‡†ç¡®æ€§ä¸å¤Ÿã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<strong>è¿Ÿåˆ°çš„äº‹ä»¶æœ‰å¯èƒ½æ™šäºæ°´ä½çº¿åˆ°è¾¾ï¼Œæˆ‘ä»¬éœ€è¦ç¼–å†™ä¸€äº›ä»£ç æ¥å¤„ç†è¿Ÿåˆ°äº‹ä»¶</strong>ã€‚å¦ä¸€æ–¹é¢ï¼Œ<strong>å¦‚æœæ°´ä½çº¿è®¾ç½®çš„è¿‡äºå®½æ¾ï¼Œè®¡ç®—çš„ç»“æœå‡†ç¡®æ€§ä¼šå¾ˆé«˜ï¼Œä½†å¯èƒ½ä¼šå¢åŠ æµå¤„ç†ç¨‹åºä¸å¿…è¦çš„å»¶æ—¶</strong>ã€‚</p><blockquote><p>ç™½è¯è®²</p><p><strong>ç»“æœå¯ä¿¡åº¦å’Œå»¶æ—¶ä¹‹é—´çš„å¦¥å</strong>ï¼š</p><p>å°±æ˜¯è¯´æ°´ä½çº¿æ—¶æœ‰ä¸€ä¸ªæœ€å¤§å»¶è¿Ÿæ—¶é—´çš„æ¦‚å¿µï¼ŒåŠ å…¥æœ€å¤§çš„äº‹ä»¶æ—¶é—´åˆ°äº†æ˜¯10Sï¼Œä½†æ˜¯æœ€å¤§å»¶è¿Ÿæ—¶é—´æ˜¯5Sï¼Œé‚£ä¹ˆå½“å‰æ°´ä½çº¿å°±æ˜¯5Sï¼Œé‚£ä¹ˆ0-10Sçš„çª—å£å°±ä¸ä¼šå…³é—­è®¡ç®—ï¼Œå®ƒåœ¨ç­‰å¾…å› ä¸ºæŸäº›åŸå› è¿˜æ²¡æœ‰åˆ°çš„0-10Sçš„äº‹ä»¶ã€‚</p><p>ä¸€æ–¹é¢ï¼š</p><p>å½“æœ€å¤§æ—¶é—´æ—¶é—´åˆ°äº†15Sï¼Œæœ€å¤§å»¶è¿Ÿæ—¶é—´æ˜¯5Sï¼Œé‚£ä¹ˆå½“å‰æ°´ä½çº¿å°±æ˜¯10Sã€‚å³0-10Sçš„çª—å£å·²ç»å…³é—­å¼€å§‹äº†è®¡ç®—ï¼Œé‚£ä¹ˆä¹‹ååˆ°çš„0-10Sçš„äº‹ä»¶äº‹ä»¶æ•°æ®å°±æ˜¯è¿Ÿåˆ°äº‹ä»¶ï¼Œéœ€è¦ç¼–å†™ä¸€äº›ä»£ç æ¥å¤„ç†ï¼ˆé»˜è®¤ä¸¢å¼ƒï¼‰</p><p>å¦ä¸€æ–¹é¢ï¼š</p><p>å¦‚æœå°†æ°´ä½çº¿è®¾ç½®çš„å®½æ¾ï¼Œå‡†ç¡®æ€§å°±ä¼šæé«˜ã€‚ä¾‹å¦‚æ”¾å¤§æœ€å¤§å»¶è¿Ÿæ—¶é—´ï¼Œä½†æ˜¯å¯èƒ½ä¼šå¢åŠ æµå¤„ç†ç¨‹åºä¸å¿…è¦çš„å»¶æ—¶</p></blockquote><p>å¦‚å›¾ï¼Œè®¾æ—¶é—´çª—å£å¤§å°ä¸º10Sï¼Œæœ€å¤§å»¶è¿Ÿäº‹ä»¶ä¸º5Sã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-23_21-13-13.png" alt="Snipaste_2020-12-23_21-13-13"></p><hr><p>åœ¨13Såˆ°è¾¾æ—¶ï¼Œæ°´ä½çº¿ä¸º7Sã€‚</p><ul><li>è¿™æ—¶å¦‚æœæ²¡æœ‰æ›´å¤§çš„äº‹ä»¶æ—¶é—´åˆ°æ¥æ—¶ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶é—´æ®µå†…æ‰€æœ‰0-10Sçš„æ•°æ®éƒ½ä¼šè¿›å…¥çª—å£ã€‚</li><li>å½“15Sçš„äº‹ä»¶æ—¶é—´åˆ°è¾¾æ—¶ï¼Œæ°´ä½çº¿ä¸º10Sã€‚0-10Sçš„çª—å£å°†è¢«è®¡ç®—å¹¶ä¸”å…³é—­ã€‚</li><li>å¦‚æœåœ¨15Sçš„äº‹ä»¶æ—¶é—´åˆ°è¾¾åï¼Œåˆæ¥ä¸´äº†0-10Sçš„äº‹ä»¶æ—¶é—´ã€‚å®ƒä»¬é»˜è®¤å°†è¢«æŠ›å¼ƒï¼Œé™¤äº†å†™äº†ä¸“é—¨å¤„ç†çš„ä»£ç </li></ul><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-23_21-22-39.png" alt="Snipaste_2020-12-23_21-22-39"></p><h2 id="æ°´ä½çº¿ç‰¹ç‚¹ğŸ”º"><a href="#æ°´ä½çº¿ç‰¹ç‚¹ğŸ”º" class="headerlink" title="æ°´ä½çº¿ç‰¹ç‚¹ğŸ”º"></a>æ°´ä½çº¿ç‰¹ç‚¹ğŸ”º</h2><ul><li>watermarké»˜è®¤æ¯200msæ’å…¥ä¸€æ¬¡ï¼Œç”±ç¨‹åºå‘˜ç¼–ç æ’å…¥ã€‚å¯ä»¥ä½¿ç”¨<code>env.getConfig.setAutoWatermarkInterval(5000)</code>æ–¹æ³•è¿›è¡Œè®¾ç½®ã€‚</li><li>Watermark æ˜¯ä¸€ç§è¡¡é‡ Event Time è¿›å±•çš„æœºåˆ¶ï¼Œå¯ä»¥è®¾å®šå»¶è¿Ÿè§¦å‘</li><li>watermark å¿…é¡»å•è°ƒé€’å¢ï¼Œä»¥ç¡®ä¿ä»»åŠ¡çš„äº‹ä»¶æ—¶é—´æ—¶é’Ÿåœ¨å‘å‰æ¨è¿›ï¼Œè€Œä¸æ˜¯åœ¨åé€€</li><li>åªæœ‰äº‹ä»¶æ—¶é—´éœ€è¦æ°´ä½çº¿ï¼Œæ°´ä½çº¿åªæœ‰åœ¨çª—å£è®¡ç®—æ—¶æ‰æœ‰ç”¨ï¼Œäº‹ä»¶æ—¶é—´å¯ä»¥è®¾ç½®æœ€å¤§å»¶è¿Ÿæ—¶é—´</li><li><font color="red">ç³»ç»Ÿè®¤ä¸ºæ—¶é—´æˆ³å°äºæ°´ä½çº¿çš„äº‹ä»¶éƒ½å·²ç»åˆ°è¾¾äº†</font></li><li><font color="red">äº‹ä»¶æ—¶é—´çª—å£çš„é—­åˆè§¦å‘è§„åˆ™ï¼šæ°´ä½çº¿å¤§äºç­‰äºçª—å£ç»“æŸæ—¶é—´</font></li><li><font color="red"><code>watermark  = æœ€å¤§äº‹ä»¶æ—¶é—´ - æœ€å¤§å»¶è¿Ÿæ—¶é—´</code></font></li></ul><blockquote><p>é€šå¸¸ï¼Œå½“æ°´ä½çº¿è¶…è¿‡çª—å£ç»“æŸæ—¶é—´æ—¶ï¼Œçª—å£å°†ä¸å†æ¥æ”¶äº‹ä»¶ï¼Œç„¶åè§¦å‘è®¡ç®—ï¼Œè®¡ç®—å®Œæ¯•ï¼Œçª—å£è¢«é”€æ¯</p></blockquote><hr><blockquote><p> é€šå¸¸éƒ½æ˜¯åœ¨æµä¹‹åç«‹é©¬è®¾ç½®æ°´ä½çº¿ï¼Œå› ä¸ºç»è¿‡åˆ†æµååœ¨è®¾ç½®æ°´ä½çº¿ï¼Œæµä¹‹é—´çš„æ°´ä½çº¿ä¼šå¾ˆä¹±</p></blockquote><h2 id="æ°´ä½çº¿çš„å¼•å…¥"><a href="#æ°´ä½çº¿çš„å¼•å…¥" class="headerlink" title="æ°´ä½çº¿çš„å¼•å…¥"></a>æ°´ä½çº¿çš„å¼•å…¥</h2><h3 id="è‡ªå¸¦"><a href="#è‡ªå¸¦" class="headerlink" title="è‡ªå¸¦"></a>è‡ªå¸¦</h3><p><strong>å¯¹äºæ’å¥½åºçš„æ•°æ®ï¼Œä¸éœ€è¦å»¶è¿Ÿè§¦å‘ï¼Œå¯ä»¥åªæŒ‡å®šæ—¶é—´æˆ³å°±è¡Œäº†</strong></p><p>å½“10Såˆ°è¾¾åï¼Œå› ä¸ºçª—å£æ˜¯å·¦é—­å³å¼€ï¼Œè¿™ä¸ª10Sä¸ä¼šç«‹é©¬åŠ å…¥çª—å£è®¡ç®—ï¼Œ<font color="red">æ‰€ä»¥å½“å‰æ°´ä½çº¿æ˜¯æœ€å¤§äº‹ä»¶æ—¶é—´-1msã€‚</font></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ—¶é—´æˆ³å¿…é¡»æ˜¯msï¼Œæ ¹æ®è‡ªå·±éœ€æ±‚å†™</span></span><br><span class="line">dataStream.assignAscendingTimestamps(_timestamp * <span class="number">1000</span>)</span><br></pre></td></tr></table></figure><p><strong>å¯¹äºä¹±åºæ•°æ®ï¼Œéœ€è¦æ¥è®¾ç½®å»¶è¿Ÿæ—¶é—´ï¼Œæ¥è§£å†³é—®é¢˜</strong></p><p>å³è®¾ç½®æœ€å¤§å»¶è¿Ÿæ—¶é—´</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.assignTimestampsAndWatermarks(</span><br><span class="line">       <span class="comment">// è®¾ç½®æœ€å¤§å»¶è¿Ÿæ—¶é—´ä¸º5S</span></span><br><span class="line">       <span class="keyword">new</span> <span class="type">BoundedOutOfOrdernessTimestampExtractor</span>[(<span class="type">String</span>, <span class="type">Long</span>)](<span class="type">Time</span>.seconds(<span class="number">5</span>)) &#123;</span><br><span class="line">         <span class="comment">// è®¾ç½®é‚£ä¸ªå…ƒç´ æ˜¯äº‹ä»¶è‡ªå¸¦çš„</span></span><br><span class="line">       <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(t: (<span class="type">String</span>, <span class="type">Long</span>)) = t._2</span><br><span class="line">     &#125;)</span><br></pre></td></tr></table></figure><h3 id="è‡ªå®šä¹‰"><a href="#è‡ªå®šä¹‰" class="headerlink" title="è‡ªå®šä¹‰"></a>è‡ªå®šä¹‰</h3><p>æˆ‘ä»¬çŸ¥é“é»˜è®¤çš„æ°´å¹³çº¿è®¡ç®—è§„åˆ™ä¸º<code>æœ€å¤§äº‹ä»¶æ—¶é—´-æœ€å¤§å»¶è¿Ÿæ—¶é—´</code>ï¼Œå³<code>BoundedOutOfOrdernessTimestampExtractor</code>ç±»çš„å®ç°ã€‚è€Œä¸”æ˜¯æ¯éš”200msæ’å…¥ä¸€æ¬¡ã€‚</p><p>Flinkæä¾›äº†æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰å®ç°æ°´å¹³çº¿çš„å®ç°é€»è¾‘ï¼Œå³å®ƒçš„è®¡ç®—è§„åˆ™å¯ä»¥æ›´æ”¹ï¼Œå¹¶ä¸”å®ƒçš„æ’å…¥ä¹Ÿå¯ä»¥æ›´æ”¹ï¼ˆè§„åˆ™æ€§æ’å…¥|ä¸è§„åˆ™æ’å…¥ï¼‰ï¼Œåˆ†åˆ«å¯¹åº”ç€ä¸¤ä¸ªæ¥å£ï¼š</p><ol><li><code>AssignerWithPeriodicWatermarks</code>ï¼š<a href="#%E5%91%A8%E6%9C%9F%E6%80%A7%E7%9A%84%E7%94%9F%E6%88%90%E6%B0%B4%E4%BD%8D%E7%BA%BF">å‘¨æœŸæ€§çš„ç”Ÿæˆæ°´ä½çº¿</a></li><li><code>AssignerWithPunctuatedWatermarks</code>ï¼š<a href="#%E5%A6%82%E4%BD%95%E4%BA%A7%E7%94%9F%E4%B8%8D%E8%A7%84%E5%88%99%E7%9A%84%E6%B0%B4%E4%BD%8D%E7%BA%BF">äº§ç”Ÿä¸è§„åˆ™çš„æ°´ä½çº¿</a></li></ol><h4 id="å‘¨æœŸæ€§çš„ç”Ÿæˆæ°´ä½çº¿"><a href="#å‘¨æœŸæ€§çš„ç”Ÿæˆæ°´ä½çº¿" class="headerlink" title="å‘¨æœŸæ€§çš„ç”Ÿæˆæ°´ä½çº¿"></a>å‘¨æœŸæ€§çš„ç”Ÿæˆæ°´ä½çº¿</h4><p>å‘¨æœŸæ€§çš„ç”Ÿæˆæ°´ä½çº¿ï¼šç³»ç»Ÿä¼šå‘¨æœŸæ€§çš„å°†æ°´ä½çº¿æ’å…¥åˆ°æµä¸­ï¼ˆæ°´ä½çº¿ä¹Ÿæ˜¯ä¸€ç§ç‰¹æ®Šçš„äº‹ä»¶!ï¼‰ã€‚é»˜è®¤å‘¨æœŸæ˜¯200æ¯«ç§’ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç³»ç»Ÿä¼šæ¯éš”200æ¯«ç§’å°±å¾€æµä¸­æ’å…¥ä¸€æ¬¡æ°´ä½çº¿ã€‚</p><blockquote><p>è¿™é‡Œçš„200æ¯«ç§’æ˜¯æœºå™¨æ—¶é—´ï¼</p></blockquote><p>å¯ä»¥ä½¿ç”¨<code>ExecutionConfig.setAutoWatermarkInterval()</code>æ–¹æ³•è¿›è¡Œè®¾ç½®ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">EventTime</span>)</span><br><span class="line"><span class="comment">// æ¯éš”5ç§’äº§ç”Ÿä¸€ä¸ªæ°´ä½çº¿</span></span><br><span class="line">env.getConfig.setAutoWatermarkInterval(<span class="number">5000</span>)</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä¾‹å­äº§ç”Ÿæ°´ä½çº¿çš„é€»è¾‘ï¼šæ¯éš”5ç§’é’Ÿï¼ŒFlinkä¼šè°ƒç”¨AssignerWithPeriodicWatermarksä¸­çš„getCurrentWatermark()æ–¹æ³•ã€‚å¦‚æœæ–¹æ³•è¿”å›çš„æ—¶é—´æˆ³å¤§äºä¹‹å‰æ°´ä½çº¿çš„æ—¶é—´æˆ³ï¼Œæ–°çš„æ°´ä½çº¿ä¼šè¢«æ’å…¥åˆ°æµä¸­ã€‚è¿™ä¸ªæ£€æŸ¥ä¿è¯äº†æ°´ä½çº¿æ˜¯å•è°ƒé€’å¢çš„ã€‚å¦‚æœæ–¹æ³•è¿”å›çš„æ—¶é—´æˆ³å°äºç­‰äºä¹‹å‰æ°´ä½çº¿çš„æ—¶é—´æˆ³ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿæ–°çš„æ°´ä½çº¿ã€‚</p><hr><p>ä¾‹å­ï¼Œè‡ªå®šä¹‰ä¸€ä¸ªå‘¨æœŸæ€§çš„æ—¶é—´æˆ³æŠ½å–</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PeriodicAssigner</span> <span class="keyword">extends</span> <span class="title">AssignerWithPeriodicWatermarks</span>[<span class="type">SensorReading</span>] </span>&#123;</span><br><span class="line">  <span class="keyword">val</span> bound = <span class="number">60</span> * <span class="number">1000</span> <span class="comment">// é»˜è®¤ï¼Œå»¶æ—¶ä¸º1åˆ†é’Ÿ</span></span><br><span class="line">  <span class="keyword">var</span> maxTs = <span class="type">Long</span>.<span class="type">MinValue</span> + bound <span class="comment">// è§‚å¯Ÿåˆ°çš„æœ€å¤§æ—¶é—´æˆ³</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getCurrentWatermark</span></span>: <span class="type">Watermark</span> &#123;</span><br><span class="line">      <span class="comment">// è®¾ç½®æ°´ä½çº¿ï¼Œé»˜è®¤è§„åˆ™</span></span><br><span class="line">    <span class="keyword">new</span> <span class="type">Watermark</span>(maxTs - bound)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¯ä¸ªäº‹ä»¶åˆ°æ¥éƒ½ä¼šæ‰§è¡Œï¼Œæ›´æ–°æœ€å¤§äº‹ä»¶æ—¶é—´æˆ³</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(r: <span class="type">SensorReading</span>, previousTS: <span class="type">Long</span>) &#123;</span><br><span class="line">    maxTs = maxTs.max(r.timestamp)</span><br><span class="line">    r.timestamp</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç çš„é€»è¾‘å°±æ˜¯<code>BoundedOutOfOrdernessTimestampExtractor</code>çš„é€»è¾‘ã€‚</p><h4 id="å¦‚ä½•äº§ç”Ÿä¸è§„åˆ™çš„æ°´ä½çº¿"><a href="#å¦‚ä½•äº§ç”Ÿä¸è§„åˆ™çš„æ°´ä½çº¿" class="headerlink" title="å¦‚ä½•äº§ç”Ÿä¸è§„åˆ™çš„æ°´ä½çº¿"></a><a href="#%E5%A6%82%E4%BD%95%E4%BA%A7%E7%94%9F%E4%B8%8D%E8%A7%84%E5%88%99%E7%9A%84%E6%B0%B4%E4%BD%8D%E7%BA%BF">å¦‚ä½•äº§ç”Ÿä¸è§„åˆ™çš„æ°´ä½çº¿</a></h4><p>æœ‰æ—¶å€™è¾“å…¥æµä¸­ä¼šåŒ…å«ä¸€äº›ç”¨äºæŒ‡ç¤ºç³»ç»Ÿè¿›åº¦çš„ç‰¹æ®Šå…ƒç»„æˆ–æ ‡è®°ã€‚Flinkä¸ºæ­¤ç±»æƒ…å½¢ä»¥åŠå¯æ ¹æ®è¾“å…¥å…ƒç´ ç”Ÿæˆæ°´ä½çº¿çš„æƒ…å½¢æä¾›äº†<code>AssignerWithPunctuatedWatermarks</code>æ¥å£ã€‚è¯¥æ¥å£ä¸­çš„<code>checkAndGetNextWatermark()</code>æ–¹æ³•ä¼šåœ¨é’ˆå¯¹æ¯ä¸ªäº‹ä»¶çš„<code>extractTimestamp()</code>æ–¹æ³•åç«‹å³è°ƒç”¨ã€‚å®ƒå¯ä»¥å†³å®šæ˜¯å¦ç”Ÿæˆä¸€ä¸ªæ–°çš„æ°´ä½çº¿ã€‚<strong>å¦‚æœè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªéç©ºã€ä¸”å¤§äºä¹‹å‰å€¼çš„æ°´ä½çº¿ï¼Œç®—å­å°±ä¼šå°†è¿™ä¸ªæ–°æ°´ä½çº¿å‘å‡ºã€‚</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PunctuatedAssigner</span> <span class="keyword">extends</span> <span class="title">AssignerWithPunctuatedWatermarks</span>[<span class="type">SensorReading</span>] </span>&#123;</span><br><span class="line">  <span class="keyword">val</span> bound = <span class="number">60</span> * <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¯æ¥ä¸€æ¡æ•°æ®å°±è°ƒç”¨ä¸€æ¬¡</span></span><br><span class="line">  <span class="comment">// ç´§è·Ÿ`extractTimestamp`å‡½æ•°è°ƒç”¨</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">checkAndGetNextWatermark</span></span>(r: <span class="type">SensorReading</span>, extractedTS: <span class="type">Long</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (r.id == <span class="string">&quot;sensor_1&quot;</span>) &#123;</span><br><span class="line">      <span class="comment">// æŠ½å–çš„æ—¶é—´æˆ³ - æœ€å¤§å»¶è¿Ÿæ—¶é—´</span></span><br><span class="line">      <span class="keyword">new</span> <span class="type">Watermark</span>(extractedTS - bound)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸äº§ç”Ÿæ—¶é—´æˆ³</span></span><br><span class="line">      <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¯æ¥ä¸€æ¡æ•°æ®å°±è°ƒç”¨ä¸€æ¬¡</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(r: <span class="type">SensorReading</span>, previousTS: <span class="type">Long</span>) &#123;</span><br><span class="line">    r.timestamp</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æœ€å¤§å»¶è¿Ÿæ—¶é—´çš„è®¾ç½®"><a href="#æœ€å¤§å»¶è¿Ÿæ—¶é—´çš„è®¾ç½®" class="headerlink" title="æœ€å¤§å»¶è¿Ÿæ—¶é—´çš„è®¾ç½®"></a>æœ€å¤§å»¶è¿Ÿæ—¶é—´çš„è®¾ç½®</h2><p>å®Œç¾çš„æ°´ä½çº¿æ°¸è¿œä¸ä¼šé”™ï¼šæ—¶é—´æˆ³å°äºæ°´ä½çº¿çš„äº‹ä»¶ä¸ä¼šå†å‡ºç°ã€‚åœ¨ç‰¹æ®Šæƒ…å†µä¸‹(ä¾‹å¦‚éä¹±åºäº‹ä»¶æµ)ï¼Œæœ€è¿‘ä¸€æ¬¡äº‹ä»¶çš„æ—¶é—´æˆ³å°±å¯èƒ½æ˜¯å®Œç¾çš„æ°´ä½çº¿ã€‚å¯å‘å¼æ°´ä½çº¿åˆ™ç›¸åï¼Œå®ƒåªä¼°è®¡æ—¶é—´ï¼Œå› æ­¤æœ‰å¯èƒ½å‡ºé”™ï¼Œå³è¿Ÿåˆ°çš„äº‹ä»¶(å…¶æ—¶é—´æˆ³å°äºæ°´ä½çº¿æ ‡è®°æ—¶é—´)æ™šäºæ°´ä½çº¿å‡ºç°ã€‚é’ˆå¯¹å¯å‘å¼æ°´ä½çº¿ï¼ŒFlinkæä¾›äº†å¤„ç†è¿Ÿåˆ°å…ƒç´ çš„æœºåˆ¶ã€‚</p><p><strong>è®¾å®šæ°´ä½çº¿é€šå¸¸éœ€è¦ç”¨åˆ°é¢†åŸŸçŸ¥è¯†ã€‚</strong>ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœçŸ¥é“äº‹ä»¶çš„è¿Ÿåˆ°æ—¶é—´ä¸ä¼šè¶…è¿‡5ç§’ï¼Œå°±å¯ä»¥å°†æ°´ä½çº¿æ ‡è®°æ—¶é—´è®¾ä¸ºæ”¶åˆ°çš„æœ€å¤§æ—¶é—´æˆ³å‡å»5ç§’ã€‚å¦ä¸€ç§åšæ³•æ˜¯ï¼Œé‡‡ç”¨ä¸€ä¸ªFlinkä½œä¸šç›‘æ§äº‹ä»¶æµï¼Œå­¦ä¹ äº‹ä»¶çš„è¿Ÿåˆ°è§„å¾‹ï¼Œå¹¶ä»¥æ­¤æ„å»ºæ°´ä½çº¿ç”Ÿæˆæ¨¡å‹ã€‚</p><p>å¦‚æœæœ€å¤§å»¶è¿Ÿæ—¶é—´è®¾ç½®çš„å¾ˆå¤§ï¼Œè®¡ç®—å‡ºçš„ç»“æœä¼šæ›´ç²¾ç¡®ï¼Œä½†æ”¶åˆ°è®¡ç®—ç»“æœçš„é€Ÿåº¦ä¼šå¾ˆæ…¢ï¼ŒåŒæ—¶ç³»ç»Ÿä¼šç¼“å­˜å¤§é‡çš„æ•°æ®ï¼Œå¹¶å¯¹ç³»ç»Ÿé€ æˆæ¯”è¾ƒå¤§çš„å‹åŠ›ã€‚å¦‚æœæœ€å¤§å»¶è¿Ÿæ—¶é—´è®¾ç½®çš„å¾ˆå°ï¼Œé‚£ä¹ˆæ”¶åˆ°è®¡ç®—ç»“æœçš„é€Ÿåº¦ä¼šå¾ˆå¿«ï¼Œä½†å¯èƒ½æ”¶åˆ°é”™è¯¯çš„è®¡ç®—ç»“æœã€‚ä¸è¿‡Flinkå¤„ç†è¿Ÿåˆ°æ•°æ®çš„æœºåˆ¶å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä¸Šè¿°é—®é¢˜çœ‹èµ·æ¥å¾ˆå¤æ‚ï¼Œä½†æ˜¯æ°æ°ç¬¦åˆç°å®ä¸–ç•Œçš„è§„å¾‹ï¼šå¤§éƒ¨åˆ†çœŸå®çš„äº‹ä»¶æµéƒ½æ˜¯ä¹±åºçš„ï¼Œå¹¶ä¸”é€šå¸¸æ— æ³•äº†è§£å®ƒä»¬çš„ä¹±åºç¨‹åº¦(å› ä¸ºç†è®ºä¸Šä¸èƒ½é¢„è§æœªæ¥)ã€‚æ°´ä½çº¿æ˜¯å”¯ä¸€è®©æˆ‘ä»¬ç›´é¢ä¹±åºäº‹ä»¶æµå¹¶ä¿è¯æ­£ç¡®æ€§çš„æœºåˆ¶; å¦åˆ™åªèƒ½é€‰æ‹©å¿½è§†äº‹å®ï¼Œå‡è£…é”™è¯¯çš„ç»“æœæ˜¯æ­£ç¡®çš„ã€‚</p><blockquote><ul><li>æ€è€ƒé¢˜ä¸€ï¼šå®æ—¶ç¨‹åºï¼Œè¦æ±‚å®æ—¶æ€§éå¸¸é«˜ï¼Œå¹¶ä¸”ç»“æœå¹¶ä¸ä¸€å®šè¦æ±‚éå¸¸å‡†ç¡®ï¼Œé‚£ä¹ˆåº”è¯¥æ€ä¹ˆåŠï¼Ÿ</li><li>å›ç­”ï¼šç›´æ¥ä½¿ç”¨å¤„ç†æ—¶é—´ã€‚</li><li>æ€è€ƒé¢˜äºŒï¼šå¦‚æœè¦è¿›è¡Œæ—¶é—´æ—…è¡Œï¼Œä¹Ÿå°±æ˜¯è¦è¿˜åŸä»¥å‰çš„æ•°æ®é›†å½“æ—¶çš„æµçš„çŠ¶æ€ï¼Œåº”è¯¥æ€ä¹ˆåŠï¼Ÿ</li><li>å›ç­”ï¼šä½¿ç”¨äº‹ä»¶æ—¶é—´ã€‚ä½¿ç”¨Hiveå°†æ•°æ®é›†å…ˆæŒ‰ç…§æ—¶é—´æˆ³å‡åºæ’åˆ—ï¼Œå†å°†æœ€å¤§å»¶è¿Ÿæ—¶é—´è®¾ç½®ä¸º0ã€‚</li></ul></blockquote><h2 id="æ°´ä½çº¿ã€äº‹ä»¶çª—å£çš„éªŒè¯ğŸ”º"><a href="#æ°´ä½çº¿ã€äº‹ä»¶çª—å£çš„éªŒè¯ğŸ”º" class="headerlink" title="æ°´ä½çº¿ã€äº‹ä»¶çª—å£çš„éªŒè¯ğŸ”º"></a>æ°´ä½çº¿ã€äº‹ä»¶çª—å£çš„éªŒè¯ğŸ”º</h2><p>å› ä¸ºæ˜¯éªŒè¯çª—å£ä¸æ°´ä½çº¿çš„å…³ç³»ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå‡½æ•°èƒ½åŒæ—¶è·å–çª—å£çš„åŸºæœ¬ä¿¡æ¯ï¼ˆå¼€å§‹ç»“æŸæ—¶é—´ï¼‰å’Œæ°´ä½çº¿çš„ã€‚</p><p>è¿™å°±æ˜¯å‰é¢æåˆ°çš„<code>PrcessWindowFunction</code>ï¼Œå› ä¸ºè¦è·å–è·å–çª—å£çš„åŸºæœ¬ä¿¡æ¯ã€‚æ‰€ä»¥ï¼Œå¢é‡èšåˆå‡½æ•°åœ¨è¿™é‡Œè¡Œä¸é€šã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æµ‹è¯• æ°´ä½çº¿å’Œçª—å£ç»“æŸæ—¶é—´ç»“æŸ çš„å…³ç³»</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">EventTime</span>)</span><br><span class="line"></span><br><span class="line">    env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">9000</span>, &#x27;\n&#x27;)</span><br><span class="line">      .map(r =&gt; (r.split(<span class="string">&quot; &quot;</span>)(<span class="number">0</span>), r.split(<span class="string">&quot; &quot;</span>)(<span class="number">1</span>).toLong * <span class="number">1000</span>))</span><br><span class="line">      .assignTimestampsAndWatermarks(</span><br><span class="line">        <span class="comment">// è®¾ç½®æœ€å¤§å»¶è¿Ÿæ—¶é—´ä¸º5S</span></span><br><span class="line">        <span class="keyword">new</span> <span class="type">BoundedOutOfOrdernessTimestampExtractor</span>[(<span class="type">String</span>, <span class="type">Long</span>)](<span class="type">Time</span>.seconds(<span class="number">5</span>)) &#123;</span><br><span class="line">          <span class="comment">// è®¾ç½®é‚£ä¸ªå…ƒç´ æ˜¯äº‹ä»¶è‡ªå¸¦çš„</span></span><br><span class="line">          <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(t: (<span class="type">String</span>, <span class="type">Long</span>)) = t._2</span><br><span class="line">        &#125;)</span><br><span class="line">      .keyBy(r =&gt; r._1)</span><br><span class="line">      <span class="comment">// å¼€çª—10S</span></span><br><span class="line">      .timeWindow(<span class="type">Time</span>.seconds(<span class="number">10</span>))</span><br><span class="line">      .process(<span class="keyword">new</span> <span class="type">MyProcess</span>).print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MyProcess</span> <span class="keyword">extends</span> <span class="title">ProcessWindowFunction</span>[(<span class="type">String</span>, <span class="type">Long</span>), <span class="type">String</span>, <span class="type">String</span>, <span class="type">TimeWindow</span>] </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">process</span></span>(key: <span class="type">String</span>, context: <span class="type">Context</span>, elements: <span class="type">Iterable</span>[(<span class="type">String</span>, <span class="type">Long</span>)], out: <span class="type">Collector</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="keyword">val</span> startTime: <span class="type">String</span> = <span class="keyword">new</span> <span class="type">Timestamp</span>(context.window.getStart).toString</span><br><span class="line">      <span class="keyword">val</span> endTime: <span class="type">String</span> = <span class="keyword">new</span> <span class="type">Timestamp</span>(context.window.getEnd).toString</span><br><span class="line">      out.collect(<span class="string">s&quot;çª—å£çš„å¤§å°ä¸ºï¼š<span class="subst">$startTime</span>-<span class="subst">$endTime</span>\tçª—å£å†…çš„å…ƒç´ ä¸ºï¼š<span class="subst">$elements</span>\tä¸ªæ•°ä¸ºï¼š<span class="subst">$&#123;elements.size&#125;</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>è¾“å…¥2ï¼Œ5ï¼Œ8ï¼Œ9ï¼Œ10ã€‚å‘ç°çª—å£æ²¡æœ‰ååº”ï¼Œå³ç¬¬ä¸€ä¸ªçª—å£æ²¡æœ‰å…³é—­</li><li>è¾“å…¥12ï¼Œ15ã€‚å‘ç°çª—å£å…³é—­äº†ï¼Œå½“è¾“å…¥15æ—¶ï¼Œæ°´å¹³çº¿ä¸º10.æ­£å¥½å¤§äºç­‰äºç¬¬ä¸€ä¸ªçª—å£çš„ç»“æŸæ—¶é—´ï¼Œæ‰€ä»¥çª—å£å¼€å§‹è®¡ç®—</li><li>çœ‹åˆ°æ—¥å¿—ç¬¬ä¸€ä¸ªçª—å£æ²¡æœ‰10Sï¼Œ<strong>å› ä¸ºçª—å£æ˜¯å·¦é—­å³å¼€çš„ã€‚</strong></li></ol><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201224163855851.png" alt="image-20201224163855851"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201224160149977.png" alt="image-20201224160149977"></p><h2 id="æ°´ä½çº¿çš„ä¼ é€’"><a href="#æ°´ä½çº¿çš„ä¼ é€’" class="headerlink" title="æ°´ä½çº¿çš„ä¼ é€’"></a>æ°´ä½çº¿çš„ä¼ é€’</h2><p>æ¯ä¸ªæµéƒ½æœ‰ç€è‡ªå·±çš„æ°´ä½çº¿ï¼Œåœ¨è¿›è¡Œæµåˆå¹¶æ—¶ï¼Œæ°´ä½çº¿æ˜¯æ€ä¹ˆä¼ é€’çš„å‘¢ï¼Ÿ</p><p><font color="red"><strong>ä¸€ä¸ªæµåœ¨ä¸€ä¸ªåˆ†åŒºä¸­å°±æœ‰ä¸€ä¸ªæ°´ä½çº¿</strong></font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210101195833056.png" alt="image-20210101195833056"></p><blockquote><ol><li>åœ¨map_1å’Œmap_2éƒ½æœ‰è‡ªå·±çš„æ°´ä½çº¿</li><li>åœ¨å‘å¾€åˆ†åŒº1ï¼Œ2æ—¶ï¼Œå®ƒä»¬å„è‡ªçš„æ°´ä½çº¿éƒ½å‘é€ï¼Œæ¯ä¸ªåˆ†åŒºåªå°†æœ€å°çš„æ°´ä½çº¿å½“æœ€æ­¤åˆ†åŒºæ­¤æ“ä½œçš„æ°´ä½çº¿</li></ol><p>æ­¤æ—¶ï¼Œå¦‚æœ125æ˜¯çª—å£ç»“æŸæ—¶é—´ï¼Œå¦‚æœæƒ³è¦è§¦å‘ç»“æŸï¼Œåˆ™map_1,map_2éƒ½è¦å¤§äº125çš„æ°´ä½çº¿</p><p><strong>ç»“è®ºï¼Œæ·»åŠ watermarkç¦»Sourceè¶Šè¿‘è¶Šå¥½</strong></p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/spaf_0309.png"></p><hr><h1 id="åº•å±‚çº§å¤„ç†å‡½æ•°ğŸ”º"><a href="#åº•å±‚çº§å¤„ç†å‡½æ•°ğŸ”º" class="headerlink" title="åº•å±‚çº§å¤„ç†å‡½æ•°ğŸ”º"></a>åº•å±‚çº§å¤„ç†å‡½æ•°ğŸ”º</h1><p>æˆ‘ä»¬ä¹‹å‰å­¦ä¹ çš„è½¬æ¢ç®—å­<strong>æ˜¯æ— æ³•è®¿é—®äº‹ä»¶çš„æ—¶é—´æˆ³ä¿¡æ¯å’Œæ°´ä½çº¿ä¿¡æ¯çš„ã€‚</strong>è€Œè¿™åœ¨ä¸€äº›åº”ç”¨åœºæ™¯ä¸‹ï¼Œæä¸ºé‡è¦ã€‚ä¾‹å¦‚MapFunctionè¿™æ ·çš„mapè½¬æ¢ç®—å­å°±æ— æ³•è®¿é—®æ—¶é—´æˆ³æˆ–è€…å½“å‰äº‹ä»¶çš„äº‹ä»¶æ—¶é—´ã€‚</p><p>åŸºäºæ­¤ï¼ŒDataStream APIæä¾›äº†ä¸€ç³»åˆ—çš„<strong>Low-Levelè½¬æ¢ç®—å­ã€‚å¯ä»¥è®¿é—®æ—¶é—´æˆ³ã€æ°´ä½çº¿ä»¥åŠæ³¨å†Œå®šæ—¶äº‹ä»¶ã€‚</strong>è¿˜å¯ä»¥è¾“å‡ºç‰¹å®šçš„ä¸€äº›äº‹ä»¶ï¼Œä¾‹å¦‚è¶…æ—¶äº‹ä»¶ç­‰ã€‚Process Functionç”¨æ¥æ„å»ºäº‹ä»¶é©±åŠ¨çš„åº”ç”¨ä»¥åŠå®ç°è‡ªå®šä¹‰çš„ä¸šåŠ¡é€»è¾‘(ä½¿ç”¨ä¹‹å‰çš„windowå‡½æ•°å’Œè½¬æ¢ç®—å­æ— æ³•å®ç°)ã€‚<strong>ä¾‹å¦‚ï¼ŒFlink-SQLå°±æ˜¯ä½¿ç”¨Process Functionå®ç°çš„ã€‚</strong></p><blockquote><p>Process Functionéƒ½æ˜¯Rich Function</p></blockquote><p><code>Flink</code>æä¾›äº†8ä¸ªProcess Functionï¼š</p><ul><li>ProcessFunctionï¼šå¤„ç†æ²¡æœ‰ç»è¿‡åˆ†ç»„å’Œå¼€çª—çš„æµï¼Œç›´æ¥å¯¹æ•´æ¡æµå¤„ç†ï¼Œæ¯ä¸ªå…ƒç´ è§¦å‘æ‰§è¡Œä¸€æ¬¡</li><li><code>KeyedProcessFunction</code>ï¼šå¤„ç†åˆ†ç»„åæ²¡æœ‰å¼€çª—çš„æµï¼Œæ¯ä¸ªå…ƒç´ è§¦å‘æ‰§è¡Œä¸€æ¬¡</li><li><code>CoProcessFunction</code>ï¼šå¤„ç†connectä¹‹åçš„æµ</li><li>ProcessJoinFunctionï¼šå¤„ç†ä¸¤æ¡æµjoinåçš„æµ </li><li>BroadcastProcessFunction</li><li>KeyedBroadcastProcessFunction</li><li><code>ProcessWindowFunction</code>ï¼šå¤„ç†åˆ†æµå’Œå¼€çª—å£ä»¥åçš„æµï¼Œæ¯ä¸ªçª—å£ç»“æŸæ—¶æ‰§è¡Œä¸€æ¬¡</li><li>ProcessAllWindowFunctionï¼šå¤„ç†æ²¡æœ‰åˆ†æµä½†å¼€äº†çª—çš„æµï¼Œçª—å£ç»“æŸæ—¶æ‰§è¡Œ</li></ul><p>æˆ‘ä»¬è¿™é‡Œè¯¦ç»†ä»‹ç»ä¸€ä¸‹KeyedProcessFunctionã€‚</p><h2 id="KeyedProcessFunction"><a href="#KeyedProcessFunction" class="headerlink" title="KeyedProcessFunction"></a><strong><em>KeyedProcessFunction</em></strong></h2><p>KeyedProcessFunctionç”¨<strong>æ¥æ“ä½œKeyedStream</strong>ã€‚KeyedProcessFunction<strong>ä¼šå¤„ç†æµçš„æ¯ä¸€ä¸ªå…ƒç´ ï¼Œè¾“å‡ºä¸º0ä¸ªã€1ä¸ªæˆ–è€…å¤šä¸ªå…ƒç´ </strong>ã€‚<strong>æ‰€æœ‰çš„Process Functionéƒ½ç»§æ‰¿è‡ªRichFunctionæ¥å£</strong>ï¼Œæ‰€ä»¥éƒ½æœ‰open()ã€close()å’ŒgetRuntimeContext()ç­‰æ–¹æ³•ã€‚è€ŒKeyedProcessFunction[KEY, IN, OUT]è¿˜é¢å¤–æä¾›äº†ä¸¤ä¸ªæ–¹æ³•:</p><ol><li><code>processElement(v: IN, ctx: Context, out: Collector[OUT])</code>, æµä¸­çš„<strong>æ¯ä¸€ä¸ªå…ƒç´ éƒ½ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•</strong>ï¼Œè°ƒç”¨ç»“æœå°†ä¼šæ”¾åœ¨Collectoræ•°æ®ç±»å‹ä¸­è¾“å‡ºã€‚<strong>Contextå¯ä»¥è®¿é—®å…ƒç´ çš„æ—¶é—´æˆ³ï¼Œå…ƒç´ çš„keyï¼Œä»¥åŠTimerServiceæ—¶é—´æœåŠ¡</strong>ã€‚**Contextè¿˜å¯ä»¥å°†ç»“æœè¾“å‡ºåˆ°åˆ«çš„æµ(side outputs)**ï¼ˆåé¢è®²#<a href="#%E4%BE%A7%E8%BE%93%E5%87%BA%E6%B5%81">ä¾§è¾“å‡ºæµ</a>ï¼‰ã€‚</li><li><code>onTimer(timestamp: Long, ctx: OnTimerContext, out: Collector[OUT])</code>æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ã€‚å½“ä¹‹å‰<font color="red"><strong>æ³¨å†Œçš„å®šæ—¶å™¨è§¦å‘æ—¶è°ƒç”¨</strong></font>ã€‚å‚æ•°timestampä¸ºå®šæ—¶å™¨æ‰€è®¾å®šçš„è§¦å‘çš„æ—¶é—´æˆ³ã€‚Collectorä¸ºè¾“å‡ºç»“æœçš„é›†åˆã€‚OnTimerContextå’ŒprocessElementçš„Contextå‚æ•°ä¸€æ ·ï¼Œæä¾›äº†ä¸Šä¸‹æ–‡çš„ä¸€äº›ä¿¡æ¯ï¼Œä¾‹å¦‚firing triggerçš„æ—¶é—´ä¿¡æ¯(äº‹ä»¶æ—¶é—´æˆ–è€…å¤„ç†æ—¶é—´)ã€‚</li></ol><h3 id="ä¾‹å­ï¼šæ—¶é—´æœåŠ¡å’Œå®šæ—¶å™¨"><a href="#ä¾‹å­ï¼šæ—¶é—´æœåŠ¡å’Œå®šæ—¶å™¨" class="headerlink" title="ä¾‹å­ï¼šæ—¶é—´æœåŠ¡å’Œå®šæ—¶å™¨"></a>ä¾‹å­ï¼š<a href="#%E6%97%B6%E9%97%B4%E6%9C%8D%E5%8A%A1%E5%92%8C%E5%AE%9A%E6%97%B6%E5%99%A8">æ—¶é—´æœåŠ¡å’Œå®šæ—¶å™¨</a></h3><p>Contextå’ŒOnTimerContextæ‰€æŒæœ‰çš„TimerServiceå¯¹è±¡æ‹¥æœ‰ä»¥ä¸‹æ–¹æ³•:</p><ul><li><code>currentProcessingTime(): Long</code> è¿”å›å½“å‰å¤„ç†æ—¶é—´</li><li><code>currentWatermark(): Long</code> è¿”å›å½“å‰æ°´ä½çº¿çš„æ—¶é—´æˆ³</li><li><code>registerProcessingTimeTimer(timestamp: Long): Unit</code> ä¼šæ³¨å†Œå½“å‰keyçš„processing timeçš„timerã€‚å½“processing timeåˆ°è¾¾å®šæ—¶æ—¶é—´æ—¶ï¼Œè§¦å‘timerã€‚</li><li><code>registerEventTimeTimer(timestamp: Long): Unit</code> ä¼šæ³¨å†Œå½“å‰keyçš„event time timerã€‚å½“æ°´ä½çº¿å¤§äºç­‰äºå®šæ—¶å™¨æ³¨å†Œçš„æ—¶é—´æ—¶ï¼Œè§¦å‘å®šæ—¶å™¨æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚</li><li><code>deleteProcessingTimeTimer(timestamp: Long): Unit</code> åˆ é™¤ä¹‹å‰æ³¨å†Œå¤„ç†æ—¶é—´å®šæ—¶å™¨ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ªæ—¶é—´æˆ³çš„å®šæ—¶å™¨ï¼Œåˆ™ä¸æ‰§è¡Œã€‚</li><li><code>deleteEventTimeTimer(timestamp: Long): Unit</code> åˆ é™¤ä¹‹å‰æ³¨å†Œçš„äº‹ä»¶æ—¶é—´å®šæ—¶å™¨ï¼Œå¦‚æœæ²¡æœ‰æ­¤æ—¶é—´æˆ³çš„å®šæ—¶å™¨ï¼Œåˆ™ä¸æ‰§è¡Œã€‚</li></ul><p>å½“å®šæ—¶å™¨timerè§¦å‘æ—¶ï¼Œæ‰§è¡Œå›è°ƒå‡½æ•°onTimer()ã€‚<strong>processElement()æ–¹æ³•å’ŒonTimer()æ–¹æ³•æ˜¯åŒæ­¥ï¼ˆä¸æ˜¯å¼‚æ­¥ï¼‰æ–¹æ³•ï¼Œè¿™æ ·å¯ä»¥é¿å…å¹¶å‘è®¿é—®å’Œæ“ä½œçŠ¶æ€ã€‚</strong></p><p><strong>é’ˆå¯¹æ¯ä¸€ä¸ªkeyå’Œtimestampï¼Œåªèƒ½æ³¨å†Œä¸€ä¸ªå®šæœŸå™¨</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸€ä¸ªkeyå¯ä»¥æ³¨å†Œå¤šä¸ªå®šæ—¶å™¨ï¼Œä½†åœ¨æ¯ä¸€ä¸ªæ—¶é—´æˆ³åªèƒ½æ³¨å†Œä¸€ä¸ªå®šæ—¶å™¨ã€‚KeyedProcessFunctioné»˜è®¤å°†æ‰€æœ‰å®šæ—¶å™¨çš„æ—¶é—´æˆ³æ”¾åœ¨ä¸€ä¸ªä¼˜å…ˆé˜Ÿåˆ—ä¸­ã€‚åœ¨Flinkåšæ£€æŸ¥ç‚¹æ“ä½œæ—¶ï¼Œå®šæ—¶å™¨ä¹Ÿä¼šè¢«ä¿å­˜åˆ°çŠ¶æ€åç«¯ä¸­ã€‚</p><p>ä¸¾ä¸ªä¾‹å­è¯´æ˜KeyedProcessFunctionå¦‚ä½•æ“ä½œKeyedStreamã€‚</p><p>ä¸‹é¢çš„ç¨‹åºå±•ç¤ºäº†å¦‚ä½•ç›‘æ§æ¸©åº¦ä¼ æ„Ÿå™¨çš„æ¸©åº¦å€¼ï¼Œå¦‚æœæ¸©åº¦å€¼åœ¨ä¸€ç§’é’Ÿä¹‹å†…(processing time)è¿ç»­ä¸Šå‡ï¼ŒæŠ¥è­¦ã€‚</p><p>åŸç†ï¼šé€šè¿‡çŠ¶æ€å˜é‡ï¼ˆæµä¸­ä¿ç•™ä¹‹å‰æµæ•°æ®çš„è®¡ç®—ç»“æœï¼Œæ¯å½“æ–°çš„æ•°æ®åˆ°åˆ°è¾¾æ—¶ï¼Œæ›´æ–°ä¿å­˜çš„çŠ¶æ€å˜é‡ï¼‰æ¯”è¾ƒå½“å‰æ¸©åº¦å’Œä¸Šä¸€ä¸ªæ¸©åº¦ï¼Œå¦‚æœå¤§äºçš„è¯ï¼Œåˆ›å»ºä¸€ä¸ª1Såçš„å®šæ—¶å™¨æŠ¥è­¦ï¼›å¦‚æœå°äºçš„è¯ï¼Œå–æ¶ˆä¹‹å‰çš„æŠ¥è­¦å™¨ã€‚è¿™æ ·å¦‚æœ1Sä¸­ä¹‹å†…æŠ¥è­¦å™¨æ²¡æœ‰è¢«å–æ¶ˆçš„è¯ï¼Œè¯æ˜1Så†…æ¸©åº¦åœ¨ä¸æ–­ä¸Šå‡ï¼</p><p>ä¸»è¦ç¨‹åºï¼šï¼ˆä¸ºä»€ä¹ˆä½¿ç”¨çŠ¶æ€å˜é‡ï¼Œå› ä¸ºé˜²æ­¢å®•æœºåï¼Œä¸¢å¤±æ•°æ®ï¼ˆçŠ¶æ€å˜é‡å¯ä»¥å­˜åœ¨hdfsä¸Šï¼Œåˆå§‹åŒ–æ—¶è¯»å–ï¼Œæ²¡æœ‰å†åˆå§‹åŒ–ï¼‰ï¼Œä½¿ç”¨çŠ¶æ€å˜é‡çš„è¯å¾—ç”¨æ‡’æ‰§è¡Œï¼Œå› ä¸ºä¸ç”¨æ‡’æ‰§è¡Œçš„è¯ï¼Œåˆå§‹åŒ–æ—¶<code>getRuntimeContext</code>è¿˜æ²¡æœ‰ï¼‰</p><blockquote><p>éœ€è¦æ³¨æ„æˆ‘æ²¡æœ‰è®¾ç½®å¹¶è¡Œåº¦ï¼Œå¦‚æœä½ çš„ç¨‹åºæ²¡æœ‰è¾“å‡ºç»“æœçš„è¯ï¼Œæ˜¯å› ä¸ºä¸€èˆ¬ç”µè„‘çš„æ ¸æ•°ä¸º8|16ï¼Œæ‰€ä»¥addSourceçš„å¹¶è¡Œåº¦ä¸º8|16ï¼Œè€Œæ¯ä¸ªaddSourceåœ¨æ¯sæ¯ä¸ªidå¤§çº¦ä¼šç”Ÿæˆ3æ¡æ•°æ®ï¼ˆæ ¹æ®300msè®¡ç®—çš„å¾—å‡ºï¼‰ï¼Œè€Œä¹˜ä»¥å¹¶è¡Œåº¦8æœ€åä¸º24æ¡ï¼Œè¿™æ—¶åªæœ‰24æ¡è®°å½•è¿ç»­ä¸Šå‡æ‰ä¼šå¯¼è‡´æŠ¥è­¦è§¦å‘ï¼Œæ‰€ä»¥å¾ˆéš¾å‡ºç°ç»“æœã€‚å¤§å®¶ä»¬å¯ä»¥å•ç‹¬å°†addSourceçš„å¹¶è¡Œåº¦è®¾ç½®ä¸º1</p></blockquote><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.&#123;<span class="type">ValueState</span>, <span class="type">ValueStateDescriptor</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.scala.typeutils.<span class="type">Types</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.<span class="type">KeyedProcessFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"><span class="keyword">import</span> org.example.flink.source.&#123;<span class="type">SensorReading</span>, <span class="type">SensorSource</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">TemperatureMonitor</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> source: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = env.addSource(<span class="keyword">new</span> <span class="type">SensorSource</span>)</span><br><span class="line">    source.keyBy(r =&gt; r.id).process(<span class="keyword">new</span> <span class="type">MykeyedFunction</span>).print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MykeyedFunction</span> <span class="keyword">extends</span> <span class="title">KeyedProcessFunction</span>[<span class="type">String</span>, <span class="type">SensorReading</span>, <span class="type">String</span>] </span>&#123;</span><br><span class="line">    <span class="comment">// å®šä¹‰çŠ¶æ€å˜é‡ï¼Œä½¿ç”¨æ‡’æ‰§è¡Œ</span></span><br><span class="line">    <span class="comment">// æ‡’åŠ è½½ï¼›</span></span><br><span class="line">    <span class="comment">// çŠ¶æ€å˜é‡ä¼šåœ¨æ£€æŸ¥ç‚¹æ“ä½œæ—¶è¿›è¡ŒæŒä¹…åŒ–ï¼Œä¾‹å¦‚hdfs</span></span><br><span class="line">    <span class="comment">// åªä¼šåˆå§‹åŒ–ä¸€æ¬¡ï¼Œå•ä¾‹æ¨¡å¼</span></span><br><span class="line">    <span class="comment">// åœ¨å½“æœºé‡å¯ç¨‹åºæ—¶ï¼Œé¦–å…ˆå»æŒä¹…åŒ–è®¾å¤‡å¯»æ‰¾åä¸º`last-temp`çš„çŠ¶æ€å˜é‡ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥è¯»å–ã€‚ä¸å­˜åœ¨ï¼Œåˆ™åˆå§‹åŒ–ã€‚</span></span><br><span class="line">    <span class="comment">// æµä¸­ä¸Šæ¬¡æ¸©åº¦ï¼Œé€šè¿‡å¯¹æ¯”æœ¬æ¬¡æ¸©åº¦å’Œä¸Šæ¬¡æ¸©åº¦ï¼Œæ¥çœ‹æ¸©åº¦çš„ä¸Šå‡/ä¸‹é™è¶‹åŠ¿  ä¸‹é™çš„è¯ å–æ¶ˆä¹‹å‰è®¾ç½®çš„å®šæ—¶æŠ¥è­¦</span></span><br><span class="line">    <span class="keyword">lazy</span> <span class="keyword">val</span> perTemperature: <span class="type">ValueState</span>[<span class="type">Double</span>] = getRuntimeContext.getState(<span class="keyword">new</span> <span class="type">ValueStateDescriptor</span>[<span class="type">Double</span>]</span><br><span class="line">    (<span class="string">&quot;last-temperature&quot;</span>, <span class="type">Types</span>.of[<span class="type">Double</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¹‹å‰è®¾ç½®çš„æŠ¥è­¦æ—¶é—´ï¼Œå½“æ¸©åº¦ä¸‹é™æ—¶éœ€è¦è·å–ä¹‹å‰è®¾ç½®çš„æŠ¥è­¦å™¨çš„æ—¶é—´ï¼Œé€šè¿‡æ—¶é—´æ¥åˆ é™¤æŠ¥è­¦å™¨</span></span><br><span class="line">    <span class="keyword">lazy</span> <span class="keyword">val</span> time: <span class="type">ValueState</span>[<span class="type">Long</span>] = getRuntimeContext.getState(<span class="keyword">new</span> <span class="type">ValueStateDescriptor</span>[<span class="type">Long</span>]</span><br><span class="line">    (<span class="string">&quot;time&quot;</span>, <span class="type">Types</span>.of[<span class="type">Long</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¯ä¸ªæµçš„å…ƒç´ éƒ½ä¼šæ‰§è¡Œä¸€é</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">processElement</span></span>(i: <span class="type">SensorReading</span>, context: <span class="type">KeyedProcessFunction</span>[<span class="type">String</span>, <span class="type">SensorReading</span>, <span class="type">String</span>]#<span class="type">Context</span>, collector: <span class="type">Collector</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="comment">// è·å–ä¸Šæ¬¡æ¸©åº¦</span></span><br><span class="line">      <span class="keyword">val</span> lastTemperature: <span class="type">Double</span> = perTemperature.value()</span><br><span class="line">      <span class="comment">// æ›´æ–°æ¸©åº¦çš„çŠ¶æ€å˜é‡</span></span><br><span class="line">      perTemperature.update(i.temperature)</span><br><span class="line">      <span class="keyword">val</span> curTime: <span class="type">Long</span> = time.value()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ¸©åº¦ï¼Œåˆ™ä¸Šæ¡æ¸©åº¦ä¸º0 || æœ¬åœ°æ¸©åº¦æ¯”ä¸Šæ¬¡æ¸©åº¦ä½   å½“å‰æ˜¯åˆå§‹åŒ–æˆ–é™æ¸©è¶‹åŠ¿ï¼Œåˆ é™¤å®šæ—¶ä»»åŠ¡</span></span><br><span class="line">      <span class="keyword">if</span> (lastTemperature == <span class="number">0.0</span> || i.temperature&lt;lastTemperature) &#123;</span><br><span class="line">        <span class="comment">// åˆ é™¤æŠ¥è­¦å™¨ï¼Œå¹¶æ¸…ç©ºå®šæ—¶å™¨çš„çŠ¶æ€å˜é‡</span></span><br><span class="line">        context.timerService().deleteProcessingTimeTimer(curTime)</span><br><span class="line">        time.clear()</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯æ¸©åº¦å¤„äºä¸Šå‡è¶‹åŠ¿||å®šæ—¶å™¨æ˜¯æœªè®¾ç½®  åˆ™è¦è®¾ç½®å®šæ—¶å™¨</span></span><br><span class="line">      &#125;<span class="keyword">else</span> <span class="keyword">if</span>(i.temperature&gt; lastTemperature  &amp;&amp; curTime==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">// 1S å†…  å¦‚æœæ¸©åº¦æ²¡æœ‰ä¸‹é™è¶‹åŠ¿ï¼Œå³æ²¡æœ‰å–æ¶ˆå®šæ—¶å™¨ï¼Œåˆ™æŠ¥è­¦</span></span><br><span class="line">        <span class="keyword">val</span> l: <span class="type">Long</span> = context.timerService().currentProcessingTime() + <span class="number">1000</span></span><br><span class="line">        context.timerService().registerProcessingTimeTimer(l)</span><br><span class="line">        time.update(l)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¸è¦æŒ‰ç…§æ³¨é‡Šé‚£æ ·å†™ï¼Œè¡€çš„æ•™è®­  è¿™æ ·å†™ å®šæ—¶äº‹ä»¶çš„æ—¶é—´å’ŒçŠ¶æ€å˜é‡å­˜å‚¨çš„æ—¶é—´ä¸åŒï¼Œå¯¼è‡´æ— æ³•åˆ é™¤åº”è¯¥åˆ é™¤çš„å®šæ—¶äº‹ä»¶</span></span><br><span class="line"><span class="comment">//        context.timerService().registerProcessingTimeTimer(context.timerService().currentProcessingTime() + 1000)</span></span><br><span class="line"><span class="comment">//        time.update(context.timerService().currentProcessingTime() + 1000)</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šæ—¶å™¨è§¦å‘æ—¶æ‰§è¡Œçš„é€»è¾‘</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">onTimer</span></span>(timestamp: <span class="type">Long</span>, ctx: <span class="type">KeyedProcessFunction</span>[<span class="type">String</span>, <span class="type">SensorReading</span>, <span class="type">String</span>]#<span class="type">OnTimerContext</span>, out: <span class="type">Collector</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      out.collect(<span class="string">s&quot;æ¸©åº¦è®¡idä¸º<span class="subst">$&#123;ctx.getCurrentKey&#125;</span>çš„å®ä¾‹æ¸©åº¦åœ¨1Så†…è¿ç»­ä¸Šå‡ï¼&quot;</span>)</span><br><span class="line">      <span class="comment">// ä¸æ¸…ç©ºçš„è¯ï¼Œå¦‚æœæ¸©åº¦ç»§ç»­ä¸Šå‡åˆ™æ— æ³•è¿›è¡Œä¸‹ä¸€æ¬¡çš„æŠ¥è­¦</span></span><br><span class="line">      time.clear()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸ºäº†æ›´å¥½çš„å±•ç¤ºç»“æœï¼Œæ„é€ æ•°æ®éœ€è¦å‡å°‘äº§ç”Ÿé‡ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.flink.source</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Calendar</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.source.<span class="type">SourceFunction</span>.<span class="type">SourceContext</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.source.&#123;<span class="type">RichParallelSourceFunction</span>, <span class="type">SourceFunction</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scala.util.<span class="type">Random</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”Ÿæˆéšæœºæ•°æ®</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SensorSource</span> <span class="keyword">extends</span> <span class="title">RichParallelSourceFunction</span>[<span class="type">SensorReading</span>] </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> running = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>(sourceContext: <span class="type">SourceContext</span>[<span class="type">SensorReading</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> rand = <span class="keyword">new</span> <span class="type">Random</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> curFTemp = (<span class="number">1</span> to <span class="number">10</span>).map(</span><br><span class="line">      i =&gt; (<span class="string">&quot;sensor_&quot;</span> + i, rand.nextGaussian() * <span class="number">20</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (running) &#123;</span><br><span class="line">      curFTemp = curFTemp.map(</span><br><span class="line">        t =&gt; (t._1, t._2 + rand.nextGaussian() * <span class="number">0.5</span>)</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">val</span> curTime = <span class="type">Calendar</span>.getInstance.getTimeInMillis</span><br><span class="line"></span><br><span class="line">      curFTemp.foreach(t =&gt; sourceContext.collect(<span class="type">SensorReading</span>(t._1, curTime, t._2)))</span><br><span class="line"></span><br><span class="line">      <span class="type">Thread</span>.sleep(<span class="number">300</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">cancel</span></span>(): <span class="type">Unit</span> = running = <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>åªæœ‰ç”¨äº†Flinkçš„æµå¤„ç†æ‰èƒ½è®¡ç®—åˆ°è¿ç»­çš„æ•°æ®æµä¸­çš„çŠ¶æ€æ•°æ®å˜åŒ–ï¼Œè€Œå¦‚æœç”¨Sparkæ¥å®ç°è¿™ä¸ªåŠŸèƒ½çš„æ ¹æœ¬å®ç°ä¸äº†çš„ã€‚å› ä¸ºï¼š</p><ul><li>Sparkçš„æµå¤„ç†æ˜¯å¾®æ‰¹ï¼Œæ— æ³•ç›‘æ§åˆ°ä¸åŒå¾®æ‰¹æ•°æ®ä¸­çš„çŠ¶æ€ï¼Œå°±æ— æ³•è¿›è¡Œè¿ç»­1Sçš„æ•°æ®è®¡ç®—</li><li>å¦‚æœé‡‡ç”¨æ‰¹å¤„ç†çš„è¯ï¼Œæ˜¯å¯ä»¥ã€‚ä½†æ˜¯æ•°æ®çš„äº§ç”Ÿéƒ½æ˜¯å®æ—¶çš„ï¼Œæ ¹æœ¬ä¸èƒ½ç”¨æ‰¹å¤„ç†ã€‚å†™å†™DEMOå¯ä»¥ï¼Œå®é™…æ— ç”¨å¤„ã€‚</li></ul></blockquote><h2 id="CoProcessFunction"><a href="#CoProcessFunction" class="headerlink" title="CoProcessFunction"></a><strong><em>CoProcessFunction</em></strong></h2><p>å¯¹äºä¸¤æ¡è¾“å…¥æµï¼ŒDataStream APIæä¾›äº†CoProcessFunctionè¿™æ ·çš„low-levelæ“ä½œã€‚CoProcessFunctionæä¾›äº†æ“ä½œæ¯ä¸€ä¸ªè¾“å…¥æµçš„æ–¹æ³•: processElement1()å’ŒprocessElement2()ã€‚ç±»ä¼¼äºProcessFunctionï¼Œè¿™ä¸¤ç§æ–¹æ³•éƒ½é€šè¿‡Contextå¯¹è±¡æ¥è°ƒç”¨ã€‚è¿™ä¸ªContextå¯¹è±¡å¯ä»¥è®¿é—®äº‹ä»¶æ•°æ®ï¼Œå®šæ—¶å™¨æ—¶é—´æˆ³ï¼ŒTimerServiceï¼Œä»¥åŠside outputsã€‚<strong>CoProcessFunctionä¹Ÿæä¾›äº†onTimer()å›è°ƒå‡½æ•°</strong>ã€‚ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨CoProcessFunctionæ¥åˆå¹¶ä¸¤æ¡æµã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.flink.transform</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.&#123;<span class="type">ValueState</span>, <span class="type">ValueStateDescriptor</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.scala.typeutils.<span class="type">Types</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.co.<span class="type">CoProcessFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"><span class="keyword">import</span> org.example.flink.source.&#123;<span class="type">SensorReading</span>, <span class="type">SensorSource</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">CoProcessFunctionTest</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ingest sensor stream</span></span><br><span class="line">    <span class="keyword">val</span> readings: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = env.addSource(<span class="keyword">new</span> <span class="type">SensorSource</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// filter switches enable forwarding of readings</span></span><br><span class="line">    <span class="keyword">val</span> filterSwitches: <span class="type">DataStream</span>[(<span class="type">String</span>, <span class="type">Long</span>)] = env</span><br><span class="line">      .fromCollection(<span class="type">Seq</span>(</span><br><span class="line">        (<span class="string">&quot;sensor_2&quot;</span>, <span class="number">10</span> * <span class="number">1000</span>L),</span><br><span class="line">        (<span class="string">&quot;sensor_7&quot;</span>, <span class="number">60</span> * <span class="number">1000</span>L)</span><br><span class="line">      ))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> forwardedReadings = readings</span><br><span class="line">      <span class="comment">// connect readings and switches</span></span><br><span class="line">      .connect(filterSwitches)</span><br><span class="line">      <span class="comment">// key by sensor ids</span></span><br><span class="line">      .keyBy(_.id, _._1)</span><br><span class="line">      <span class="comment">// apply filtering CoProcessFunction</span></span><br><span class="line">      .process(<span class="keyword">new</span> <span class="type">ReadingFilter</span>).print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">ReadingFilter</span> <span class="keyword">extends</span> <span class="title">CoProcessFunction</span>[<span class="type">SensorReading</span>, (<span class="type">String</span>, <span class="type">Long</span>), <span class="type">SensorReading</span>] </span>&#123;</span><br><span class="line">    <span class="comment">// switch to enable forwarding</span></span><br><span class="line">    <span class="comment">// ä¼ é€æ•°æ®çš„å¼€å…³</span></span><br><span class="line">    <span class="keyword">lazy</span> <span class="keyword">val</span> forwardingEnabled: <span class="type">ValueState</span>[<span class="type">Boolean</span>] = getRuntimeContext</span><br><span class="line">      .getState(</span><br><span class="line">        <span class="keyword">new</span> <span class="type">ValueStateDescriptor</span>[<span class="type">Boolean</span>](<span class="string">&quot;filterSwitch&quot;</span>, <span class="type">Types</span>.of[<span class="type">Boolean</span>])</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// hold timestamp of currently active disable timer</span></span><br><span class="line">    <span class="keyword">lazy</span> <span class="keyword">val</span> disableTimer: <span class="type">ValueState</span>[<span class="type">Long</span>] = getRuntimeContext</span><br><span class="line">      .getState(</span><br><span class="line">        <span class="keyword">new</span> <span class="type">ValueStateDescriptor</span>[<span class="type">Long</span>](<span class="string">&quot;timer&quot;</span>, <span class="type">Types</span>.of[<span class="type">Long</span>])</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">processElement1</span></span>(reading: <span class="type">SensorReading</span>,</span><br><span class="line">                                 ctx: <span class="type">CoProcessFunction</span>[<span class="type">SensorReading</span>,</span><br><span class="line">                                   (<span class="type">String</span>, <span class="type">Long</span>), <span class="type">SensorReading</span>]#<span class="type">Context</span>,</span><br><span class="line">                                 out: <span class="type">Collector</span>[<span class="type">SensorReading</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="comment">// check if we may forward the reading</span></span><br><span class="line">      <span class="comment">// å†³å®šæˆ‘ä»¬æ˜¯å¦è¦å°†æ•°æ®ç»§ç»­ä¼ ä¸‹å»</span></span><br><span class="line">      <span class="keyword">if</span> (forwardingEnabled.value()) &#123;</span><br><span class="line">        out.collect(reading)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">processElement2</span></span>(switch: (<span class="type">String</span>, <span class="type">Long</span>),</span><br><span class="line">                                 ctx: <span class="type">CoProcessFunction</span>[<span class="type">SensorReading</span>,</span><br><span class="line">                                   (<span class="type">String</span>, <span class="type">Long</span>), <span class="type">SensorReading</span>]#<span class="type">Context</span>,</span><br><span class="line">                                 out: <span class="type">Collector</span>[<span class="type">SensorReading</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="comment">// enable reading forwarding</span></span><br><span class="line">      <span class="comment">// å…è®¸ç»§ç»­ä¼ è¾“æ•°æ®</span></span><br><span class="line">      forwardingEnabled.update(<span class="literal">true</span>)</span><br><span class="line">      <span class="comment">// set disable forward timer</span></span><br><span class="line">      <span class="keyword">val</span> timerTimestamp = ctx.timerService().currentProcessingTime()</span><br><span class="line">      + switch._2</span><br><span class="line"></span><br><span class="line">      <span class="keyword">val</span> curTimerTimestamp = disableTimer.value()</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (timerTimestamp &gt; curTimerTimestamp) &#123;</span><br><span class="line">        <span class="comment">// remove current timer and register new timer</span></span><br><span class="line">        ctx.timerService().deleteProcessingTimeTimer(curTimerTimestamp)</span><br><span class="line">        ctx.timerService().registerProcessingTimeTimer(timerTimestamp)</span><br><span class="line">        disableTimer.update(timerTimestamp)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">onTimer</span></span>(ts: <span class="type">Long</span>,</span><br><span class="line">                         ctx: <span class="type">CoProcessFunction</span>[<span class="type">SensorReading</span>,</span><br><span class="line">                           (<span class="type">String</span>, <span class="type">Long</span>), <span class="type">SensorReading</span>]#<span class="type">OnTimerContext</span>,</span><br><span class="line">                         out: <span class="type">Collector</span>[<span class="type">SensorReading</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="comment">// remove all state; forward switch will be false by default</span></span><br><span class="line">      forwardingEnabled.clear()</span><br><span class="line">      disableTimer.clear()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ProcessFunction"><a href="#ProcessFunction" class="headerlink" title="ProcessFunction"></a>ProcessFunction</h2><blockquote><p><code>process function</code>ä¸<code>KeyedProcessFunction</code>åŒºåˆ«ï¼š</p><p><code>KeyedProcessFunction</code>æ˜¯å¯¹äºkeybyåçš„æµè®¡ç®—ï¼Œè€Œ<code>process function</code>æ˜¯å¯¹keybyå‰çš„æµè®¡ç®—ï¼Œéƒ½æ˜¯ä¸€ä¸ªå…ƒç´ è§¦å‘ä¸€æ¬¡è®¡ç®—</p></blockquote><h1 id="ä¾§è¾“å‡ºæµ"><a href="#ä¾§è¾“å‡ºæµ" class="headerlink" title="ä¾§è¾“å‡ºæµ"></a>ä¾§è¾“å‡ºæµ</h1><p>ä¸Šé¢æˆ‘ä»¬è¯´è¿‡æ°´ä½çº¿åŠ ä¸Šæœ€å¤§å»¶è¿Ÿæ—¶é—´å¯ä¿è¯å°å¹…åº¦è¿Ÿåˆ°çš„æ•°æ®å¯ä»¥ç»§ç»­åŠ å…¥çª—å£è¢«è®¡ç®—ï¼Œä½†æ˜¯å¦‚æœæ•°æ®è¿Ÿåˆ°çš„ç¦»è°±ï¼Œè¿™æ—¶é…ç½®æœ€å¤§å»¶è¿Ÿæ—¶é—´è‚¯å®šæ²¡æœ‰ç”¨äº†ã€‚</p><p>å¦‚æœä¸è®¾ç½®å®ƒä¼šé»˜è®¤èˆå¼ƒè¿™ç§è¿Ÿåˆ°çš„æ—¶é—´ã€‚é™¤éæˆ‘ä»¬æ‰‹åŠ¨ä»£ç è®¾ç½®æ¥å¤„ç†è¿™äº›æ•°æ®ï¼Œæœ‰2ä¸­æ–¹å¼ã€‚</p><ol><li>å…è®¸è¿Ÿåˆ°çš„æ•°æ®ï¼Œä¸€å®šæ—¶é—´å†…ã€‚æ­¤æ—¶æ¥çš„æ•°æ®ä¸ä¹‹å‰çš„ç»“æœè¿›è¡Œèšåˆè®¡ç®—</li><li>è¾“å‡ºåˆ°ä¾§è¾“å‡ºæµ</li></ol><p>ä¸ä¹‹å‰èŠè¿‡çš„lambdaæ¶æ„ï¼Œæ‰¹å¤„ç†æä¾›æ•°æ®å‡†ç¡®æ€§ã€‚è€ŒFlinké€šè¿‡ä¸€ä¸ªæµå¤„ç†å°±èƒ½ä¿è¯æ•°æ®å‡†ç¡®æ€§ï¼Œä¹Ÿæ˜¯ä¾é äº†ä¸‹é¢ä¸‰ç‚¹ï¼š</p><blockquote><p>å‡†ç¡®è®¡ç®—æ€§çš„ä¸‰é‡ä¿è¯ï¼š</p><ol><li>watermarkï¼šå°†æ—¶é—´è¿›åº¦ç”±æ…¢çš„watermarkè°ƒæ§</li><li>allowedLatenessï¼šæ—¶é—´çª—å£ç»“æŸæ—¶é—´å°äºç­‰äºæ°´ä½çº¿åå¼€å§‹èšåˆè®¡ç®—ï¼Œè®¡ç®—ååˆæœ‰è¯¥æ—¶é—´èŒƒå›´å†…çš„æ•°æ®åˆ°è¾¾æ—¶ï¼Œè¿Ÿåˆ°çš„æ•°æ®æ¯ä¸ªå…ƒç´ è¿›å…¥éƒ½ä¼šå’ŒåŸçª—å£çš„ç»“æœè¿›è¡Œèšåˆ</li><li>ä¾§è¾“å‡ºæµï¼šæœ€åçš„æ•°æ®è¿›å…¥ä¾§è¾“å‡ºæµã€‚</li></ol></blockquote><hr><p>ä»¥ä¸‹ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œé€šè¿‡ä¸‰é‡ï¼šwatermarkå’Œæœ€å¤§å»¶è¿Ÿæ—¶é—´ã€å…è®¸è¿Ÿåˆ°æ—¶é—´ã€å’Œä¾§è¾“å‡ºæµä¿å­˜ä¸¢å¼ƒå…ƒç´ æ¥çœ‹å¤„ç†ä¹±åºå’Œè¿Ÿåˆ°æ•°æ®ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.flink.transform</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.&#123;<span class="type">ValueState</span>, <span class="type">ValueStateDescriptor</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.scala.typeutils.<span class="type">Types</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.<span class="type">TimeCharacteristic</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.timestamps.<span class="type">BoundedOutOfOrdernessTimestampExtractor</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.function.<span class="type">ProcessWindowFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows.<span class="type">TimeWindow</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">LaterDataDeal</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®äº‹ä»¶æ—¶é—´</span></span><br><span class="line">    env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">EventTime</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç«¯å£è¾“å…¥æ•°æ®</span></span><br><span class="line">    <span class="keyword">val</span> input: <span class="type">DataStream</span>[<span class="type">String</span>] = env.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">9999</span>, &#x27;\n&#x27;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ•°æ®çš„æ”¹è£…</span></span><br><span class="line">    <span class="keyword">val</span> mapStream: <span class="type">DataStream</span>[(<span class="type">String</span>, <span class="type">Long</span>)] = input.map(x =&gt; &#123;</span><br><span class="line">      <span class="keyword">val</span> spilt: <span class="type">Array</span>[<span class="type">String</span>] = x.split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">      (spilt(<span class="number">0</span>), spilt(<span class="number">1</span>).toLong * <span class="number">1000</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®æ°´ä½çº¿å’Œæœ€å¤§å»¶è¿Ÿæ—¶é—´</span></span><br><span class="line">    <span class="keyword">val</span> preStream: <span class="type">WindowedStream</span>[(<span class="type">String</span>, <span class="type">Long</span>), <span class="type">String</span>, windows.<span class="type">TimeWindow</span>] = mapStream.assignTimestampsAndWatermarks(<span class="keyword">new</span> <span class="type">BoundedOutOfOrdernessTimestampExtractor</span>[(<span class="type">String</span>, <span class="type">Long</span>)](<span class="type">Time</span>.seconds(<span class="number">5</span>)) &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(t: (<span class="type">String</span>, <span class="type">Long</span>)): <span class="type">Long</span> = t._2</span><br><span class="line">    &#125;)</span><br><span class="line">      <span class="comment">// åˆ†ç»„+å¼€çª—</span></span><br><span class="line">      .keyBy(_._1)</span><br><span class="line">      .timeWindow(<span class="type">Time</span>.seconds(<span class="number">5</span>))</span><br><span class="line">      <span class="comment">// è®¾ç½®å…è®¸è¿Ÿåˆ°æ•°æ®çš„æ—¶é—´</span></span><br><span class="line">      .allowedLateness(<span class="type">Time</span>.seconds(<span class="number">5</span>))</span><br><span class="line">      <span class="comment">// è®¾ç½®è¿Ÿåˆ°çš„æ•°æ®ï¼Œä¾§è¾“å‡ºæµ</span></span><br><span class="line">      .sideOutputLateData(<span class="keyword">new</span> <span class="type">OutputTag</span>[(<span class="type">String</span>, <span class="type">Long</span>)](<span class="string">&quot;later&quot;</span>))</span><br><span class="line"></span><br><span class="line">    preStream</span><br><span class="line">      <span class="comment">// è®¾ç½®å¤„ç†å‡½æ•°ï¼Œéœ€è¦åŒæ—¶è€ƒè™‘åˆ°ç¬¬ä¸€æ¬¡å¤„ç†  å’Œ  å› ä¸ºå…è®¸è¿Ÿåˆ°æ•°æ®åˆ°æ¥æ—¶å’Œä¹‹å‰å¤„ç†ç»“æœåˆå¹¶æ—¶çš„è®¡ç®—æ‰“å°ä¸åŒçš„å€¼</span></span><br><span class="line">      .process(<span class="keyword">new</span> <span class="type">MyCount1</span>).print()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MyCount1</span> <span class="keyword">extends</span> <span class="title">ProcessWindowFunction</span>[(<span class="type">String</span>, <span class="type">Long</span>), <span class="type">String</span>, <span class="type">String</span>, <span class="type">TimeWindow</span>]</span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">process</span></span>(key: <span class="type">String</span>, context: <span class="type">Context</span>, elements: <span class="type">Iterable</span>[(<span class="type">String</span>, <span class="type">Long</span>)], out: <span class="type">Collector</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="comment">// è®¾ç½®æ¯ä¸ªçª—å£å•ç‹¬çš„çŠ¶æ€å˜é‡ï¼Œç”¨äºåŒºåˆ«æ˜¯æ°´ä½çº¿è¿‡çª—å£ç»“æŸæ—¶é—´æ—¶çš„è®¡ç®—ï¼ˆç¬¬ä¸€æ¬¡ï¼‰è¿˜æ˜¯å…è®¸è¿Ÿåˆ°æ•°æ®æ¥ä¸´æ—¶å€™çš„èšåˆè®¡ç®—ï¼ˆåå‡ æ¬¡ï¼‰ï¼Œåªç”¨äºæ‰“å°ä¸åŒçš„å€¼ï¼Œå®é™…ä¸Šé€»è¾‘ä¸å¿…åˆ†å¼€å†™</span></span><br><span class="line">      <span class="keyword">val</span> flag: <span class="type">ValueState</span>[<span class="type">Boolean</span>] = context.windowState.getState(<span class="keyword">new</span> <span class="type">ValueStateDescriptor</span>[<span class="type">Boolean</span>](<span class="string">&quot;flag&quot;</span>, <span class="type">Types</span>.of[<span class="type">Boolean</span>]))</span><br><span class="line"></span><br><span class="line">      <span class="comment">// flagé»˜è®¤false</span></span><br><span class="line">      <span class="comment">// falseæ—¶æ˜¯ç¬¬ä¸€æ¬¡è®¡ç®—ï¼Œå³æ°´ä½çº¿è¶…è¿‡çª—å£ç»“æŸæ—¶é—´æ—¶å€™</span></span><br><span class="line">      <span class="keyword">if</span> (!flag.value())&#123;</span><br><span class="line">        out.collect(<span class="string">s&quot;çª—å£å¼€å§‹ç¬¬ä¸€æ¬¡è®¡ç®—ï¼ˆæ°´ä½çº¿æ­¤æ—¶å·²ç»è¶…è¿‡çª—å£ç»“æŸæ—¶é—´ï¼‰ï¼Œæ­¤æ—¶çª—å£å†…çš„å…ƒç´ çš„ä¸ªæ•°ä¸º<span class="subst">$&#123;elements.size&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment">// æ›´æ–°çŠ¶æ€</span></span><br><span class="line">        flag.update(<span class="literal">true</span>)</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// æ­¤æ—¶æ˜¯å› ä¸ºå…è®¸è¿Ÿåˆ°æ•°æ®å¼€å§‹çš„èšåˆè®¡ç®—ï¼Œæ­¤æ—¶æ­¤çª—å£å·²ç»è®¡ç®—äº†ä¸€ä¸ªç»“æœï¼Œä½†æ˜¯å› ä¸ºå…è®¸è¿Ÿåˆ°æ•°æ®çš„æ—¶é—´æœªè¿‡ï¼Œæ‰€ä»¥çª—å£æœªå…³é—­ï¼Œæ­¤æ—¶æ¥ä¸€æ¡æ•°æ®éœ€è¦è®¡ç®—ä¸€æ¬¡</span></span><br><span class="line">        out.collect(<span class="string">s&quot;çª—å£æ•´åˆè¿Ÿåˆ°çš„æ•°æ®å¼€å§‹è®¡ç®—...ï¼Œæ­¤æ—¶çª—å£å†…çš„å…ƒç´ çš„ä¸ªæ•°ä¸º<span class="subst">$&#123;elements.size&#125;</span>&quot;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210102155853069.png" alt="image-20210102155853069"></p><p>å¯ä»¥çœ‹åˆ°å› ä¸ºæ°´ä½çº¿çš„å…³ç³»ï¼Œçª—å£[0,5)è™½ç„¶åœ¨äº‹ä»¶æ—¶é—´7åˆ°è¾¾æ—¶è¿˜æ²¡æœ‰è§¦å‘è®¡ç®—ï¼Œ7ä¹‹åçš„2è¿˜è¢«ç›´æ¥çº³å…¥äº†çª—å£[0,5)ï¼Œå½“äº‹ä»¶æ—¶é—´10åˆ°è¾¾æ—¶ï¼Œæ°´ä½çº¿å·²ç»åˆ°è¾¾äº†çª—å£çš„å…³é—­æ—¶é—´ï¼Œå¯¼è‡´çª—å£è®¡ç®—ï¼Œæ­¤æ—¶çª—å£å†…å…ƒç´ ä¸º3ã€‚</p><p>ç„¶åç»§ç»­è¾“å…¥çª—å£[0,5)çš„æ•°æ®</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210102160109858.png" alt="image-20210102160109858"></p><p>å‘ç°è¿Ÿåˆ°çš„æ•°æ®å†æ¬¡å’Œ[0,5)ä¹‹å‰çš„ç»“æœæ•´åˆè®¡ç®—ï¼Œè¿™æ˜¯å› ä¸ºè®¾ç½®äº†<code>.allowedLateness(Time.seconds(5))</code>å…è®¸è¿Ÿåˆ°çš„æ—¶é—´ä¸º5ï¼Œåœ¨æ­¤æ—¶é—´åŒºé—´å†…åˆ°è¾¾çš„æ•°æ®ä¼šæ¯æ¡å’Œä¹‹å‰çª—å£çš„è®¡ç®—ç»“æœè¿›è¡Œæ•´åˆè®¡ç®—ã€‚å½“è¶…è¿‡è¿™5ç§’æ—¶ï¼Œå†æ¬¡åˆ°è¾¾çš„[0,5)çª—å£æ•°æ®å°†è¢«ä¸¢å¼ƒã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210102160331132.png" alt="image-20210102160331132"></p><p>ç¬¬ä¸€ä¸ªæ˜¯[5,10)çš„çª—å£ï¼Œå½“å…è®¸è¶…æ—¶æ—¶é—´è¿‡å»åï¼Œå†æ¬¡è¾“å…¥[0,5)çª—å£æ•°æ®ï¼Œæ•°æ®è¢«ä¸¢å¼ƒï¼Œå­˜åˆ°äº†ä¾§è¾“å‡ºæµ<code>later</code></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;æˆ‘ä»¬å°†ä»‹ç»æ—¶é—´è¯­ä¹‰ï¼Œå¹¶æè¿°æµä¸­ä¸åŒçš„æ—¶é—´æ¦‚å¿µã€‚æˆ‘ä»¬å°†è®¨è®ºæµå¤„ç†å™¨åœ¨ä¹±åºäº‹ä»¶æµçš„æƒ…å†µä¸‹å¦‚ä½•æä¾›å‡†ç¡®çš„è®¡ç®—ç»“æœï¼Œä»¥åŠæˆ‘ä»¬å¦‚ä½•å¤„ç†å†å²äº‹ä»¶æµï¼Œå¦‚ä½•</summary>
      
    
    
    
    <category term="Flink" scheme="https://awslzhang.top/categories/Flink/"/>
    
    
    <category term="Flink" scheme="https://awslzhang.top/tags/Flink/"/>
    
  </entry>
  
  <entry>
    <title>Flink Apiå­¦ä¹ </title>
    <link href="https://awslzhang.top/2020/12/17/Flink-API/"/>
    <id>https://awslzhang.top/2020/12/17/Flink-API/</id>
    <published>2020-12-17T12:36:28.000Z</published>
    <updated>2021-01-02T10:05:23.110Z</updated>
    
    <content type="html"><![CDATA[<h1 id="DataStream-API"><a href="#DataStream-API" class="headerlink" title="DataStream API"></a>DataStream API</h1><p>æ‰€æœ‰çš„Flinkç¨‹åºéƒ½æ˜¯ç”±ä¸‰éƒ¨åˆ†ç»„æˆçš„ï¼š Source ã€Transformation å’Œ Sinkã€‚</p><p>Source è´Ÿè´£è¯»å–æ•°æ®æºï¼ŒTransformation åˆ©ç”¨å„ç§ç®—å­è¿›è¡Œå¤„ç†åŠ å·¥ï¼ŒSink è´Ÿè´£è¾“å‡ºã€‚</p><p>æ‰€ä»¥ç»ƒä¹ APIï¼ŒSourceæ˜¯å¿…ä¸å¯å°‘çš„ï¼Œæ²¡æœ‰æ•°æ®æºå°±æ²¡æœ‰ç¬¬ä¸€æ­¥ã€‚è¿™é‡Œä½¿ç”¨æ‰‹åŠ¨é€ æ•°æ®çš„æ–¹æ³•ï¼Œè€ŒFlinkæä¾›äº†ä¸€ä¸‹æ–¹å¼ã€‚</p><h2 id="æ­å»ºæ‰§è¡Œç¯å¢ƒ"><a href="#æ­å»ºæ‰§è¡Œç¯å¢ƒ" class="headerlink" title="æ­å»ºæ‰§è¡Œç¯å¢ƒ"></a>æ­å»ºæ‰§è¡Œç¯å¢ƒ</h2><p>ç¼–å†™Flinkç¨‹åºçš„ç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯æ­å»ºæ‰§è¡Œç¯å¢ƒã€‚æ‰§è¡Œç¯å¢ƒå†³å®šäº†ç¨‹åºæ˜¯è¿è¡Œåœ¨å•æœºä¸Šè¿˜æ˜¯é›†ç¾¤ä¸Šã€‚åœ¨DataStream APIä¸­ï¼Œç¨‹åºçš„æ‰§è¡Œç¯å¢ƒæ˜¯ç”±StreamExecutionEnvironmentè®¾ç½®çš„ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨é™æ€getExecutionEnvironment()æ–¹æ³•æ¥è·å–æ‰§è¡Œç¯å¢ƒã€‚è¿™ä¸ªæ–¹æ³•æ ¹æ®è°ƒç”¨æ–¹æ³•çš„ä¸Šä¸‹æ–‡ï¼Œè¿”å›ä¸€ä¸ªæœ¬åœ°çš„æˆ–è€…è¿œç¨‹çš„ç¯å¢ƒã€‚å¦‚æœè¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯æäº¤åˆ°è¿œç¨‹é›†ç¾¤çš„ä»£ç è°ƒç”¨çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•å°†ä¼šè¿”å›ä¸€ä¸ªè¿œç¨‹çš„æ‰§è¡Œç¯å¢ƒã€‚å¦åˆ™ï¼Œå°†è¿”å›æœ¬åœ°æ‰§è¡Œç¯å¢ƒã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create a local stream execution environment</span></span><br><span class="line"><span class="keyword">val</span> localEnv = <span class="type">StreamExecutionEnvironment</span></span><br><span class="line">  .createLocalEnvironment()</span><br><span class="line"><span class="comment">// create a remote stream execution environment</span></span><br><span class="line"><span class="keyword">val</span> remoteEnv = <span class="type">StreamExecutionEnvironment</span></span><br><span class="line">  .createRemoteEnvironment(</span><br><span class="line">    <span class="string">&quot;host&quot;</span>, <span class="comment">// hostname of JobManager</span></span><br><span class="line">    <span class="number">1234</span>, <span class="comment">// port of JobManager process</span></span><br><span class="line">    <span class="string">&quot;path/to/jarFile.jar&quot;</span></span><br><span class="line">  ) <span class="comment">// JAR file to ship to the JobManager</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime)</code>æ¥å°†æˆ‘ä»¬ç¨‹åºçš„æ—¶é—´è¯­ä¹‰è®¾ç½®ä¸ºäº‹ä»¶æ—¶é—´ã€‚æ‰§è¡Œç¯å¢ƒæä¾›äº†å¾ˆå¤šé…ç½®é€‰é¡¹ï¼Œä¾‹å¦‚ï¼šè®¾ç½®ç¨‹åºçš„å¹¶è¡Œåº¦å’Œç¨‹åºæ˜¯å¦å¼€å¯å®¹é”™æœºåˆ¶ã€‚</p><h2 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h2><ul><li>ä»é›†åˆä¸­è¯»å–ï¼šfromElementsã€fromCollection</li><li>ä»æ–‡ä»¶ä¸­è¯»å–ï¼šreadTextFile</li><li>ä»ç½‘ç»œsockï¼šsocketTextStream</li><li>Kafkaæ•°æ®æº ï¼šï¼ˆé¢å¤–å¯¼åŒ…ï¼‰</li></ul><h3 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h3><p><strong>pom</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-kafka-0.10_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>0.10æ˜¯Kafkaç‰ˆæœ¬</p></blockquote><p>ä½¿ç”¨addSourceé€šç”¨æ•°æ®æºï¼ŒaddSource(SourceFunction)ï¼Œä½¿ç”¨å¯Œå‡½æ•°SourceFunctionï¼ˆéœ€è¦éšå¼è½¬æ¢ï¼‰ä¹Ÿå¯ä»¥ã€‚ä¸‹é¢çš„è‡ªå®šä¹‰æ•°æ®æºå°±æ˜¯è¿™ä¸ªåŸç†ã€‚</p><p>æ—¢ç„¶addSourceéœ€è¦SourceFunctionçš„å‚æ•°éš¾é“ç”¨æˆ‘ä»¬è‡ªå·±å®ç°å—ï¼Œä¸ç”¨ï¼Œæ—¢ç„¶æˆ‘ä»¬å¯¼äº†åŒ…å°±èƒ½ç›´æ¥ç”¨ç°æˆçš„ï¼</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> kafkaProps = <span class="keyword">new</span> <span class="type">Properties</span>()</span><br><span class="line"> kafkaProps.setProperty(<span class="string">&quot;zookeeper.connect&quot;</span>, <span class="type">ZOOKEEPER_HOST</span>)</span><br><span class="line"> kafkaProps.setProperty(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="type">KAFKA_BROKER</span>)</span><br><span class="line"> kafkaProps.setProperty(<span class="string">&quot;group.id&quot;</span>, <span class="type">TRANSACTION_GROUP</span>)</span><br><span class="line"></span><br><span class="line"> <span class="comment">//topicdçš„åå­—æ˜¯newï¼Œschemaé»˜è®¤ä½¿ç”¨SimpleStringSchema()å³å¯</span></span><br><span class="line"> <span class="keyword">val</span> transaction = env</span><br><span class="line">   .addSource(</span><br><span class="line">     <span class="keyword">new</span> <span class="type">FlinkKafkaConsumer08</span>[<span class="type">String</span>](<span class="string">&quot;new&quot;</span>, <span class="keyword">new</span> <span class="type">SimpleStringSchema</span>(), kafkaProps)</span><br><span class="line">   )</span><br></pre></td></tr></table></figure><h3 id="è‡ªå®šä¹‰"><a href="#è‡ªå®šä¹‰" class="headerlink" title="è‡ªå®šä¹‰"></a>è‡ªå®šä¹‰</h3><p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ¸©åº¦å™¨ï¼Œå¹¶éšæœºå®ƒçš„æ•°æ®ï¼š</p><p><strong>åˆ›å»ºæ•°æ®ç»“æ„</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zxjgg.source</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">SensorReading</span>(<span class="params">id: <span class="type">String</span>, temperature: <span class="type">Double</span>, timestamp: <span class="type">Long</span></span>)</span></span><br></pre></td></tr></table></figure><p><strong>ç”Ÿæˆæ•°æ®</strong></p><p>éœ€è¦é›†æˆFlinkçš„ç±»ï¼Œå› ä¸ºä¹‹åè¦ç”¨Flinkæ¥å¤„ç†è¿™äº›æ•°æ®</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zxjgg.source</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.source.&#123;<span class="type">RichParallelSourceFunction</span>, <span class="type">SourceFunction</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scala.util.<span class="type">Random</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SensorSource</span> <span class="keyword">extends</span> <span class="title">RichParallelSourceFunction</span>[<span class="type">SensorReading</span>] </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> running: <span class="type">Boolean</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>(sourceContext: <span class="type">SourceFunction</span>.<span class="type">SourceContext</span>[<span class="type">SensorReading</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> random = <span class="keyword">new</span> <span class="type">Random</span>()</span><br><span class="line">    <span class="keyword">val</span> result = (<span class="number">1</span> to <span class="number">10</span>).map(x =&gt; (x + <span class="string">&quot;&quot;</span>, random.nextGaussian() * <span class="number">20</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (running) &#123;</span><br><span class="line">      result.map(x =&gt; (x._1, x._2 + random.nextGaussian() * <span class="number">0.5</span>))</span><br><span class="line">      result.foreach(x =&gt; sourceContext.collect(<span class="type">SensorReading</span>(x._1, x._2, <span class="type">System</span>.currentTimeMillis())))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">cancel</span></span>(): <span class="type">Unit</span> = running = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æµ‹è¯•æ•°æ®å¤„ç†</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zxjgg.source</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> value:<span class="type">DataStream</span>[<span class="type">SensorReading</span>] = env.addSource(<span class="keyword">new</span> <span class="type">SensorSource</span>)</span><br><span class="line">    value.print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°Flinkç¨‹åºçš„å®šä¹‰å’Œæäº¤æ‰§è¡Œä½¿ç”¨çš„å°±æ˜¯æ­£å¸¸çš„Scalaæˆ–è€…Javaçš„æ–¹æ³•ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™äº›ä»£ç éƒ½å†™åœ¨ä¸€ä¸ªé™æ€mainæ–¹æ³•ä¸­ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†Testå¯¹è±¡ï¼Œç„¶åå°†å¤§å¤šæ•°çš„åº”ç”¨ç¨‹åºé€»è¾‘æ”¾åœ¨äº†main()ä¸­ã€‚</p><p>Flinkæµå¤„ç†ç¨‹åºçš„ç»“æ„å¦‚ä¸‹ï¼š</p><ol><li>åˆ›å»ºFlinkç¨‹åºæ‰§è¡Œç¯å¢ƒã€‚</li><li>ä»æ•°æ®æºè¯»å–ä¸€æ¡æˆ–è€…å¤šæ¡æµæ•°æ®</li><li>ä½¿ç”¨æµè½¬æ¢ç®—å­å®ç°ä¸šåŠ¡é€»è¾‘</li><li>å°†è®¡ç®—ç»“æœè¾“å‡ºåˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªå¤–éƒ¨è®¾å¤‡ï¼ˆå¯é€‰ï¼‰</li><li>æ‰§è¡Œç¨‹åº</li></ol><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¯¦ç»†çš„å­¦ä¹ ä¸€ä¸‹è¿™äº›éƒ¨åˆ†ã€‚</p><h2 id="Sink"><a href="#Sink" class="headerlink" title="Sink"></a>Sink</h2><p>Flinkæ²¡æœ‰ç±»ä¼¼äºsparkä¸­foreachæ–¹æ³•ï¼Œè®©ç”¨æˆ·è¿›è¡Œè¿­ä»£çš„æ“ä½œã€‚è™½æœ‰å¯¹å¤–çš„è¾“å‡ºæ“ä½œéƒ½è¦åˆ©ç”¨Sinkå®Œæˆã€‚æœ€åé€šè¿‡ç±»ä¼¼å¦‚ä¸‹æ–¹å¼å®Œæˆæ•´ä¸ªä»»åŠ¡æœ€ç»ˆè¾“å‡ºæ“ä½œã€‚</p><p><code> stream.addSink(new MySink(xxxx))</code></p><p>å®˜æ–¹æä¾›äº†ä¸€éƒ¨åˆ†çš„æ¡†æ¶çš„sinkã€‚é™¤æ­¤ä»¥å¤–ï¼Œéœ€è¦ç”¨æˆ·è‡ªå®šä¹‰å®ç°sinkã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210101142032322.png" alt="image-20210101142032322"></p><p>ç¬¬ä¸‰æ–¹ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210101142045980.png" alt="image-20210101142045980"></p><p>å…¶ä»–çš„éœ€è¦è‡ªå®šä¹‰ï¼ï¼</p><h3 id="Kafka-1"><a href="#Kafka-1" class="headerlink" title="Kafka"></a>Kafka</h3><p>ç»§ä¸Šé¢çš„Kafkaçš„Sourceï¼Œç»§ç»­å†™Sink</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dataStream.addSink(<span class="keyword">new</span> <span class="type">FlinkKafkaProducer011</span>[<span class="type">String</span>](<span class="string">&quot;localhost:9092&quot;</span>, <span class="string">&quot;topic&quot;</span>, <span class="keyword">new</span> <span class="type">SimpleStringSchema</span>()))</span><br></pre></td></tr></table></figure><h3 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h3><p>å› ä¸ºå®˜æ–¹æ²¡æœ‰Redisçš„Sinkï¼Œä½†æ˜¯Bahiræä¾›äº†ã€‚æ‰€ä»¥éœ€è¦å¼•å…¥å®ƒçš„åŒ…ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.bahir<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-redis_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å®šä¹‰ä¸€ä¸ªredisçš„mapperç±»ï¼Œç”¨äºå®šä¹‰ä¿å­˜åˆ°redisæ—¶è°ƒç”¨çš„å‘½ä»¤ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyRedisMapper</span> <span class="keyword">extends</span> <span class="title">RedisMapper</span>[<span class="type">SensorReading</span>]</span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getCommandDescription</span></span>: <span class="type">RedisCommandDescription</span> = &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="type">RedisCommandDescription</span>(<span class="type">RedisCommand</span>.<span class="type">HSET</span>, <span class="string">&quot;sensor_temperature&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getValueFromData</span></span>(t: <span class="type">SensorReading</span>): <span class="type">String</span> = t.temperature.toString</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getKeyFromData</span></span>(t: <span class="type">SensorReading</span>): <span class="type">String</span> = t.id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸»å‡½æ•°ä¸­è°ƒç”¨ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">FlinkJedisPoolConfig</span>.<span class="type">Builder</span>().setHost(<span class="string">&quot;localhost&quot;</span>).setPort(<span class="number">6379</span>).build()</span><br><span class="line">dataStream.addSink( <span class="keyword">new</span> <span class="type">RedisSink</span>[<span class="type">SensorReading</span>](conf, <span class="keyword">new</span> <span class="type">MyRedisMapper</span>))</span><br></pre></td></tr></table></figure><h3 id="ElasticSearch"><a href="#ElasticSearch" class="headerlink" title="ElasticSearch"></a>ElasticSearch</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-elasticsearch6_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸»å‡½æ•°ä¸­è°ƒç”¨</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> httpHosts = <span class="keyword">new</span> util.<span class="type">ArrayList</span>[<span class="type">HttpHost</span>]()</span><br><span class="line">httpHosts.add(<span class="keyword">new</span> <span class="type">HttpHost</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">9200</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> esSinkBuilder = <span class="keyword">new</span> <span class="type">ElasticsearchSink</span>.<span class="type">Builder</span>[<span class="type">SensorReading</span>]( httpHosts, <span class="keyword">new</span> <span class="type">ElasticsearchSinkFunction</span>[<span class="type">SensorReading</span>] &#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">process</span></span>(t: <span class="type">SensorReading</span>, runtimeContext: <span class="type">RuntimeContext</span>, requestIndexer: <span class="type">RequestIndexer</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    println(<span class="string">&quot;saving data: &quot;</span> + t)</span><br><span class="line">    <span class="keyword">val</span> json = <span class="keyword">new</span> util.<span class="type">HashMap</span>[<span class="type">String</span>, <span class="type">String</span>]()</span><br><span class="line">    json.put(<span class="string">&quot;data&quot;</span>, t.toString)</span><br><span class="line">    <span class="keyword">val</span> indexRequest = <span class="type">Requests</span>.indexRequest().index(<span class="string">&quot;sensor&quot;</span>).`<span class="class"><span class="keyword">type</span>`(<span class="params">&quot;readingData&quot;</span>).<span class="title">source</span>(<span class="params">json</span>)</span></span><br><span class="line"><span class="class">    <span class="title">requestIndexer</span>.<span class="title">add</span>(<span class="params">indexRequest</span>)</span></span><br><span class="line"><span class="class">    <span class="title">println</span>(<span class="params">&quot;saved successfully&quot;</span>)</span></span><br><span class="line"><span class="class">  &#125;</span></span><br><span class="line"><span class="class">&#125; )</span></span><br><span class="line"><span class="class"><span class="title">dataStream</span>.<span class="title">addSink</span>(<span class="params"> esSinkBuilder.build(</span>) )</span></span><br><span class="line"><span class="class"></span></span><br></pre></td></tr></table></figure><h3 id="JDBC-1-10æ²¡æœ‰"><a href="#JDBC-1-10æ²¡æœ‰" class="headerlink" title="JDBC(1.10æ²¡æœ‰)"></a>JDBC(1.10æ²¡æœ‰)</h3><p><strong>1.11åæœ‰ï¼Œè¿™ç§ä¸å¤Ÿçµæ´»ï¼Œä¸èƒ½æ ¹æ®æƒ…å†µè¿›è¡Œæ’å…¥æˆ–è€…æ›´æ–°ã€‚</strong></p><p><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/jdbc.html">Apache Flink 1.12 Documentation: JDBC Connector</a></p><p>This connector provides a sink that writes data to a JDBC database.</p><p>To use it, add the following dependency to your project (along with your JDBC-driver):</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-jdbc_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Note that the streaming connectors are currently <strong>NOT</strong> part of the binary distribution. See how to link with them for cluster execution <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/project-configuration.html">here</a>.</p><p>Created JDBC sink provides at-least-once guarantee. Effectively exactly-once can be achieved using upsert statements or idempotent updates.</p><p>Example usage:</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">StreamExecutionEnvironment</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment();</span><br><span class="line">env</span><br><span class="line">        .fromElements(...)</span><br><span class="line">        .addSink(<span class="type">JdbcSink</span>.sink(</span><br><span class="line">                <span class="string">&quot;insert into books (id, title, author, price, qty) values (?,?,?,?,?)&quot;</span>,</span><br><span class="line">                (ps, t) -&gt; &#123;</span><br><span class="line">                    ps.setInt(<span class="number">1</span>, t.id);</span><br><span class="line">                    ps.setString(<span class="number">2</span>, t.title);</span><br><span class="line">                    ps.setString(<span class="number">3</span>, t.author);</span><br><span class="line">                    ps.setDouble(<span class="number">4</span>, t.price);</span><br><span class="line">                    ps.setInt(<span class="number">5</span>, t.qty);</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="type">JdbcConnectionOptions</span>.<span class="type">JdbcConnectionOptionsBuilder</span>()</span><br><span class="line">                        .withUrl(getDbMetadata().getUrl())</span><br><span class="line">                        .withDriverName(getDbMetadata().getDriverClass())</span><br><span class="line">                        .build()));</span><br><span class="line">env.execute();</span><br></pre></td></tr></table></figure><p>Please refer to the <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/api/java/org/apache/flink/connector/jdbc/JdbcSink.html">API documentation</a> for more details.</p><h4 id="è‡ªå®šä¹‰-1"><a href="#è‡ªå®šä¹‰-1" class="headerlink" title="è‡ªå®šä¹‰"></a>è‡ªå®šä¹‰</h4><p>1.10ä»¥åŠä»¥å‰æ²¡æœ‰å®˜æ–¹çš„ï¼Œéœ€è¦è‡ªå®šä¹‰ã€‚éœ€è¦ä½¿ç”¨å¯Œå‡½æ•°çš„<code>SinkFunction</code>ï¼Œä½¿ç”¨å¯Œå‡½æ•°çš„ç”Ÿå‘½å‘¨æœŸæ¥åˆ›å»ºå’Œå…³é—­JDBCçš„è¿æ¥</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyJdbcSink</span>(<span class="params"></span>) <span class="keyword">extends</span> <span class="title">RichSinkFunction</span>[<span class="type">SensorReading</span>]</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> conn: <span class="type">Connection</span> = _</span><br><span class="line">  <span class="keyword">var</span> insertStmt: <span class="type">PreparedStatement</span> = _</span><br><span class="line">  <span class="keyword">var</span> updateStmt: <span class="type">PreparedStatement</span> = _</span><br><span class="line"></span><br><span class="line">  <span class="comment">// open ä¸»è¦æ˜¯åˆ›å»ºè¿æ¥</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">open</span></span>(parameters: <span class="type">Configuration</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">super</span>.open(parameters)</span><br><span class="line"></span><br><span class="line">    conn = <span class="type">DriverManager</span>.getConnection(<span class="string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>, <span class="string">&quot;root&quot;</span>, <span class="string">&quot;123456&quot;</span>)</span><br><span class="line">    insertStmt = conn.prepareStatement(<span class="string">&quot;INSERT INTO temperatures (sensor, temp) VALUES (?, ?)&quot;</span>)</span><br><span class="line">    updateStmt = conn.prepareStatement(<span class="string">&quot;UPDATE temperatures SET temp = ? WHERE sensor = ?&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è°ƒç”¨è¿æ¥ï¼Œæ‰§è¡Œsql</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">invoke</span></span>(value: <span class="type">SensorReading</span>, context: <span class="type">SinkFunction</span>.<span class="type">Context</span>[_]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    </span><br><span class="line">updateStmt.setDouble(<span class="number">1</span>, value.temperature)</span><br><span class="line">    updateStmt.setString(<span class="number">2</span>, value.id)</span><br><span class="line">    updateStmt.execute()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (updateStmt.getUpdateCount == <span class="number">0</span>) &#123;</span><br><span class="line">      insertStmt.setString(<span class="number">1</span>, value.id)</span><br><span class="line">      insertStmt.setDouble(<span class="number">2</span>, value.temperature)</span><br><span class="line">      insertStmt.execute()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">close</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">    insertStmt.close()</span><br><span class="line">    updateStmt.close()</span><br><span class="line">    conn.close()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è½¬æ¢ç®—å­"><a href="#è½¬æ¢ç®—å­" class="headerlink" title="è½¬æ¢ç®—å­"></a><a href="#%E8%BD%AC%E6%8D%A2%E7%AE%97%E5%AD%90">è½¬æ¢ç®—å­</a></h2><p>åœ¨è¿™ä¸€å°èŠ‚æˆ‘ä»¬å°†å¤§æ¦‚çœ‹ä¸€ä¸‹DataStream APIçš„åŸºæœ¬è½¬æ¢ç®—å­ã€‚ä¸æ—¶é—´æœ‰å…³çš„æ“ä½œç¬¦ï¼ˆä¾‹å¦‚çª—å£æ“ä½œç¬¦å’Œå…¶ä»–ç‰¹æ®Šçš„è½¬æ¢ç®—å­ï¼‰å°†ä¼šåœ¨åé¢çš„ç« èŠ‚å™è¿°ã€‚ä¸€ä¸ªæµçš„è½¬æ¢æ“ä½œå°†ä¼šåº”ç”¨åœ¨ä¸€ä¸ªæˆ–è€…å¤šä¸ªæµä¸Šé¢ï¼Œè¿™äº›è½¬æ¢æ“ä½œå°†æµè½¬æ¢æˆä¸€ä¸ªæˆ–è€…å¤šä¸ªè¾“å‡ºæµã€‚ç¼–å†™ä¸€ä¸ªDataStream APIç®€å•æ¥è¯´å°±æ˜¯å°†è¿™äº›è½¬æ¢ç®—å­ç»„åˆåœ¨ä¸€èµ·æ¥æ„å»ºä¸€ä¸ªæ•°æ®æµå›¾ï¼Œè¿™ä¸ªæ•°æ®æµå›¾å°±å®ç°äº†æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘ã€‚</p><p><font color="red"><strong>å¤§éƒ¨åˆ†çš„æµè½¬æ¢æ“ä½œéƒ½åŸºäºç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°UDF</strong></font>ã€‚UDFå‡½æ•°æ‰“åŒ…äº†ä¸€äº›ä¸šåŠ¡é€»è¾‘å¹¶å®šä¹‰äº†è¾“å…¥æµçš„å…ƒç´ å¦‚ä½•è½¬æ¢æˆè¾“å‡ºæµçš„å…ƒç´ ã€‚åƒ<code>MapFunction</code>è¿™æ ·çš„å‡½æ•°ï¼Œå°†ä¼šè¢«å®šä¹‰ä¸ºç±»ï¼Œè¿™ä¸ªç±»å®ç°äº†Flinké’ˆå¯¹ç‰¹å®šçš„è½¬æ¢æ“ä½œæš´éœ²å‡ºæ¥çš„æ¥å£ã€‚è™½ç„¶åŒ¿åå‡½æ•°å¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯é€»è¾‘å¤æ‚æ—¶è¿‡é•¿çš„åŒ¿åå‡½æ•°ä¼šæ˜¾å¾—é€»è¾‘æ··ä¹±ã€‚</p><p>DataStream APIé’ˆå¯¹å¤§å¤šæ•°æ•°æ®è½¬æ¢æ“ä½œæä¾›äº†è½¬æ¢ç®—å­ã€‚å¦‚æœä½ å¾ˆç†Ÿæ‚‰æ‰¹å¤„ç†APIã€å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€æˆ–è€…SQLï¼Œé‚£ä¹ˆä½ å°†ä¼šå‘ç°è¿™äº›APIå¾ˆå®¹æ˜“å­¦ä¹ ã€‚æˆ‘ä»¬ä¼šå°†DataStream APIçš„è½¬æ¢ç®—å­åˆ†æˆå››ç±»ï¼š</p><ul><li>åŸºæœ¬è½¬æ¢ç®—å­ï¼šå°†ä¼šä½œç”¨åœ¨æ•°æ®æµä¸­çš„æ¯ä¸€æ¡å•ç‹¬çš„æ•°æ®ä¸Šã€‚</li><li>KeyedStreamè½¬æ¢ç®—å­ï¼šåœ¨æ•°æ®æœ‰keyçš„æƒ…å†µä¸‹ï¼Œå¯¹æ•°æ®åº”ç”¨è½¬æ¢ç®—å­ã€‚</li><li>å¤šæµè½¬æ¢ç®—å­ï¼šåˆå¹¶å¤šæ¡æµä¸ºä¸€æ¡æµæˆ–è€…å°†ä¸€æ¡æµåˆ†å‰²ä¸ºå¤šæ¡æµã€‚</li><li>åˆ†å¸ƒå¼è½¬æ¢ç®—å­ï¼šå°†é‡æ–°ç»„ç»‡æµé‡Œé¢çš„äº‹ä»¶ã€‚</li></ul><h3 id="åŸºæœ¬è½¬æ¢ç®—å­"><a href="#åŸºæœ¬è½¬æ¢ç®—å­" class="headerlink" title="åŸºæœ¬è½¬æ¢ç®—å­"></a><a href="#%E5%9F%BA%E6%9C%AC%E8%BD%AC%E6%8D%A2%E7%AE%97%E5%AD%90">åŸºæœ¬è½¬æ¢ç®—å­</a></h3><p><strong>åŸºæœ¬è½¬æ¢ç®—å­ä¼šé’ˆå¯¹æµä¸­çš„æ¯ä¸€ä¸ªå•ç‹¬çš„äº‹ä»¶åšå¤„ç†ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸€ä¸ªè¾“å…¥æ•°æ®ä¼šäº§ç”Ÿä¸€ä¸ªè¾“å‡ºæ•°æ®ã€‚</strong>å•å€¼è½¬æ¢ï¼Œæ•°æ®çš„åˆ†å‰²ï¼Œæ•°æ®çš„è¿‡æ»¤ï¼Œéƒ½æ˜¯åŸºæœ¬è½¬æ¢æ“ä½œçš„å…¸å‹ä¾‹å­ã€‚æˆ‘ä»¬å°†è§£é‡Šè¿™äº›ç®—å­çš„è¯­ä¹‰å¹¶æä¾›ç¤ºä¾‹ä»£ç ã€‚</p><h4 id="MAP"><a href="#MAP" class="headerlink" title="MAP"></a><em>MAP</em></h4><p><code>map</code>ç®—å­é€šè¿‡è°ƒç”¨<code>DataStream.map()</code>æ¥æŒ‡å®šã€‚<code>map</code>ç®—å­çš„ä½¿ç”¨å°†ä¼šäº§ç”Ÿä¸€æ¡æ–°çš„æ•°æ®æµã€‚å®ƒä¼šå°†æ¯ä¸€ä¸ªè¾“å…¥çš„äº‹ä»¶ä¼ é€åˆ°ä¸€ä¸ªç”¨æˆ·è‡ªå®šä¹‰çš„mapperï¼Œè¿™ä¸ªmapperåªè¿”å›ä¸€ä¸ªè¾“å‡ºäº‹ä»¶ï¼Œè¿™ä¸ªè¾“å‡ºäº‹ä»¶å’Œè¾“å…¥äº‹ä»¶çš„ç±»å‹å¯èƒ½ä¸ä¸€æ ·ã€‚ä¸‹å›¾å±•ç¤ºäº†ä¸€ä¸ªmapç®—å­ï¼Œè¿™ä¸ªmapå°†æ¯ä¸€ä¸ªæ­£æ–¹å½¢è½¬åŒ–æˆäº†åœ†å½¢ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/spaf_0501.png" alt="img"></p><p><code>MapFunction</code>çš„ç±»å‹ä¸è¾“å…¥äº‹ä»¶å’Œè¾“å‡ºäº‹ä»¶çš„ç±»å‹ç›¸å…³ï¼Œå¯ä»¥é€šè¿‡å®ç°<code>MapFunction</code>æ¥å£æ¥å®šä¹‰ã€‚æ¥å£åŒ…å«<code>map()</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°†ä¸€ä¸ªè¾“å…¥äº‹ä»¶æ°å¥½è½¬æ¢ä¸ºä¸€ä¸ªè¾“å‡ºäº‹ä»¶ã€‚</p><p>ä¸‹é¢çš„ä»£ç å®ç°äº†å°†SensorReadingä¸­çš„idå­—æ®µæŠ½å–å‡ºæ¥çš„åŠŸèƒ½ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> readings: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = ...</span><br><span class="line"><span class="keyword">val</span> sensorIds: <span class="type">DataStream</span>[<span class="type">String</span>] = readings.map(<span class="keyword">new</span> <span class="type">IdExtractor</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IdExtractor</span> <span class="keyword">extends</span> <span class="title">MapFunction</span>[<span class="type">SensorReading</span>, <span class="type">String</span>] </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">map</span></span>(r: <span class="type">SensorReading</span>) : <span class="type">String</span> = r.id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶æˆ‘ä»¬æ›´æ¨èåŒ¿åå‡½æ•°çš„å†™æ³•ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> sensorIds: <span class="type">DataStream</span>[<span class="type">String</span>] = filteredReadings.map(r =&gt; r.id)</span><br></pre></td></tr></table></figure><h4 id="FILTER"><a href="#FILTER" class="headerlink" title="FILTER"></a><em>FILTER</em></h4><p><code>filter</code>è½¬æ¢ç®—å­é€šè¿‡åœ¨æ¯ä¸ªè¾“å…¥äº‹ä»¶ä¸Šå¯¹ä¸€ä¸ªå¸ƒå°”æ¡ä»¶è¿›è¡Œæ±‚å€¼æ¥è¿‡æ»¤æ‰ä¸€äº›å…ƒç´ ï¼Œç„¶åå°†å‰©ä¸‹çš„å…ƒç´ ç»§ç»­å‘é€ã€‚ä¸€ä¸ª<code>true</code>çš„æ±‚å€¼ç»“æœå°†ä¼šæŠŠè¾“å…¥äº‹ä»¶ä¿ç•™ä¸‹æ¥å¹¶å‘é€åˆ°è¾“å‡ºï¼Œè€Œå¦‚æœæ±‚å€¼ç»“æœä¸º<code>false</code>ï¼Œåˆ™è¾“å…¥äº‹ä»¶ä¼šè¢«æŠ›å¼ƒæ‰ã€‚æˆ‘ä»¬é€šè¿‡è°ƒç”¨<code>DataStream.filter()</code>æ¥æŒ‡å®šæµçš„<code>filter</code>ç®—å­ï¼Œ<code>filter</code>æ“ä½œå°†äº§ç”Ÿä¸€æ¡æ–°çš„æµï¼Œå…¶ç±»å‹å’Œè¾“å…¥æµä¸­çš„äº‹ä»¶ç±»å‹æ˜¯ä¸€æ ·çš„ã€‚ä¸‹å›¾å±•ç¤ºäº†åªäº§ç”Ÿç™½è‰²æ–¹æ¡†çš„<code>filter</code>æ“ä½œã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/spaf_0502.png" alt="img"></p><p>å¸ƒå°”æ¡ä»¶å¯ä»¥ä½¿ç”¨å‡½æ•°ã€FilterFunctionæ¥å£æˆ–è€…åŒ¿åå‡½æ•°æ¥å®ç°ã€‚FilterFunctionä¸­çš„æ³›å‹æ˜¯è¾“å…¥äº‹ä»¶çš„ç±»å‹ã€‚å®šä¹‰çš„<code>filter()</code>æ–¹æ³•ä¼šä½œç”¨åœ¨æ¯ä¸€ä¸ªè¾“å…¥å…ƒç´ ä¸Šé¢ï¼Œå¹¶è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚</p><p>ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨filteræ¥ä»ä¼ æ„Ÿå™¨æ•°æ®ä¸­è¿‡æ»¤æ‰æ¸©åº¦å€¼å°äº25åæ°æ¸©åº¦çš„è¯»æ•°ã€‚</p><p><code>val filteredReadings = readings.filter(r =&gt; r.temperature &gt;= 25)</code></p><h4 id="FLATMAP"><a href="#FLATMAP" class="headerlink" title="FLATMAP"></a><em>FLATMAP</em></h4><p><code>flatMap</code>ç®—å­å’Œ<code>map</code>ç®—å­å¾ˆç±»ä¼¼ï¼Œä¸åŒä¹‹å¤„åœ¨äºé’ˆå¯¹æ¯ä¸€ä¸ªè¾“å…¥äº‹ä»¶<code>flatMap</code>å¯ä»¥ç”Ÿæˆ0ä¸ªã€1ä¸ªæˆ–è€…å¤šä¸ªè¾“å‡ºå…ƒç´ ã€‚äº‹å®ä¸Šï¼Œ<code>flatMap</code>è½¬æ¢ç®—å­æ˜¯<code>filter</code>å’Œ<code>map</code>çš„æ³›åŒ–ã€‚æ‰€ä»¥<code>flatMap</code>å¯ä»¥å®ç°<code>map</code>å’Œ<code>filter</code>ç®—å­çš„åŠŸèƒ½ã€‚ä¸‹å›¾å±•ç¤ºäº†<code>flatMap</code>å¦‚ä½•æ ¹æ®è¾“å…¥äº‹ä»¶çš„é¢œè‰²æ¥åšä¸åŒçš„å¤„ç†ã€‚å¦‚æœè¾“å…¥äº‹ä»¶æ˜¯ç™½è‰²æ–¹æ¡†ï¼Œåˆ™ç›´æ¥è¾“å‡ºã€‚è¾“å…¥å…ƒç´ æ˜¯é»‘æ¡†ï¼Œåˆ™å¤åˆ¶è¾“å…¥ã€‚ç°è‰²æ–¹æ¡†ä¼šè¢«è¿‡æ»¤æ‰ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/spaf_0503.png" alt="img"></p><p>flatMapç®—å­å°†ä¼šåº”ç”¨åœ¨æ¯ä¸€ä¸ªè¾“å…¥äº‹ä»¶ä¸Šé¢ã€‚å¯¹åº”çš„<code>FlatMapFunction</code>å®šä¹‰äº†<code>flatMap()</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›0ä¸ªã€1ä¸ªæˆ–è€…å¤šä¸ªäº‹ä»¶åˆ°ä¸€ä¸ª<code>Collector</code>é›†åˆä¸­ï¼Œä½œä¸ºè¾“å‡ºç»“æœã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; T: the type of input elements</span><br><span class="line">&#x2F;&#x2F; O: the type of output elements</span><br><span class="line">FlatMapFunction[T, O]</span><br><span class="line">    &gt; flatMap(T, Collector[O]): Unit</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†åœ¨æ•°æ®åˆ†ææ•™ç¨‹ä¸­ç»å¸¸ç”¨åˆ°çš„ä¾‹å­ï¼Œæˆ‘ä»¬ç”¨<code>flatMap</code>æ¥å®ç°ã€‚ä½¿ç”¨<code>_</code>æ¥åˆ‡å‰²ä¼ æ„Ÿå™¨IDï¼Œæ¯”å¦‚<code>sensor_1</code>ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IdSplitter</span> <span class="keyword">extends</span> <span class="title">FlatMapFunction</span>[<span class="type">String</span>, <span class="type">String</span>] </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">flatMap</span></span>(id: <span class="type">String</span>, out: <span class="type">Collector</span>[<span class="type">String</span>]) : <span class="type">Unit</span> = &#123;</span><br><span class="line">        <span class="keyword">val</span> arr = id.split(<span class="string">&quot;_&quot;</span>)</span><br><span class="line">        arr.foreach(out.collect)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒ¿åå‡½æ•°å†™æ³•</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> splitIds = sensorIds</span><br><span class="line">  .flatMap(r =&gt; r.split(<span class="string">&quot;_&quot;</span>))</span><br></pre></td></tr></table></figure><h3 id="é”®æ§æµè½¬æ¢ç®—å­"><a href="#é”®æ§æµè½¬æ¢ç®—å­" class="headerlink" title="é”®æ§æµè½¬æ¢ç®—å­"></a><a href="#%E9%94%AE%E6%8E%A7%E6%B5%81%E8%BD%AC%E6%8D%A2%E7%AE%97%E5%AD%90">é”®æ§æµè½¬æ¢ç®—å­</a></h3><p>å¾ˆå¤šæµå¤„ç†ç¨‹åºçš„ä¸€ä¸ªåŸºæœ¬è¦æ±‚å°±æ˜¯è¦èƒ½<font color="red">å¯¹æ•°æ®è¿›è¡Œåˆ†ç»„ï¼Œåˆ†ç»„åçš„æ•°æ®å…±äº«æŸä¸€ä¸ªç›¸åŒçš„å±æ€§</font>ã€‚DataStream APIæä¾›äº†ä¸€ä¸ªå«åš<code>KeyedStream</code>çš„æŠ½è±¡ï¼Œæ­¤æŠ½è±¡ä¼šä»<strong>é€»è¾‘ä¸Šå¯¹DataStreamè¿›è¡Œåˆ†åŒº</strong>ï¼Œåˆ†åŒºåçš„æ•°æ®æ‹¥æœ‰åŒæ ·çš„<code>Key</code>å€¼ï¼Œåˆ†åŒºåçš„æµäº’ä¸ç›¸å…³ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-19_10-47-17.png"></p><p>è€ŒSparkçš„åˆ†ç»„å‡½æ•°ä¸æ˜¯è¿™æ ·ï¼Œå› ä¸ºå®ƒæ˜¯æ‰¹å¤„ç†ã€‚æ‰€ä»¥ä»–ä¸æ˜¯ä¸€ä¸ªäº‹ä»¶æ‰§è¡Œä¸€ä¸ªåˆ†ç»„ï¼Œè€Œæ˜¯ä¸€æ‰¹æ•°æ®æ‰§è¡Œä¸€æ¬¡åˆ†ç»„ã€‚æ‰€ä»¥å®ƒçš„åˆ†ç»„ä¹‹åæ˜¯K,[V]çš„äº‹ä»¶ï¼Œå³å®ƒçš„åˆ†ç»„å‡½æ•°æ˜¯ç‰©ç†åˆ†ç»„ã€‚</p><hr><p>é’ˆå¯¹KeyedStreamçš„çŠ¶æ€è½¬æ¢æ“ä½œå¯ä»¥è¯»å–æ•°æ®æˆ–è€…å†™å…¥æ•°æ®åˆ°å½“å‰äº‹ä»¶Keyæ‰€å¯¹åº”çš„çŠ¶æ€ä¸­ã€‚<strong>è¿™è¡¨æ˜æ‹¥æœ‰åŒæ ·Keyçš„æ‰€æœ‰äº‹ä»¶éƒ½å¯ä»¥è®¿é—®åŒæ ·çš„çŠ¶æ€</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€ä»¥è¿™äº›äº‹ä»¶å¯ä»¥ä¸€èµ·å¤„ç†ã€‚</p><blockquote><p>ä¹Ÿå°±æ˜¯è¯´åˆ†ç»„åçš„æ¯ä¸ªkeyæ‰€åœ¨çš„åˆ†åŒºéƒ½ä¼šç»´æŠ¤ä¸€ä¸ªçŠ¶æ€ï¼Œä¸ºäº†ä¹‹åçš„æ»šåŠ¨è®¡ç®—åˆ†åŒºå†…çš„å€¼ï¼Œæ¯å½“åˆ†åŒºä¸­çš„ä¸€ä¸ªäº‹ä»¶åˆ°æ¥æ—¶ï¼Œéƒ½ä¼šä¸ä¹‹å‰ä¿å­˜å¥½çš„çŠ¶æ€ç›¸è®¡ç®—ï¼Œå¾—åˆ°æœ€æ–°çš„çŠ¶æ€ã€‚è€Œæ¯ä¸ªkeyçš„çŠ¶æ€éƒ½æ˜¯éš”ç¦»çš„ã€‚</p></blockquote><blockquote><p>è¦å°å¿ƒä½¿ç”¨çŠ¶æ€è½¬æ¢æ“ä½œå’ŒåŸºäºKeyçš„èšåˆæ“ä½œã€‚å¦‚æœKeyçš„å€¼è¶Šæ¥è¶Šå¤šï¼Œä¾‹å¦‚ï¼šKeyæ˜¯è®¢å•IDï¼Œæˆ‘ä»¬å¿…é¡»åŠæ—¶æ¸…ç©ºKeyæ‰€å¯¹åº”çš„çŠ¶æ€ï¼Œä»¥å…å¼•èµ·å†…å­˜æ–¹é¢çš„é—®é¢˜ã€‚ç¨åæˆ‘ä»¬ä¼šè¯¦ç»†è®²è§£ã€‚</p></blockquote><p>KeyedStreamå¯ä»¥ä½¿ç”¨mapï¼ŒflatMapå’Œfilterç®—å­æ¥å¤„ç†ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šä½¿ç”¨keyByç®—å­æ¥å°†DataStreamè½¬æ¢æˆKeyedStreamï¼Œå¹¶è®²è§£åŸºäºkeyçš„è½¬æ¢æ“ä½œï¼š<strong>æ»šåŠ¨èšåˆå’Œreduceç®—å­ã€‚</strong></p><h4 id="KEYBY"><a href="#KEYBY" class="headerlink" title="KEYBY"></a><em>KEYBY</em></h4><p>keyByé€šè¿‡æŒ‡å®škeyæ¥å°†DataStreamè½¬æ¢æˆKeyedStreamã€‚åŸºäºä¸åŒçš„keyï¼Œæµä¸­çš„äº‹ä»¶å°†è¢«åˆ†é…åˆ°ä¸åŒçš„åˆ†åŒºä¸­å»ã€‚æ‰€æœ‰å…·æœ‰ç›¸åŒkeyçš„äº‹ä»¶å°†ä¼šåœ¨æ¥ä¸‹æ¥çš„æ“ä½œç¬¦çš„åŒä¸€ä¸ªå­ä»»åŠ¡æ§½ä¸­è¿›è¡Œå¤„ç†ã€‚æ‹¥æœ‰ä¸åŒkeyçš„äº‹ä»¶å¯ä»¥åœ¨åŒä¸€ä¸ªä»»åŠ¡ä¸­å¤„ç†ã€‚ä½†æ˜¯ç®—å­åªèƒ½è®¿é—®å½“å‰äº‹ä»¶çš„keyæ‰€å¯¹åº”çš„çŠ¶æ€ã€‚</p><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒæŠŠè¾“å…¥äº‹ä»¶çš„é¢œè‰²ä½œä¸ºkeyï¼Œé»‘è‰²çš„äº‹ä»¶è¾“å‡ºåˆ°äº†ä¸€ä¸ªåˆ†åŒºï¼Œå…¶ä»–é¢œè‰²è¾“å‡ºåˆ°äº†å¦ä¸€ä¸ªåˆ†åŒºã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/spaf_0504.png"></p><p><code>keyBy()</code>æ–¹æ³•æ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°æŒ‡å®šäº†keyæˆ–è€…keysï¼Œæœ‰å¾ˆå¤šä¸åŒçš„æ–¹æ³•æ¥æŒ‡å®škeyã€‚æˆ‘ä»¬å°†åœ¨åé¢è®²è§£ã€‚ä¸‹é¢çš„ä»£ç å£°æ˜äº†<code>id</code>è¿™ä¸ªå­—æ®µä¸ºSensorReadingæµçš„keyã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> keyed: <span class="type">KeyedStream</span>[<span class="type">SensorReading</span>, <span class="type">String</span>] = readings.keyBy(r =&gt; r.id)</span><br></pre></td></tr></table></figure><p>åŒ¿åå‡½æ•°<code>r =&gt; r.id</code>æŠ½å–äº†ä¼ æ„Ÿå™¨è¯»æ•°SensorReadingçš„idå€¼ã€‚</p><h4 id="æ»šåŠ¨èšåˆğŸ”º"><a href="#æ»šåŠ¨èšåˆğŸ”º" class="headerlink" title="æ»šåŠ¨èšåˆğŸ”º"></a><em>æ»šåŠ¨èšåˆ</em>ğŸ”º</h4><p><font color="red"><strong>æ»šåŠ¨èšåˆç®—å­ç”±<code>KeyedStream</code>è°ƒç”¨ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªèšåˆä»¥åçš„DataStream</strong></font>ï¼Œä¾‹å¦‚ï¼šsumï¼Œminimumï¼Œmaximumã€‚<strong>ä¸€ä¸ªæ»šåŠ¨èšåˆç®—å­ä¼šä¸ºæ¯ä¸€ä¸ªè§‚å¯Ÿåˆ°çš„keyä¿å­˜ä¸€ä¸ªèšåˆçš„å€¼</strong>ã€‚<strong>é’ˆå¯¹æ¯ä¸€ä¸ªè¾“å…¥äº‹ä»¶ï¼Œç®—å­å°†ä¼šæ›´æ–°ä¿å­˜çš„èšåˆç»“æœ</strong>ï¼Œå¹¶å‘é€ä¸€ä¸ªå¸¦æœ‰æ›´æ–°åçš„å€¼çš„äº‹ä»¶åˆ°ä¸‹æ¸¸ç®—å­ã€‚<strong>æ»šåŠ¨èšåˆä¸éœ€è¦ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°ï¼Œä½†éœ€è¦æ¥å—ä¸€ä¸ªå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°æŒ‡å®šäº†åœ¨å“ªä¸€ä¸ªå­—æ®µä¸Šé¢åšèšåˆæ“ä½œ</strong>ã€‚DataStream APIæä¾›äº†ä»¥ä¸‹æ»šåŠ¨èšåˆæ–¹æ³•ã€‚</p><ul><li>sum()ï¼šåœ¨è¾“å…¥æµä¸Šå¯¹æŒ‡å®šçš„å­—æ®µåšæ»šåŠ¨ç›¸åŠ æ“ä½œã€‚</li><li>min()ï¼šåœ¨è¾“å…¥æµä¸Šå¯¹æŒ‡å®šçš„å­—æ®µæ±‚æœ€å°å€¼ã€‚</li><li>max()ï¼šåœ¨è¾“å…¥æµä¸Šå¯¹æŒ‡å®šçš„å­—æ®µæ±‚æœ€å¤§å€¼ã€‚</li><li>minBy()ï¼šåœ¨è¾“å…¥æµä¸Šé’ˆå¯¹æŒ‡å®šå­—æ®µæ±‚æœ€å°å€¼ï¼Œå¹¶è¿”å›åŒ…å«å½“å‰è§‚å¯Ÿåˆ°çš„æœ€å°å€¼çš„äº‹ä»¶ã€‚</li><li>maxBy()ï¼šåœ¨è¾“å…¥æµä¸Šé’ˆå¯¹æŒ‡å®šå­—æ®µæ±‚æœ€å¤§å€¼ï¼Œå¹¶è¿”å›åŒ…å«å½“å‰è§‚å¯Ÿåˆ°çš„æœ€å¤§å€¼çš„äº‹ä»¶ã€‚</li></ul><p>æ»šåŠ¨èšåˆç®—å­æ— æ³•ç»„åˆèµ·æ¥ä½¿ç”¨ï¼Œæ¯æ¬¡è®¡ç®—åªèƒ½ä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„æ»šåŠ¨èšåˆç®—å­ã€‚</p><blockquote><p>å› ä¸ºæ»šåŠ¨èšåˆç®—å­åªèƒ½å¯¹<code>KeyedStream</code>è°ƒç”¨ï¼Œä¸”è°ƒç”¨åä¼šå˜ä¸º<code>DataStream</code></p></blockquote><p>ä¸‹é¢çš„ä¾‹å­æ ¹æ®ç¬¬ä¸€ä¸ªå­—æ®µæ¥å¯¹ç±»å‹ä¸º<code>Tuple3</code>çš„æµåšåˆ†æµæ“ä½œï¼Œç„¶åé’ˆå¯¹ç¬¬äºŒä¸ªå­—æ®µåšæ»šåŠ¨æ±‚å’Œæ“ä½œã€‚</p><p><strong>scala version</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> inputStream = env.fromElements((<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>), (<span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>), (<span class="number">2</span>, <span class="number">2</span>, <span class="number">4</span>), (<span class="number">1</span>, <span class="number">5</span>, <span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> resultStream = inputStream.keyBy(<span class="number">0</span>).sum(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­é‡Œé¢ï¼Œè¾“å…¥æµæ ¹æ®ç¬¬ä¸€ä¸ªå­—æ®µæ¥åˆ†æµï¼Œç„¶ååœ¨ç¬¬äºŒä¸ªå­—æ®µä¸Šåšè®¡ç®—ã€‚å¯¹äºkey 1ï¼Œè¾“å‡ºç»“æœæ˜¯(1,2,2),(1,7,2)ã€‚å¯¹äºkey 2ï¼Œè¾“å‡ºç»“æœæ˜¯(2,3,1),(2,5,1)ã€‚ç¬¬ä¸€ä¸ªå­—æ®µæ˜¯keyï¼Œç¬¬äºŒä¸ªå­—æ®µæ˜¯æ±‚å’Œçš„æ•°å€¼ï¼Œç¬¬ä¸‰ä¸ªå­—æ®µæœªå®šä¹‰ã€‚</p><blockquote><p>æ»šåŠ¨èšåˆæ“ä½œä¼šå¯¹æ¯ä¸€ä¸ªkeyéƒ½ä¿å­˜ä¸€ä¸ªçŠ¶æ€ã€‚å› ä¸ºçŠ¶æ€ä»æ¥ä¸ä¼šè¢«æ¸…ç©ºï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä½¿ç”¨æ»šåŠ¨èšåˆç®—å­æ—¶åªèƒ½ä½¿ç”¨åœ¨<font color="red">å«æœ‰æœ‰é™ä¸ªkeyçš„æµä¸Šé¢ã€‚</font></p></blockquote><h4 id="REDUCEğŸ”º"><a href="#REDUCEğŸ”º" class="headerlink" title="REDUCEğŸ”º"></a><em>REDUCE</em>ğŸ”º</h4><p>reduceç®—å­æ˜¯æ»šåŠ¨èšåˆçš„æ³›åŒ–å®ç°ã€‚<strong>å®ƒå°†ä¸€ä¸ªReduceFunctionåº”ç”¨åˆ°äº†ä¸€ä¸ªKeyedStreamä¸Šé¢å»ã€‚</strong>reduceç®—å­å°†ä¼šæŠŠæ¯ä¸€ä¸ªè¾“å…¥äº‹ä»¶å’Œå½“å‰å·²ç»reduceå‡ºæ¥çš„å€¼åšèšåˆè®¡ç®—ã€‚<strong>reduceæ“ä½œä¸ä¼šæ”¹å˜æµçš„äº‹ä»¶ç±»å‹ã€‚è¾“å‡ºæµæ•°æ®ç±»å‹å’Œè¾“å…¥æµæ•°æ®ç±»å‹æ˜¯ä¸€æ ·çš„ã€‚</strong></p><blockquote><p>å®é™…ä¸Šreduceæ–¹æ³•å°±æ˜¯è‡ªå®šä¹‰çš„æ»šåŠ¨èšåˆæ–¹æ³•ï¼Œä¸ä¹‹ä¸åŒçš„æ˜¯å®ƒä¸ä¼šæ”¹å˜æµç±»å‹ï¼Œä½¿ç”¨ä¼šä¸ä¼šå°†KeyedStream[T]-&gt;DataStream[T1]</p></blockquote><p>reduceå‡½æ•°å¯ä»¥é€šè¿‡å®ç°æ¥å£ReduceFunctionæ¥åˆ›å»ºä¸€ä¸ªç±»ã€‚ReduceFunctionæ¥å£å®šä¹‰äº†<code>reduce()</code>æ–¹æ³•ï¼Œæ­¤æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªè¾“å…¥äº‹ä»¶ï¼Œè¾“å…¥ä¸€ä¸ªç›¸åŒç±»å‹çš„äº‹ä»¶ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; T: the element type</span><br><span class="line">ReduceFunction[T]</span><br><span class="line">    &gt; reduce(T, T): T</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çš„ä¾‹å­ï¼Œæµæ ¹æ®ä¼ æ„Ÿå™¨IDåˆ†æµï¼Œç„¶åè®¡ç®—æ¯ä¸ªä¼ æ„Ÿå™¨çš„å½“å‰æœ€å¤§æ¸©åº¦å€¼ã€‚</p><p><strong>scala version</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">MyReduce</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> value: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = env.addSource(<span class="keyword">new</span> <span class="type">SensorSource</span>)</span><br><span class="line">    <span class="keyword">val</span> value1: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = value.keyBy(_.id).reduce(<span class="keyword">new</span> myReduce)</span><br><span class="line">    value1.print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">myReduce</span> <span class="keyword">extends</span> <span class="title">ReduceFunction</span>[<span class="type">SensorReading</span>]</span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">reduce</span></span>(t: <span class="type">SensorReading</span>, t1: <span class="type">SensorReading</span>): <span class="type">SensorReading</span> = &#123;</span><br><span class="line">     <span class="keyword">if</span> (t.temperature&gt;t1.temperature) &#123;</span><br><span class="line">       t</span><br><span class="line">     &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">       t1</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>reduceä½œä¸ºæ»šåŠ¨èšåˆçš„æ³›åŒ–å®ç°ï¼ŒåŒæ ·ä¹Ÿè¦é’ˆå¯¹æ¯ä¸€ä¸ªkeyä¿å­˜çŠ¶æ€ã€‚å› ä¸ºçŠ¶æ€ä»æ¥ä¸ä¼šæ¸…ç©ºï¼Œ<font color="red">æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†reduceç®—å­åº”ç”¨åœ¨ä¸€ä¸ªæœ‰é™keyçš„æµä¸Šã€‚</font></p></blockquote><h3 id="å¤šæµè½¬æ¢ç®—å­"><a href="#å¤šæµè½¬æ¢ç®—å­" class="headerlink" title="å¤šæµè½¬æ¢ç®—å­"></a><a href="#%E5%A4%9A%E6%B5%81%E8%BD%AC%E6%8D%A2%E7%AE%97%E5%AD%90">å¤šæµè½¬æ¢ç®—å­</a></h3><p>è®¸å¤šåº”ç”¨éœ€è¦æ‘„å…¥å¤šä¸ªæµå¹¶å°†æµåˆå¹¶å¤„ç†ï¼Œè¿˜å¯èƒ½éœ€è¦å°†ä¸€æ¡æµåˆ†å‰²æˆå¤šæ¡æµç„¶åé’ˆå¯¹æ¯ä¸€æ¡æµåº”ç”¨ä¸åŒçš„ä¸šåŠ¡é€»è¾‘ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è®¨è®ºDataStream APIä¸­æä¾›çš„èƒ½å¤Ÿå¤„ç†å¤šæ¡è¾“å…¥æµæˆ–è€…å‘é€å¤šæ¡è¾“å‡ºæµçš„æ“ä½œç®—å­ã€‚</p><h4 id="UNION"><a href="#UNION" class="headerlink" title="UNION"></a><em>UNION</em></h4><p>DataStream.union()æ–¹æ³•å°†ä¸¤æ¡æˆ–è€…å¤šæ¡DataStreamåˆå¹¶æˆä¸€æ¡å…·æœ‰<strong>ä¸è¾“å…¥æµç›¸åŒç±»å‹çš„è¾“å‡ºDataStream</strong>ã€‚æ¥ä¸‹æ¥çš„è½¬æ¢ç®—å­å°†ä¼šå¤„ç†è¾“å…¥æµä¸­çš„æ‰€æœ‰å…ƒç´ ã€‚ä¸‹å›¾å±•ç¤ºäº†unionæ“ä½œç¬¦å¦‚ä½•å°†é»‘è‰²å’Œç™½è‰²çš„äº‹ä»¶æµåˆå¹¶æˆä¸€ä¸ªå•ä¸€è¾“å‡ºæµã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/spaf_0505.png" alt="img"></p><p>äº‹ä»¶åˆæµçš„æ–¹å¼ä¸ºFIFOæ–¹å¼ã€‚æ“ä½œç¬¦å¹¶ä¸ä¼šäº§ç”Ÿä¸€ä¸ªç‰¹å®šé¡ºåºçš„äº‹ä»¶æµã€‚<strong>unionæ“ä½œç¬¦ä¹Ÿä¸ä¼šè¿›è¡Œå»é‡ã€‚æ¯ä¸€ä¸ªè¾“å…¥äº‹ä»¶éƒ½è¢«å‘é€åˆ°äº†ä¸‹ä¸€ä¸ªæ“ä½œç¬¦ã€‚</strong></p><p>ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•å°†ä¸‰æ¡ç±»å‹ä¸ºSensorReadingçš„æ•°æ®æµåˆå¹¶æˆä¸€æ¡æµã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> parisStream: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = ...</span><br><span class="line"><span class="keyword">val</span> tokyoStream: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = ...</span><br><span class="line"><span class="keyword">val</span> rioStream: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = ...</span><br><span class="line"><span class="keyword">val</span> allCities: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = parisStream</span><br><span class="line">  .union(tokyoStream, rioStream)</span><br></pre></td></tr></table></figure><h4 id="CONNECT-COMAPå’ŒCOFLATMAPğŸ”º"><a href="#CONNECT-COMAPå’ŒCOFLATMAPğŸ”º" class="headerlink" title="CONNECT, COMAPå’ŒCOFLATMAPğŸ”º"></a><em>CONNECT, COMAPå’ŒCOFLATMAP</em>ğŸ”º</h4><p>è”åˆä¸¤æ¡æµçš„äº‹ä»¶æ˜¯éå¸¸å¸¸è§çš„æµå¤„ç†éœ€æ±‚ã€‚ä¾‹å¦‚ç›‘æ§ä¸€ç‰‡æ£®æ—ç„¶åå‘å‡ºé«˜å±çš„ç«è­¦è­¦æŠ¥ã€‚æŠ¥è­¦çš„Applicationæ¥æ”¶ä¸¤æ¡æµï¼Œä¸€æ¡æ˜¯æ¸©åº¦ä¼ æ„Ÿå™¨ä¼ å›æ¥çš„æ•°æ®ï¼Œä¸€æ¡æ˜¯çƒŸé›¾ä¼ æ„Ÿå™¨ä¼ å›æ¥çš„æ•°æ®ã€‚å½“ä¸¤æ¡æµéƒ½è¶…è¿‡å„è‡ªçš„é˜ˆå€¼æ—¶ï¼ŒæŠ¥è­¦ã€‚</p><p>DataStream APIæä¾›äº†<code>connect</code>æ“ä½œæ¥æ”¯æŒä»¥ä¸Šçš„åº”ç”¨åœºæ™¯ã€‚<code>DataStream.connect()</code>æ–¹æ³•æ¥æ”¶ä¸€æ¡<code>DataStream</code>ï¼Œç„¶åè¿”å›ä¸€ä¸ª<code>ConnectedStreams</code>ç±»å‹çš„å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡è¡¨ç¤ºäº†ä¸¤æ¡è¿æ¥çš„æµã€‚</p><p>ConnectedStreamsæä¾›äº†<code>map()</code>å’Œ<code>flatMap()</code>æ–¹æ³•ï¼Œåˆ†åˆ«éœ€è¦æ¥æ”¶ç±»å‹ä¸º<code>CoMapFunction</code>å’Œ<code>CoFlatMapFunction</code>çš„å‚æ•°ã€‚</p><p>ä»¥ä¸Šä¸¤ä¸ªå‡½æ•°é‡Œé¢çš„æ³›å‹æ˜¯ç¬¬ä¸€æ¡æµçš„äº‹ä»¶ç±»å‹å’Œç¬¬äºŒæ¡æµçš„äº‹ä»¶ç±»å‹ï¼Œä»¥åŠè¾“å‡ºæµçš„äº‹ä»¶ç±»å‹ã€‚è¿˜å®šä¹‰äº†ä¸¤ä¸ªæ–¹æ³•ï¼Œæ¯ä¸€ä¸ªæ–¹æ³•é’ˆå¯¹ä¸€æ¡æµæ¥è°ƒç”¨ã€‚<code>map1()</code>å’Œ<code>flatMap1()</code>ä¼šè°ƒç”¨åœ¨ç¬¬ä¸€æ¡æµçš„å…ƒç´ ä¸Šé¢ï¼Œ<code>map2()</code>å’Œ<code>flatMap2()</code>ä¼šè°ƒç”¨åœ¨ç¬¬äºŒæ¡æµçš„å…ƒç´ ä¸Šé¢ã€‚flatmapçš„flatmapå‡½æ•°å¯ä»¥å‘é€å¤šä¸ªå€¼ï¼Œè€Œmapåªèƒ½ä¸€ä¸ªã€‚</p><p>å¯¹ä¸¤æ¡æµåšè¿æ¥æŸ¥è¯¢é€šå¸¸éœ€è¦è¿™ä¸¤æ¡æµåŸºäºæŸäº›æ¡ä»¶è¢«ç¡®å®šæ€§çš„è·¯ç”±åˆ°æ“ä½œç¬¦ä¸­ç›¸åŒçš„å¹¶è¡Œå®ä¾‹é‡Œé¢å»ã€‚<strong>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œconnect()æ“ä½œå°†ä¸ä¼šå¯¹ä¸¤æ¡æµçš„äº‹ä»¶å»ºç«‹ä»»ä½•å…³ç³»ï¼Œæ‰€ä»¥ä¸¤æ¡æµçš„äº‹ä»¶å°†ä¼šéšæœºçš„è¢«å‘é€åˆ°ä¸‹æ¸¸çš„ç®—å­å®ä¾‹é‡Œé¢å»ã€‚</strong>è¿™æ ·çš„è¡Œä¸ºä¼šäº§ç”Ÿä¸ç¡®å®šæ€§çš„è®¡ç®—ç»“æœï¼Œæ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚<font color="red">ä¸ºäº†é’ˆå¯¹ConnectedStreamsè¿›è¡Œç¡®å®šæ€§çš„è½¬æ¢æ“ä½œï¼Œconnect()æ–¹æ³•å¯ä»¥å’ŒkeyBy()æˆ–è€…broadcast()ç»„åˆèµ·æ¥ä½¿ç”¨ã€‚æˆ‘ä»¬é¦–å…ˆçœ‹ä¸€ä¸‹keyBy()çš„ç¤ºä¾‹ã€‚</font></p><ul><li>ä½¿ç”¨keyByæŒ‡å®škeyæ¥å¯¹ä¸¤æ¡æµå»ºç«‹å…³ç³»</li></ul><p><strong>keyby</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> one = ...</span><br><span class="line"><span class="keyword">val</span> two = ...</span><br><span class="line"><span class="comment">// å†™æ³•1</span></span><br><span class="line"><span class="keyword">val</span> keyedConnect1 = one.connect(two).keyBy(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"><span class="comment">// å†™æ³•2</span></span><br><span class="line"><span class="keyword">val</span> keyedConnect2 = one.keyBy(<span class="number">0</span>).connect(two.keyBy(<span class="number">0</span>))</span><br></pre></td></tr></table></figure><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> one: <span class="type">DataStream</span>[(<span class="type">Int</span>, <span class="type">String</span>)] = env.fromElements((<span class="number">1</span>, <span class="string">&quot;a&quot;</span>), (<span class="number">2</span>,<span class="string">&quot;b&quot;</span>))</span><br><span class="line">    <span class="keyword">val</span> two: <span class="type">DataStream</span>[(<span class="type">Int</span>, <span class="type">String</span>)] = env.fromElements((<span class="number">1</span>, <span class="string">&quot;m&quot;</span>), (<span class="number">2</span>,<span class="string">&quot;n&quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> keyedConnect2: <span class="type">ConnectedStreams</span>[(<span class="type">Int</span>, <span class="type">String</span>), (<span class="type">Int</span>, <span class="type">String</span>)] = one.keyBy(<span class="number">0</span>).connect(two.keyBy(<span class="number">0</span>))</span><br><span class="line">    keyedConnect2.map(<span class="keyword">new</span> <span class="type">MyCoMap</span>).print()</span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MyCoMap</span> <span class="keyword">extends</span> <span class="title">CoMapFunction</span>[(<span class="type">Int</span>, <span class="type">String</span>),(<span class="type">Int</span>, <span class="type">String</span>),<span class="type">String</span>]</span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">map1</span></span>(in1: (<span class="type">Int</span>, <span class="type">String</span>)): <span class="type">String</span> = &#123;</span><br><span class="line">      in1._1+in1._2</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">map2</span></span>(in1: (<span class="type">Int</span>, <span class="type">String</span>)): <span class="type">String</span> = &#123;</span><br><span class="line">      in1._1+in1._2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾“å‡ºï¼š1a 1m 2b 2n</span></span><br></pre></td></tr></table></figure><h4 id="SideOutput"><a href="#SideOutput" class="headerlink" title="SideOutput"></a><em>SideOutput</em></h4><p>å¤§éƒ¨åˆ†çš„DataStream APIçš„ç®—å­çš„è¾“å‡ºæ˜¯å•ä¸€è¾“å‡ºï¼Œä¹Ÿå°±æ˜¯æŸç§æ•°æ®ç±»å‹çš„æµã€‚é™¤äº†splitç®—å­ï¼Œå¯ä»¥å°†ä¸€æ¡æµåˆ†æˆå¤šæ¡æµï¼Œè¿™äº›æµçš„æ•°æ®ç±»å‹ä¹Ÿéƒ½ç›¸åŒã€‚process functionçš„side outputsåŠŸèƒ½å¯ä»¥äº§ç”Ÿå¤šæ¡æµï¼Œå¹¶ä¸”è¿™äº›æµçš„æ•°æ®ç±»å‹å¯ä»¥ä¸ä¸€æ ·ã€‚ä¸€ä¸ªside outputå¯ä»¥å®šä¹‰ä¸ºOutputTag[X]å¯¹è±¡ï¼Œ<strong>Xæ˜¯è¾“å‡ºæµçš„æ•°æ®ç±»å‹</strong>ã€‚process functionå¯ä»¥é€šè¿‡Contextå¯¹è±¡å‘å°„ä¸€ä¸ªäº‹ä»¶åˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªside outputsã€‚</p><blockquote><p><code>process function</code>ä¸<code>KeyedProcessFunction</code>åŒºåˆ«ï¼š</p><p><code>KeyedProcessFunction</code>æ˜¯å¯¹äºkeybyåçš„æµè®¡ç®—ï¼Œè€Œ<code>process function</code>æ˜¯å¯¹keybyå‰çš„æµè®¡ç®—ï¼Œéƒ½æ˜¯ä¸€ä¸ªå…ƒç´ è§¦å‘ä¸€æ¬¡è®¡ç®—</p></blockquote><p><strong>å°†æ•°æ®å‘é€åˆ°ä¸åŒçš„ä¾§è¾“å‡ºæµ</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">SideOutputStream</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> inputStream: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = env.addSource(<span class="keyword">new</span> <span class="type">SensorSource</span>)</span><br><span class="line">    inputStream.process(<span class="keyword">new</span> <span class="type">MySideOutputStream</span>).getSideOutput(<span class="keyword">new</span> <span class="type">OutputTag</span>[<span class="type">SensorReading</span>](<span class="string">&quot;tmp&quot;</span>))</span><br><span class="line">      .print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  ProcessFunction`å¤„ç†çš„æ˜¯æ²¡æœ‰ kelByçš„æµ</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MySideOutputStream</span> <span class="keyword">extends</span> <span class="title">ProcessFunction</span>[<span class="type">SensorReading</span>, <span class="type">SensorReading</span>]</span>&#123;</span><br><span class="line">    <span class="keyword">lazy</span> <span class="keyword">private</span> <span class="keyword">val</span> tag: <span class="type">OutputTag</span>[<span class="type">SensorReading</span>] = <span class="keyword">new</span> <span class="type">OutputTag</span>[<span class="type">SensorReading</span>](<span class="string">&quot;tmp&quot;</span>)</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">processElement</span></span>(i: <span class="type">SensorReading</span>, context: <span class="type">ProcessFunction</span>[<span class="type">SensorReading</span>, <span class="type">SensorReading</span>]#<span class="type">Context</span>, collector: <span class="type">Collector</span>[<span class="type">SensorReading</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="comment">// æ»¡è¶³æŒ‡å®šæ¡ä»¶åˆ™è¾“å…¥åˆ°ä¾§è¾“å‡ºæµï¼Œæ‰€æœ‰å…ƒç´ éƒ½éœ€è¦å‘é€åˆ°æ­£å¸¸æµ</span></span><br><span class="line">      <span class="keyword">if</span> (i.temperature&lt;<span class="number">10.0</span>) &#123;</span><br><span class="line">        context.output(tag, i)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      collector.collect(i)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210102142714440.png" alt="image-20210102142714440"></p><h3 id="åˆ†å¸ƒå¼è½¬æ¢ç®—å­"><a href="#åˆ†å¸ƒå¼è½¬æ¢ç®—å­" class="headerlink" title="åˆ†å¸ƒå¼è½¬æ¢ç®—å­"></a><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E8%BD%AC%E6%8D%A2%E7%AE%97%E5%AD%90">åˆ†å¸ƒå¼è½¬æ¢ç®—å­</a></h3><p>å½“æˆ‘ä»¬ä½¿ç”¨DataStream APIæ¥ç¼–å†™ç¨‹åºæ—¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨çš„é€‰æ‹©æ•°æ®åˆ†åŒºç­–ç•¥ï¼Œç„¶åæ ¹æ®æ“ä½œç¬¦çš„è¯­ä¹‰å’Œè®¾ç½®çš„å¹¶è¡Œåº¦å°†æ•°æ®è·¯ç”±åˆ°æ­£ç¡®çš„åœ°æ–¹å»ã€‚æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åœ¨åº”ç”¨ç¨‹åºçš„å±‚é¢æ§åˆ¶åˆ†åŒºç­–ç•¥ï¼Œæˆ–è€…è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬çŸ¥é“ä¼šå‘ç”Ÿæ•°æ®å€¾æ–œï¼Œé‚£ä¹ˆæˆ‘ä»¬æƒ³è¦é’ˆå¯¹æ•°æ®æµåšè´Ÿè½½å‡è¡¡ï¼Œå°†æ•°æ®æµå¹³å‡å‘é€åˆ°æ¥ä¸‹æ¥çš„æ“ä½œç¬¦ä¸­å»ã€‚åˆæˆ–è€…ï¼Œåº”ç”¨ç¨‹åºçš„ä¸šåŠ¡é€»è¾‘å¯èƒ½éœ€è¦ä¸€ä¸ªç®—å­æ‰€æœ‰çš„å¹¶è¡Œä»»åŠ¡éƒ½éœ€è¦æ¥æ”¶åŒæ ·çš„æ•°æ®ã€‚å†æˆ–è€…ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥çš„æ—¶å€™ã€‚åœ¨è¿™ä¸€å°èŠ‚ï¼Œæˆ‘ä»¬å°†å±•ç¤ºDataStreamçš„ä¸€äº›æ–¹æ³•ï¼Œå¯ä»¥ä½¿æˆ‘ä»¬æ¥æ§åˆ¶æˆ–è€…è‡ªå®šä¹‰æ•°æ®åˆ†åŒºç­–ç•¥ã€‚</p><blockquote><p>keyBy()æ–¹æ³•ä¸åŒäºåˆ†å¸ƒå¼è½¬æ¢ç®—å­ã€‚æ‰€æœ‰çš„åˆ†å¸ƒå¼è½¬æ¢ç®—å­å°†äº§ç”ŸDataStreamæ•°æ®ç±»å‹ã€‚è€ŒkeyBy()äº§ç”Ÿçš„ç±»å‹æ˜¯KeyedStreamï¼Œå®ƒæ‹¥æœ‰è‡ªå·±çš„keyed stateã€‚</p><p>åˆ†å¸ƒå¼è½¬æ¢ç®—å­å®é™…ä¸Šå°±æ˜¯shuffleå°†åŸæœ‰åˆ†åŒºçš„æ•°æ®å‘é€åˆ°ä¸‹ä¸€ä»»åŠ¡çš„ä¸åŒåˆ†åŒºã€‚å¦‚æœä¸‹ä¸€ä»»åŠ¡æœ‰å¤šä¸ªå¹¶è¡Œï¼Œåˆ™æœ‰ç”¨ï¼Œå¦‚æœå°±ä¸€ä¸ªå®ƒæ€ä¹ˆå‘è¿˜æ˜¯ç»™ä¸€ä¸ªå¹¶è¡Œåº¦1çš„ä»»åŠ¡æ‰§è¡Œ</p></blockquote><p>æ•°æ®äº¤æ¢ç­–ç•¥å¦‚ä¸‹ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/spaf_0203.png"></p><ul><li>å‰å‘ç­–ç•¥å°†æ•°æ®ä»ä¸€ä¸ªä»»åŠ¡å‘é€åˆ°æ¥æ”¶ä»»åŠ¡ã€‚å¦‚æœä¸¤ä¸ªä»»åŠ¡éƒ½ä½äºåŒä¸€å°ç‰©ç†è®¡ç®—æœºä¸Šï¼ˆè¿™é€šå¸¸ç”±ä»»åŠ¡è°ƒåº¦å™¨ç¡®ä¿ï¼‰ï¼Œè¿™ç§äº¤æ¢ç­–ç•¥å¯ä»¥é¿å…ç½‘ç»œé€šä¿¡ã€‚</li><li>å¹¿æ’­ç­–ç•¥å°†æ‰€æœ‰æ•°æ®å‘é€åˆ°ç®—å­çš„æ‰€æœ‰çš„å¹¶è¡Œä»»åŠ¡ä¸Šé¢å»ã€‚å› ä¸ºè¿™ç§ç­–ç•¥ä¼šå¤åˆ¶æ•°æ®å’Œæ¶‰åŠç½‘ç»œé€šä¿¡ï¼Œæ‰€ä»¥ä»£ä»·ç›¸å½“æ˜‚è´µã€‚</li><li>åŸºäºé”®æ§çš„ç­–ç•¥é€šè¿‡Keyå€¼(é”®)å¯¹æ•°æ®è¿›è¡Œåˆ†åŒºä¿è¯å…·æœ‰ç›¸åŒKeyçš„æ•°æ®å°†ç”±åŒä¸€ä»»åŠ¡å¤„ç†ã€‚åœ¨å›¾2-2ä¸­ï¼Œè¾“å‡ºâ€œExtract hashtagsâ€ç®—å­ä½¿ç”¨é”®æ¥åˆ†åŒºï¼ˆhashtagï¼‰ï¼Œä»¥ä¾¿countç®—å­çš„ä»»åŠ¡å¯ä»¥æ­£ç¡®è®¡ç®—æ¯ä¸ª#æ ‡ç­¾çš„å‡ºç°æ¬¡æ•°ã€‚</li><li>éšæœºç­–ç•¥ç»Ÿä¸€å°†æ•°æ®åˆ†é…åˆ°ç®—å­çš„ä»»åŠ¡ä¸­å»ï¼Œä»¥ä¾¿å‡åŒ€åœ°å°†è´Ÿè½½åˆ†é…åˆ°ä¸åŒçš„è®¡ç®—ä»»åŠ¡ã€‚</li></ul><h4 id="Random"><a href="#Random" class="headerlink" title="Random"></a><em>Random</em></h4><p>éšæœºæ•°æ®äº¤æ¢ç”±<code>DataStream.shuffle()</code>æ–¹æ³•å®ç°ã€‚shuffleæ–¹æ³•å°†æ•°æ®éšæœºçš„åˆ†é…åˆ°ä¸‹æ¸¸ç®—å­çš„å¹¶è¡Œä»»åŠ¡ä¸­å»ã€‚</p><h4 id="Round-Robin"><a href="#Round-Robin" class="headerlink" title="Round-Robin"></a><em>Round-Robin</em></h4><p><code>rebalance()</code>æ–¹æ³•ä½¿ç”¨Round-Robinè´Ÿè½½å‡è¡¡ç®—æ³•å°†è¾“å…¥æµå¹³å‡åˆ†é…åˆ°éšåçš„å¹¶è¡Œè¿è¡Œçš„ä»»åŠ¡ä¸­å»ã€‚å›¾5-7ä¸ºround-robinåˆ†å¸ƒå¼è½¬æ¢ç®—å­çš„ç¤ºæ„å›¾ã€‚</p><h4 id="Rescale"><a href="#Rescale" class="headerlink" title="Rescale"></a><em>Rescale</em></h4><p><code>rescale()</code>æ–¹æ³•ä½¿ç”¨çš„ä¹Ÿæ˜¯round-robinç®—æ³•ï¼Œä½†åªä¼šå°†æ•°æ®å‘é€åˆ°æ¥ä¸‹æ¥çš„å¹¶è¡Œè¿è¡Œçš„ä»»åŠ¡ä¸­çš„ä¸€éƒ¨åˆ†ä»»åŠ¡ä¸­ã€‚æœ¬è´¨ä¸Šï¼Œå½“å‘é€è€…ä»»åŠ¡æ•°é‡å’Œæ¥æ”¶è€…ä»»åŠ¡æ•°é‡ä¸ä¸€æ ·æ—¶ï¼Œrescaleåˆ†åŒºç­–ç•¥æä¾›äº†ä¸€ç§è½»é‡çº§çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ã€‚<font color="red">å¦‚æœæ¥æ”¶è€…ä»»åŠ¡çš„æ•°é‡æ˜¯å‘é€è€…ä»»åŠ¡çš„æ•°é‡çš„å€æ•°æ—¶ï¼Œrescaleæ“ä½œå°†ä¼šæ•ˆç‡æ›´é«˜ã€‚</font></p><p><code>rebalance()</code>å’Œ<code>rescale()</code>çš„æ ¹æœ¬åŒºåˆ«åœ¨äºä»»åŠ¡ä¹‹é—´è¿æ¥çš„æœºåˆ¶ä¸åŒã€‚ <code>rebalance()</code>å°†ä¼šé’ˆå¯¹æ‰€æœ‰å‘é€è€…ä»»åŠ¡å’Œæ‰€æœ‰æ¥æ”¶è€…ä»»åŠ¡ä¹‹é—´å»ºç«‹é€šä¿¡é€šé“ï¼Œè€Œ<code>rescale()</code>ä»…ä»…é’ˆå¯¹æ¯ä¸€ä¸ªä»»åŠ¡å’Œä¸‹æ¸¸ç®—å­çš„ä¸€éƒ¨åˆ†å­å¹¶è¡Œä»»åŠ¡ä¹‹é—´å»ºç«‹é€šä¿¡é€šé“ã€‚rescaleçš„ç¤ºæ„å›¾ä¸ºå›¾5-7ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/spaf_0507.png" alt="5-7"></p><h4 id="Broadcast"><a href="#Broadcast" class="headerlink" title="Broadcast"></a><em>Broadcast</em></h4><p><code>broadcast()</code>æ–¹æ³•å°†è¾“å…¥æµçš„æ‰€æœ‰æ•°æ®å¤åˆ¶å¹¶å‘é€åˆ°ä¸‹æ¸¸ç®—å­çš„æ‰€æœ‰å¹¶è¡Œä»»åŠ¡ä¸­å»ã€‚</p><h4 id="Global"><a href="#Global" class="headerlink" title="Global"></a><em>Global</em></h4><p><code>global()</code>æ–¹æ³•å°†æ‰€æœ‰çš„è¾“å…¥æµæ•°æ®éƒ½å‘é€åˆ°ä¸‹æ¸¸ç®—å­çš„ç¬¬ä¸€ä¸ªå¹¶è¡Œä»»åŠ¡ä¸­å»ã€‚è¿™ä¸ªæ“ä½œéœ€è¦å¾ˆè°¨æ…ï¼Œå› ä¸ºå°†æ‰€æœ‰æ•°æ®å‘é€åˆ°åŒä¸€ä¸ªtaskï¼Œå°†ä¼šå¯¹åº”ç”¨ç¨‹åºé€ æˆå¾ˆå¤§çš„å‹åŠ›ã€‚</p><h4 id="Custom"><a href="#Custom" class="headerlink" title="Custom"></a><em>Custom</em></h4><p>å½“Flinkæä¾›çš„åˆ†åŒºç­–ç•¥éƒ½ä¸é€‚ç”¨æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>partitionCustom()</code>æ–¹æ³•æ¥è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥ã€‚è¿™ä¸ªæ–¹æ³•æ¥æ”¶ä¸€ä¸ª<code>Partitioner</code>å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡éœ€è¦å®ç°åˆ†åŒºé€»è¾‘ä»¥åŠå®šä¹‰é’ˆå¯¹æµçš„å“ªä¸€ä¸ªå­—æ®µæˆ–è€…keyæ¥è¿›è¡Œåˆ†åŒºã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-19_14-38-09.png" alt="Snipaste_2020-12-19_14-38-09"></p><h2 id="è®¾ç½®å¹¶è¡Œåº¦"><a href="#è®¾ç½®å¹¶è¡Œåº¦" class="headerlink" title="è®¾ç½®å¹¶è¡Œåº¦"></a><a href="#%E8%AE%BE%E7%BD%AE%E5%B9%B6%E8%A1%8C%E5%BA%A6">è®¾ç½®å¹¶è¡Œåº¦</a></h2><p>Flinkåº”ç”¨ç¨‹åºåœ¨ä¸€ä¸ªåƒé›†ç¾¤è¿™æ ·çš„åˆ†å¸ƒå¼ç¯å¢ƒä¸­å¹¶è¡Œæ‰§è¡Œã€‚å½“ä¸€ä¸ªæ•°æ®æµç¨‹åºæäº¤åˆ°ä½œä¸šç®¡ç†å™¨æ‰§è¡Œæ—¶ï¼Œç³»ç»Ÿå°†ä¼šåˆ›å»ºä¸€ä¸ªæ•°æ®æµå›¾ï¼Œç„¶åå‡†å¤‡æ‰§è¡Œéœ€è¦çš„æ“ä½œç¬¦ã€‚æ¯ä¸€ä¸ªæ“ä½œç¬¦å°†ä¼šå¹¶è¡ŒåŒ–åˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªä»»åŠ¡ä¸­å»ã€‚æ¯ä¸ªç®—å­çš„å¹¶è¡Œä»»åŠ¡éƒ½ä¼šå¤„ç†è¿™ä¸ªç®—å­çš„è¾“å…¥æµä¸­çš„ä¸€ä»½å­é›†ã€‚ä¸€ä¸ªç®—å­å¹¶è¡Œä»»åŠ¡çš„ä¸ªæ•°å«åšç®—å­çš„å¹¶è¡Œåº¦ã€‚å®ƒå†³å®šäº†ç®—å­æ‰§è¡Œçš„å¹¶è¡ŒåŒ–ç¨‹åº¦ï¼Œä»¥åŠè¿™ä¸ªç®—å­èƒ½å¤„ç†å¤šå°‘æ•°æ®é‡ã€‚</p><p>ä¸€èˆ¬è®¾ç½®å¹¶è¡Œåº¦ï¼Œæˆ‘ä»¬ä¸è¦åœ¨ä»£ç é‡Œè®¾ç½®å…¨å±€å¹¶è¡Œåº¦ï¼Œè¿™æ ·ç¡¬ç¼–ç ä¸å¥½ï¼Œåº”å½“ä½¿ç”¨é›†ç¾¤é»˜è®¤å¹¶è¡Œåº¦ï¼Œè¿™æ ·å½“é›†ç¾¤æ‰©å……èŠ‚ç‚¹æ—¶ï¼Œå¯ä»¥æ”¹å˜å½“å‰è¿è¡Œjobçš„å¹¶è¡Œåº¦ï¼Œè¿™æ ·ä»£ç å°±ä¸ç”¨é‡æ”¹ä»£ç å®ç°å¹¶è¡Œåº¦çš„å¢åŠ ã€‚å¦‚æœå†™æ­»äº†ï¼Œé›†ç¾¤å†æ€ä¹ˆè®¾ç½®ï¼Œå¹¶è¡Œåº¦ä¹Ÿä¸ä¼šå˜åŒ–ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±åº”è¯¥å¯¹ç‰¹å®šçš„ç®—å­è¿›è¡Œå¹¶è¡Œåº¦çš„è®¡ç®—ã€‚</p><p>åœ¨ä¸‹é¢çš„ä¾‹å­é‡Œé¢ï¼Œæ•°æ®æºçš„æ“ä½œç¬¦å°†ä¼šæŒ‰ç…§ç¯å¢ƒé»˜è®¤çš„å¹¶è¡Œåº¦æ¥å¹¶è¡Œæ‰§è¡Œï¼Œmapæ“ä½œç¬¦çš„å¹¶è¡Œåº¦å°†ä¼šæ˜¯é»˜è®¤å¹¶è¡Œåº¦çš„2å€ï¼Œsinkæ“ä½œç¬¦çš„å¹¶è¡Œåº¦ä¸º2ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">StreamExecutionEnvironment</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment;</span><br><span class="line">int defaultP = env.getParallelism;</span><br><span class="line">env</span><br><span class="line">  .addSource(<span class="keyword">new</span> <span class="type">CustomSource</span>)</span><br><span class="line">  .map(<span class="keyword">new</span> <span class="type">MyMapper</span>)</span><br><span class="line">  .setParallelism(defaultP * <span class="number">2</span>)</span><br><span class="line">  .print()</span><br><span class="line">  .setParallelism(<span class="number">2</span>);</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬é€šè¿‡å®¢æˆ·ç«¯å°†åº”ç”¨ç¨‹åºçš„å¹¶è¡Œåº¦è®¾ç½®ä¸º16å¹¶æäº¤æ‰§è¡Œæ—¶ï¼Œsourceæ“ä½œç¬¦çš„å¹¶è¡Œåº¦ä¸º16ï¼Œmapperå¹¶è¡Œåº¦ä¸º32ï¼Œsinkå¹¶è¡Œåº¦ä¸º2ã€‚å¦‚æœæˆ‘ä»¬åœ¨æœ¬åœ°ç¯å¢ƒè¿è¡Œåº”ç”¨ç¨‹åºçš„è¯ï¼Œä¾‹å¦‚åœ¨IDEä¸­è¿è¡Œï¼Œæœºå™¨æ˜¯8æ ¸ï¼Œé‚£ä¹ˆsourceä»»åŠ¡å°†ä¼šå¹¶è¡Œæ‰§è¡Œåœ¨8ä¸ªä»»åŠ¡ä¸Šé¢ï¼Œmapperè¿è¡Œåœ¨16ä¸ªä»»åŠ¡ä¸Šé¢ï¼Œsinkè¿è¡Œåœ¨2ä¸ªä»»åŠ¡ä¸Šé¢ã€‚</p><h2 id="ç±»å‹"><a href="#ç±»å‹" class="headerlink" title="ç±»å‹"></a><a href="#%E7%B1%BB%E5%9E%8B">ç±»å‹</a></h2><p>Flinkç¨‹åºæ‰€å¤„ç†çš„æµä¸­çš„äº‹ä»¶ä¸€èˆ¬æ˜¯å¯¹è±¡ç±»å‹ã€‚æ“ä½œç¬¦æ¥æ”¶å¯¹è±¡è¾“å‡ºå¯¹è±¡ã€‚æ‰€ä»¥Flinkçš„å†…éƒ¨æœºåˆ¶éœ€è¦èƒ½å¤Ÿå¤„ç†äº‹ä»¶çš„ç±»å‹ã€‚åœ¨ç½‘ç»œä¸­ä¼ è¾“æ•°æ®ï¼Œæˆ–è€…å°†æ•°æ®å†™å…¥åˆ°çŠ¶æ€åç«¯ã€æ£€æŸ¥ç‚¹å’Œä¿å­˜ç‚¹ä¸­ï¼Œéƒ½éœ€è¦æˆ‘ä»¬å¯¹æ•°æ®è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚ä¸ºäº†é«˜æ•ˆçš„è¿›è¡Œæ­¤ç±»æ“ä½œï¼ŒFlinkéœ€è¦æµä¸­äº‹ä»¶ç±»å‹çš„è¯¦ç»†ä¿¡æ¯ã€‚Flinkä½¿ç”¨äº†<code>Type Information</code>çš„æ¦‚å¿µæ¥è¡¨è¾¾æ•°æ®ç±»å‹ï¼Œè¿™æ ·å°±èƒ½é’ˆå¯¹ä¸åŒçš„æ•°æ®ç±»å‹äº§ç”Ÿç‰¹å®šçš„åºåˆ—åŒ–å™¨ï¼Œååºåˆ—åŒ–å™¨å’Œæ¯”è¾ƒæ“ä½œç¬¦ã€‚</p><p>Flinkä¹Ÿèƒ½å¤Ÿé€šè¿‡åˆ†æè¾“å…¥æ•°æ®å’Œè¾“å‡ºæ•°æ®æ¥è‡ªåŠ¨è·å–æ•°æ®çš„ç±»å‹ä¿¡æ¯ä»¥åŠåºåˆ—åŒ–å™¨å’Œååºåˆ—åŒ–å™¨ã€‚å°½ç®¡å¦‚æ­¤ï¼Œåœ¨ä¸€äº›ç‰¹å®šçš„æƒ…å†µä¸‹ï¼Œä¾‹å¦‚åŒ¿åå‡½æ•°æˆ–è€…ä½¿ç”¨æ³›å‹çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®çš„æä¾›æ•°æ®çš„ç±»å‹ä¿¡æ¯ï¼Œæ¥æé«˜æˆ‘ä»¬ç¨‹åºçš„æ€§èƒ½ã€‚</p><h3 id="æ”¯æŒçš„æ•°æ®ç±»å‹"><a href="#æ”¯æŒçš„æ•°æ®ç±»å‹" class="headerlink" title="æ”¯æŒçš„æ•°æ®ç±»å‹"></a><a href="#%E6%94%AF%E6%8C%81%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">æ”¯æŒçš„æ•°æ®ç±»å‹</a></h3><p>Flinkæ”¯æŒJavaå’ŒScalaæä¾›çš„æ‰€æœ‰æ™®é€šæ•°æ®ç±»å‹ã€‚æœ€å¸¸ç”¨çš„æ•°æ®ç±»å‹å¯ä»¥åšä»¥ä¸‹åˆ†ç±»ï¼š</p><ul><li>Primitivesï¼ˆåŸå§‹æ•°æ®ç±»å‹ï¼‰</li><li>Javaå’ŒScalaçš„Tuplesï¼ˆå…ƒç»„ï¼‰</li><li>Scalaçš„æ ·ä¾‹ç±»</li><li>POJOç±»å‹</li><li>ä¸€äº›ç‰¹æ®Šçš„ç±»å‹</li></ul><p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬ä¸€æ¢ç©¶ç«Ÿã€‚</p><p><em>Primitives</em></p><p>Javaå’ŒScalaæä¾›çš„æ‰€æœ‰åŸå§‹æ•°æ®ç±»å‹éƒ½æ”¯æŒï¼Œä¾‹å¦‚<code>Int</code>(Javaçš„<code>Integer</code>)ï¼ŒStringï¼ŒDoubleç­‰ç­‰ã€‚ä¸‹é¢ä¸¾ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DataStream[Long] numbers = env.fromElements(<span class="number">1L</span>, <span class="number">2L</span>, <span class="number">3L</span>, <span class="number">4L</span>);</span><br><span class="line">numbers.map(n -&gt; n + <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p><em>Tuples</em></p><p>å…ƒç»„æ˜¯ä¸€ç§ç»„åˆæ•°æ®ç±»å‹ï¼Œç”±å›ºå®šæ•°é‡çš„å…ƒç´ ç»„æˆã€‚</p><p>Flinkä¸ºJavaçš„Tupleæä¾›äº†é«˜æ•ˆçš„å®ç°ã€‚Flinkå®ç°çš„Java Tupleæœ€å¤šå¯ä»¥æœ‰25ä¸ªå…ƒç´ ï¼Œæ ¹æ®å…ƒç´ æ•°é‡çš„ä¸åŒï¼ŒTupleéƒ½è¢«å®ç°æˆäº†ä¸åŒçš„ç±»ï¼šTuple1ï¼ŒTuple2ï¼Œä¸€ç›´åˆ°Tuple25ã€‚Tupleç±»æ˜¯å¼ºç±»å‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;Tuple2&lt;String, Integer&gt;&gt; persons = env</span><br><span class="line">  .fromElements(</span><br><span class="line">    Tuple2.of(<span class="string">&quot;Adam&quot;</span>, <span class="number">17</span>),</span><br><span class="line">    Tuple2.of(<span class="string">&quot;Sarah&quot;</span>, <span class="number">23</span>)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">persons.filter(p -&gt; p.f1 &gt; <span class="number">18</span>);</span><br></pre></td></tr></table></figure><p>Tupleçš„å…ƒç´ å¯ä»¥é€šè¿‡å®ƒä»¬çš„publicå±æ€§è®¿é—®â€”â€”f0ï¼Œf1ï¼Œf2ç­‰ç­‰ã€‚æˆ–è€…ä½¿ç”¨<code>getField(int pos)</code>æ–¹æ³•æ¥è®¿é—®ï¼Œå…ƒç´ ä¸‹æ ‡ä»0å¼€å§‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.tuple.Tuple2</span><br><span class="line"></span><br><span class="line">Tuple2&lt;String, Integer&gt; personTuple = Tuple2.of(<span class="string">&quot;Alex&quot;</span>, <span class="number">42</span>);</span><br><span class="line">Integer age = personTuple.getField(<span class="number">1</span>); <span class="comment">// age = 42</span></span><br></pre></td></tr></table></figure><p>ä¸åŒäºScalaçš„Tupleï¼ŒJavaçš„Tupleæ˜¯å¯å˜æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥Tupleä¸­çš„å…ƒç´ å¯ä»¥é‡æ–°è¿›è¡Œèµ‹å€¼ã€‚é‡å¤åˆ©ç”¨Javaçš„Tupleå¯ä»¥å‡è½»åƒåœ¾æ”¶é›†çš„å‹åŠ›ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">personTuple.f1 = <span class="number">42</span>; <span class="comment">// set the 2nd field to 42</span></span><br><span class="line">personTuple.setField(<span class="number">43</span>, <span class="number">1</span>); <span class="comment">// set the 2nd field to 43</span></span><br></pre></td></tr></table></figure><p><em>POJO</em></p><p>POJOç±»çš„å®šä¹‰ï¼š</p><ul><li>å…¬æœ‰ç±»</li><li>æ— å‚æ•°çš„å…¬æœ‰æ„é€ å™¨</li><li>æ‰€æœ‰çš„å­—æ®µéƒ½æ˜¯å…¬æœ‰çš„ï¼Œå¯ä»¥é€šè¿‡getterså’Œsettersè®¿é—®ã€‚</li><li>æ‰€æœ‰å­—æ®µçš„æ•°æ®ç±»å‹éƒ½å¿…é¡»æ˜¯Flinkæ”¯æŒçš„æ•°æ®ç±»å‹ã€‚</li></ul><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> String name;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">this</span>.age = age;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream&lt;Person&gt; persons = env.fromElements(</span><br><span class="line">  <span class="keyword">new</span> Person(<span class="string">&quot;Alex&quot;</span>, <span class="number">42</span>),</span><br><span class="line">  <span class="keyword">new</span> Person(<span class="string">&quot;Wendy&quot;</span>, <span class="number">23</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p><em>å…¶ä»–æ•°æ®ç±»å‹</em></p><ul><li>Array, ArrayList, HashMap, Enum</li><li>Hadoop Writable types</li></ul><h2 id="å®šä¹‰Keyä»¥åŠå¼•ç”¨å­—æ®µğŸ”º"><a href="#å®šä¹‰Keyä»¥åŠå¼•ç”¨å­—æ®µğŸ”º" class="headerlink" title="å®šä¹‰Keyä»¥åŠå¼•ç”¨å­—æ®µğŸ”º"></a><a href="#%E5%AE%9A%E4%B9%89key%E4%BB%A5%E5%8F%8A%E5%BC%95%E7%94%A8%E5%AD%97%E6%AE%B5">å®šä¹‰Keyä»¥åŠå¼•ç”¨å­—æ®µ</a>ğŸ”º</h2><p>åœ¨Flinkä¸­ï¼Œæˆ‘ä»¬å¿…é¡»æ˜ç¡®æŒ‡å®šè¾“å…¥æµä¸­çš„å…ƒç´ ä¸­çš„å“ªä¸€ä¸ªå­—æ®µæ˜¯keyã€‚</p><h3 id="ä½¿ç”¨å­—æ®µä½ç½®è¿›è¡ŒkeyBy"><a href="#ä½¿ç”¨å­—æ®µä½ç½®è¿›è¡ŒkeyBy" class="headerlink" title="ä½¿ç”¨å­—æ®µä½ç½®è¿›è¡ŒkeyBy"></a><a href="#%E4%BD%BF%E7%94%A8%E5%AD%97%E6%AE%B5%E4%BD%8D%E7%BD%AE%E8%BF%9B%E8%A1%8Ckeyby">ä½¿ç”¨å­—æ®µä½ç½®è¿›è¡ŒkeyBy</a></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;Tuple3&lt;Int, String, Long&gt;&gt; input = ...</span><br><span class="line">KeyedStream&lt;Tuple3&lt;Int, String, Long&gt;, String&gt; keyed = input.keyBy(<span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬æƒ³è¦ç”¨å…ƒç»„çš„ç¬¬2ä¸ªå­—æ®µå’Œç¬¬3ä¸ªå­—æ®µåškeyByï¼Œå¯ä»¥çœ‹ä¸‹é¢çš„ä¾‹å­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input.keyBy(<span class="number">1</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨å­—æ®µè¡¨è¾¾å¼æ¥è¿›è¡ŒkeyBy"><a href="#ä½¿ç”¨å­—æ®µè¡¨è¾¾å¼æ¥è¿›è¡ŒkeyBy" class="headerlink" title="ä½¿ç”¨å­—æ®µè¡¨è¾¾å¼æ¥è¿›è¡ŒkeyBy"></a><a href="#%E4%BD%BF%E7%94%A8%E5%AD%97%E6%AE%B5%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%9D%A5%E8%BF%9B%E8%A1%8Ckeyby">ä½¿ç”¨å­—æ®µè¡¨è¾¾å¼æ¥è¿›è¡ŒkeyBy</a></h3><p>å¯¹äºæ ·ä¾‹ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;SensorReading&gt; sensorStream = ...</span><br><span class="line">sensorStream.keyBy(<span class="string">&quot;id&quot;</span>);</span><br></pre></td></tr></table></figure><p>å¯¹äºå…ƒç»„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;Tuple3&lt;Integer, String, Long&gt;&gt; javaInput = ...</span><br><span class="line">javaInput.keyBy(<span class="string">&quot;f2&quot;</span>) <span class="comment">// key Java tuple by 3rd field</span></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-19_14-46-16.png"></p><h3 id="Keyé€‰æ‹©å™¨"><a href="#Keyé€‰æ‹©å™¨" class="headerlink" title="Keyé€‰æ‹©å™¨"></a><a href="#key%E9%80%89%E6%8B%A9%E5%99%A8">Keyé€‰æ‹©å™¨</a></h3><p>æ–¹æ³•ç±»å‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">KeySelector[IN, KEY]</span><br><span class="line">  &gt; getKey(IN): KEY</span><br></pre></td></tr></table></figure><p><strong>scala version</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> sensorData = ...</span><br><span class="line"><span class="keyword">val</span> byId = sensorData.keyBy(r =&gt; r.id)</span><br></pre></td></tr></table></figure><p><strong>java version</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;SensorReading&gt; sensorData = ...</span><br><span class="line">KeyedStream&lt;SensorReading, String&gt; byId = sensorData.keyBy(r -&gt; r.id);</span><br></pre></td></tr></table></figure><h2 id="å®ç°UDFå‡½æ•°ï¼Œæ›´ç»†ç²’åº¦çš„æ§åˆ¶æµ"><a href="#å®ç°UDFå‡½æ•°ï¼Œæ›´ç»†ç²’åº¦çš„æ§åˆ¶æµ" class="headerlink" title="å®ç°UDFå‡½æ•°ï¼Œæ›´ç»†ç²’åº¦çš„æ§åˆ¶æµ"></a><a href="#%E5%AE%9E%E7%8E%B0udf%E5%87%BD%E6%95%B0%E6%9B%B4%E7%BB%86%E7%B2%92%E5%BA%A6%E7%9A%84%E6%8E%A7%E5%88%B6%E6%B5%81">å®ç°UDFå‡½æ•°ï¼Œæ›´ç»†ç²’åº¦çš„æ§åˆ¶æµ</a></h2><p>å…¶ä¸Šä¸Šé¢çš„ä¾‹å­å·²ç»æœ‰ä½¿ç”¨UDFè‡ªå®šä¹‰å‡½æ•°å¤„ç†é€»è¾‘äº†ã€‚</p><h3 id="å‡½æ•°ç±»"><a href="#å‡½æ•°ç±»" class="headerlink" title="å‡½æ•°ç±»"></a><a href="#%E5%87%BD%E6%95%B0%E7%B1%BB">å‡½æ•°ç±»</a></h3><p>Flinkæš´éœ²äº†æ‰€æœ‰udfå‡½æ•°çš„æ¥å£(å®ç°æ–¹å¼ä¸ºæ¥å£æˆ–è€…æŠ½è±¡ç±»)ã€‚ä¾‹å¦‚MapFunction, FilterFunction, ProcessFunctionç­‰ç­‰ã€‚</p><p>ä¾‹å­å®ç°äº†FilterFunctionæ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FilterFilter</span> <span class="keyword">extends</span> <span class="title">FilterFunction</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Boolean <span class="title">filter</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> value.contains(<span class="string">&quot;flink&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream&lt;String&gt; flinkTweets = tweets.filter(<span class="keyword">new</span> FlinkFilter);</span><br></pre></td></tr></table></figure><p>è¿˜å¯ä»¥å°†å‡½æ•°å®ç°æˆåŒ¿åç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;String&gt; flinkTweets = tweets.filter(</span><br><span class="line">  <span class="keyword">new</span> RichFilterFunction&lt;String&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">filter</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> value.contains(<span class="string">&quot;flink&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬filterçš„å­—ç¬¦ä¸²â€flinkâ€è¿˜å¯ä»¥å½“ä½œå‚æ•°ä¼ è¿›å»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;String&gt; tweets = ...</span><br><span class="line">DataStream&lt;String&gt; flinkTweets = tweets.filter(<span class="keyword">new</span> KeywordFilter(<span class="string">&quot;flink&quot;</span>));</span><br><span class="line"></span><br><span class="line">class KeywordFilter(keyWord: String) extends FilterFunction&lt;String&gt; &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Boolean <span class="title">filter</span><span class="params">(String value)</span> </span>= &#123;</span><br><span class="line">    <span class="keyword">return</span> value.contains(keyWord);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åŒ¿åå‡½æ•°"><a href="#åŒ¿åå‡½æ•°" class="headerlink" title="åŒ¿åå‡½æ•°"></a><a href="#%E5%8C%BF%E5%90%8D%E5%87%BD%E6%95%B0">åŒ¿åå‡½æ•°</a></h3><p><strong>åŒ¿åå‡½æ•°å¯ä»¥å®ç°ä¸€äº›ç®€å•çš„é€»è¾‘ï¼Œä½†æ— æ³•å®ç°ä¸€äº›é«˜çº§åŠŸèƒ½ï¼Œä¾‹å¦‚è®¿é—®çŠ¶æ€ç­‰ç­‰ã€‚</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;String&gt; tweets = ...</span><br><span class="line">DataStream&lt;String&gt; flinkTweets = tweets.filter(r -&gt; r.contains(<span class="string">&quot;flink&quot;</span>));</span><br></pre></td></tr></table></figure><h3 id="å¯Œå‡½æ•°ğŸ”º"><a href="#å¯Œå‡½æ•°ğŸ”º" class="headerlink" title="å¯Œå‡½æ•°ğŸ”º"></a><a href="#%E5%AF%8C%E5%87%BD%E6%95%B0">å¯Œå‡½æ•°</a>ğŸ”º</h3><p>å…¶å®ä¸Šé¢çš„æ•°æ®æºå°±æ˜¯ç”¨äº†å¯Œå‡½æ•°ï¼Œå®ƒå¯ä»¥å®šä¹‰æ›´å¤šçš„æ“ä½œã€‚</p><p>æˆ‘ä»¬ç»å¸¸ä¼šæœ‰è¿™æ ·çš„éœ€æ±‚<strong>ï¼šåœ¨å‡½æ•°å¤„ç†æ•°æ®ä¹‹å‰ï¼Œéœ€è¦åšä¸€äº›åˆå§‹åŒ–çš„å·¥ä½œï¼›æˆ–è€…éœ€è¦åœ¨å¤„ç†æ•°æ®æ—¶å¯ä»¥è·å¾—å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡çš„ä¸€äº›ä¿¡æ¯ï¼›ä»¥åŠåœ¨å¤„ç†å®Œæ•°æ®æ—¶åšä¸€äº›æ¸…ç†å·¥ä½œã€‚</strong>è€ŒDataStream APIå°±æä¾›äº†è¿™æ ·çš„æœºåˆ¶ã€‚</p><p>DataStream APIæä¾›çš„æ‰€æœ‰è½¬æ¢æ“ä½œå‡½æ•°ï¼Œéƒ½æ‹¥æœ‰å®ƒä»¬çš„â€œå¯Œâ€ç‰ˆæœ¬ï¼Œå¹¶ä¸”æˆ‘ä»¬åœ¨ä½¿ç”¨å¸¸è§„å‡½æ•°æˆ–è€…åŒ¿åå‡½æ•°çš„åœ°æ–¹æ¥ä½¿ç”¨å¯Œå‡½æ•°ã€‚ä¾‹å¦‚ä¸‹é¢å°±æ˜¯å¯Œå‡½æ•°çš„ä¸€äº›ä¾‹å­ï¼Œå¯ä»¥çœ‹å‡ºï¼Œ<strong>åªéœ€è¦åœ¨å¸¸è§„å‡½æ•°çš„å‰é¢åŠ ä¸Š<code>Rich</code>å‰ç¼€å°±æ˜¯å¯Œå‡½æ•°äº†ã€‚</strong></p><ul><li>RichMapFunction</li><li>RichFlatMapFunction</li><li>RichFilterFunction</li><li>â€¦</li></ul><p>å½“æˆ‘ä»¬ä½¿ç”¨å¯Œå‡½æ•°æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸¤ä¸ªé¢å¤–çš„æ–¹æ³•ï¼š</p><ul><li>open()æ–¹æ³•æ˜¯rich functionçš„åˆå§‹åŒ–æ–¹æ³•ï¼Œå½“ä¸€ä¸ªç®—å­ä¾‹å¦‚mapæˆ–è€…filterè¢«è°ƒç”¨ä¹‹å‰open()ä¼šè¢«è°ƒç”¨ã€‚open()å‡½æ•°é€šå¸¸ç”¨æ¥åšä¸€äº›åªéœ€è¦åšä¸€æ¬¡å³å¯çš„åˆå§‹åŒ–å·¥ä½œã€‚</li><li>close()æ–¹æ³•æ˜¯ç”Ÿå‘½å‘¨æœŸä¸­çš„æœ€åä¸€ä¸ªè°ƒç”¨çš„æ–¹æ³•ï¼Œé€šå¸¸ç”¨æ¥åšä¸€äº›æ¸…ç†å·¥ä½œã€‚</li></ul><p>å¦å¤–ï¼ŒgetRuntimeContext()æ–¹æ³•æä¾›äº†å‡½æ•°çš„RuntimeContextçš„ä¸€äº›ä¿¡æ¯ï¼Œä¾‹å¦‚å‡½æ•°æ‰§è¡Œçš„å¹¶è¡Œåº¦ï¼Œå½“å‰å­ä»»åŠ¡çš„ç´¢å¼•ï¼Œå½“å‰å­ä»»åŠ¡çš„åå­—ã€‚åŒæ—¶è¿˜å®ƒè¿˜åŒ…å«äº†è®¿é—®<strong>åˆ†åŒºçŠ¶æ€</strong>çš„æ–¹æ³•ã€‚ä¸‹é¢çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFlatMap</span> <span class="keyword">extends</span> <span class="title">RichFlatMapFunction</span>&lt;<span class="title">Integer</span>, <span class="title">Tuple2</span>&lt;<span class="title">Integer</span>, <span class="title">Integer</span>&gt;&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> subTaskIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration configuration)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> subTaskIndex = getRuntimeContext.getIndexOfThisSubtask;</span><br><span class="line">    <span class="comment">// åšä¸€äº›åˆå§‹åŒ–å·¥ä½œ</span></span><br><span class="line">    <span class="comment">// ä¾‹å¦‚å»ºç«‹ä¸€ä¸ªå’ŒHDFSçš„è¿æ¥</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flatMap</span><span class="params">(Integer in, Collector&lt;Tuple2&lt;Integer, Integer&gt;&gt; out)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (in % <span class="number">2</span> == subTaskIndex) &#123;</span><br><span class="line">      out.collect((subTaskIndex, in));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ¸…ç†å·¥ä½œï¼Œæ–­å¼€å’ŒHDFSçš„è¿æ¥ã€‚</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Window-API"><a href="#Window-API" class="headerlink" title="Window API"></a>Window API</h1><p>ä¸€èˆ¬çœŸå®çš„æµéƒ½æ˜¯æ— ç•Œçš„ï¼Œæ€æ ·å¤„ç†æ— ç•Œçš„æ•°æ®ï¼Ÿ</p><p>å°†æ— ç•Œæµè½¬æ¢ä¸ºæœ‰ç•Œæµå¼€å§‹è®¡ç®—ï¼Œå› ä¸ºæ— ç•Œæµæ˜¯æ— é™åˆ¶çš„ï¼Œä¸ä¼šæœ‰ç»“æœã€‚</p><p>å¯ä»¥æŠŠæ— é™çš„æ•°æ®æµè¿›è¡Œåˆ‡åˆ†ï¼Œå¾—åˆ°æœ‰é™çš„æ•°æ®é›†è¿›è¡Œå¤„ç† â€”â€” ä¹Ÿå°±æ˜¯å¾—åˆ°æœ‰ç•Œæµï¼›çª—å£ï¼ˆwindowï¼‰å°±æ˜¯å°†æ— é™æµåˆ‡å‰²ä¸ºæœ‰é™æµçš„ä¸€ç§æ–¹å¼ï¼Œå®ƒä¼šå°†æµæ•°æ®åˆ†å‘åˆ°æœ‰é™å¤§å°çš„æ¡¶ï¼ˆbucketï¼‰ä¸­è¿›è¡Œåˆ†æ</p><h2 id="window-ç±»å‹"><a href="#window-ç±»å‹" class="headerlink" title="window ç±»å‹"></a>window ç±»å‹</h2><ol><li>æ—¶é—´çª—å£ï¼ˆTime Windowï¼‰ï¼šä¸»è¦å†™çš„æ—¶é—´çª—å£ï¼Œè®¡æ•°çª—å£ç±»ä¼¼ã€‚<ul><li><a href="#%E6%97%B6%E9%97%B4%E6%BB%9A%E5%8A%A8%E7%AA%97%E5%8F%A3">æ»šåŠ¨æ—¶é—´çª—å£</a>ï¼š<strong>Tumbling Windows</strong></li><li><a href="#%E6%97%B6%E9%97%B4%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3">æ»‘åŠ¨æ—¶é—´çª—å£</a>ï¼š<strong>Sliding Windows</strong></li><li><a href="#%E4%BC%9A%E8%AF%9D%E7%AA%97%E5%8F%A3">ä¼šè¯çª—å£</a>ï¼š<strong>Session Windows</strong></li></ul></li><li>è®¡æ•°çª—å£ï¼ˆCount Windowï¼‰<ul><li>æ»šåŠ¨è®¡æ•°çª—å£</li><li>æ»‘åŠ¨è®¡æ•°çª—å£</li></ul></li></ol><h3 id="æ—¶é—´çª—å£"><a href="#æ—¶é—´çª—å£" class="headerlink" title="æ—¶é—´çª—å£"></a>æ—¶é—´çª—å£</h3><p><font color="red">æ—¶é—´çª—å£åˆåˆ†ä¸ºï¼šäº‹ä»¶æ—¶é—´ã€è§¦å‘æ—¶é—´ã€‚é»˜è®¤çš„æ˜¯è§¦å‘æ—¶é—´çª—å£</font></p><h4 id="æ—¶é—´æ»šåŠ¨çª—å£"><a href="#æ—¶é—´æ»šåŠ¨çª—å£" class="headerlink" title="æ—¶é—´æ»šåŠ¨çª—å£"></a>æ—¶é—´æ»šåŠ¨çª—å£</h4><p><strong>Tumbling Windows</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201220215345926.png" alt="image-20201220215345926"></p><ol><li>æ—¶é—´å¯¹é½ï¼Œçª—å£é•¿åº¦å›ºå®šï¼Œæ²¡æœ‰é‡å </li><li>æ»šåŠ¨çª—å£æ˜¯ç‰¹æ®Šçš„æ»‘åŠ¨çª—å£ï¼ˆæ»‘åŠ¨é—´éš”=çª—å£é•¿åº¦ï¼‰</li><li>å·¦é—­å³å¼€</li></ol><p>æ»šåŠ¨çª—å£è®¡ç®—æŸä¸€ç§’æ‰€åœ¨çš„çª—å£çš„èµ·å§‹æ—¶é—´ï¼Œoffset=0ï¼Œts=1â€¦n(s)ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201220144118892.png" alt="image-20201220144118892"></p><h4 id="æ—¶é—´æ»‘åŠ¨çª—å£"><a href="#æ—¶é—´æ»‘åŠ¨çª—å£" class="headerlink" title="æ—¶é—´æ»‘åŠ¨çª—å£"></a>æ—¶é—´æ»‘åŠ¨çª—å£</h4><p><strong>Sliding Windows</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201220220206360.png" alt="image-20201220220206360"></p><ol><li>æ»‘åŠ¨çª—å£æ˜¯å›ºå®šçª—å£çš„æ›´å¹¿ä¹‰çš„ä¸€ç§å½¢å¼ï¼Œæ»‘åŠ¨çª—å£ç”±å›ºå®šçš„çª—å£é•¿åº¦å’Œæ»‘åŠ¨é—´éš”ç»„æˆ</li><li>çª—å£é•¿åº¦å›ºå®šï¼Œå¯ä»¥æœ‰é‡å </li></ol><blockquote><p>æ³¨æ„ï¼š</p><p>å› ä¸ºæ»‘åŠ¨çª—å£åœ¨æ»‘åŠ¨é—´éš”&lt;çª—å£é•¿åº¦æ—¶ï¼Œä¸åŒçš„çª—å£ä¼šæœ‰é‡å¤çš„æ•°æ®ï¼Œä¸ºäº†å‰é¢çš„çª—å£çš„æ¶ˆå¤±ä¸å½±å“åé¢çª—å£çš„æ•°æ®ï¼ŒFlinkä¼šå°†æ•°æ®å¤åˆ¶åˆ†åˆ«ç»™ä½¿ç”¨åˆ°æ­¤æ•°æ®çš„ä¸åŒçª—å£ã€‚</p><p><font color="red">æ‰€ä»¥ï¼Œå¦‚æœæ»‘åŠ¨é—´éš”è¿‡å°ï¼Œä¼šå¯¼è‡´Flinkå¤åˆ¶è¿‡å¤šçš„æ•°æ®ï¼Œé€ æˆæ•ˆç‡ä¸¥é‡é™ä½ã€‚</font></p><p>ä¾‹å¦‚ï¼š</p><p>çª—å£é•¿åº¦100minï¼Œçª—å£å“¦é—´éš”1minï¼›è¿™æ ·æ¯è¿‡ä¸€åˆ†é’Ÿï¼Œå°±ä¼šå¤åˆ¶æ­¤çª—å£çš„å99æ¡æ•°æ®ç»™ä¸‹ä¸€ä¸ªçª—å£ã€‚</p></blockquote><h4 id="ä¼šè¯çª—å£"><a href="#ä¼šè¯çª—å£" class="headerlink" title="ä¼šè¯çª—å£"></a>ä¼šè¯çª—å£</h4><p><strong>Session Windows</strong>ï¼Œåªæœ‰æ—¶é—´çª—å£æ‰æœ‰ä¼šè¯çª—å£</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201220221007431.png" alt="image-20201220221007431"></p><ol><li>ç”±ä¸€ç³»åˆ—äº‹ä»¶ç»„åˆä¸€ä¸ªæŒ‡å®šæ—¶é—´é•¿åº¦çš„ timeout é—´éš™ç»„æˆï¼Œä¹Ÿå°±æ˜¯ä¸€æ®µæ—¶é—´æ²¡æœ‰æ¥æ”¶åˆ°æ–°æ•°æ®å°±ä¼šç”Ÿæˆæ–°çš„çª—å£</li><li>ç‰¹ç‚¹ï¼šæ—¶é—´æ— å¯¹é½</li></ol><blockquote><p> æŒ‡å®šæ—¶é—´é•¿åº¦timeoutå†…æ— æ•°æ®ï¼Œæ–°æ•°æ®æ¥ä¸´åä¼šç›´æ¥äº§ç”Ÿæ–°çš„çª—å£ã€‚å®ƒå¯ç”¨æ¥ç»Ÿè®¡è¡Œä¸ºæ¨¡å¼</p><p> å³ï¼šæ–°æ¥çš„äº‹ä»¶å’Œä¸Šä¸€äº‹ä»¶çš„æ—¶é—´é—´éš”å¤§äºtimeoutçš„è¯ï¼Œä¸Šä¸€çª—å£ç›´æ¥å…³é—­ï¼Œæ–°æ¥çš„äº‹ä»¶åœ¨æ–°çš„çª—å£ï¼Œæ˜¯å®ƒçš„ç¬¬ä¸€ä¸ªäº‹ä»¶ã€‚</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201221150605732.png" alt="image-20201221150605732"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201221150626503.png" alt="image-20201221150626503"></p><h2 id="Window-API-1"><a href="#Window-API-1" class="headerlink" title="Window API"></a>Window API</h2><p><strong><font color="red">ä¸€èˆ¬æ•°æ®å…ˆåˆ†æµåå¼€çª—ã€‚</font>åˆ†æµåä¸åŒkeyå¯èƒ½ä¸åœ¨ä¸€ä¸ªslotä¸­ä¹Ÿå¯èƒ½ä¸åœ¨ä¸€ä¸ªtaskmanagerä¸­ï¼Œè¿™æ ·ï¼Œæ¯ä¸ªkeyçš„çª—å£äº’ä¸å¹²æ¶‰ï¼ŒåŠ å¤§å¹¶è¡Œã€‚</strong></p><h3 id="create-window"><a href="#create-window" class="headerlink" title="create window"></a>create window</h3><p><strong><em>window</em></strong></p><p>æœ€åº•å±‚çš„å¼€çª—å£çš„æ–¹æ³•ï¼š<code>window()</code>ã€‚ç”¨ <code>.window() </code>æ¥å®šä¹‰ä¸€ä¸ªçª—å£ï¼Œç„¶ååŸºäºè¿™ä¸ª window å»åšä¸€äº›èšåˆæˆ–è€…å…¶å®ƒå¤„ç†æ“ä½œã€‚æ³¨æ„ window () æ–¹æ³•å¿…é¡»åœ¨ keyBy ä¹‹åæ‰èƒ½ç”¨ã€‚</p><blockquote><p>window()ä¸windowall()</p><p>windowall()æ˜¯åº”ç”¨åœ¨DataStreamä¸Šçš„ï¼Œå°†æ‰€æœ‰æ•°æ®æ”¾åœ¨ä¸€ä¸ªçª—å£ä¸­</p><p>window()æ˜¯åº”ç”¨åœ¨DataStreamå’Œ<strong>KeydStream</strong>ä¸Šçš„ã€‚</p></blockquote><p>è€Œ<code>window</code>æ–¹æ³•æ„é€ æ—¶é—´ã€è®¡æ•°çª—å£æ˜¯éœ€è¦ä¸€ä¸ªçª—å£åˆ†é…å™¨ï¼ˆ<strong>window assigner</strong>ï¼‰çš„ã€‚WindowAssigner è´Ÿè´£å°†æ¯æ¡è¾“å…¥çš„æ•°æ®åˆ†å‘åˆ°æ­£ç¡®çš„ window ä¸­ï¼ŒFlink æä¾›äº†é€šç”¨çš„ <strong>WindowAssigner</strong>ï¼š</p><ul><li>æ»šåŠ¨çª—å£ï¼ˆtumbling windowï¼‰</li><li>æ»‘åŠ¨çª—å£ï¼ˆsliding windowï¼‰</li><li>ä¼šè¯çª—å£ï¼ˆsession windowï¼‰</li><li>å…¨å±€çª—å£ï¼ˆglobal windowï¼‰ï¼Œéƒ½åœ¨ä¸€ä¸ªçª—å£ä¸­</li></ul><hr><p><strong><em>timewindow</em>,<em>countwindow</em>ğŸ”º</strong></p><p>windowæ–¹æ³•åˆ›å»ºè¿˜éœ€è¦<strong>window assigner</strong>ï¼Œæ¯”è¾ƒéº»çƒ¦ã€‚Flink æä¾›äº†æ›´åŠ ç®€å•çš„<code> .timeWindow</code> å’Œ<code>.countWindow</code> æ–¹æ³•ï¼Œç”¨äºå®šä¹‰æ—¶é—´çª—å£å’Œè®¡æ•°çª—å£ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">env.addSource(<span class="keyword">new</span> <span class="type">SensorSource</span>)</span><br><span class="line">    .keyBy(<span class="number">0</span>).timeWindow(<span class="type">Time</span>.seconds(<span class="number">5</span>L))</span><br><span class="line">    .reduce((r1, _)=&gt;r1).print()</span><br></pre></td></tr></table></figure><p><img src="E:\Projects\sync\md\flink\Snipaste_2020-12-19_12-00-52.png" alt="image-20201220102331672"></p><blockquote><p>Flinkçš„çª—å£å‡½æ•°å’ŒSparkçš„æœ‰æ‰€ä¸åŒï¼Œå³å¼€çª—å£çš„ç±»å‹æ˜¯SensorReadingè€Œä¸æ˜¯SensorReading[]ï¼Œå› ä¸ºå®ƒå®é™…ä¸Šæ˜¯æ‰¹å¤„ç†ï¼Œå³æ¥ä¸€æ¡æ•°æ®ç»™ä¸€æ¡æ•°æ®æ‰“ä¸Šçª—å£çš„æ ‡ç­¾ã€‚è€Œä¸æ˜¯èµä¸€ä¸ªçª—å£çš„æ•°æ®å†å¤„ç†ï¼ŒFlinkä¹Ÿèƒ½è¿™æ ·åšå³ä½¿ç”¨å…¨çª—å£å‡½æ•°<code>ProcessWindowFunction</code>ã€‚</p></blockquote><p><strong>åˆ›å»ºä¸åŒç±»å‹çš„çª—å£</strong>ï¼š</p><ol><li><strong>æ»šåŠ¨æ—¶é—´çª—å£ï¼ˆtumbling time windowï¼‰</strong>ï¼š<code>.timeWindow(Time.seconds(5L))</code></li><li><strong>æ»‘åŠ¨æ—¶é—´çª—å£ï¼ˆsliding time windowï¼‰</strong>ï¼š<code>.timeWindow(Time.seconds(5L), Time.seconds(1L))</code></li><li><strong>ä¼šè¯çª—å£ï¼ˆsession windowï¼‰</strong>ï¼š<code>.window(EventTimeSessionWindows.withGrap(Time.minutes(10)))</code></li><li><strong>æ»šåŠ¨è®¡æ•°çª—å£ï¼ˆtumbling count windowï¼‰</strong>ï¼š<code>.countWindow(Time.seconds(5L))</code></li><li><strong>æ»‘åŠ¨è®¡æ•°çª—å£ï¼ˆsliding count windowï¼‰</strong>ï¼š<code>.countWindow(Time.seconds(5L), Time.seconds(1L))</code></li></ol><h3 id="window-functionğŸ”º"><a href="#window-functionğŸ”º" class="headerlink" title="window functionğŸ”º"></a>window functionğŸ”º</h3><p>window function å®šä¹‰äº†è¦å¯¹çª—å£ä¸­æ”¶é›†çš„æ•°æ®åšçš„è®¡ç®—æ“ä½œï¼Œå¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li>å¢é‡èšåˆå‡½æ•°ï¼šæ¯æ¡æ•°æ®åˆ°æ¥å°±è¿›è¡Œè®¡ç®—,åªä¿å­˜ä¸€ä¸ªç®€å•çš„çŠ¶æ€(ç´¯åŠ å™¨)ï¼Œçª—å£é—­åˆå³è®¡ç®—å®Œæˆ<ul><li>ReduceFuntion</li><li>AggregateFunction<ul><li>mergeåªä¼šåœ¨äº‹ä»¶æ—¶é—´çš„çª—å£ä¸­ç”¨åˆ°</li></ul></li></ul></li><li>å…¨çª—å£å‡½æ•°ï¼šå…ˆæŠŠçª—å£æ‰€æœ‰æ•°æ®æ”¶é›†èµ·æ¥,ç­‰åˆ°è®¡ç®—çš„æ—¶å€™ä¼šéå†æ‰€æœ‰æ•°æ®.ç±»ä¼¼äºSparkçš„å¾®æ‰¹å¤„ç†ï¼ŒåŒºåˆ«æ˜¯æ—¶é—´åŒºåŸŸï¼ˆProcessWindowFunctionï¼Œä¸€ä¸ªå¯Œå‡½æ•°ï¼‰</li></ul><h3 id="å…¶ä»–API"><a href="#å…¶ä»–API" class="headerlink" title="å…¶ä»–API"></a>å…¶ä»–API</h3><ul><li>.trigger() â€”â€” è§¦å‘å™¨ï¼šå®šä¹‰ window ä»€ä¹ˆæ—¶å€™å…³é—­ï¼Œè§¦å‘è®¡ç®—å¹¶è¾“å‡ºç»“æœ</li><li>.evictor() â€”â€” ç§»é™¤å™¨ï¼šå®šä¹‰ç§»é™¤æŸäº›æ•°æ®çš„é€»è¾‘</li><li>.allowedLateness() â€”â€” å…è®¸å¤„ç†è¿Ÿåˆ°çš„æ•°æ®</li><li>.sideOutputLateData() â€”â€” å°†è¿Ÿåˆ°çš„æ•°æ®æ”¾å…¥ä¾§è¾“å‡ºæµ</li><li>.getSideOutput() â€”â€” è·å–ä¾§è¾“å‡ºæµ</li></ul><h2 id="å¢é‡èšåˆä¸å…¨é‡èšåˆ"><a href="#å¢é‡èšåˆä¸å…¨é‡èšåˆ" class="headerlink" title="å¢é‡èšåˆä¸å…¨é‡èšåˆ"></a>å¢é‡èšåˆä¸å…¨é‡èšåˆ</h2><h3 id="å¢é‡èšåˆ"><a href="#å¢é‡èšåˆ" class="headerlink" title="å¢é‡èšåˆ"></a>å¢é‡èšåˆ</h3><h4 id="ReduceFunction"><a href="#ReduceFunction" class="headerlink" title="ReduceFunction"></a><em>ReduceFunction</em></h4><p>æ¯”è¾ƒæŠ½è±¡ï¼Œå®ç°ç®€å•ï¼Œå®ç°çš„åŠŸèƒ½è¾ƒå°‘ï¼Œä¸å¯ä»¥æ”¹å˜æµçš„æ•°æ®ç±»å‹ã€‚</p><h4 id="AggregateFunction"><a href="#AggregateFunction" class="headerlink" title="AggregateFunction"></a><em>AggregateFunction</em></h4><p>æ¯”reduceå®ç°è¾ƒéº»çƒ¦ï¼Œä½†æ˜¯å¯ä»¥æ”¹å˜æµä¸­çš„æ•°æ®ç±»å‹ï¼Œè¾ƒçµæ´»ã€‚</p><blockquote><p>å®ƒçš„ä¼˜ç‚¹ï¼šæ¯ä¸ªçª—å£åªç”¨ä¿å­˜ä¸€ä¸ªçŠ¶æ€å³å¯ã€‚æ­£æ˜¯å› ä¸ºå®ƒçš„ä¼˜ç‚¹ç»™å®ƒå¸¦æ¥äº†ä¸€äº›ç¼ºç‚¹ï¼šå› ä¸ºä¿å­˜çš„æ•°æ®å°‘ï¼Œæ— æ³•è®¡ç®—ä¸€äº›åœºæ™¯ï¼šä¾‹å¦‚è®¡ç®—çª—å£æ•°æ®çš„ä¸­ä½æ•°ï¼Œæˆ–è€…è®¡ç®—çª—å£æ•°æ®ä¸­å‡ºç°é¢‘ç‡æœ€é«˜çš„å€¼ã€‚</p><p>è¿™æ—¶ä½¿ç”¨ReduceFunctionå’ŒAggregateFunctionå°±æ— æ³•å®ç°äº†ã€‚<font color="red">ã€‚è¿™ä¸ªæ—¶å€™å°±éœ€è¦ProcessWindowFunctionäº†ã€‚</font></p></blockquote><p>å…ˆæ¥çœ‹æ¥å£å®šä¹‰<em>AggregateFunction</em>ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public interface <span class="type">AggregateFunction</span>&lt;<span class="type">IN</span>, <span class="type">ACC</span>, <span class="type">OUT</span>&gt;</span><br><span class="line">  <span class="keyword">extends</span> <span class="type">Function</span>, <span class="type">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// create a new accumulator to start a new aggregate</span></span><br><span class="line">  <span class="type">ACC</span> createAccumulator();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// add an input element to the accumulator and return the accumulator</span></span><br><span class="line">  <span class="type">ACC</span> add(<span class="type">IN</span> value, <span class="type">ACC</span> accumulator);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// compute the result from the accumulator and return it.</span></span><br><span class="line">  <span class="type">OUT</span> getResult(<span class="type">ACC</span> accumulator);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// merge two accumulators and return the result.</span></span><br><span class="line">  <span class="type">ACC</span> merge(<span class="type">ACC</span> a, <span class="type">ACC</span> b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>INæ˜¯è¾“å…¥å…ƒç´ çš„ç±»å‹ï¼ŒACCæ˜¯ç´¯åŠ å™¨çš„ç±»å‹ï¼ŒOUTæ˜¯è¾“å‡ºå…ƒç´ çš„ç±»å‹ã€‚</p><p>ä¾‹å¦‚ï¼šæ±‚å¹³å‡æ¸©åº¦ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">TumblingWindow</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line"></span><br><span class="line">    env.addSource(<span class="keyword">new</span> <span class="type">SensorSource</span>)</span><br><span class="line">      .keyBy(<span class="number">0</span>).timeWindow(<span class="type">Time</span>.seconds(<span class="number">5</span>L))</span><br><span class="line">      <span class="comment">// ä¾‹å¦‚è®¡ç®—å¹³å‡æ¸©åº¦</span></span><br><span class="line">      .aggregate(<span class="keyword">new</span> <span class="type">MyAggregate</span>).print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ã€æµè¾“å…¥ã€ç´¯åŠ å™¨ã€æµè¾“å‡ºã€‘</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MyAggregate</span> <span class="keyword">extends</span> <span class="title">AggregateFunction</span>[<span class="type">SensorReading</span>, (<span class="type">String</span>, <span class="type">Long</span>, <span class="type">Double</span>), (<span class="type">String</span>, <span class="type">Double</span>)] </span>&#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–ç´¯åŠ å™¨</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">createAccumulator</span></span>(): (<span class="type">String</span>, <span class="type">Long</span>, <span class="type">Double</span>) = &#123;</span><br><span class="line">      (<span class="string">&quot;&quot;</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç´¯åŠ é€»è¾‘</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(in: <span class="type">SensorReading</span>, acc: (<span class="type">String</span>, <span class="type">Long</span>, <span class="type">Double</span>)): (<span class="type">String</span>, <span class="type">Long</span>, <span class="type">Double</span>) = &#123;</span><br><span class="line">      (in.id, acc._2 + <span class="number">1</span>, acc._3 + in.temperature)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æµåˆå¹¶ï¼Œåªæœ‰äº‹ä»¶æ—¶é—´ï¼ˆé»˜è®¤ä¸ºè§¦å‘æ—¶é—´çª—å£ï¼‰çª—å£æ‰ä¼šç”¨åˆ°</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">merge</span></span>(acc: (<span class="type">String</span>, <span class="type">Long</span>, <span class="type">Double</span>), acc1: (<span class="type">String</span>, <span class="type">Long</span>, <span class="type">Double</span>)): (<span class="type">String</span>, <span class="type">Long</span>, <span class="type">Double</span>) = &#123;</span><br><span class="line">      (acc._1, acc._2 + acc1._2, acc._3 + acc1._3)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getResult</span></span>(acc: (<span class="type">String</span>, <span class="type">Long</span>, <span class="type">Double</span>)): (<span class="type">String</span>, <span class="type">Double</span>) = &#123;</span><br><span class="line">      (acc._1, acc._3 / acc._2)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å…¨é‡èšåˆ"><a href="#å…¨é‡èšåˆ" class="headerlink" title="å…¨é‡èšåˆ"></a>å…¨é‡èšåˆ</h3><h4 id="ProcessWindowFunction"><a href="#ProcessWindowFunction" class="headerlink" title="ProcessWindowFunction"></a><em>ProcessWindowFunction</em></h4><p>ä¸€äº›ä¸šåŠ¡åœºæ™¯ï¼Œæˆ‘ä»¬éœ€è¦æ”¶é›†çª—å£å†…æ‰€æœ‰çš„æ•°æ®è¿›è¡Œè®¡ç®—ï¼Œä¾‹å¦‚è®¡ç®—çª—å£æ•°æ®çš„ä¸­ä½æ•°ï¼Œæˆ–è€…è®¡ç®—çª—å£æ•°æ®ä¸­å‡ºç°é¢‘ç‡æœ€é«˜çš„å€¼ã€‚è¿™æ ·çš„éœ€æ±‚ï¼Œä½¿ç”¨ReduceFunctionå’ŒAggregateFunctionå°±æ— æ³•å®ç°äº†ã€‚è¿™ä¸ªæ—¶å€™å°±éœ€è¦ProcessWindowFunctionäº†ã€‚</p><blockquote><p>ä½†æ˜¯ï¼Œæ­¤æ–¹æ³•è™½ç„¶èƒ½è·å–åˆ°çš„ä¿¡æ¯æ¯”è¾ƒå¤šï¼Œä¾‹å¦‚ï¼šçª—å£ä¿¡æ¯å’Œçª—å£å†…æ‰€æœ‰æ•°æ®çš„é›†åˆã€‚ä½†æ˜¯æ­£å¼å› ä¸ºå­˜çš„ä¸œè¥¿è¿‡å¤šï¼Œå°†ä¼šéå¸¸å ç”¨ç©ºé—´ã€‚æ‰€ä»¥ æœ‰ä¸€ç§å°†ReduceFunction/AggregateFunctionProcessWindowFunctionç»“åˆèµ·æ¥ä½¿ç”¨çš„æ–¹å¼ï¼Œå¸å–ä¸¤è¾¹çš„ä¼˜ç‚¹ã€‚<font color="red">å¢é‡èšåˆè´Ÿè´£èšåˆï¼Œå…¨çª—å£å‡½æ•°è´Ÿè´£åŒ…è£…çª—å£ä¿¡æ¯</font></p></blockquote><p>å…ˆæ¥çœ‹æ¥å£å®šä¹‰</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessWindowFunction&lt;IN</span>, <span class="title">OUT</span>, <span class="title">KEY</span>, <span class="title">W</span> <span class="keyword">extends</span> <span class="title">Window&gt;</span></span></span><br><span class="line"><span class="class">  <span class="keyword">extends</span> <span class="title">AbstractRichFunction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Evaluates the window</span></span><br><span class="line">  void process(<span class="type">KEY</span> key, <span class="type">Context</span> ctx, <span class="type">Iterable</span>&lt;<span class="type">IN</span>&gt; vals, <span class="type">Collector</span>&lt;<span class="type">OUT</span>&gt; out)</span><br><span class="line">    <span class="keyword">throws</span> <span class="type">Exception</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Deletes any custom per-window state when the window is purged</span></span><br><span class="line">  public void clear(<span class="type">Context</span> ctx) <span class="keyword">throws</span> <span class="type">Exception</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The context holding window metadata</span></span><br><span class="line">  public <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Context</span> <span class="title">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Returns the metadata of the window</span></span><br><span class="line">    public <span class="keyword">abstract</span> <span class="type">W</span> window();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Returns the current processing time</span></span><br><span class="line">    public <span class="keyword">abstract</span> long currentProcessingTime();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Returns the current event-time watermark</span></span><br><span class="line">    public <span class="keyword">abstract</span> long currentWatermark();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// State accessor for per-window state</span></span><br><span class="line">    public <span class="keyword">abstract</span> <span class="type">KeyedStateStore</span> windowState();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// State accessor for per-key global state</span></span><br><span class="line">    public <span class="keyword">abstract</span> <span class="type">KeyedStateStore</span> globalState();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Emits a record to the side output identified by the OutputTag.</span></span><br><span class="line">    public <span class="keyword">abstract</span> &lt;<span class="type">X</span>&gt; void output(<span class="type">OutputTag</span>&lt;<span class="type">X</span>&gt; outputTag, <span class="type">X</span> value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>process()æ–¹æ³•æ¥å—çš„å‚æ•°ä¸ºï¼šwindowçš„keyï¼ŒIterableè¿­ä»£å™¨åŒ…å«çª—å£çš„æ‰€æœ‰å…ƒç´ ï¼ŒCollectorç”¨äºè¾“å‡ºç»“æœæµã€‚Contextå‚æ•°å’Œåˆ«çš„processæ–¹æ³•ä¸€æ ·ã€‚è€ŒProcessWindowFunctionçš„Contextå¯¹è±¡è¿˜å¯ä»¥è®¿é—®windowçš„å…ƒæ•°æ®(çª—å£å¼€å§‹å’Œç»“æŸæ—¶é—´)ï¼Œå½“å‰å¤„ç†æ—¶é—´å’Œæ°´ä½çº¿ï¼Œper-window stateå’Œper-key global stateï¼Œside outputsã€‚</p><ul><li>per-window state: ç”¨äºä¿å­˜ä¸€äº›ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯å¯ä»¥è¢«process()è®¿é—®ï¼Œåªè¦processæ‰€å¤„ç†çš„å…ƒç´ å±äºè¿™ä¸ªçª—å£ã€‚</li><li>per-key global state: åŒä¸€ä¸ªkeyï¼Œä¹Ÿå°±æ˜¯åœ¨ä¸€æ¡KeyedStreamä¸Šï¼Œä¸åŒçš„windowå¯ä»¥è®¿é—®per-key global stateä¿å­˜çš„å€¼ã€‚</li></ul><p>ä¾‹å­ï¼šè®¡ç®—5sæ»šåŠ¨çª—å£ä¸­å¹³å‡å€¼</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">MyProcessWindowFunction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> source: <span class="type">DataStream</span>[<span class="type">SensorReading</span>] = env.addSource(<span class="keyword">new</span> <span class="type">SensorSource</span>)</span><br><span class="line">    source.keyBy(r=&gt;r.id).timeWindow(<span class="type">Time</span>.seconds(<span class="number">3</span>L)).process(<span class="keyword">new</span> test1).print()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¾“å…¥ï¼Œè¾“å‡ºï¼Œkeyï¼Œçª—å£ç±»å‹</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">test1</span> <span class="keyword">extends</span> <span class="title">ProcessWindowFunction</span>[<span class="type">SensorReading</span>, (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Long</span>, <span class="type">Long</span>), <span class="type">String</span>, <span class="type">TimeWindow</span>] </span>&#123;</span><br><span class="line">    <span class="comment">// çª—å£æœ€åçš„å¤„ç†é€»è¾‘ï¼Œ elementsæ˜¯çª—å£ä¸­çš„æ‰€æœ‰äº‹ä»¶</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">process</span></span>(key: <span class="type">String</span>, context: <span class="type">Context</span>, elements: <span class="type">Iterable</span>[<span class="type">SensorReading</span>], out: <span class="type">Collector</span>[(<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Long</span>, <span class="type">Long</span>)]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="keyword">var</span> sum: <span class="type">Double</span> = <span class="number">0.0</span></span><br><span class="line">      <span class="keyword">val</span> size: <span class="type">Int</span> = elements.size</span><br><span class="line">      elements.foreach(x=&gt;&#123;</span><br><span class="line">        sum+=x.temperature</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      out.collect((key, sum / size, context.window.getStart, context.window.getEnd))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>éœ€è¦æ³¨æ„çš„åœ°æ–¹</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201221174330638.png" alt="image-20201221174330638"></p><h3 id="å¢é‡ã€å…¨é‡è”åˆä½¿ç”¨ğŸ”º"><a href="#å¢é‡ã€å…¨é‡è”åˆä½¿ç”¨ğŸ”º" class="headerlink" title="å¢é‡ã€å…¨é‡è”åˆä½¿ç”¨ğŸ”º"></a>å¢é‡ã€å…¨é‡è”åˆä½¿ç”¨ğŸ”º</h3><p>å¦‚æœè®¡ç®—ä¸­ä½æ•°æˆ–è€…å‡ºç°æœ€é«˜é¢‘ç‡çš„æ•°æ®ï¼Œåˆ™å¿…é¡»ç”¨å…¨é‡èšåˆã€‚ä½†æ˜¯ï¼Œå¦‚æœè®¡ç®—å¹³å‡æ•°ä¹‹ç±»çš„ä¸ºäº†æ•ˆç‡ï¼Œç›´æ¥ä½¿ç”¨å¢é‡èšåˆï¼Œç„¶æ˜¯å¦‚æœè¿˜æƒ³è·å–åˆ°çª—å£çš„åŸºç¡€ä¿¡æ¯ï¼Œåˆ™è¿˜éœ€è¦å…¨é‡èšåˆçš„å°è£…ï¼Œä½†æ˜¯æ­¤æ—¶å…¨é‡èšåˆä¸å†è®¡ç®—ï¼ŒäºŒåå°è£…ä¸€æ¬¡æ•°æ®ã€‚</p><ol><li>å¢é‡èšåˆç›´æ¥è®¡ç®—å‡ºç»“æœ</li><li>ç„¶åå…¨é‡èšåˆæ ¹æ®å¢é‡èšåˆçš„ç»“æœï¼Œè°ƒæ•´è¾“å…¥å’Œè¾“å‡ºå¹¶é™„åŠ çª—å£ä¿¡æ¯</li><li>è°ƒç”¨æ—¶é€šè¿‡<code>aggregate(å¢é‡, å…¨é‡)</code></li><li><font color="red">é‡è¦çš„ä¸€ç‚¹ï¼Œç»è¿‡<code>aggregate</code>å¢é‡èšåˆä¹‹åï¼Œå…¨é‡èšåˆçš„elementsé›†åˆåªæœ‰ä¸€æ¡æ•°æ®</font></li></ol><hr><p>ä¾‹å­ï¼šè®¡ç®—5sæ»šåŠ¨çª—å£ä¸­çš„æœ€ä½å’Œæœ€é«˜çš„æ¸©åº¦ã€‚è¾“å‡ºçš„å…ƒç´ åŒ…å«äº†(æµçš„Key, æœ€ä½æ¸©åº¦, æœ€é«˜æ¸©åº¦, çª—å£ç»“æŸæ—¶é—´)ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.flink.transform.window</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.<span class="type">AggregateFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.function.<span class="type">ProcessWindowFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows.<span class="type">TimeWindow</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"><span class="keyword">import</span> org.example.flink.source.&#123;<span class="type">SensorReading</span>, <span class="type">SensorSource</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">AggregateAndProcessWindow</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">out</span>(<span class="params">id: <span class="type">String</span>, max: <span class="type">Double</span>, min: <span class="type">Double</span>,var startTime: <span class="type">Long</span>,var endTime: <span class="type">Long</span></span>)</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  <span class="title">def</span> <span class="title">main</span>(<span class="params">args: <span class="type">Array</span>[<span class="type">String</span>]</span>)</span>: <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line"></span><br><span class="line">    env.addSource(<span class="keyword">new</span> <span class="type">SensorSource</span>)</span><br><span class="line">      .keyBy(r=&gt;r.id).timeWindow(<span class="type">Time</span>.seconds(<span class="number">5</span>L))</span><br><span class="line">      <span class="comment">// ä¾‹å¦‚è®¡ç®—å¹³å‡æ¸©åº¦</span></span><br><span class="line">      .aggregate(<span class="keyword">new</span> myAggFunction ,<span class="keyword">new</span> <span class="type">MyProcessWindowFunction</span>).print()</span><br><span class="line"></span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">myAggFunction</span> <span class="keyword">extends</span> <span class="title">AggregateFunction</span>[<span class="type">SensorReading</span>, (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Double</span>), out]</span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">createAccumulator</span></span>(): (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Double</span>) = &#123;</span><br><span class="line">      (<span class="string">&quot;&quot;</span>, <span class="type">Double</span>.<span class="type">MinValue</span>, <span class="type">Double</span>.<span class="type">MaxValue</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(in: <span class="type">SensorReading</span>, acc: (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Double</span>)): (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Double</span>) = &#123;</span><br><span class="line">      (in.id, in.temperature.max(acc._2), in.temperature.min(acc._3))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">merge</span></span>(acc: (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Double</span>), acc1: (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Double</span>)): (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Double</span>) = &#123;</span><br><span class="line">      (acc._1, acc._2.max(acc1._2), acc1._3.min(acc._3))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getResult</span></span>(acc: (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Double</span>)): out = &#123;</span><br><span class="line">      out(acc._1, acc._2, acc._3, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¾“å…¥ï¼Œè¾“å‡ºï¼Œkeyï¼Œçª—å£ç±»å‹</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MyProcessWindowFunction</span> <span class="keyword">extends</span> <span class="title">ProcessWindowFunction</span>[out, out, <span class="type">String</span>, <span class="type">TimeWindow</span>] </span>&#123;</span><br><span class="line">    <span class="comment">// å› ä¸ºæ˜¯å¢é‡èšåˆçš„ä¸‹æ¸¸ï¼Œæ‰€ä»¥ä¸€ä¸ªçª—å£ä¹‹ä¼šæœ‰ä¸€æ¡æ•°æ®ï¼Œå³èšåˆå¥½çš„æœ€å¤§æœ€å°å€¼ï¼Œè¿™é‡Œåªè¦é™„åŠ çª—å£ä¿¡æ¯å³å¯ï¼Œiterableåªæœ‰ä¸€æ¡æ•°æ®ï¼Œä¹Ÿä¸ä¼šå ç”¨è¿‡å¤šä»å­˜å‚¨ç©ºé—´</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">process</span></span>(key: <span class="type">String</span>, context: <span class="type">Context</span>, elements: <span class="type">Iterable</span>[out], out: <span class="type">Collector</span>[out]): <span class="type">Unit</span> = &#123;</span><br><span class="line">      <span class="keyword">val</span> head: out = elements.head</span><br><span class="line">      head.startTime = context.window.getStart</span><br><span class="line">      head.endTime = context.window.getEnd</span><br><span class="line">      out.collect(head)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™æ ·å°±å¯ä»¥é€šè¿‡å¢é‡èšåˆå‡å°‘å­˜å‚¨çš„åŒæ—¶ä½¿ç”¨å…¨é‡èšåˆçš„çª—å£ä¿¡æ¯ã€‚</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201221175646429.png" alt="image-20201221175646429"></p><h2 id="å…¶ä»–å¯é€‰API"><a href="#å…¶ä»–å¯é€‰API" class="headerlink" title="å…¶ä»–å¯é€‰API"></a>å…¶ä»–å¯é€‰API</h2><ul><li>trigger() â€”â€” è§¦å‘å™¨ï¼šå®šä¹‰ window ä»€ä¹ˆæ—¶å€™å…³é—­ï¼Œè§¦å‘è®¡ç®—å¹¶è¾“å‡ºç»“æœ</li><li>evitor() â€”â€” ç§»é™¤å™¨ï¼šå®šä¹‰ç§»é™¤æŸäº›æ•°æ®çš„é€»è¾‘</li><li>allowedLateness() â€”â€” å…è®¸å¤„ç†è¿Ÿåˆ°çš„æ•°æ®(æ²¡å¿…è¦ï¼Œçª—å£åˆ°è¾¾ç»“æŸæ—¶é—´æ—¶ç«‹é©¬è®¡ç®—ä¸å…³é—­ï¼Œå…è®¸è¿Ÿåˆ°çš„æ•°æ®æ¯ä¸ªå…ƒç´ è¿›å…¥éƒ½ä¼šå’ŒåŸçª—å£çš„ç»“æœè¿›è¡Œèšåˆ)</li><li>sideOutputLateData() â€”â€” å°†è¿Ÿåˆ°çš„æ•°æ®æ”¾å…¥ä¾§è¾“å‡ºæµï¼ˆå½“è®¾ç½®çš„æœ€å¤§è¿Ÿåˆ°æ—¶é—´ä¹‹åè¿˜æ¥äº†ä¹‹å‰çš„æ•°æ®ï¼Œéœ€è¦æ”¾å…¥ä¾§è¾“å‡ºæµï¼‰ï¼Œä¹±åºã€è¿Ÿåˆ°æ•°æ®å¤„ç†</li><li>getSideOutput() â€”â€” è·å–ä¾§è¾“å‡ºæµ</li></ul><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>èšåˆçš„ä¸¤ç§è®¡ç®—åœºæ™¯ï¼š</p><ol><li>keydStream</li><li>window</li></ol><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20210101172351300.png" alt="image-20210101172351300"></p><h1 id="è½¬è½½"><a href="#è½¬è½½" class="headerlink" title="è½¬è½½"></a>è½¬è½½</h1><p>è½¬è½½ä¸‹çš„æ–‡ç« éƒ½æ˜¯é€šè¿‡äº’è”ç½‘ä¸Šå¤åˆ¶ä¸‹æ¥çš„ï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†èƒ½å¤Ÿæ–¹ä¾¿æŸ¥çœ‹å’Œæ›´å¥½çš„é˜…è¯»ï¼Œä»…æ­¤è€Œå·²ï¼Œè°¢è°¢å„ä½ä½œè€…~~</p><p><a href="https://github.com/confucianzuoyuan/flink-tutorial">https://github.com/confucianzuoyuan/flink-tutorial</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;DataStream-API&quot;&gt;&lt;a href=&quot;#DataStream-API&quot; class=&quot;headerlink&quot; title=&quot;DataStream API&quot;&gt;&lt;/a&gt;DataStream API&lt;/h1&gt;&lt;p&gt;æ‰€æœ‰çš„Flinkç¨‹åºéƒ½æ˜¯ç”±ä¸‰éƒ¨åˆ†ç»„æˆçš„ï¼š S</summary>
      
    
    
    
    <category term="Flink" scheme="https://awslzhang.top/categories/Flink/"/>
    
    
    <category term="Flink" scheme="https://awslzhang.top/tags/Flink/"/>
    
  </entry>
  
  <entry>
    <title>ready!</title>
    <link href="https://awslzhang.top/2020/12/17/ready/"/>
    <id>https://awslzhang.top/2020/12/17/ready/</id>
    <published>2020-12-16T16:02:06.000Z</published>
    <updated>2021-02-02T13:34:19.871Z</updated>
    
    <content type="html"><![CDATA[<div id="hexo-blog-encrypt" data-wpm="æŠ±æ­‰, è¿™ä¸ªå¯†ç çœ‹ç€ä¸å¤ªå¯¹, è¯·å†è¯•è¯•." data-whm="æŠ±æ­‰, è¿™ä¸ªæ–‡ç« ä¸èƒ½è¢«æ ¡éªŒ, ä¸è¿‡æ‚¨è¿˜æ˜¯èƒ½çœ‹çœ‹è§£å¯†åçš„å†…å®¹.">  <div class="hbe-input-container">  <input type="password" id="hbePass" placeholder="" />    <label for="hbePass">æ‚¨å¥½, è¿™é‡Œéœ€è¦å¯†ç .</label>    <div class="bottom-line"></div>  </div>  <script id="hbeData" type="hbeData" data-hmacdigest="815adfd345959e78f0562958a0356ed20e2a8ecde8fe80239c5fc77e8f2200f5">2ef123d636f2f21a7a6ecf818bf73b0168cc121ba75be9c227f6b4e8abc84136359f52f4b010ff4fbcfc0a9c90fe4aef6ec00e82c3925cbeb7eeaf95dea8f8723d8e2d09fe263e8ae76b17b7b3517368c8df60ea512ce0203d75e6a039531cdfb2ba4b21b95228454f1a752814f6c7f0366f8e461672a904c93679aab1c823ceb195aa2a1f6b9b5b7ab94959474b97d45c58066419e5ffc372e4231b1c6edf10dbc2b37d6301776f90f5f7cd64cc3b828c03eb820b26153ff70884091a23f842fed110ea12e0f8fd831127466f165fe7f8812e9999d8ed1c6d000b48e1d74bef428f86a06c51ab24b09302fc9ebea6c668ea6b264b2eeb782bd05f40301014a280cd551e912b009d012d42973f6d1bdf04e181233a05aec24855f680174486a7ce54146afd89afa7ce5389db9b65916d8a3c3d888fe18552a24c3bd4a6e4c7713b7933bd8afbaa9c7a53fc427fd2e97c2cd5d60227bf9eea0c0d90922e3ba341d7fee22c0595ce095e85bd3f9cd25690c93ae509eed55cb59b1f4b3c3838eb1f9e5783c3355f6a63a4b808e803c5f1d391dee02d10efd4b4f2f5f78fab5d50b7c38b5d14a08dd9ed779680b5a2518b0b5f12dfa40ccab36f3bd0d420203d0b906a0b48c7c537c9632e115356191568a7c34ccd79e3eb53f9ef54f653e64fcf3690b0884178d464c080cf4d611cd635a4d8b5b1fac2410fa5a695c00ea309b72cf401cb35bbb37a3e6363517f934377f12c54d81e19d693197002837e0f9355e6a082dfe1854e339487d667157cddb837ad44d8528b277b365707238c45201e6f5dfa42db1bcadacbb17df5d5371333952bb898cc51057ef9272eb890490ade1d6598b8ab6fa9aff61cc21f52e105ced6066f4ea0bededdfa5c1e34bed766d6ce2a21b74c15607c42297b14ba2a6b448ca4b73c81d4b67c349322293b6fbfb9932ce65c375572179be7267ccddf9c1bfa00a46e9149e6eed38fbdf8af9edaf4a022d9f997c66db2b9b71c2982c25fc5c5227001dbbf1e2929c02d11ba1f9c5554e6be037570c337bd113748233921a0fb4a3787dce5793241f2562c2c1ee97dffd233e16f10b26318f2cb24f44c8ff4fdd8f64424801dbe7347f71ea48f86e72240b2cce4615f64a47833efa3f10f1d8231e0bc0817b9cc38d9969c5db1840c800287cfa743e9fc71d294fc5739b6ebac7ddec23b6a307b76e2bbb902449c59faef59b6d5305ab42bfd94e9c8a1c5c456e8d7c1b8b238fcfc0be576a10563d4488ae0d6b9a8c3d94575065c1e15c90208ae91fd0fa43923e6ea35b5126e0e1d43f09d0ea03b90a9634f51dde9efbf2fcc0241e93bdb4d4d1b4ed07c32e706c5ba5d23c731709368eb4c1f28b28b5905d69d41cd022a069c24c884d0bebe6fe5a283163da90cdc5ecab9e830329c5d2a9b23aa251bffb327179acea4039ecad345bb031feddb6f38dd86e74cae0eed87fc93eadd8c3d0eb288b7c347af72ba69772f8238e9b758e7d29f10bac044d3f15c3b9ba01e9712485b7ff118e2956b311ac82a26cae2b82df250b35e8d0c01bdf8768bd19b06d4ede261656a2f048d82a8d434d9791cd38cdf5fed53acc1ad410d13408a3ad1b0f0281f179ac5343ea5a6cdf7506ea7aac96cc26b4cd1a8a7eb79161937108a05af52b3a151acbb9d6430f0e607717e104b99b4f183402f9bbed575281b8413f06e02e36e11114a1399a0653b34ab1d34d33b5b6e8ef4ff37aa49f1bfb0b1fe0ebd6f7fadc8151c6e59eb33998c13eb3ce545d851272edc59a2757551735099f9911f829620771d9c99944dab057c8981a03c014553b59108974c15fe863804fe70d27f606aee4f9ede1e86bffcce7cae062babb85309519e871d7fcec7cc0ab4d8bc034673f9a70c55d61df7a2183d7facdf8d429236cde25d0d9976dcb577b19688c8232e47ef8e86b96c529d8657afead0aa5e6673ba90710fbab25ca9400e0adf2c224341a582aa771e48209d41153007fdcecd7d839d02b1a8b73faf4ce1c1ecd9f82099c635d7183a33b48b4ae4e663cf6a015baebaf3051ff5574cded2c2886074bdb7cb7a4f6bd7f10bad9e0e27bf538f790f10770332890096bfb037769a826c60eab4b1b1e6c85caca824c25246419ba73c19ee1c1dd7343cb2dedb2cb94a23bb606209a248236532781fdda2b2224b60bc2f9a43eaa0a8517dcdb9034e5d577d5c4a4b95c3eda9d60663011bd3b192fd53db21775c3a184a3a773c7749bd68ad00bce9e43ab82513812775cf49a624baf1eef09bf9776c8da739bdde5e237af37e2710c3e4664aef8e84501ef2b86915c03791fccc909084e417c03d870fdb9c7b07047e5ca6cfa24f1385eb86325cfae446b5eb074e19dd9c23b8856cdd485755baf1cede7c925672eed4a35c2a230ff9d27aad94cf786e6e29e8dd48aa41cdc690c0ef208b2187db19bb3254ffd5cf005eacae2c0cfcca3f3eedc37088e3c93ef68fb9b59813a8f6e34b3e8263df5e90849f43a4c84e75fddcc9cab991b93b1109c74d1f4b82ed332b96016123a299a4ff0cf7fd4042bf85e9a746dd037831d19c65b9cb20f02a47db34442eb59fec8844e324c99299af3b3883c0eb1771cf382a98b12f70e39f7a325810b272543e647fe32389d76cc3d110db7211a4e96898d7c825d6c107cdf77922ed70b292c04f643173bfd15d213adcd89f0d2303110add7e796d6345e77ef240e3e043104efcfa15129b77466c59caa77997cce4c5944c387fa2c127e7905509a030f979e1e8ca5992722a7cf6d7b44cef5e5f81fa12e194ad4df7ca3d14a7b65cefae1703f541168db9875c2e7c40aa6c02de2c4197f1a1f9d69b3faeb3a83a195c29dcb6ff95ee3c999c55322c3bc2887762063bdb26045653565ca7a73b55e9a74e18431fa601ab8a75a953b0a201ec8747828e1ea8f7da7023798ea62197611ae425a9479f2a080340f13a89b5f3d438eec1156793321895ef109b0d34856e4a6b1bf0596183f49221b4e85504fd1565d7e2fabfda060f1a9615b28f2e01a0542e4852d393bbb6f4bfc66feb8fc512f19301e76efee607c17de1d4c0d5eaf37d035031564486b39a186b9001643805969ca416823cc1c6bf2235b338a6b2822d4901fe77ff75457914a2a116f3f1aa5d72d8333598621ac211c5192cee1e716c3a18e5d8ef823e5f838fdeef403226496c34451fc12b995878957a237201067492733fd74915a4ecfb6a7560022d41745a128f90902df74adcfb1c1e4bbbebb3442f06aeffe1852c80c7436f6fc99cb4aa780eaeaf1dbb77e2dac638e9ae0269e3681a6d0648d8e24ad1c41d2ce1d8ee669fc9283c4530948909964b4f0ffb7c79bd1821b9b0a2e441aed4597d4fc69f11c29509f85417673920069e29d459d28b50a74574de18117a793af62ec35e9e07ef82f8383a7d7b6cb05df55c8b3c73e08ffbaa10dddd35b5f00281be5f1c24d465089620b64ff0ca21e1209d401df0d22e40332a74a93e6c6cbc7dbc5f725716b9b3d3d42531acf99781766ab4d473cbaabbfe264c541f972a382de9a81b0e1630f07731b427d7ebc2169ca571ab60f36fc4e8f8fd9a14382aad1d0d288c3634e3bc4c7bf6c1dc8e07ad51a277fdf7a268e9688629ea0df63e493fd2d775b974e3e0ce84ab5f982520ded267e6618d1219ccc6adb249cf501aa475de22a945e63b6432490cd5ff4fd8022ae768c960d6934c293eea45df27f81503fa1ff21aae5198ddc5ef2d64799392714e3687a70c85ca9c2023b2218d4439104fcd9c4fc52a3867e2f86623549e0708b868ea5bc38cad17fc7812cfe5f997de03a3d9bcc531872359f9bce50ef1761fa4d6ab216b364271e9db07d744951fb63ff4f629dfded4d8d65938d96dbad3d079ecac0deb0287357d964cfee6d0013df2df26fa90c8c6719876e6b2eedb0427b087f39d0d793790ca3871a029d9ce31bba7126cbff4f7198de772f8c151256d6d7ef66e11cb404e9cb46d4dc3068be4574995145eba5b9e327ccabeccc14ee5c1b11cb5910d77a11d4f351b7cefec22b2a0b3d150af23d49b65b6c2a0ee4ce026281f2a3e902bef98ecba9ca901762f140bf8316b256e0ea12137a670e0461bab6adb5319c717ce453724cb7250a63089568e6f10e7cb46e13abfce7eb8c6b246081f81688e53cde5ecb6ef4c458bf1c0abe22cbed560bc8396243d8ceff199cd2eab51e6546985ee94caf189e8a9b9c5838ce49193aad579fbfe9a0d675ef24b48bba852a63e143ad044296833fa53564820c20e6be25ee494cba767c110288b894eeb42052bb63e81601e853a7f954f0d742cf24c2ea22d7e51f135286740cfd17a026ff9d8ac874f161b7410092947e88819dde8c874384f43a4b2a6dddf9d216d995ae94ad5290ca5c1e7789c50c0f3e7915f87638e860d2aa9e2c65e4d2acff25fa6696dda498379c635cc00630860e3b3206deee2a9644a8078afb47c30b528b0c210d46ea26f3b3e68c52613247dbb3d87426a4d907ba4c6bc8500ab5ba3eed528d9b42c01a65e2e82b0a3515c022e7c250d356f7be726433c05c1c5b1468b43f2f9e11b5f0f0b6e21262327fbcb0f5974f7bb7be4fd9d55525d0ab6cb19655e9944c323ead89661c2140f0f47732b9ed10177c1ee864fc761369f6cf3541de50a41cd612b961227ad1ad2815974e6f63633cc12fee6e4c443f18f3f63451aee72f31dcbcd3559e3026350f7b957d35a2ac61f14ed7ad5d42bdc8f502ee9877ae61f70a26ad06c0c3c73e9de427af5e2489f400af8ba1bf6c3a0ba9beb9f0d60c61b5725dcb919a28d6ee3229befe1bb264ecb49e329ac06205324f9b28e76d148ff3504bc5a29e0f1be7be3231cf0b63e8bc197a74897d5d7c988f361cf65f2b50383b2bbd5e45555ef574d45d99fa513d11b3f62856d21f207d41da0b5286bb3d7a8c3653ba48a9092e098c74e99e2bcda612506367ad001b8fa4886a3d74f9f7e3478de0fa6d7713fc858dd5823a1f108ac37b506d4b28ab0c2332b201725bc0adfeaf0194826d5845fd99103be6f65ca18ef3caedea6b8fdbbe553f6c08a60c06da1e4d1033a264b3d5c75ebecac6b1931276104896f0ff59abf8ce62be8df623fcc999d6dfefe3921b8366aa006f47ea03fd3ca48fa6f214af218fb2886e314c596671ee94828a503ccf97a8316ca517f9d17bc766d0f159be5217bd4bd9b8925824075a9b9be7e3dcb799489c307156eb4c840d4f8a0a78a2ed84bc956ce6320c2c0a55cad922754d9df67505bfbbaa3006b9b4cd41aed021f197b803e9ba577150f30fb11df426503f08b87db7bd3852b5a5589af75d1bad21b538d2ec1df6d2b3f19a2f663ba23463b674dc2f5d1bbf9ff30683d27b844ece1a87eaa725779f0c480824c74bf11000095e45ac6c0fdacdf74d2827d609b1a9e98a2d8bf9df0c5c53a275d968bb11c90563befb859fe87a988cbb88add48cf788cdb610f7876c05403aa0adb461a8f665fb3488546390721447743db18bc924144ab3d9e6be5f5252df74c51246ac7642d2aad3d7ff40ca1118ac4eac8ce31c73b157c84b298289e1886ff892de4185021af5556046161a1c3daafd4e2b94b4e87c240cab1f5883d7e82bf3a769a518ee764a154d85a0dbdcbca957105578a6c8af942e357b03d3d0b0ff1e9b9c8093601c2d9ba9222e475c34b75bdd98ba212e6b0a460cce11365ccb451b9d8c2072e513432cd32656e1575aac6e7bc6872d79aa14f1891cc778cc8ddecd34a2112241c50bb150e0221a20ca2da1eb58c8d0679ba79e5561fdb46a8c3bf656a14a8d2e470907ced2e113f2b53f53292e31a3387898db4472eb712d913d7c882f9ac259c728bef70c259e1c368428c51625bcb32189f2b4018d24a6884f12c2b396dc07861c54b4f1ec7881e2d1b8ce11ede04195df0e71c7ee5ba7aee0cf9238cd9040dd58ad64b056033628c3074f4bc456516f3cbda92bb28ca83b3f2dc0c8be4f7ab32792ebd47802725a8f9614481f2291e37ed220dd8447886c5b2eb0e1e17182f0e289d84c067a11325a8879ad8b76c9d13f197c202a4a83bf2b27a921865063ecaedfe80fc1f04d23821d60e45584efc37e79dac68d5ef4869179e0248a2511a9dfdbe42e979f2c2d2beb7ebed936ff002e0e58dd0cf873806409a7945a7883d5abbac74cac5551c2c822293579bac5145f343bb658432d3171975b20ce8a9c19c906550616cdc64ee0bfd72d18f05446e4e405d2796b47fe768dfef2740fb986c820543750dbd18998b2e9edb1c5763e3b376818e900b01bca4248796a9795aece8ed3b6eb61110ab5b2d4bd34ca701f3772a64369afa8a70b2f71d861879073f0986ba712915fe313e0fee060805274a792fa7d21350b20f67e2570643c605c487105f6dc9eae0b95df2529d56edfc74642bea88d65c43bd20c4c9e0ee40fca1fc4ce71a942cace82396805eb71e4ed73d0045a0f4afd8095fe9680dd75960ca443b3fd772c7ddae97c9385b48f0397a66284892747d1105e0e3dea8919f57701a1511d6c361492790a62a0f539a02c9d94fa4fe1c50d35e143e949d3b235143ebafe01633161927eb071d9751a674a78bf494a67e43eb9194a804f325359563ed976ccd828ad19923c95ef00ddbf15a468a2cd70a712f7d0da41e23fc8372e23a72c4175c457b05dfd3ef9142eb3dcf4a30010ed30d594eb7fbfe5c59c55d52364c34d07d299a3e136d9cc1f3f0f06a79371fce9015531393e200adb2fac2a3b15121104e18e411b185b6724fa3014422b86bc9b4bd3eb79ecd887d435e3b5fd200f05f956c6139a32c0037dd62a1335f713c220a31436baaaedc882dc6b3e236eb7f7ea85642aeec60730992ea45dbed33f8867cd60563d5f068058014318af1d1abbfe4d0cd86f402ddb26c74c2ba66a409971efd9f32b40e2a9fff02394f94a8cf4e8485353f9409f5452b8c9efbee45cc54f49a5134ffcb7023121d3adf5845ca5b38b8b849984fdde2c5e25315b4e78ad64c2b7654310b7b121a2512f54c516850a299ed7c9419cffb3d9b7b33731dfe01bd12a80656e001e6918333939264f1991997ad4edcfb7bc6edd3dc9255ca0f63f39258262974d965907263c5488fe8d978d4b004c587dc235e9c16bbdf5b6acf5b300898c2b4e3ee926633373edfd88e1f92f4a9e1d944329aec85fbd70efc473100bf143b68c526cef16547ace9a62fb8d8b874477987df91344fba66592de7b37df7d1cd629becab088d244e923baffa3c9c2fc1666ea88651d71aee5d11b4c1d5946aeefd591df49daeb13514fdb76ec2fe8d2da9f72823fe0b91e533a01dd669b21d104cab24f6c3f271da835e59dabd4fd80def0668a4c5c1677f48ebca2753ab41976e8595b1384f14310063a4166f89d896488494544d76e065d560fe1ab8cccec432e8bede8c1d511e4a991093beb8fbc404f0cd22eaf43d0bf24cf71b31d29e0b6179f285367c890dfb1aac39508a4df29e80b6453ec5ef8b414fe2109b7c7c1786f6fba568747c03ca52d2cc9386d89d2b7c3eb37d87c9842e7ba2007f425293d7c1c05d6df75e7d513565270ad27b47d303f312c959a7326aeb53b74e0ca13bf48613519eb1eb7118dfcae1ce0535a98b6a20328886c33632922aacc738ced34616307cdff279eb5599aa2c99549035d832b3e9083e31417c07dbbbcbecc0545a42e45b7365cb692c132e9d886fa42381d14777776f2dfd91885fdc4d792b53a46ce21881ef544628eea2550f76fbafc1a10eb81fbda309669c9d4048a6e7b098edf50ba571c07acb1e604c6174f286f2091c811306cf12b4ed9b580fdc2e201c2901f4bf7d8da7d3ec40273957d1b05e8aa98d192cd6cdb16b0c72029875babe347e1f954c93db35dc02d76daf580e6294c048a1e8d49729153fc8f334339acf85f8b313a18273d849284d2be61546a1de7b2a548bca3cd8f3bedd9c75c0b04dd1f8c289fbb96937c7b65bba9513dd2521939a104e6ac48b15044ea263a9efbaf19ffafb165b5e68b87826a013e18724c9c9e3deac264dbef6f75fca43414e205dbd1ddfa6a495775d5e6aaeca0250860ac86d6de724ffb9a98fb313b7b15638e7dd7f242edf18116811ecfb82a28a1f8b93c33edbedcd3591ed9e2738e7c3c2c01e8f3362819eb0d54cfb44c438bbd40e8f91d8b18c12e442fccccad46cc0cfd5af349cd2c625aac0345ce16ef8d907ef534fe46af1c1a58541cd510ef242dc08433214d349cf41f927daa16aae8f06d98f1102534edc160ff7068aca03c361eb33c4f1bc335b8994db6c3a4cbcf2dd29664f08fb3cc1d4447886de738d0dfd1edae50e705f01c0a260e9a64327f5ee2179c69c239a497cdec2f359e0dcc28e896d6e9408a60179164a7c155fa792774fe85db6646e73dadfae2d6cb7f7a2725bd68d5902f0a67ac4d8f2e01e22d3d9a4474a802960ff1a6d6189864c3f8945a302714d59b675be92133d5c14e6be9449c674dee9033598644715bb6c6bae2b1418bb0776b320963efee60e171260bef25bfb873739c1673d57d542d4d737b2e89e83eaf156b83b95fb1f1eeec1d4e4d538ef07e45beca95809c882a1b78f49cce3c48a0599d91b2373b57cad9209797f0f74ca35a1f3333a76efbfaa455a3d5f8210ae539add026887dd8455a2ccc8369306becace333ee818302918ca94547113232e000114d25dfd7abaaa768a3b49fa5a65e5fbf80059928f36b280b1f100d4951e027dd684279d6b9039f7679fbbaacae3c4cec5e4222a4952df1ef86e8d7e81766fb0ba7b931a9739021a468b9457f6efcd95d856904b1c8cd58db4ee2d9fe1bfcbe5f2fd2c29bb9e367d4885b809e3bc954e24208e91c9b1c20a687da4c92b57921b3907b7274686c39579060f285a3c534b85fd22c3a296810678a8a4c237416bd98e093a6b203cff1b21d7a139bedb380de1ffa1e219e6e1d57cac24578a36c801fe4c7706199ebc8af8a6fc54b04d93700715a5728925f0d5817c9f3672db8307d4412f649908aa912a488eaba74f0df9f2bd9a77480bf42cf9a2cd409197f7a136a2564f0b6c521e5a2080b7274d5a5015a0853aec50c02d2c473d762054ccb8e7d2634ca6732c9f9b5f000078d0fd4a1331e740a74dcbd1e046947d98be10498e0bf88e063e7829f49086e12a4c810d338102282f05771962b9e29d62164e4d4408c0695a9c810454dbbd2d800b2010beb533cd0b8471695349d9c976d2e5113fc9a008dfda4ed795211fbc52b1e7e5899a9dd02fe2567d0a49441a17cf9a31010b61da9ef338db2f4619faca776336459300aabfaa3ac929531cb154e92267635ef5a95ca24a126d526067695dc5a73091ed747bc78c295b69e3456fe17516486607f57dde39d9b703f4c1ba72f78b7f017369475a74bcc76f7486fbf90597530c59fc10b84bf0d77750e711559b9f48a966ad535aaa5dc5c5dd6d3c386c4b338564032421dd82610a5090c742e6b11dcf3ad3167f433bdbaaaf303d4a21a51795ca67230f19d647ea249ee57fb5be96525db8288061d0a1a79af8db8eb8610fcaee7ce07317494b18e5caf154050a1c08cd0d615af0c177cefafc1d54932876a439afb901fcba3f9aa530229c507cf9da1ebc98b9fd79a74101ee7d7e903dc07453e715acf3ea7f1d47db6b3599149292b0965b494076ce008badbf0f278cd1efcd193a1dd5b3e1b0071271671d6299e82a68dac44453697e6ea4b658355a305f2f3f07b3fed9d1e4f6a9a5c96c67e947a537958ff786a6f2014bff935b7a2d21d961bbd8991d1b921cc133b26149e4e8ae10353d7dd7a3173dd73a36a925b1962b8a49077e682feb7dfadd72da7988d02b2d7d0bc75a3de3e7c5149d98567589d1a63bf3c79f0a10e10672d1090cf4a0069cc96da41602dbcf3d00bfa7dca39395baaca27749c2122d1a0d75094d4d719b7bf04f3e7d597aae4f0ec177e2d6be8af9998f10914c21e5f5a1ffc91711405f8478b30e0d4e986757092fcaca6402c4b0a6534b153371f20cead5428cabe72dad9809e8a8532fafc33a6d456a063517a438deca00b75159b586c64f1e4b7cafc1be40637bb67eab6bfdc9945dbf5a12de7567bdd932f48fdf6c677ba708b9a443a944af5d1c805b7e457ac2e75ee20eb730c51bac437b0319c4b2cae65c222e00e4a02704674d9be66bfd072edf9fe34e3c391a59825a845e434ff9518702fc4d496eec13d5773bf55f0937ad99a516d9b02463cc8580be62278edd143cbcc6a36eb24e8b1434d27e6e955b714fa26ef43e0da983a0a34a00a7dd6cec19fa567b34b1546b75285eb07902cefd9b5d7fe735ef1e2a1830ab239dd36d73c431a12aed7f5616e6f0518340f568a55da53e65f19cf8d8ba330424d5b6d77e04a6fad3e5ac87655f9bfa937a50054018a25ef6fba2326ad236aa9352fc4153397f0cb131ef0552adddfa8319e92124cda1e4a13c408e6bebaad93a701d960c99cf07efffc8d76a8f20ed10372b6515ee0ab9a804cd890feb9fb02203668f0e6b87dc222f49bb0e36863623a04d358641a79ea971dca0a79f2f1c1a14d2cc48f7e2a22f6cb84b8d225de563344ec37ac2307414ce71091844afae6c3f31aaca9b06564ccbf83d520bb1e08903e634de04526f877e2ee5c69c3b46d239bf1e5edb2e1a853a65ef6417ed990a9b2b3e1490124ce6f25508e348450bcd1e4c39f7cb3c64054d99fcc80b3901156eb506e2ceaf42509a5cf20342c3c552ff394c510a08084d276552ad450da6752709f74144e208bb3082750e0bc795965c02a85185292aa07d9603c7b99be5d7f1ff9b8e450a55bc3a8622de9230020d0041cebe620baa63d82ab0e767080f04ebcc711461a2d14ea964efd6c6d0d7addd4cb6510e08012030bab740bf447d90a1a4103164d56525f6a3d5b8d313d0d1d3c8cffd18354c1cff1efc051ad65f57cb6cf7a60da99b67c6bde2243cbc8c841ba03ceb19e20eb9f2014320d72dd5fd1714e06b1ef873815b768ba0ef174199c316065c4b22eca847e781541d60265fca7f906d37ef13369abf249383efa8971b2cf3f98d6a74b0722674c8e705f88af7536cd5bfbe3d0d0fccf1bc032db131724d26342e922877853adad552c6977f0a5116fecde7b7aa5c95669eef1e1641f233c2571de1d3c24a737f36771c0323e191a3e95939822b23aa678273eb91fee725acbbe666bce81ca96cdca634b59b58f9c08beb958253e807ca378c9816cd798f3c3ad92ddb66aebd1c8483ed8b31da0e8df489190ab6a85380063e652a7a37eff49f88195a24544cd28fcc9e97d7c186642afb511bf57e341dd44c7a2d3c987e55687e6d825d9acaacca589f2946a168d8c0ae447f583074dfccccc34ecd2794082b3cb64549d1e7a4ac93e10d98d53fff5aaba168a49b281e45449f19f1bc7d60913fa996ce6a8a106d1ea48977a37dd53c65ddfe688177b9493f94fffeacd211a7c04c5c7cc564be46ae46ec0fa4160d630aa1eff67a4957c0e7881bd46f5009141148488a66f93a5c4fd7aafffa4eb657d4f52f4c6bf08df2a4178fc154eb2a3ffe2048515f075f0963fe96aec0e991491e7e71024694caa9406068a948b0e57ffe187d80860c96bb407134a9fc37c6e8b198334fefbe71c23d5bbee648d3a2bcde34eaeb0655ca5919207e1847e2a41e24c762452bee7f422ae7a1970374a259897bed236fe917f6bb20b6dd7fb766a4248dd94049845528015b93db888a81d2d6afa7145e3de6640d2214a4c59ef899c677fa6a9b93e50eadb941518fb166c9837bb31549e672cdd79b77caab99b3791174a6fa1311c21f3c549a7e2fe84ea55cb3b4525b11bdb634927b31615b34c26c60f9dc8006ccd530519eeb1987d6ac9031e712e3020f501127cfafcd0461f9759297e6fdd85bc584f85014676f55f5ff57148ad61d73ac2f3660d232dbb8f084026521b165538c43cc22a842903ec8aefa19e7c1452b66e774228c2b158358bfb55ea795a852c17f2fd94c62b7799807c526c9430f36bfe642a91cb345569ad0f9845a089bf221d45bce7e59282586f921f6453ade5cf8f6ed91ad6ffb9db8bb218f58b621ada92391041237064414bc7847f921582fb263e45ec9e7b966ce846e2493161fe7656ab14865a5e388db6cad8d8923c53409926232469a37d7f3b4b0517dcd1edc6acd648de1c7629c1681e2892e98299c7a927a2a275e7acd687584dbd0a0f2f709d62e3abb93c460b548f281c714c4eba1901619d2aa85739a6ea8460231a1c2ffc31e52b4a42ee10eadc978929b8110b2750209a9a010eb078ed87459069ad673c78e0951394c55de42cac50cbf27cc1f2b7ca7d494d5abbf85cec355bfa7fdd8ee979b09c626552e64df0befe8951217d3a8d448869d5421ff1bd902ffb88d041120c95acc60ca4fb57738c37922cad9f979182e3523d5e3365e172b8fa0f59d2604d41d547fb57f2b93a9151c9543680c0f54b08374b57d62d6e0e6d978ffb011abb470f6c746fb14c5e13a18549c34e6a3269b1585a5afe73ce3f28609408f47bff4a4b96d040fcd0e4ed684506f72f7da26f82ef4b24387a85eb20f2af7311a51ba3c9680d0795fb3b29c932f6c7fc5ddbb05c07e61be14210abde59e7d6e6a92e5f5141bb97dcec857d69af69caa91bb9a7f7ca87084b97e87af13b78070922ed6a2839cb43251889301dbfe7658302dd247b30aa9ee597d858afebc65be1275b24bfdd8f1e464dc7c3562e4384a3d38ac5cc70105204d6caf81352adfae91540e05b5f9d4738d3cc979c380b032af4aaf72918dd8dd018a2ebd9d7c22be4dc6321e93a9ab3e2beb57cc9e25e20833b911c22334d3201692c9fc157e280c0f22201dc95dce2eb0ca470995fb760421db37a840f756b79d50f043946d299d02b7252889d2e5baa37cd61afd93d316222d8ede7f3c3bc14dc2e80cd414f736b4d4511c0db4944fb9942ab0560dc202e17d84dc8d400f1ed6ae2426e14ba2dfdaed63e31e09f24a068ce71ce384a38fa65c0d79ecca67a26080e86f6725446956c84e9bbba336fcf2aa7530f4f2af1fd85b778dd21ed835c67b4aad6d2a84ef669f5971f026749b53e2ba39c05cc6c8c5bdfc2463491f957285a7b55cde0871339bb8df1ef4d63d8cf41811f8bf79df000158173490caa2d6a7e4dd47788f23260b9cd41794114b4584d504e33cc63ede576667717397aa96cf20e1bb86d630c3712fd85177aecdc3f4b9ad84946b52e441a2014448999a126adba3d5257d6ddcfd9bf1c31f3f3551f2fddefafd49ee828b3fe46a2b533287eb589cb0541c4b7ff80f0f5b3884a5c53da2563abd20ba4ff7fefecf237544daea64af75954a7ddd224dd5723ff86e5deed44796395a2004c5b585964527c72f733c939efc06a13d041f5d1e30f0c360090fa191d9a7e28dfcad2c84eba4fadcc7d41efb82b5715b6d6848856642965f7fe972ea15bb6de3c460dc646024f5944476711a97ebb3d4819301977aceae8eefe646a7fb613e51c3cd9e2fc703e3a599ae4f02e0e0e6838508780454b45f4e756718a8c16a963d0cd0cec2cad32bd8548be8a41d87c241ed353ff6307443ec64e4f66197a774897ed780877125646c2aa8c7cd02b26e13743a5b5902c3eab92a56c029e936d3662e1dd7584cce94a127284f5549ea8cd60867dab301c4c39bcbe60a323e8b138c67f05c6692a064e4bf1e8ad9d8ef19c84c0538a49c8e3ee252d2cca2e5930ec4b2c251427748e49cc58d09e55583c87517493e00f8186b34302e1e1be0d3c4bd179d0e858f1e49132da06c7f34f1a25c00e6811c59dfaf0bad8e6f146169e6ef39867f728bd584a6563fe5e6237ea936b3eed437a1b06adad9ea6e9bf2289ced46ed79cb32943cb0b380c258fcbe3b10915222dd6be0839c3f0525eade5d732bd03008d4a46acb197f45d2afe9b0fdc5031ddadb1cfa2afd434f445d88f45aa06bb6e70c292946e3ee4bb2ffd374c65a605229516ecf180da1e447bab58615397f7bc0eb4e7034268520d5036a74a800db249f02b28c2166b6697443a5c8c9a012f545c225266cf704e51ae7fe370d8404a36e5cd087f99e7a772cbfd0d26b2ebc134bedca1d98bcad41db67092125665209abc530b2af5659f253328bb211650abad4eaaf9115c3f7bca463a5244f4cbba7518bc91cd7f8d0dfa24318520ad88eb73e5017a268dce3713bebb7301c60cfd003dcc06e110eb6ebb6ccd6ca70bc99b026e1462d41f700d78feaaa5e5174639dd2bbd73add2ec8206620a79e003ac1fe619b23989ab4eab94343d70d30bee8d5bc7ab76d08d46206d24bc990789a4eedd00e0f7a4b3733a25d95f85724476f5c87dd0c5a89e1a10e37d5fc11d8c7016d714fc01b8a314739494aeb9f18fc35647e417f7e998dd326775340dc70711b1bba51a6a36e2b643bae85a045940055d0e6867deb2c6e0ef6d118b92a30b89eedb2f1f7d36622ce037bb032d96a6dcfa8463f671bf7624db6ad10d59dcf630a5bd87c65e4598bb79982ca69fc80a219419eb13cdfc7313049b6e96c710c04cad1aaa66712d6d71ff2fb4c1b9ab88ad6e477a76afc28e03a203d7bd490abb98dc0e3d07ce2013337b967ed1e70d170d182e2a859fd4a6a3e6c85c35c63c24c9d8dae872f3aaf0d721fc36316896516b553bd995dd430dd5f6a9883d9bef57dd5d0f5da6d48caa0216f64193ec01d1fcd4117bc4fad50c3f52f4877d4374cc3d677187b5f1747c72606dddee980e1a0d44ae1924f1a6c6488237a8ef0dda3a1e571b5ad82176382fcc5a4f00758421f151603cc47355ae68d6938110d8cd228f6b9bbc3abc4cde65775cdfdc0ce197bcba33cfb7a49dfb24890f292b13d6274aaa6df87db88ada9925139cdff766fd07f5ef429977bf3e7515039b29ad6c360174d82997c7d8e66df9c15cf07daaee6494878d7073e178685fa91c0b0a4ab2e9d606863c67abcdcfe19ebd4241b677cee13fa795a0a72ef0d9b1d616e330c606d708b62e8fb381d88524832c1f45c0842c5e7b42026bdd0ea9b0ad2d6b76b80274097b46394fc41c6f989ee20372f09029cc1d7866e1b57a98127cb420e69c3b5fe4ea99259bc9e12f350937e8ac679aff2fdce1775f2fc9509dbba7562c07766153633e4b6ad24b08ffbda48c3944a2494064a161d847aefb7f8f872205680643359fcc35dbda5fe85884b4ded0650224a504bb2164cdd370c65e4049d981651816e7ba801482adfaafb150797c2ae4d9417a78ad2db39df7f84dae0c91d545f9c936818dcc1241c9fca3bd8fddcaefaab4527e5aa356395ec2ac56079779df3aa8c722c54503ade46105606182326efc25e080236480065d03559a1257e034b2048c65da77ac4bd3b4cf6fa93818f232f883cd602896ea9a19e7d4eb90804acfe85f9dd4bec2f84071229927fd102c312fe41b49aaacf67c67de5542e5fbdb09bca5accde035daf782bb42fefeff877a24507a2cdfbfade7405ba31a814b60833ddfac14b5347512163f192099cf8691dcf5b396956d2ca1d787e9a4cfafd5ff8b36c5959fe68afbb2e0913f2a9c5bc73d7b1a47dd56476adb5ec37659a7d87659d5e3a46c0f19370599627bd140c080830d57181bd260f464556d9bc2ead6c0b1537f485ffd74c76639466d4b7506bda8a75b933d2c5195d85cfdcda8a00548f03e864fe8d011c60612a39d5f2439d63f29049ada43e739760ab7d14607fca36c95b0b5526758339144446ac40c9d463af70b4676a9d48e89b9c138b7e9df34076d6d89b7f066589bedf70d65bc1d8cb9637ebda3b6a411d5170797e89d4ca0c797592e8ec486b1e12d3f1756146118d13b0e8d464d4fba93b0efdb21294ae73517c2f2da2eb4b9a3958ebef2f8969d4c79641c6f09bc97ae5462bda7641a0238ff284a4199fc02a74fa3f0cdc63c429326cdc88addf0e1ec2d69ac4dd6fd6d1213e44647151566333d65d5c53519588cae1ef49a73cf5c963d7f236259af3fc8af374abefdb6f311260e2c1f8cb27e2af9aed04ac4a7650e9c65421ed0a1aa637ee1a0328ecc4973b0c49bb7f74680df7d0fd90a8a52be9510d88309ea9993cc2aa7409abf04ad774770b462b1546a7227c998d47aadcc22c561f2f596ba4fb44347bc3d1274e2a6b9c35b91180472cacad3c3b59ca0478b7c08b8b261d61d13808dddf58b94515d89e2f7cdd5bc2f6151e7c89bfb26b029e0927bc2962182924de7635a7d14766c44ccff06854e165a433568e6b68bbf3226b54f67e66079380e7f1b40b3036bcb88f97bbdd208bbd2fb82d1852ca37f79219d2c1e65efae394910a25c2604f07021cb9923af3120c4fc74d6d5eec66a41258fbdb34d67250f69d463bb77ea56e5953f82b74d2291d016075e999775cc048357beacf14df25bd66732ccf6968f43f0480387b4ad9b699675c757a68467045f0b1cfa10dc0aed0a23fd1c5ead4f60632afe7f1c6e0dd370208e78ab3101800d99e09a46df96a61cc882d86423253a4da646a39da6182db380546ec4a09065772689c6e7e786289e2bda26e420d3ca972b9e0ae33c2adb1e9360e1f05f57dab18895f1c190eb49165d09d2b7aa741357d29c38dc65c77ad22629e9aa13c86263dcf5fefabb376b8a62a6bd9dea8c2866d8b7e23796c6bf57a92dce2ddd27934ef52c2eb859639e119f31d5832aa5ec1212648b3111714b735d786271f82d7828008657042246ba2fd83f84c349846a290c3feb840157ab667f419a0fdadf1169bd5243a51b00cf4462575baa9af3b7e7d9652204fe48806b8c82b396bcf34ddd2858b51ba9bc24796cebe6d0bbdddbd475d8d95dae190faf4829d089393ced691d7ea9ea28a862eb740691728d7a6df45d7f820301fc6403a5dfadab60b92a63d3e9d8e93a777ac86ba4eadf740cbb7b549cc8917828cda43f203a24776c898418db0246016b3dbdb45c4b9084a564ec610f0f61af14a8b6e50bcfc9a6cc390d912b575e6b73bab3040d41776426b36600aa6d7007b52e54d7f2778ee1d0316218fa816bb84914f6597d697e04b159b07ff1f9dd5fb630ddbfecac22b6a3c1ceb11c42680f2749a460a9152e64044278dc8041b5eab9b1429c0e8ad7fd794b26d9c775440a475b58b0aa8a075d9788946c863ababdd59dfe05c0b1d046132d37fb91ee4edc019cd44628431783afb054a1963a913b76f8ec60d8b83286d7d828787e45466900165b0c758ceebb28441b7993284fb55923e9c877bf3c181b2c7d2e3328fd4228ea8a510c82222b0f6f6d2c12ae25b1ee54845b3a4cd37652ea50bcc806f2dc5975234b0fb861ca2c1f151223ffacbe26b578dbda5620d8c9b444993b23a0255910ceb5913de204ebc744e6b478c9fcedd59bb6aedbcc2d8fbd5101257881c55b6566f9043afa2a915dae18276d445b04af7bd69390e571e60d881fa20044f9c8112f53e83f9b30adaf86718646ce2546c1e4c43fe35009c45037e3422171f480b1afc83f6e6ca3cd1157193006235e7ff9c33296e18320861f42e2fd96ed91f199b04804b1a4b409072a50cf7d36dadc7c1e55c0a43762dbb05a29d45f74ce80cfa895c3f32e7f44a1dbfdb62e4aa6720ebbea69f4a30e093da0e6444647dbc85f34807ca992a062574fc22acd52d891851b41473d9162ba9b2ec4c9ac8e38219e5d4790e4b6d0adcee5a77fb6d3ebad5c5f0a3154057637ca22b4fd13b0107f6ed50e6f8a8d71000d1a6557506ce2b5997bf467be9d5f6f470ac8886cbeec39365a94e898cd49b6584f05ef80b8737a8707d4a4e3a21a623cafb948ab2639af005876134d7247e757611a631015afe5fc1e3697ca26094512196ad80dbf4a0b43ea34638b186b6efa6397eb67b75fcf6f4547b1b398a9a7dea7a30f6a6141d6ab1de8edf0f2243a3c5386d58492ddb9d098077787eb5ddbba488a8bdbf1145b955842756312f37f0683d2878d6aeed144702113b1486ad524cc8057ce51f802234169f2eeaf9e4a7a56c7c245b01b5fc3de0e035d06fd18a07d66cab1f53e22d5be5076e7a180b2393a082abd55cd83e3d598e5e5c5d8bc10123206395d426755e5e81290cce7430d804b7f36a456dda890e8fab13bf40a132ae48e1938f4ddf58a1ed737842c3b5a56bf55d602c2176aaab9b802dd84b9c3d6eeaad00947f3fd784385bf5ec7c03de8a1f2625be240152cf18da9d54e896268565b42aaa7851bbf79c8466683d1d666697dbb4931abbddebab609701b89d797ecaef81da8c77bd9dcf7fd2ca7fa80e4541a1bade35583a093964c5c2c5bee19c30ddc4ad910c17cec68909bcbc37a7293f18de8472463051399011b5c3dca8ab0fd508b1c5c6db0ba8e0214428c475ec66b491746e81f22e73f5890666814f2787a39b264284fbe0dbe873b041a4a38f652f546bcb9950d31acf0f64212955e372c9abf5bdb630fbe7baafa367e884c8a8d86d05330bc4755076a3119624b3afd95db9aa56c96b321dd22cea162fcedc9265d94c46a38845db469ca83ebdc2dd53fe340d85712d3afd585af6c50a2ff595ce4e58c6c1ee947835d0e85b552528eeaf5e3744e080825c75312dd538cb3f85afae0bf953cd3bef4259f6b6bb1f889009519dcf0cc61eb33d61da600fb84dd454b4da187fd4dbec1372d7d2074bab0522487ce2424ab12eb83261ba681ad5f70c6d0cd20c10ec1f228c3f2ff5fcd4ebace0356e26c91f808bfc2198aae3482aebf84d5ec580fad284ee4f31f3e9c322973cc00bbda8928e854fc58f733195631237d9c654b5eaed05628aaf4c9d096909a3f4b535a879f89a5183da89335255402d7e03bdf97dad520bcbdadaceb71bb6145cf2effce5c53a098d0b55e0dfeddde00be7849b12209885f29ce5b6c9534dc966fd6bd385e164215426f4775ab7147ce84548b52a83c3b0e6f5c46086c9a0d07376b7d7523da35a7ffae07a890d32414bff4e549851452342e308ef27606784b1866a471edf65ca40ec732c0692932ef44337acd69b2d73f6e915b87c062817e61843af11cc9ef6249cd6563bd6bc9746298f96b16d32cda7d61b11007431257cb0c297f34673a8f967a9ed1766795397dbed78f8ef1b2cabf795c5d85f191e053cb5a0de28809076d3912db1e18e71f2e85fa1dbb3da5765fb04a9f8c241a1b7692f8a0f4335e6d793d24d38b7a6bec512843ba66a9e20313b322e7c662bb049518bace1b384a7e92bd02bb06e4574e18116032df308a12459b1c038cd68a6cf126efa2722beb8bbfd4fc9e40177caab2da1250ec85aa3f707327e40131b8f59712f36e96df6f5ec98322e54679f4fbc516d977d98d5f346abbbd97273969b69de5170fe908d7b90113f1f6493f017b2797cbe9aa2e20f02311e46348140d10cc9be969c9d362732e6388647f495451f87c85b16a4b5a8f78e5728f2227f012a177987b976effd61feac1493799fdfaacc258fa861b4b8015b3ec39fc5be38093fd293fb6c9800c501f2b81e42d0762b0a38c9cb6aab2fc9f0aa9ed2b79e843e5995d3700edab1699737edf8d380d075a90718d0c21bc210987e0917e3b69a54d3b22d9353cab055b9c57cd3a0cc7a0f25ef05fe60f3420bb7837babd050c5be94217126831f812815b127e678f46c8966760b703f55ab63fec1e1f4b75747eb9c77b676c479d1ccc337e2dfbd045714c0756f2d9501c949e5d01f4741419118e7ed82d770c113af0551b33c9cfd5b9050e22156444dbba0bd005f3040fe295d356c7b45740b51350b06aaf3e773b212224b0178ef7cce2420441ac3f9191d86e54511e66a9241279816b7e1e42b0b9169b240409988b322d9d6957989c3967907969e794db1266b2a86ef16cfbb952e54b01a56f7fbdae3e18cffee6017e1da11a36b51e1487f7fe4d269d7bfc9f493a4d65ed1fda817f6353d45f8260eb291193b95ee2db015aa019516b57623140afed6bb4a29399e0b4120d72c70b735b80edec20d04c0ecc064395f9fb381ae302f98e47c16a5b5cf7ee40e64468ddb55a1c3ad349ca87018c358e3c55f430a53b4d1805c17ddd398825d46d75f3cc0012988603c1b198df7fb6d7925945df32d4950d8f7247bab13e2c8cfbd3c8e85ed6f65bd2d0ea4ea9f45077eeb67383278a95106608735abfe5b23ad6501e5441476965f0022327f08ff35d8f2dda1aac43e617790e310a29ba62a0c9df54cc43ff9ebdae1bc5293bbe64da523ba85fc4d30beb5fd03c0f392ffbf7254b66c50ceb3d426d3fa2e1484a760c44424e015edf716a049d28ab670a08f3d8628baf7acfa103d3a47f554ac9c620bddbfc6a23b17a6a56b8d3413b1d39575f19c6954afe7b96e63be0133213bb5696fa22a8afec6d367c8cea5efb5eb8959b751d1ca1f4e7ef1375e9be36b7830713d6d26316b93d07c5bdde8451b1e84d379efc9a77d14faf339f31726e2b87f29619d763a28fb5d6963edaa34b335cc9ba017972095c47cf485750bec0a08f34d4f8c1de563c634d23394f0d323655e8d4112a4059f0c3892de0e1500085e3756f2778051cd6ebd3ce909dd7c7fb1df846d234b53996fec1add30121859766004da2333b51788b935e1fca6952849e91df898ce9044f516a786314926f88a0e91e54855e4c38d55b36a209f368172d93014103fbb74e6165955e4cae7ffaf86d355eb715cea71e43c4edcf3c5977262cfe07cc9b40bd247779a81bfacfede502b799f0719591ac3ce5034ada7ac4d5bb55479e9e34e7ff281a5d3af1895a5ec4bf20bf7eba84722419069081a375dfe8fbb3033bbfb9a3153fdd250ef5b4ba11e98d3cc73f78ef17385e124d1b929ecdfd673a308192bfe458cafa58076bb018e82c00fcf323a47cfe5a1b28f014599217f8ee53b81381713df651c39512fc7cb110e442f1c2b469f49a7cb39997f3c852729254030a71b2dcac615310348c3377f7f9a32c3569f6cac311d136157e1a0b20f71d22f1df63c69b380aad8ab215a90ba944df9add403e34e35cf08aff0a8b0032c9ad372131dd98ff8857d022717c22433bbc1c348c251180fc2d735932c1164f4e7999d6073ece12717698f8a625d5cf22081fce05ac18be81a83a73c9cd1f0efc06ec23362107d687a34a029c04bec3c61d4ba590caf6bdc19a277df05cb7528c9c2470f3ffa5a7d5aef4959ac2d8fd2af9b5cc3df98610c8a4fe7c177aa027f179e1e781fcbbcf5e4232b064244d614973e25aaa43d4f9d78e974d5db0ff8ec806714e822f21ef0fc0e14765ee7bc5181d8bd77e6c545c5bbc885a34f4bf2cd9718ca0edef2d7b6bcf9eff3409bf39ebac00772474f3256df13a6f57bf922812b87e4a3af2531fd69e33f0b96e7663fbaf831aa5c20a67ebf5618cb158a8623df9e1e4499bba96cb4dd64095515ebae3c21bfab0f37c1b1507bbfc4a9fbd8e617751a393d1a3d4151d504db5a774dda27c6dc3cf76d6152cc1fc89333bf759053f9070991679464e2fe0e5804ba64582034b89365c64e5243c80491058f40532c4949e19535061cb42abd3f829ddcd9d68a5323bbdcd68db0d157996013295af368e6b8bbd5d581645402b42736477bccedb15a53621f9dd8d8364fc4607303dae80270595201102bf30de10d740d16c2681e235f3b70275ccc7ba5c3965db8603455ad5cb07bc11fbc535219ba8dfae11fcca7e472fde06842305902dd228242ebb3cc542fa1158b903378d04959cebe62c0e17efffafb12a7055965dd14d87b72afa6ad61ca1b834ca54607c9ea957f896e7b624b0e34f597fc9eb5ee97b289f7ffb370b93a2ec76939e56d76cec2566c1ffd2dc67160ad5915a863e4ec9834b6210fb087d58b464c1dbc03e54c144e3f8a1f1bf7f6401908145794d6dab10f2e957f6911df0584e6dee2131fccb4852db53700770b80c2b85780a674c7ce8745456eba7ddc636e9a2084d70f6b62bb5cb334c7e0d59fe9d6fb827e54f11f57e65574478571f9ba31bd8cacaf6741c37bdd8f143d0c20eb2c45859b6949a40af0538dbf85e16569f1060f084ddfabc4ab246a11e01fec48c8818097838cbd3233bfd9c66c5dec6ecafcb209820d0d8692a5418effcd48850ec9238bbebe8d780f5ce87ba9130731927632569fcf36d566da08d6ac933ae8e261822fa7419c5b6f353d5ee6a28ba610f3a1baadd3cb227129db0977132b41d31a69ec0ceaffafbfa99d7c33ce63e91f521986d6a877974477db0c638d9362230c6dfa9795f5cf83221f2b750f004fe6cd6a34ea51fa82b8b80e173e3c0b7bf04ec7218fee4a9c84afe551e8aea13b9accdcb3363a50eda73e2ea343b5861fbdcbcfb94b8413d319a890f94fcf316916b3a0ebe436f9c280c2541accffe36e7b501a51df1b4b96dda0dadacd8ad1ea5f53f9191f678d6b96bfd57b014fb509adb3ec9487abd2616e630801f0e9402fe8338b0f6abc985e4f07132ad41010f46a9e87db4d30560fcb8f5cecce207aa786bdd5d9c1fcfb1a9a044a7578d4c24bbda4928bd24187b53d22db750cfd34ec095815d03d06e84e00f440a154531762b9378c9c6499ac76766937077ceeaf1551006fb225b7ea689a8e7b0a990d3ced55b76bf91bebe156ed7a30708435ac60ae7b71d88b9ecf3e553c9590333aeedeaa792d1bc1c06af675e8a207d2476078f182ec17b246fd2e27fb3b6946f9e34cffbc410574b488d52e962fce038e1f50f62766ea1c782f0a97720f53533724e4b06f4acdcb30777cc04758a002919156344b2c60396b017219f9fb91a2903f5f1ff17ba7de9a7bbe18c94ddd1df1958afaf94a34cd277309975a7fc1acd9cc79ac4b272c65b3a3ee481ee7d7caa0b4b1896ccedb17bf89d0a2dc8ea1b044de4227f292934d4d29c3576763073f537558281a83c087822d46d3613d974c0306fe913a1c006750a37fce4db74062c81088316a2078c64897d920f467721e76f0ae09cf51c9d7accd2e3f8d9ce7bde22997c7906d8f2d0f3b172dc2791b7f06c894900ed5f5cf0c709c38bda496a35cf4f6fe19798761fde778e4804fc34655fe2e44f866a67df3cea46010d207a28f4e5139d3fb74d406ec3e9fe2685a823d4845341560b18e4e566119e5f27429b5ecc7266ea39621b7be70aa1448be8919212a6cb909ec2598b8cf8f17a7b4e5b0926c991e130244792a3180f2143ec023829e4c942c9521d2180fdb111dc3b97cc7bc7a9977af75ddb6552b5c613c320c5849e99a3c45557d048d8973310c2154d8603b4f14232e8d13a6212385a57bd33b2ffa37ab9857661ce6e4293fdc27964826258ac4064febc2119e256d82d73c30d44fe8209176727430e01a635bb1b9d5fc3a34d38ddac660c3bc578392593fa505de1aafad1dcdc0070d73fa1a41af2ba364a491bb4b0503bb9048c77d7fad00cee1df991c275dcff658483a54ffa1c16202feea44c77abeea0ee617c59a6ddc15c179ae1a5fe4988e7e2121a701e10543349b17fc64e9e4cfbfd4829d07c0b3e1306903f6ca3ddf4b196a8504b52ab5977dd9ed77b7c1741788fe462fe4f52007165b2e674712036518aefacfb8055307639adf139c7bf0270265e69fe9cbc0d211c267d30d9e1b2d5cf96dfa1f8dd515585ba30b5ba7b9e2a1dafd8ed80b173d0d640de96d73d9c1ee4261c87ba77a48ab8fd6d344c72e03501f9a02430475cdad171dd079699a4cda9ce875a29222bf93b419da88d09cd4c307489f2cc14cea837ee4b59749d38edbec049f865024d29da3515e85b8db10f577074f9291d2045c16a48be9c4de0a2dee131e5005c4e02f3b1a82528e4c44bcbe0129302b399a973fdcdc8aa57a74ebe425ee74e6cfa7f30c43585bc872b1c071f24d087440227b014787e7aaaaa01ae90fc2c9728ed8880b9acde80253aaa08064f97ddc63ad953e7baa3da028790f0c8cf4d454407507ac9ca1878c64e3e3f9d595f5d8b5098722591b1e03b0ad5537c6dd592d30b86e403a087f8637e416d47fa792134d13e32a704458bfe9729b3e9c6fe0ff197ff1155f53afbc280bd47a203567022c5455b460f026dbb5866a9b16b41b751990d0818b4767fa6e14f36111d9faefcd4371ee7f0f1e43825fbef01d5ddbf865bcf05e5567e028770b9869f32104d417446334575a0e8b6ccf9da6b2f3ae17cb464ee80ab7249222147a322ddf9c58b2ff288b2e3b96c7acb978ff0952e1dcd76e0c4ca07a2118c69d072ca258ac7274f2cd5cb996677466124afeb32e013b7d1bd9209c318d63d87125ac56ecc92232c7ab6aa082dc63f5dc409c3968597af3c59a4961b2f529ad6ff6d518ea43d9792f12bc7bd2ae90651b2220ff09628eff620f2aa0b4f7852727f4d9e80c454f3f174a03976f243ad12730484f7bad0447534baa911e68801c2b40e52c6c8677a97d9466aa7f5ac6ae8e42b8b2be59bc7693574a8c6948a1b75509efe393af38656a49865c308353a5ccf2aad140feb055548c855fec22bd0241d6e4109f3da8e88b3b3ad54adf320dbbae86e5b1f59c0d902f9d6ec32a7df84f3863a2384e89a4bbbad6ed1c04f2227b5be80359f6d0ddd6692312541fedab2583f092eff1384e34a8639e25e90ee921d9243dca884d7dd4455d3a41297028b36ff951a6568110a4d40d2deab093eb1776c6fe9b7a3290f80ec46830489f987347b33e86ad8d8796b90f36d30e3e2849c0791017d2c53755e24cd77ad893c1b2f2c7ea900297c3cff8241285d8bef3fe42a06c78bfed1f66dcf64b1bc6b3dd4f80e0ff5d343ee915d50a5caae0b7a49fc0e04c7bbfc978596ee86871882256e4c961a1a92b34e20c2710410529e710e2542315cc9833c5f331d28b2879488a1a9abed142c7d6e8edaf8676571dbe732e23da4a54fd2efd07d6099b7b9f059114fd2f229f25394cb5a058ba9678884af5c139f3dc55ac372381e6af7ab890e0d18603602d72f236aba3d1fe86d3994d96c448f7f099c3ce5752e1e513f5b167ba5968d0cff5f02a8f69eb273f126822c6b8a42ce59b0084dd994e804ef4a67645c493d268a797ca36160c05845a41e34b6bfe117848afe28014b81761704e5717a6b9079752a98048b63be15e2c0349aed687e1d87e734e7a1c2b77d8a270f2ace18ba79df76f9db41803187c9d9b73859aa23eceaa1a2d088cd97a8fb8d6bcf5841add2bb952b771ae791e64ff3fa038760c490ecf55ebb4bc5c37b13e42390efedb9896addc05e39b807ff9cce5220d043974505b1839d853ee1f6eb10f528c3d69803a8a7e0ec4ddc0fc1c09f719ab016605c9e1e1eef1188625c68de12006a52c339c2d936f97143df6912150d68e387bfebc3b002ff343f83c9c436e49c07bfc36167dbd2398142e57badada9fe93d03bbb70e844419a8a11cff83869030b1ae63b4d597a1c4790606fa815c6f4331e7832f34557a13b3df4b905b1be2a59ae18cf835b204bd24d482f2b2d6683fe0d592cb52d254c93394c5e8ac1502c596340523b05192f12e96f67956384b2db88f0349bc3f83ca28c64426f808d467a8c3c03ae6d2ac67f6e68e69206a79c329df2237cef0f7fece21e9a0fbf659ae4183fdebb6368598e4ea0c18cc1d690beb38e204456300c130f24f27b0c78622b5f391b65ce1977f286cd67ae8813accd87f821d345793069914703bd234148995c37aba49859084498ab535a4735c822f5bf3c81e4be2095ca9ebbf22cabf30f8d002133ffa5d8ba9cbe8507fdd7dba4d663fc9eb576983d01ff0dd0ba80f7b982bfbb429147903800c13ea16f929f861d5d561837c43d4e89d94d46e70eb72958b8eb3be70d8adf0aca303820757fe863505a735fae390e718e55fc955f59d4ae73513365c1cd9cd51b65c907c71b54720ed5ba7b2c9d1a8caee2ba984a541f77418b455c4dfdc28e5b024d5a5995a000aeda31743823149477a94260bdcde8a57f64a048b479f2ffa34e3cc51808da22b723a768c993a37fda951e6feca5c139f6820e9c7802ffb7abfe3446b78ce57ae833a4e181aac435e31d39c844ad89e2d682eee5ed1e795115e1aa67339e11bbff9a91976271855f2380660297e6a09c0e763078253c4d2fbc79bb8da5f1efe013d01e9b4aae1d2655619cf0804d7b6a2a43ebebce4c22e6071c7ac894e7c3736aae81fd31980dbdbcf81ccd518f12ac44932a29e0f46da1a489550a09e42498b8ef78990d2651f01591158fa782eefdfdcd4b8d914f493281bcaab6be53b0ba875244c45f582ef640bfdd742f5d0589ba03dc45f8fe8e8b6c8fd513dd07c741a6b81a683d146644b32b38d0f2ff357c1cae74534905b1b3d620bc10e25a97ace27e490803fa0a803371dbe6fe59d89ec00bfcd3e30c15bb50297a647b219b37374c9dd8379b82734dcff7b89de33d39e49b38fb52ec6c52b4cc324a8318c39c45ff596a6922042f24f6e8871b892b3248af3f059c6d9822d50a88adfad9fbedf3760a82cfeac557e11ef7b7938d1776920e01a52a48131a873e0c1bc38a584afddc9c040b4aac4d6dd72b00e4803acfcec394f88648fc03a6f9dcd153471cd3f030764fee2b2c779da0270ace2f00ddda27fdc5d032b7905d8d37ce9205fa7e3d3ce75cff78b81913c02098d5202b3b453c2e81d098f6d637d1f29923314f418a92d0b9655a29aef0af9b130d3db54ba93c18bafd184a26993c229748c76656f07f035441a9ca9abb045dfe1ab3f4a332cd77dc263a0f4e7483b9bee11c4c2d00773b16a29b2998534fc75eb60bc9a2a422301cf1814c6fad237d09a5d8794933ce7e236742d87368979305ac0d41df6017be8c5467bc787597afc4b33ccf739b6147eaea366ff40918d6f71eafa119b2388e9524c754bd9483b87b0f82b6571e00575e87012c4b58187d041320abaa15785d38f164b0ecbeaf033170b2243e428620d66c5074dfe15b34982e582b38f5c4c2077a5ccb86bd8673fb410e62364b4f5e56060e688421989eb5c18a02dab582ec8c04e5628859b82e23ecda49e91f49cfd66173109884dcff739f14bcd79929b191368708605fea98d2eba973748ee2e922e02a129590194f609ec350f1371b6c8b7b92f0dd5430201eca1ee32b54fed545f004df76ddb4e3d3d5dfbe83b766050ef625d080e679218454dfa5675b4a634aa574de94e1484538f1067c6fe54a5000672591b5d694342a2e670fd065859137b3e81a1b9eabc7fd15d4f203d21299ef6d0fbae847f031cc378bee145ccbe3a8d9124530f281574c224fff761e53610344da0ada94c97abdf9c2844389fa0b3ceabdc7aaab4bd2e70ce067d215785cf11a0af7499eaf9f0dfa552925710ed94a7daf2adbcec2b1ff81c269208c2debc3d5c7be43f5811cb8d49e0d97ff94d25cb0c14ae372b1671dac1c14f014cad1e82f5328c360bd95c5846fc8818e701085e21842e8748ba1df0bae5ce5afe474dd4871582b7a2bd2222eea7df2aa607f2e6be4491a6761d7910496563af0cff1b6d61082569c76c88f9e42f7e02da11c38cd6d9e0d23e5f7e0c7bd26ad0ab22fb113b1b3a3156b2d7eb4e0ec4e66dcf108025d545f9aaf7a5e7617bbc664d738c6b4eeb2b0ea9f6751c109dd4e6d3b76fe1649f127eb17f76bbb70a6b3d6b00a508c410ce0ea74d172d52ba264d2c5ded5437f05d87f84eae6c93b31530cb42f1259f629fc2c0bdc18902ac8d28b896ab945733580d55d61f4abc06a8a6e7628ff0740a94fa9f76426eb427c42e5f4a882a2a03aa4e53a56b94d2e8a0a4f3c5caa5cc31a3b7e6d2b9b6a42e83999753516dfe709c543f65d8a4b82827005b94aa1c7d4bd9a0ce5243065b68270f4e5d028299575990c028b96629834119a6f020ca0ec66acdd5d3fd7f879d59c498f85af8a5de373875ad55e3d2df781659336510f5d19a518ff9e2f8f4691551e5b9aa5abbb8e8dc569540a4a71747459a09785973a7d18316b40d6c8bd115e3d67592fcf9252c14707f38ad3a3319123e00b688df8f594496f7c5813ee28f0543a7c63df755914e12d7331fd46bf2d4044cfe15c99858a2f80388b1717ca9f8cb437060c990e8c7d7ea60c31ba9b660510062dc44cbb429abc7e326f208d027f4c46cc27a31ec0c1ecf61c31e8f41f2cb9969764853898ccd11256866e219a1846afe8a01ff95fd792b6669cfd810c667ceca02f68a2190b8846a6b7f300dbf435aa0200861ffd9cf49f58c07d632b72217dca61dd5679110de300c85c7107cac25b110f77ea00b03e691083ee80f3b482c322f9bcf18231f898834f8a8e9e5428080d33ddfe174a0f5e8e6409e804a215c1a19a1e10b6aad0ceef0a3c2004a13d808550bcfd23ea1daa20d8ed79ff4785145bf1e4a31f1b7f8835568597e4fa072e3204600e13d5f54a30b746fb83844148a65d340b70fe1e065b1d4b44a9069fef49912a72c7f1eeded70e313dce8381091bd7f49e42eb58d68cae4fab494accfb0f0118e7b8c2235af3176372b3bfe0ca26c9ceabc021b3a9689cc7d140955110ffda0f83e74f8be7d6b3c73820f1c38bcea34f86deb72327b3ca63ce3067bce1b76836eb250cba6000d8fbec25e7eacfd4f1ac33a9fd75b49aa552ac3436e69e85cff1bccef7106a9df5eb9dbea90998d5d0509a1575ab19fe58b10c86a324b052130f901c0c4a3a062fe9bdae20ac0cc1c06bc1e9b3bbd4ae855729cf14493368ad42969a1204e0ac574dc6efcd5ffed26f8f6fe08229967608470d8f3432660a71cfb619cfb6b1b93e0de01fd898bc142b7fd7082ffa5c1f16b3048c361827e9c8e51ec4297c90e5b0091dbbe329fbc7d7e1e7860cf001b006f22519a01e02f0520db31c2c0a591b8c7c61d484de3dfe179154e9a2bc462513cae13c904a79d027bf6a5098d37cacf0bd64ea7feb409ba162c20cd6141beb0e43c3a15b6f45baedc6bf9e1695ed77827dedffcc147e240a6c7b7bd4ddaf3bd86b7b59d0c2d2ca16ea4d608d80bb58a5ec3c3e4889b97bde890ba04e2a8dfa27edb27078121fed100d8bd1d5d4ba32242777b90f6c7c4227d659a101f5ec2a9ef6e6b5b6c4f89b145560cb42b5ec58ad794b500bad0332b52e1ee0a66f11bfe053556cbede6a85f183c3da2e932eee74218bd76b5a737ef1f6bf0be25d5a5f67f5d0b22284ee9865642067f9bac042ededaa8e5cc285f29c77da55ea2f62e21ce049fc6ca84fc906c32b38ed3e73e2e6741337144529f4e1ac51a62863e441746f0b94cd3867ef791c32a6e56202075efb710680076975f2ecf118402154a73104d6e61f73b6175d12842a0cc29d803f64dd20ba2307f7e1905cf017944244b0900d1f31d193c5afb3ab65e6dc3f5cff90cf11059c23fcda874c0ca077845c8561045bc7165547c72cf3b272d6a28d9a9a5736614c1e86cde1486548afaa47d87260de1ad7efcbec50ebe21f0f192eef0790219369da924a29602939d7c923faeba7f9543b148d8ae5409e4854aeab99372cb86a167317f8feb1f57aefea882eb61de09bfa601ce9206aea60e43b22fec3e383724202c148ac2de43ec28c7c139602ce84fc8c5f40465d762aed892bff4beb39a71596e219d4f1012e2a015278adb12478e091c1cf93aab476e24e28a14c619995a6673fc2817ba5d6b3cec6f45cc3c1387e1f98b8f59c68b40b34707bc35533baf21d85203c3db215a023ee7e6158fc50a910d4a034c607c93c30bffc5113c0f661c09c7d164a6682e35655135a235dc4b80ee4ed701c5d00fdb0cf0323fd6b67fc0a854095166f224b8cb7f976a9388fc4c4b06c6de5d3974f5cdaf7ec3270206e552335526cd1c9bc3bc1f2bcdfafe2aecceef7646b32a8fb7851919b56012b3040669e9553d5fb9b16db741b026b786f1127cdf3adda3ebcf297d44f7574bed0882f288d38e1f15b08aab627d56ce7ae6c2536cfb75d46eefc42f17dcaca110be667ab4ceb9b55daffaf2c6467c858d6eb5c322d8eb858a160c2f580a73c17541be13eaa8b451ddb427a2a2f41b0fa0b72b7743da0f38d035c895c4b247b487d4aabd11462c99fd21c42923954ad2415ab20583fd4c2dc3d3a9125283505a864c830a7f30819b1e83378f030ea62e157123e9bf16fcfdfcbf017cc593c66966ba5f1bb984be7297e930bfefc90235e53d85044f1c145571e3a58ca8fb7f9ca5963e0b19265171bb16d6267dcfe96eb748566365bdcebecc2a9270052af6a1ecf19df36e8259fa7647887d09ab76df51d4aa89d964782b6eceb1856b1fb0f2c9031fe598e99302a6e9e3a4d2c153affe09699afdadc860db883132b445654fddba50b8d0e0ff6872c05d49f8574fdaf2e27e8736197c1f82bdda1ff6f817e3f0fc93fded81b56cbba6e8d0ec207ec9ca453b83cf0d3a15e986e90abcf48d7fef7ef7152ed49c1b98c9cdb5c52063051ce9042a1d2b7f58161ceda5a522e9ee0c89dd0e95c95c9d9eb2521e34f48b5e8ad8b8b86485fbe216a8f5a8b454191de1e6a1fc33956e50c5119982f2402b820bfb848fdee982a6a626f68eb23f1822666e0fa37905e16e08fbf3c22e3ceec49edd20d0448361785c8b11fe766cd46fe6c16e1f99d206a1428274ee11ee6e41f7f2144ea3a2d928efd49fdea67daa962c8b518faef352391b3fb4cf2204ad76ead6ecbe722a00a8a9e4dfabe4c520b8c847fbf9eee0c54b85e303466d1dc86d49a4124a11cf892da4f7433de05678f0f766bcd1f8ba68d8c52fbe57014f9d56a938d5ad37c0b9d27ec93333108aa4950c18383c4805ca0b6ced602613740e4b85f8f19baf35ba87eedcdf31f7cf58a6aca0514c18c2917171b4f2a94e597523e25a84ef1ce9a19589a1b59a04812910fbc264152c76c2cb5c17b6bca33ea72d53e4bee1fa3e9967d386134a2bb777abac2062c40118f4c8e852315b4ea0807d7b494e224a4f388ec66e3970a0105663bb6e6460c772fb46afbb77d155735e54a235ecb46198186524df266eb400d2d730fd309e735c84bd508cebe0a35e2a455b4dd707b52e0123896ab251b7c017e224a1927309b0bfa0da63b4366059350e7782eae0ea29066348c89ec234b05830f9492b6ab7c1f80d63704fa3b94ba0f6c3d35169eeb13caef1c2d0c1bbbcd42298837b02c42dc983b15790b80dcdc27e858d87607f89c1b3948a1141dbddaa5103d6a062c649d92a7019ce77b0ff7e9455b9e534afec6a6ef7725293baacf4e9f17682eeac97ee69090ee9fe8121b5a2f834f2dcfcab75d3ccb7c9bb9c9f764e6aa301c018a579d5a927fa07c47cc4add92f527c6288c97ae722e9a7c4b7a46ee721238248913659025981a988dff414eeef7ef1e4dee68fa768694a7b1431db214d8cd61a13ef4d710167f48ba76f04ef6db57a84c654a8434c5a73a03b42fbbc44d4072fdcb0d44838431db7b76d6e7a5865a3faa397c07b49b011732361577a083a47a870fcab172a2b32efce18edbd2514b92d68351caa8ca2afe044f19a58ab75b6c53c89a5ee5de5fb80692c6cefdbd52997dce1d3a0a2e3ba0169eb4aaa37ccb4271e7d16f179fd076bff2d3148e85a2471f06d3c5a7788d139124800f235107b5d5ee7f6ee3fd0086f6a9b383a745f59ce0f261c62faf9686b0e88ed42f0906c08020625e23dfb85496b641671a7e7e582f2029585b62b69f891a93b3ae7b6cd426c4a6ddec9b07df817e87338b6ca2ac6808571afa7c1c6beb2306708468d973281d981485d64bf8bc5622ca15d813eae02783d22b1b55de6a6df88cc6bfcfda7d32c4c491d9b6a671251e2ca36242371f1f6b125c2c9c84f98275026fd6491e0914ff144feb30f5dd5e70c3d39613efbd31858e29385775f3fe94d5c50f2e4eddc7e466c08475c141b36d92f6778479978ee9996af76fd663cca887048960acc239c5ce046f7db8c15a4bade086b913ac36e96e89a077289b60c9ce7041e5ff854699dd834571b501ffc8046718e8b7ae3d267f98585413843d698aea7dc8bd9c7a470efd4b3371696f78c0ecd6c895b00f2e3a65c8dc0526bc244cfebc9c7603191721219edffa2ae80dbafda8c2d4678aa52698173cf81c1b747fe0e6c1711e65ee5c40914de64a186ba284337130d9f7eb0da6dfa5cf64c02a4f6c896070ca8f02f1d30154860c332a24b0c0f4dd920f4f2ee757faa8be67d5bff91535678e2c097d677bf54aaa9a4cfbfe837fddad2e7837034e4b9d31bd69a61f1f916e9c86bbbd219b3e2e6d86ce636a1b5579facadd42f9e35fff0010407cc47349b8663601e8e2ca0f650d1cb713432a4c2f1041848a4cee3f0aecf66ec5d9a388db01d452ee20f0a7b79e173cdeebc005f960ec4d20b615e132cc0c241a0607321445b0d5a72cc49d54fd58163d4ebafd78dcf041bda152a926fd0fba226385e4feb5504c114bc8e0dfcbc22943214bcb3566f95c97e1df922b828af12028ef7920b502504d813da0e57056151e2dd19b57c10c492968fc77656b372a1675640c22f2bfd9d97171407eea82b5746d4f4af1167e06a815f42ee3113119178e38955d52a417211646712cdcc1a27aa223a7e78715d0291dcac6de725a61c31b975ef0486747b213b0d1bbe50761e82058cc3d99a9400ae063a34b10837e47f7e475c927bc644b0ee37261a5d6ca64af5a5ffff67062ed41ae3a875370c7c253ad8567bc0768c0c3c605a689c7a9b052581d0fe6a5cdbcf79986cc399dd0ccec93c2c25a8ed9fda71ac70386913d7a1cdfc30d75a37f3a7c85fd9645c249b9c7c6168fd03c9d67a2c9b92dfb462136c90866c5c84ae4fe786e3a267cf5ab54147713aace87e54015f294043861f755d4548e6a9a8fff1d8ba161d20d1d3a935c6cf32fd94960f6cfa44326d1997a7bcf265a3725544693f233e8ba3f4f4bf1f53b5279951b97bee78afae56ab3e8d4ff2e9f10d7127cd415a3bd21b270702fa2d4d83c37848d8f06dde80cd02b4625f2ff9a98f3872f75842ea9e0d23276cf5ac6f02cabf11bc2f64eed0b33b5a0db7a850c14407d4af6ede770b14b439f5a14ac1285903a2ec5e789d828bf78796c64b9208e1f02855c581cbde9b564ce4c695300192c47bf5f0f18506a2dfe1de0f22caea2ae468f2a64e8f95da6839fbfbe73b45b50a16068abb18af8cbea5d30e3a87bdc34d12b80fca03802e7972da6db6a8f4899b077e68b3f4c2ce51d08a8508104484a4f650931728dc4497c70aabb645010864f3c62e1e708dd4c30e72afff64e8db866425caf99f5f31074877f6427dcd3bf4fd109370349fb5303d963ca432fb1a27115e5d6a223d1af1dcacc0afbbfcac535d3c4b3758584c85a0c3e5d8cc9ebc10cfadb1248e2e2458e71d19c6fb425083abf96b0feca34ad2a8d88307e322b6b38413d42b5070f8708fc2c189cde6e1c640c1c0cbb720ab1e61f902326a1ce5272e77feeb636202290f7b27ee2f87379c4d01549ac70a38a9e0edad7316be2d4b14c8d589a8abd18fee2b5fc709ec517b1108619fd39d92932413959aa64684f1949de74995c29859276b6be02877f7fecbcaeb2e14f4cd20634c98f46437bfddfa2ee4c9fe555dc137001cad4e4e95f8f6939ff61d9d8787797aab92cb5039ff700116f649c689373d0a5c7a730c287a26c01fcfa60c0ea90e705f7e6a0644b5b3fe879cfe9ed173f2e86f97d32b35a7015b9b721f11dc6c76a0e3995bad239641c0297e7bb7e31147bb381177504fdd4e9249f3027e5f0e596964e2ed927b33b64d63b0f5186467d68719c2d467c92e6f4174735824d995ee5e391edba03f53ba75c8595097adaaf39962aa3d05aa1fb2cf1daaf3b84ecd8ce99b4591e37898f4c38f6306fc6fd39f548ee2df354fd48fd159dab0370939e52a436cfe6eafba346ddfed20c5990d44661c6deb7863d0e8c7107e1198ad7494cb2f499a5b3e8ccb162423aed671de55c989fc87f918b58dadded85bc44ba1fd0e02c323a4a7676f57b78b768cf312874c0afc0e5e0d8381b6477dfb086e0cb20c4d62dffa2b4fb4099df6ef073d16a9b5baf62a154866d73e56250f6428181742a90ff0fbaf16f65f7fba299e5bd3ec51b2d370cc188097eb3eb8d4ad620b4bf721d6d0c85d523579b1bbc75b9de5a94234f920c548d7eca05ba2e09844677d78558a55788b8992662dd159ab3207d7b6dab75243dc328fbec4f5cff2022605d95ba7759cbc915800c1bdb9564348c68106529f7e908572e0fd4752fea40dba814745add07b6a7baaa8cadcc1df0becfbc11de684ddcf30a5e57536fb0ae95e61d71b1bf206b5e2aaa9188a15649d83bdaa497125da2b47b143b592a1a6a81bebc7b921693227ee2c63da27ed15e3365e595464de464af6e08c67eca436522205566db69234e66e21ce8cadaf69427423e582c39796d0b90144800f66705681584fc642f8faa75e6f9adb5733b84b23e419b4550cc44f08dc553e677e09ebf0b9aca1631b21390b87e86d6dde7e15430f2fae753e9effb796794b0a68d6ccfed45bca11b83728c3f66af14d6b25ac0d886bee8e56271546a06f8df06eb5d67087e4dc897b38db330c4a654017d436776d9e13916c79eddc8d743b37277d51b7433cb2f0e2d28d48595b9e8df99295e8946dc28c139352cd55f2d1d317f89528c717622d2d48f6d599ce9ed7a6334cfd91c667f2f40bfaa9b7b491c69a0cd0e6fce53a9980b048963557d154935462d7ce2403ca5ed0e87d34b19ae111d74bb408a0dd675654296e93b6e701258747d3e4ba46357504d321c5c671a2ec9a5c45f10037b71ed42d53aa966ee9c2a743823309ce63a23bd01f1bd64d7ded373701d792d8b7869931175e1445de6b4af8825c5ea41e0d60f31c62032048365bd344a0b2e72fa5bdccf50e82675de0c4d42e4f2d3a2518eeaa7b056b99ff7ce4880d8b7fd98e16d1d30dbaffe3aad618b4698fb3d0378ccddf8f431263a78ac6df335cf1ffc4df6e40245d36c96a20df1d7a883ad83d4771be493088e7e8e34087e2874c0a79ef393fd5381e3c2e7e7bf7d6f6c051d462740517b71f8896b2007245cd8d929a7d9474a39ce8d3076565ed0809ca21cedea26c123563f2d20b718f3807654fe4d342cf8f0da86a62d49aec20ef05e0060cc364394cd2b2af2dedd7d44ccdda7906141a0dc1ec3d3d211b4a7f4fc8f0970845b6faac0b2a7363d597fc912f554ff869ec35149384e050ffb7d4e1d401d0a0f07cc6fbf1cf6113520e72c33f4ef1b90c343b75affa3b0c22259324c48f038d86c4f47e576b8303b106f1712311edcdf606270d9c642ea545f252ddb49f2393421954a2c2664074662fad98647373f52bc4b1f75ad61abce747110ecbd246078422cb2f18be0ddabccd8ec92782aeb00fd6cb0fed9e52c295cede6758a99d93b4fbe58f5b0404759d86ec4c824a08ed6a5fab4e02c78226fa0cc28ee79fd71ca194a824147dd27a29e0cbb6e86d301ee49c042adab4dc40ca6b66abcc2647d0a9c503c7e6a371b575c255c68359ead10758375d6ba48016a7bf25899ce532b0bf3edbfef4191817ef2cb708cce81604c8755151d3803de413fbb3595cd7876becd1215ffef5814e44006eda1421a9b46fafa4d11a5a50e8e118d30786909d5b2fc4aac696b296399c277d1a7434ca605a6749de69abeaee21d4a3fffeca645b5234a902ca8d2644c4f54b7a44b4f430995c50d11cda61df368aba4473ab96f5846aca5018e8d088e052cadf7391079397a658bfdb4bc6286b31aae1cc055a152a81c6a980dddc32db620bf055767307de91aac9a413ab9f1ff0f077cdf91770797999ab3b3148066b45fdb622614e2bc94a1eb6a959fcc43948b9110749acf012a7a7c8162cb500bd0d781696ec21f9374ab83c7ebce510ca1e74929d8a7bdadeb330f9b3a0d8259a06e1579eff8ab99b087801086837365752a026df9a715ca3a964972124eea4283d6252a6d1cf4abefc94c2c6e2b24a653ab9f118cc53ce5af9f1a7397f59770af3165ecc4606a110df8c630e3ea8726a8c159639a3981de30be753e3bc7a0149d46d2d0cd356be9a31933f8f73f8bf6a12a9e75e7544a813624bc9fc0b230ed8b1b037f67e26fbec0c728b07510159ddf8a8e5a8064e0ca7fdabe263a2ede2a9e1b6159400a2c7a776ac12f8f81f8dea730f25c267b8f6e25e861c1058b341f8c5e6221ca923efd173504d2efd50b565490c377603df477abcc809c2a8d2be84c8a7ca6dc9aaf03f80d06feaa3e3a5d3f9a8b36dd8b06ba08b33f8d48a413c2ebe40c503385255b23e186f6696d2b938d9200bb929df4b180b1feecd7cb7549088271c470a244e548bc2e21d16aac8463cb167d06dfc345a2c079221df4a7fe282d0a9024851e96f2179498ae31d9df990f48f0a1bad2b6a2675f06e41f42159d832d38864501b204e1996fc52d1e3cd61e1f3f7b77049a3c54bdebdd956bf520ba4e9c41721a1f96eea553c921d0e9d1486ce8c01b1421b4ca7aa60f234f61464447b329c925cb52c7c902ef3d59acb96b9b68865788f769ee1a2ec3ab59d4d34b2e3344acd94f9d2657c004ca02ba688942de72363155fe38e85ff2530aeb4c8c98971fe6b1772873bb3063e5bf537eb8920486aaad89df1ebd33c530a7d6b89243df49331247a64e39a2a29e47ccdbe47e2f510abc9a735dd31d954cb5dbf667d5a4c0244ea99ff97a386c97e97ae02b5e2cad38dd8957bdd69fc431fefcf659f597840560afc54f6fa165def0e1c48a35fecc77427c792d453dd192e44696483c1209177269ff5fc86c6d19283e51e604adac73d85c0dc76c8c82bcc24bc63f28c298ff8ffc7289dd6ec936a7e033877b86dedfd432ef5bb2e2f70b6e8822f6cbdcc566a127cd8483481e672f2a765136d34a8bcee54e0f6226b9a9dbe79685b532f575e38af7da0e40b959e0ecf7e0d5253e5086794db1dcd59cf84d572d3672f3bf5333eb7deecd2fd402cd2eedc5a941677d6ad19c411c79b7cecd8ac42265acc118d43bd240bb4b4fce922c8639537994f1ff98bedfbfd10c05626acac397546c28e24ae65e3327884b16e931be63f652424a275f35b12ebdee863ecf8a531eb754e07de3da6562bedf0e7dd2aff8870b14b311b90695705fc66d69a812fce0d456e4302428ee5517feb08cac9c03856b281ebc7b779413e12ba1c4cabb3af37dcabb42e3b57b5fe5abab7925b4397983847abe09ca29809558bab9a59077012000394497a4da12c2568fc2e0e4e44ea6f1e44153a206ab2e1389e413b80fdfd8fd94032a537d552f54d8f08602fe0b444c7a1a76dc3778ddde52777a25d55999b5570208bf5b083f013c5dd2801d5ee1342a7da59291ac13170de9dbf6bcb88269fb204018fadfcc0c9253ad5090da2f4a9d094f5421bde84bbf23c70c51f6a7d971c6c779f19ed2f94b2a705c81dcbdcbdc86fd611fdc4145ccaf948fed976ec666092dd35653151f4d7a1628724b8db9aee9e543ed586d7754e6817cf1a5bdce86528d9b1b3c9c3f277c4eb6f7431111bd7bf9b4d15d8dd321a2f17ce0b4697fce95a87349009bd3568730823e747277c690fdd80a742862c6064c5efc98d8211e0547d04168a93e92ba1237fe6a3752f396c2d68145b279db095bd232e738a62a8842acf33bbdfc96fb6a8098163ecffbc234d3c3fea3f96a9b71f2c21094d25377b0f65302e178f80c149bc00f7742e9ca11761ed8769600dc99be19af1fd1ed6c80a1b4f60033c37c8741958072c29d9608518ca0d542aba8e29a20cf0ad5829cc624697a721f1d31c702f05bc1137101d98460a0bcdb7e482e2e7c09d4aa436b7d8863a2966fa12d3bc42f96235af7dac1f77eb6d2344f56a012d55e64dcee4b148675f069603d010b385738ddbae8337b9517275d8a578b349e9e6ea72a55daff8a134c151b434f8b473d16f8670bfaba6571c097a56678ec531bcf60ffc5ad3eed28aed9570fe5702dbd55c8f5d9821fe5de2344c3d17f649b408fa9473126249ccfd79eba22499884ae751538f5651ef1ed11d100fa0ccb2292cb3791c1f3cb2b34ff59a5d14c596ba05f9c22a3d8a64519d31464b3d41207b2bab97ce2c322b93b5348303fe60a803598567fbe54fec32b5503801a6789cd088cf6f13a94a100df78663e617b1e5955158da9238e2d6844899e358f55efa434ef26c027f8e2055e1d8beea3d61a6f7587913abcc2139d078906e1ab2eca7991965a99894b3c29a267de637e5159f08a344fc62eb523773fb360cbd5e55c4dc79033c3c81d4b3f307baad091f1e5e91743ed335671dd610e0e1e0a981927badb083407da4b3fa79bb01508b250451b82cf0557e93fe4a390f807f76c2e4338ce96c031700492c4a9fbe824143ee4f317344be8caebc1798b820a45e7d44ad381f0dea160a1cabc65ddff5a5420895104354be16dd091c3291ed7d538da772aa4de961fcf8b334cc26767979123967491b978e36678ea211116e488bfe843214f0cd15c3c5216dfdb3da2ccf35656016553aa89db24b1db586aea2f014e113c0a5147281499794a05dc1480506c033545b191522a1c781a30676432cb06e15a5d1c3332bf8a828e7342c44b41d1a3e96d359fb492f4898bf01d89a1aba611394dcc071356dbf7828da267c5ecf0c5c7147c257a3e0e7e8b2bb33ed3a14dfe71d942b882593a32abf9c9a36f4e5fc244a37f4b6b4c4a2a8794eb3e8ae4d0c3fde5b05840eaea1563498fcb6fa7252fc99d98964ffd05adbea558635e195ee69e837708ac7bbc62bd5dc9f9f24ebe70df922889c40926b451ba4017fa20bce9cf7083e89cfe0d4ac7d033a268e1f013984c9f75d905e3af0f6259ecbbce735cac99e6d1fbbcc1a516d35def9649be6c239e6e0e30382f5ceabdf1e42796b5dc6b862a06576e77e9ab7d124c30454b9b5dfbe7f3f446347c11ab771f9d363a4038e7e0741bd7c9894304ae1713b16b2a5ef1232ef0a34c52e00f23d731717b624b2010e65f0666c75715de68a4bd2a184242ccc1465ecb0dc411cc58f60365c81a3d04a70c595bc78ad2efd397a65e5da4c521ed352a9e2fedc108b88e5f4408f80854cd34063449acce86e297fdc53907f40fcd85065d399a30a04caf1eb8d1d38487a70e79c9b6c01822675cdf5b5e404b6156ec77cd4b98031dbc1fbc5fd0247f08ca5e63152366c6d4a067f1b5abdf7a30fc009bdef38f6ffec941f94cd6ff7ac80e5a21cc29c7f111f75804380139c11539b3e7eea08cfd8cbb9316314fe44266ab94365972f0cc2c562177faa9b2e35ac75aa975d8906d0bc4918a2b5e487f96570182dc95f657e828475904082bb8a809ca781448884d901fdf718e033a8fafb49699df8003ed17dc3d184978edd005d226f7f702cb6a9d5558c3c9f0465c43b6efa48ce072b1f815db3aa92f0746ec966057d555372f13750f5595c6c7920fe76937d473a51f3ce76f92dada8c62e45c3cc61666c005991e0f31cf8a1868f6c4fc1dba6e4c7d62f6240f6425191b005ddac410e2a0b4175b76c58f9d7e11d6ebce0ab6c6ae6e7270927194d03a5d1252d291300a56bb5c7e968fca9e83d414928dc796140b46088c6af768b58fa3debc80ecb389422727d9b943517d895f1bfe9fd916ff6f9afab8b352e9de5cafe5728666b9306d393ff0bb1ef04b71d3aa94c75e661809c425c6659faaef46f7218b38adc2bf75da83f0824f46900989a8cd5bceb065edde5b8f07bbe42979c06a0d1c60502039da06155cbeb1ad772119ab265d1fa7f41e29f86fa1f693cb422f46db6a403d55651b1d885e15a58da9fe7e90b3efda73a2031ab9f2a03dbff956921c9da3aa1369f044977e2f14d60bad5c71494f0c02ede7d265810e69a709d4591b2beee6a43a77c2ffc7ee49de5e8609ed604badea24dbf9dfd69308e46b860ff1e7fcb361000a4e5039513ea49c8589d9876250521d770b1ce223a4c3c84aac7c9323a302417beca8fa5f59c7ef0a63be177166355dd274ade9b5c40b098d7da5939d30e3fc0132e26a19d797da1efccf9436c9243f07ea40b5b5cd901b18b306185bdfeb470562c73390a58cead039cd200d1bf119f9579eb14d5097acb7ca59de6abab051fe0f64054bf569265b9d5e109fc144a43fa1ffe0ebc59e4787c6ac3cfc3d2c4e06ebe39290f614fa40bbad88aeaadc1c276fc0c92952811c2ceebc7c3621d44242f5811d2d90b46c21aa6145efb86c2bffcee9f851bcac367c3de5c220ef35163090568d0080b82ccba715807e281c3f85c32538c69e5743f858fcdf18d06e07e3c3531e25a21f4f7ba54ce8d210fad1c35a04eb00fd8a65be479cb13a62db3e77fb93fb00bb39ceac9ab6836d7191a7d7b24ae886988978abb234f21f71dc561e13e31804334db5d457826cd59798d9aac9ac1db27737fc0bd4ce8cb18d3886616ef5c94a40c415415ff96ea34c5c5c7059edcd6259efb6feb4262f3b67ed942735ea195d494076f44fcbb936e66aa3b294fe05f72e1e768bcd3c2a5550b30024bb2818e8878fabcd574efd7e2891db6f2b53c7d77550b91074717a7806ca116683cacba950f19373d42a941d99d4023dca0dedd02ab9f13a76137dca475f5d00d1b746ec620a1ee28e9d3740eb80f58bd244b3a7edcc7f07921e7d295c97c470effcdb691cdf08fd5fe8f1c8e8c45be95d640220f3647d0c37ef3f445882513c6f51150dcc473637deaf2f2e57bc14c7f69b074a6e0e120869bb24e194d208ef0f0ddd2087b7818706ed6fc655d8191624d6e9aeb8f2986481d03ca10e265becb9b4ca7826808bd9940e80239cc0bc38f480bde47e3bbcb5e41e5ea3b28ca6adc4f76732c234bb40d184187f6169c87b48512c6d91a7f061cd07e8371a539f8750c11f07acfd168f55ba634788d6029e5bca844d86fa2866edbee7ab50577e5113941dedd2e75df123f4ed36d5451988475cbdd5de47a8c60292c1b8d3930f51bac0715169014d385b12657b36edddd7c83bd0099511c0356b851a792a6520f0ab13b7681e9b9cfe2c665b66fc45eef87a45793caeb98ddd4b70596f65880bb695af8670424d5121c93a9d1254eaa2414afbd9f84b557cbe14c5069efffc0c9ebed2ccffda273750e1670cd91d76132cf2bf2a5c74922d440947ac8526b66a89a51904e16c7645c9fdf4fcf1932f8d7e851cd9635bc3af8805abb254c6c284297875c6b2eb0e48b0d7babb47a1cb491cbd36b4a41a4082382f29048876d675fecaf96f596468ed1502791817e2d4c65566249f0f89629f0a5efdf3bd8ca01fb17e31567e569f884b7f826dfab616956a3c96d6c8a77352e30b5b75faaba54a59b03c774d678c69e1695c1b9c49539cef0508816243018b1276cb82c21001b4ac61b354b9abdae4aa17dc52981b13d090f4f5e5a2316c84245395ea36ba7d5e4f4d96d7a0e479fc45a5d212336b4ed1ed0975092cd441e9df26c2411082b2959470bda1ffae61cd3796dd6d1d911a4816e756768349d66febeab2275fdfb8d6cffdea64fd323b0771086626f49401b74a1e7e71c4eb9a26692fa600bb0d88f73d4739ca0fbb42334df329598dc745554c1aa03c48ad530471f41a89b7f0dc9e42c062a73b9ba0250f14fcc5b36d4c7fbb1c6db5ad2b535360a6da092d6525a6d5f9c463cc7fbe090ab00b3bb8cc6de24e955059c62b45e23940504364e5a8f8cbf77e10fac447084752efbc5b87e56a1b6b9656f4381752cb49eeb55e66d9a6bd485bd4fef0c0ea748e2dee0a34260b1366f6a3524530534d090c5bc09cada7082f8acb09703f1bd675d669653e8488dcb7d8469151d2fa5404f24946d0262cc87012d9705b9eaf8947752f8c73bf31b925469891b522fc47df6ef0c8bde836dff5b22859678333a38d81b49c8edbd3d05feb1c1706697d473374d8723fcdb59bc2510a4225c356691c517c20b8b604512f36139b476ec351ece8b2cd36ca02df14e0dc270b730a181766aec5dec2557cf8a857ccbedfcf2f67f31f6c4cfd5159f9eeb48a5295e6758c8d03b04da6689cbe2b5ab217703d6b6a3a4aaa243368f7a27635faec1cdd39f8f8d589915e587b821a101927f2397122549c07a7427fde6a3ec39f9136f70b9c447f589ded4b4d4aaf67b15b70fd92e6c3ebc39e6bc712219c4d9d7eff24ed9b90f281e584092874664ac982c19c8a6edcb5833e9cf3a0edcf188dfc62301855065c885515fd95236746fdf7528530c4bdc11ff53d25cf866cc43a71d63d1cab2ccf920ddac04bd134c12adff7ea6f22b04bc2bac5d69cad2ced623a26857bf3b83af57fa32cd0e1ce051a609e7ce6a3add57bcaea806489694694184ecc72190a9fcb250db77f4a567665e34811d6ed4819dc7d75b1c330f9f2241ca3cd99ee16b67768948fd8d756ebd2ec98ca66c59b782db094c297c575d9c03c7172e0da0996f33acf1ec8ab7089c37a3a3820b053a1387c750f46598ece8b20dfffb36c76953529c7225bef503eb48991774362fb097f2e42209dd7923b95fb16599c7b695816427971fec196b054fbee238fc7fab662db5cc7d0d67157a7601cb0cb8c00f36ac4f5b87142e72cc6d44ac03f81baa7d754001a8dd87179557e1f8f52acef6f32ba1980c64f28d51fc26dac4615e58b969d2345eb91529f1e74f1fd3bfe26fc0ac27feb95f01f5adaad248fe55d8902344d7d7aaa387684c6c463c585e5585a600e07ae3da49a0639bc428b500ef21edbefcaeb504d393bac72769eeaf2f5caa011b859b86d592edb14cd35fa15f9821deea0e31229c4d64a0c79c3f311292521dedc202f3f8843c69ae86601302568c62a78997c78390d33d715145fc2eb667b8366889348e1745e6e80f89db85ae6a1c16d3e437e52e2efe6885f1172d9164d17d305f9986c80f9077d0e42c6f1b12b4dd9d5e2e24d5bcda82b5caf3616654abd7260c755d69f6393274544beb0f1d737c278769026964008335792a868f9d55d1d69d7f5757d2b4baad6de644681bc2e0ce57cc9a0ed7d62fb6094dc8aedb12dd8ae75423a05f731f7eba725c2806c22e3eba01123ed6cffa4db46c1e833c8d248d8f5efd143acbe8e0e553b1b655a2f8aae2b17cfaa33dadf4482f56af269780d14ccf8ed9aefa83fc1daa35ab0bae31f5a6aab385ea981fec3d5e5d62094082af1abe10c2480fa2bb5f73f04a5262f860d22c69528b8e000c9d03e52c1f3d883643f3a5ddeaf61b2c768a2334b91ff6ed87618ea84e7a440781761130eb2af3d3c3504e0377fce85eeabe70b400b96b0f6fcf7b3d5153ea2fd06782f17741c8be0712b36c229641e5ea2367de8664c3e1f988dbd2e7370ea56647ce79d19b86ec8d458707b29958dfb8f54a018c9eae14b6b024be84d41cb021b40f0bf098d2eec228d93e0a75d9fd7fc26ee448e5fa21ba3a4100e481665f3ef7ba85af89f0b2c7c6cb9096c4afb49d5c8bdfa58c1092a5a6f00c611adf198b48ada29fdb2dba234b0278246acda92fec526e7a237403fbf6f34474ac8a88368eede124f17b062c6c6b1dee13c8e9d4959ace6fa6f90c64ac1be10c2af87835e63ea4b41e655bbf225af85f572455a30fe06de2445ecfca29fddfbd1adfebe74687d430c90b81d9cf0144913f33f71fd41d435bf969c4624691803191468a73094df7ea1f43c1b65d01702d6bc56e7e31f41be8f6e27be3efb263cedd3e280263734b80d2c733c13bfa25d1214b3190a3b6a42734b0a63f163431d5c2420465e301dd3ace6b8cf8f707da5e97a18caf600c0edd315ff687a29d636bb68b8a7af3baed662b41d991f9e72d8895a9f49fbca41cba6d73e3d0cb4f4c49df594b12c2b1528ae68b432f45a5bf7e4013af2fc8c5efc084481bd7f44d989c2f12f8ec4574bd08e9ce34f457fe7b1cfd26b1473a60d092351bc99fb6177b92f7c0c342fb87ae9400c64eb878476cf33daa41591ccb115c8df5be368469bfe62c5f481cf41570f649ad2dc40aa3301ab4d7f71c7aab21a154176c9f985af105982d939b9c62e63fd8a1b5786f74453072183ec579bdbfe0189f2ad0229cbe2f4f7b5b80721f781a65671fbf834a10a4e1b20aba54bcda6f14533c634727fd351ebe063db389967e5276a8455135e0551540bce5bbfdc488ac48e9e3b96cc8eb6b7f70242dba54ecf46ced09d4a0c5a043bef3f6027b18808ca79203d155a05a473f3584f36682f3c40cf7a2259061e3cdce0b6347d0be8902150a79c0f11c5d9b7cb8a68d6a167ace0ed4ef5008c914d62daa5ef71bf9eece6f5724a9484a15d25794cbc54d85a5479ca895f37f1c06d7a3c503859c7a07805f9b38376fe227666f066f9bd3573b7b479ce4670a3b7dbe3a18d6572cb589306b10167567c51444d0c233a9b1f090c292c5b502bc76075cc2dd31647d128ea7beb6392603eb88e2fab5807f18a18747a9f21e382300495a0d352c246ff3a9940f005e5065703740bbc71053f3aaff6deefb392284018f3a143746446ab201d88dfc49999a28e9b884ad19724d7141242570d5bae955193081d9c4157d7e666e7549f06f329eb1f404f26e7349ead36a432c6e9d52cde36ff8396e56e2c99b339700a13da2da3835ee4028a97c71a73f15d9a0f552d7e00526d7d8e4ea9ae0bd700c76d4ec4728436bf16a48e9dab9be0c0678c19b38096b9fbd5473668b8c521437269d3419d293f6e67faeb2fc63d6a7caf70a4f6f90003feae8b3f6ffbc8141351970b135c7fa6545d46dca1713d28d2481a77fe2f395571a76d242fe72c525ec1b59bfe28b003298677da79d47da315ef86a37b136ed83da8adade92220c713bf6df4715289f5ab5f95b5635fe7900093d36e6c9b6d4d13141f1827ed7372e612e88ba74478e7be7f989a90da8eb7f35368136600646bd5ee2a3342da469292567e52d9c8de90c389ab9fa54a9844c498195aecae7c08e167aea8619daf99dfa2b2125b45510f74e8c7020000ac16cbe11b11b71f7c9aacb361164f6ac78f7432f70be7499cc7fb7bbd02bf7336e0c1ae4e0e3ef7cbfd214e960dfa92a15539dd859432d2dde062d2a12fba741839d2a02e3113699e1f1c77efd4144f3c75b90505f7598e57c48990a29031166bd57bceec91f13ec16e97e4212424544e4377ecf9dbd8825b5e226ca2c53488eb2d9be0bb35737975701dabde7d81e08306d67a8550f0574ca6ecaf4d341d15086866371e776fbccffd64889516fe290bce737715d06e89110dc9d74f373525a1944e8b2705588223ec5df5276d36ca0799c9a38e1e8c3c51426381f04561ab6bd8f46f34c63001e8e0aac768803790cdfb27555747e6b2872d0f039535b8ca9e9065a3711777431d268e772087ffba4bb5a845003e91b3fae826fa70f9469c509476c1ca830c8cd0bbf89137de169444b26e5143397178a7dde6c09e4eca60357e2a615dd928fef5fbd70e04a8892d653191e7324898fe4aeec1b270e0237197fdbcda37fc9e175beadfb0d3f8b0d45a910df21beef3d434cd49fd9400d5eb017e7fccc3d3e278b6881229b1087925fdb2199a10f3931fcca25037b38bcf86a2403834d578ee5fdef38cc46fec27b9af51910bae2865c6e9dd1f043fb635d10eb33f35c49b086338870460b5d66a553439442e4f273ebfc3c11e182a7f80ba66e0c99986386c8661d796c27eef4cd452d2215d6283c9ee4c10a3501afd996812e2222535042010d2ef136d72bba0c4b3653ef922e3b642df0fe9d2006590168c5c8a9a834eab118458c9b0b5bacd609a26b2a92db1d88f40de0c83259f172f304a818fff21b6d92020afa18f4c80dfa283bd8775b6bf85e9f4f05f2ebda90082c7ee045511012ae131755a2f83e32bed9b33feea976ea14368b0e8a7ab92940849b401725df192253e46deca8b6de1c2f3469d3c3caa5e32e912d6eabc609a6cbb6c1c7381c55f369ebaaa818b53bac9c945b0df65e17ebbaa3cce1060ca5385bee1dbcb23b8fa8d3acbcda28cf792e3d2d1040e5458ab8a1063055d5e8e88a31874e3c2ae8340591be07dbb40afee8de11427c175408ec92c73a445df4c2c708a79f550ac2f43749928d20fc000b3b2da6405825b8417107ba364559c671b0a3d5b1be76688b092af70d6e8dda011bca902fa8f402be6937f855b9c4cc8798b31915c709ade138f384e3c9eb34c4e991739fa3b8ab0e1221fa9ada87025df61ab9837dd8aa7c24390ef4a3360cb7d2efb4765beb11f3934b439895aa56777b70eb58fe57a868cb20068e0d35c48eef20936ecfcff4236c647814fad2ede912426321aefd08e04e51ef69baae0a28317eecd86abebc2f215ba9bfb5b27a5124a3837885e7af1497404f3db3060e33c9b1ca3db8d7324700a48c3a50834af920fb17c2e08e7d59c066d1ced56f99b6b79ea437e3241f679bce15921fb7f2ee25a21a665e7f4a8bf6966fc564c5a3eaca9cfea8eec85028980692de2c2fbc036bbd96d79fc9d782fe336f3b6a7a7e3492dea6c670aabcdbfbfd5dcbbeff165a31c4dd1c494f86917f19028129f56ff3292553f823451f86dfd24831259b849919a48730fdc24a071c3cdf56723cceded6f6aa2a6559c99b32a984a02f922f6cc06de5254b2f173858f26e1fb77d098346d17ff54b6d9046c5d61d271b78e8e8258c215ee9cee5363e5874e78780961f7d1bc45cdd4855140557285599f910de96c73fe8a463b72355eb8441cbd8c1367215fe8c9ba392954444e776e7280f23d6dc3047208577d7e0c73a092ef9d4d530c09d2d8c22f11e632eeb7231fda608707c9ae9ef65b29c64c0111d910aaa2013dd7acf6abe3f9a3451596c86f4d3c79009faf2c7570aa3f9c8e230a41a5e3c02a0228710dd96c537db3cf1e0373fc8426f1624b55b3a7b9c301d506823c30848d34a04d4073b62adc3ca58d886de43c81f94cb6b3ccebec36aa631</script></div><script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">æœ‰ä¸œè¥¿è¢«åŠ å¯†äº†, è¯·è¾“å…¥å¯†ç æŸ¥çœ‹.</summary>
    
    
    
    
    <category term="interview" scheme="https://awslzhang.top/tags/interview/"/>
    
  </entry>
  
  <entry>
    <title>Flinkå­¦ä¹ ç¬”è®°</title>
    <link href="https://awslzhang.top/2020/12/16/Flink%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <id>https://awslzhang.top/2020/12/16/Flink%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</id>
    <published>2020-12-16T12:29:56.000Z</published>
    <updated>2021-01-01T05:49:59.939Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Flink"><a href="#Flink" class="headerlink" title="Flink"></a>Flink</h1><h2 id="Flinkæ˜¯ä»€ä¹ˆ"><a href="#Flinkæ˜¯ä»€ä¹ˆ" class="headerlink" title="Flinkæ˜¯ä»€ä¹ˆ"></a>Flinkæ˜¯ä»€ä¹ˆ</h2><p>Apache Flink æ˜¯ä¸€ä¸ª<strong>æ¡†æ¶</strong>å’Œ<strong>åˆ†å¸ƒå¼å¤„ç†å¼•æ“</strong>ï¼Œç”¨äºå¯¹<strong>æ— ç•Œå’Œæœ‰ç•Œæ•°æ®æµ</strong>è¿›è¡Œ<strong>çŠ¶æ€</strong>è®¡ç®—ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œhdfsã€mapreduceã€hbaseåˆ†åˆ«æ˜¯å¯¹åº”googleçš„ä¸‰ç¯‡è®ºæ–‡æå‡ºçš„æŠ€æœ¯ï¼Œè€ŒFlinkä¹Ÿæ˜¯åŸºäºGoogleçš„dataflow modelæå‡ºçš„æŠ€æœ¯ã€‚</p><blockquote><p>æœ‰çŠ¶æ€ï¼šå¯¹è¾“å…¥è¿›è¡Œè®¡ç®—æ—¶ï¼Œè¦å’Œä¹‹å‰çš„è®¡ç®—ç»“æœå‘ç”Ÿå…³ç³»ã€‚</p><p>æ— çŠ¶æ€ï¼š<strong>å¹‚ç­‰æ€§ï¼Œæ¯æ¬¡è¾“å…¥ï¼Œè¾“å‡ºéƒ½ä¸€è‡´</strong>ã€‚</p><p>ç»“æœå‡†ç¡®æ€§ï¼šexactly-onceï¼Œåªå¤„ç†ä¸€æ¬¡</p></blockquote><h2 id="ä¸ºä»€ä¹ˆä½¿ç”¨Flink"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨Flink" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨Flink"></a>ä¸ºä»€ä¹ˆä½¿ç”¨Flink</h2><ul><li>æµæ‰¹æ•°æ®ç›¸åŒè®¡ç®—é€»è¾‘</li><li>ä½å»¶è¿Ÿï¼Œç›¸å¯¹äºSpark Streamingçš„å¾®æ‰¹æœ‰æ›´å°çš„å»¶è¿Ÿ</li><li>ç»“æœçš„å‡†ç¡®æ€§å’Œè‰¯å¥½çš„å®¹é”™æ€§</li></ul><h3 id="æ•°æ®å¤„ç†æ¶æ„çš„æ¼”å˜"><a href="#æ•°æ®å¤„ç†æ¶æ„çš„æ¼”å˜" class="headerlink" title="æ•°æ®å¤„ç†æ¶æ„çš„æ¼”å˜"></a>æ•°æ®å¤„ç†æ¶æ„çš„æ¼”å˜</h3><h4 id="äº‹åŠ¡å¤„ç†"><a href="#äº‹åŠ¡å¤„ç†" class="headerlink" title="äº‹åŠ¡å¤„ç†"></a>äº‹åŠ¡å¤„ç†</h4><p>æ‰€æœ‰çš„å­˜å‚¨å’Œè®¡ç®—éƒ½äº¤ç”±ä¸€ä¸ªDBMSæ¥å¤„ç†ï¼Œç„¶åé€šè¿‡å„ä¸ªç³»ç»Ÿæ¥å±•ç¤ºã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_20-47-35.png" alt="Snipaste_2020-12-16_20-47-35"></p><p>ç‰¹ç‚¹ï¼š</p><ul><li>å®æ—¶æ€§å¾ˆå¥½</li></ul><p>é—®é¢˜ï¼š</p><ul><li>èƒ½å¤ŸåŒæ—¶å¤„ç†çš„è¯·æ±‚æœ‰é™ï¼Œå½“æ•°æ®é‡å¤§ï¼Œè¯·æ±‚å¤šæ—¶å°±æ— æ³•å¤„ç†äº†</li></ul><h4 id="åˆ†æå¤„ç†"><a href="#åˆ†æå¤„ç†" class="headerlink" title="åˆ†æå¤„ç†"></a>åˆ†æå¤„ç†</h4><p>å°†æ•°æ®ä»ä¸šåŠ¡æ•°æ®åº“å¤åˆ¶åˆ°æ•°ä»“ï¼Œå†è¿›è¡Œåˆ†æå’ŒæŸ¥è¯¢</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_20-50-09.png" alt="Snipaste_2020-12-16_20-50-09"></p><p>ç‰¹ç‚¹ï¼š</p><ul><li>ä¸ç”¨åœ¨è”è¡¨æŸ¥è¯¢ï¼Œä¸æ€•é«˜å¹¶å‘</li></ul><p>é—®é¢˜ï¼š</p><ul><li>å®æ—¶æ€§åšä¸åˆ°</li></ul><h3 id="æµå¤„ç†æ¶æ„"><a href="#æµå¤„ç†æ¶æ„" class="headerlink" title="æµå¤„ç†æ¶æ„"></a>æµå¤„ç†æ¶æ„</h3><p>ä¸Šé¢çš„äº‹åŠ¡å¤„ç†å’Œåˆ†æå¤„ç†éƒ½æœ‰å„è‡ªçš„ä¼˜ç‚¹ï¼Œä½†æ˜¯æ²¡æœ‰åŒæ—¶æ»¡è¶³ä½å»¶è¿Ÿå’Œæ•°æ®æ­£ç¡®ã€‚</p><p>æ‰€ä»¥å‡ºç°äº†æµå¤„ç†ç»“æ„ï¼Œé€šè¿‡å°†æ•°æ®å­˜åœ¨æ•°æ®åº“ä¸­å˜ä¸ºå­˜åœ¨äºæµå¤„ç†çš„å†…å®¹ä¸­ï¼ˆæœ‰çŠ¶æ€ï¼‰ï¼Œå®šæ—¶æŒä¹…åŒ–åˆ°æœ¬åœ°ï¼Œå†…å­˜ä¸å¤Ÿçš„è¯ä½¿ç”¨é›†ç¾¤ï¼Œå°±èƒ½åŒæ—¶æ»¡è¶³ä½å»¶æ—¶å’Œé«˜ååã€‚</p><p>ä½†æ˜¯è¿™æ ·æœ‰ä¸ªç¼ºç‚¹ï¼Œå› ä¸ºä½¿ç”¨é›†ç¾¤å¤„ç†ï¼Œæ— æ³•ä¿è¯å„ä¸ªèŠ‚ç‚¹äº‹ä»¶çš„æœ‰åºæ€§ï¼Œè¿™æ ·å°±ä¼šå¯¹æœ€ç»ˆç»“æœé€ æˆåå·®ã€‚</p><p>è¿™æ—¶ï¼Œlambdaæ¶æ„é€šè¿‡ä¸¤å¥—å¤„ç†ç³»ç»Ÿï¼Œåˆ†åˆ«å¯¹ä½å»¶è¿Ÿå’Œæ•°æ®å‡†ç¡®æ€§åšå‡ºäº†ä¿éšœã€‚</p><h4 id="Lambdaæ¶æ„"><a href="#Lambdaæ¶æ„" class="headerlink" title="Lambdaæ¶æ„"></a>Lambdaæ¶æ„</h4><p>lambdaæ¶æ„ï¼šäº‹ä»¶æµæ—¢è¦è¿›è¡Œæµå¤„ç†ï¼ˆä½å»¶è¿Ÿï¼‰è¿˜è¦è¿›è¡Œæ‰¹å¤„ç†ï¼ˆä¿è¯å‡†ç¡®æ€§ï¼‰ï¼Œç”¨ä¸¤å¥—ç³»ç»Ÿä¿è¯ä½å»¶è¿Ÿå’Œç»“æœå‡†ç¡®ã€‚twitteræå‡º</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_20-59-21.png" alt="Snipaste_2020-12-16_20-59-21"></p><blockquote><p>ä¸ºä»€ä¹ˆè¿™é‡Œçš„æ‰¹å¤„ç†ç»“æœä¸å‡†ç¡®ï¼Ÿ</p><p><strong>æ—¶é—´æ­£ç¡®å¤„ç†/è¯­ä¹‰åŒ–çª—å£</strong>ï¼ˆæŒ‰ç…§äº‹ä»¶è§¦å‘æ—¶é—´è®¡ç®—ï¼Œä¸æ˜¯æŒ‰ç…§äº‹ä»¶åˆ°è¾¾æ—¶é—´è®¡ç®—ï¼‰ï¼Œåªæœ‰FLinkèƒ½åšåˆ°</p><p>ç¼ºç‚¹ï¼š</p><p>æµå¤„ç†è´Ÿè´£ä½å»¶è¿Ÿï¼Œæ•°æ®ä¸å‡†ç¡®ï¼›æ‰¹å¤„ç†è´Ÿè´£æ•°æ®å‡†ç¡®ã€‚<strong>ä½†å‡ ä¹å¤„ç†é€»è¾‘å¤§è‡´ç›¸åŒï¼Œå´å†™ä¸¤éã€‚</strong>ä¸å¥½</p></blockquote><blockquote><p><strong>æ—¶é—´æ­£ç¡®å¤„ç†/è¯­ä¹‰åŒ–çª—å£</strong></p><p>ï¼ˆæŒ‰ç…§äº‹ä»¶è§¦å‘æ—¶é—´è®¡ç®—ï¼Œä¸æ˜¯æŒ‰ç…§äº‹ä»¶åˆ°è¾¾æ—¶é—´è®¡ç®—ï¼‰</p><p>ä¾‹å¦‚ï¼Œç”±äºç½‘ç»œå»¶è¿Ÿï¼Œä¸€ä¸ªæ—¥å¿—æœ¬æ¥æ˜¯æ˜¨å¤©äº§ç”Ÿçš„ï¼Œç»“æœä»Šå¤©æ‰åˆ°è¾¾æœåŠ¡å™¨ã€‚</p><p>è¿™æ—¶ï¼Œsparkstreamä¼šè®¤ä¸ºå®ƒæ˜¯ä»Šå¤©çš„æ•°æ®ï¼Œå®ƒåªèƒ½æŒ‰ç…§å¤„ç†æ—¶é—´è®¡ç®—ã€‚è€Œflinkè®¤ä¸ºå®ƒæ˜¯æ˜¨å¤©çš„æ•°æ®ï¼Œå®ƒæŒ‰ç…§äº‹ä»¶æ—¶é—´è®¡ç®—ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201216114055114.png" alt="image-20201216114055114"></p><p><strong>ä¸Šå›¾æŸ¥çœ‹ç»“æœ</strong>ï¼Œåœ¨ssä¸­äº‹ä»¶æ”¾åœ¨äº†ä¸€ä¸ªä¸€åˆ†é’Ÿçš„çª—å£ä¸­ï¼Œè€Œäº‹ä»¶äº‹ä»¶å¹¶ä¸åœ¨ä¸€åˆ†é’Ÿä¹‹å†…ï¼Œæ‰€ä»¥å¾—çŸ¥ssæ˜¯è®¡ç®—å¤„ç†æ—¶é—´ã€‚è€ŒFlinkæ”¾åœ¨äº†2ä¸ªçª—å£ä¸­ï¼Œæ‰€ä»¥å®ƒä¸æ˜¯è®¡ç®—å¤„ç†æ—¶é—´ï¼Œè€Œæ˜¯è®¡ç®—äº‹ä»¶æœ¬èº«çš„æ—¶é—´ã€‚</p></blockquote><p><font color="red"><strong>æ‰€ä»¥ï¼ŒFlinkå‡ºç°äº†ï¼Œèƒ½åŒæ—¶å¤„ç†æ‰¹æµæ•°æ®çš„è®¡ç®—æ¡†æ¶ã€‚</strong></font></p><h2 id="Flinkç‰¹ç‚¹"><a href="#Flinkç‰¹ç‚¹" class="headerlink" title="Flinkç‰¹ç‚¹"></a>Flinkç‰¹ç‚¹</h2><ul><li>äº‹ä»¶é©±åŠ¨ï¼ˆäº‹ä»¶åˆ°è¾¾ï¼Œç«‹é©¬è®¡ç®—ï¼‰ï¼ˆSSä¸æ˜¯äº‹ä»¶é©±åŠ¨ï¼Œå› ä¸ºå®ƒæ˜¯å¾®æ‰¹ï¼Œæ”’å¤Ÿä¸€ä¸ªæ‰¹çš„äº‹ä»¶æ‰è®¡ç®—ï¼‰</li><li>æ—¶é—´æ­£ç¡®å¤„ç†/è¯­ä¹‰åŒ–çª—å£</li><li>exacly-once</li><li>æ¯«ç§’å»¶è¿Ÿ</li><li>é«˜å¯ç”¨</li><li>ä¸ä¼—å¤šå¸¸ç”¨å­˜å‚¨ç³»ç»Ÿçš„è¿æ¥</li></ul><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_21-07-39.png" alt="Snipaste_2020-12-16_21-07-39"></p><h2 id="vs-Spark-Streaming"><a href="#vs-Spark-Streaming" class="headerlink" title="vs Spark Streaming"></a>vs Spark Streaming</h2><ul><li>æµ(stream)å’Œå¾®æ‰¹(micro-batching)</li><li>æ•°æ®æ¨¡å‹ï¼ŒRDDä¸DataFlow</li><li>è¿è¡Œæ—¶æ¶æ„<ul><li>â€“spark æ˜¯æ‰¹è®¡ç®—ï¼Œå°† DAG åˆ’åˆ†ä¸ºä¸åŒçš„ stageï¼Œä¸€ä¸ªå®Œæˆåæ‰å¯ä»¥è®¡ç®—ä¸‹ä¸€ä¸ª</li><li>â€“flink æ˜¯æ ‡å‡†çš„æµæ‰§è¡Œæ¨¡å¼ï¼Œä¸€ä¸ªäº‹ä»¶åœ¨ä¸€ä¸ªèŠ‚ç‚¹å¤„ç†å®Œåå¯ä»¥ç›´æ¥å‘å¾€ä¸‹ä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œå¤„ç†</li></ul></li><li>shuffleåŒºåˆ«ğŸ”º<ul><li>Sparkæ˜¯æ‰¹å¤„ç†ï¼Œåœ¨shuffleæ—¶è¦ç­‰æ­¤stageçš„æ•°æ®å…¨éƒ¨è®¡ç®—å®Œæ¯•æ‰å¯ä»¥è¿›è¡Œshuffleæ´—ç‰Œï¼Œå¼€å§‹ä¸‹ä¸€ä¸ªstage</li><li>è€Œflinkæ˜¯æµå¤„ç†ï¼Œæ¯æ¬¡å¤„ç†å°±ä¸€å¼ ç‰Œï¼Œå®ƒçš„shuffleä¹Ÿå°±ä¸æ˜¯æ´—ç‰Œäº†ï¼Œè€Œæ˜¯å‘ç‰Œç»™ä¸‹ä¸€ä¸ªå­ä»»åŠ¡ï¼Œ<strong>ä¹Ÿä¸éœ€è¦ç­‰å¾…å…¶ä»–äº‹ä»¶çš„åˆ°è¾¾ã€‚</strong>flinkä¹Ÿæœ‰ä¸ªapiå«shuffleï¼Œå®ƒæ˜¯éšæœºå‘ç‰Œç»™ä¸‹ä¸€ä¸ªå­ä»»åŠ¡ï¼Œè€Œrebalanceæ˜¯è½®è¯¢å‘ç‰Œç»™ä¸‹ä¸€ä¸ªå­ä»»åŠ¡çš„åˆ†åŒºã€‚</li></ul></li></ul><h1 id="å¿«é€Ÿå¼€å§‹"><a href="#å¿«é€Ÿå¼€å§‹" class="headerlink" title="å¿«é€Ÿå¼€å§‹"></a>å¿«é€Ÿå¼€å§‹</h1><h2 id="åœ¨IDEAä¸­ç¼–å†™Flinkç¨‹åº"><a href="#åœ¨IDEAä¸­ç¼–å†™Flinkç¨‹åº" class="headerlink" title="åœ¨IDEAä¸­ç¼–å†™Flinkç¨‹åº"></a>åœ¨IDEAä¸­ç¼–å†™Flinkç¨‹åº</h2><p>æœ¬é¡¹ç›®ä½¿ç”¨çš„Flinkç‰ˆæœ¬ä¸ºæœ€æ–°ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯1.11.0ã€‚ç°åœ¨æä¾›mavené¡¹ç›®çš„é…ç½®æ–‡ä»¶ã€‚</p><ol><li>ä½¿ç”¨Intellij IDEAåˆ›å»ºä¸€ä¸ªMavenæ–°é¡¹ç›®</li><li>å‹¾é€‰<code>Create from archetype</code>ï¼Œç„¶åç‚¹å‡»<code>Add Archetype</code>æŒ‰é’®</li><li><code>GroupId</code>ä¸­è¾“å…¥<code>org.apache.flink</code>ï¼Œ<code>ArtifactId</code>ä¸­è¾“å…¥<code>flink-quickstart-scala</code>ï¼Œ<code>Version</code>ä¸­è¾“å…¥<code>1.11.0</code>ï¼Œç„¶åç‚¹å‡»<code>OK</code></li><li>ç‚¹å‡»å‘å³ç®­å¤´ï¼Œå‡ºç°ä¸‹æ‹‰åˆ—è¡¨ï¼Œé€‰ä¸­<code>flink-quickstart-scala:1.11.0</code>ï¼Œç‚¹å‡»<code>Next</code></li><li><code>Name</code>ä¸­è¾“å…¥<code>FlinkTutorial</code>ï¼Œ<code>GroupId</code>ä¸­è¾“å…¥<code>com.atguigu</code>ï¼Œ<code>ArtifactId</code>ä¸­è¾“å…¥<code>FlinkTutorial</code>ï¼Œç‚¹å‡»<code>Next</code></li><li>æœ€å¥½ä½¿ç”¨IDEAé»˜è®¤çš„Mavenå·¥å…·ï¼šBundledï¼ˆMaven 3ï¼‰ï¼Œç‚¹å‡»<code>Finish</code>ï¼Œç­‰å¾…ä¸€ä¼šå„¿ï¼Œé¡¹ç›®å°±åˆ›å»ºå¥½äº†</li></ol><p>ç¼–å†™<code>WordCount.scala</code>ç¨‹åº</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line">    <span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">object</span> <span class="title">StreamingJob</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">      <span class="comment">/** Main program method */</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) : <span class="type">Unit</span> = &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// get the execution environment</span></span><br><span class="line">        <span class="keyword">val</span> env: <span class="type">StreamExecutionEnvironment</span> = <span class="type">StreamExecutionEnvironment</span></span><br><span class="line">          .getExecutionEnvironment</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// get input data by connecting to the socket</span></span><br><span class="line">        <span class="keyword">val</span> text: <span class="type">DataStream</span>[<span class="type">String</span>] = env</span><br><span class="line">          .socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">9999</span>, &#x27;\n&#x27;)</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// parse the data, group it, window it, and aggregate the counts</span></span><br><span class="line">        <span class="keyword">val</span> windowCounts = text</span><br><span class="line">          .flatMap &#123; w =&gt; w.split(<span class="string">&quot;\\s&quot;</span>) &#125;</span><br><span class="line">          .map &#123; w =&gt; <span class="type">WordWithCount</span>(w, <span class="number">1</span>) &#125;</span><br><span class="line">          .keyBy(<span class="string">&quot;word&quot;</span>)</span><br><span class="line">          .timeWindow(<span class="type">Time</span>.seconds(<span class="number">5</span>))</span><br><span class="line">          .sum(<span class="string">&quot;count&quot;</span>)</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// print the results with a single thread, rather than in parallel</span></span><br><span class="line">        windowCounts</span><br><span class="line">          .print()</span><br><span class="line">          .setParallelism(<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">        env.execute(<span class="string">&quot;Socket Window WordCount&quot;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">      <span class="comment">/** Data type for words with count */</span></span><br><span class="line">      <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">WordWithCount</span>(<span class="params">word: <span class="type">String</span>, count: <span class="type">Long</span></span>)</span></span><br><span class="line"><span class="class">    &#125;</span></span><br></pre></td></tr></table></figure><p>æ‰“å¼€ä¸€ä¸ªç»ˆç«¯ï¼ˆTerminalï¼‰ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nc -lk 9999</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä½¿ç”¨<code>IDEA</code>è¿è¡Œå°±å¯ä»¥äº†ã€‚</p><h2 id="ä¸‹è½½Flinkè¿è¡Œæ—¶ç¯å¢ƒï¼Œæäº¤JaråŒ…çš„è¿è¡Œæ–¹å¼"><a href="#ä¸‹è½½Flinkè¿è¡Œæ—¶ç¯å¢ƒï¼Œæäº¤JaråŒ…çš„è¿è¡Œæ–¹å¼" class="headerlink" title="ä¸‹è½½Flinkè¿è¡Œæ—¶ç¯å¢ƒï¼Œæäº¤JaråŒ…çš„è¿è¡Œæ–¹å¼"></a>ä¸‹è½½Flinkè¿è¡Œæ—¶ç¯å¢ƒï¼Œæäº¤JaråŒ…çš„è¿è¡Œæ–¹å¼</h2><p>ä¸‹è½½é“¾æ¥ï¼š<a href="http://mirror.bit.edu.cn/apache/flink/flink-1.11.0/flink-1.11.0-bin-scala_2.11.tgz">http://mirror.bit.edu.cn/apache/flink/flink-1.11.0/flink-1.11.0-bin-scala_2.11.tgz</a></p><p>ç„¶åè§£å‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tar xvfz flink-1.11.0-bin-scala_2.11.tgz</span><br></pre></td></tr></table></figure><p>å¯åŠ¨Flinké›†ç¾¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> flink-1.11.0</span><br><span class="line">$ ./bin/start-cluster.sh</span><br></pre></td></tr></table></figure><p>å¯ä»¥æ‰“å¼€Flink WebUIæŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼š<a href="http://localhost:8081/">http://localhost:8081</a></p><p>åœ¨<code>IDEA</code>ä¸­ä½¿ç”¨<code>maven package</code>æ‰“åŒ…ã€‚</p><p>æäº¤æ‰“åŒ…å¥½çš„<code>JAR</code>åŒ…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> flink-1.11.0</span><br><span class="line">$ ./bin/flink run æ‰“åŒ…å¥½çš„JARåŒ…çš„ç»å¯¹è·¯å¾„</span><br></pre></td></tr></table></figure><p>åœæ­¢Flinké›†ç¾¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./bin/stop-cluster.sh</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æ ‡å‡†è¾“å‡ºæ—¥å¿—çš„ä½ç½®ï¼Œåœ¨<code>log</code>æ–‡ä»¶å¤¹ä¸­ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> flink-1.11.0/<span class="built_in">log</span></span><br></pre></td></tr></table></figure><h2 id="ç¨‹åºä¸æ•°æ®æµ"><a href="#ç¨‹åºä¸æ•°æ®æµ" class="headerlink" title="ç¨‹åºä¸æ•°æ®æµ"></a>ç¨‹åºä¸æ•°æ®æµ</h2><ul><li>æ‰€æœ‰çš„Flinkç¨‹åºéƒ½æ˜¯ç”±ä¸‰éƒ¨åˆ†ç»„æˆçš„ï¼š Source ã€Transformation å’Œ Sinkã€‚</li><li>Source è´Ÿè´£è¯»å–æ•°æ®æºï¼ŒTransformation åˆ©ç”¨å„ç§ç®—å­è¿›è¡Œå¤„ç†åŠ å·¥ï¼ŒSink è´Ÿè´£è¾“å‡º</li><li>åœ¨è¿è¡Œæ—¶ï¼ŒFlinkä¸Šè¿è¡Œçš„ç¨‹åºä¼šè¢«æ˜ å°„æˆâ€œé€»è¾‘æ•°æ®æµâ€ï¼ˆdataflowsï¼‰ï¼Œå®ƒåŒ…å«äº†è¿™ä¸‰éƒ¨åˆ†</li><li>æ¯ä¸€ä¸ªdataflowä»¥ä¸€ä¸ªæˆ–å¤šä¸ªsourceså¼€å§‹ä»¥ä¸€ä¸ªæˆ–å¤šä¸ªsinksç»“æŸã€‚dataflowç±»ä¼¼äºä»»æ„çš„æœ‰å‘æ— ç¯å›¾ï¼ˆDAGï¼‰</li><li>åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œç¨‹åºä¸­çš„è½¬æ¢è¿ç®—ï¼ˆtransformationsï¼‰è·Ÿdataflowä¸­çš„ç®—å­ï¼ˆoperatorï¼‰æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»</li></ul><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_23-32-45.png" alt="Snipaste_2020-12-16_23-32-45"></p><h1 id="Flinkè¿è¡Œæ¶æ„ğŸ”º"><a href="#Flinkè¿è¡Œæ¶æ„ğŸ”º" class="headerlink" title="Flinkè¿è¡Œæ¶æ„ğŸ”º"></a>Flinkè¿è¡Œæ¶æ„ğŸ”º</h1><h2 id="Flinkè¿è¡Œæ—¶ç»„ä»¶"><a href="#Flinkè¿è¡Œæ—¶ç»„ä»¶" class="headerlink" title="Flinkè¿è¡Œæ—¶ç»„ä»¶"></a>Flinkè¿è¡Œæ—¶ç»„ä»¶</h2><p>Flinkè¿è¡Œæ—¶æ¶æ„ä¸»è¦åŒ…æ‹¬å››ä¸ªä¸åŒçš„ç»„ä»¶ï¼Œå®ƒä»¬ä¼šåœ¨è¿è¡Œæµå¤„ç†åº”ç”¨ç¨‹åºæ—¶ååŒå·¥ä½œï¼šä½œä¸šç®¡ç†å™¨ï¼ˆJobManagerï¼‰ã€èµ„æºç®¡ç†å™¨ï¼ˆResourceManagerï¼‰ã€ä»»åŠ¡ç®¡ç†å™¨ï¼ˆTaskManagerï¼‰ï¼Œä»¥åŠåˆ†å‘å™¨ï¼ˆDispatcherï¼‰ã€‚å› ä¸ºFlinkæ˜¯ç”¨Javaå’ŒScalaå®ç°çš„ï¼Œæ‰€ä»¥æ‰€æœ‰ç»„ä»¶éƒ½ä¼šè¿è¡Œåœ¨Javaè™šæ‹Ÿæœºï¼ˆJVMsï¼‰ä¸Šã€‚</p><h3 id="ä½œä¸šç®¡ç†å™¨ï¼ˆJobManagerï¼‰"><a href="#ä½œä¸šç®¡ç†å™¨ï¼ˆJobManagerï¼‰" class="headerlink" title="ä½œä¸šç®¡ç†å™¨ï¼ˆJobManagerï¼‰"></a>ä½œä¸šç®¡ç†å™¨ï¼ˆJobManagerï¼‰</h3><p>ç±»ä¼¼äºSparkçš„Driverè¿›ç¨‹ï¼Œä¸€ä¸ªJobå°±å¯¹åº”è¿™ä¸€ä¸ªJobManagerã€‚</p><ul><li>æ§åˆ¶ä¸€ä¸ªåº”ç”¨ç¨‹åºæ‰§è¡Œçš„ä¸»è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªåº”ç”¨ç¨‹åºéƒ½ä¼šè¢«ä¸€ä¸ªä¸åŒçš„JobManager æ‰€æ§åˆ¶æ‰§è¡Œã€‚</li><li>JobManager ä¼šå…ˆæ¥æ”¶åˆ°è¦æ‰§è¡Œçš„åº”ç”¨ç¨‹åºï¼Œè¿™ä¸ªåº”ç”¨ç¨‹åºä¼šåŒ…æ‹¬ï¼šä½œä¸šå›¾ï¼ˆJobGraphï¼‰ã€é€»è¾‘æ•°æ®æµå›¾ï¼ˆlogical dataflow graphï¼‰å’Œæ‰“åŒ…äº†æ‰€æœ‰çš„ç±»ã€åº“å’Œå…¶å®ƒèµ„æºçš„JARåŒ…ã€‚</li><li>JobManager ä¼šæŠŠJobGraphè½¬æ¢æˆä¸€ä¸ªç‰©ç†å±‚é¢çš„æ•°æ®æµå›¾ï¼Œè¿™ä¸ªå›¾è¢«å«åšâ€œæ‰§è¡Œå›¾â€ï¼ˆExecutionGraphï¼‰ï¼ŒåŒ…å«äº†æ‰€æœ‰å¯ä»¥å¹¶å‘æ‰§è¡Œçš„ä»»åŠ¡ã€‚</li><li>JobManager ä¼šå‘èµ„æºç®¡ç†å™¨ï¼ˆResourceManagerï¼‰è¯·æ±‚æ‰§è¡Œä»»åŠ¡å¿…è¦çš„èµ„æºï¼Œä¹Ÿå°±æ˜¯ä»»åŠ¡ç®¡ç†å™¨ï¼ˆTaskManagerï¼‰ä¸Šçš„<strong>æ’æ§½ï¼ˆslotï¼‰</strong>ã€‚ä¸€æ—¦å®ƒè·å–åˆ°äº†è¶³å¤Ÿçš„èµ„æºï¼Œå°±ä¼šå°†æ‰§è¡Œå›¾åˆ†å‘åˆ°çœŸæ­£è¿è¡Œå®ƒä»¬çš„TaskManagerä¸Šã€‚è€Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒJobManagerä¼šè´Ÿè´£æ‰€æœ‰éœ€è¦ä¸­å¤®åè°ƒçš„æ“ä½œï¼Œ<strong>æ¯”å¦‚è¯´æ£€æŸ¥ç‚¹ï¼ˆcheckpointsï¼‰çš„åè°ƒã€‚</strong></li></ul><h4 id="æ‰§è¡Œå›¾ï¼ˆExecutionGraphï¼‰ğŸ”º"><a href="#æ‰§è¡Œå›¾ï¼ˆExecutionGraphï¼‰ğŸ”º" class="headerlink" title="æ‰§è¡Œå›¾ï¼ˆExecutionGraphï¼‰ğŸ”º"></a>æ‰§è¡Œå›¾ï¼ˆExecutionGraphï¼‰ğŸ”º</h4><p>Flink ä¸­çš„æ‰§è¡Œå›¾å¯ä»¥åˆ†æˆå››å±‚ï¼šStreamGraph -&gt; JobGraph -&gt; ExecutionGraph -&gt; ç‰©ç†æ‰§è¡Œå›¾</p><ol><li>StreamGraphï¼šæ˜¯æ ¹æ®ç”¨æˆ·é€šè¿‡ Stream API ç¼–å†™çš„ä»£ç ç”Ÿæˆçš„æœ€åˆçš„å›¾ã€‚ç”¨æ¥è¡¨ç¤ºç¨‹åºçš„æ‹“æ‰‘ç»“æ„ã€‚</li><li>JobGraphï¼šStreamGraphç»è¿‡ä¼˜åŒ–åç”Ÿæˆäº† JobGraphï¼Œæäº¤ç»™ JobManager çš„æ•°æ®ç»“æ„ã€‚ä¸»è¦çš„ä¼˜åŒ–ä¸ºï¼Œ<strong>å°†å¤šä¸ªç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹ chain åœ¨ä¸€èµ·ä½œä¸ºä¸€ä¸ªèŠ‚ç‚¹</strong>ï¼Œé¿å…åœ¨ä¸åŒçš„slotè€Œè¿›è¡Œç½‘ç»œIOã€‚</li><li>ExecutionGraphï¼šJobManager æ ¹æ® JobGraph ç”ŸæˆExecutionGraphã€‚ExecutionGraphæ˜¯JobGraphçš„å¹¶è¡ŒåŒ–ç‰ˆæœ¬ï¼Œæ˜¯è°ƒåº¦å±‚æœ€æ ¸å¿ƒçš„æ•°æ®ç»“æ„ã€‚</li><li>ç‰©ç†æ‰§è¡Œå›¾ï¼šJobManager æ ¹æ® ExecutionGraph å¯¹ Job è¿›è¡Œè°ƒåº¦åï¼Œåœ¨å„ä¸ªTaskManager ä¸Šéƒ¨ç½² Task åå½¢æˆçš„â€œå›¾â€ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„æ•°æ®ç»“æ„ã€‚</li></ol><p><strong>æµç¨‹å›¾å®ä¾‹</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/sdkkfkasd.png" alt="sdkkfkasd"></p><ul><li>StreamGraph-&gt;JobGraphæ—¶ï¼Œæœ€åä¸¤ä¸ªåˆå¹¶äº†ï¼Œæ˜¯å› ä¸ºå®ƒä»¬ä¹‹é—´æ²¡æœ‰shuffleå¹¶ä¸”ç›¸åŒå¹¶è¡Œåº¦ï¼Œæ‰€ä»¥ä¸²ä¸ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œé¿å…å®ƒä»¬ä¸åœ¨ä¸€ä¸ªslotä¸­å¯èƒ½å¯¼è‡´çš„ç½‘ç»œä¼ è¾“</li><li>JobGraph-&gt;ExecutionGraphï¼Œè¿™æ˜¯ç”±Job Managerå®Œæˆçš„ï¼Œå®ƒå±•ç¤ºäº†å¹¶è¡Œçš„ä»»åŠ¡<ul><li><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-17_20-19-52.png" alt="Snipaste_2020-12-17_20-19-52"></li></ul></li></ul><p>æ‰€ä»¥æœ€åå„ä¸ªå­ä»»åŠ¡åœ¨TaskMangerä¸Šçš„åˆ†å¸ƒå¯èƒ½æ˜¯ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_23-46-12.png" alt="Snipaste_2020-12-16_23-46-12"></p><blockquote><p>æ‰å¹³çš„é•¿æ–¹å½¢æŒ‡çš„æ˜¯slot</p></blockquote><h4 id="ä»»åŠ¡é“¾ï¼ˆOperator-Chainsï¼‰ğŸ”º"><a href="#ä»»åŠ¡é“¾ï¼ˆOperator-Chainsï¼‰ğŸ”º" class="headerlink" title="ä»»åŠ¡é“¾ï¼ˆOperator Chainsï¼‰ğŸ”º"></a>ä»»åŠ¡é“¾ï¼ˆOperator Chainsï¼‰ğŸ”º</h4><p>GraphèŠ‚ç‚¹åˆå¹¶è§„åˆ™-Operator Chains</p><ul><li>Flink é‡‡ç”¨äº†ä¸€ç§ç§°ä¸ºä»»åŠ¡é“¾çš„ä¼˜åŒ–æŠ€æœ¯ï¼Œ<font color="red"><strong>å¯ä»¥åœ¨ç‰¹å®šæ¡ä»¶ä¸‹å‡å°‘æœ¬åœ°é€šä¿¡çš„å¼€é”€</strong></font>ã€‚ä¸ºäº†æ»¡è¶³ä»»åŠ¡é“¾çš„è¦æ±‚<strong>ï¼Œå¿…é¡»å°†ä¸¤ä¸ªæˆ–å¤šä¸ªç®—å­è®¾ä¸ºç›¸åŒçš„å¹¶è¡Œåº¦ï¼Œå¹¶é€šè¿‡æœ¬åœ°è½¬å‘ï¼ˆlocal forwardï¼‰çš„æ–¹å¼è¿›è¡Œè¿æ¥</strong></li><li><strong>ç›¸åŒå¹¶è¡Œåº¦</strong>çš„ <strong>one-to-one</strong>(ç»´æŠ¤åˆ†åŒºå†…æ•°æ®æœ‰åº) æ“ä½œï¼ŒFlink è¿™æ ·ç›¸è¿çš„ç®—å­é“¾æ¥åœ¨ä¸€èµ·å½¢æˆä¸€ä¸ª taskï¼ŒåŸæ¥çš„ç®—å­æˆä¸ºé‡Œé¢çš„ subtask</li><li>å¹¶è¡Œåº¦ç›¸åŒã€å¹¶ä¸”æ˜¯ one-to-one æ“ä½œï¼Œä¸¤ä¸ªæ¡ä»¶ç¼ºä¸€ä¸å¯</li></ul><hr><blockquote><p>åœ¨ä»£ç ç¼–è¯‘è¿‡ç¨‹ä¸­ä¼šå°†streamGarphå˜ä¸ºJobGraphï¼Œå…¶ä¸­ä¼šå°†å¤šä¸ªç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹ chain åœ¨ä¸€èµ·ä½œä¸ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p><p>å› ä¸ºæŠŠå®ƒä»¬æ”¾åœ¨ä¸€ä¸ªèŠ‚ç‚¹å®ƒä»¬æœ€ç»ˆä¼šåœ¨ä¸€ä¸ªslotä¸­è¿è¡Œï¼Œè¿™æ—¶å®ƒä»¬ä¹‹é—´æ•°æ®ä¼ é€’ä¼šèµ°æœ¬åœ°æ–¹å¼è¿æ¥ï¼Œå¦‚æœä¸æ”¾åœ¨ä¸€èµ·ï¼Œåˆ™æœ‰å¯èƒ½ä¼šå‡ºç°å®ƒä»¬èŠ‚ç‚¹åœ¨ä¸åŒçš„slotä¸­æ‰§è¡Œï¼Œå¿…ç„¶é€ æˆçº¿ç¨‹é—´æ•°æ®è¿æ¥æˆ–è€…ä¸åŒçš„job managerä¸­çš„sloté—´ç½‘ç»œæ•°æ®è¿æ¥ã€‚æ•ˆç‡ä½ä¸‹ã€‚</p></blockquote><p>æ‰€ä»¥ï¼Œå„ä¸ªå­ä»»åŠ¡çš„å¹¶è¡Œåº¦æœ€å¥½ä¸€è‡´ï¼Œå› ä¸ºåœ¨ç›¸åŒslotä¸­æ‰§è¡Œä½¿ç”¨æœ¬åœ°çº¿ç¨‹ä¼ è¾“ä¼šæ¯”å¯èƒ½çš„ç½‘ç»œä¼ è¾“æœ‰æ•ˆç‡ã€‚ä¸¾ä¸€ä¸ªåé¢æ•™æï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-17_20-25-35.png" alt="Snipaste_2020-12-17_20-25-35"></p><p>ç”±å›¾å¾—çŸ¥ï¼Œé™¤äº†CEå‰©ä¸‹çš„éƒ½æ˜¯å¹¶è¡Œåº¦4ã€‚å¹¶ä¸”Cå’ŒDä¹‹é—´æ˜¯shuffleï¼Œè€ŒDå’ŒEä¹‹é—´ä¸æ˜¯shuffleã€‚</p><p>è¿™ä¸ªå›¾å”¯ä¸€èƒ½ä¼˜åŒ–çš„åœ°æ–¹å°±æ˜¯Eçš„å¹¶è¡Œåº¦ï¼Œå¦‚æœæŠŠå®ƒçš„å¹¶è¡Œåº¦è®¾ä¸º4ï¼Œåˆ™D-Eä¹‹åèµ°slotæœ¬åœ°ä¼ è¾“ï¼Œè€Œä¸ä¼šè·¨slotä¼ è¾“ï¼›è‡³äºCï¼Œå› ä¸ºc-dæ˜¯shuffleï¼Œæ‰€ä»¥Cçš„å¹¶è¡Œåº¦åœ¨è¿™é‡Œä¸é‡è¦ã€‚</p><p><font color="red">ä½†æ˜¯æœ€å¥½å„ä¸ªå­ä»»åŠ¡çš„å¹¶è¡Œåº¦æœ€å¥½ä¸€è‡´ã€‚</font></p><h5 id="ä»»åŠ¡é“¾ç¦ç”¨"><a href="#ä»»åŠ¡é“¾ç¦ç”¨" class="headerlink" title="ä»»åŠ¡é“¾ç¦ç”¨"></a>ä»»åŠ¡é“¾ç¦ç”¨</h5><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-17_22-14-42.png" alt="Snipaste_2020-12-17_22-14-42"></p><p>æ ¹æ®é»˜è®¤è§„åˆ™ä¸Šå›¾çš„keyå’Œsinkæ˜¯è¦åˆå¹¶çš„ï¼Œä½†æ˜¯æˆ‘å°±æ˜¯ä¸åƒè®©å®ƒåˆå¹¶ï¼Œå¯ä»¥å‚è€ƒçš„æ–¹æ³•æœ‰ï¼š</p><ol><li>åœ¨keyåæ‰‹åŠ¨é‡åˆ†åŒº(rebalance|shuffle)</li><li>å•ç‹¬ä¸ºkeyæ“ä½œè®¾ç½®<code>disableChaining</code>ï¼Œè¿™æ ·keyå‰åéƒ½ä¸ä¼šå‚ä¸åˆå¹¶</li><li>æŠ›å¼€æ­¤å›¾æ¥è®²ï¼Œkeyå’Œå‰åéƒ½æ˜¯åˆå¹¶çŠ¶æ€ï¼Œå¦‚æœæƒ³è®©keyå’Œå‰é¢æ–­å¼€å’Œåè¾¹åˆå¹¶ï¼Œå¯ä»¥å•ç‹¬ä¸ºkeyè®¾ç½®<code>.startNewChain</code></li><li>å¦‚æœç›´æ¥ä¸ºæ­¤å›¾ç¦ç”¨åˆå¹¶Chainï¼Œåˆ™ç›´æ¥åœ¨ç¯å¢ƒå¤„<code>.disableChaining</code></li></ol><h3 id="ä»»åŠ¡ç®¡ç†å™¨ï¼ˆTaskManagerï¼‰"><a href="#ä»»åŠ¡ç®¡ç†å™¨ï¼ˆTaskManagerï¼‰" class="headerlink" title="ä»»åŠ¡ç®¡ç†å™¨ï¼ˆTaskManagerï¼‰"></a>ä»»åŠ¡ç®¡ç†å™¨ï¼ˆTaskManagerï¼‰</h3><p>ç±»ä¼¼äºSparkçš„Executorè¿›ç¨‹ã€‚</p><ul><li>Flinkä¸­çš„å·¥ä½œè¿›ç¨‹ã€‚é€šå¸¸åœ¨Flinkä¸­ä¼šæœ‰å¤šä¸ªTaskManagerè¿è¡Œï¼Œæ¯ä¸€ä¸ªTaskManageréƒ½åŒ…å«äº†ä¸€å®šæ•°é‡çš„æ’æ§½ï¼ˆslotsï¼‰ã€‚æ’æ§½çš„æ•°é‡é™åˆ¶äº†TaskManagerèƒ½å¤Ÿæ‰§è¡Œçš„ä»»åŠ¡æ•°é‡ã€‚</li><li>å¯åŠ¨ä¹‹åï¼ŒTaskManagerä¼šå‘èµ„æºç®¡ç†å™¨æ³¨å†Œå®ƒçš„æ’æ§½ï¼›æ”¶åˆ°èµ„æºç®¡ç†å™¨çš„æŒ‡ä»¤åï¼ŒTaskManagerå°±ä¼šå°†ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ’æ§½æä¾›ç»™JobManagerè°ƒç”¨ã€‚JobManagerå°±å¯ä»¥å‘æ’æ§½åˆ†é…ä»»åŠ¡ï¼ˆtasksï¼‰æ¥æ‰§è¡Œäº†ã€‚</li><li>åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªTaskManagerå¯ä»¥è·Ÿå…¶å®ƒè¿è¡ŒåŒä¸€åº”ç”¨ç¨‹åºçš„TaskManageräº¤æ¢æ•°æ®ã€‚</li></ul><blockquote><p>TaskManageræ˜¯è¿›ç¨‹ï¼›slotæ˜¯çº¿ç¨‹ï¼›</p></blockquote><h4 id="TaskManager-å’Œ-SlotsğŸ”º"><a href="#TaskManager-å’Œ-SlotsğŸ”º" class="headerlink" title="TaskManager å’Œ SlotsğŸ”º"></a>TaskManager å’Œ SlotsğŸ”º</h4><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_23-07-10.png" alt="Snipaste_2020-12-16_23-07-10"></p><ul><li>Flink ä¸­æ¯ä¸€ä¸ª TaskManager éƒ½æ˜¯ä¸€ä¸ªJVMè¿›ç¨‹ï¼Œå®ƒå¯èƒ½ä¼šåœ¨ç‹¬ç«‹çš„çº¿ç¨‹ä¸Šæ‰§è¡Œä¸€ä¸ªæˆ–å¤šä¸ªå­ä»»åŠ¡</li><li>ä¸ºäº†æ§åˆ¶ä¸€ä¸ª TaskManager èƒ½æ¥æ”¶å¤šå°‘ä¸ª taskï¼Œ TaskManager é€šè¿‡ task slot æ¥è¿›è¡Œæ§åˆ¶ï¼ˆä¸€ä¸ª TaskManager è‡³å°‘æœ‰ä¸€ä¸ª slotï¼‰</li><li>Task Slot æ˜¯é™æ€çš„æ¦‚å¿µï¼Œæ˜¯æŒ‡ TaskManager å…·æœ‰çš„å¹¶å‘æ‰§è¡Œèƒ½åŠ› </li></ul><blockquote><p><font color="red"><strong>å…±äº«slot</strong></font></p><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒFlink å…è®¸å­ä»»åŠ¡å…±äº« slotï¼Œå­ä»»åŠ¡å³åŒä¸€Jobçš„ä¸åŒæ“ä½œã€‚ è¿™æ ·çš„ç»“æœæ˜¯ï¼Œä¸€ä¸ª slot å¯ä»¥ä¿å­˜ä½œä¸šçš„æ•´ä¸ªç®¡é“ã€‚(å½“æ­¤Jobè®¾ç½®å…¨å±€å¹¶è¡Œåº¦ä¸º1æ—¶,å³<code>env.setParallelism(1)</code>)</p><p>æ­¤å›¾å°±æ˜¯ä¸€ä¸ªslotä¿å­˜äº†æ•´ä¸ªä½œä¸šçš„å¤„ç†é€»è¾‘ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_23-19-17.png" alt="Snipaste_2020-12-16_23-19-17"></p><p>å¦‚æœæƒ³ä¸ç”¨å…±äº«soltï¼Œå¯ä»¥ä¸ºä¸åŒçš„å­ä»»åŠ¡è®¾ç½®ä¸åŒçš„å…±äº«ç»„(slotSharingGroup)ã€‚</p><p>å¦‚æœç¦ç”¨äº†å…±äº«slotä¹‹åï¼Œåˆ™å¹¶è¡Œåº¦å’Œslotä½¿ç”¨çš„è®¡ç®—æ–¹å¼å·²ç»ä¸æ˜¯ä¸‹é¢çš„è®¡ç®—æ–¹å¼ã€‚é¦–å…ˆæŒ‰ç…§åˆ†ç»„è®¡ç®—å„ä¸ªå­ä»»åŠ¡çš„æœ€å¤§å¹¶è¡Œåº¦ï¼Œ<strong>ç„¶åä¸åŒç»„ä¹‹é—´çš„æœ€å¤§ç›¸åŠ ã€‚</strong></p></blockquote><h4 id="å¹¶è¡Œåº¦æµ‹è¯•ğŸ”º"><a href="#å¹¶è¡Œåº¦æµ‹è¯•ğŸ”º" class="headerlink" title="å¹¶è¡Œåº¦æµ‹è¯•ğŸ”º"></a>å¹¶è¡Œåº¦æµ‹è¯•ğŸ”º</h4><p>ä»£ç ä¸­å¯ä»¥é€šè¿‡<code>env.setParallelism(1)</code>è®¾ç½®Jobé»˜è®¤å¹¶è¡Œåº¦ï¼Œ<strong>ä½†æ˜¯æ¯ä¸ªå­ä»»åŠ¡éƒ½æœ‰è‡ªå·±çš„å¹¶è¡Œåº¦</strong>ï¼Œæ‰€ä»¥ï¼Œ<font color="red"><strong>ä¸€ä¸ªStreamæœ€åçš„å¹¶è¡Œåº¦ï¼ˆå³æœ€åéœ€è¦çš„slotï¼‰è¦ç»¼åˆå„ä¸ªç®—å­ï¼Œä¸€èˆ¬(æ²¡æœ‰è®¾ç½®ä¸åŒçš„å…±äº«ç»„)å¯ä»¥è®¤ä¸ºå°±æ˜¯å…¶æ‰€æœ‰ç®—å­ä¸­æœ€å¤§çš„å¹¶è¡Œåº¦ã€‚</strong></font>ï¼ˆå› ä¸ºå…±äº«slotçš„å­˜åœ¨ï¼Œä½¿å¾—åŒä¸€ä»»åŠ¡çš„ä¸åŒå­ä»»åŠ¡å¯ä»¥å…±äº«slotï¼Œæ‰€ä»¥åªéœ€è¦å…¶æ‰€æœ‰ç®—å­ä¸­æœ€å¤§çš„å¹¶è¡Œåº¦ã€‚ï¼‰</p><blockquote><p>ä¸€ä¸ªç‰¹å®šç®—å­çš„ å­ä»»åŠ¡ï¼ˆsubtaskï¼‰çš„ä¸ªæ•°è¢«ç§°ä¹‹ä¸ºå…¶å¹¶è¡Œåº¦ï¼ˆparallelismï¼‰</p></blockquote><p>å¦‚æœè®¾ç½®äº†ä¸åŒçš„å…±äº«ç»„(slotSharingGroup)ï¼Œåˆ™è®¡ç®—æ–¹æ³•ä¸æ˜¯ä¸Šé¢çš„è®¡ç®—æ–¹æ³•ï¼Œè€Œæ˜¯æ¯ä¸ªç»„å†…éƒ½è¦ä½¿ç”¨ä¸Šé¢çš„è®¡ç®—æ–¹æ³•ï¼Œå¹¶ä¸”ä¸åŒçš„ç»„ç›¸åŠ <strong>ï¼ˆå› ä¸ºå…±äº«ç»„ä¹‹é—´çš„ä»»åŠ¡ä¸èƒ½å…±äº«slotï¼Œæ¯”å¦‚2ç»„çš„ä»»åŠ¡ä¸èƒ½åˆ°1ç»„çš„slotæ‰§è¡Œï¼‰</strong>ã€‚æœ€åçš„æ•°å°±æ˜¯æ­¤Jobæœ€ç»ˆä¼šæ¶ˆè€—çš„slotæ•°ç›®ã€‚</p><p><strong>ä¾‹å¦‚ä»¥ä¸‹ä»£ç ï¼š</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> text: <span class="type">DataStream</span>[<span class="type">String</span>] = env</span><br><span class="line">  .socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">9999</span>, &#x27;\n&#x27;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// parse the data, group it, window it, and aggregate the counts</span></span><br><span class="line"><span class="keyword">val</span> windowCounts = text</span><br><span class="line">  .flatMap &#123; w =&gt; w.split(<span class="string">&quot;\\s&quot;</span>) &#125;.slotSharingGroup(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">  .map &#123; w =&gt; <span class="type">WordWithCount</span>(w, <span class="number">1</span>) &#125;</span><br><span class="line">  .keyBy(<span class="string">&quot;word&quot;</span>)</span><br><span class="line">  .sum(<span class="string">&quot;count&quot;</span>).setParallelism(<span class="number">2</span>).slotSharingGroup(<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// print the results with a single thread, rather than in parallel</span></span><br><span class="line">windowCounts</span><br><span class="line">  .print()</span><br><span class="line">  .setParallelism(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆæ¶ˆè€—4ä¸ªslotï¼Œè®¡ç®—æ˜ç»†å¦‚ä¸‹ï¼š</p><ul><li>defalutç»„ï¼šæœ€å¤§å¹¶è¡Œ1</li><li>1ç»„ï¼šæœ€å¤§å¹¶è¡Œ1</li><li>2ç»„ï¼šæœ€å¤§å¹¶è¡Œ2</li></ul><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-17_22-28-59.png" alt="Snipaste_2020-12-17_22-28-59"></p><p><strong>ä¸¾ä¾‹è¯´æ˜</strong></p><p>ç°æœ‰3ä¸ªTaskManagerï¼Œæ¯ä¸ªTaskManageræœ‰3ä¸ªslotã€‚</p><p><strong>1. Parallelism=1</strong></p><p>æ‰€æœ‰çš„å­ä»»åŠ¡éƒ½åœ¨ä¸€ä¸ªslotä¸­ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_23-27-06.png" alt="Snipaste_2020-12-16_23-27-06"></p><p><strong>2. Parallelism=9</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_23-27-42.png" alt="Snipaste_2020-12-16_23-27-42"></p><p><strong>3. æ€»ä½“ä¸º9ï¼Œä½†æ˜¯å•ç‹¬ä¸ºSinkè®¾ç½®ä¸º1</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_23-28-43.png" alt="Snipaste_2020-12-16_23-28-43"></p><hr><h3 id="èµ„æºç®¡ç†å™¨ï¼ˆResourceManagerï¼‰"><a href="#èµ„æºç®¡ç†å™¨ï¼ˆResourceManagerï¼‰" class="headerlink" title="èµ„æºç®¡ç†å™¨ï¼ˆResourceManagerï¼‰"></a>èµ„æºç®¡ç†å™¨ï¼ˆResourceManagerï¼‰</h3><ul><li>ä¸»è¦è´Ÿè´£ç®¡ç†ä»»åŠ¡ç®¡ç†å™¨ï¼ˆTaskManagerï¼‰çš„æ’æ§½ï¼ˆslotï¼‰ï¼ŒTaskManger æ’æ§½æ˜¯Flinkä¸­å®šä¹‰çš„å¤„ç†èµ„æºå•å…ƒã€‚</li><li>Flinkä¸ºä¸åŒçš„ç¯å¢ƒå’Œèµ„æºç®¡ç†å·¥å…·æä¾›äº†ä¸åŒèµ„æºç®¡ç†å™¨ï¼Œæ¯”å¦‚YARNã€Mesosã€K8sï¼Œä»¥åŠstandaloneéƒ¨ç½²ã€‚</li><li>å½“JobManagerç”³è¯·æ’æ§½èµ„æºæ—¶ï¼ŒResourceManagerä¼šå°†æœ‰ç©ºé—²æ’æ§½çš„TaskManageråˆ†é…ç»™JobManagerã€‚å¦‚æœResourceManageræ²¡æœ‰è¶³å¤Ÿçš„æ’æ§½æ¥æ»¡è¶³JobManagerçš„è¯·æ±‚ï¼Œå®ƒè¿˜å¯ä»¥å‘èµ„æºæä¾›å¹³å°å‘èµ·ä¼šè¯ï¼Œä»¥æä¾›å¯åŠ¨TaskManagerè¿›ç¨‹çš„å®¹å™¨ã€‚</li></ul><h3 id="åˆ†å‘å™¨ï¼ˆDispatcherï¼‰"><a href="#åˆ†å‘å™¨ï¼ˆDispatcherï¼‰" class="headerlink" title="åˆ†å‘å™¨ï¼ˆDispatcherï¼‰"></a>åˆ†å‘å™¨ï¼ˆDispatcherï¼‰</h3><ul><li><p>å¯ä»¥è·¨ä½œä¸šè¿è¡Œï¼Œå®ƒä¸ºåº”ç”¨æäº¤æä¾›äº†RESTæ¥å£ã€‚</p></li><li><p>å½“ä¸€ä¸ªåº”ç”¨è¢«æäº¤æ‰§è¡Œæ—¶ï¼Œåˆ†å‘å™¨å°±ä¼šå¯åŠ¨å¹¶å°†åº”ç”¨ç§»äº¤ç»™ä¸€ä¸ªJobManagerã€‚</p></li><li><p>Dispatcherä¹Ÿä¼šå¯åŠ¨ä¸€ä¸ªWeb UIï¼Œç”¨æ¥æ–¹ä¾¿åœ°å±•ç¤ºå’Œç›‘æ§ä½œä¸šæ‰§è¡Œçš„ä¿¡æ¯ã€‚</p></li><li><p>Dispatcheråœ¨æ¶æ„ä¸­å¯èƒ½å¹¶ä¸æ˜¯å¿…éœ€çš„ï¼Œè¿™å–å†³äºåº”ç”¨æäº¤è¿è¡Œçš„æ–¹å¼ã€‚</p></li></ul><p>åœ¨UIæäº¤ä»»åŠ¡æ—¶çš„å…¥å£ã€‚</p><h2 id="ä»»åŠ¡æäº¤æµç¨‹"><a href="#ä»»åŠ¡æäº¤æµç¨‹" class="headerlink" title="ä»»åŠ¡æäº¤æµç¨‹"></a>ä»»åŠ¡æäº¤æµç¨‹</h2><h3 id="UI"><a href="#UI" class="headerlink" title="UI"></a>UI</h3><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_22-58-39.png" alt="Snipaste_2020-12-16_22-58-39"></p><h3 id="Yarn"><a href="#Yarn" class="headerlink" title="Yarn"></a>Yarn</h3><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_23-00-28.png" alt="Snipaste_2020-12-16_23-00-28"></p><h2 id="ä»»åŠ¡è°ƒåº¦åŸç†"><a href="#ä»»åŠ¡è°ƒåº¦åŸç†" class="headerlink" title="ä»»åŠ¡è°ƒåº¦åŸç†"></a>ä»»åŠ¡è°ƒåº¦åŸç†</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-16_23-01-44.png" alt="Snipaste_2020-12-16_23-01-44"></p><p>keybyä¹‹åä¸ºä»€ä¹ˆæ²¡æœ‰åˆ†ç»„[]ï¼Œæ˜¯é€»è¾‘åˆ†ç»„ï¼Œå› ä¸ºå®ƒæ˜¯æµå¤„ç†æ¥ä¸€ä¸ªå¤„ç†ä¸€ä¸ªï¼Œæ‰€ä»¥åªå¯¹äº‹ä»¶è¿›è¡Œæ‰“æ ‡æ ‡æ˜æ˜¯å“ªä¸ªç»„ï¼Œç„¶ååªå¤„ç†ä¸€æ¡äº‹ä»¶ã€‚ä¸Sparkä¸åŒï¼ŒSparkæ˜¯æ‰¹å¤„ç†ï¼Œæ‰€ä»¥åˆ†ç»„åä¼šæ˜¯key,[event]çš„æ•°æ®</p><p>æ»šåŠ¨èšåˆåä¼šå˜ä¸ºDataStreamï¼›æ»šåŠ¨èšåˆä¼šå­˜æ”¾ä¸€ä¸ªçŠ¶æ€ï¼Œæ¯å½“æ•°æ®æ»šåŠ¨ï¼ˆæ•°æ®æµå¢åŠ æ—¶ï¼‰ä¼šå’ŒçŠ¶æ€ï¼ˆä¸€ä¸ªkeyä¸€ä¸ªçŠ¶æ€ï¼‰è¿›è¡Œè®¡ç®—ï¼Œå¾—å‡ºä¸‹ä¸€ä¸ªçŠ¶æ€ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Flink&quot;&gt;&lt;a href=&quot;#Flink&quot; class=&quot;headerlink&quot; title=&quot;Flink&quot;&gt;&lt;/a&gt;Flink&lt;/h1&gt;&lt;h2 id=&quot;Flinkæ˜¯ä»€ä¹ˆ&quot;&gt;&lt;a href=&quot;#Flinkæ˜¯ä»€ä¹ˆ&quot; class=&quot;headerlink&quot; titl</summary>
      
    
    
    
    <category term="Flink" scheme="https://awslzhang.top/categories/Flink/"/>
    
    
    <category term="Flink" scheme="https://awslzhang.top/tags/Flink/"/>
    
  </entry>
  
  <entry>
    <title>k8sé›†ç¾¤ç›‘æ§ã€é«˜å¯ç”¨ä»¥åŠéƒ¨ç½²è‡ªå»ºJavaé¡¹ç›®</title>
    <link href="https://awslzhang.top/2020/12/06/k8s%E9%9B%86%E7%BE%A4%E7%9B%91%E6%8E%A7%E3%80%81%E9%AB%98%E5%8F%AF%E7%94%A8%E4%BB%A5%E5%8F%8A%E9%83%A8%E7%BD%B2%E8%87%AA%E5%BB%BAJava%E9%A1%B9%E7%9B%AE/"/>
    <id>https://awslzhang.top/2020/12/06/k8s%E9%9B%86%E7%BE%A4%E7%9B%91%E6%8E%A7%E3%80%81%E9%AB%98%E5%8F%AF%E7%94%A8%E4%BB%A5%E5%8F%8A%E9%83%A8%E7%BD%B2%E8%87%AA%E5%BB%BAJava%E9%A1%B9%E7%9B%AE/</id>
    <published>2020-12-06T01:26:41.000Z</published>
    <updated>2021-01-01T05:50:00.027Z</updated>
    
    <content type="html"><![CDATA[<h1 id="k8sé›†ç¾¤ç›‘æ§"><a href="#k8sé›†ç¾¤ç›‘æ§" class="headerlink" title="k8sé›†ç¾¤ç›‘æ§"></a>k8sé›†ç¾¤ç›‘æ§</h1><p>æ—¢ç„¶æ˜¯ç›‘æ§k8sçš„é›†ç¾¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦å®æ—¶è·å–k8sé›†ç¾¤çš„å“ªäº›ä¿¡æ¯å‘¢ï¼Ÿå³æˆ‘ä»¬çš„ç›‘æ§æŒ‡æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>æƒ³æƒ³k8sçš„é›†ç¾¤ä¸­æ‰€æœ‰çš„æ¦‚å¿µï¼Œå³æˆ‘ä»¬éœ€è¦ç›‘æ§ï¼š</p><ul><li>èŠ‚ç‚¹èµ„æºåˆ©ç”¨ç‡</li><li>èŠ‚ç‚¹æ•°</li><li>è¿è¡Œçš„Podæ•°ç›®</li><li>å„ä¸ªå®¹å™¨çš„çŠ¶æ€ã€èµ„æº</li><li>è¿è¡Œçš„ç¨‹åºç­‰ã€‚</li></ul><p>ç¡®å®šå¥½ç›‘æ§çš„æŒ‡æ ‡åï¼Œå°±è¦å¼€å§‹å†³å®šä½¿ç”¨çš„ç›‘æ§å¹³å°æ˜¯ä»€ä¹ˆï¼Œåœ¨ä¼—å¤šçš„ç›‘æ§å¹³å°ä¸­é€‰æ‹©äº†<code>prometheus</code>å’Œ<code>Grafana</code>æ¥ç›‘æ§å’Œå±•ç¤ºå†…å®¹ã€‚</p><p><code>prometheus</code>æ˜¯ä¸€ä¸ª<strong>å¼€æºçš„ã€ä»¥HTTPåè®®å‘¨æœŸæ€§æŠ“å–è¢«ç›‘æ§ç»„ä»¶çŠ¶æ€çš„é›†ç›‘æ§ã€æŠ¥è­¦ã€æ•°æ®åº“ä¸ºä¸€èº«çš„ç»„ä»¶</strong>ã€‚</p><p><code>Grafana</code>æ˜¯ä¸€ä¸ª<strong>å¼€æºçš„æ•°æ®åˆ†æå’Œæ•°æ®å¯è§†åŒ–å·¥å…·ï¼Œæä¾›uiç•Œé¢æ”¯æŒå¤šç§æ•°æ®åº“æºçš„æ•°æ®ã€‚</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-06_09-48-11.png" alt="Snipaste_2020-12-06_09-48-11"></p><h2 id="æ­å»ºç›‘æ§å¹³å°"><a href="#æ­å»ºç›‘æ§å¹³å°" class="headerlink" title="æ­å»ºç›‘æ§å¹³å°"></a>æ­å»ºç›‘æ§å¹³å°</h2><h3 id="prometheus"><a href="#prometheus" class="headerlink" title="prometheus"></a><code>prometheus</code></h3><p><strong>0. åˆ›å»ºæ”¶é›†å®ˆæŠ¤è¿›ç¨‹</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">node-exporter</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">node-exporter</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">prom/node-exporter</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9100</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9100</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">31672</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">node-exporter</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f xxx.yaml</span><br></pre></td></tr></table></figure><p><strong>1. æƒé™é…ç½®</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/proxy</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">nonResourceURLs:</span> [<span class="string">&quot;/metrics&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-06_10-19-18.png" alt="Snipaste_2020-12-06_10-19-18"></p><p><strong>2.é…ç½®æ–‡ä»¶</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">prometheus.yml:</span> <span class="string">|</span></span><br><span class="line">    <span class="attr">global:</span></span><br><span class="line">      <span class="attr">scrape_interval:</span>     <span class="string">15s</span></span><br><span class="line">      <span class="attr">evaluation_interval:</span> <span class="string">15s</span></span><br><span class="line">    <span class="attr">scrape_configs:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes-apiservers&#x27;</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">tls_config:</span></span><br><span class="line">        <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">      <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>, <span class="string">__meta_kubernetes_service_name</span>, <span class="string">__meta_kubernetes_endpoint_port_name</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">default;kubernetes;https</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes-nodes&#x27;</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">      <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">tls_config:</span></span><br><span class="line">        <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">      <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">kubernetes.default.svc:443</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_node_name</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">/api/v1/nodes/$&#123;1&#125;/proxy/metrics</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes-cadvisor&#x27;</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">      <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">tls_config:</span></span><br><span class="line">        <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">      <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">kubernetes.default.svc:443</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_node_name</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">/api/v1/nodes/$&#123;1&#125;/proxy/metrics/cadvisor</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes-service-endpoints&#x27;</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_scrape</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_scheme</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__scheme__</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(https?)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_path</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>, <span class="string">__meta_kubernetes_service_annotation_prometheus_io_port</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">$1:$2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_service_label_(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_name</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_name</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes-services&#x27;</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">service</span></span><br><span class="line">      <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">      <span class="attr">params:</span></span><br><span class="line">        <span class="attr">module:</span> [<span class="string">http_2xx</span>]</span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_probe</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">blackbox-exporter.example.com:9115</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_service_label_(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_name</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_name</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes-ingresses&#x27;</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">ingress</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_ingress_annotation_prometheus_io_probe</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_ingress_scheme</span>,<span class="string">__address__</span>,<span class="string">__meta_kubernetes_ingress_path</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.+);(.+);(.+)</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">$&#123;1&#125;://$&#123;2&#125;$&#123;3&#125;</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">blackbox-exporter.example.com:9115</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_ingress_label_(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_ingress_name</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_name</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes-pods&#x27;</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">pod</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_scrape</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_path</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>, <span class="string">__meta_kubernetes_pod_annotation_prometheus_io_port</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">$1:$2</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_pod_label_(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_name</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_pod_name</span></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-06_10-20-28.png" alt="Snipaste_2020-12-06_10-20-28"></p><p><strong>3. deploymentåˆ›å»º</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">prometheus-deployment</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">prom/prometheus:v2.0.0</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;/bin/prometheus&quot;</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;--config.file=/etc/prometheus/prometheus.yml&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;--storage.tsdb.path=/prometheus&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;--storage.tsdb.retention=24h&quot;</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9090</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&quot;/prometheus&quot;</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&quot;/etc/prometheus&quot;</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">2500Mi</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">prometheus</span>    </span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">prometheus-config</span>   </span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-06_10-21-44.png" alt="Snipaste_2020-12-06_10-21-44"></p><p><strong>4. svcåˆ›å»º</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9090</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30003</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-06_10-22-46.png" alt="Snipaste_2020-12-06_10-22-46"></p><h3 id="Grafana"><a href="#Grafana" class="headerlink" title="Grafana"></a><code>Grafana</code></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana-core</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">core</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">      <span class="attr">component:</span> <span class="string">core</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">        <span class="attr">component:</span> <span class="string">core</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">grafana/grafana:4.2.0</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">grafana-core</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        </span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">         </span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">         </span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_AUTH_BASIC_ENABLED</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_AUTH_ANONYMOUS_ENABLED</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">         </span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/login</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">         </span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-persistent-storage</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-persistent-storage</span></span><br><span class="line">        <span class="attr">emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">core</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">core</span></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-06_10-30-38.png" alt="Snipaste_2020-12-06_10-30-38"></p><hr><p>æ£€éªŒ</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-06_11-03-38.png" alt="Snipaste_2020-12-06_11-03-38"></p><h2 id="è®¾ç½®"><a href="#è®¾ç½®" class="headerlink" title="è®¾ç½®"></a>è®¾ç½®</h2><p>æ ¹æ®<code>kubectl get svc -n kube-system    </code>å¾—åˆ°è®¿é—®åœ°å€ï¼Œè®¿é—®ä¹‹åï¼Œè¾“å…¥è´¦å·å¯†ç ï¼Œéƒ½æ˜¯admin</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-06_11-05-46.png" alt="Snipaste_2020-12-06_11-05-46"></p><p><strong>1. é…ç½®æ•°æ®æºprometheus</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-06_11-33-54.png" alt="Snipaste_2020-12-06_11-33-54"></p><p>è¯·æ³¨æ„ï¼ŒURLçš„ipè¯·é‡‡ç”¨prometheusçš„svcçš„IPã€‚</p><p><strong>2. è®¾ç½®æ•°æ®æ¨¡æ¿</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-06_11-36-19.png" alt="Snipaste_2020-12-06_11-36-19"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-06_11-50-06.png" alt="Snipaste_2020-12-06_11-50-06"></p><p>è¿™é‡Œä¸¤ç§é€‰æ‹©ï¼Œä½ å¯ä»¥ç›´æ¥åœ¨ä¸Šé¢çš„è¾“å…¥æ¡†å†…è¾“å…¥<code>315</code>ï¼Œåˆæˆ–è€…åœ¨ä¸‹é¢çš„JSONå†…è¾“å…¥JSONã€‚</p><p>å› ä¸ºè¾“å…¥315ä»–ä¼šè¯·æ±‚ä¸€ä¸ªç½‘å€æ¥è·å–JSONï¼Œä½†æ˜¯å¯èƒ½éœ€è¦ç§‘å­¦ä¸Šç½‘æ‰èƒ½æ‹‰å–åˆ°JSONã€‚æ‰€ä»¥è¿™é‡Œæˆ‘æ‰‹åŠ¨è¾“å…¥JSONä¹Ÿå¯ä»¥ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br><span class="line">1251</span><br><span class="line">1252</span><br><span class="line">1253</span><br><span class="line">1254</span><br><span class="line">1255</span><br><span class="line">1256</span><br><span class="line">1257</span><br><span class="line">1258</span><br><span class="line">1259</span><br><span class="line">1260</span><br><span class="line">1261</span><br><span class="line">1262</span><br><span class="line">1263</span><br><span class="line">1264</span><br><span class="line">1265</span><br><span class="line">1266</span><br><span class="line">1267</span><br><span class="line">1268</span><br><span class="line">1269</span><br><span class="line">1270</span><br><span class="line">1271</span><br><span class="line">1272</span><br><span class="line">1273</span><br><span class="line">1274</span><br><span class="line">1275</span><br><span class="line">1276</span><br><span class="line">1277</span><br><span class="line">1278</span><br><span class="line">1279</span><br><span class="line">1280</span><br><span class="line">1281</span><br><span class="line">1282</span><br><span class="line">1283</span><br><span class="line">1284</span><br><span class="line">1285</span><br><span class="line">1286</span><br><span class="line">1287</span><br><span class="line">1288</span><br><span class="line">1289</span><br><span class="line">1290</span><br><span class="line">1291</span><br><span class="line">1292</span><br><span class="line">1293</span><br><span class="line">1294</span><br><span class="line">1295</span><br><span class="line">1296</span><br><span class="line">1297</span><br><span class="line">1298</span><br><span class="line">1299</span><br><span class="line">1300</span><br><span class="line">1301</span><br><span class="line">1302</span><br><span class="line">1303</span><br><span class="line">1304</span><br><span class="line">1305</span><br><span class="line">1306</span><br><span class="line">1307</span><br><span class="line">1308</span><br><span class="line">1309</span><br><span class="line">1310</span><br><span class="line">1311</span><br><span class="line">1312</span><br><span class="line">1313</span><br><span class="line">1314</span><br><span class="line">1315</span><br><span class="line">1316</span><br><span class="line">1317</span><br><span class="line">1318</span><br><span class="line">1319</span><br><span class="line">1320</span><br><span class="line">1321</span><br><span class="line">1322</span><br><span class="line">1323</span><br><span class="line">1324</span><br><span class="line">1325</span><br><span class="line">1326</span><br><span class="line">1327</span><br><span class="line">1328</span><br><span class="line">1329</span><br><span class="line">1330</span><br><span class="line">1331</span><br><span class="line">1332</span><br><span class="line">1333</span><br><span class="line">1334</span><br><span class="line">1335</span><br><span class="line">1336</span><br><span class="line">1337</span><br><span class="line">1338</span><br><span class="line">1339</span><br><span class="line">1340</span><br><span class="line">1341</span><br><span class="line">1342</span><br><span class="line">1343</span><br><span class="line">1344</span><br><span class="line">1345</span><br><span class="line">1346</span><br><span class="line">1347</span><br><span class="line">1348</span><br><span class="line">1349</span><br><span class="line">1350</span><br><span class="line">1351</span><br><span class="line">1352</span><br><span class="line">1353</span><br><span class="line">1354</span><br><span class="line">1355</span><br><span class="line">1356</span><br><span class="line">1357</span><br><span class="line">1358</span><br><span class="line">1359</span><br><span class="line">1360</span><br><span class="line">1361</span><br><span class="line">1362</span><br><span class="line">1363</span><br><span class="line">1364</span><br><span class="line">1365</span><br><span class="line">1366</span><br><span class="line">1367</span><br><span class="line">1368</span><br><span class="line">1369</span><br><span class="line">1370</span><br><span class="line">1371</span><br><span class="line">1372</span><br><span class="line">1373</span><br><span class="line">1374</span><br><span class="line">1375</span><br><span class="line">1376</span><br><span class="line">1377</span><br><span class="line">1378</span><br><span class="line">1379</span><br><span class="line">1380</span><br><span class="line">1381</span><br><span class="line">1382</span><br><span class="line">1383</span><br><span class="line">1384</span><br><span class="line">1385</span><br><span class="line">1386</span><br><span class="line">1387</span><br><span class="line">1388</span><br><span class="line">1389</span><br><span class="line">1390</span><br><span class="line">1391</span><br><span class="line">1392</span><br><span class="line">1393</span><br><span class="line">1394</span><br><span class="line">1395</span><br><span class="line">1396</span><br><span class="line">1397</span><br><span class="line">1398</span><br><span class="line">1399</span><br><span class="line">1400</span><br><span class="line">1401</span><br><span class="line">1402</span><br><span class="line">1403</span><br><span class="line">1404</span><br><span class="line">1405</span><br><span class="line">1406</span><br><span class="line">1407</span><br><span class="line">1408</span><br><span class="line">1409</span><br><span class="line">1410</span><br><span class="line">1411</span><br><span class="line">1412</span><br><span class="line">1413</span><br><span class="line">1414</span><br><span class="line">1415</span><br><span class="line">1416</span><br><span class="line">1417</span><br><span class="line">1418</span><br><span class="line">1419</span><br><span class="line">1420</span><br><span class="line">1421</span><br><span class="line">1422</span><br><span class="line">1423</span><br><span class="line">1424</span><br><span class="line">1425</span><br><span class="line">1426</span><br><span class="line">1427</span><br><span class="line">1428</span><br><span class="line">1429</span><br><span class="line">1430</span><br><span class="line">1431</span><br><span class="line">1432</span><br><span class="line">1433</span><br><span class="line">1434</span><br><span class="line">1435</span><br><span class="line">1436</span><br><span class="line">1437</span><br><span class="line">1438</span><br><span class="line">1439</span><br><span class="line">1440</span><br><span class="line">1441</span><br><span class="line">1442</span><br><span class="line">1443</span><br><span class="line">1444</span><br><span class="line">1445</span><br><span class="line">1446</span><br><span class="line">1447</span><br><span class="line">1448</span><br><span class="line">1449</span><br><span class="line">1450</span><br><span class="line">1451</span><br><span class="line">1452</span><br><span class="line">1453</span><br><span class="line">1454</span><br><span class="line">1455</span><br><span class="line">1456</span><br><span class="line">1457</span><br><span class="line">1458</span><br><span class="line">1459</span><br><span class="line">1460</span><br><span class="line">1461</span><br><span class="line">1462</span><br><span class="line">1463</span><br><span class="line">1464</span><br><span class="line">1465</span><br><span class="line">1466</span><br><span class="line">1467</span><br><span class="line">1468</span><br><span class="line">1469</span><br><span class="line">1470</span><br><span class="line">1471</span><br><span class="line">1472</span><br><span class="line">1473</span><br><span class="line">1474</span><br><span class="line">1475</span><br><span class="line">1476</span><br><span class="line">1477</span><br><span class="line">1478</span><br><span class="line">1479</span><br><span class="line">1480</span><br><span class="line">1481</span><br><span class="line">1482</span><br><span class="line">1483</span><br><span class="line">1484</span><br><span class="line">1485</span><br><span class="line">1486</span><br><span class="line">1487</span><br><span class="line">1488</span><br><span class="line">1489</span><br><span class="line">1490</span><br><span class="line">1491</span><br><span class="line">1492</span><br><span class="line">1493</span><br><span class="line">1494</span><br><span class="line">1495</span><br><span class="line">1496</span><br><span class="line">1497</span><br><span class="line">1498</span><br><span class="line">1499</span><br><span class="line">1500</span><br><span class="line">1501</span><br><span class="line">1502</span><br><span class="line">1503</span><br><span class="line">1504</span><br><span class="line">1505</span><br><span class="line">1506</span><br><span class="line">1507</span><br><span class="line">1508</span><br><span class="line">1509</span><br><span class="line">1510</span><br><span class="line">1511</span><br><span class="line">1512</span><br><span class="line">1513</span><br><span class="line">1514</span><br><span class="line">1515</span><br><span class="line">1516</span><br><span class="line">1517</span><br><span class="line">1518</span><br><span class="line">1519</span><br><span class="line">1520</span><br><span class="line">1521</span><br><span class="line">1522</span><br><span class="line">1523</span><br><span class="line">1524</span><br><span class="line">1525</span><br><span class="line">1526</span><br><span class="line">1527</span><br><span class="line">1528</span><br><span class="line">1529</span><br><span class="line">1530</span><br><span class="line">1531</span><br><span class="line">1532</span><br><span class="line">1533</span><br><span class="line">1534</span><br><span class="line">1535</span><br><span class="line">1536</span><br><span class="line">1537</span><br><span class="line">1538</span><br><span class="line">1539</span><br><span class="line">1540</span><br><span class="line">1541</span><br><span class="line">1542</span><br><span class="line">1543</span><br><span class="line">1544</span><br><span class="line">1545</span><br><span class="line">1546</span><br><span class="line">1547</span><br><span class="line">1548</span><br><span class="line">1549</span><br><span class="line">1550</span><br><span class="line">1551</span><br><span class="line">1552</span><br><span class="line">1553</span><br><span class="line">1554</span><br><span class="line">1555</span><br><span class="line">1556</span><br><span class="line">1557</span><br><span class="line">1558</span><br><span class="line">1559</span><br><span class="line">1560</span><br><span class="line">1561</span><br><span class="line">1562</span><br><span class="line">1563</span><br><span class="line">1564</span><br><span class="line">1565</span><br><span class="line">1566</span><br><span class="line">1567</span><br><span class="line">1568</span><br><span class="line">1569</span><br><span class="line">1570</span><br><span class="line">1571</span><br><span class="line">1572</span><br><span class="line">1573</span><br><span class="line">1574</span><br><span class="line">1575</span><br><span class="line">1576</span><br><span class="line">1577</span><br><span class="line">1578</span><br><span class="line">1579</span><br><span class="line">1580</span><br><span class="line">1581</span><br><span class="line">1582</span><br><span class="line">1583</span><br><span class="line">1584</span><br><span class="line">1585</span><br><span class="line">1586</span><br><span class="line">1587</span><br><span class="line">1588</span><br><span class="line">1589</span><br><span class="line">1590</span><br><span class="line">1591</span><br><span class="line">1592</span><br><span class="line">1593</span><br><span class="line">1594</span><br><span class="line">1595</span><br><span class="line">1596</span><br><span class="line">1597</span><br><span class="line">1598</span><br><span class="line">1599</span><br><span class="line">1600</span><br><span class="line">1601</span><br><span class="line">1602</span><br><span class="line">1603</span><br><span class="line">1604</span><br><span class="line">1605</span><br><span class="line">1606</span><br><span class="line">1607</span><br><span class="line">1608</span><br><span class="line">1609</span><br><span class="line">1610</span><br><span class="line">1611</span><br><span class="line">1612</span><br><span class="line">1613</span><br><span class="line">1614</span><br><span class="line">1615</span><br><span class="line">1616</span><br><span class="line">1617</span><br><span class="line">1618</span><br><span class="line">1619</span><br><span class="line">1620</span><br><span class="line">1621</span><br><span class="line">1622</span><br><span class="line">1623</span><br><span class="line">1624</span><br><span class="line">1625</span><br><span class="line">1626</span><br><span class="line">1627</span><br><span class="line">1628</span><br><span class="line">1629</span><br><span class="line">1630</span><br><span class="line">1631</span><br><span class="line">1632</span><br><span class="line">1633</span><br><span class="line">1634</span><br><span class="line">1635</span><br><span class="line">1636</span><br><span class="line">1637</span><br><span class="line">1638</span><br><span class="line">1639</span><br><span class="line">1640</span><br><span class="line">1641</span><br><span class="line">1642</span><br><span class="line">1643</span><br><span class="line">1644</span><br><span class="line">1645</span><br><span class="line">1646</span><br><span class="line">1647</span><br><span class="line">1648</span><br><span class="line">1649</span><br><span class="line">1650</span><br><span class="line">1651</span><br><span class="line">1652</span><br><span class="line">1653</span><br><span class="line">1654</span><br><span class="line">1655</span><br><span class="line">1656</span><br><span class="line">1657</span><br><span class="line">1658</span><br><span class="line">1659</span><br><span class="line">1660</span><br><span class="line">1661</span><br><span class="line">1662</span><br><span class="line">1663</span><br><span class="line">1664</span><br><span class="line">1665</span><br><span class="line">1666</span><br><span class="line">1667</span><br><span class="line">1668</span><br><span class="line">1669</span><br><span class="line">1670</span><br><span class="line">1671</span><br><span class="line">1672</span><br><span class="line">1673</span><br><span class="line">1674</span><br><span class="line">1675</span><br><span class="line">1676</span><br><span class="line">1677</span><br><span class="line">1678</span><br><span class="line">1679</span><br><span class="line">1680</span><br><span class="line">1681</span><br><span class="line">1682</span><br><span class="line">1683</span><br><span class="line">1684</span><br><span class="line">1685</span><br><span class="line">1686</span><br><span class="line">1687</span><br><span class="line">1688</span><br><span class="line">1689</span><br><span class="line">1690</span><br><span class="line">1691</span><br><span class="line">1692</span><br><span class="line">1693</span><br><span class="line">1694</span><br><span class="line">1695</span><br><span class="line">1696</span><br><span class="line">1697</span><br><span class="line">1698</span><br><span class="line">1699</span><br><span class="line">1700</span><br><span class="line">1701</span><br><span class="line">1702</span><br><span class="line">1703</span><br><span class="line">1704</span><br><span class="line">1705</span><br><span class="line">1706</span><br><span class="line">1707</span><br><span class="line">1708</span><br><span class="line">1709</span><br><span class="line">1710</span><br><span class="line">1711</span><br><span class="line">1712</span><br><span class="line">1713</span><br><span class="line">1714</span><br><span class="line">1715</span><br><span class="line">1716</span><br><span class="line">1717</span><br><span class="line">1718</span><br><span class="line">1719</span><br><span class="line">1720</span><br><span class="line">1721</span><br><span class="line">1722</span><br><span class="line">1723</span><br><span class="line">1724</span><br><span class="line">1725</span><br><span class="line">1726</span><br><span class="line">1727</span><br><span class="line">1728</span><br><span class="line">1729</span><br><span class="line">1730</span><br><span class="line">1731</span><br><span class="line">1732</span><br><span class="line">1733</span><br><span class="line">1734</span><br><span class="line">1735</span><br><span class="line">1736</span><br><span class="line">1737</span><br><span class="line">1738</span><br><span class="line">1739</span><br><span class="line">1740</span><br><span class="line">1741</span><br><span class="line">1742</span><br><span class="line">1743</span><br><span class="line">1744</span><br><span class="line">1745</span><br><span class="line">1746</span><br><span class="line">1747</span><br><span class="line">1748</span><br><span class="line">1749</span><br><span class="line">1750</span><br><span class="line">1751</span><br><span class="line">1752</span><br><span class="line">1753</span><br><span class="line">1754</span><br><span class="line">1755</span><br><span class="line">1756</span><br><span class="line">1757</span><br><span class="line">1758</span><br><span class="line">1759</span><br><span class="line">1760</span><br><span class="line">1761</span><br><span class="line">1762</span><br><span class="line">1763</span><br><span class="line">1764</span><br><span class="line">1765</span><br><span class="line">1766</span><br><span class="line">1767</span><br><span class="line">1768</span><br><span class="line">1769</span><br><span class="line">1770</span><br><span class="line">1771</span><br><span class="line">1772</span><br><span class="line">1773</span><br><span class="line">1774</span><br><span class="line">1775</span><br><span class="line">1776</span><br><span class="line">1777</span><br><span class="line">1778</span><br><span class="line">1779</span><br><span class="line">1780</span><br><span class="line">1781</span><br><span class="line">1782</span><br><span class="line">1783</span><br><span class="line">1784</span><br><span class="line">1785</span><br><span class="line">1786</span><br><span class="line">1787</span><br><span class="line">1788</span><br><span class="line">1789</span><br><span class="line">1790</span><br><span class="line">1791</span><br><span class="line">1792</span><br><span class="line">1793</span><br><span class="line">1794</span><br><span class="line">1795</span><br><span class="line">1796</span><br><span class="line">1797</span><br><span class="line">1798</span><br><span class="line">1799</span><br><span class="line">1800</span><br><span class="line">1801</span><br><span class="line">1802</span><br><span class="line">1803</span><br><span class="line">1804</span><br><span class="line">1805</span><br><span class="line">1806</span><br><span class="line">1807</span><br><span class="line">1808</span><br><span class="line">1809</span><br><span class="line">1810</span><br><span class="line">1811</span><br><span class="line">1812</span><br><span class="line">1813</span><br><span class="line">1814</span><br><span class="line">1815</span><br><span class="line">1816</span><br><span class="line">1817</span><br><span class="line">1818</span><br><span class="line">1819</span><br><span class="line">1820</span><br><span class="line">1821</span><br><span class="line">1822</span><br><span class="line">1823</span><br><span class="line">1824</span><br><span class="line">1825</span><br><span class="line">1826</span><br><span class="line">1827</span><br><span class="line">1828</span><br><span class="line">1829</span><br><span class="line">1830</span><br><span class="line">1831</span><br><span class="line">1832</span><br><span class="line">1833</span><br><span class="line">1834</span><br><span class="line">1835</span><br><span class="line">1836</span><br><span class="line">1837</span><br><span class="line">1838</span><br><span class="line">1839</span><br><span class="line">1840</span><br><span class="line">1841</span><br><span class="line">1842</span><br><span class="line">1843</span><br><span class="line">1844</span><br><span class="line">1845</span><br><span class="line">1846</span><br><span class="line">1847</span><br><span class="line">1848</span><br><span class="line">1849</span><br><span class="line">1850</span><br><span class="line">1851</span><br><span class="line">1852</span><br><span class="line">1853</span><br><span class="line">1854</span><br><span class="line">1855</span><br><span class="line">1856</span><br><span class="line">1857</span><br><span class="line">1858</span><br><span class="line">1859</span><br><span class="line">1860</span><br><span class="line">1861</span><br><span class="line">1862</span><br><span class="line">1863</span><br><span class="line">1864</span><br><span class="line">1865</span><br><span class="line">1866</span><br><span class="line">1867</span><br><span class="line">1868</span><br><span class="line">1869</span><br><span class="line">1870</span><br><span class="line">1871</span><br><span class="line">1872</span><br><span class="line">1873</span><br><span class="line">1874</span><br><span class="line">1875</span><br><span class="line">1876</span><br><span class="line">1877</span><br><span class="line">1878</span><br><span class="line">1879</span><br><span class="line">1880</span><br><span class="line">1881</span><br><span class="line">1882</span><br><span class="line">1883</span><br><span class="line">1884</span><br><span class="line">1885</span><br><span class="line">1886</span><br><span class="line">1887</span><br><span class="line">1888</span><br><span class="line">1889</span><br><span class="line">1890</span><br><span class="line">1891</span><br><span class="line">1892</span><br><span class="line">1893</span><br><span class="line">1894</span><br><span class="line">1895</span><br><span class="line">1896</span><br><span class="line">1897</span><br><span class="line">1898</span><br><span class="line">1899</span><br><span class="line">1900</span><br><span class="line">1901</span><br><span class="line">1902</span><br><span class="line">1903</span><br><span class="line">1904</span><br><span class="line">1905</span><br><span class="line">1906</span><br><span class="line">1907</span><br><span class="line">1908</span><br><span class="line">1909</span><br><span class="line">1910</span><br><span class="line">1911</span><br><span class="line">1912</span><br><span class="line">1913</span><br><span class="line">1914</span><br><span class="line">1915</span><br><span class="line">1916</span><br><span class="line">1917</span><br><span class="line">1918</span><br><span class="line">1919</span><br><span class="line">1920</span><br><span class="line">1921</span><br><span class="line">1922</span><br><span class="line">1923</span><br><span class="line">1924</span><br><span class="line">1925</span><br><span class="line">1926</span><br><span class="line">1927</span><br><span class="line">1928</span><br><span class="line">1929</span><br><span class="line">1930</span><br><span class="line">1931</span><br><span class="line">1932</span><br><span class="line">1933</span><br><span class="line">1934</span><br><span class="line">1935</span><br><span class="line">1936</span><br><span class="line">1937</span><br><span class="line">1938</span><br><span class="line">1939</span><br><span class="line">1940</span><br><span class="line">1941</span><br><span class="line">1942</span><br><span class="line">1943</span><br><span class="line">1944</span><br><span class="line">1945</span><br><span class="line">1946</span><br><span class="line">1947</span><br><span class="line">1948</span><br><span class="line">1949</span><br><span class="line">1950</span><br><span class="line">1951</span><br><span class="line">1952</span><br><span class="line">1953</span><br><span class="line">1954</span><br><span class="line">1955</span><br><span class="line">1956</span><br><span class="line">1957</span><br><span class="line">1958</span><br><span class="line">1959</span><br><span class="line">1960</span><br><span class="line">1961</span><br><span class="line">1962</span><br><span class="line">1963</span><br><span class="line">1964</span><br><span class="line">1965</span><br><span class="line">1966</span><br><span class="line">1967</span><br><span class="line">1968</span><br><span class="line">1969</span><br><span class="line">1970</span><br><span class="line">1971</span><br><span class="line">1972</span><br><span class="line">1973</span><br><span class="line">1974</span><br><span class="line">1975</span><br><span class="line">1976</span><br><span class="line">1977</span><br><span class="line">1978</span><br><span class="line">1979</span><br><span class="line">1980</span><br><span class="line">1981</span><br><span class="line">1982</span><br><span class="line">1983</span><br><span class="line">1984</span><br><span class="line">1985</span><br><span class="line">1986</span><br><span class="line">1987</span><br><span class="line">1988</span><br><span class="line">1989</span><br><span class="line">1990</span><br><span class="line">1991</span><br><span class="line">1992</span><br><span class="line">1993</span><br><span class="line">1994</span><br><span class="line">1995</span><br><span class="line">1996</span><br><span class="line">1997</span><br><span class="line">1998</span><br><span class="line">1999</span><br><span class="line">2000</span><br><span class="line">2001</span><br><span class="line">2002</span><br><span class="line">2003</span><br><span class="line">2004</span><br><span class="line">2005</span><br><span class="line">2006</span><br><span class="line">2007</span><br><span class="line">2008</span><br><span class="line">2009</span><br><span class="line">2010</span><br><span class="line">2011</span><br><span class="line">2012</span><br><span class="line">2013</span><br><span class="line">2014</span><br><span class="line">2015</span><br><span class="line">2016</span><br><span class="line">2017</span><br><span class="line">2018</span><br><span class="line">2019</span><br><span class="line">2020</span><br><span class="line">2021</span><br><span class="line">2022</span><br><span class="line">2023</span><br><span class="line">2024</span><br><span class="line">2025</span><br><span class="line">2026</span><br><span class="line">2027</span><br><span class="line">2028</span><br><span class="line">2029</span><br><span class="line">2030</span><br><span class="line">2031</span><br><span class="line">2032</span><br><span class="line">2033</span><br><span class="line">2034</span><br><span class="line">2035</span><br><span class="line">2036</span><br><span class="line">2037</span><br><span class="line">2038</span><br><span class="line">2039</span><br><span class="line">2040</span><br><span class="line">2041</span><br><span class="line">2042</span><br><span class="line">2043</span><br><span class="line">2044</span><br><span class="line">2045</span><br><span class="line">2046</span><br><span class="line">2047</span><br><span class="line">2048</span><br><span class="line">2049</span><br><span class="line">2050</span><br><span class="line">2051</span><br><span class="line">2052</span><br><span class="line">2053</span><br><span class="line">2054</span><br><span class="line">2055</span><br><span class="line">2056</span><br><span class="line">2057</span><br><span class="line">2058</span><br><span class="line">2059</span><br><span class="line">2060</span><br><span class="line">2061</span><br><span class="line">2062</span><br><span class="line">2063</span><br><span class="line">2064</span><br><span class="line">2065</span><br><span class="line">2066</span><br><span class="line">2067</span><br><span class="line">2068</span><br><span class="line">2069</span><br><span class="line">2070</span><br><span class="line">2071</span><br><span class="line">2072</span><br><span class="line">2073</span><br><span class="line">2074</span><br><span class="line">2075</span><br><span class="line">2076</span><br><span class="line">2077</span><br><span class="line">2078</span><br><span class="line">2079</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;__inputs&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;DS_PROMETHEUS&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;label&quot;</span>: <span class="string">&quot;Prometheus&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;datasource&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;pluginId&quot;</span>: <span class="string">&quot;prometheus&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;pluginName&quot;</span>: <span class="string">&quot;Prometheus&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;__requires&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;panel&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;graph&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Graph&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;panel&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;singlestat&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Singlestat&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;grafana&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;grafana&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Grafana&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;3.1.1&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;datasource&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;prometheus&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Prometheus&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;1.3.0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;id&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Kubernetes cluster monitoring (via Prometheus)&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Monitors Kubernetes cluster using Prometheus. Shows overall cluster CPU / Memory / Filesystem usage as well as individual pod, containers, systemd services statistics. Uses cAdvisor metrics only.&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;tags&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;kubernetes&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;style&quot;</span>: <span class="string">&quot;dark&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;timezone&quot;</span>: <span class="string">&quot;browser&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;hideControls&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;sharedCrosshair&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;rows&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;collapse&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;200px&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;panels&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;aliasColors&quot;</span>: &#123;&#125;,</span><br><span class="line">          <span class="attr">&quot;bars&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;fill&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;grid&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;threshold1&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold1Color&quot;</span>: <span class="string">&quot;rgba(216, 200, 27, 0.27)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2Color&quot;</span>: <span class="string">&quot;rgba(234, 112, 112, 0.22)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdLine&quot;</span>: <span class="literal">false</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;200px&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">32</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;legend&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;alignAsTable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;avg&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;current&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;max&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;min&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;rightSide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;sideWidth&quot;</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="string">&quot;current&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;sortDesc&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;total&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;values&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;lines&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;linewidth&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;percentage&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;pointradius&quot;</span>: <span class="number">5</span>,</span><br><span class="line">          <span class="attr">&quot;points&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;renderer&quot;</span>: <span class="string">&quot;flot&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;seriesOverrides&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">&quot;stack&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;steppedLine&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_network_receive_bytes_total&#123;kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m]))&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;Received&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;network&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;- sum (rate (container_network_transmit_bytes_total&#123;kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m]))&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;Sent&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;network&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;B&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;timeFrom&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;timeShift&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Network I/O pressure&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;tooltip&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;msResolution&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;shared&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;value_type&quot;</span>: <span class="string">&quot;cumulative&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;transparent&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;graph&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;xaxis&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;yaxes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;Bps&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;Bps&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Network I/O pressure&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;collapse&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;250px&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;panels&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;cacheTimeout&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;colorBackground&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colorValue&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;colors&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;rgba(50, 172, 45, 0.97)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(237, 129, 40, 0.89)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(245, 54, 54, 0.9)&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;percent&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;gauge&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;maxValue&quot;</span>: <span class="number">100</span>,</span><br><span class="line">            <span class="attr">&quot;minValue&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdLabels&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdMarkers&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;180px&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">4</span>,</span><br><span class="line">          <span class="attr">&quot;interval&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;mappingType&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;mappingTypes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;value to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;range to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">2</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;maxDataPoints&quot;</span>: <span class="number">100</span>,</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;nullText&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;postfix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;postfixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;rangeMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;from&quot;</span>: <span class="string">&quot;null&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">4</span>,</span><br><span class="line">          <span class="attr">&quot;sparkline&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;fillColor&quot;</span>: <span class="string">&quot;rgba(31, 118, 189, 0.18)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;full&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;lineColor&quot;</span>: <span class="string">&quot;rgb(31, 120, 193)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (container_memory_working_set_bytes&#123;id=\&quot;/\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;) / sum (machine_memory_bytes&#123;kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;) * 100&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;thresholds&quot;</span>: <span class="string">&quot;65, 90&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Cluster memory usage&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;transparent&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;singlestat&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueFontSize&quot;</span>: <span class="string">&quot;80%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;op&quot;</span>: <span class="string">&quot;=&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;valueName&quot;</span>: <span class="string">&quot;current&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;cacheTimeout&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;colorBackground&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colorValue&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;colors&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;rgba(50, 172, 45, 0.97)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(237, 129, 40, 0.89)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(245, 54, 54, 0.9)&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;percent&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;gauge&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;maxValue&quot;</span>: <span class="number">100</span>,</span><br><span class="line">            <span class="attr">&quot;minValue&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdLabels&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdMarkers&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;180px&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">6</span>,</span><br><span class="line">          <span class="attr">&quot;interval&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;mappingType&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;mappingTypes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;value to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;range to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">2</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;maxDataPoints&quot;</span>: <span class="number">100</span>,</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;nullText&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;postfix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;postfixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;rangeMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;from&quot;</span>: <span class="string">&quot;null&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">4</span>,</span><br><span class="line">          <span class="attr">&quot;sparkline&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;fillColor&quot;</span>: <span class="string">&quot;rgba(31, 118, 189, 0.18)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;full&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;lineColor&quot;</span>: <span class="string">&quot;rgb(31, 120, 193)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_cpu_usage_seconds_total&#123;id=\&quot;/\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) / sum (machine_cpu_cores&#123;kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;) * 100&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;thresholds&quot;</span>: <span class="string">&quot;65, 90&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Cluster CPU usage (1m avg)&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;singlestat&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueFontSize&quot;</span>: <span class="string">&quot;80%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;op&quot;</span>: <span class="string">&quot;=&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;valueName&quot;</span>: <span class="string">&quot;current&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;cacheTimeout&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;colorBackground&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colorValue&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;colors&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;rgba(50, 172, 45, 0.97)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(237, 129, 40, 0.89)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(245, 54, 54, 0.9)&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;percent&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;gauge&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;maxValue&quot;</span>: <span class="number">100</span>,</span><br><span class="line">            <span class="attr">&quot;minValue&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdLabels&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdMarkers&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;180px&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">7</span>,</span><br><span class="line">          <span class="attr">&quot;interval&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;mappingType&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;mappingTypes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;value to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;range to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">2</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;maxDataPoints&quot;</span>: <span class="number">100</span>,</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;nullText&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;postfix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;postfixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;rangeMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;from&quot;</span>: <span class="string">&quot;null&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">4</span>,</span><br><span class="line">          <span class="attr">&quot;sparkline&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;fillColor&quot;</span>: <span class="string">&quot;rgba(31, 118, 189, 0.18)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;full&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;lineColor&quot;</span>: <span class="string">&quot;rgb(31, 120, 193)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (container_fs_usage_bytes&#123;device=~\&quot;^/dev/[sv]d[a-z][1-9]$\&quot;,id=\&quot;/\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;) / sum (container_fs_limit_bytes&#123;device=~\&quot;^/dev/[sv]d[a-z][1-9]$\&quot;,id=\&quot;/\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;) * 100&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;thresholds&quot;</span>: <span class="string">&quot;65, 90&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Cluster filesystem usage&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;singlestat&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueFontSize&quot;</span>: <span class="string">&quot;80%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;op&quot;</span>: <span class="string">&quot;=&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;valueName&quot;</span>: <span class="string">&quot;current&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;cacheTimeout&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;colorBackground&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colorValue&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colors&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;rgba(50, 172, 45, 0.97)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(237, 129, 40, 0.89)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(245, 54, 54, 0.9)&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;bytes&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;gauge&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;maxValue&quot;</span>: <span class="number">100</span>,</span><br><span class="line">            <span class="attr">&quot;minValue&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdLabels&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdMarkers&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;1px&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">9</span>,</span><br><span class="line">          <span class="attr">&quot;interval&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;mappingType&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;mappingTypes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;value to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;range to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">2</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;maxDataPoints&quot;</span>: <span class="number">100</span>,</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;nullText&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;postfix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;postfixFontSize&quot;</span>: <span class="string">&quot;20%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefixFontSize&quot;</span>: <span class="string">&quot;20%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;rangeMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;from&quot;</span>: <span class="string">&quot;null&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;sparkline&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;fillColor&quot;</span>: <span class="string">&quot;rgba(31, 118, 189, 0.18)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;full&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;lineColor&quot;</span>: <span class="string">&quot;rgb(31, 120, 193)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (container_memory_working_set_bytes&#123;id=\&quot;/\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;thresholds&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Used&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;singlestat&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;op&quot;</span>: <span class="string">&quot;=&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;valueName&quot;</span>: <span class="string">&quot;current&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;cacheTimeout&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;colorBackground&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colorValue&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colors&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;rgba(50, 172, 45, 0.97)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(237, 129, 40, 0.89)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(245, 54, 54, 0.9)&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;bytes&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;gauge&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;maxValue&quot;</span>: <span class="number">100</span>,</span><br><span class="line">            <span class="attr">&quot;minValue&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdLabels&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdMarkers&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;1px&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">10</span>,</span><br><span class="line">          <span class="attr">&quot;interval&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;mappingType&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;mappingTypes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;value to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;range to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">2</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;maxDataPoints&quot;</span>: <span class="number">100</span>,</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;nullText&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;postfix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;postfixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;rangeMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;from&quot;</span>: <span class="string">&quot;null&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;sparkline&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;fillColor&quot;</span>: <span class="string">&quot;rgba(31, 118, 189, 0.18)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;full&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;lineColor&quot;</span>: <span class="string">&quot;rgb(31, 120, 193)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (machine_memory_bytes&#123;kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;thresholds&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Total&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;singlestat&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;op&quot;</span>: <span class="string">&quot;=&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;valueName&quot;</span>: <span class="string">&quot;current&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;cacheTimeout&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;colorBackground&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colorValue&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colors&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;rgba(50, 172, 45, 0.97)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(237, 129, 40, 0.89)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(245, 54, 54, 0.9)&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;gauge&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;maxValue&quot;</span>: <span class="number">100</span>,</span><br><span class="line">            <span class="attr">&quot;minValue&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdLabels&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdMarkers&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;1px&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">11</span>,</span><br><span class="line">          <span class="attr">&quot;interval&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;mappingType&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;mappingTypes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;value to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;range to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">2</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;maxDataPoints&quot;</span>: <span class="number">100</span>,</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;nullText&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;postfix&quot;</span>: <span class="string">&quot; cores&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;postfixFontSize&quot;</span>: <span class="string">&quot;30%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;rangeMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;from&quot;</span>: <span class="string">&quot;null&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;sparkline&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;fillColor&quot;</span>: <span class="string">&quot;rgba(31, 118, 189, 0.18)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;full&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;lineColor&quot;</span>: <span class="string">&quot;rgb(31, 120, 193)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_cpu_usage_seconds_total&#123;id=\&quot;/\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m]))&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;thresholds&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Used&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;singlestat&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;op&quot;</span>: <span class="string">&quot;=&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;valueName&quot;</span>: <span class="string">&quot;current&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;cacheTimeout&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;colorBackground&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colorValue&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colors&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;rgba(50, 172, 45, 0.97)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(237, 129, 40, 0.89)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(245, 54, 54, 0.9)&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;gauge&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;maxValue&quot;</span>: <span class="number">100</span>,</span><br><span class="line">            <span class="attr">&quot;minValue&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdLabels&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdMarkers&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;1px&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">&quot;interval&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;mappingType&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;mappingTypes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;value to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;range to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">2</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;maxDataPoints&quot;</span>: <span class="number">100</span>,</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;nullText&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;postfix&quot;</span>: <span class="string">&quot; cores&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;postfixFontSize&quot;</span>: <span class="string">&quot;30%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;rangeMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;from&quot;</span>: <span class="string">&quot;null&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;sparkline&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;fillColor&quot;</span>: <span class="string">&quot;rgba(31, 118, 189, 0.18)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;full&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;lineColor&quot;</span>: <span class="string">&quot;rgb(31, 120, 193)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (machine_cpu_cores&#123;kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;thresholds&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Total&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;singlestat&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;op&quot;</span>: <span class="string">&quot;=&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;valueName&quot;</span>: <span class="string">&quot;current&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;cacheTimeout&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;colorBackground&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colorValue&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colors&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;rgba(50, 172, 45, 0.97)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(237, 129, 40, 0.89)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(245, 54, 54, 0.9)&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;bytes&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;gauge&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;maxValue&quot;</span>: <span class="number">100</span>,</span><br><span class="line">            <span class="attr">&quot;minValue&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdLabels&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdMarkers&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;1px&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">13</span>,</span><br><span class="line">          <span class="attr">&quot;interval&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;mappingType&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;mappingTypes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;value to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;range to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">2</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;maxDataPoints&quot;</span>: <span class="number">100</span>,</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;nullText&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;postfix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;postfixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;rangeMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;from&quot;</span>: <span class="string">&quot;null&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;sparkline&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;fillColor&quot;</span>: <span class="string">&quot;rgba(31, 118, 189, 0.18)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;full&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;lineColor&quot;</span>: <span class="string">&quot;rgb(31, 120, 193)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (container_fs_usage_bytes&#123;device=~\&quot;^/dev/[sv]d[a-z][1-9]$\&quot;,id=\&quot;/\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;thresholds&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Used&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;singlestat&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;op&quot;</span>: <span class="string">&quot;=&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;valueName&quot;</span>: <span class="string">&quot;current&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;cacheTimeout&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;colorBackground&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colorValue&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;colors&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;rgba(50, 172, 45, 0.97)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(237, 129, 40, 0.89)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;rgba(245, 54, 54, 0.9)&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;bytes&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;gauge&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;maxValue&quot;</span>: <span class="number">100</span>,</span><br><span class="line">            <span class="attr">&quot;minValue&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdLabels&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;thresholdMarkers&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;1px&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">14</span>,</span><br><span class="line">          <span class="attr">&quot;interval&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;mappingType&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;mappingTypes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;value to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;range to text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="number">2</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;maxDataPoints&quot;</span>: <span class="number">100</span>,</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;nullText&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;postfix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;postfixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;prefixFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;rangeMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;from&quot;</span>: <span class="string">&quot;null&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;sparkline&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;fillColor&quot;</span>: <span class="string">&quot;rgba(31, 118, 189, 0.18)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;full&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;lineColor&quot;</span>: <span class="string">&quot;rgb(31, 120, 193)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (container_fs_limit_bytes&#123;device=~\&quot;^/dev/[sv]d[a-z][1-9]$\&quot;,id=\&quot;/\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;thresholds&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Total&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;singlestat&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueFontSize&quot;</span>: <span class="string">&quot;50%&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;valueMaps&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;op&quot;</span>: <span class="string">&quot;=&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;valueName&quot;</span>: <span class="string">&quot;current&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;showTitle&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Total usage&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;collapse&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;250px&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;panels&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;aliasColors&quot;</span>: &#123;&#125;,</span><br><span class="line">          <span class="attr">&quot;bars&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">3</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;fill&quot;</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="attr">&quot;grid&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;threshold1&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold1Color&quot;</span>: <span class="string">&quot;rgba(216, 200, 27, 0.27)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2Color&quot;</span>: <span class="string">&quot;rgba(234, 112, 112, 0.22)&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">17</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;legend&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;alignAsTable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;avg&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;current&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;max&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;min&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;rightSide&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="string">&quot;current&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;sortDesc&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;total&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;values&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;lines&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;linewidth&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;percentage&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;pointradius&quot;</span>: <span class="number">5</span>,</span><br><span class="line">          <span class="attr">&quot;points&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;renderer&quot;</span>: <span class="string">&quot;flot&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;seriesOverrides&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">&quot;stack&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;steppedLine&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_cpu_usage_seconds_total&#123;image!=\&quot;\&quot;,name=~\&quot;^k8s_.*\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (pod_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;&#123;&#123; pod_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;container_cpu&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;timeFrom&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;timeShift&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Pods CPU usage (1m avg)&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;tooltip&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;msResolution&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;shared&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;value_type&quot;</span>: <span class="string">&quot;cumulative&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;transparent&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;graph&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;xaxis&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;yaxes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="string">&quot;cores&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;short&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;showTitle&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Pods CPU usage&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;collapse&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;250px&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;panels&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;aliasColors&quot;</span>: &#123;&#125;,</span><br><span class="line">          <span class="attr">&quot;bars&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">3</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;fill&quot;</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="attr">&quot;grid&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;threshold1&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold1Color&quot;</span>: <span class="string">&quot;rgba(216, 200, 27, 0.27)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2Color&quot;</span>: <span class="string">&quot;rgba(234, 112, 112, 0.22)&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">23</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;legend&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;alignAsTable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;avg&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;current&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;max&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;min&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;rightSide&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="string">&quot;current&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;sortDesc&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;total&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;values&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;lines&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;linewidth&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;percentage&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;pointradius&quot;</span>: <span class="number">5</span>,</span><br><span class="line">          <span class="attr">&quot;points&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;renderer&quot;</span>: <span class="string">&quot;flot&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;seriesOverrides&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">&quot;stack&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;steppedLine&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_cpu_usage_seconds_total&#123;systemd_service_name!=\&quot;\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (systemd_service_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;hide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;&#123;&#123; systemd_service_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;container_cpu&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;timeFrom&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;timeShift&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;System services CPU usage (1m avg)&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;tooltip&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;msResolution&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;shared&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;value_type&quot;</span>: <span class="string">&quot;cumulative&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;graph&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;xaxis&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;yaxes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="string">&quot;cores&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;short&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;System services CPU usage&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;collapse&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;250px&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;panels&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;aliasColors&quot;</span>: &#123;&#125;,</span><br><span class="line">          <span class="attr">&quot;bars&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">3</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;fill&quot;</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="attr">&quot;grid&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;threshold1&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold1Color&quot;</span>: <span class="string">&quot;rgba(216, 200, 27, 0.27)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2Color&quot;</span>: <span class="string">&quot;rgba(234, 112, 112, 0.22)&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">24</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;legend&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;alignAsTable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;avg&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;current&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;hideEmpty&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;hideZero&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;max&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;min&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;rightSide&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sideWidth&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="string">&quot;current&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;sortDesc&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;total&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;values&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;lines&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;linewidth&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;percentage&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;pointradius&quot;</span>: <span class="number">5</span>,</span><br><span class="line">          <span class="attr">&quot;points&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;renderer&quot;</span>: <span class="string">&quot;flot&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;seriesOverrides&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">&quot;stack&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;steppedLine&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_cpu_usage_seconds_total&#123;image!=\&quot;\&quot;,name=~\&quot;^k8s_.*\&quot;,container_name!=\&quot;POD\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (container_name, pod_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;hide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;pod: &#123;&#123; pod_name &#125;&#125; | &#123;&#123; container_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;container_cpu&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_cpu_usage_seconds_total&#123;image!=\&quot;\&quot;,name!~\&quot;^k8s_.*\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (kubernetes_io_hostname, name, image)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;hide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;docker: &#123;&#123; kubernetes_io_hostname &#125;&#125; | &#123;&#123; image &#125;&#125; (&#123;&#123; name &#125;&#125;)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;container_cpu&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;B&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_cpu_usage_seconds_total&#123;rkt_container_name!=\&quot;\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (kubernetes_io_hostname, rkt_container_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;rkt: &#123;&#123; kubernetes_io_hostname &#125;&#125; | &#123;&#123; rkt_container_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;container_cpu&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;C&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;timeFrom&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;timeShift&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Containers CPU usage (1m avg)&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;tooltip&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;msResolution&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;shared&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;value_type&quot;</span>: <span class="string">&quot;cumulative&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;graph&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;xaxis&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;yaxes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="string">&quot;cores&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;short&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Containers CPU usage&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;collapse&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;500px&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;panels&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;aliasColors&quot;</span>: &#123;&#125;,</span><br><span class="line">          <span class="attr">&quot;bars&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">3</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;fill&quot;</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="attr">&quot;grid&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;threshold1&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold1Color&quot;</span>: <span class="string">&quot;rgba(216, 200, 27, 0.27)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2Color&quot;</span>: <span class="string">&quot;rgba(234, 112, 112, 0.22)&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">20</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;legend&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;alignAsTable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;avg&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;current&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;max&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;min&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;rightSide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="string">&quot;current&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;sortDesc&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;total&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;values&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;lines&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;linewidth&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;percentage&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;pointradius&quot;</span>: <span class="number">5</span>,</span><br><span class="line">          <span class="attr">&quot;points&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;renderer&quot;</span>: <span class="string">&quot;flot&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;seriesOverrides&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">&quot;stack&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;steppedLine&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_cpu_usage_seconds_total&#123;id!=\&quot;/\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (id)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;hide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;&#123;&#123; id &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;container_cpu&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;timeFrom&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;timeShift&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;All processes CPU usage (1m avg)&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;tooltip&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;msResolution&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;shared&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;value_type&quot;</span>: <span class="string">&quot;cumulative&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;graph&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;xaxis&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;yaxes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="string">&quot;cores&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;short&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;repeat&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">&quot;showTitle&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;All processes CPU usage&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;collapse&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;250px&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;panels&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;aliasColors&quot;</span>: &#123;&#125;,</span><br><span class="line">          <span class="attr">&quot;bars&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;fill&quot;</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="attr">&quot;grid&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;threshold1&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold1Color&quot;</span>: <span class="string">&quot;rgba(216, 200, 27, 0.27)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2Color&quot;</span>: <span class="string">&quot;rgba(234, 112, 112, 0.22)&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">25</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;legend&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;alignAsTable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;avg&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;current&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;max&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;min&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;rightSide&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sideWidth&quot;</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="string">&quot;current&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;sortDesc&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;total&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;values&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;lines&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;linewidth&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;percentage&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;pointradius&quot;</span>: <span class="number">5</span>,</span><br><span class="line">          <span class="attr">&quot;points&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;renderer&quot;</span>: <span class="string">&quot;flot&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;seriesOverrides&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">&quot;stack&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;steppedLine&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (container_memory_working_set_bytes&#123;image!=\&quot;\&quot;,name=~\&quot;^k8s_.*\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;) by (pod_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;&#123;&#123; pod_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;container_memory_usage:sort_desc&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;timeFrom&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;timeShift&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Pods memory usage&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;tooltip&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;msResolution&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;shared&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;value_type&quot;</span>: <span class="string">&quot;cumulative&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;graph&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;xaxis&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;yaxes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;bytes&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;short&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Pods memory usage&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;collapse&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;250px&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;panels&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;aliasColors&quot;</span>: &#123;&#125;,</span><br><span class="line">          <span class="attr">&quot;bars&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;fill&quot;</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="attr">&quot;grid&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;threshold1&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold1Color&quot;</span>: <span class="string">&quot;rgba(216, 200, 27, 0.27)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2Color&quot;</span>: <span class="string">&quot;rgba(234, 112, 112, 0.22)&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">26</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;legend&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;alignAsTable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;avg&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;current&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;max&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;min&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;rightSide&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sideWidth&quot;</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="string">&quot;current&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;sortDesc&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;total&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;values&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;lines&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;linewidth&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;percentage&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;pointradius&quot;</span>: <span class="number">5</span>,</span><br><span class="line">          <span class="attr">&quot;points&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;renderer&quot;</span>: <span class="string">&quot;flot&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;seriesOverrides&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">&quot;stack&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;steppedLine&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (container_memory_working_set_bytes&#123;systemd_service_name!=\&quot;\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;) by (systemd_service_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;&#123;&#123; systemd_service_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;container_memory_usage:sort_desc&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;timeFrom&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;timeShift&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;System services memory usage&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;tooltip&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;msResolution&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;shared&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;value_type&quot;</span>: <span class="string">&quot;cumulative&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;graph&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;xaxis&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;yaxes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;bytes&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;short&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;System services memory usage&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;collapse&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;250px&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;panels&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;aliasColors&quot;</span>: &#123;&#125;,</span><br><span class="line">          <span class="attr">&quot;bars&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;fill&quot;</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="attr">&quot;grid&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;threshold1&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold1Color&quot;</span>: <span class="string">&quot;rgba(216, 200, 27, 0.27)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2Color&quot;</span>: <span class="string">&quot;rgba(234, 112, 112, 0.22)&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">27</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;legend&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;alignAsTable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;avg&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;current&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;max&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;min&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;rightSide&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sideWidth&quot;</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="string">&quot;current&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;sortDesc&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;total&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;values&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;lines&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;linewidth&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;percentage&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;pointradius&quot;</span>: <span class="number">5</span>,</span><br><span class="line">          <span class="attr">&quot;points&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;renderer&quot;</span>: <span class="string">&quot;flot&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;seriesOverrides&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">&quot;stack&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;steppedLine&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (container_memory_working_set_bytes&#123;image!=\&quot;\&quot;,name=~\&quot;^k8s_.*\&quot;,container_name!=\&quot;POD\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;) by (container_name, pod_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;pod: &#123;&#123; pod_name &#125;&#125; | &#123;&#123; container_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;container_memory_usage:sort_desc&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (container_memory_working_set_bytes&#123;image!=\&quot;\&quot;,name!~\&quot;^k8s_.*\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;) by (kubernetes_io_hostname, name, image)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;docker: &#123;&#123; kubernetes_io_hostname &#125;&#125; | &#123;&#123; image &#125;&#125; (&#123;&#123; name &#125;&#125;)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;container_memory_usage:sort_desc&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;B&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (container_memory_working_set_bytes&#123;rkt_container_name!=\&quot;\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;) by (kubernetes_io_hostname, rkt_container_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;rkt: &#123;&#123; kubernetes_io_hostname &#125;&#125; | &#123;&#123; rkt_container_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;container_memory_usage:sort_desc&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;C&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;timeFrom&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;timeShift&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Containers memory usage&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;tooltip&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;msResolution&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;shared&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;value_type&quot;</span>: <span class="string">&quot;cumulative&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;graph&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;xaxis&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;yaxes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;bytes&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;short&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Containers memory usage&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;collapse&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;500px&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;panels&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;aliasColors&quot;</span>: &#123;&#125;,</span><br><span class="line">          <span class="attr">&quot;bars&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;fill&quot;</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="attr">&quot;grid&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;threshold1&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold1Color&quot;</span>: <span class="string">&quot;rgba(216, 200, 27, 0.27)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2Color&quot;</span>: <span class="string">&quot;rgba(234, 112, 112, 0.22)&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">28</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;legend&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;alignAsTable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;avg&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;current&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;max&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;min&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;rightSide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sideWidth&quot;</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="string">&quot;current&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;sortDesc&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;total&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;values&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;lines&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;linewidth&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;percentage&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;pointradius&quot;</span>: <span class="number">5</span>,</span><br><span class="line">          <span class="attr">&quot;points&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;renderer&quot;</span>: <span class="string">&quot;flot&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;seriesOverrides&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">&quot;stack&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;steppedLine&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (container_memory_working_set_bytes&#123;id!=\&quot;/\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;) by (id)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;&#123;&#123; id &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;container_memory_usage:sort_desc&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;timeFrom&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;timeShift&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;All processes memory usage&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;tooltip&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;msResolution&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;shared&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;value_type&quot;</span>: <span class="string">&quot;cumulative&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;graph&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;xaxis&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;yaxes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;bytes&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;short&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;All processes memory usage&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;collapse&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;250px&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;panels&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;aliasColors&quot;</span>: &#123;&#125;,</span><br><span class="line">          <span class="attr">&quot;bars&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;fill&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;grid&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;threshold1&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold1Color&quot;</span>: <span class="string">&quot;rgba(216, 200, 27, 0.27)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2Color&quot;</span>: <span class="string">&quot;rgba(234, 112, 112, 0.22)&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">16</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;legend&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;alignAsTable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;avg&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;current&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;max&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;min&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;rightSide&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sideWidth&quot;</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="string">&quot;current&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;sortDesc&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;total&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;values&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;lines&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;linewidth&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;percentage&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;pointradius&quot;</span>: <span class="number">5</span>,</span><br><span class="line">          <span class="attr">&quot;points&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;renderer&quot;</span>: <span class="string">&quot;flot&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;seriesOverrides&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">&quot;stack&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;steppedLine&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_network_receive_bytes_total&#123;image!=\&quot;\&quot;,name=~\&quot;^k8s_.*\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (pod_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;-&gt; &#123;&#123; pod_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;network&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;- sum (rate (container_network_transmit_bytes_total&#123;image!=\&quot;\&quot;,name=~\&quot;^k8s_.*\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (pod_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;&lt;- &#123;&#123; pod_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;network&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;B&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;timeFrom&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;timeShift&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Pods network I/O (1m avg)&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;tooltip&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;msResolution&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;shared&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;value_type&quot;</span>: <span class="string">&quot;cumulative&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;graph&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;xaxis&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;yaxes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;Bps&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;short&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Pods network I/O&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;collapse&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;250px&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;panels&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;aliasColors&quot;</span>: &#123;&#125;,</span><br><span class="line">          <span class="attr">&quot;bars&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;fill&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;grid&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;threshold1&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold1Color&quot;</span>: <span class="string">&quot;rgba(216, 200, 27, 0.27)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2Color&quot;</span>: <span class="string">&quot;rgba(234, 112, 112, 0.22)&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">30</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;legend&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;alignAsTable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;avg&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;current&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;max&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;min&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;rightSide&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sideWidth&quot;</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="string">&quot;current&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;sortDesc&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;total&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;values&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;lines&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;linewidth&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;percentage&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;pointradius&quot;</span>: <span class="number">5</span>,</span><br><span class="line">          <span class="attr">&quot;points&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;renderer&quot;</span>: <span class="string">&quot;flot&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;seriesOverrides&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">&quot;stack&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;steppedLine&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_network_receive_bytes_total&#123;image!=\&quot;\&quot;,name=~\&quot;^k8s_.*\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (container_name, pod_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;hide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;-&gt; pod: &#123;&#123; pod_name &#125;&#125; | &#123;&#123; container_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;network&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;B&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;- sum (rate (container_network_transmit_bytes_total&#123;image!=\&quot;\&quot;,name=~\&quot;^k8s_.*\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (container_name, pod_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;hide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;&lt;- pod: &#123;&#123; pod_name &#125;&#125; | &#123;&#123; container_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;network&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;D&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_network_receive_bytes_total&#123;image!=\&quot;\&quot;,name!~\&quot;^k8s_.*\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (kubernetes_io_hostname, name, image)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;hide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;-&gt; docker: &#123;&#123; kubernetes_io_hostname &#125;&#125; | &#123;&#123; image &#125;&#125; (&#123;&#123; name &#125;&#125;)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;network&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;- sum (rate (container_network_transmit_bytes_total&#123;image!=\&quot;\&quot;,name!~\&quot;^k8s_.*\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (kubernetes_io_hostname, name, image)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;hide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;&lt;- docker: &#123;&#123; kubernetes_io_hostname &#125;&#125; | &#123;&#123; image &#125;&#125; (&#123;&#123; name &#125;&#125;)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;network&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;C&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_network_transmit_bytes_total&#123;rkt_container_name!=\&quot;\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (kubernetes_io_hostname, rkt_container_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;hide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;-&gt; rkt: &#123;&#123; kubernetes_io_hostname &#125;&#125; | &#123;&#123; rkt_container_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;network&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;E&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;- sum (rate (container_network_transmit_bytes_total&#123;rkt_container_name!=\&quot;\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (kubernetes_io_hostname, rkt_container_name)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;hide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;&lt;- rkt: &#123;&#123; kubernetes_io_hostname &#125;&#125; | &#123;&#123; rkt_container_name &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;network&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;F&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;timeFrom&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;timeShift&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Containers network I/O (1m avg)&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;tooltip&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;msResolution&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;shared&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;value_type&quot;</span>: <span class="string">&quot;cumulative&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;graph&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;xaxis&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;yaxes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;Bps&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;short&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Containers network I/O&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;collapse&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;height&quot;</span>: <span class="string">&quot;500px&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;panels&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;aliasColors&quot;</span>: &#123;&#125;,</span><br><span class="line">          <span class="attr">&quot;bars&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;editable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;error&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;fill&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;grid&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;threshold1&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold1Color&quot;</span>: <span class="string">&quot;rgba(216, 200, 27, 0.27)&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;threshold2Color&quot;</span>: <span class="string">&quot;rgba(234, 112, 112, 0.22)&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">29</span>,</span><br><span class="line">          <span class="attr">&quot;isNew&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;legend&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;alignAsTable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;avg&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;current&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;max&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;min&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;rightSide&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sideWidth&quot;</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="string">&quot;current&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;sortDesc&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;total&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;values&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;lines&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">&quot;linewidth&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;nullPointMode&quot;</span>: <span class="string">&quot;connected&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;percentage&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;pointradius&quot;</span>: <span class="number">5</span>,</span><br><span class="line">          <span class="attr">&quot;points&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;renderer&quot;</span>: <span class="string">&quot;flot&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;seriesOverrides&quot;</span>: [],</span><br><span class="line">          <span class="attr">&quot;span&quot;</span>: <span class="number">12</span>,</span><br><span class="line">          <span class="attr">&quot;stack&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;steppedLine&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;sum (rate (container_network_receive_bytes_total&#123;id!=\&quot;/\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (id)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;-&gt; &#123;&#123; id &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;network&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;expr&quot;</span>: <span class="string">&quot;- sum (rate (container_network_transmit_bytes_total&#123;id!=\&quot;/\&quot;,kubernetes_io_hostname=~\&quot;^$Node$\&quot;&#125;[1m])) by (id)&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;intervalFactor&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;legendFormat&quot;</span>: <span class="string">&quot;&lt;- &#123;&#123; id &#125;&#125;&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;metric&quot;</span>: <span class="string">&quot;network&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;refId&quot;</span>: <span class="string">&quot;B&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;step&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">&quot;timeFrom&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;timeShift&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">          <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;All processes network I/O (1m avg)&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;tooltip&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;msResolution&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;shared&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;sort&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;value_type&quot;</span>: <span class="string">&quot;cumulative&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;graph&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;xaxis&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;yaxes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;Bps&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;short&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;label&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;logBase&quot;</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">&quot;max&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;min&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">&quot;show&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;All processes network I/O&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;time&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;from&quot;</span>: <span class="string">&quot;now-5m&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;now&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;timepicker&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;refresh_intervals&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;5s&quot;</span>,</span><br><span class="line">      <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">      <span class="string">&quot;30s&quot;</span>,</span><br><span class="line">      <span class="string">&quot;1m&quot;</span>,</span><br><span class="line">      <span class="string">&quot;5m&quot;</span>,</span><br><span class="line">      <span class="string">&quot;15m&quot;</span>,</span><br><span class="line">      <span class="string">&quot;30m&quot;</span>,</span><br><span class="line">      <span class="string">&quot;1h&quot;</span>,</span><br><span class="line">      <span class="string">&quot;2h&quot;</span>,</span><br><span class="line">      <span class="string">&quot;1d&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;time_options&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;5m&quot;</span>,</span><br><span class="line">      <span class="string">&quot;15m&quot;</span>,</span><br><span class="line">      <span class="string">&quot;1h&quot;</span>,</span><br><span class="line">      <span class="string">&quot;6h&quot;</span>,</span><br><span class="line">      <span class="string">&quot;12h&quot;</span>,</span><br><span class="line">      <span class="string">&quot;24h&quot;</span>,</span><br><span class="line">      <span class="string">&quot;2d&quot;</span>,</span><br><span class="line">      <span class="string">&quot;7d&quot;</span>,</span><br><span class="line">      <span class="string">&quot;30d&quot;</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;templating&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;list&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;allValue&quot;</span>: <span class="string">&quot;.*&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;current&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="attr">&quot;datasource&quot;</span>: <span class="string">&quot;$&#123;DS_PROMETHEUS&#125;&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;hide&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;includeAll&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">&quot;multi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Node&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;options&quot;</span>: [],</span><br><span class="line">        <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;label_values(kubernetes_io_hostname)&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;refresh&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;query&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;annotations&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;list&quot;</span>: []</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;refresh&quot;</span>: <span class="string">&quot;10s&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;schemaVersion&quot;</span>: <span class="number">12</span>,</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="number">13</span>,</span><br><span class="line">  <span class="attr">&quot;links&quot;</span>: [],</span><br><span class="line">  <span class="attr">&quot;gnetId&quot;</span>: <span class="number">315</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-06_11-50-15.png" alt="Snipaste_2020-12-06_11-50-15"></p><p>loadä¹‹åè¿˜éœ€è¦é€‰æ‹©ä¹‹é—´æ–°å¢çš„æ•°æ®æºprometheusã€‚å¯¼å…¥æ¨¡æ¿å®Œæˆã€‚</p><blockquote><p>æ³¨æ„</p><p>å¦‚æœæœ€åæ•°æ®ç»Ÿè®¡ä¸å‡ºæ¥ï¼Œè¯·æ³¨æ„æœ¬æœºã€Grafanaã€Prometheusçš„æ—¶åŒºæ˜¯ä¸æ˜¯ä¸€è‡´çš„ï¼Œè¦æ˜¯ä¸€æ ·çš„æ—¶é—´æ‰å¯ä»¥ã€‚</p></blockquote><h1 id="æ­å»ºé«˜å¯ç”¨çš„é›†ç¾¤"><a href="#æ­å»ºé«˜å¯ç”¨çš„é›†ç¾¤" class="headerlink" title="æ­å»ºé«˜å¯ç”¨çš„é›†ç¾¤"></a>æ­å»ºé«˜å¯ç”¨çš„é›†ç¾¤</h1><p>ä¹‹å‰1ä¸ªmasterã€2ä¸ªworkerçš„é›†ç¾¤æœ‰ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜ï¼Œè¿™ç§åªæœ‰1ä¸ªmasterçš„é›†ç¾¤çš„é€šç”¨é—®é¢˜å³å•ç‚¹æ•…éšœï¼Œå½“æˆ‘ä»¬çš„masterç”±äºæŸç§åŸå› å®•æœºä¹‹åï¼Œæ•´ä¸ªé›†ç¾¤å°±ä¼šåœæ­¢å·¥ä½œäº†ï¼Œæ²¡æœ‰äººæ¥æŒ‡æŒ¥äº†ã€‚</p><p>è¦æƒ³è§£å†³è¿™ä¸­é—®é¢˜ï¼Œé€šå¸¸æ–¹æ¡ˆæ˜¯å¯ç”¨å¤šä¸ªmasterï¼Œç„¶åå°±æ²¡æœ‰å•ç‚¹æ•…éšœé—®é¢˜äº†ï¼Œè‡³äºæ€ä¹ˆä½¿ç”¨å¤šä¸ªmasterä¸åŒçš„é›†ç¾¤æœ‰ä¸åŒçš„é€»è¾‘ï¼Œä¾‹å¦‚ï¼š</p><ul><li>Hadoopé›†ç¾¤æ˜¯active masterå’Œstandby masterï¼Œactive masterå®•æœºä¹‹åè¢«æ£€æµ‹åˆ°standby masterå°±åˆ‡æ¢ä¸ºactive master</li><li>k8sé›†ç¾¤æ˜¯å¤šä¸ªmasteréƒ½å®‰è£…äº†HAProxyæ’ä»¶ï¼Œworkeré€šè¿‡è™šæ‹ŸIPè¿æ¥åˆ°ä¸€å°masteræ—¶ï¼Œmasterçš„HAProxyä½¿ç”¨è´Ÿè½½å‡è¡¡å°†ä»»åŠ¡éšæœº(å¯è®¾ç½®è§„åˆ™)å‘é€ç»™ä»»ä¸€master</li></ul><blockquote><p>k8sä¸­çš„è™šæ‹ŸIPæ˜¯é€šè¿‡keepalivedå®ç°çš„ï¼Œkeepalivedå°†ä¸€è™šæ‹ŸIPåŒæ—¶ç»‘å®šåˆ°æ‰€æœ‰masterã€‚ä½†æ˜¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€å°masterå­˜åœ¨è¿™ä¸ªè™šæ‹ŸIPï¼Œåªæœ‰è¿™å°masterå®•æœºä¹‹åï¼Œè™šæ‹ŸIPæ‰ä¼šé£˜å‘å…¶ä»–è®¾ç½®äº†keepalivedçš„masterèŠ‚ç‚¹ã€‚</p></blockquote><p><strong>k8sé«˜å¯ç”¨é›†ç¾¤è°ƒç”¨å±•ç¤ºï¼š</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201209111646898.png" alt="image-20201209111646898"></p><p><strong>k8sé«˜å¯ç”¨é›†ç¾¤å„è§’è‰²ä»»åŠ¡å±•ç¤ºï¼š</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201209112543393.png" alt="image-20201209112543393"></p><p><strong>æŒ‚æ‰æ‹¥æœ‰vipçš„masterï¼Œvip(æ˜¯æŒ‡å®šçš„ä¸€ä¸ªå›ºå®šIP)ä¼šè‡ªåŠ¨é£˜å‘å…¶å®ƒmasterï¼Œkeepalivedå®ç°ï¼Œæ­¤æ—¶nodeä¼šè‡ªåŠ¨è¿æ¥vipï¼Œä½†æ­¤æ—¶æ‹¥æœ‰vipçš„èŠ‚ç‚¹å·²ç»æ˜¯å…¶ä»–masterï¼š</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201209112909081.png" alt="image-20201209112909081"></p><p>è‹¥æŒ‚æ‰æ²¡æœ‰VIPçš„èŠ‚ç‚¹ï¼Œåˆ™HAProxyä¸ä¼šå°†è¯·æ±‚è´Ÿè½½åˆ°æ­¤èŠ‚ç‚¹ä¸Šï¼Œå¯¹é›†ç¾¤åŠŸèƒ½æ²¡æœ‰å½±å“ã€‚</p><blockquote><p>é›†ç¾¤å†…å®ç°åŠŸèƒ½çš„å„ä¸ªç»„ä»¶ï¼š</p><ol><li>è´Ÿè½½å‡è¡¡-&gt;HAProxy</li><li>è™šæ‹ŸIP-&gt;keepalived</li></ol></blockquote><h2 id="å®‰è£…è¦æ±‚"><a href="#å®‰è£…è¦æ±‚" class="headerlink" title="å®‰è£…è¦æ±‚"></a>å®‰è£…è¦æ±‚</h2><p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œéƒ¨ç½²Kubernetesé›†ç¾¤æœºå™¨éœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶ï¼š</p><ul><li>ä¸€å°æˆ–å¤šå°æœºå™¨ï¼Œæ“ä½œç³»ç»Ÿ CentOS7.x-86_x64</li><li>ç¡¬ä»¶é…ç½®ï¼š2GBæˆ–æ›´å¤šRAMï¼Œ2ä¸ªCPUæˆ–æ›´å¤šCPUï¼Œç¡¬ç›˜30GBæˆ–æ›´å¤š</li><li>å¯ä»¥è®¿é—®å¤–ç½‘ï¼Œéœ€è¦æ‹‰å–é•œåƒï¼Œå¦‚æœæœåŠ¡å™¨ä¸èƒ½ä¸Šç½‘ï¼Œéœ€è¦æå‰ä¸‹è½½é•œåƒå¹¶å¯¼å…¥èŠ‚ç‚¹</li><li>ç¦æ­¢swapåˆ†åŒº</li></ul><h2 id="å‡†å¤‡ç¯å¢ƒ"><a href="#å‡†å¤‡ç¯å¢ƒ" class="headerlink" title="å‡†å¤‡ç¯å¢ƒ"></a>å‡†å¤‡ç¯å¢ƒ</h2><table><thead><tr><th>è§’è‰²</th><th>IP</th><th>keepalived</th><th>kubeadm init</th><th>docker</th></tr></thead><tbody><tr><td>master1</td><td>192.168.44.155</td><td>âˆš</td><td>âˆš</td><td>âˆš</td></tr><tr><td>master2</td><td>192.168.44.156</td><td>âˆš</td><td>åŠ å…¥</td><td>âˆš</td></tr><tr><td>node1</td><td>192.168.44.157</td><td></td><td>åŠ å…¥</td><td>âˆš</td></tr><tr><td>VIPï¼ˆè™šæ‹Ÿipï¼‰</td><td>192.168.44.158</td><td></td><td></td><td></td></tr></tbody></table><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å…³é—­é˜²ç«å¢™</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å…³é—­selinux</span></span><br><span class="line">sed -i &#x27;s/enforcing/disabled/&#x27; /etc/selinux/config  # æ°¸ä¹…</span><br><span class="line">setenforce 0  # ä¸´æ—¶</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å…³é—­swap</span></span><br><span class="line">swapoff -a  # ä¸´æ—¶</span><br><span class="line">sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab    # æ°¸ä¹…</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ ¹æ®è§„åˆ’è®¾ç½®ä¸»æœºå</span></span><br><span class="line">hostnamectl set-hostname &lt;hostname&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> åœ¨masteræ·»åŠ hosts</span></span><br><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line">192.168.44.158    master.k8s.io   k8s-vip</span><br><span class="line">192.168.44.155    master01.k8s.io master1</span><br><span class="line">192.168.44.156    master02.k8s.io master2</span><br><span class="line">192.168.44.157    node01.k8s.io   node1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å°†æ¡¥æ¥çš„IPv4æµé‡ä¼ é€’åˆ°iptablesçš„é“¾</span></span><br><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line">sysctl --system  # ç”Ÿæ•ˆ</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ—¶é—´åŒæ­¥</span></span><br><span class="line">yum install ntpdate -y</span><br><span class="line">ntpdate time.windows.com</span><br></pre></td></tr></table></figure><blockquote><p>Linux hosts</p><p>ä¸€èˆ¬æƒ…å†µä¸‹hostsæ–‡ä»¶çš„æ¯è¡Œå°¾ä¸€ä¸ªä¸»æœºï¼Œæ¯è¡Œç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œæ¯ä¸ªéƒ¨åˆ†ç”±ç©ºæ ¼éš”å¼€ã€‚</p><ol><li>ç½‘ç»œIPåœ°å€</li><li>ä¸»æœºåæˆ–åŸŸå</li><li>ä¸»æœºååˆ«å</li></ol></blockquote><h2 id="æ‰€æœ‰masterèŠ‚ç‚¹éƒ¨ç½²keepalived"><a href="#æ‰€æœ‰masterèŠ‚ç‚¹éƒ¨ç½²keepalived" class="headerlink" title="æ‰€æœ‰masterèŠ‚ç‚¹éƒ¨ç½²keepalived"></a>æ‰€æœ‰masterèŠ‚ç‚¹éƒ¨ç½²keepalived</h2><h3 id="å®‰è£…ç›¸å…³åŒ…å’Œkeepalived"><a href="#å®‰è£…ç›¸å…³åŒ…å’Œkeepalived" class="headerlink" title="å®‰è£…ç›¸å…³åŒ…å’Œkeepalived"></a>å®‰è£…ç›¸å…³åŒ…å’Œkeepalived</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y conntrack-tools libseccomp libtool-ltdl</span><br><span class="line"></span><br><span class="line">yum install -y keepalived</span><br></pre></td></tr></table></figure><h3 id="é…ç½®masterèŠ‚ç‚¹"><a href="#é…ç½®masterèŠ‚ç‚¹" class="headerlink" title="é…ç½®masterèŠ‚ç‚¹"></a>é…ç½®masterèŠ‚ç‚¹</h3><p>master1èŠ‚ç‚¹é…ç½®</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt;EOF </span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id k8s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_haproxy &#123;</span><br><span class="line">    script &quot;killall -0 haproxy&quot;</span><br><span class="line">    interval 3</span><br><span class="line">    weight -2</span><br><span class="line">    fall 10</span><br><span class="line">    rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER </span><br><span class="line">    interface ens33 </span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 250</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass ceb1b3ec013d66163d6ab</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.44.158</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_haproxy</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>master2èŠ‚ç‚¹é…ç½®</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt;EOF </span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id k8s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_haproxy &#123;</span><br><span class="line">    script &quot;killall -0 haproxy&quot;</span><br><span class="line">    interval 3</span><br><span class="line">    weight -2</span><br><span class="line">    fall 10</span><br><span class="line">    rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP </span><br><span class="line">    interface ens33 </span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 200</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass ceb1b3ec013d66163d6ab</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.44.158</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_haproxy</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201209114249444.png" alt="image-20201209114249444"></p><p><strong>é€šè¿‡å¯¹æ¯”ä¸Šé¢çš„å‘½ä»¤ï¼Œæ¥è¯´æ˜ä¸€ä¸‹é…ç½®æ–‡ä»¶çš„æ³¨æ„ç‚¹</strong></p><ol><li>master2çš„stateæ˜¯backupï¼Œmaster1æ˜¯masterã€‚æ‰€ä»¥ä¸€å¼€å§‹è™šæ‹ŸIP<code>192.168.44.158</code>ä¼šåœ¨master1ä¸Š</li><li>ä¸¤è€…çš„interfaceéƒ½è¦å†™è‡ªå·±èŠ‚ç‚¹çš„ç½‘å¡åï¼Œä¸€èˆ¬æ˜¯ens33</li><li>è¾“å…¥è‡ªå®šä¹‰çš„è™šæ‹ŸIPï¼Œè¦å’Œä½ è‡ªå·±èŠ‚ç‚¹çš„IPä¸€ä¸ªç½‘æ®µ</li></ol><h3 id="å¯åŠ¨å’Œæ£€æŸ¥"><a href="#å¯åŠ¨å’Œæ£€æŸ¥" class="headerlink" title="å¯åŠ¨å’Œæ£€æŸ¥"></a>å¯åŠ¨å’Œæ£€æŸ¥</h3><p>åœ¨ä¸¤å°masterèŠ‚ç‚¹éƒ½æ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯åŠ¨keepalived</span></span><br><span class="line">$ systemctl start keepalived.service</span><br><span class="line">è®¾ç½®å¼€æœºå¯åŠ¨</span><br><span class="line">$ systemctl <span class="built_in">enable</span> keepalived.service</span><br><span class="line"><span class="comment"># æŸ¥çœ‹å¯åŠ¨çŠ¶æ€</span></span><br><span class="line">$ systemctl status keepalived.service</span><br></pre></td></tr></table></figure><p>å¯åŠ¨åæŸ¥çœ‹master1çš„ç½‘å¡ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip a s ens33</span><br></pre></td></tr></table></figure><h2 id="éƒ¨ç½²haproxy"><a href="#éƒ¨ç½²haproxy" class="headerlink" title="éƒ¨ç½²haproxy"></a>éƒ¨ç½²haproxy</h2><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y haproxy</span><br></pre></td></tr></table></figure><h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><p>ä¸¤å°masterèŠ‚ç‚¹çš„é…ç½®å‡ç›¸åŒï¼Œé…ç½®ä¸­å£°æ˜äº†åç«¯ä»£ç†çš„ä¸¤ä¸ªmasterèŠ‚ç‚¹æœåŠ¡å™¨ï¼ŒæŒ‡å®šäº†haproxyè¿è¡Œçš„ç«¯å£ä¸º16443ç­‰ï¼Œå› æ­¤16443ç«¯å£ä¸ºé›†ç¾¤çš„å…¥å£</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/haproxy/haproxy.cfg &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="string"># Global settings</span></span><br><span class="line"><span class="string">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="string">global</span></span><br><span class="line"><span class="string">    # to have these messages end up in /var/log/haproxy.log you will</span></span><br><span class="line"><span class="string">    # need to:</span></span><br><span class="line"><span class="string">    # 1) configure syslog to accept network log events.  This is done</span></span><br><span class="line"><span class="string">    #    by adding the &#x27;-r&#x27; option to the SYSLOGD_OPTIONS in</span></span><br><span class="line"><span class="string">    #    /etc/sysconfig/syslog</span></span><br><span class="line"><span class="string">    # 2) configure local2 events to go to the /var/log/haproxy.log</span></span><br><span class="line"><span class="string">    #   file. A line like the following can be added to</span></span><br><span class="line"><span class="string">    #   /etc/sysconfig/syslog</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    #    local2.*                       /var/log/haproxy.log</span></span><br><span class="line"><span class="string">    #</span></span><br><span class="line"><span class="string">    log         127.0.0.1 local2</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    chroot      /var/lib/haproxy</span></span><br><span class="line"><span class="string">    pidfile     /var/run/haproxy.pid</span></span><br><span class="line"><span class="string">    maxconn     4000</span></span><br><span class="line"><span class="string">    user        haproxy</span></span><br><span class="line"><span class="string">    group       haproxy</span></span><br><span class="line"><span class="string">    daemon </span></span><br><span class="line"><span class="string">       </span></span><br><span class="line"><span class="string">    # turn on stats unix socket</span></span><br><span class="line"><span class="string">    stats socket /var/lib/haproxy/stats</span></span><br><span class="line"><span class="string">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="string"># common defaults that all the &#x27;listen&#x27; and &#x27;backend&#x27; sections will</span></span><br><span class="line"><span class="string"># use if not designated in their block</span></span><br><span class="line"><span class="string">#---------------------------------------------------------------------  </span></span><br><span class="line"><span class="string">defaults</span></span><br><span class="line"><span class="string">    mode                    http</span></span><br><span class="line"><span class="string">    log                     global</span></span><br><span class="line"><span class="string">    option                  httplog</span></span><br><span class="line"><span class="string">    option                  dontlognull</span></span><br><span class="line"><span class="string">    option http-server-close</span></span><br><span class="line"><span class="string">    option forwardfor       except 127.0.0.0/8</span></span><br><span class="line"><span class="string">    option                  redispatch</span></span><br><span class="line"><span class="string">    retries                 3</span></span><br><span class="line"><span class="string">    timeout http-request    10s</span></span><br><span class="line"><span class="string">    timeout queue           1m</span></span><br><span class="line"><span class="string">    timeout connect         10s</span></span><br><span class="line"><span class="string">    timeout client          1m</span></span><br><span class="line"><span class="string">    timeout server          1m</span></span><br><span class="line"><span class="string">    timeout http-keep-alive 10s</span></span><br><span class="line"><span class="string">    timeout check           10s</span></span><br><span class="line"><span class="string">    maxconn                 3000</span></span><br><span class="line"><span class="string">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="string"># kubernetes apiserver frontend which proxys to the backends</span></span><br><span class="line"><span class="string">#--------------------------------------------------------------------- </span></span><br><span class="line"><span class="string">frontend kubernetes-apiserver</span></span><br><span class="line"><span class="string">    mode                 tcp</span></span><br><span class="line"><span class="string">    bind                 *:16443</span></span><br><span class="line"><span class="string">    option               tcplog</span></span><br><span class="line"><span class="string">    default_backend      kubernetes-apiserver    </span></span><br><span class="line"><span class="string">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="string"># round robin balancing between the various backends</span></span><br><span class="line"><span class="string">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="string">backend kubernetes-apiserver</span></span><br><span class="line"><span class="string">    mode        tcp</span></span><br><span class="line"><span class="string">    balance     roundrobin</span></span><br><span class="line"><span class="string">    server      master01.k8s.io   192.168.44.155:6443 check</span></span><br><span class="line"><span class="string">    server      master02.k8s.io   192.168.44.156:6443 check</span></span><br><span class="line"><span class="string">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="string"># collection haproxy statistics message</span></span><br><span class="line"><span class="string">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="string">listen stats</span></span><br><span class="line"><span class="string">    bind                 *:1080</span></span><br><span class="line"><span class="string">    stats auth           admin:awesomePassword</span></span><br><span class="line"><span class="string">    stats refresh        5s</span></span><br><span class="line"><span class="string">    stats realm          HAProxy\ Statistics</span></span><br><span class="line"><span class="string">    stats uri            /admin?stats</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„ä¿®æ”¹æ–‡ä»¶ä¸­çš„ä¸»æœºåå’ŒIPå°±è¡Œ</p><h3 id="å¯åŠ¨å’Œæ£€æŸ¥-1"><a href="#å¯åŠ¨å’Œæ£€æŸ¥-1" class="headerlink" title="å¯åŠ¨å’Œæ£€æŸ¥"></a>å¯åŠ¨å’Œæ£€æŸ¥</h3><p>ä¸¤å°masteréƒ½å¯åŠ¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®å¼€æœºå¯åŠ¨</span></span><br><span class="line">$ systemctl <span class="built_in">enable</span> haproxy</span><br><span class="line"><span class="comment"># å¼€å¯haproxy</span></span><br><span class="line">$ systemctl start haproxy</span><br><span class="line"><span class="comment"># æŸ¥çœ‹å¯åŠ¨çŠ¶æ€</span></span><br><span class="line">$ systemctl status haproxy</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥ç«¯å£</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -lntup|grep haproxy</span><br></pre></td></tr></table></figure><h2 id="æ‰€æœ‰èŠ‚ç‚¹å®‰è£…Docker-kubeadm-kubelet"><a href="#æ‰€æœ‰èŠ‚ç‚¹å®‰è£…Docker-kubeadm-kubelet" class="headerlink" title="æ‰€æœ‰èŠ‚ç‚¹å®‰è£…Docker/kubeadm/kubelet"></a>æ‰€æœ‰èŠ‚ç‚¹å®‰è£…Docker/kubeadm/kubelet</h2><p>Kubernetesé»˜è®¤CRIï¼ˆå®¹å™¨è¿è¡Œæ—¶ï¼‰ä¸ºDockerï¼Œå› æ­¤å…ˆå®‰è£…Dockerã€‚</p><h3 id="å®‰è£…Docker"><a href="#å®‰è£…Docker" class="headerlink" title="å®‰è£…Docker"></a>å®‰è£…Docker</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">$ yum -y install docker-ce-18.06.1.ce-3.el7</span><br><span class="line">$ systemctl <span class="built_in">enable</span> docker &amp;&amp; systemctl start docker</span><br><span class="line">$ docker --version</span><br><span class="line">Docker version 18.06.1-ce, build e68fc7a</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; /etc/docker/daemon.json &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;registry-mirrors&quot;: [&quot;https://b9pmyelo.mirror.aliyuncs.com&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h3 id="æ·»åŠ é˜¿é‡Œäº‘YUMè½¯ä»¶æº"><a href="#æ·»åŠ é˜¿é‡Œäº‘YUMè½¯ä»¶æº" class="headerlink" title="æ·»åŠ é˜¿é‡Œäº‘YUMè½¯ä»¶æº"></a>æ·»åŠ é˜¿é‡Œäº‘YUMè½¯ä»¶æº</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">repo_gpgcheck=0</span></span><br><span class="line"><span class="string">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h3 id="å®‰è£…kubeadmï¼Œkubeletå’Œkubectl"><a href="#å®‰è£…kubeadmï¼Œkubeletå’Œkubectl" class="headerlink" title="å®‰è£…kubeadmï¼Œkubeletå’Œkubectl"></a>å®‰è£…kubeadmï¼Œkubeletå’Œkubectl</h3><p>ç”±äºç‰ˆæœ¬æ›´æ–°é¢‘ç¹ï¼Œè¿™é‡ŒæŒ‡å®šç‰ˆæœ¬å·éƒ¨ç½²ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y kubelet-1.16.3 kubeadm-1.16.3 kubectl-1.16.3</span><br><span class="line">$ systemctl <span class="built_in">enable</span> kubelet</span><br></pre></td></tr></table></figure><h2 id="éƒ¨ç½²Kubernetes-Master"><a href="#éƒ¨ç½²Kubernetes-Master" class="headerlink" title="éƒ¨ç½²Kubernetes Master"></a>éƒ¨ç½²Kubernetes Master</h2><h3 id="åˆ›å»ºkubeadmé…ç½®æ–‡ä»¶"><a href="#åˆ›å»ºkubeadmé…ç½®æ–‡ä»¶" class="headerlink" title="åˆ›å»ºkubeadmé…ç½®æ–‡ä»¶"></a>åˆ›å»ºkubeadmé…ç½®æ–‡ä»¶</h3><p><strong>åœ¨å…·æœ‰vipçš„masterä¸Šæ“ä½œï¼Œè¿™é‡Œä¸ºmaster1</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir /usr/<span class="built_in">local</span>/kubernetes/manifests -p</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/kubernetes/manifests/</span><br><span class="line"></span><br><span class="line">$ vi kubeadm-config.yaml</span><br><span class="line"></span><br><span class="line">apiServer:</span><br><span class="line">  certSANs:</span><br><span class="line">    - master1</span><br><span class="line">    - master2</span><br><span class="line">    - master.k8s.io</span><br><span class="line">    - 192.168.44.158</span><br><span class="line">    - 192.168.44.155</span><br><span class="line">    - 192.168.44.156</span><br><span class="line">    - 127.0.0.1</span><br><span class="line">  extraArgs:</span><br><span class="line">    authorization-mode: Node,RBAC</span><br><span class="line">  timeoutForControlPlane: 4m0s</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta1</span><br><span class="line">certificatesDir: /etc/kubernetes/pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">controlPlaneEndpoint: <span class="string">&quot;master.k8s.io:16443&quot;</span></span><br><span class="line">controllerManager: &#123;&#125;</span><br><span class="line">dns: </span><br><span class="line">  <span class="built_in">type</span>: CoreDNS</span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:    </span><br><span class="line">    dataDir: /var/lib/etcd</span><br><span class="line">imageRepository: registry.aliyuncs.com/google_containers</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.16.3</span><br><span class="line">networking: </span><br><span class="line">  dnsDomain: cluster.local  </span><br><span class="line">  podSubnet: 10.244.0.0/16</span><br><span class="line">  serviceSubnet: 10.1.0.0/16</span><br><span class="line">scheduler: &#123;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201209142119717.png" alt="image-20201209142119717"></p><p>è¿™é‡Œéœ€è¦å¡«master1ï¼Œmaster2ï¼Œè™šæ‹ŸIPçš„ä¸»æœºåå’ŒIP</p><h3 id="åœ¨master1èŠ‚ç‚¹æ‰§è¡Œ"><a href="#åœ¨master1èŠ‚ç‚¹æ‰§è¡Œ" class="headerlink" title="åœ¨master1èŠ‚ç‚¹æ‰§è¡Œ"></a>åœ¨master1èŠ‚ç‚¹æ‰§è¡Œ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm init --config kubeadm-config.yaml</span><br></pre></td></tr></table></figure><p>æŒ‰ç…§æç¤ºé…ç½®ç¯å¢ƒå˜é‡ï¼Œä½¿ç”¨kubectlå·¥å…·ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">$ kubectl get nodes</span><br><span class="line">$ kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure><p><strong>æŒ‰ç…§æç¤ºä¿å­˜ä»¥ä¸‹å†…å®¹ï¼Œä¸€ä¼šè¦ä½¿ç”¨ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join master.k8s.io:16443 --token jv5z7n.3y1zi95p952y9p65 \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:403bca185c2f3a4791685013499e7ce58f9848e2213e27194b75a2e3293d8812 \</span><br><span class="line">    --control-plane </span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cs</span><br><span class="line"></span><br><span class="line">kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure><h2 id="master2èŠ‚ç‚¹åŠ å…¥é›†ç¾¤"><a href="#master2èŠ‚ç‚¹åŠ å…¥é›†ç¾¤" class="headerlink" title="master2èŠ‚ç‚¹åŠ å…¥é›†ç¾¤"></a>master2èŠ‚ç‚¹åŠ å…¥é›†ç¾¤</h2><h3 id="å¤åˆ¶å¯†é’¥åŠç›¸å…³æ–‡ä»¶"><a href="#å¤åˆ¶å¯†é’¥åŠç›¸å…³æ–‡ä»¶" class="headerlink" title="å¤åˆ¶å¯†é’¥åŠç›¸å…³æ–‡ä»¶"></a>å¤åˆ¶å¯†é’¥åŠç›¸å…³æ–‡ä»¶</h3><p>ä»master1å¤åˆ¶å¯†é’¥åŠç›¸å…³æ–‡ä»¶åˆ°master2</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ssh root@192.168.44.156 mkdir -p /etc/kubernetes/pki/etcd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># scp /etc/kubernetes/admin.conf root@192.168.44.156:/etc/kubernetes</span></span><br><span class="line">   </span><br><span class="line"><span class="comment"># scp /etc/kubernetes/pki/&#123;ca.*,sa.*,front-proxy-ca.*&#125; root@192.168.44.156:/etc/kubernetes/pki</span></span><br><span class="line">   </span><br><span class="line"><span class="comment"># scp /etc/kubernetes/pki/etcd/ca.* root@192.168.44.156:/etc/kubernetes/pki/etcd</span></span><br></pre></td></tr></table></figure><h3 id="master2åŠ å…¥é›†ç¾¤"><a href="#master2åŠ å…¥é›†ç¾¤" class="headerlink" title="master2åŠ å…¥é›†ç¾¤"></a>master2åŠ å…¥é›†ç¾¤</h3><p>æ‰§è¡Œåœ¨master1ä¸Šinitåè¾“å‡ºçš„joinå‘½ä»¤,éœ€è¦å¸¦ä¸Šå‚æ•°<code>--control-plane</code>è¡¨ç¤ºæŠŠmasteræ§åˆ¶èŠ‚ç‚¹åŠ å…¥é›†ç¾¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join master.k8s.io:16443 --token ckf7bs.30576l0okocepg8b     --discovery-token-ca-cert-hash sha256:19afac8b11182f61073e254fb57b9f19ab4d798b70501036fc69ebef46094aba --control-plane</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line"></span><br><span class="line">kubectl get pods --all-namespaces</span><br></pre></td></tr></table></figure><p><strong>æŒ‰ç…§åç»­æç¤ºï¼Œæ‰§è¡Œç›¸å…³å†…å®¹</strong></p><h2 id="åŠ å…¥Kubernetes-Node"><a href="#åŠ å…¥Kubernetes-Node" class="headerlink" title="åŠ å…¥Kubernetes Node"></a>åŠ å…¥Kubernetes Node</h2><p>åœ¨node1ä¸Šæ‰§è¡Œ</p><p>å‘é›†ç¾¤æ·»åŠ æ–°èŠ‚ç‚¹ï¼Œæ‰§è¡Œåœ¨kubeadm initè¾“å‡ºçš„kubeadm joinå‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join master.k8s.io:16443 --token ckf7bs.30576l0okocepg8b     --discovery-token-ca-cert-hash sha256:19afac8b11182f61073e254fb57b9f19ab4d798b70501036fc69ebef46094aba</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line"></span><br><span class="line">kubectl get pods --all-namespaces</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…é›†ç¾¤ç½‘ç»œ"><a href="#å®‰è£…é›†ç¾¤ç½‘ç»œ" class="headerlink" title="å®‰è£…é›†ç¾¤ç½‘ç»œ"></a>å®‰è£…é›†ç¾¤ç½‘ç»œ</h2><p>ä»å®˜æ–¹åœ°å€è·å–åˆ°flannelçš„yamlï¼Œåœ¨master1ä¸Šæ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir flannel</span><br><span class="line"><span class="built_in">cd</span> flannel</span><br><span class="line">wget -c https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure><p>å®‰è£…flannelç½‘ç»œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kube-flannel.yml </span><br></pre></td></tr></table></figure><p>æ£€æŸ¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure><h2 id="æµ‹è¯•kubernetesé›†ç¾¤"><a href="#æµ‹è¯•kubernetesé›†ç¾¤" class="headerlink" title="æµ‹è¯•kubernetesé›†ç¾¤"></a>æµ‹è¯•kubernetesé›†ç¾¤</h2><p>åœ¨Kubernetesé›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ªpodï¼ŒéªŒè¯æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create deployment nginx --image=nginx</span><br><span class="line">$ kubectl expose deployment nginx --port=80 --<span class="built_in">type</span>=NodePort</span><br><span class="line">$ kubectl get pod,svc</span><br></pre></td></tr></table></figure><p>è®¿é—®åœ°å€ï¼š<a href="http://NodeIP:Port">http://NodeIP:Port</a>  </p><h1 id="k8sé›†ç¾¤éƒ¨ç½²Javaé¡¹ç›®"><a href="#k8sé›†ç¾¤éƒ¨ç½²Javaé¡¹ç›®" class="headerlink" title="k8sé›†ç¾¤éƒ¨ç½²Javaé¡¹ç›®"></a>k8sé›†ç¾¤éƒ¨ç½²Javaé¡¹ç›®</h1><p>æˆ‘ä»¬çŸ¥é“k8sé›†ç¾¤æ˜¯ä»¥Podä¸ºåŸºæœ¬å•ä½çš„ï¼Œè€ŒPodæ˜¯å¤šä¸ªå®¹å™¨çš„ç»„åˆã€‚æ‰€ä»¥å¦‚æœå‘éƒ¨ç½²é¡¹ç›®åˆ°k8sé›†ç¾¤éœ€è¦é¦–å…ˆå°±æ˜‚é¡¹ç›®æºä»£ç é›†æˆä¸ºå®¹å™¨é•œåƒã€‚ç„¶ååœ¨k8sä¸Šéƒ¨ç½²å®¹å™¨æœåŠ¡ã€‚</p><h2 id="å®¹å™¨äº¤ä»˜æµç¨‹"><a href="#å®¹å™¨äº¤ä»˜æµç¨‹" class="headerlink" title="å®¹å™¨äº¤ä»˜æµç¨‹"></a>å®¹å™¨äº¤ä»˜æµç¨‹</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201210111801547.png" alt="image-20201210111801547"></p><h2 id="k8séƒ¨ç½²é¡¹ç›®æµç¨‹"><a href="#k8séƒ¨ç½²é¡¹ç›®æµç¨‹" class="headerlink" title="k8séƒ¨ç½²é¡¹ç›®æµç¨‹"></a>k8séƒ¨ç½²é¡¹ç›®æµç¨‹</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201210111902550.png" alt="image-20201210111902550"></p><h3 id="ç¼–å†™é¡¹ç›®"><a href="#ç¼–å†™é¡¹ç›®" class="headerlink" title="ç¼–å†™é¡¹ç›®"></a>ç¼–å†™é¡¹ç›®</h3><p>åˆ›å»ºä¸€ä¸ªspringbooté¡¹ç›®</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-09_20-49-49.png" alt="Snipaste_2020-12-09_20-49-49"></p><p><strong>ç¼–å†™Dockerfile</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-09_20-55-52.png"></p><h3 id="åˆ›å»ºç¬¬ä¸‰æ–¹ä»“åº“"><a href="#åˆ›å»ºç¬¬ä¸‰æ–¹ä»“åº“" class="headerlink" title="åˆ›å»ºç¬¬ä¸‰æ–¹ä»“åº“"></a>åˆ›å»ºç¬¬ä¸‰æ–¹ä»“åº“</h3><p>æ¨é€æ•°æ®åˆ°ç¬¬ä¸‰æ–¹ä»“åº“ï¼Œè¿™é‡Œé€‰æ‹©é˜¿é‡Œäº‘ã€‚ä¹Ÿå¯ä»¥è‡ªå·±æ­å»ºdockerä»“åº“</p><p><a href="https://cn.aliyun.com/product/containerservice">https://cn.aliyun.com/product/containerservice</a></p><p><strong>1. åˆ›å»ºå‘½åç©ºé—´</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-09_20-59-46.png"></p><p><strong>2. åˆ›å»ºä»“åº“</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-09_21-01-01.png"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-09_21-01-09.png"></p><h3 id="æ¨é€é•œåƒ"><a href="#æ¨é€é•œåƒ" class="headerlink" title="æ¨é€é•œåƒ"></a><strong>æ¨é€é•œåƒ</strong></h3><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-09_21-01-50.png"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-09_21-12-11.png"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-09_21-12-27.png"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-09_21-18-17.png"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-09_21-19-00.png" alt="Snipaste_2020-12-09_21-19-00"></p><h3 id="é¡¹ç›®éƒ¨ç½²"><a href="#é¡¹ç›®éƒ¨ç½²" class="headerlink" title="é¡¹ç›®éƒ¨ç½²"></a>é¡¹ç›®éƒ¨ç½²</h3><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-10_22-10-42.png" alt="Snipaste_2020-12-10_22-10-42"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-10_22-08-07.png" alt="Snipaste_2020-12-10_22-08-07"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;k8sé›†ç¾¤ç›‘æ§&quot;&gt;&lt;a href=&quot;#k8sé›†ç¾¤ç›‘æ§&quot; class=&quot;headerlink&quot; title=&quot;k8sé›†ç¾¤ç›‘æ§&quot;&gt;&lt;/a&gt;k8sé›†ç¾¤ç›‘æ§&lt;/h1&gt;&lt;p&gt;æ—¢ç„¶æ˜¯ç›‘æ§k8sçš„é›†ç¾¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦å®æ—¶è·å–k8sé›†ç¾¤çš„å“ªäº›ä¿¡æ¯å‘¢ï¼Ÿå³æˆ‘ä»¬çš„ç›‘æ§æŒ‡æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ&lt;/p&gt;</summary>
      
    
    
    
    <category term="Kubernetes" scheme="https://awslzhang.top/categories/Kubernetes/"/>
    
    
    <category term="Docker" scheme="https://awslzhang.top/tags/Docker/"/>
    
    <category term="Kubernetes" scheme="https://awslzhang.top/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>æµ…è°ˆHttps</title>
    <link href="https://awslzhang.top/2020/11/21/%E6%B5%85%E8%B0%88Https/"/>
    <id>https://awslzhang.top/2020/11/21/%E6%B5%85%E8%B0%88Https/</id>
    <published>2020-11-21T01:10:13.000Z</published>
    <updated>2021-01-01T05:50:00.099Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><h2 id="Http"><a href="#Http" class="headerlink" title="Http"></a>Http</h2><p>HyperText Transfer Protocolï¼Œè¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼Œæ˜¯äº’è”ç½‘ä¸Šä½¿ç”¨æœ€å¹¿æ³›çš„ä¸€ç§åè®®ï¼Œæ‰€æœ‰WWWæ–‡ä»¶å¿…é¡»éµå¾ªçš„æ ‡å‡†ã€‚HTTPåè®®ä¼ è¾“çš„æ•°æ®éƒ½æ˜¯æœªåŠ å¯†çš„ï¼Œä¹Ÿå°±æ˜¯æ˜æ–‡çš„ï¼Œå› æ­¤ä½¿ç”¨HTTPåè®®ä¼ è¾“éšç§ä¿¡æ¯éå¸¸ä¸å®‰å…¨ã€‚</p><p>ä½¿ç”¨TCPç«¯å£ä¸ºï¼š80</p><h2 id="Https"><a href="#Https" class="headerlink" title="Https"></a>Https</h2><p>Hyper Text Transfer Protocol over Secure Socket Layerï¼Œå®‰å…¨çš„è¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼Œç½‘æ™¯å…¬å¼è®¾è®¡äº†SSL(Secure Sockets Layer)åè®®ç”¨äºå¯¹Httpåè®®ä¼ è¾“çš„æ•°æ®è¿›è¡ŒåŠ å¯†ï¼Œä¿è¯ä¼šè¯è¿‡ç¨‹ä¸­çš„å®‰å…¨æ€§ã€‚</p><p>ä½¿ç”¨TCPç«¯å£é»˜è®¤ä¸º443</p><hr><p>HTTPS åè®®æ ˆä¸ HTTP çš„å”¯ä¸€åŒºåˆ«åœ¨äºå¤šäº†ä¸€ä¸ªå®‰å…¨å±‚ï¼ˆSecurity Layerï¼‰â€”â€” TLS/SSLï¼ŒSSL æ˜¯æœ€æ—©çš„å®‰å…¨å±‚åè®®ï¼ŒTLS ç”± SSL å‘å±•è€Œæ¥ï¼Œæ‰€ä»¥ä¸‹é¢æˆ‘ä»¬ç»Ÿç§° TLSã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/v2-29fee3e54e584905453e69c3df133e05_720w.jpg" alt="img"></p><p>åŸæ¥HTTPSå°±æ˜¯åœ¨HTTPåè®®çš„åŸºç¡€ä¸ŠåŠ å…¥äº†TLSåè®®ã€‚ç›®çš„æ˜¯ä¿è¯æˆ‘ä»¬çš„æ•°æ®åœ¨ç½‘ç»œä¸Šä¼ è¾“çš„å®‰å…¨æ€§ã€‚</p><p><strong>ä»€ä¹ˆæ˜¯TLSï¼Ÿ</strong></p><blockquote><p>TLSæ˜¯ä¼ è¾“å±‚åŠ å¯†åè®®ï¼Œå‰èº«æ˜¯SSLåè®®ã€‚ç”±ç½‘æ™¯å…¬å¸äº1995å¹´å‘å¸ƒã€‚åæ”¹åä¸ºTLSã€‚å¸¸ç”¨çš„ TLS åè®®ç‰ˆæœ¬æœ‰ï¼šTLS1.2, TLS1.1, TLS1.0 å’Œ SSL3.0ã€‚å…¶ä¸­ SSL3.0 ç”±äº POODLE æ”»å‡»å·²ç»è¢«è¯æ˜ä¸å®‰å…¨ã€‚TLS1.0 ä¹Ÿå­˜åœ¨éƒ¨åˆ†å®‰å…¨æ¼æ´ï¼Œæ¯”å¦‚ RC4 å’Œ BEAST æ”»å‡»ã€‚</p></blockquote><h1 id="æ•°å­—è¯ä¹¦"><a href="#æ•°å­—è¯ä¹¦" class="headerlink" title="æ•°å­—è¯ä¹¦"></a>æ•°å­—è¯ä¹¦</h1><p>TLS æ¡æ‰‹çš„ä½œç”¨ä¹‹ä¸€æ˜¯èº«ä»½è®¤è¯ï¼ˆauthenticationï¼‰ï¼Œè¢«éªŒè¯çš„ä¸€æ–¹éœ€è¦æä¾›ä¸€ä¸ªèº«ä»½è¯æ˜ï¼Œåœ¨ HTTPS çš„ä¸–ç•Œé‡Œï¼Œè¿™ä¸ªèº«ä»½è¯æ˜å°±æ˜¯ ã€ŒTLS è¯ä¹¦ã€ï¼Œæˆ–è€…ç§°ä¸º ã€ŒHTTPS è¯ä¹¦ã€ã€‚</p><p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨è®¿é—®xxxxæ—¶ï¼Œæµè§ˆå™¨ä¼šå¾—åˆ°ä¸€ä¸ª TLS è¯ä¹¦ï¼Œè¿™ä¸ªæ•°å­—è¯ä¹¦ç”¨äºè¯æ˜æˆ‘ä»¬æ­£åœ¨è®¿é—®çš„ç½‘ç«™å’Œè¯ä¹¦çš„æŒæœ‰è€…æ˜¯åŒ¹é…çš„ï¼Œå¦åˆ™å› ä¸ºèº«ä»½è®¤è¯æ— æ³•é€šè¿‡ï¼Œè¿æ¥ä¹Ÿå°±æ— æ³•å»ºç«‹ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201121091912788.png" alt="image-20201121091912788"></p><p>ä¸Šä¾‹å¯ä»¥çœ‹å‡ºï¼Œæµè§ˆå™¨å¾—åˆ°çš„æ˜¯ä¸€ä¸ªè¯ä¹¦çš„é“¾è¡¨ï¼Œè¿™ä¸ªé“¾è¡¨å«è¯ä¹¦é“¾ï¼ˆCertificate Chainï¼‰ï¼Œæˆ‘ä»¬åé¢ä¼šåˆ†æå®ƒçš„ä½œç”¨ã€‚</p><h2 id="è¯ä¹¦é“¾"><a href="#è¯ä¹¦é“¾" class="headerlink" title="è¯ä¹¦é“¾"></a>è¯ä¹¦é“¾</h2><p>ä¸Šå›¾çš„å±‚çº§ç»“æ„å°±æ˜¯è¯ä¹¦é“¾ã€‚</p><p>å½“è·å¾—è¯ä¹¦é“¾ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾ˆè½»æ¾çš„å¾€ä¸Šå›æº¯åˆ°è¢« UA ä¿¡ä»»çš„è¯ä¹¦ï¼Œè™½ç„¶ UA å†…ç½®çš„å¯èƒ½æ˜¯ä¸­é—´è¯ä¹¦ï¼ˆIntermediate Certificateï¼‰ï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ª End-Entity è¯ä¹¦å³ä½¿å›æº¯åˆ°è·Ÿè¯ä¹¦ï¼ˆRoot Certificateï¼‰ä¹Ÿæ²¡æœ‰åœ¨ UA çš„å—ä¿¡åˆ—è¡¨ä¸­æ‰¾åˆ°ï¼Œé‚£ä¹ˆè¿™ä¸ªç«™ç‚¹å°±ä¼šè¢«æ ‡è®°ä¸ºä¸å®‰å…¨ã€‚</p><p>æœ€ä¸Šå±‚çš„éƒ½æ˜¯è·Ÿè¯ä¹¦ï¼Œè¿™äº›è¯ä¹¦éœ€è¦å­˜åœ¨äºæµè§ˆå™¨çš„å—ä¿¡åˆ—è¡¨ä¸­ï¼Œå¦åˆ™é“¾æ¥ä¸å®‰å…¨ã€‚</p><h2 id="HTTPSè¯·æ±‚è¿‡ç¨‹"><a href="#HTTPSè¯·æ±‚è¿‡ç¨‹" class="headerlink" title="HTTPSè¯·æ±‚è¿‡ç¨‹"></a>HTTPSè¯·æ±‚è¿‡ç¨‹</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1704743ced98df13"></p><h2 id="ä¸­é—´äººæ”»å‡»"><a href="#ä¸­é—´äººæ”»å‡»" class="headerlink" title="ä¸­é—´äººæ”»å‡»"></a>ä¸­é—´äººæ”»å‡»</h2><p>è¯·æŸ¥çœ‹ä¸­é—´äººæ”»å‡»åŸç†ï¼š<a href="https://juejin.cn/post/6844904065227292685#heading-11">https://juejin.cn/post/6844904065227292685#heading-11</a></p><blockquote><p>ä»¥ä¸Šæ€»ç»“æ”»å‡»çš„æ¡ä»¶ï¼š</p><ol><li>é¦–å…ˆæ”»å‡»è€…éœ€è¦æˆªå–åˆ°ä½ çš„è¯·æ±‚ï¼Œç°åœ¨é™¤äº†åœ¨æœ¬æœºä½¿ç”¨fiddler/wiresharkï¼Œæˆ‘æƒ³ä¸åˆ°å…¶ä»–çš„æ–¹å¼</li><li>å¦‚æœé‡‡ç”¨fiddler/wiresharkéœ€è¦æ‰‹åŠ¨ä¿¡ä»»ä»–ä»¬çš„è¯ä¹¦</li><li>å¦‚æœç¬¬ä¸‰æ–¹èƒ½åœ¨ç½‘ç»œä¸­æˆªå–ä½ çš„è¯·æ±‚ï¼Œæˆ‘æƒ³ä¸åˆ°æ–¹æ³•ï¼Œå¯èƒ½ä¹Ÿæœ‰</li></ol></blockquote><h2 id="é˜²èŒƒä¸­é—´äººæ”»å‡»"><a href="#é˜²èŒƒä¸­é—´äººæ”»å‡»" class="headerlink" title="é˜²èŒƒä¸­é—´äººæ”»å‡»"></a>é˜²èŒƒä¸­é—´äººæ”»å‡»</h2><p>å¯æŸ¥çœ‹ï¼š<a href="https://www.zhihu.com/question/65464646">https://www.zhihu.com/question/65464646</a></p><p>HTTPSæ˜¯ä¿æŠ¤ç”¨æˆ·å’ŒæœåŠ¡å™¨ä¹‹é—´çš„é€šè®¯ä¸è¢«ç¬¬ä¸‰æ–¹çªƒå–æˆ–è€…ç¯¡æ”¹ã€‚è¿™ä¸ªç¬¬ä¸‰æ–¹æ”»å‡»è€…æ‰æ˜¯ä¸­é—´äººã€‚å¯¹äºç”¨æˆ·å¯¹å®¢æˆ·ç«¯é€»è¾‘çš„é€†å‘å’Œç¯¡æ”¹ï¼ŒHTTPSæ˜¯ä¸èƒ½èµ·åˆ°é˜²æŠ¤ä½œç”¨çš„ã€‚<strong>æ‰€ä»¥ç”¨æˆ·é€šè¿‡æŠ“å–è¯·æ±‚çš„è½¯ä»¶é€šè¿‡ä½¿è‡ªå·±ç”µè„‘ä¿¡ä»»(æ‰‹åŠ¨å¯¼å…¥DHçš„å‚æ•°)æŠ“å–è¯·æ±‚è½¯ä»¶çš„è¯ä¹¦è¿˜æ˜¯å¯ä»¥è§£å¯†httpsçš„</strong></p><blockquote><p>HTTPSä¼šè¢«æŠ“åŒ…ï¼ŒHTTPS åªé˜²æ­¢ç”¨æˆ·åœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹é€šä¿¡è¢«ç›‘å¬ï¼Œå¦‚æœç”¨æˆ·ä¸»åŠ¨æˆä¿¡ï¼Œæ˜¯å¯ä»¥æ„å»ºâ€œä¸­é—´äººâ€ç½‘ç»œï¼Œä»£ç†è½¯ä»¶å¯ä»¥å¯¹ä¼ è¾“å†…å®¹è¿›è¡Œè§£å¯†ã€‚</p></blockquote><h1 id="ä½¿ç”¨Httpsè®¿é—®é¡¹ç›®"><a href="#ä½¿ç”¨Httpsè®¿é—®é¡¹ç›®" class="headerlink" title="ä½¿ç”¨Httpsè®¿é—®é¡¹ç›®"></a>ä½¿ç”¨Httpsè®¿é—®é¡¹ç›®</h1><h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><p>é¡¹ç›®é‡‡ç”¨spring boot</p><ul><li>Java</li><li>maven</li><li>éƒ¨ç½²æœåŠ¡çš„vpsä¸€å°ï¼Œä¸ºäº†æ¨¡æ‹ŸçœŸå®ï¼Œé‡‡ç”¨çš„å…¬ç½‘IPï¼Œå¹¶å°†åŸŸåæ·»åŠ å®ƒçš„Aè®°å½•ã€‚</li><li>è¯ä¹¦ï¼Œé¢å‘ç»™åŸŸåã€‚</li></ul><p>è¯ä¹¦ç”³è¯·ï¼š<a href="https://blog.walterlv.com/post/apply-for-free-ssl-certificates-using-freessl.html">https://blog.walterlv.com/post/apply-for-free-ssl-certificates-using-freessl.html</a></p><p>åœ¨åˆ›å»ºå¥½è¯ä¹¦ä¹‹åå¯¼å‡ºè¯ä¹¦ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201121122116308.png" alt="image-20201121122116308"></p><h2 id="é¡¹ç›®é…ç½®"><a href="#é¡¹ç›®é…ç½®" class="headerlink" title="é¡¹ç›®é…ç½®"></a>é¡¹ç›®é…ç½®</h2><p><strong>1.åˆå§‹åŒ–springbooté¡¹ç›®</strong></p><p>ç•¥</p><p><strong>2.é…ç½®æ–‡ä»¶</strong></p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¿é—®åœ°å€ é‡è¦ ä¸åŠ çš„è¯ä¸èƒ½è¿œç¨‹è®¿é—®</span></span><br><span class="line"><span class="meta">server.address</span>=<span class="string">0.0.0.0</span></span><br><span class="line"><span class="comment">#httpsåŠ å¯†ç«¯å£å· 443</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">443</span></span><br><span class="line"><span class="comment">#SSLè¯ä¹¦è·¯å¾„ ä¸€å®šè¦åŠ ä¸Šclasspath:</span></span><br><span class="line"><span class="meta">server.ssl.key-store</span>=<span class="string">classpath:t-av2ray-top-tomcat-1121122148.jks</span></span><br><span class="line"><span class="comment">#SSLè¯ä¹¦å¯†ç </span></span><br><span class="line"><span class="meta">server.ssl.key-store-password</span>=<span class="string">1214</span></span><br><span class="line"><span class="comment">#è¯ä¹¦ç±»å‹</span></span><br><span class="line"><span class="meta">server.ssl.key-store-type</span>=<span class="string">JKS</span></span><br><span class="line"><span class="comment">#è¯ä¹¦åˆ«å</span></span><br><span class="line"><span class="comment">#server.ssl.key-alias=alias</span></span><br></pre></td></tr></table></figure><p>é¡¹ç›®å¯åŠ¨ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(DemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * httpé‡å®šå‘åˆ°https</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TomcatServletWebServerFactory <span class="title">servletContainer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        TomcatServletWebServerFactory tomcat = <span class="keyword">new</span> TomcatServletWebServerFactory() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postProcessContext</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">                SecurityConstraint constraint = <span class="keyword">new</span> SecurityConstraint();</span><br><span class="line">                constraint.setUserConstraint(<span class="string">&quot;CONFIDENTIAL&quot;</span>);</span><br><span class="line">                SecurityCollection collection = <span class="keyword">new</span> SecurityCollection();</span><br><span class="line">                collection.addPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">                constraint.addCollection(collection);</span><br><span class="line">                context.addConstraint(constraint);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        tomcat.addAdditionalTomcatConnectors(httpConnector());</span><br><span class="line">        <span class="keyword">return</span> tomcat;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connector <span class="title">httpConnector</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connector connector = <span class="keyword">new</span> Connector(<span class="string">&quot;org.apache.coyote.http11.Http11NioProtocol&quot;</span>);</span><br><span class="line">        connector.setScheme(<span class="string">&quot;http&quot;</span>);</span><br><span class="line">        <span class="comment">//Connectorç›‘å¬çš„httpçš„ç«¯å£å·</span></span><br><span class="line">        connector.setPort(<span class="number">8080</span>);</span><br><span class="line">        connector.setSecure(<span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">//ç›‘å¬åˆ°httpçš„ç«¯å£å·åè½¬å‘åˆ°çš„httpsçš„ç«¯å£å·</span></span><br><span class="line">        connector.setRedirectPort(<span class="number">443</span>);</span><br><span class="line">        <span class="keyword">return</span> connector;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¾ç½®80ç«¯å£è·³è½¬è‡³443ç«¯å£ï¼Œå¼ºåˆ¶ä½¿ç”¨httpsã€‚</p><p><strong>3.æ‰“åŒ…</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn package -DskipTests</span><br></pre></td></tr></table></figure><p><strong>4. ä¸Šä¼ è‡³æœåŠ¡å™¨</strong></p><p><strong>4.1 æœåŠ¡å™¨å®‰è£…Java</strong></p><p>ç•¥</p><p><strong>4.2é¡¹ç›®è¿è¡Œ</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar xxx</span><br></pre></td></tr></table></figure><p><a href="https://t.av2ray.top/hello%EF%BC%8C%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE">https://t.av2ray.top/helloï¼Œå¯ä»¥è®¿é—®</a></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201121162646185.png" alt="image-20201121162646185"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201121162701151.png" alt="image-20201121162701151"></p><hr><p>å½“æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ipè®¿é—®æ—¶ï¼š</p><p><strong><a href="http://ip:443/hello">http://ip:443/hello</a></strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Bad Request</span><br><span class="line">This combination of host and port requires TLS.</span><br></pre></td></tr></table></figure><blockquote><p>è¿™æ˜¯å› ä¸ºé¡¹ç›®é…ç½®äº†TLSè®¿é—®ï¼Œæ‰€ä»¥è¿™æ—¶ä¸èƒ½ä½¿ç”¨http</p></blockquote><p><strong><a href="https://ip/hello">https://ip:443/hello</a></strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201121162909986.png" alt="image-20201121162909986"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201121162925128.png" alt="image-20201121162925128"></p><blockquote><p>è¿™æ—¶å› ä¸ºæˆ‘ä»¬é€šè¿‡ipè®¿é—®é¡¹ç›®æ—¶ï¼Œè¯ä¹¦ä¸å¯¹ã€‚æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯é¢å‘ç»™åŸŸåxxxçš„è¯ä¹¦ï¼Œæ‰€ä»¥åªèƒ½ä½¿ç”¨æ­¤åŸŸåè®¿é—®æ—¶æ‰æ˜¯å®‰å…¨çš„ã€‚</p><p>ä¸å®‰å…¨æ—¶æµè§ˆå™¨ä¼šæç¤ºï¼Œä»å¯ä»¥è®¿é—®ï¼Œä½†æ˜¯æ˜¾ç¤ºä¸å®‰å…¨ã€‚</p></blockquote><blockquote><p>httpsé¡¹ç›®æ€»ç»“</p><p>å› ä¸ºé¡¹ç›®ä¸­é…ç½®äº†TSLï¼Œæ‰€ä»¥åªæœ‰ä½ è®¿é—®æ—¶æºå¸¦äº†è¯ä¹¦ï¼Œä¸”æºå¸¦çš„è¯ä¹¦æ­£å¥½å’Œé¡¹ç›®ä¸­é…ç½®çš„è¯ä¹¦åŒ¹é…è®¿é—®æ‰æ˜¯å®‰å…¨çš„ï¼Œå¦åˆ™è®¿é—®éƒ½ä¸å®‰å…¨ã€‚ </p><p>é‚£å¦‚ä½•æ‰èƒ½æºå¸¦è¯ä¹¦è®¿é—®å‘¢ï¼Œçœ‹ä½ é¡¹ç›®ä¸­çš„è¯ä¹¦æ˜¯æ€ä¹ˆç”Ÿæˆé¢ï¼Œä¾‹å¦‚ä¸Šè¿°é¡¹ç›®ä¸­çš„è¯ä¹¦æ˜¯ç”±åŸŸåt.av2ray.topç”Ÿæˆçš„ï¼Œæ‰€ä»¥åªæœ‰å½“ä½¿ç”¨æ­¤åŸŸåè®¿é—®æœåŠ¡æ—¶æ‰ä¼šæºå¸¦æ­£ç¡®çš„è¯ä¹¦ï¼Œå¦‚æœç›´æ¥ä½¿ç”¨IPåœ°å€è®¿é—®ä¹Ÿä¸æ˜¯å®‰å…¨çš„ã€‚å› ä¸ºè¯ä¹¦æ˜¯é¢å‘ç»™t.av2ray.topçš„ã€‚</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;h2 id=&quot;Http&quot;&gt;&lt;a href=&quot;#Http&quot; class=&quot;headerlink&quot; title=&quot;Http&quot;&gt;&lt;/a&gt;Http&lt;/h</summary>
      
    
    
    
    <category term="åè®®" scheme="https://awslzhang.top/categories/%E5%8D%8F%E8%AE%AE/"/>
    
    
    <category term="Https" scheme="https://awslzhang.top/tags/Https/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetesæ ¸å¿ƒæŠ€æœ¯</title>
    <link href="https://awslzhang.top/2020/11/17/Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/"/>
    <id>https://awslzhang.top/2020/11/17/Kubernetes%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/</id>
    <published>2020-11-17T13:31:09.000Z</published>
    <updated>2021-01-01T05:49:59.958Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ ¸å¿ƒæŠ€æœ¯Pod"><a href="#æ ¸å¿ƒæŠ€æœ¯Pod" class="headerlink" title="æ ¸å¿ƒæŠ€æœ¯Pod"></a>æ ¸å¿ƒæŠ€æœ¯Pod</h1><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><blockquote><p>Pod æ˜¯ k8s ç³»ç»Ÿä¸­å¯ä»¥åˆ›å»ºå’Œç®¡ç†çš„æœ€å°å•å…ƒï¼Œæ˜¯èµ„æºå¯¹è±¡æ¨¡å‹ä¸­ç”±ç”¨æˆ·åˆ›å»ºæˆ–éƒ¨ç½²çš„æœ€å°èµ„æºå¯¹è±¡æ¨¡å‹ï¼Œä¹Ÿæ˜¯åœ¨ k8s ä¸Šè¿è¡Œå®¹å™¨åŒ–åº”ç”¨çš„èµ„æºå¯¹è±¡ï¼Œå…¶ä»–çš„èµ„æºå¯¹è±¡éƒ½æ˜¯ç”¨æ¥æ”¯ æ’‘æˆ–è€…æ‰©å±• Pod å¯¹è±¡åŠŸèƒ½çš„ï¼Œæ¯”å¦‚æ§åˆ¶å™¨å¯¹è±¡æ˜¯ç”¨æ¥ç®¡æ§ Pod å¯¹è±¡çš„ï¼ŒService æˆ–è€… Ingress èµ„æºå¯¹è±¡æ˜¯ç”¨æ¥æš´éœ² Pod å¼•ç”¨å¯¹è±¡çš„ï¼ŒPersistentVolume èµ„æºå¯¹è±¡æ˜¯ç”¨æ¥ä¸º Pod æä¾›å­˜å‚¨ç­‰ç­‰ï¼Œ<font color="red">k8s ä¸ä¼šç›´æ¥å¤„ç†å®¹å™¨ï¼Œè€Œæ˜¯ Podï¼ŒPod æ˜¯ç”±ä¸€ä¸ªæˆ–å¤šä¸ª container ç»„æˆ</font>ï¼ŒPod æ˜¯ Kubernetes çš„æœ€é‡è¦æ¦‚å¿µï¼Œ<font color="red">æ¯ä¸€ä¸ª Pod éƒ½æœ‰ä¸€ä¸ªç‰¹æ®Šçš„è¢«ç§°ä¸ºâ€æ ¹å®¹å™¨â€œçš„ Pauseå®¹å™¨ã€‚</font>Pause å®¹å™¨å¯¹åº”çš„é•œ åƒå±äº Kubernetes å¹³å°çš„ä¸€éƒ¨åˆ†ï¼Œé™¤äº† Pause å®¹å™¨ï¼Œæ¯ä¸ª Pod è¿˜åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªç´§å¯†ç›¸å…³çš„ç”¨æˆ·ä¸šåŠ¡å®¹å™¨ã€‚</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201119143357674.png" alt="image-20201119143357674"></p><p><strong>ä¸ºä»€ä¹ˆPodæ˜¯æœ€å°èµ„æºè€Œä¸æ˜¯å®¹å™¨ï¼Ÿ</strong></p><p><code>docker run</code>äº§ç”Ÿä¸€ä¸ªå®¹å™¨(è¿›ç¨‹)ï¼Œä¸€èˆ¬å®¹å™¨ä¸­åªèƒ½ç”±ä¸€ä¸ªåº”ç”¨ï¼Œå¦‚æœåº”ç”¨è¿‡å¤šï¼Œæ— æ³•é€šè¿‡å®¹å™¨æ¥ç®¡ç†åº”ç”¨ã€‚å½“æˆ‘ä»¬Podé‡Œé¢è¦è¿è¡Œå¤šä¸ªåº”ç”¨æ—¶æ˜¯é€šè¿‡å®¹å™¨å’Œåº”ç”¨ä¸€å¯¹ä¸€çš„è¿è¡Œåº”ç”¨çš„ï¼Œæ‰€ä»¥Podä¸­èƒ½è¿è¡Œå¤šä¸ªåº”ç”¨å³Podä¸­èƒ½è¿è¡Œå¤šä¸ªå®¹å™¨ã€‚</p><blockquote><p>ä¸€ä¸ª Pod å¯ä»¥æœ‰å¤šä¸ªå®¹å™¨ï¼Œå½¼æ­¤é—´å…±äº«ç½‘ç»œå’Œå­˜å‚¨èµ„æºï¼Œæ¯ä¸ª Pod ä¸­æœ‰ä¸€ä¸ª Pause å®¹å™¨ä¿å­˜æ‰€æœ‰çš„å®¹å™¨çŠ¶æ€ï¼Œ é€šè¿‡ç®¡ç† pause å®¹å™¨ï¼Œè¾¾åˆ°ç®¡ç† pod ä¸­æ‰€æœ‰å®¹å™¨çš„æ•ˆæœã€‚</p></blockquote><h2 id="Podç‰¹æ€§"><a href="#Podç‰¹æ€§" class="headerlink" title="Podç‰¹æ€§"></a>Podç‰¹æ€§</h2><ul><li>å…±äº«ç½‘ç»œ</li><li>å…±äº«å­˜å‚¨</li><li>ç”Ÿå‘½å‘¨æœŸçŸ­æš‚</li><li>å¹³å¦çš„ç½‘ç»œ</li></ul><h3 id="å…±äº«ç½‘ç»œ"><a href="#å…±äº«ç½‘ç»œ" class="headerlink" title="å…±äº«ç½‘ç»œ"></a>å…±äº«ç½‘ç»œ</h3><p>æˆ‘ä»¬çŸ¥é“Dockerå®¹å™¨ä¹‹é—´æ˜¯äº’ç›¸éš”ç¦»çš„(ç½‘ç»œã€æ–‡ä»¶ç³»ç»Ÿâ€¦)ï¼Œå®ƒæ˜¯ç”±Dockerä½¿ç”¨äº†Linux Namespace(ä¸­çš„cgroup)æ¥å®ç°çš„ã€‚è€ŒK8sä¸­çš„Podä½¿å®ƒå†…éƒ¨åŒ…å«çš„æ‰€æœ‰å®¹å™¨å…±äº«ç½‘ç»œï¼Œæ˜¯å› ä¸ºå®ƒä½¿é‡Œé¢çš„æ‰€æœ‰å®¹å™¨éƒ½å¤„äºäº†ä¸€ä¸ªNamespaceä¸­çš„ã€‚</p><blockquote><p> <strong>Podçš„å…±äº«ç½‘ç»œåŒ…å«ä»€ä¹ˆï¼Ÿ/å•¥æ„æ€ï¼Ÿ</strong></p><ul><li>åœ¨ä¸€ä¸ª Pod é‡Œçš„å¤šä¸ªå®¹å™¨å…±äº« Pod çš„ IPï¼šå¤šä¸ªå®¹å™¨çš„Ipç›¸åŒ</li><li>ä»¥ä¸€ä¸ª Pod å†…çš„å¤šä¸ªå®¹å™¨ä¹‹é—´å¯ä»¥é€šè¿‡ localhost æ¥è¿›è¡Œé€šä¿¡ï¼šä¸åŒçš„å®¹å™¨å¯é€šè¿‡localhostäº¤æµ</li><li>ä¸åŒå®¹å™¨è¦æ³¨æ„ä¸è¦æœ‰ç«¯å£å†²çªå³å¯ï¼šå†…æ‰€æœ‰å®¹å™¨ç«¯å£å…¬ç”¨ï¼Œä¸å¯å†²çª</li><li>ä¸åŒçš„ Pod æœ‰ä¸åŒçš„ IP,ä¸åŒ Pod é€šä¿¡è¦åŸºäºPod Ipï¼›ä¸å¯é€šè¿‡IPCé€šä¿¡</li></ul></blockquote><p><strong>Dockerå®¹å™¨çš„éš”ç¦»</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/20191121111452351.png"></p><p><strong>Podæ€ä¹ˆå®ç°ç½‘ç»œå…±äº«çš„</strong></p><p>é€šè¿‡<code>Pause</code>å®¹å™¨ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201119151230610.png" alt="image-20201119151230610"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/20191121111837155.png"></p><p>åªæœ‰ä¸€ä¸ªeth0ç½‘å¡åªå‡ºç°åœ¨äº†â€pauseå®¹å™¨â€é‡Œé¢ï¼Œnginxå’Œphp-fpmå¤ç”¨äº†â€pauseå®¹å™¨â€çš„network namespaceï¼Œç®€å•ç†è§£å°±æ˜¯ä½¿ç”¨äº†â€pauseå®¹å™¨â€çš„eth0ç½‘å¡ä¸å¤–éƒ¨è¿›è¡Œé€šä¿¡ã€‚</p><h3 id="å…±äº«å­˜å‚¨"><a href="#å…±äº«å­˜å‚¨" class="headerlink" title="å…±äº«å­˜å‚¨"></a>å…±äº«å­˜å‚¨</h3><p>ä¸€ä¸ª Pod é‡Œçš„å¤šä¸ªå®¹å™¨å¯ä»¥å…±äº«å­˜å‚¨å·ï¼Œè¿™ä¸ªå­˜å‚¨å·ä¼šè¢«å®šä¹‰ä¸º Pod çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ä¸”å¯ä»¥æŒ‚è½½åˆ°è¯¥ Pod é‡Œçš„æ‰€æœ‰å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿä¸Šã€‚</p><h4 id="å­˜å‚¨å·å®ç°å…±äº«å­˜å‚¨"><a href="#å­˜å‚¨å·å®ç°å…±äº«å­˜å‚¨" class="headerlink" title="å­˜å‚¨å·å®ç°å…±äº«å­˜å‚¨"></a>å­˜å‚¨å·å®ç°å…±äº«å­˜å‚¨</h4><p>å¤§å¤šæ•°å’Œæ•°æ®å­˜å‚¨ç›¸å…³çš„åº”ç”¨å’Œæœ‰çŠ¶æ€åº”ç”¨éƒ½æ˜¯éœ€è¦æŒä¹…å­˜å‚¨æ•°æ®çš„ã€‚å®¹å™¨æœ¬èº«æœ‰ç”Ÿå‘½å‘¨æœŸï¼Œ<font color="red">ä¸ºäº†ä½¿å¾—å®¹å™¨å°†æ¥ç»ˆç»“åæˆ‘ä»¬å¯ä»¥æŠŠå®ƒåˆ é™¤ï¼Œç”šè‡³æ˜¯ç¼–æ’åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œæ„å‘³ç€æ•°æ®ä¸èƒ½æ”¾åœ¨å®¹å™¨è‡ªå·±çš„åç§°ç©ºé—´ä¸­ã€‚</font></p><blockquote><p>åœ¨k8sä¸­ï¼Œ<font color="red">Podæ˜¯è¿è¡Œåœ¨æŸä¸ªèŠ‚ç‚¹ä¸Šçš„</font>ï¼Œåªè¦ä¸å‡ºæ•…éšœï¼Œå°±ä¸€ç›´ä¼šè¿è¡Œåœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šï¼Œ<strong>èŠ‚ç‚¹æ•…éšœäº†æ‰ä¼šè°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œåªè¦èŠ‚ç‚¹ä¸æ•…éšœï¼Œæ˜¯ä¸ä¼šèµ°çš„ï¼Œæ— éå°±æ˜¯é‡å¯é‡å¯è€Œå·²ã€‚</strong></p><p>è¿™é‡Œå°±æœ‰ä¸¤ä¸ªé—®é¢˜äº†ï¼Œä¸€æ—¦è¿™ä¸ªPodæ•…éšœäº†è¢«åˆ é™¤ï¼Œæˆ–è€…èŠ‚ç‚¹æ•…éšœäº†ï¼Œæ­¤æ—¶æœ‰å¯èƒ½ç¼–æ’åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šäº†ï¼Œ<strong>ä¸ºäº†çªç ´Podç”Ÿå‘½å‘¨æœŸå—é™è¿™ç§ç°çŠ¶ï¼Œæˆ‘ä»¬éœ€è¦æŠŠæ•°æ®æ”¾åœ¨Podè‡ªæœ‰æ–‡ä»¶ç³»ç»Ÿä¹‹å¤–çš„åœ°æ–¹ã€‚</strong></p></blockquote><p>æˆ‘ä»¬æ­¤å‰åœ¨å•ç‹¬ä½¿ç”¨dockeræ—¶ï¼Œä½¿ç”¨å­˜å‚¨å·ï¼Œç›¸å½“äº<font color="red">æŠŠå®¹å™¨ä¸­çš„æŸä¸€ç›®å½•ä¸å®¿ä¸»æœºä¸ŠæŸä¸€ç›®å½•å…³è”èµ·æ¥</font>ï¼Œéšåå®¹å™¨å†…è¯¥ç›®å½•å­˜å‚¨çš„æ•°æ®éƒ½å­˜åˆ°äº†å®¿ä¸»æœºä¸Šäº†ã€‚å½“æˆ‘ä»¬åˆ äº†å®¹å™¨ï¼Œåœ¨é‡å»ºå®¹å™¨ï¼Œåªè¦è¿™ä¸ªå­˜å‚¨å·ä¸å—å½±å“ï¼Œé‚£ä¹ˆæ•°æ®æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šæ‹¥æœ‰äº†æŒä¹…åŠŸèƒ½ã€‚</p><p>ä½†æ˜¯è¿™ä¸ªé—®é¢˜åœ¨k8sä¸Šä¸èƒ½è¿™ä¹ˆæ¥æ“ä½œï¼Œ<strong>k8sæ˜¯ä¸€ä¸ªé›†ç¾¤</strong>ï¼Œç”±è°ƒåº¦å™¨è´Ÿè´£è°ƒåº¦ï¼Œ<font color="red">Podè¢«åˆ æ‰äº†å¯èƒ½ä¼šè¢«è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹</font>ï¼Œæ‰€ä»¥è¿™ç§åœ¨èŠ‚ç‚¹çº§å¸®å¿™æä¾›å­˜å‚¨å·çš„æ–¹å¼æ¥æŒä¹…å­˜å‚¨æ•°æ®çš„é€»è¾‘åœ¨k8sä¸Šï¼Œåªèƒ½è¯´åªæœ‰ä¸€å®šç¨‹åº¦ä¸Šçš„æŒä¹…æ€§ï¼Œä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„æŒä¹…æ€§ã€‚<font color="red"><strong>åº”è¯¥ä½¿ç”¨è„±ç¦»èŠ‚ç‚¹è€Œå­˜åœ¨çš„å­˜å‚¨è®¾å¤‡ã€‚</strong></font></p><p>ä¸ºæ­¤ï¼Œk8sæä¾›äº†èƒ½åº”ä»˜å„ç§ä¸åŒç±»å‹çš„å­˜å‚¨å·è®©æˆ‘ä»¬æ¥ä½¿ç”¨ï¼Œæ²¡æœ‰æŒä¹…ã€åŠæŒä¹…ã€æˆ–çœŸæ­£æ„ä¹‰ä¸Šçš„æŒä¹…åŠŸèƒ½ã€‚å¯¹äºPodæ¥è¯´ï¼ŒPodå†…çš„å¤šä¸ªå®¹å™¨å¯å…±äº«è®¿é—®åŒä¸€ç»„å­˜å‚¨å·ï¼Œå› ä¸ºå¯¹k8sæ¥è®²ï¼Œå­˜å‚¨å·ä¸å±äºå®¹å™¨ï¼Œè€Œå±äºPodã€‚åœ¨å®¹å™¨ä¸­æŒ‚è½½å­˜å‚¨å·ï¼Œå¦‚æœPodä¸­ä¸¤ä¸ªå®¹å™¨éƒ½æŒ‚è½½äº†æŸä¸ªå­˜å‚¨å·ï¼Œå°±ç›¸å½“äºä¸¤ä¸ªå®¹å™¨å…±äº«æ•°æ®äº†ã€‚Podåº•å±‚æœ‰ä¸ªåŸºç¡€å®¹å™¨ï¼Œä¸å¯åŠ¨ï¼Œé ä¸€ä¸ªç‹¬ç‰¹çš„é•œåƒæ¥åˆ›å»ºçš„ï¼Œå«pauseã€‚<strong>æ‰€æœ‰çš„Podï¼Œå…¶ç½‘ç»œåç§°ç©ºé—´ã€å­˜å‚¨å·ä¹‹ç±»çš„éƒ½æ˜¯åˆ†é…ç»™è¿™ä¸ªPodçš„</strong>ï¼ŒPodä¸­è¿è¡Œçš„ä¸»å®¹å™¨æ˜¯å…±äº«è¿™ä¸ªé•œåƒçš„ç½‘ç»œåç§°ç©ºé—´çš„ï¼Œå®¹å™¨æŒ‚è½½å­˜å‚¨å·å…¶å®æ˜¯æŒ‚è½½è¿™ä¸ªå®¹å™¨çš„å­˜å‚¨å·çš„ã€‚æ‰€ä»¥å«åŸºç¡€æ¶æ„å®¹å™¨ã€‚</p><p>åœ¨Podä¸Šä½¿ç”¨å­˜å‚¨å·ï¼Œå®é™…ä¸Šä¹Ÿå°±æ˜¯è¿™ä¸ªpauseå®¹å™¨æœ‰äº†å­˜å‚¨å·ï¼Œè€Œè¿™ä¸ªå®¹å™¨æœ‰å­˜å‚¨å·ï¼Œåªä¸è¿‡æ˜¯è¿™ä¸ªå®¹å™¨å’Œå®¿ä¸»æœºç›®å½•å»ºç«‹äº†å…³è”å…³ç³»ã€‚è€Œå®¿ä¸»æœºç›®å½•å¦‚æœæ˜¯èŠ‚ç‚¹æœ¬åœ°çš„ï¼Œé‚£ä¹ˆå®ƒå°±éšç€å®¿ä¸»æœºè€Œç»ˆç»“äº†ï¼Œå› æ­¤å®¿ä¸»æœºè¿™ä¸ªç›®å½•ä¸ºäº†çœŸæ­£å®ç°æŒä¹…æ€§ï¼Œå®ƒåº”è¯¥ä¹Ÿä¸æ˜¯å®¿ä¸»æœºæœ¬åœ°çš„ï¼Œ<strong>è€Œæ˜¯å®¿ä¸»æœºæŒ‚è½½çš„å¤–éƒ¨å­˜å‚¨è®¾å¤‡ä¸Šçš„å­˜å‚¨å·ã€‚</strong>å½“ç„¶å¦‚æœè¿™ä¸ªå®¿ä¸»æœºçš„ç›®å½•æ²¡æŒ‚è½½ï¼Œé‚£å°±æ˜¯èŠ‚ç‚¹æœ¬åœ°çš„äº†ã€‚åªè¦èŠ‚ç‚¹ä¸å®•æœºï¼Œæ•°æ®å°±æ˜¯æŒä¹…çš„ã€‚ä½†æ˜¯è·¨èŠ‚ç‚¹å­˜å‚¨ï¼Œåªèƒ½ä½¿ç”¨è„±ç¦»èŠ‚ç‚¹æœ¬åœ°çš„ç½‘ç»œè®¾å¤‡ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/143.png"></p><blockquote><p>æ€»ä¹‹ï¼š</p><p>è·¨èŠ‚ç‚¹å­˜å‚¨ï¼šPodå†…å®¹å™¨â¡Pauseå®¹å™¨â¡å®¿ä¸»æœºï¼ˆéæœ¬åœ°ï¼‰æŒ‚è½½çš„å¤–éƒ¨è®¾å¤‡</p><p>æœ¬åœ°èŠ‚ç‚¹å­˜å‚¨ï¼šPodå†…å®¹å™¨â¡Pauseå®¹å™¨â¡å®¿ä¸»æœºï¼ˆæœ¬åœ°ï¼‰ï¼Œè¿™æ ·Podé‡å¯æˆ–è€…è¿ç§»æ—¶èŠ‚ç‚¹æ¢æ‰ï¼Œåˆ™æ•°æ®ä¸¢å¤±ï¼</p></blockquote><h4 id="Kuberneteså­˜å‚¨å·åˆ†ç±»"><a href="#Kuberneteså­˜å‚¨å·åˆ†ç±»" class="headerlink" title="Kuberneteså­˜å‚¨å·åˆ†ç±»"></a>Kuberneteså­˜å‚¨å·åˆ†ç±»</h4><p>ä¸Šé¢è¯´åˆ°k8sæä¾›äº†èƒ½åº”ä»˜å„ç§ä¸åŒç±»å‹çš„å­˜å‚¨å·è®©æˆ‘ä»¬æ¥ä½¿ç”¨ï¼šæ²¡æœ‰æŒä¹…ã€åŠæŒä¹…ã€æˆ–çœŸæ­£æ„ä¹‰ä¸Šçš„æŒä¹…åŠŸèƒ½ã€‚</p><h5 id="emptyDir"><a href="#emptyDir" class="headerlink" title="emptyDir"></a>emptyDir</h5><p>ç»™Podåˆ†é…ä¸€ä¸ªå­˜å‚¨å·ï¼Œå­˜å‚¨å·åªå­˜åœ¨PodèŠ‚ç‚¹æœ¬åœ°ï¼Œ<strong>å½“Podè¢«åˆ é™¤ï¼ŒèŠ‚ç‚¹ä¸Šå­˜å‚¨å·ä¹Ÿä¼šä¸€å¹¶è¢«åˆ é™¤</strong>ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201119161057269.png" alt="image-20201119161057269"></p><blockquote><p>è¿™ä¸ªä¸æ˜¯ä¸ºäº†æŒä¹…è€Œè®¾è®¡ã€‚åªæ˜¯ç”¨æ¥åšä¸´æ—¶ç›®å½•ä½¿ç”¨çš„ã€‚</p></blockquote><h5 id="hostPath"><a href="#hostPath" class="headerlink" title="hostPath"></a>hostPath</h5><p>ä¸»æœºè·¯å¾„ã€‚ç›´æ¥åœ¨å®¿ä¸»æœºæ‰¾ä¸€ä¸ªç›®å½•ï¼Œä¸å®¹å™¨å»ºç«‹å…³è”å…³ç³»ã€‚ä¹Ÿä¸å…·æœ‰çœŸæ­£æ„ä¹‰ä¸Šçš„æŒä¹…æ€§ã€‚å¦‚æœéœ€è¦çœŸæ­£ä»¥ä¸Šçš„æŒä¹…æ€§ï¼Œåˆ™éœ€è¦è¿æ¥ç½‘ç»œè¿æ¥å­˜å‚¨ã€‚å¤§æ¦‚åˆ†3ç±»ï¼š</p><ol><li>SAN(å­˜å‚¨åŒºåŸŸç½‘ç»œï¼Œæ¯”å¦‚iSCSIã€FCåè®®)ã€NAS(ç½‘ç»œé™„åŠ å­˜å‚¨ï¼Œæ¯”å¦‚nfsåè®®ã€cifsåè®®ä»¥åŠhttpåè®®)</li><li>åˆ†å¸ƒå¼å­˜å‚¨ï¼šæˆ–æ˜¯æ–‡ä»¶ç³»ç»Ÿçº§åˆ«ã€æˆ–è€…å—è®¾å¤‡ã€‚<br>æ–‡ä»¶ç³»ç»Ÿçº§åˆ«ï¼šglusterfsã€cephfs<br>å—çº§åˆ«ï¼šrbd</li><li>äº‘å­˜å‚¨ï¼šäºšé©¬é€Šçš„EBS(å¼¹æ€§å—å­˜å‚¨)ã€Azure Diskã€‚</li></ol><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201119161514977.png" alt="image-20201119161514977"></p><h5 id="pvc"><a href="#pvc" class="headerlink" title="pvc"></a>pvc</h5><p><strong>æŒä¹…å­˜å‚¨å·ç”³è¯·ï¼Œç®€ç§°pvc</strong>ã€‚ä»æŸç§æ„ä¹‰ä¸Šæ¥è®²ï¼Œå®ƒä¸æ˜¯ä¸€ä¸ªå­˜å‚¨å·ã€‚ä»¥rbdä¸ºä¾‹ï¼Œå½“ä½ å®šä¹‰ä½¿ç”¨rbdç±»å‹çš„å­˜å‚¨æ—¶ï¼Œä½ éœ€è¦å®šä¹‰å¾ˆå¤šç›¸å…³çš„å‚æ•°ï¼Œè¿™éœ€è¦ä½ å¯¹è¿™ä¸ªå­˜å‚¨å¾ˆç†Ÿæ‚‰ã€‚è¿™ä¼šé˜»æ–­ä¸€å¤§éƒ¨åˆ†ç”¨æˆ·æ¥ç”¨k8sã€‚æ€ä¹ˆè½¬æ¢æˆå‚»ç“œçš„å½¢å¼æ¥ä½¿ç”¨ï¼Ÿpvcå°±æ˜¯å¹²è¿™ä¸ªäº‹æƒ…çš„ã€‚<br>å½“éœ€è¦åˆ›å»ºä¸€ä¸ªå­˜å‚¨å·æ—¶ï¼Œä½ åªéœ€è¦å‘Šè¯‰æˆ‘ï¼Œâ€œæˆ‘è¦æ¥ä¸ªå­˜å‚¨å·â€ï¼Œæ‰€ä»¥å«å­˜å‚¨å·åˆ›å»ºç”³è¯·ã€‚ä½ ä¸è¦ç®¡å®ƒåº•å±‚å­˜å‚¨ç³»ç»Ÿæ˜¯ä»€ä¹ˆï¼Œä½ åªéœ€è¦è¯´â€œæˆ‘å°±éœ€è¦è¿™ä¹ˆå¤šâ€å°±è¡Œã€‚æŒ‡å®šå‘Šè¯‰å®ƒæ¯”å¦‚è¯´éœ€è¦ä¸ª5gçš„å­˜å‚¨ç©ºé—´ï¼Œè€Œä¸ç”¨ç®¡å®ƒé‚£ä¸ªå­˜å‚¨åˆ°åº•æ”¾åœ¨å“ªä¸ªç³»ç»Ÿä¸Šã€‚<strong>è¿™å«å­˜å‚¨åŠæœåŠ¡ã€‚</strong></p><p>è®©Podåˆ›å»ºå’Œåº•å±‚å­˜å‚¨è§£è€¦ã€‚å…³é”®æ˜¯å’Œpvcå»ºç«‹å…³è”å…³ç³»ï¼Œè€Œpvcå…³é”®æ˜¯å’Œpvå»ºç«‹å…³è”å…³ç³»ï¼Œè€Œpvå…³é”®æ˜¯å’Œå­˜å‚¨ç³»ç»Ÿå»ºç«‹å…³è”å…³ç³»ã€‚è§£é‡Šå¦‚ä¸‹ï¼šå‡å¦‚ä¸€ä¸ªPodåˆ›å»ºè°ƒåº¦åˆ°æŸä¸ªèŠ‚ç‚¹ä¸Šï¼Œæˆ‘ä»¬åœ¨Podä¸Šå®šä¹‰ä¸€ä¸ªpvcï¼Œå®ƒæ˜¯ä¸€ç§å­˜å‚¨å·ç±»å‹ï¼Œpvcè¦å…³è”åˆ°å½“å‰è¿™ä¸ªPodæ‰€åœ¨åç§°ç©ºé—´çœŸæ­£å­˜åœ¨çš„pvcèµ„æºï¼Œè¿™ä¸ªpvcåªæ˜¯ä¸ªç”³è¯·ï¼Œç”³è¯·è¦ä¸pvå»ºç«‹å…³è”å…³ç³»ï¼Œpvæ˜¯çœŸæ­£å­˜å‚¨ç³»ç»Ÿä¹‹ä¸Šçš„ä¸€æ®µå­˜å‚¨ç©ºé—´ï¼Œpvä¸åç«¯å­˜å‚¨å»ºç«‹å…³è”å…³ç³»ã€‚ä½†æ˜¯è¿™ä¸ªpvcä¸å“ªä¸ªpvå»ºç«‹å…³è”å…³ç³»æ—¶ï¼Œæ€ä¹ˆå¯èƒ½æœ‰ä¸ªpvæ”¾åœ¨é‚£ç­‰ä½ æ¥ç”¨å‘¢ï¼Ÿè¦åšåˆ°è¿™ä¸€æ­¥ï¼Œç”¨æˆ·åœ¨åˆ›å»ºç”³è¯·ä¹‹å‰ï¼Œå…ˆæéœ€æ±‚ï¼Œç„¶ååç«¯å­˜å‚¨å·¥ç¨‹å¸ˆæˆ–è€…k8sç®¡ç†å‘˜æŠŠè¿™äº›pvåˆ›å»ºå¥½ã€‚ä½†æ˜¯å¦‚æœæ˜¯å…¬æœ‰äº‘å‘¢ï¼Ÿæœ‰å¾ˆå¤šç§Ÿæˆ·åœ¨ä¸Šé¢è·‘ç€ï¼Œå‹æ ¹ä¸çŸ¥é“ä»–ä»¬ä»€ä¹ˆæ—¶å€™è¦åˆ›å»ºpvã€‚å› æ­¤å¦‚æœè¦åšåˆ°æŒ‰éœ€åˆ›å»ºï¼Œæˆ‘ä»¬pvä¹Ÿä¸å»ºäº†ï¼Œæˆ‘ä»¬æŠŠæ‰€æœ‰çš„å­˜å‚¨ç©ºé—´æŠ½è±¡å‡ºæ¥ï¼ŒæŠ½è±¡ä¸ºä¸€ä¸ªæŠ½è±¡å±‚ï¼Œå«<strong>å­˜å‚¨ç±»</strong>ã€‚å½“ç”¨æˆ·åˆ›å»ºpvcéœ€è¦ç”¨åˆ°pvæ—¶ï¼Œå®ƒèƒ½å¤Ÿå‘å­˜å‚¨ç±»ç”³è¯·è¯´ï¼Œâ€œä½ å¸®æˆ‘åˆ›å»ºå‡ºæ¥â€ï¼Œå­˜å‚¨ç±»ä¼šå¸®å®ƒç”Ÿæˆåˆšå¥½ç¬¦åˆç”¨æˆ·è¯·æ±‚å¤§å°çš„pvæ¥ï¼Œå¹¶è®©äºŒè€…å»ºç«‹å…³è”å…³ç³»ã€‚<strong>åƒè¿™ç§pvç”±ç”¨æˆ·çš„è¯·æ±‚è§¦å‘è€ŒåŠ¨æ€ç”Ÿæˆï¼Œæˆ‘ä»¬ç§°ä¸ºpvçš„åŠ¨æ€ä¾›ç»™ã€‚è€Œè¿™é‡Œéœ€è¦ä¾èµ–ä¸€ä¸ªå‰æï¼šè¦å®šä¹‰å¥½å­˜å‚¨ç±»ã€‚</strong><br><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/144.png" alt="img"><br>ä»€ä¹ˆå«å­˜å‚¨ç±»ï¼Ÿå­˜å‚¨æŒ‰ç…§å…¶ç»¼åˆæœåŠ¡è´¨é‡å¯ä»¥åˆ†ä¸ºå¥½å‡ ä¸ªçº§åˆ«ï¼Œæœ‰çš„åˆæ…¢åˆç¬¨ï¼Œç§°ä¸ºBronzeå­˜å‚¨ï¼Œæœ‰çš„é€Ÿåº¦ç®—ä¸­é—´ï¼Œæˆ‘ä»¬å¯¹æ€§èƒ½æ²¡æœ‰å¤ªé«˜è¦æ±‚ï¼Œç§°ä¸ºSilverå­˜å‚¨ï¼Œè€Œæœ‰äº›ç‰¹åˆ«å¿«ï¼Œssdä¹‹ç±»ç»„æˆçš„ï¼Œç§°ä¸ºGoldå­˜å‚¨ã€‚<br><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/145.png" alt="img"><br>å¦‚æœæˆ‘ä»¬è‡ªå·±æ˜¯ä¸€ä¸ªå¯¹äºå­˜å‚¨ç³»ç»Ÿéå¸¸äº†è§£çš„äººï¼Œåˆ›å»ºPodæ—¶å¯ç›´æ¥ä½¿ç”¨å­˜å‚¨ç©ºé—´ï¼Œå¦‚æœä½ ä¸æ˜¯ç‰¹åˆ«äº†è§£ï¼Œæˆ–è€…æˆ‘ä»¬å°†æ¥æœ‰å¾ˆå¤šç”¨æˆ·ã€ç»ˆç«¯ç”¨æˆ·å¯¹äºå­˜å‚¨æŠ€æœ¯çŸ¥ä¹‹ä¸å¤šçš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±åº”è¯¥å°½å¯èƒ½åœ°ç»™ä»–ä»¬åšæˆåŠ¨æ€ä¾›ç»™çš„æ–¹å¼ï¼Œè®©ä»–ä»¬ä½¿ç”¨pvcæ¥ä½¿ç”¨ã€‚</p><h4 id="å®ä¾‹"><a href="#å®ä¾‹" class="headerlink" title="å®ä¾‹"></a>å®ä¾‹</h4><p>å­˜å‚¨å·åªæ˜¯åœ¨Podä¸Šå®šä¹‰çš„ï¼Œå®¹å™¨ä¸­è¦æƒ³ä½¿ç”¨è¿˜å¾—æŒ‚è½½å’Œç»‘å®šã€‚ç¬¬ä¸€åœ¨Podä¸­è¦å®šä¹‰<code>volume</code>ï¼Œè¿™ä¸ªvolumeè¦æŒ‡æ˜å…³è”åˆ°å“ªä¸ªå­˜å‚¨è®¾å¤‡ä¸Šå»çš„ï¼Œç¬¬äºŒè¦åœ¨å®¹å™¨ä¸­ä½¿ç”¨<code>volumeMounts</code>ï¼Œç„¶åä½ æ‰èƒ½ä½¿ç”¨ã€‚</p><h5 id="emptyDir-1"><a href="#emptyDir-1" class="headerlink" title="emptyDir"></a>emptyDir</h5><p>emptyDirä¸éœ€è¦ä¾èµ–ä»»ä½•å¤–éƒ¨è®¾å¤‡ã€‚</p><p>æŸ¥çœ‹å®šä¹‰emptyDirçš„ç›¸å…³å­—æ®µï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl explain pod.spec.volumes.emptyDir</span><br><span class="line">$ kubectl explain pod.spec.containers.volumeMounts</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªç»ƒä¹ ä¸­ï¼Œä½ ä¼šåˆ›å»ºä¸€ä¸ªåŒ…å«ä¸¤ä¸ªå®¹å™¨çš„ Podã€‚ä¸¤ä¸ªå®¹å™¨å…±äº«ä¸€ä¸ªå·ç”¨äºä»–ä»¬ä¹‹é—´çš„é€šä¿¡ã€‚ Pod çš„é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">two-containers</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">shared-data</span></span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">shared-data</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debian-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">debian</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">shared-data</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/pod-data</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo Hello from the debian container &gt; /pod-data/index.html&quot;</span>]</span><br></pre></td></tr></table></figure><p>åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ° Pod æœ‰ä¸€ä¸ªå…±äº«å·ï¼Œåä¸º <code>shared-data</code>ã€‚</p><p>é…ç½®æ–‡ä»¶ä¸­çš„ç¬¬ä¸€ä¸ªå®¹å™¨è¿è¡Œäº†ä¸€ä¸ª nginx æœåŠ¡å™¨ã€‚å…±äº«å·çš„æŒ‚è½½è·¯å¾„æ˜¯ <code>/usr/share/nginx/html</code>ã€‚ ç¬¬äºŒä¸ªå®¹å™¨æ˜¯åŸºäº debian é•œåƒçš„ï¼Œæœ‰ä¸€ä¸ª <code>/pod-data</code> çš„æŒ‚è½½è·¯å¾„ã€‚ç¬¬äºŒä¸ªå®¹å™¨è¿è¡Œäº†ä¸‹é¢çš„å‘½ä»¤ç„¶åç»ˆæ­¢ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> Hello from the debian container &gt; /pod-data/index.html</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œç¬¬äºŒä¸ªå®¹å™¨åœ¨ nginx æœåŠ¡å™¨çš„æ ¹ç›®å½•ä¸‹å†™äº† <code>index.html</code> æ–‡ä»¶ã€‚</p><p>åˆ›å»ºä¸€ä¸ªåŒ…å«ä¸¤ä¸ªå®¹å™¨çš„ Podï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f https://k8s.io/examples/pods/two-container-pod.yaml</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ Pod å’Œå®¹å™¨çš„ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod two-containers --output=yaml</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯è¾“å‡ºçš„ä¸€éƒ¨åˆ†ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">two-containers</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="attr">containerStatuses:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">containerID:</span> <span class="string">docker://c1d8abd1</span> <span class="string">...</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">debian</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">lastState:</span></span><br><span class="line">      <span class="attr">terminated:</span></span><br><span class="line">        <span class="string">...</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">debian-container</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">containerID:</span> <span class="string">docker://96c1ff2c5bb</span> <span class="string">...</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx-container</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">state:</span></span><br><span class="line">      <span class="attr">running:</span></span><br><span class="line">    <span class="string">...</span></span><br></pre></td></tr></table></figure><p>ä½ å¯ä»¥çœ‹åˆ° debian å®¹å™¨å·²ç»è¢«ç»ˆæ­¢äº†ï¼Œè€Œ nginx æœåŠ¡å™¨ä¾ç„¶åœ¨è¿è¡Œã€‚</p><p>è¿›å…¥ nginx å®¹å™¨çš„ shellï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it two-containers -c nginx-container -- /bin/bash</span><br></pre></td></tr></table></figure><p>åœ¨ shell ä¸­ï¼Œç¡®è®¤ nginx è¿˜åœ¨è¿è¡Œã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@two-containers:/<span class="comment"># ps aux</span></span><br></pre></td></tr></table></figure><p>è¾“å‡ºç±»ä¼¼äºè¿™æ ·ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">USER       PID  ...  STAT START   TIME COMMAND</span><br><span class="line">root         1  ...  Ss   21:12   0:00 nginx: master process nginx -g daemon off;</span><br></pre></td></tr></table></figure><p>å›å¿†ä¸€ä¸‹ï¼Œdebian å®¹å™¨åœ¨ nginx çš„æ ¹ç›®å½•ä¸‹åˆ›å»ºäº† <code>index.html</code> æ–‡ä»¶ã€‚ ä½¿ç”¨ <code>curl</code> å‘ nginx æœåŠ¡å™¨å‘é€ä¸€ä¸ª GET è¯·æ±‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@two-containers:/<span class="comment"># apt-get update</span></span><br><span class="line">root@two-containers:/<span class="comment"># apt-get install curl</span></span><br><span class="line">root@two-containers:/<span class="comment"># curl localhost</span></span><br></pre></td></tr></table></figure><p>è¾“å‡ºè¡¨ç¤º nginx æä¾›äº† debian å®¹å™¨å†™çš„é¡µé¢ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello from the debian container</span><br></pre></td></tr></table></figure><h5 id="nfså…±äº«ç½‘ç»œå­˜å‚¨"><a href="#nfså…±äº«ç½‘ç»œå­˜å‚¨" class="headerlink" title="nfså…±äº«ç½‘ç»œå­˜å‚¨"></a>nfså…±äº«ç½‘ç»œå­˜å‚¨</h5><p>è¿™ç§æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„æŒä¹…åŠŸèƒ½ï¼Œæˆ‘ä»¬<font color="red">éœ€è¦ä¸€å°å•ç‹¬çš„æœºå™¨ä½œä¸ºç½‘ç»œå­˜å‚¨nfsçš„æœåŠ¡ç«¯</font>ï¼Œç„¶ååœ¨å¯åŠ¨çš„Podé‡Œæ‰‹åŠ¨æŒ‡å®šVolumeæŒ‚è½½åˆ°nfsçš„æœåŠ¡ç«¯ï¼Œæ‰€ä»¥<font color="red">ä¹Ÿéœ€è¦k8sçš„é›†ç¾¤çš„å„ä¸ªèŠ‚ç‚¹è¦å®‰è£…nfsçš„å®¢æˆ·ç«¯</font></p><p><strong>1. æœåŠ¡ç«¯å®‰è£…nfs</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y nfs-utils</span><br></pre></td></tr></table></figure><p>è®¾ç½®æŒ‚è½½è·¯å¾„ï¼ˆæŒ‚è½½è·¯å¾„éœ€è¦å­˜åœ¨ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/exports</span><br><span class="line">/data/nfs *(rw,no_root_squash)</span><br></pre></td></tr></table></figure><p>å¯åŠ¨nfsæœåŠ¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/nfs</span><br><span class="line">systemctl start nfs</span><br><span class="line">ps -ef|grep nfs</span><br></pre></td></tr></table></figure><p><strong>2. k8sé›†ç¾¤èŠ‚ç‚¹å®‰è£…nfså®¢æˆ·ç«¯</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y nfs-utils</span><br></pre></td></tr></table></figure><p><strong>3.  ä½¿ç”¨nfsä½œä¸ºpvè¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-dep1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wwwroot</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wwwroot</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">          <span class="comment"># è¦æ›´æ”¹ä¸ºä½ è‡ªå·±nfsæœåŠ¡ç«¯çš„åœ°å€å’Œç›®å½•</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.58</span><span class="number">.138</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/data/nfs</span></span><br></pre></td></tr></table></figure><p><code>kubectl apply -f xxx.yaml </code></p><p>æˆ‘ä»¬åœ¨æœåŠ¡ç«¯çš„è·¯å¾„ä¸­æ·»åŠ ä¸€ä¸ªæ–‡ä»¶index.htmlï¼Œç„¶ååœ¨è¿›å…¥Podå®¹å™¨æŸ¥çœ‹æ˜¯å¦å­˜åœ¨æ­¤æ–‡ä»¶ã€‚</p><p>nfsæœåŠ¡ç«¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/nfs/</span><br><span class="line">vim index.html</span><br><span class="line">hello my nfs</span><br></pre></td></tr></table></figure><p>è¿›å…¥å®¹å™¨</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-05_17-40-30.png" alt="Snipaste_2020-12-05_17-40-30"></p><p>å¯ä»¥å‘ç°æˆ‘ä»¬è¿›å…¥äº†å®¹å™¨ï¼Œå‘ç°æ•°æ®å·²ç»ç»‘å®šäº†è¿‡å»ï¼Œè¯æ˜æˆ‘ä»¬æˆåŠŸäº†</p><blockquote><p>ç¼ºç‚¹</p><p>è¿™æ ·æˆ‘ä»¬åœ¨Podçš„é…ç½®æ–‡ä»¶ä¸­å£°æ˜nfsçš„åœ°å€å’Œç›®å½•è¿™æ ·æœ‰ç‚¹ä¸å¤ªå®‰å…¨ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡pvå’Œpvcçš„æ–¹å¼æ¥å®ç°æŒä¹…åŒ–ï¼Œå½“ç„¶æœ€åæ•°æ®è¿˜æ˜¯å­˜æ”¾åœ¨æˆ‘ä»¬çš„nfsæœåŠ¡ç«¯</p></blockquote><h5 id="pvå’Œpvcæ–¹å¼"><a href="#pvå’Œpvcæ–¹å¼" class="headerlink" title="pvå’Œpvcæ–¹å¼"></a>pvå’Œpvcæ–¹å¼</h5><p><a href="#pvc">ä¸Šé¢è¯´è¿‡</a>ï¼Œpvcä¸æ˜¯ä¸€ä¸ªå­˜å‚¨æ–‡ä»¶çš„åœ°æ–¹ï¼Œä»–æ˜¯ä¸€ä¸ªæéœ€æ±‚çš„åœ°æ–¹ï¼›pvæ˜¯ä¸€ä¸ªå­˜å‚¨èµ„æºçš„æŠ½è±¡ï¼Œå®ƒæä¾›äº†å­˜å‚¨èµ„æºçš„æ¥å£ã€‚</p><p>ä¾‹å¦‚ä¸Šé¢çš„nfsæœåŠ¡ç«¯å°±æ˜¯å­˜å‚¨çš„èµ„æºï¼Œæˆ‘ä»¬éœ€è¦å¯¹è¿™ä¸ªnfsæœåŠ¡ç«¯å­˜å‚¨èµ„æºåˆ›å»ºpvä¸å…¶ç»‘å®šï¼Œè¿™æ ·æˆ‘ä»¬åªéœ€è¦æŒ‡å®špvæ¥ç»‘å®šæ•°æ®ï¼Œä¸éœ€è¦æ‰‹åŠ¨æŒ‡å®šå­˜å‚¨èµ„æºçš„ç»†èŠ‚ã€‚è€Œpvcæ˜¯ä¸pvç»‘å®šçš„ï¼Œåœ¨ä½¿ç”¨k8sæ—¶ï¼Œç”¨æˆ·æ ¹æœ¬ä¸è€ƒè™‘è¦æŠŠæ•°æ®å­˜å‚¨åœ¨å“ªä¸ªpvï¼Œä»–ä»¬åªä¼šæå‡ºå­˜å‚¨å¤šå¤§çš„å†…å®¹å’ŒåŒ¹é…çš„æ¨¡å¼ï¼Œä»–ä»¬æçš„è¦æ±‚å°±å¯ä»¥çœ‹ä¸ºæ˜¯pvcã€‚ä»–ä»¬çš„å…³ç³»ä¸ºï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-05_17-48-55.png" alt="Snipaste_2020-12-05_17-48-55"></p><p>ä¸€èˆ¬åœ¨çœŸå®ä½¿ç”¨ä¸­ï¼Œpvçš„åˆ›å»ºå’Œpvåº•å±‚çš„å­˜å‚¨èµ„æºçš„åˆ›å»ºéƒ½æ˜¯ç”±ä¸“é—¨çš„å­˜å‚¨å·¥ç¨‹å¸ˆæ¥åšçš„ï¼Œæˆ‘ä»¬åœ¨åˆ›å»ºæœåŠ¡çš„æŒä¹…åŒ–çš„å·¥ç¨‹ä¸­åªéœ€è¦æŒ‡å®špvcï¼ˆéœ€æ±‚ï¼‰å³å¯ã€‚</p><p>æˆ‘è¿™é‡Œä¸ºäº†å®ç°æ•´ä¸ªæµç¨‹ï¼Œæœ‰åˆ›å»ºå­˜å‚¨èµ„æºæŠ½è±¡pvçš„è¿‡ç¨‹</p><p><strong>1. åˆ›å»ºpv</strong></p><p>æ­¤è¿‡ç¨‹æ˜¯å·²ç»åœ¨<a href="#nfs%E5%85%B1%E4%BA%AB%E7%BD%91%E7%BB%9C%E5%AD%98%E5%82%A8">ä¸Šä¸€æ­¥éª¤</a>åˆ›å»ºå¥½äº†nfsæœåŠ¡ç«¯çš„åç»­ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/k8s/nfs</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.58</span><span class="number">.138</span></span><br></pre></td></tr></table></figure><p><code>kubectl apply -f pv.yaml</code></p><p><strong>2. åˆ›å»ºpvcå¹¶ä½¿ç”¨</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-dep1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wwwroot</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wwwroot</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">my-pvc</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure><p><code>kubectl apply -f pvc.yaml</code></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201205175846703.png" alt="image-20201205175846703"></p><blockquote><p>å¯ä»¥æ ¹æ®é…ç½®æ–‡ä»¶çœ‹åˆ°pvcçš„åˆ›å»ºåªéœ€è¦æŒ‡å®šå¤§å°ã€è§„åˆ™ã€‚æ²¡æœ‰ä¸pvæœ‰å…³çš„åœ°æ–¹ã€‚k8sä¼šæ ¹æ®ä½ çš„éœ€æ±‚è‡ªåŠ¨ä¸pvç»‘å®šã€‚</p></blockquote><p>æ‰‹åŠ¨è¿›å…¥å®¹å™¨ï¼ŒæŸ¥çœ‹ä¹‹å‰åœ¨nfsæœåŠ¡ç«¯æ·»åŠ çš„æ–‡ä»¶index.htmlæ˜¯å¦å­˜åœ¨</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-05_18-01-51.png" alt="Snipaste_2020-12-05_18-01-51"></p><p>pvcæ¨¡å¼æˆåŠŸï¼Œè®¿é—®ä¸€ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]<span class="comment"># kubectl expose deploy nginx-dep1 --type=NodePort --port=80 --target-port=80</span></span><br><span class="line">service/nginx-dep1 exposed</span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl get svc</span></span><br><span class="line">NAME         TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1     &lt;none&gt;        443/TCP        18d</span><br><span class="line">nginx-dep1   NodePort    10.108.56.3   &lt;none&gt;        80:30437/TCP   5s</span><br><span class="line">[root@k8smaster ~]<span class="comment">#</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-05_18-04-12.png" alt="Snipaste_2020-12-05_18-04-12"></p><h3 id="ç”Ÿå‘½å‘¨æœŸçŸ­æš‚"><a href="#ç”Ÿå‘½å‘¨æœŸçŸ­æš‚" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸçŸ­æš‚"></a>ç”Ÿå‘½å‘¨æœŸçŸ­æš‚</h3><p>Pod å±äºç”Ÿå‘½å‘¨æœŸæ¯”è¾ƒçŸ­æš‚çš„ç»„ä»¶ï¼Œæ¯”å¦‚ï¼Œå½“ Pod æ‰€åœ¨èŠ‚ç‚¹å‘ç”Ÿæ•…éšœï¼Œé‚£ä¹ˆè¯¥èŠ‚ç‚¹ä¸Šçš„ Podä¼šè¢«è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¢«é‡æ–°è°ƒåº¦çš„ Pod æ˜¯ä¸€ä¸ªå…¨æ–°çš„ Pod,è·Ÿä¹‹å‰çš„Pod æ²¡æœ‰åŠæ¯›é’±å…³ç³»ã€‚</p><h3 id="å¹³å¦çš„ç½‘ç»œ"><a href="#å¹³å¦çš„ç½‘ç»œ" class="headerlink" title="å¹³å¦çš„ç½‘ç»œ"></a><strong>å¹³å¦çš„ç½‘ç»œ</strong></h3><p>K8s é›†ç¾¤ä¸­çš„æ‰€æœ‰ Pod éƒ½åœ¨åŒä¸€ä¸ªå…±äº«ç½‘ç»œåœ°å€ç©ºé—´ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ª Pod éƒ½å¯ä»¥é€šè¿‡å…¶ ä»– Pod çš„ IP åœ°å€æ¥å®ç°è®¿é—®ã€‚ </p><h2 id="Podçš„ä¸€äº›è®¾ç½®"><a href="#Podçš„ä¸€äº›è®¾ç½®" class="headerlink" title="Podçš„ä¸€äº›è®¾ç½®"></a>Podçš„ä¸€äº›è®¾ç½®</h2><h3 id="é•œåƒæ‹‰å–ç­–ç•¥"><a href="#é•œåƒæ‹‰å–ç­–ç•¥" class="headerlink" title="é•œåƒæ‹‰å–ç­–ç•¥"></a>é•œåƒæ‹‰å–ç­–ç•¥</h3><ul><li><code>ifNotPresent</code>ï¼šé»˜è®¤å€¼ï¼Œé•œåƒåœ¨å®¿ä¸»æœºä¸Šä¸å­˜åœ¨æ—¶æ‰æ‹‰å–</li><li><code>Always</code>ï¼šæ¯æ¬¡åˆ›å»ºéƒ½ä¼šé‡æ–°æ‹‰å–</li><li><code>Never</code>ï¼šä»ä¸æ‹‰å–ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl explain pod.spec.containers.imagePullPolicy</span><br></pre></td></tr></table></figure><h3 id="ç”Ÿå‘½å‘¨æœŸå’Œé‡å¯ç­–ç•¥"><a href="#ç”Ÿå‘½å‘¨æœŸå’Œé‡å¯ç­–ç•¥" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸå’Œé‡å¯ç­–ç•¥"></a>ç”Ÿå‘½å‘¨æœŸå’Œé‡å¯ç­–ç•¥</h3><h4 id="ç”Ÿå‘½å‘¨æœŸ"><a href="#ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸ"></a>ç”Ÿå‘½å‘¨æœŸ</h4><table><thead><tr><th>çŠ¶æ€å€¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>Pending</td><td>API Serverå·²ç»åˆ›å»ºäº†è¯¥Pod,ä½†Podä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨çš„é•œåƒè¿˜æ²¡æœ‰åˆ›å»º,åŒ…æ‹¬é•œåƒä¸‹è½½è¿‡ç¨‹</td></tr><tr><td>Running</td><td>Podå†…æ‰€æœ‰å®¹å™¨å·²åˆ›å»º,ä¸”è‡³å°‘ä¸€ä¸ªå®¹å™¨å¤„äºè¿è¡ŒçŠ¶æ€ã€æ­£åœ¨å¯åŠ¨çŠ¶æ€æˆ–æ­£åœ¨é‡å¯çŠ¶æ€</td></tr><tr><td>Completed</td><td>Podå†…æ‰€æœ‰å®¹å™¨å‡æˆåŠŸæ‰§è¡Œé€€å‡º,ä¸”ä¸ä¼šå†é‡å¯</td></tr><tr><td>Failed</td><td>Podå†…æ‰€æœ‰å®¹å™¨å‡å·²é€€å‡º,ä½†è‡³å°‘ä¸€ä¸ªå®¹å™¨é€€å‡ºå¤±è´¥</td></tr><tr><td>Unknown</td><td>ç”±äºæŸç§åŸå› æ— æ³•è·å–PodçŠ¶æ€,ä¾‹å¦‚ç½‘ç»œé€šä¿¡ä¸ç•…</td></tr></tbody></table><h4 id="é‡å¯ç­–ç•¥"><a href="#é‡å¯ç­–ç•¥" class="headerlink" title="é‡å¯ç­–ç•¥"></a>é‡å¯ç­–ç•¥</h4><p>Pod çš„é‡å¯ç­–ç•¥åŒ…æ‹¬ Alwaysã€OnFailure å’Œ Neverï¼Œé»˜è®¤å€¼æ˜¯ Always</p><table><thead><tr><th>é‡å¯ç­–ç•¥</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>Always</td><td>å½“å®¹å™¨å¤±æ•ˆæ—¶,ç”± kubeletè‡ªåŠ¨é‡å¯è¯¥å®¹å™¨</td></tr><tr><td>OnFailure</td><td>å½“å®¹å™¨ç»ˆæ­¢è¿è¡Œä¸”é€€å‡ºç ä¸ä¸º0æ—¶,ç”± kubeleè‡ªåŠ¨é‡å¯è¯¥å®¹å™¨</td></tr><tr><td>Never</td><td>ä¸è®ºå®¹å™¨è¿è¡ŒçŠ¶æ€å¦‚ä½•, kubeletéƒ½ä¸ä¼šé‡å¯è¯¥å®¹å™¨</td></tr></tbody></table><h3 id="èµ„æºé™åˆ¶é…ç½®"><a href="#èµ„æºé™åˆ¶é…ç½®" class="headerlink" title="èµ„æºé™åˆ¶é…ç½®"></a>èµ„æºé™åˆ¶é…ç½®</h3><p>æ¯ä¸ª Pod éƒ½å¯ä»¥å¯¹å…¶èƒ½ä½¿ç”¨çš„æœåŠ¡å™¨ä¸Šçš„è®¡ç®—èµ„æºè®¾ç½®é™é¢ï¼ŒKubernetes ä¸­å¯ä»¥è®¾ç½®é™é¢çš„è®¡ç®—èµ„æºæœ‰ CPU ä¸ Memory ä¸¤ç§ï¼Œå…¶ä¸­CPU çš„èµ„æºå•ä½ä¸º CPU æ•°é‡,æ˜¯ä¸€ä¸ªç»å¯¹å€¼è€Œéç›¸å¯¹å€¼ã€‚Memory é…é¢ä¹Ÿæ˜¯ä¸€ä¸ªç»å¯¹å€¼ï¼Œå®ƒçš„å• ä½æ˜¯<strong>å†…å­˜å­—èŠ‚æ•°</strong>ã€‚ </p><p>Kubernetes é‡Œï¼Œä¸€ä¸ªè®¡ç®—èµ„æºè¿›è¡Œé…é¢é™å®šéœ€è¦è®¾å®šä»¥ä¸‹ä¸¤ä¸ªå‚æ•°ï¼š Requests è¯¥èµ„æºæœ€å°ç”³è¯·æ•°é‡ï¼Œç³»ç»Ÿå¿…é¡»æ»¡è¶³è¦æ±‚ Limits è¯¥èµ„æºæœ€å¤§å…è®¸ä½¿ç”¨çš„é‡ï¼Œä¸èƒ½çªç ´ï¼Œå½“å®¹å™¨è¯•å›¾ä½¿ç”¨è¶…è¿‡è¿™ä¸ªé‡çš„èµ„æºæ—¶ï¼Œ<strong>å¯èƒ½ä¼šè¢« Kubernetes Kill å¹¶é‡å¯</strong> ã€‚</p><p><strong>ä¸¾ä¾‹</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">db</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">env:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;123456&quot;</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;64Mi&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;128Mi&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br></pre></td></tr></table></figure><p><strong>ä¸Šè¿°ä»£ç è¡¨æ˜ MySQL å®¹å™¨ç”³è¯·æœ€å°‘ 0.25 ä¸ª CPU ä»¥åŠ 64MiB å†…å­˜ï¼Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­å®¹å™¨æ‰€èƒ½ä½¿ç”¨çš„èµ„æºé…é¢ä¸º 0.5 ä¸ª CPU ä»¥åŠ 128MiB å†…å­˜</strong></p><h3 id="å¥åº·æ£€æŸ¥"><a href="#å¥åº·æ£€æŸ¥" class="headerlink" title="å¥åº·æ£€æŸ¥"></a>å¥åº·æ£€æŸ¥</h3><p>Kubeletä½¿ç”¨liveness probeï¼ˆå­˜æ´»æ¢é’ˆï¼‰æ¥ç¡®å®šä½•æ—¶é‡å¯å®¹å™¨ã€‚ä¾‹å¦‚ï¼Œå½“åº”ç”¨ç¨‹åºå¤„äºè¿è¡ŒçŠ¶æ€ä½†æ— æ³•åšè¿›ä¸€æ­¥æ“ä½œï¼Œlivenessæ¢é’ˆå°†æ•è·åˆ°deadlockï¼Œé‡å¯å¤„äºè¯¥çŠ¶æ€ä¸‹çš„å®¹å™¨ï¼Œä½¿åº”ç”¨ç¨‹åºåœ¨å­˜åœ¨bugçš„æƒ…å†µä¸‹ä¾ç„¶èƒ½å¤Ÿç»§ç»­è¿è¡Œä¸‹å»ï¼ˆè°çš„ç¨‹åºè¿˜æ²¡å‡ ä¸ªbugå‘¢ï¼‰ã€‚</p><p>Kubeletä½¿ç”¨readiness probeï¼ˆå°±ç»ªæ¢é’ˆï¼‰æ¥ç¡®å®šå®¹å™¨æ˜¯å¦å·²ç»å°±ç»ªå¯ä»¥æ¥å—æµé‡ã€‚åªæœ‰å½“Podä¸­çš„å®¹å™¨éƒ½å¤„äºå°±ç»ªçŠ¶æ€æ—¶kubeletæ‰ä¼šè®¤å®šè¯¥Podå¤„äºå°±ç»ªçŠ¶æ€ã€‚è¯¥ä¿¡å·çš„ä½œç”¨æ˜¯æ§åˆ¶å“ªäº›Podåº”è¯¥ä½œä¸ºserviceçš„åç«¯ã€‚å¦‚æœPodå¤„äºéå°±ç»ªçŠ¶æ€ï¼Œé‚£ä¹ˆå®ƒä»¬å°†ä¼šè¢«ä»serviceçš„load balancerä¸­ç§»é™¤ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl explain pod.spec.containers.livenessProbe</span><br><span class="line">$ kubectl explain pod.spec.containers.readinessProbe</span><br></pre></td></tr></table></figure><h2 id="Podåˆ›å»ºæµç¨‹"><a href="#Podåˆ›å»ºæµç¨‹" class="headerlink" title="Podåˆ›å»ºæµç¨‹"></a>Podåˆ›å»ºæµç¨‹</h2><p><img src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/A1HKVXsfHNkb9ibEAnRZekRbN1Kic7aicNynPBNqlCrnJeb8PqzpbO5FwtGaxo78RbfRdYRzlTE8Mjt4j6PiafVAlA/640"></p><p><strong>masterç«¯</strong></p><ol><li>ç”¨æˆ·å‘å‡ºå‘½ä»¤åˆ°ApiServerï¼Œå°†æ–°å»ºpodçš„ä¿¡æ¯å­˜å…¥etcd</li><li>Schedulerè§‚å¯Ÿåˆ°Api Serverå‘å‡ºäº†æ–°å»ºPodçš„æŒ‡ä»¤ï¼Œä»Etcdé‚£å¾—åˆ°äº†è¦åˆ›å»ºçš„Podå…·ä½“ä¿¡æ¯ï¼Œå®ƒæ ¹æ®è°ƒåº¦è§„åˆ™é€‰ä¸­äº†ä¸€å°èŠ‚ç‚¹æ¥è¿è¡ŒPodï¼Œå¹¶å°†æ­¤ä¿¡æ¯å†™å…¥etcd</li></ol><p><strong>Nodeç«¯</strong></p><ol><li>è¢«é€‰ä¸­çš„èŠ‚ç‚¹ä¸­çš„kubeletè§‚å¯Ÿåˆ°Schedulerç»‘å®šPodåˆ°æœ¬æœºçš„äº‹ä»¶ï¼Œå¼€å§‹æ“æ§Dockerè¿è¡Œå®¹å™¨ï¼Œè¿è¡ŒæˆåŠŸåå‘ŠçŸ¥api serverï¼Œå¹¶ä¿®æ”¹etcdä¸­çš„çŠ¶æ€</li></ol><h2 id="Podè°ƒåº¦ç­–ç•¥"><a href="#Podè°ƒåº¦ç­–ç•¥" class="headerlink" title="Podè°ƒåº¦ç­–ç•¥"></a>Podè°ƒåº¦ç­–ç•¥</h2><h3 id="Podèµ„æºé™åˆ¶"><a href="#Podèµ„æºé™åˆ¶" class="headerlink" title="Podèµ„æºé™åˆ¶"></a>Podèµ„æºé™åˆ¶</h3><p>å‰é¢è¯´åˆ°åœ¨Podåˆ›å»ºçš„é…ç½®ä¸­æœ‰èµ„æºé…ç½®ï¼Œè°ƒåº¦å™¨æ ¹æ®æ­¤Podæ‰€éœ€è¦çš„èµ„æºæ¥é…ç½®ç›¸åº”èŠ‚ç‚¹æ¥è¿è¡Œæ­¤Podï¼Œé‚£è‚¯å®šæ˜¯é…ç½®è¶³å¤Ÿçš„èŠ‚ç‚¹æ‰èƒ½è¿è¡Œæ­¤Podã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201120153131728.png" alt="image-20201120153131728"></p><h3 id="èŠ‚ç‚¹é€‰æ‹©å™¨-nodeSelector"><a href="#èŠ‚ç‚¹é€‰æ‹©å™¨-nodeSelector" class="headerlink" title="èŠ‚ç‚¹é€‰æ‹©å™¨(nodeSelector)"></a>èŠ‚ç‚¹é€‰æ‹©å™¨(nodeSelector)</h3><p>é€šè¿‡å¯¹NodeèŠ‚ç‚¹æ‰“ä¸Šä¸åŒçš„æ ‡ç­¾<code>Label</code>æ¥æŠŠPodè°ƒåº¦åˆ°æŒ‡å®šæ ‡ç­¾çš„Nodeã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201120154555674.png" alt="image-20201120154555674"></p><blockquote><p>å¯¹èŠ‚ç‚¹åˆ›å»ºæ ‡ç­¾</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;$ kubectl label node xxx env_role=dev</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹èŠ‚ç‚¹çš„æ ‡ç­¾</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;$ kubectl node xxx --show-label</span><br></pre></td></tr></table></figure><p>ç»™ namespace ä¸­çš„æ‰€æœ‰ pod æ·»åŠ  label</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;$ kubectl label pods --all status=unhealthy</span><br></pre></td></tr></table></figure><p>åˆ é™¤åä¸ºâ€œbarâ€çš„label ã€‚ï¼ˆä½¿ç”¨â€œ - â€å‡å·ç›¸è¿ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;kubectl label pods xxx bar-</span><br></pre></td></tr></table></figure></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cuda-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cuda-test</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">&quot;k8s.gcr.io/cuda-vector-add:v0.1&quot;</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">nvidia.com/gpu:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">env_role:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201120155613803.png" alt="image-20201120155613803"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201120160233595.png" alt="image-20201120160233595"></p><h3 id="äº²å’Œæ€§è°ƒåº¦-nodeAffinity"><a href="#äº²å’Œæ€§è°ƒåº¦-nodeAffinity" class="headerlink" title="äº²å’Œæ€§è°ƒåº¦(nodeAffinity)"></a>äº²å’Œæ€§è°ƒåº¦(nodeAffinity)</h3><p>å’ŒèŠ‚ç‚¹é€‰æ‹©æ€§åŸç†ä¸€è‡´ï¼Œä½†åŠŸèƒ½æ›´å¼ºå¤§ï¼Œå¯ä»¥å¯¹æ ‡ç­¾è¿›è¡Œä¸åŒçš„æ“ä½œç¬¦è®¡ç®—ã€‚</p><p><code>nodeAffinity</code>å°±æ˜¯èŠ‚ç‚¹äº²å’Œæ€§ï¼Œç›¸å¯¹åº”çš„æ˜¯<code>Anti-Affinity</code>ï¼Œå°±æ˜¯åäº²å’Œæ€§ï¼Œè¿™ç§æ–¹æ³•æ¯”ä¸Šé¢çš„<code>nodeSelector</code>æ›´åŠ çµæ´»ï¼Œå®ƒå¯ä»¥è¿›è¡Œä¸€äº›ç®€å•çš„é€»è¾‘ç»„åˆäº†ï¼Œä¸åªæ˜¯ç®€å•çš„ç›¸ç­‰åŒ¹é…ã€‚ è°ƒåº¦å¯ä»¥åˆ†æˆè½¯ç­–ç•¥å’Œç¡¬ç­–ç•¥ä¸¤ç§æ–¹å¼ï¼Œè½¯ç­–ç•¥å°±æ˜¯å¦‚æœä½ æ²¡æœ‰æ»¡è¶³è°ƒåº¦è¦æ±‚çš„èŠ‚ç‚¹çš„è¯ï¼ŒPOD å°±ä¼šå¿½ç•¥è¿™æ¡è§„åˆ™ï¼Œç»§ç»­å®Œæˆè°ƒåº¦è¿‡ç¨‹ï¼Œè¯´ç™½äº†å°±æ˜¯<strong>æ»¡è¶³æ¡ä»¶æœ€å¥½äº†ï¼Œæ²¡æœ‰çš„è¯ä¹Ÿæ— æ‰€è°“äº†</strong>çš„ç­–ç•¥ï¼›è€Œç¡¬ç­–ç•¥å°±æ¯”è¾ƒå¼ºç¡¬äº†ï¼Œå¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹çš„è¯ï¼Œå°±ä¸æ–­é‡è¯•ç›´åˆ°æ»¡è¶³æ¡ä»¶ä¸ºæ­¢ï¼Œç®€å•è¯´å°±æ˜¯<strong>ä½ å¿…é¡»æ»¡è¶³æˆ‘çš„è¦æ±‚ï¼Œä¸ç„¶æˆ‘å°±ä¸å¹²</strong>çš„ç­–ç•¥ã€‚ <code>nodeAffinity</code>å°±æœ‰ä¸¤ä¸Šé¢ä¸¤ç§ç­–ç•¥ï¼š<code>preferredDuringSchedulingIgnoredDuringExecution</code>å’Œ<code>requiredDuringSchedulingIgnoredDuringExecution</code>ï¼Œå‰é¢çš„å°±æ˜¯è½¯ç­–ç•¥ï¼Œåé¢çš„å°±æ˜¯ç¡¬ç­–ç•¥ã€‚</p><p>å¦‚ä¸‹ä¾‹å­ï¼šï¼ˆ<strong>test-node-affinity.yaml</strong>ï¼‰</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">with-node-affinity</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">node-affinity-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">with-node-affinity</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">NotIn</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.140</span></span><br><span class="line">            <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.161</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">preference:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">source</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">qikqiak</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ä¸ª POD é¦–å…ˆæ˜¯è¦æ±‚ POD ä¸èƒ½è¿è¡Œåœ¨140å’Œ161ä¸¤ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå¦‚æœæœ‰ä¸ªèŠ‚ç‚¹æ»¡è¶³<code>source=qikqiak</code>çš„è¯å°±ä¼˜å…ˆè°ƒåº¦åˆ°è¿™ä¸ªèŠ‚ç‚¹ä¸Šï¼ŒåŒæ ·çš„æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>descirbe</code>å‘½ä»¤æŸ¥çœ‹å…·ä½“çš„è°ƒåº¦æƒ…å†µæ˜¯å¦æ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚ã€‚è¿™é‡Œçš„åŒ¹é…é€»è¾‘æ˜¯ label çš„å€¼åœ¨æŸä¸ªåˆ—è¡¨ä¸­ï¼Œç°åœ¨<code>Kubernetes</code>æä¾›çš„æ“ä½œç¬¦æœ‰ä¸‹é¢çš„å‡ ç§ï¼š</p><ul><li>Inï¼šlabel çš„å€¼åœ¨æŸä¸ªåˆ—è¡¨ä¸­</li><li>NotInï¼šlabel çš„å€¼ä¸åœ¨æŸä¸ªåˆ—è¡¨ä¸­</li><li>Gtï¼šlabel çš„å€¼å¤§äºæŸä¸ªå€¼</li><li>Ltï¼šlabel çš„å€¼å°äºæŸä¸ªå€¼</li><li>Existsï¼šæŸä¸ª label å­˜åœ¨</li><li>DoesNotExistï¼šæŸä¸ª label ä¸å­˜åœ¨</li></ul><blockquote><p>æ³¨æ„ï¼š</p><p>å¦‚æœ<code>nodeSelectorTerms</code>ä¸‹é¢æœ‰å¤šä¸ªé€‰é¡¹çš„è¯ï¼Œæ»¡è¶³ä»»ä½•ä¸€ä¸ªæ¡ä»¶å°±å¯ä»¥äº†ï¼›å¦‚æœ<code>matchExpressions</code>æœ‰å¤šä¸ªé€‰é¡¹çš„è¯ï¼Œåˆ™å¿…é¡»åŒæ—¶æ»¡è¶³è¿™äº›æ¡ä»¶æ‰èƒ½æ­£å¸¸è°ƒåº¦ PODã€‚</p></blockquote><h3 id="podAffinity"><a href="#podAffinity" class="headerlink" title="podAffinity"></a>podAffinity</h3><p>ä¸Šé¢ä¸¤ç§æ–¹å¼éƒ½æ˜¯è®© <strong>POD å»é€‰æ‹©èŠ‚ç‚¹çš„</strong>ï¼Œæœ‰çš„æ—¶å€™æˆ‘ä»¬ä¹Ÿå¸Œæœ›èƒ½å¤Ÿæ ¹æ® POD ä¹‹é—´çš„å…³ç³»è¿›è¡Œè°ƒåº¦ï¼Œ<code>Kubernetes</code>åœ¨1.4ç‰ˆæœ¬å¼•å…¥çš„<code>podAffinity</code>æ¦‚å¿µå°±å¯ä»¥å®ç°æˆ‘ä»¬è¿™ä¸ªéœ€æ±‚ã€‚</p><p>å’Œ<code>nodeAffinity</code>ç±»ä¼¼ï¼Œ<code>podAffinity</code>ä¹Ÿæœ‰<code>requiredDuringSchedulingIgnoredDuringExecution</code>å’Œ <code>preferredDuringSchedulingIgnoredDuringExecution</code>ä¸¤ç§è°ƒåº¦ç­–ç•¥ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯å¦‚æœè¦ä½¿ç”¨äº’æ–¥æ€§ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨<code>podAntiAffinity</code>å­—æ®µã€‚ å¦‚ä¸‹ä¾‹å­ï¼Œæˆ‘ä»¬å¸Œæœ›<code>with-pod-affinity</code>å’Œ<code>busybox-pod</code>èƒ½å¤Ÿå°±è¿‘éƒ¨ç½²ï¼Œè€Œä¸å¸Œæœ›å’Œ<code>node-affinity-pod</code>éƒ¨ç½²åœ¨åŒä¸€ä¸ªæ‹“æ‰‘åŸŸä¸‹é¢ï¼šï¼ˆ<strong>test-pod-affinity.yaml</strong>ï¼‰</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">with-pod-affinity</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">pod-affinity-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">with-pod-affinity</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">podAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">busybox-pod</span></span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">    <span class="attr">podAntiAffinity:</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">podAffinityTerm:</span></span><br><span class="line">          <span class="attr">labelSelector:</span></span><br><span class="line">            <span class="attr">matchExpressions:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">              <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">              <span class="attr">values:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">node-affinity-pod</span></span><br><span class="line">          <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­çš„ POD éœ€è¦è°ƒåº¦åˆ°æŸä¸ªæŒ‡å®šçš„ä¸»æœºä¸Šï¼Œè‡³å°‘æœ‰ä¸€ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œäº†è¿™æ ·çš„ PODï¼šè¿™ä¸ª POD æœ‰ä¸€ä¸ª<code>app=busybox-pod</code>çš„ labelã€‚<code>podAntiAffinity</code>åˆ™æ˜¯å¸Œæœ›æœ€å¥½ä¸è¦è°ƒåº¦åˆ°è¿™æ ·çš„èŠ‚ç‚¹ï¼šè¿™ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œäº†æŸä¸ª PODï¼Œè€Œè¿™ä¸ª POD æœ‰<code>app=node-affinity-pod</code>çš„ labelã€‚</p><blockquote><p><font color="red">æ³¨æ„ï¼Œè¿™é‡ŒåŒ¹é…çš„æ˜¯Podçš„æ ‡ç­¾  ä¸æ˜¯ä¸»æœºçš„æ ‡ç­¾</font></p></blockquote><p>äº²å’Œæ€§/åäº²å’Œæ€§è°ƒåº¦ç­–ç•¥æ¯”è¾ƒå¦‚ä¸‹ï¼š</p><table><thead><tr><th align="left">è°ƒåº¦ç­–ç•¥</th><th align="left">åŒ¹é…æ ‡ç­¾</th><th align="left">æ“ä½œç¬¦</th><th align="left">æ‹“æ‰‘åŸŸæ”¯æŒ</th><th align="left">è°ƒåº¦ç›®æ ‡</th></tr></thead><tbody><tr><td align="left">nodeAffinity</td><td align="left"><strong>ä¸»æœº</strong></td><td align="left">In, NotIn, Exists, DoesNotExist, Gt, Lt</td><td align="left">å¦</td><td align="left">æŒ‡å®šä¸»æœº</td></tr><tr><td align="left">podAffinity</td><td align="left"><strong>POD</strong></td><td align="left">In, NotIn, Exists, DoesNotExist</td><td align="left">æ˜¯</td><td align="left">PODä¸æŒ‡å®šPODåŒä¸€æ‹“æ‰‘åŸŸ</td></tr><tr><td align="left">podAnitAffinity</td><td align="left"><strong>POD</strong></td><td align="left">In, NotIn, Exists, DoesNotExist</td><td align="left">æ˜¯</td><td align="left">PODä¸æŒ‡å®šPODä¸åœ¨åŒä¸€æ‹“æ‰‘åŸŸ</td></tr></tbody></table><h3 id="æ±¡ç‚¹ï¼ˆTaintsï¼‰ä¸å®¹å¿ï¼ˆtolerationsï¼‰"><a href="#æ±¡ç‚¹ï¼ˆTaintsï¼‰ä¸å®¹å¿ï¼ˆtolerationsï¼‰" class="headerlink" title="æ±¡ç‚¹ï¼ˆTaintsï¼‰ä¸å®¹å¿ï¼ˆtolerationsï¼‰"></a>æ±¡ç‚¹ï¼ˆTaintsï¼‰ä¸å®¹å¿ï¼ˆtolerationsï¼‰</h3><p>å¯¹äº<code>nodeAffinity</code>æ— è®ºæ˜¯ç¡¬ç­–ç•¥è¿˜æ˜¯è½¯ç­–ç•¥æ–¹å¼ï¼Œéƒ½æ˜¯è°ƒåº¦ POD åˆ°é¢„æœŸèŠ‚ç‚¹ä¸Šï¼Œ<strong>è€Œ<code>Taints</code>æ°å¥½ä¸ä¹‹ç›¸åï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ ‡è®°ä¸º Taints ï¼Œé™¤é POD ä¹Ÿè¢«æ ‡è¯†ä¸ºå¯ä»¥å®¹å¿æ±¡ç‚¹èŠ‚ç‚¹ï¼Œå¦åˆ™è¯¥ Taints èŠ‚ç‚¹ä¸ä¼šè¢«è°ƒåº¦podã€‚</strong></p><p>æ±¡ç‚¹taintsæ˜¯å®šä¹‰åœ¨èŠ‚ç‚¹ä¸Šçš„é”®å€¼å‹å±æ€§æ•°æ®ï¼Œç”¨äºè®©èŠ‚ç‚¹æ‹’ç»å°† Pod è°ƒåº¦è¿è¡Œäºå…¶ä¸Šï¼Œ é™¤é Pod æœ‰æ¥çº³èŠ‚ç‚¹æ±¡ç‚¹çš„å®¹å¿åº¦å®¹å¿åº¦ tolerations æ˜¯å®šä¹‰åœ¨ Pod ä¸Šçš„é”®å€¼å±æ€§æ•°æ®ï¼Œ ç”¨äºé…ç½®å¯å®¹å¿çš„æ±¡ç‚¹ï¼Œä¸”è°ƒåº¦å™¨å°† Pod è°ƒåº¦è‡³å…¶èƒ½å®¹å¿è¯¥èŠ‚ç‚¹æ±¡ç‚¹çš„èŠ‚ç‚¹ä¸Šæˆ–æ²¡æœ‰æ±¡ç‚¹çš„èŠ‚ç‚¹ä¸Šã€‚</p><p><strong>æ±¡ç‚¹æ˜¯èŠ‚ç‚¹çš„å±æ€§ï¼Œè€Œå®¹å¿æ±¡ç‚¹æ˜¯Podçš„å±æ€§ã€‚</strong></p><p>æ¯”å¦‚ç”¨æˆ·å¸Œæœ›æŠŠ Master èŠ‚ç‚¹ä¿ç•™ç»™ Kubernetes ç³»ç»Ÿç»„ä»¶ä½¿ç”¨ï¼Œæˆ–è€…æŠŠä¸€ç»„å…·æœ‰ç‰¹æ®Šèµ„æºé¢„ç•™ç»™æŸäº› PODï¼Œåˆ™æ±¡ç‚¹å°±å¾ˆæœ‰ç”¨äº†ï¼ŒPOD ä¸ä¼šå†è¢«è°ƒåº¦åˆ° taint æ ‡è®°è¿‡çš„èŠ‚ç‚¹ã€‚</p><h4 id="å®šä¹‰æ±¡ç‚¹å’Œå®¹å¿åº¦"><a href="#å®šä¹‰æ±¡ç‚¹å’Œå®¹å¿åº¦" class="headerlink" title="å®šä¹‰æ±¡ç‚¹å’Œå®¹å¿åº¦"></a>å®šä¹‰æ±¡ç‚¹å’Œå®¹å¿åº¦</h4><p>æ±¡ç‚¹å®šä¹‰äº<code>nodes.spec.taints</code>å®¹å¿åº¦å®šä¹‰äº<code>pods.spec.tolerations</code> </p><p><strong>è¯­æ³•ï¼š key=value:effect</strong></p><h4 id="effectå®šä¹‰æ’æ–¥ç­‰çº§"><a href="#effectå®šä¹‰æ’æ–¥ç­‰çº§" class="headerlink" title="effectå®šä¹‰æ’æ–¥ç­‰çº§"></a>effectå®šä¹‰æ’æ–¥ç­‰çº§</h4><p>effect å…±æœ‰ä¸‰ä¸ªå¯é€‰é¡¹ï¼Œå¯æŒ‰å®é™…éœ€æ±‚è¿›è¡Œè®¾ç½®ï¼š</p><ol><li><code>NoSchedule</code>ï¼šä¸èƒ½å®¹å¿ï¼Œä½†ä»…å½±å“è°ƒåº¦è¿‡ç¨‹ï¼Œå·²è°ƒåº¦ä¸Šå»çš„ pod ä¸å—å½±å“ï¼Œä»…å¯¹æ–°å¢åŠ çš„pod ç”Ÿæ•ˆã€‚ </li><li><code>PreferNoSchedule</code>ï¼šæŸ”æ€§çº¦æŸï¼ŒèŠ‚ç‚¹ç°å­˜ Podä¸å—å½±å“ï¼Œå¦‚æœå®åœ¨æ˜¯æ²¡æœ‰ç¬¦åˆçš„èŠ‚ç‚¹ï¼Œä¹Ÿ å¯ä»¥è°ƒåº¦ä¸Šæ¥</li><li><code>NoExecute</code>ï¼šè¯¥é€‰é¡¹æ„å‘³ç€ä¸€æ—¦ Taint ç”Ÿæ•ˆï¼Œå¦‚è¯¥èŠ‚ç‚¹å†…æ­£åœ¨è¿è¡Œçš„ POD æ²¡æœ‰å¯¹åº” Tolerate(å®¹å¿æ±¡ç‚¹) è®¾ç½®ï¼Œä¼šç›´æ¥è¢«é€å‡ºã€‚</li></ol><h4 id="Podå®šä¹‰å®¹å¿åº¦"><a href="#Podå®šä¹‰å®¹å¿åº¦" class="headerlink" title="Podå®šä¹‰å®¹å¿åº¦"></a>Podå®šä¹‰å®¹å¿åº¦</h4><blockquote><ul><li><p>ç­‰å€¼æ¯”è¾ƒå®¹å¿åº¦ä¸æ±¡ç‚¹åœ¨ keyã€valueã€effect ä¸‰è€…å®Œå…¨åŒ¹é… </p></li><li><p>å­˜åœ¨æ€§åˆ¤æ–­ keyã€effect å®Œå…¨åŒ¹é…ï¼Œvalue ä½¿ç”¨ç©ºå€¼ </p></li></ul><p><font color="red">ä¸€ä¸ªèŠ‚ç‚¹å¯é…ç½®å¤šä¸ªæ±¡ç‚¹ï¼Œä¸€ä¸ª Pod ä¹Ÿå¯æœ‰å¤šä¸ªå®¹å¿åº¦</font></p></blockquote><p>å¦‚æœä»ç„¶å¸Œæœ›æŸä¸ª POD è°ƒåº¦åˆ° taint èŠ‚ç‚¹ä¸Šï¼Œåˆ™å¿…é¡»åœ¨ Spec ä¸­åšå‡º<code>Toleration</code>å®šä¹‰ï¼Œæ‰èƒ½è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ï¼Œä¸¾ä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;your key&quot;</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;your value&quot;</span></span><br><span class="line">    <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br></pre></td></tr></table></figure><h4 id="èŠ‚ç‚¹ç®¡ç†æ±¡ç‚¹"><a href="#èŠ‚ç‚¹ç®¡ç†æ±¡ç‚¹" class="headerlink" title="èŠ‚ç‚¹ç®¡ç†æ±¡ç‚¹"></a>èŠ‚ç‚¹ç®¡ç†æ±¡ç‚¹</h4><blockquote><p><strong>åŒä¸€ä¸ªé”®å€¼æ•°æ®ï¼Œeffect ä¸åŒï¼Œä¹Ÿå±äºä¸åŒçš„æ±¡ç‚¹</strong></p><p>å‡å¦‚èŠ‚ç‚¹node2æœ‰ï¼š</p><ul><li>w1=v1:NoSchedule</li><li>s2=v2:NoSchedule</li><li>w1=v1:NoExecute</li></ul><p>åˆ™èŠ‚ç‚¹æœ‰ä¸‰ä¸ªæ±¡ç‚¹ã€‚</p></blockquote><p>ç»™èŠ‚ç‚¹æ·»åŠ æ±¡ç‚¹ï¼š</p><p><code>kubectl taint node &lt;node-name&gt; &lt;key&gt;=&lt;value&gt;:&lt;effect&gt; </code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸¾ä¾‹ k,véšä¾¿èµ·</span></span><br><span class="line">$ kubectl taint node kube-node1 node-type=production:NoShedule</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹èŠ‚ç‚¹æ±¡ç‚¹:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes &lt;nodename&gt; -o go-template=&#123;&#123;.spec.taints&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸å»ºè®®ï¼Œåªèƒ½è¾“å‡ºä¸€è¡Œï¼Œå±•ç¤ºä¸å…¨</span></span><br><span class="line">$ kubectl describe nodes &lt;nodename&gt; | grep Taint</span><br></pre></td></tr></table></figure><p>åˆ é™¤èŠ‚ç‚¹æ±¡ç‚¹ï¼š</p><p><strong>è¯­æ³•ï¼š</strong><code>kubectl taint node &lt;node-name&gt;&lt;key&gt;[:&lt;effect&gt;]-</code></p><p>åˆ é™¤ key ä¸º node-typeï¼Œeffect ä¸º NoSchedule çš„æ±¡ç‚¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl taint node kube-node1 node-type:NoSchedule-</span><br></pre></td></tr></table></figure><p>åˆ é™¤ key ä¸º node-type çš„æ‰€æœ‰æ±¡ç‚¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl taint node kube-node1 node-type-</span><br></pre></td></tr></table></figure><p>åˆ é™¤æ‰€æœ‰æ±¡ç‚¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl patch nodes &lt;node-name&gt; -p <span class="string">&#x27;&#123;&quot;spec&quot;:&#123;&quot;taints&quot;:[]&#125;&#125;&#x27;</span> </span><br></pre></td></tr></table></figure><h4 id="åœºæ™¯"><a href="#åœºæ™¯" class="headerlink" title="åœºæ™¯"></a>åœºæ™¯</h4><p>æ±¡ç‚¹ç”¨äºï¼š</p><ol><li>ä¸“ç”¨èŠ‚ç‚¹</li><li>é…ç½®ç‰¹åˆ«ç¡¬ä»¶çš„èŠ‚ç‚¹</li><li>åŸºäºTainté©±é€Pod</li></ol><h2 id="PodæŸ¥çœ‹å¸¸ç”¨å‘½ä»¤ğŸ”º"><a href="#PodæŸ¥çœ‹å¸¸ç”¨å‘½ä»¤ğŸ”º" class="headerlink" title="PodæŸ¥çœ‹å¸¸ç”¨å‘½ä»¤ğŸ”º"></a>PodæŸ¥çœ‹å¸¸ç”¨å‘½ä»¤ğŸ”º</h2><p>æŸ¥çœ‹Podåˆ†é…çš„èŠ‚ç‚¹å’ŒIP</p><p><code>kubectl get pods -o wide</code></p><h2 id="æœ‰çŠ¶æ€ä¸æ— çŠ¶æ€PodğŸ”º"><a href="#æœ‰çŠ¶æ€ä¸æ— çŠ¶æ€PodğŸ”º" class="headerlink" title="æœ‰çŠ¶æ€ä¸æ— çŠ¶æ€PodğŸ”º"></a>æœ‰çŠ¶æ€ä¸æ— çŠ¶æ€PodğŸ”º</h2><p><strong>æ— çŠ¶æ€åº”ç”¨ï¼ˆStateless Applicationï¼‰</strong>æ˜¯æŒ‡åº”ç”¨ä¸ä¼šåœ¨ä¼šè¯ä¸­ä¿å­˜ä¸‹æ¬¡ä¼šè¯æ‰€éœ€è¦çš„å®¢æˆ·ç«¯æ•°æ®ã€‚æ¯ä¸€ä¸ªä¼šè¯éƒ½åƒé¦–æ¬¡æ‰§è¡Œä¸€æ ·ï¼Œä¸ä¼šä¾èµ–ä¹‹å‰çš„æ•°æ®è¿›è¡Œå“åº”ã€‚<strong>æœ‰çŠ¶æ€çš„åº”ç”¨ï¼ˆStateful Applicationï¼‰</strong>æ˜¯æŒ‡åº”ç”¨ä¼šåœ¨ä¼šè¯ä¸­ä¿å­˜å®¢æˆ·ç«¯çš„æ•°æ®ï¼Œå¹¶åœ¨å®¢æˆ·ç«¯ä¸‹ä¸€æ¬¡çš„è¯·æ±‚ä¸­æ¥ä½¿ç”¨é‚£äº›æ•°æ®ã€‚</p><h3 id="æ— çŠ¶æ€"><a href="#æ— çŠ¶æ€" class="headerlink" title="æ— çŠ¶æ€"></a>æ— çŠ¶æ€</h3><p>æ˜¯æŒ‡è¯¥æœåŠ¡è¿è¡Œçš„å®ä¾‹ä¸ä¼šåœ¨æœ¬åœ°å­˜å‚¨éœ€è¦æŒä¹…åŒ–çš„æ•°æ®ï¼Œå¹¶ä¸”å¤šä¸ªå®ä¾‹å¯¹äºåŒä¸€ä¸ªè¯·æ±‚å“åº”çš„ç»“æœæ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚</p><p>å¤šä¸ªå®ä¾‹å¯ä»¥å…±äº«ç›¸åŒçš„æŒä¹…åŒ–æ•°æ®ã€‚ä¾‹å¦‚ï¼šnginxå®ä¾‹ï¼Œtomcatå®ä¾‹ç­‰</p><p>ç›¸å…³çš„k8sèµ„æºæœ‰ï¼šReplicaSetã€ReplicationControllerã€Deploymentç­‰ï¼Œç”±äºæ˜¯æ— çŠ¶æ€æœåŠ¡ï¼Œæ‰€ä»¥è¿™äº›æ§åˆ¶å™¨åˆ›å»ºçš„podåºå·éƒ½æ˜¯éšæœºå€¼ã€‚å¹¶ä¸”åœ¨ç¼©å®¹çš„æ—¶å€™å¹¶ä¸ä¼šæ˜ç¡®ç¼©å®¹æŸä¸€ä¸ªpodï¼Œè€Œæ˜¯éšæœºçš„ï¼Œå› ä¸ºæ‰€æœ‰å®ä¾‹å¾—åˆ°çš„è¿”å›å€¼éƒ½æ˜¯ä¸€æ ·ï¼Œæ‰€ä»¥ç¼©å®¹ä»»ä½•ä¸€ä¸ªpodéƒ½å¯ä»¥ã€‚</p><blockquote><p>æ€»ç»“</p><ol><li>Podéƒ½ä¸€æ ·ï¼Œå¯¹äºåŒä¸€ä¸ªè¯·æ±‚å“åº”çš„ç»“æœæ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚</li><li>Podä¹‹é—´æ²¡æœ‰å¯åŠ¨é¡ºåº</li><li>Podä¸ç”¨è€ƒè™‘åœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Šå¯åŠ¨</li><li>éšæ„æ‰©å®¹å’Œä¼¸ç¼©</li></ol></blockquote><h3 id="æœ‰çŠ¶æ€"><a href="#æœ‰çŠ¶æ€" class="headerlink" title="æœ‰çŠ¶æ€"></a>æœ‰çŠ¶æ€</h3><p>ä¸Šé¢æ— çŠ¶æ€çš„æ€»ç»“éƒ½éœ€è¦è€ƒè™‘åˆ°ã€‚æœ‰çŠ¶æ€çš„Podå¾ˆéœ€è¦æ•°æ®å·ï¼ŒPodä¹‹é—´æ˜¯ä¸åŒçš„æ¯ä¸ªPodä¸åŒçš„Ipé‡Œé¢å­˜å‚¨çš„èµ„æºä¹Ÿä¸å°½ç›¸åŒï¼Œä¹Ÿæœ‰å¯åŠ¨é¡ºåºçš„éœ€è¦ï¼Œä¾‹å¦‚Mysqlä¸»ä»Podï¼Œè‚¯å®šå…ˆä¸»åä»å¯åŠ¨ã€‚</p><p>å½“Podåˆ†é…Nodeæ‰§è¡Œæ—¶ï¼Œå¦‚æœNodeä¸Šæ²¡æœ‰ä¹‹å‰çš„æ•°æ®å·ï¼Œåˆ™ä¸è¡Œï¼Œè¦åœ¨ä¹‹å‰çš„Nodeä¸Šè¿è¡ŒPodåˆæˆ–è€…æœ‰å…±äº«å­˜å‚¨å·ã€‚</p><p>StatefulSet ç¼©å®¹ä»»ä½•æ—¶å€™åªä¼šæ“ä½œ ä¸€ä¸ª pod å®ä¾‹ï¼Œæ‰€ä»¥æœ‰çŠ¶æ€åº”ç”¨çš„ç¼©å®¹ä¸ä¼šå¾ˆè¿…é€Ÿã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œ ä¸€ä¸ªåˆ†å¸ƒå¼å­˜å‚¨åº”ç”¨è‹¥åŒæ—¶ä¸‹çº¿å¤šä¸ªèŠ‚ç‚¹ ï¼Œåˆ™å¯èƒ½å¯¼è‡´å…¶æ•°æ®ä¸¢å¤± ã€‚ æ¯”å¦‚è¯´ä¸€ä¸ªæ•°æ®é¡¹å‰¯æœ¬æ•°è®¾ç½®ä¸º 2 çš„æ•°æ®å­˜å‚¨åº”ç”¨ï¼Œ è‹¥ åŒæ—¶æœ‰ä¸¤ä¸ªèŠ‚ç‚¹ä¸‹çº¿ï¼Œä¸€ä»½æ•°æ®è®°å½•å°±ä¼šä¸¢å¤±ï¼Œå¦‚æœå®ƒæ­£å¥½ä¿å­˜åœ¨è¿™ä¸¤ä¸ªèŠ‚ç‚¹ä¸Š ã€‚ è‹¥ç¼©å®¹æ˜¯çº¿æ€§çš„ ï¼Œåˆ™åˆ†å¸ƒå¼å­˜å‚¨åº”ç”¨å°±æœ‰æ—¶é—´æŠŠä¸¢å¤±çš„å‰¯æœ¬å¤åˆ¶åˆ°å…¶ä»–èŠ‚ç‚¹ ï¼Œä¿è¯æ•°æ®ä¸ä¼šä¸¢å¤±ã€‚</p><h1 id="Label"><a href="#Label" class="headerlink" title="Label"></a>Label</h1><h2 id="Label-æ¦‚è¿°"><a href="#Label-æ¦‚è¿°" class="headerlink" title="Label æ¦‚è¿°"></a><strong>Label æ¦‚è¿°</strong></h2><p>Label æ˜¯ Kubernetes ç³»ç»Ÿä¸­å¦ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‚ä¸€ä¸ª Label æ˜¯ä¸€ä¸ª key=value çš„é”®å€¼å¯¹ï¼Œå…¶ä¸­ key ä¸ value ç”±ç”¨æˆ·è‡ªå·±æŒ‡ å®šã€‚Label å¯ä»¥é™„åŠ åˆ°å„ç§èµ„æºå¯¹è±¡ä¸Šï¼Œå¦‚ Nodeã€Podã€Serviceã€RCï¼Œä¸€ä¸ªèµ„æºå¯¹è±¡å¯ä»¥å®šä¹‰ä»»æ„æ•°é‡çš„ Labelï¼Œ åŒä¸€ä¸ª Label ä¹Ÿå¯ä»¥è¢«æ·»åŠ åˆ°ä»»æ„æ•°é‡çš„èµ„æºå¯¹è±¡ä¸Šï¼ŒLabel é€šå¸¸åœ¨èµ„æºå¯¹è±¡å®šä¹‰æ—¶ç¡®å®šï¼Œä¹Ÿå¯ä»¥åœ¨å¯¹è±¡åˆ›å»ºååŠ¨æ€æ·»åŠ æˆ–åˆ é™¤ã€‚ </p><p>Label çš„æœ€å¸¸è§çš„ç”¨æ³•æ˜¯ä½¿ç”¨ metadata.labels å­—æ®µï¼Œæ¥ä¸ºå¯¹è±¡æ·»åŠ  Labelï¼Œé€šè¿‡spec.selector æ¥å¼•ç”¨å¯¹è±¡ ã€‚</p><p>Label é™„åŠ åˆ° Kubernetes é›†ç¾¤ä¸­å„ç§èµ„æºå¯¹è±¡ä¸Šï¼Œç›®çš„å°±æ˜¯å¯¹è¿™äº›èµ„æºå¯¹è±¡è¿›è¡Œåˆ†ç»„ç®¡ç†ï¼Œè€Œåˆ†ç»„ç®¡ç†çš„æ ¸å¿ƒå°±æ˜¯ Label Selectorã€‚Label ä¸ Label Selector éƒ½æ˜¯ä¸èƒ½å•ç‹¬å®šä¹‰ï¼Œå¿…é¡»é™„åŠ åœ¨ä¸€äº›èµ„æºå¯¹è±¡çš„å®šä¹‰æ–‡ä»¶ä¸Šï¼Œä¸€èˆ¬é™„åŠ  åœ¨ RC å’Œ Service çš„èµ„æºå®šä¹‰æ–‡ä»¶ä¸­ã€‚</p><h1 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h1><h2 id="æ¦‚è¿°-1"><a href="#æ¦‚è¿°-1" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>Controlleræ˜¯åœ¨é›†ç¾¤ä¸Šç®¡ç†å’Œè¿è¡Œå®¹å™¨çš„å¯¹è±¡ã€‚</p><p><strong>1.Podä¸Controllerçš„å…³ç³»</strong></p><p>Podæ˜¯é€šè¿‡Controller<strong>å®ç°åº”ç”¨çš„è¿ç»´ï¼Œæ¯”å¦‚ä¼¸ç¼©ã€æ»šåŠ¨å‡çº§ç­‰ç­‰</strong>ã€‚</p><p>Podå’Œ Controllerä¹‹é—´é€šè¿‡labelæ ‡ç­¾å’Œselectoré€‰æ‹©å™¨å»ºç«‹å…³ç³»</p><blockquote><p>æ§åˆ¶å™¨æœ‰ï¼š</p><ol><li><strong>Replication Controller</strong></li><li><strong>Replica Set</strong></li><li><strong>Deployment</strong></li><li><strong>Horizontal Pod Autoscaler</strong></li></ol></blockquote><blockquote><p><strong>æ³¨æ„</strong></p><p><strong>Replication Controller</strong>ã€<strong>Replica Set</strong>ã€<strong>Deployment</strong>éƒ½æ˜¯æ— çŠ¶æ€çš„Podçš„æ§åˆ¶å™¨ã€‚</p><p>statefulSetæ˜¯æœ‰çŠ¶æ€çš„Podçš„æ§åˆ¶å™¨ã€‚</p></blockquote><h2 id="æ— çŠ¶æ€Podæ§åˆ¶å™¨"><a href="#æ— çŠ¶æ€Podæ§åˆ¶å™¨" class="headerlink" title="æ— çŠ¶æ€Podæ§åˆ¶å™¨"></a>æ— çŠ¶æ€Podæ§åˆ¶å™¨</h2><h3 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h3><p>Deploymentæ˜¯ä¸€ç§å¸¸ç”¨çš„Controllerã€‚</p><p>Deployment æ˜¯ Kubenetes v1.2 å¼•å…¥çš„æ–°æ¦‚å¿µï¼Œå¼•å…¥çš„ç›®çš„æ˜¯ä¸ºäº†æ›´å¥½çš„è§£å†³ Pod çš„ç¼–æ’é—®é¢˜ï¼ŒDeployment å†…éƒ¨ä½¿ç”¨äº† Replica Set æ¥å®ç°ã€‚</p><h4 id="åº”ç”¨åœºæ™¯"><a href="#åº”ç”¨åœºæ™¯" class="headerlink" title="åº”ç”¨åœºæ™¯"></a><strong>åº”ç”¨åœºæ™¯</strong></h4><ul><li>éƒ¨ç½²æ— çŠ¶æ€åº”ç”¨(webã€å¾®æœåŠ¡)</li><li>ç®¡ç†Podå’ŒReplicaSet(Podå‰¯æœ¬)</li><li>éƒ¨ç½²ã€æ»šåŠ¨å‡çº§ç­‰åŠŸèƒ½</li></ul><h4 id="Deploymentéƒ¨ç½²åº”ç”¨"><a href="#Deploymentéƒ¨ç½²åº”ç”¨" class="headerlink" title="Deploymentéƒ¨ç½²åº”ç”¨"></a>Deploymentéƒ¨ç½²åº”ç”¨</h4><p><strong>1.ä½¿ç”¨yamlæ–‡ä»¶éƒ¨ç½²ï¼Œé¦–å…ˆå¯¼å‡ºyamlæ¨¡æ¿</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create deployment web --image=nginx --dry-run=client -o yaml &gt; web.yaml</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¯´åˆ°Podå’Œ Controllerä¹‹é—´é€šè¿‡labelæ ‡ç­¾å’Œselectoré€‰æ‹©å™¨å»ºç«‹å…³ç³»ï¼Œä¸‹å›¾è¯æ˜äº†ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201123165244192.png" alt="image-20201123165244192"></p><p><strong>2.ä½¿ç”¨yamlæ–‡ä»¶éƒ¨ç½²</strong></p><p><strong>åˆ›å»ºçš„æ˜¯pod</strong>ï¼Œé€šè¿‡web.yamlçš„å†…å®¹å¾—çŸ¥ï¼Œè¯¦ç»†è¯·çœ‹ä¸‹å›¾</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f web.yaml</span><br></pre></td></tr></table></figure><p><strong>3.å¯¹å¤–å‘å¸ƒ(æš´éœ²å¯¹å¤–ç«¯å£)</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl expose deployment web --port 80 --<span class="built_in">type</span>=NodePort --target-port=80 --name=web1 -o yaml &gt; web1.yaml</span><br></pre></td></tr></table></figure><blockquote><p>å°†èµ„æºæš´éœ²ä¸º<font color="red"><strong>æ–°çš„Kubernetes Serviceã€‚</strong></font></p><p>æŒ‡å®š<code>deployment</code>ã€<code>service</code>ã€<code>replica set</code>ã€<code>replication controller</code>æˆ–<code>pod</code>ï¼Œå¹¶ä½¿ç”¨è¯¥èµ„æºçš„é€‰æ‹©å™¨ä½œä¸ºæŒ‡å®šç«¯å£ä¸Šæ–°æœåŠ¡çš„é€‰æ‹©å™¨ã€‚<strong>deployment æˆ– replica setåªæœ‰å½“å…¶é€‰æ‹©å™¨å¯è½¬æ¢ä¸ºserviceæ”¯æŒçš„é€‰æ‹©å™¨æ—¶ï¼Œå³å½“é€‰æ‹©å™¨ä»…åŒ…å«matchLabelsç»„ä»¶æ—¶æ‰ä¼šä½œä¸ºæš´éœ²æ–°çš„Serviceã€‚</strong></p><ul><li>â€“portï¼šèµ„æºçš„ç«¯å£ï¼ˆè¿™é‡Œæ˜¯deploymentçš„ç«¯å£ï¼‰</li><li>â€“target-portï¼šå®¹å™¨çš„ç«¯å£</li><li>â€“typeï¼šType for this service: ClusterIP, NodePort, or LoadBalancer. Default is â€˜ClusterIPâ€™.(è¯¥æœåŠ¡çš„ç±»å‹ï¼šClusterIPï¼ŒNodePortæˆ–LoadBalancerã€‚é»˜è®¤å€¼ä¸ºâ€œ ClusterIPâ€)</li></ul><p>å› ä¸ºæˆ‘ä»¬æ˜¯æš´éœ²ç«¯å£ï¼Œæ‰€ä»¥typeé€‰æ‹©NodePort</p></blockquote><p><strong>4.é‡æ–°åº”ç”¨yamlæ–‡ä»¶</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f web1.yaml</span><br></pre></td></tr></table></figure><p><strong>åˆ›å»ºçš„æ˜¯service</strong>ï¼Œå› ä¸º<code>web.yaml</code>ä¸<code>web1.yaml</code>çš„åŒºåˆ«å†…å®¹ä¸ºï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201124114353266.png" alt="image-20201124114353266"></p><blockquote><p>ç”±æ­¤å›¾å¾—çŸ¥ï¼š</p><ul><li>createæ—¶åˆ›å»ºçš„æ˜¯æ‰‹åŠ¨é€‰æ‹©çš„<code>deployment</code>ï¼›è€Œexposeæ—¶ï¼Œæ˜¯åˆ›å»ºäº†<code>Service</code></li><li><code>deployment</code>å’Œ<code>Service</code>éƒ½æ˜¯é€šè¿‡Podä¸Šçš„æ ‡ç­¾iä»¥åŠé€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨æ¥å¯»æ‰¾Pod</li><li><code>Service</code>æœ‰IPå¯ä»¥é€šè¿‡å…¶è®¿é—®åˆ°Podï¼Œç›´æ¥é€šè¿‡Podè®¿é—®å†…å®¹ä¸ç¨³å®šã€‚</li></ul></blockquote><hr><p><strong>ä¸Šè¿°çš„æ­¥éª¤è¾ƒå¤šã€‚å…¶å®ï¼Œæœ€åä½ å‡†å¤‡ä¸€ä¸ªå®Œæ•´çš„yamlï¼Œå°±å¯ä»¥ç›´æ¥éƒ¨ç½²äº†ã€‚</strong></p><h5 id="å‡çº§å›æ»š"><a href="#å‡çº§å›æ»š" class="headerlink" title="å‡çº§å›æ»š"></a>å‡çº§å›æ»š</h5><p><strong>å‡çº§</strong></p><p>å¯¹å·²æœ‰deploymentçš„èµ„æºè¿›è¡Œä»¥ä¸‹æ“ä½œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubactl <span class="built_in">set</span> image deployment xxx nginx=nginx:xxx</span><br></pre></td></tr></table></figure><blockquote><p><strong>å‡çº§è¿‡ç¨‹</strong></p><ol><li>ä¸‹è½½æœ€æ–°é•œåƒ</li><li>è¿è¡Œå®¹å™¨</li><li>å½“æœ€æ–°å®¹å™¨è¿è¡Œå¥½äº†åç›´æ¥æ›¿æ¢æ—§çš„å®¹å™¨</li></ol></blockquote><p>æŸ¥çœ‹åº”ç”¨æ˜¯å¦å‡çº§æˆåŠŸï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl rollout status deployment xxx</span><br></pre></td></tr></table></figure><p><strong>å›æ»š</strong></p><p>å½“é•œåƒæ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬åï¼Œå‘ç°äº†å…¶ä»–é—®é¢˜ï¼Œéœ€è¦å›æ»šåˆ°ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œè¿™ç§åœºæ™¯å¾ˆå¸¸è§ã€‚</p><blockquote><p>æŸ¥çœ‹deploymentå†å²ç‰ˆæœ¬</p><p><code>kubectl rollout history deployment xxx</code></p><p>å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬</p><p><code>kubectl rollout undo deployment xxx</code></p><p>å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬</p><p><code>kubectl rollout undo deployment xxx --to-revision=xx</code></p></blockquote><h5 id="å¼¹æ€§ä¼¸ç¼©"><a href="#å¼¹æ€§ä¼¸ç¼©" class="headerlink" title="å¼¹æ€§ä¼¸ç¼©"></a>å¼¹æ€§ä¼¸ç¼©</h5><p>å½“å‘ç°æµ‹æœåŠ¡çƒ­é—¨ï¼Œå½“å‰èµ„æºä¸å¤Ÿç”¨æ—¶ï¼Œå¯ä»¥æ‰©å±•æœåŠ¡çš„ä¸ªæ•°ï¼š</p><p><code>kubectl scale deployment xxx --replicas=x</code></p><h3 id="Replication-Controller"><a href="#Replication-Controller" class="headerlink" title="Replication Controller"></a>Replication Controller</h3><p>Replication Controller(RC)æ˜¯ Kubernetes ç³»ç»Ÿä¸­æ ¸å¿ƒæ¦‚å¿µä¹‹ä¸€ï¼Œå½“æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª RCå¹¶æäº¤åˆ° Kubernetes é›†ç¾¤ä¸­ä»¥åï¼ŒMaster èŠ‚ç‚¹ä¸Šçš„ Controller Manager ç»„ä»¶å°±å¾—åˆ°é€šçŸ¥ï¼Œå®šæœŸæ£€æŸ¥ç³»ç»Ÿä¸­å­˜æ´»çš„ Pod,å¹¶ç¡®ä¿ç›®æ ‡ Pod å®ä¾‹çš„æ•°é‡åˆšå¥½ç­‰äº RC çš„é¢„æœŸå€¼ï¼Œå¦‚æœæœ‰è¿‡å¤šæˆ–è¿‡å°‘çš„ Pod è¿è¡Œï¼Œç³»ç»Ÿå°±ä¼šåœæ‰æˆ–åˆ›å»ºä¸€äº› Pod.æ­¤å¤–æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹ RC çš„å‰¯æœ¬æ•°é‡ï¼Œæ¥å®ç° Pod çš„åŠ¨æ€ç¼©æ”¾åŠŸèƒ½ã€‚</p><p><code>kubectl scale rc nginx --replicas=5 </code></p><p>ç”±äº Replication Controller ä¸ Kubernetes ä»£ç ä¸­çš„æ¨¡å— Replication Controller åŒåï¼Œ<strong>æ‰€ä»¥åœ¨ Kubernetes v1.2 æ—¶ï¼Œ å®ƒå°±å‡çº§æˆäº†å¦å¤–ä¸€ä¸ªæ–°çš„æ¦‚å¿µ Replica Sets,å®˜æ–¹è§£é‡Šä¸ºä¸‹ä¸€ä»£çš„ RC</strong>ï¼Œå®ƒä¸ RC åŒºåˆ«æ˜¯:Replica Sets æ”¯æ´åŸºäºé›†åˆçš„ Label selector,è€Œ RC åªæ”¯æŒåŸºäºç­‰å¼çš„ Label Selectorã€‚æˆ‘ä»¬å¾ˆå°‘å•ç‹¬ä½¿ç”¨ Replica Set,å®ƒä¸»è¦è¢« Deployment è¿™ä¸ªæ›´é«˜å±‚é¢çš„èµ„æºå¯¹è±¡æ‰€ä½¿ç”¨ï¼Œä»è€Œå½¢æˆä¸€æ•´å¥— Pod åˆ›å»ºã€åˆ é™¤ã€æ›´æ–°çš„ç¼–æ’æœºåˆ¶ã€‚æœ€å¥½ä¸è¦è¶Šè¿‡ RC ç›´æ¥åˆ›å»º Podï¼Œ å› ä¸º Replication Controller ä¼šé€šè¿‡ RC ç®¡ç† Pod å‰¯æœ¬ï¼Œå®ç°è‡ªåŠ¨åˆ›å»ºã€è¡¥è¶³ã€æ›¿æ¢ã€åˆ é™¤ Pod å‰¯æœ¬ï¼Œè¿™æ ·å°±èƒ½æé«˜åº”ç”¨çš„å®¹ç¾èƒ½åŠ›ï¼Œå‡å°‘ç”±äºèŠ‚ç‚¹ å´©æºƒç­‰æ„å¤–çŠ¶å†µé€ æˆçš„æŸå¤±ã€‚å³ä½¿åº”ç”¨ç¨‹åºåªæœ‰ä¸€ä¸ª Pod å‰¯æœ¬ï¼Œä¹Ÿå¼ºçƒˆå»ºè®®ä½¿ç”¨ RC æ¥ å®šä¹‰ Podã€‚</p><h3 id="Replica-Set"><a href="#Replica-Set" class="headerlink" title="Replica Set"></a>Replica Set</h3><p>ReplicaSet è·Ÿ ReplicationController æ²¡æœ‰æœ¬è´¨çš„ä¸åŒï¼Œåªæ˜¯åå­—ä¸ä¸€æ ·ï¼Œ<strong>å¹¶ä¸”ReplicaSet æ”¯æŒé›†åˆå¼çš„ selectorï¼ˆReplicationController ä»…æ”¯æŒç­‰å¼ï¼‰</strong>ã€‚ <font color="red"><strong>Kubernetes å®˜æ–¹å¼ºçƒˆå»ºè®®é¿å…ç›´æ¥ä½¿ç”¨ ReplicaSet</strong></font>ï¼Œè€Œåº”è¯¥é€šè¿‡ Deployment æ¥åˆ›å»º RS å’ŒPodã€‚ç”±äº ReplicaSet æ˜¯ ReplicationController çš„ä»£æ›¿ç‰©ï¼Œå› æ­¤ç”¨æ³•åŸºæœ¬ç›¸åŒï¼Œå”¯ä¸€çš„åŒºåˆ«åœ¨äº ReplicaSet æ”¯æŒé›†åˆå¼çš„ selector</p><hr><h2 id="æœ‰çŠ¶æ€çš„Podçš„æ§åˆ¶å™¨"><a href="#æœ‰çŠ¶æ€çš„Podçš„æ§åˆ¶å™¨" class="headerlink" title="æœ‰çŠ¶æ€çš„Podçš„æ§åˆ¶å™¨"></a>æœ‰çŠ¶æ€çš„Podçš„æ§åˆ¶å™¨</h2><p>æœ‰çŠ¶æ€çš„Podçš„æ§åˆ¶å™¨ä¸ºï¼š<code>StatefulSet</code></p><p>Kubernetesåœ¨1.9ç‰ˆæœ¬ä¸­æ­£å¼å‘å¸ƒçš„StatefulSetæ§åˆ¶å™¨èƒ½æ”¯æŒï¼š</p><ul><li><strong>Podä¼šè¢«é¡ºåºéƒ¨ç½²å’Œé¡ºåºç»ˆç»“</strong>ï¼šStatefulSetä¸­çš„å„ä¸ª Podä¼šè¢«é¡ºåºåœ°åˆ›å»ºå‡ºæ¥ï¼Œæ¯ä¸ªPodéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„IDï¼Œåœ¨åˆ›å»ºåç»­ Pod ä¹‹å‰ï¼Œé¦–å…ˆè¦ç­‰å‰é¢çš„ Pod è¿è¡ŒæˆåŠŸå¹¶è¿›å…¥åˆ°å°±ç»ªçŠ¶æ€ã€‚åˆ é™¤ä¼šé”€æ¯StatefulSet ä¸­çš„æ¯ä¸ª Podï¼Œå¹¶ä¸”æŒ‰ç…§åˆ›å»ºé¡ºåºçš„ååºæ¥æ‰§è¡Œï¼Œåªæœ‰åœ¨æˆåŠŸç»ˆç»“åé¢ä¸€ä¸ªä¹‹åï¼Œæ‰ä¼šç»§ç»­ä¸‹ä¸€ä¸ªåˆ é™¤æ“ä½œã€‚</li><li><strong>Podå…·æœ‰å”¯ä¸€ç½‘ç»œåç§°</strong>ï¼šPodå…·æœ‰å”¯ä¸€çš„åç§°ï¼Œè€Œä¸”åœ¨é‡å¯åä¼šä¿æŒä¸å˜ã€‚é€šè¿‡HeadlessæœåŠ¡ï¼ŒåŸºäºä¸»æœºåï¼Œæ¯ä¸ª Pod éƒ½æœ‰ç‹¬ç«‹çš„ç½‘ç»œåœ°å€ï¼Œè¿™ä¸ªç½‘åŸŸç”±ä¸€ä¸ªHeadless æœåŠ¡æ‰€æ§åˆ¶ã€‚è¿™æ ·æ¯ä¸ªPodä¼šä¿æŒç¨³å®šçš„å”¯ä¸€çš„åŸŸåï¼Œä½¿å¾—é›†ç¾¤å°±ä¸ä¼šå°†é‡æ–°åˆ›å»ºå‡ºçš„Podä½œä¸ºæ–°æˆå‘˜ã€‚</li><li><strong>Podèƒ½æœ‰ç¨³å®šçš„æŒä¹…å­˜å‚¨</strong>ï¼šStatefulSetä¸­çš„æ¯ä¸ªPodå¯ä»¥æœ‰å…¶è‡ªå·±ç‹¬ç«‹çš„PersistentVolumeClaimå¯¹è±¡ã€‚å³ä½¿Podè¢«é‡æ–°è°ƒåº¦åˆ°å…¶å®ƒèŠ‚ç‚¹ä¸Šä»¥åï¼ŒåŸæœ‰çš„æŒä¹…ç£ç›˜ä¹Ÿä¼šè¢«æŒ‚è½½åˆ°è¯¥Podã€‚</li><li><strong>Podèƒ½è¢«é€šè¿‡HeadlessæœåŠ¡è®¿é—®åˆ°</strong>ï¼šå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡æœåŠ¡çš„åŸŸåè¿æ¥åˆ°ä»»æ„Podã€‚</li></ul><p><strong>å”¯ä¸€IDè§„åˆ™ï¼Ÿï¼Ÿ</strong></p><p>é€šè¿‡statefulSetï¼Œç”±äºæ˜¯æœ‰çŠ¶æ€çš„æœåŠ¡ï¼Œæ‰€ä»¥æ¯ä¸ªpodéƒ½æœ‰ç‰¹å®šçš„åç§°å’Œç½‘ç»œæ ‡è¯†ã€‚æ¯”å¦‚podåæ˜¯ç”±statefulSetå+æœ‰åºçš„æ•°å­—ç»„æˆï¼ˆ0ã€1ã€2..ï¼‰</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-02_20-15-50.png" alt="Snipaste_2020-12-02_20-15-50"></p><p>è¿˜å¯ä»¥é€šè¿‡åŸŸåå¯¹Podå½¢æˆ1å¯¹1çš„å…³è”å…³ç³»ï¼Œä¸Šé¢è¯´äº†Podåï¼ˆä¸»æœºåç§°ï¼‰è§„åˆ™ï¼Œä¸‹é¢å”¯ä¸€æ ‡è¯†çš„è§„åˆ™ä¸ºï¼š</p><p><code>ä¸»æœºå.serviceåç§°.åç§°ç©ºé—´.svc.local</code></p><h2 id="ä¸€æ¬¡æ€§ä»»åŠ¡"><a href="#ä¸€æ¬¡æ€§ä»»åŠ¡" class="headerlink" title="ä¸€æ¬¡æ€§ä»»åŠ¡"></a>ä¸€æ¬¡æ€§ä»»åŠ¡</h2><p>Job å…¶å®å°±æ˜¯æ ¹æ®å®šä¹‰èµ·ä¸€ä¸ªæˆ–å¤šä¸ª pod æ¥æ‰§è¡Œä»»åŠ¡ï¼Œpod æ‰§è¡Œå®Œé€€å‡ºåï¼Œè¿™ä¸ª Job å°±å®Œæˆäº†ã€‚æ‰€ä»¥ Job åˆç§°ä¸º Batch Job ï¼Œå³è®¡ç®—ä¸šåŠ¡æˆ–ç¦»çº¿ä¸šåŠ¡ã€‚</p><h3 id="Jobä½¿ç”¨æ–¹æ³•"><a href="#Jobä½¿ç”¨æ–¹æ³•" class="headerlink" title="Jobä½¿ç”¨æ–¹æ³•"></a>Jobä½¿ç”¨æ–¹æ³•</h3><p>Job çš„ YAML å®šä¹‰ä¸ Deployment ååˆ†ç›¸ä¼¼ã€‚ä¸ Deployment ä¸åŒçš„æ˜¯ï¼ŒJob ä¸éœ€è¦å®šä¹‰ <code>spec.selector</code> æ¥æŒ‡å®šéœ€è¦æ§åˆ¶çš„ podï¼Œçœ‹ä¸ªä¾‹å­ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">date</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pi</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">perl</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;perl&quot;</span>, <span class="string">&quot;-Mbignum=bpi&quot;</span>, <span class="string">&quot;-wle&quot;</span>, <span class="string">&quot;print bpi(2000)&quot;</span>]</span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬è®¡ç®—äº†Piçš„å€¼ã€‚</p><p><strong>1. å¯åŠ¨Job</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f job.yaml</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201203192035404.png" alt="image-20201203192035404"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201203192057237.png" alt="image-20201203192057237"></p><p><strong>2. æŸ¥çœ‹ç»“æœ</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201203192136897.png" alt="image-20201203192136897"></p><p>pod åœ¨æ‰§è¡Œå®Œæ¯•åï¼ŒçŠ¶æ€ä¼šå˜æˆ <code>Completed</code></p><blockquote><h3 id="pod-é‡å¯ç­–ç•¥"><a href="#pod-é‡å¯ç­–ç•¥" class="headerlink" title="pod é‡å¯ç­–ç•¥"></a>pod é‡å¯ç­–ç•¥</h3><p>åœ¨ Job ä¸­ï¼Œpod çš„é‡å¯ç­–ç•¥ restartPolicy ä¸å…è®¸è¢«è®¾ç½®æˆ Alwaysï¼Œåªå…è®¸è¢«è®¾ç½®ä¸º Never æˆ– OnFailureã€‚è¿™æ˜¯å› ä¸º Job çš„ pod æ‰§è¡Œå®Œæ¯•åç›´æ¥é€€å‡ºï¼Œå¦‚æœ restartPolicy=Alwaysï¼Œpod å°†ä¸æ–­æ‰§è¡Œè®¡ç®—ä½œä¸šï¼Œè¿™å¯ä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„ã€‚</p><p>Job å¯ä»¥è®¾ç½® pod çš„æœ€é•¿è¿è¡Œæ—¶é—´ spec.activeDeadlineSecondsï¼Œä¸€æ—¦è¶…è¿‡äº†è¿™ä¸ªæ—¶é—´ï¼Œè¿™ä¸ª Job çš„æ‰€æœ‰ pod éƒ½ä¼šè¢«ç»ˆæ­¢ã€‚</p><p>é‚£ä¹ˆï¼Œå¦‚æœ pod çš„è®¡ç®—ä½œä¸šå¤±è´¥äº†ï¼Œåœ¨ä¸åŒçš„é‡å¯ç­–ç•¥ä¸‹ä¼šæ€ä¹ˆåŠï¼Ÿ</p><h4 id="restartPolicy-Never"><a href="#restartPolicy-Never" class="headerlink" title="restartPolicy=Never"></a>restartPolicy=Never</h4><p>å¦‚æœè®¾ç½®äº† restartPolicy=Neverï¼Œé‚£ä¹ˆ Job Controller ä¼šä¸æ–­çš„å°è¯•åˆ›å»ºä¸€ä¸ªæ–°çš„ pod å‡ºæ¥ï¼Œé»˜è®¤å°è¯• 6 æ¬¡ã€‚å½“ç„¶è¿™ä¸ªå€¼å¯ä»¥è®¾ç½®ï¼Œå³ Job å¯¹è±¡çš„ spec.backoffLimit å­—æ®µã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé‡æ–°åˆ›å»º Pod çš„é—´éš”æ˜¯å‘ˆæŒ‡æ•°å¢åŠ çš„ã€‚</p><h4 id="restartPolicy-OnFailure"><a href="#restartPolicy-OnFailure" class="headerlink" title="restartPolicy=OnFailure"></a>restartPolicy=OnFailure</h4><p>å¦‚æœè®¾ç½®äº† restartPolicy=Neverï¼Œé‚£ä¹ˆ Job Controller ä¼šä¸æ–­çš„é‡å¯è¿™ä¸ª podã€‚</p></blockquote><h2 id="å®šæ—¶ä»»åŠ¡"><a href="#å®šæ—¶ä»»åŠ¡" class="headerlink" title="å®šæ—¶ä»»åŠ¡"></a>å®šæ—¶ä»»åŠ¡</h2><p>ä½ å¯ä»¥åˆ©ç”¨ CronJobs æ‰§è¡ŒåŸºäºæ—¶é—´è°ƒåº¦çš„ä»»åŠ¡ã€‚è¿™äº›è‡ªåŠ¨åŒ–ä»»åŠ¡å’Œ Linux æˆ–è€… Unix ç³»ç»Ÿçš„ Cron ä»»åŠ¡ç±»ä¼¼ã€‚</p><p>CronJobs åœ¨åˆ›å»ºå‘¨æœŸæ€§ä»¥åŠé‡å¤æ€§çš„ä»»åŠ¡æ—¶å¾ˆæœ‰å¸®åŠ©ï¼Œä¾‹å¦‚æ‰§è¡Œå¤‡ä»½æ“ä½œæˆ–è€…å‘é€é‚®ä»¶ã€‚CronJobs ä¹Ÿå¯ä»¥åœ¨ç‰¹å®šæ—¶é—´è°ƒåº¦å•ä¸ªä»»åŠ¡ï¼Œä¾‹å¦‚ä½ æƒ³è°ƒåº¦ä½æ´»è·ƒå‘¨æœŸçš„ä»»åŠ¡ã€‚</p><h3 id="CronJobä½¿ç”¨æ–¹æ³•"><a href="#CronJobä½¿ç”¨æ–¹æ³•" class="headerlink" title="CronJobä½¿ç”¨æ–¹æ³•"></a>CronJobä½¿ç”¨æ–¹æ³•</h3><p>CronJob éœ€è¦ä¸€ä¸ªé…ç½®æ–‡ä»¶ã€‚ æœ¬ä¾‹ä¸­ CronJob çš„<code>.spec</code> é…ç½®æ–‡ä»¶æ¯åˆ†é’Ÿæ‰“å°å‡ºå½“å‰æ—¶é—´å’Œä¸€ä¸ªé—®å¥½ä¿¡æ¯ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hello</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">schedule:</span> <span class="string">&quot;*/1 * * * *&quot;</span></span><br><span class="line">  <span class="attr">jobTemplate:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">containers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hello</span></span><br><span class="line">            <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">            <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">            <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">date;</span> <span class="string">echo</span> <span class="string">Hello</span> <span class="string">from</span> <span class="string">the</span> <span class="string">Kubernetes</span> <span class="string">cluster</span></span><br><span class="line">          <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br></pre></td></tr></table></figure><p>æƒ³è¦è¿è¡Œç¤ºä¾‹çš„ CronJobï¼Œå¯ä»¥ä¸‹è½½ç¤ºä¾‹æ–‡ä»¶å¹¶æ‰§è¡Œå‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl create -f ./cronjob.yaml</span></span><br></pre></td></tr></table></figure><p><code>cronjob.batch/hello created</code></p><p>åˆ›å»ºå¥½ CronJob åï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥è·å–å…¶çŠ¶æ€ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get cronjob hello</span></span><br></pre></td></tr></table></figure><p>è¾“å‡ºç±»ä¼¼äºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME    SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE</span><br><span class="line">hello   *&#x2F;1 * * * *   False     0        50s             75s</span><br></pre></td></tr></table></figure><p>å°±åƒä½ ä»å‘½ä»¤è¿”å›ç»“æœçœ‹åˆ°çš„é‚£æ ·ï¼ŒCronJob è¿˜æ²¡æœ‰è°ƒåº¦æˆ–æ‰§è¡Œä»»ä½•ä»»åŠ¡ã€‚å¤§çº¦éœ€è¦ä¸€åˆ†é’Ÿä»»åŠ¡æ‰èƒ½åˆ›å»ºå¥½ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl get jobs --watch</span><br><span class="line">NAME               COMPLETIONS   DURATION   AGE</span><br><span class="line">hello-4111706356   0/1                      0s</span><br><span class="line">hello-4111706356   0/1           0s         0s</span><br><span class="line">hello-4111706356   1/1           5s         5s</span><br></pre></td></tr></table></figure><p>ç°åœ¨ä½ å·²ç»çœ‹åˆ°äº†ä¸€ä¸ªè¿è¡Œä¸­çš„ä»»åŠ¡è¢« â€œhelloâ€ CronJob è°ƒåº¦ã€‚ ä½ å¯ä»¥åœæ­¢ç›‘è§†è¿™ä¸ªä»»åŠ¡ï¼Œç„¶åå†æ¬¡æŸ¥çœ‹ CronJob å°±èƒ½çœ‹åˆ°å®ƒè°ƒåº¦ä»»åŠ¡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get cronjob hello</span></span><br></pre></td></tr></table></figure><p>è¾“å‡ºç±»ä¼¼äºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME    SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE</span><br><span class="line">hello   *&#x2F;1 * * * *   False     0        50s             75s</span><br></pre></td></tr></table></figure><p>ä½ åº”è¯¥èƒ½çœ‹åˆ° â€œhelloâ€ CronJob åœ¨ <code>LAST-SCHEDULE</code> å£°æ˜çš„æ—¶é—´ç‚¹æˆåŠŸçš„è°ƒåº¦äº†ä¸€æ¬¡ä»»åŠ¡ã€‚ æœ‰ 0 ä¸ªæ´»è·ƒçš„ä»»åŠ¡æ„å‘³ç€ä»»åŠ¡æ‰§è¡Œå®Œæ¯•æˆ–è€…æ‰§è¡Œå¤±è´¥ã€‚</p><p>ç°åœ¨ï¼Œæ‰¾åˆ°æœ€åä¸€æ¬¡è°ƒåº¦ä»»åŠ¡åˆ›å»ºçš„ Pod å¹¶æŸ¥çœ‹ä¸€ä¸ª Pod çš„æ ‡å‡†è¾“å‡ºã€‚è¯·æ³¨æ„ä»»åŠ¡åç§°å’Œ Pod åç§°æ˜¯ä¸åŒçš„ã€‚</p><blockquote><p><strong>è¯´æ˜ï¼š</strong> Job åç§°å’Œ Pod åç§°ä¸åŒã€‚</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> åœ¨ä½ çš„ç³»ç»Ÿä¸Šå°† <span class="string">&quot;hello-4111706356&quot;</span> æ›¿æ¢ä¸º Job åç§°</span></span><br><span class="line">pods=$(kubectl get pods --selector=job-name=hello-4111706356 --output=jsonpath=&#123;.items..metadata.name&#125;)</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ Pod æ—¥å¿—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs $pods</span><br><span class="line">Fri Feb 22 11:02:09 UTC 2019</span><br><span class="line">Hello from the Kubernetes cluster</span><br></pre></td></tr></table></figure><p>å½“ä½ ä¸å†éœ€è¦ CronJob æ—¶ï¼Œå¯ä»¥ç”¨ <code>kubectl delete cronjob</code> åˆ æ‰å®ƒï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete cronjob hello</span><br></pre></td></tr></table></figure><p>åˆ é™¤ CronJob ä¼šæ¸…é™¤å®ƒåˆ›å»ºçš„æ‰€æœ‰ä»»åŠ¡å’Œ Podï¼Œå¹¶é˜»æ­¢å®ƒåˆ›å»ºé¢å¤–çš„ä»»åŠ¡ã€‚</p><h1 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h1><p>Service æ˜¯ Kubernetes æœ€æ ¸å¿ƒæ¦‚å¿µï¼Œé€šè¿‡åˆ›å»º Serviceï¼Œ<strong>å¯ä»¥ä¸ºä¸€ç»„å…·æœ‰ç›¸åŒåŠŸèƒ½çš„å®¹å™¨åº”ç”¨æä¾›ä¸€ä¸ªç»Ÿä¸€çš„å…¥å£åœ°å€</strong>ï¼Œå¹¶ä¸”å°†è¯·æ±‚è´Ÿè½½åˆ†å‘åˆ°åç«¯çš„å„ä¸ªå®¹å™¨åº”ç”¨ä¸Šã€‚ </p><p>ç±»ä¼¼äºå¾®æœåŠ¡çš„æœåŠ¡æ³¨å†Œä¸å‘ç°ä¸­å¿ƒã€‚</p><blockquote><p>å­˜åœ¨æ„ä¹‰ï¼š</p><ul><li>å› ä¸ºPodçš„IPä¸æ–­å˜åŒ–ï¼ŒServiceå…³è”Podï¼Œé˜²æ­¢Podå¤±å»è”ç³»</li><li>å®šä¹‰ä¸€ç»„Podçš„è®¿é—®è§„åˆ™ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰</li></ul></blockquote><p>todo kubeget get svcçš„å›¾ç‰‡</p><h2 id="Serviceä¸Podå…³ç³»"><a href="#Serviceä¸Podå…³ç³»" class="headerlink" title="Serviceä¸Podå…³ç³»"></a>Serviceä¸Podå…³ç³»</h2><p>ä¸Šé¢è¯´åˆ°Serviceé˜²æ­¢ä¸Podå¤±è”ï¼Œæ‰€ä»¥Serviceè¦ä¸Podå»ºç«‹è”ç³»ï¼Œä»–ä»¬æ˜¯ç”¨è¿‡æ ‡ç­¾å’Œæ ‡ç­¾é€‰æ‹©å™¨æ¥å»ºç«‹è”ç³»çš„ã€‚</p><p>ç„¶åè¯´åˆ°Serviceå®šäºä¸€ç»„è®¿é—®Podçš„è§„åˆ™ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸ºä»€ä¹ˆä¸ç›´æ¥é€šè¿‡ipè®¿é—®podå‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ kubectl get pods -l app=mywebapp -o yaml | grep podIP æ¥è·å–Pod çš„ IP åœ°å€å’Œç«¯å£å·æ¥è®¿é—® Tomcat æœåŠ¡ï¼Œä½†æ˜¯ç›´æ¥é€šè¿‡ Pod çš„ IP åœ°å€å’Œç«¯å£è®¿é—®åº”ç”¨æœåŠ¡æ˜¯ä¸å¯é çš„ï¼Œå› ä¸ºå½“ Pod æ‰€åœ¨çš„ Node å‘ç”Ÿæ•…éšœæ—¶ï¼Œ Pod å°†è¢« kubernetes é‡æ–°è°ƒåº¦åˆ° å¦ä¸€å° Nodeï¼ŒPod çš„åœ°å€ä¼šå‘ç”Ÿæ”¹å˜ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶æ¥å®šä¹‰ Serviceï¼Œå† é€šè¿‡kubectl create æ¥åˆ›å»ºï¼Œè¿™æ ·å¯ä»¥é€šè¿‡ Service åœ°å€æ¥è®¿é—®åç«¯çš„ Pod.ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201124113505202.png" alt="image-20201124113505202"></p><h2 id="Serviceçš„ç§ç±»"><a href="#Serviceçš„ç§ç±»" class="headerlink" title="Serviceçš„ç§ç±»"></a>Serviceçš„ç§ç±»</h2><p><a href="#Deployment%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8">ä¸Šé¢æš´éœ²ç«¯å£æ—¶</a>æœ‰ä¸ª<code>--type=xxx</code>ï¼Œè¿™é‡Œæœ‰ä¸‰ä¸ªé€‰é¡¹ï¼Œè¿™å…¶å®å°±æ˜¯Serviceçš„ç§ç±»ï¼Œæ‰€ä»¥<code>expose</code>æ“ä½œæ—¶å°±æ˜¯åˆ›å»ºä¸åŒçš„<code>Service</code>ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-02_19-53-26.png" alt="Snipaste_2020-12-02_19-53-26"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl expose --<span class="built_in">help</span></span><br></pre></td></tr></table></figure><h3 id="ClusterIP"><a href="#ClusterIP" class="headerlink" title="ClusterIP"></a>ClusterIP</h3><p>é»˜è®¤å€¼ï¼Œä¸€èˆ¬åœ¨é›†ç¾¤å†…éƒ¨è®¿é—®æ—¶ä½¿ç”¨ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-02_19-58-04.png" alt="Snipaste_2020-12-02_19-58-04"></p><h3 id="NodePort"><a href="#NodePort" class="headerlink" title="NodePort"></a>NodePort</h3><p>ä¸€èˆ¬ç”¨äºå°†é›†ç¾¤å†…éƒ¨çš„Podæš´éœ²ç»™å¤–ç½‘è®¿é—®æ—¶é‡‡ç”¨è¿™ç§æ¨¡å¼ï¼Œå®ƒå¯ä»¥æš´éœ²Podå†…çš„æŒ‡å®šç«¯å£ï¼Œç„¶åå¯ä»¥é€šè¿‡é›†ç¾¤å†…ä»»ä½•ä¸€å°æœºå™¨çš„IPåŠ ä¸Šéšæœºæš´éœ²çš„ç«¯å£è¿›è¡Œè®¿é—®Podã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-02_19-58-39.png" alt="Snipaste_2020-12-02_19-58-39"></p><p>é€šè¿‡æŸ¥çœ‹serviceï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-02_19-59-38.png" alt="Snipaste_2020-12-02_19-59-38"></p><p>å‘ç°ï¼ŒClusterIPçš„åªæœ‰ä¸€ä¸ªç«¯å£ï¼Œåªèƒ½å†…éƒ¨è®¿é—®ï¼Œè€ŒNodePortæœ‰ç«¯å£çš„æ˜ å°„ï¼Œæ‰€ä»¥ä»–èƒ½é€šè¿‡é›†ç¾¤èŠ‚ç‚¹çš„Ipå’Œç«¯å£è®¿é—®åˆ°Podé‡ŒæŒ‡å®šçš„ç«¯å£ã€‚</p><h3 id="LoadBalancer"><a href="#LoadBalancer" class="headerlink" title="LoadBalancer"></a>LoadBalancer</h3><p>ä¹Ÿæ˜¯ä¸€èˆ¬ç”¨äºå¤–ç½‘è®¿é—®Podï¼Œä¸€èˆ¬ä¸å…¬æœ‰äº‘ä¸€åŒä½¿ç”¨ï¼Œåšåˆ°è´Ÿè½½å‡è¡¡çš„æ•ˆæœã€‚</p><h1 id="é…ç½®ç®¡ç†"><a href="#é…ç½®ç®¡ç†" class="headerlink" title="é…ç½®ç®¡ç†"></a>é…ç½®ç®¡ç†</h1><h2 id="Sercet"><a href="#Sercet" class="headerlink" title="Sercet"></a>Sercet</h2><p>Sercetï¼šæœ‰å¯†ç çš„æ„æ€ï¼Œå®ƒæ˜¯å°†å¯†ç ç­‰æ•æ„Ÿæ•°æ®å­˜å‚¨åœ¨etcdä¸­ã€‚ä¸Šé¢è¯´è¿‡etcdæ˜¯k8sçš„å­˜å‚¨ä¸­å¿ƒã€‚</p><p><strong>å®ƒçš„ä½œç”¨å°±æ˜¯å°†åŠ å¯†çš„æ•°æ®å­˜å‚¨åœ¨etcdä¸­ï¼Œè®©Podå®¹å™¨ä»¥å˜é‡/Volumeçš„æ–¹å¼è¿›è¡Œè®¿é—®ã€‚</strong></p><h3 id="åˆ›å»ºSercet"><a href="#åˆ›å»ºSercet" class="headerlink" title="åˆ›å»ºSercet"></a>åˆ›å»ºSercet</h3><p><strong>å°† secret æ•°æ®è½¬æ¢ä¸º base-64 å½¢å¼</strong></p><p>å‡è®¾ç”¨æˆ·æƒ³è¦æœ‰ä¸¤æ¡ Secret æ•°æ®ï¼šç”¨æˆ·å <code>my-app</code> å’Œå¯†ç  <code>39528$vdg7Jb</code>ã€‚ é¦–å…ˆä½¿ç”¨ <a href="https://www.base64encode.org/">Base64 ç¼–ç </a> å°†ç”¨æˆ·åå’Œå¯†ç è½¬åŒ–ä¸º base-64 å½¢å¼ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨å¸¸ç”¨çš„ base64 ç¨‹åºçš„ç¤ºä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo -n &#x27;my-app&#x27; | base64</span><br><span class="line">echo -n &#x27;39528$vdg7Jb&#x27; | base64</span><br></pre></td></tr></table></figure><p>ç»“æœæ˜¾ç¤º base-64 å½¢å¼çš„ç”¨æˆ·åä¸º <code>bXktYXBw</code>ï¼Œ base-64 å½¢å¼çš„å¯†ç ä¸º <code>Mzk1MjgkdmRnN0pi</code>ã€‚</p><blockquote><p><strong>æ³¨æ„ï¼š</strong> ä½¿ç”¨ä½ çš„æ“ä½œç³»ç»Ÿæ‰€èƒ½ä¿¡ä»»çš„æœ¬åœ°å·¥å…·ä»¥é™ä½ä½¿ç”¨å¤–éƒ¨å·¥å…·çš„é£é™©ã€‚</p></blockquote><p><strong>åˆ›å»º Secret</strong></p><p>è¿™é‡Œæ˜¯ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå¯ä»¥ç”¨æ¥åˆ›å»ºå­˜æœ‰ç”¨æˆ·åå’Œå¯†ç çš„ Secret:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-secret</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">bXktYXBw</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">Mzk1MjgkdmRnN0pi</span></span><br></pre></td></tr></table></figure><ol><li><p>åˆ›å»º Secretï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f https://k8s.io/examples/pods/inject/secret.yaml</span></span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ Secret ç›¸å…³ä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get secret test-secret</span></span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME          TYPE      DATA      AGE</span><br><span class="line">test-secret   Opaque    2         1m</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹ Secret ç›¸å…³çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe secret test-secret</span></span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Name:       test-secret</span><br><span class="line">Namespace:  default</span><br><span class="line">Labels:     &lt;none&gt;</span><br><span class="line">Annotations:    &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Type:   Opaque</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">password:   13 bytes</span><br><span class="line">username:   7  bytes</span><br></pre></td></tr></table></figure></li></ol><h3 id="æ³¨å…¥åˆ°å®¹å™¨"><a href="#æ³¨å…¥åˆ°å®¹å™¨" class="headerlink" title="æ³¨å…¥åˆ°å®¹å™¨"></a>æ³¨å…¥åˆ°å®¹å™¨</h3><h4 id="ç¯å¢ƒå˜é‡"><a href="#ç¯å¢ƒå˜é‡" class="headerlink" title="ç¯å¢ƒå˜é‡"></a>ç¯å¢ƒå˜é‡</h4><p>ä½¿ç”¨ <code>envFrom</code> æ¥å°† Secret ä¸­çš„æ‰€æœ‰æ•°æ®å®šä¹‰ä¸ºç¯å¢ƒå˜é‡ã€‚ Secret ä¸­çš„é”®åæˆä¸ºå®¹å™¨ä¸­çš„ç¯å¢ƒå˜é‡åï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">envfrom-secret</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">envars-test-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">envFrom:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">secretRef:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">test-secret</span></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201203195838491.png" alt="image-20201203195838491"></p><p>åˆ›å»º Podï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f https://k8s.io/examples/pods/inject/pod-secret-envFrom.yaml</span><br></pre></td></tr></table></figure><p>åœ¨ Shell ä¸­ï¼Œæ˜¾ç¤ºç¯å¢ƒå˜é‡ <code>username</code> å’Œ <code>password</code> çš„å†…å®¹ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201203200120573.png" alt="image-20201203200120573"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -i -t envfrom-secret -- /bin/sh -c <span class="string">&#x27;echo &quot;username: $username\npassword: $password\n&quot;&#x27;</span></span><br></pre></td></tr></table></figure><p>è¾“å‡ºä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username: my-app</span><br><span class="line">password: 39528$vdg7Jb</span><br></pre></td></tr></table></figure><h4 id="Volumeå½¢å¼"><a href="#Volumeå½¢å¼" class="headerlink" title="Volumeå½¢å¼"></a>Volumeå½¢å¼</h4><p>è¿™é‡Œæ˜¯ä¸€ä¸ªå¯ä»¥ç”¨æ¥åˆ›å»º pod çš„é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="comment"># name must match the volume name below</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secret-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/secret-volume</span></span><br><span class="line">  <span class="comment"># The secret data is exposed to Containers in the Pod through a Volume.</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secret-volume</span></span><br><span class="line">      <span class="attr">secret:</span></span><br><span class="line">        <span class="attr">secretName:</span> <span class="string">test-secret</span></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201203200422422.png" alt="image-20201203200422422"></p><ol><li><p>åˆ›å»º Podï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f secret-pod.yaml</span><br></pre></td></tr></table></figure></li><li><p>ç¡®è®¤ Pod æ­£åœ¨è¿è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod secret-test-pod</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME              READY     STATUS    RESTARTS   AGE</span><br><span class="line">secret-test-pod   1/1       Running   0          42m</span><br></pre></td></tr></table></figure></li><li><p>è·å–ä¸€ä¸ª shell è¿›å…¥ Pod ä¸­è¿è¡Œçš„å®¹å™¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it secret-test-pod -- /bin/bash</span><br></pre></td></tr></table></figure></li><li><p>Secret æ•°æ®é€šè¿‡æŒ‚è½½åœ¨ <code>/etc/secret-volume</code> ç›®å½•ä¸‹çš„å·æš´éœ²åœ¨å®¹å™¨ä¸­ã€‚</p><p>åœ¨ shell ä¸­ï¼Œåˆ—ä¸¾ <code>/etc/secret-volume</code> ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls /etc/secret-volume</span><br></pre></td></tr></table></figure><p>è¾“å‡ºåŒ…å«ä¸¤ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªå¯¹åº”ä¸€ä¸ª Secret æ•°æ®æ¡ç›®ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">password username</span><br></pre></td></tr></table></figure></li><li><p>åœ¨ Shell ä¸­ï¼Œæ˜¾ç¤º <code>username</code> å’Œ <code>password</code> æ–‡ä»¶çš„å†…å®¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> åœ¨å®¹å™¨ä¸­ Shell è¿è¡Œä¸‹é¢å‘½ä»¤</span></span><br><span class="line">echo &quot;$(cat /etc/secret-volume/username)&quot;</span><br><span class="line">echo &quot;$(cat /etc/secret-volume/password)&quot;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºä¸ºç”¨æˆ·åå’Œå¯†ç ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">my-app</span><br><span class="line"><span class="meta">39528$</span><span class="bash">vdg7Jb</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h2><p><strong>å’ŒSercetçš„ä½œç”¨å·®ä¸å¤šï¼Œå°†é…ç½®çš„æ•°æ®å­˜å‚¨åœ¨etcdä¸­ï¼Œè®©Podå®¹å™¨ä»¥å˜é‡/Volumeçš„æ–¹å¼è¿›è¡Œè®¿é—®ã€‚</strong></p><p>ConfigMap å…è®¸ä½ å°†é…ç½®æ–‡ä»¶ä¸é•œåƒæ–‡ä»¶åˆ†ç¦»ï¼Œä»¥ä½¿å®¹å™¨åŒ–çš„åº”ç”¨ç¨‹åºå…·æœ‰å¯ç§»æ¤æ€§ã€‚ æœ¬é¡µæä¾›äº†ä¸€ç³»åˆ—ä½¿ç”¨ç¤ºä¾‹ï¼Œè¿™äº›ç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•åˆ›å»º ConfigMap ä»¥åŠé…ç½® Pod ä½¿ç”¨å­˜å‚¨åœ¨ ConfigMap ä¸­çš„æ•°æ®ã€‚</p><h3 id="åˆ›å»ºConfigMap"><a href="#åˆ›å»ºConfigMap" class="headerlink" title="åˆ›å»ºConfigMap"></a>åˆ›å»ºConfigMap</h3><p>ä½ å¯ä»¥ä½¿ç”¨ <code>kubectl create configmap</code> æˆ–è€…åœ¨ <code>kustomization.yaml</code> ä¸­çš„ ConfigMap ç”Ÿæˆå™¨ æ¥åˆ›å»º ConfigMapã€‚æ³¨æ„ï¼Œ<code>kubectl</code> ä» 1.14 ç‰ˆæœ¬å¼€å§‹æ”¯æŒ <code>kustomization.yaml</code>ã€‚</p><h4 id="åŸºäºæ–‡ä»¶åˆ›å»º"><a href="#åŸºäºæ–‡ä»¶åˆ›å»º" class="headerlink" title="åŸºäºæ–‡ä»¶åˆ›å»º"></a>åŸºäºæ–‡ä»¶åˆ›å»º</h4><p>ä½ å¯ä»¥ä½¿ç”¨ <code>kubectl create configmap</code> åŸºäºå•ä¸ªæ–‡ä»¶æˆ–å¤šä¸ªæ–‡ä»¶åˆ›å»º ConfigMapã€‚</p><p>ä¾‹å¦‚ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap game-config-2 --from-file=configure-pod-container/configmap/game.properties</span><br></pre></td></tr></table></figure><p>å°†äº§ç”Ÿä»¥ä¸‹ ConfigMap:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe configmaps game-config-2</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç±»ä¼¼ä»¥ä¸‹å†…å®¹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Name:         game-config-2</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">game.properties:</span><br><span class="line">----</span><br><span class="line">enemies&#x3D;aliens</span><br><span class="line">lives&#x3D;3</span><br><span class="line">enemies.cheat&#x3D;true</span><br><span class="line">enemies.cheat.level&#x3D;noGoodRotten</span><br><span class="line">secret.code.passphrase&#x3D;UUDDLRLRBABAS</span><br><span class="line">secret.code.allowed&#x3D;true</span><br><span class="line">secret.code.lives&#x3D;30</span><br></pre></td></tr></table></figure><hr><p>åœ¨ä½¿ç”¨ <code>--from-file</code> å‚æ•°æ—¶ï¼Œä½ å¯ä»¥å®šä¹‰åœ¨ ConfigMap çš„ <code>data</code> éƒ¨åˆ†å‡ºç°é”®åï¼Œ è€Œä¸æ˜¯æŒ‰é»˜è®¤è¡Œä¸ºä½¿ç”¨æ–‡ä»¶åï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap game-config-3 --from-file=&lt;my-key-name&gt;=&lt;path-to-file&gt;</span><br></pre></td></tr></table></figure><p><code>&lt;my-key-name&gt;</code> æ˜¯ä½ è¦åœ¨ ConfigMap ä¸­ä½¿ç”¨çš„é”®åï¼Œ<code>&lt;path-to-file&gt;</code> æ˜¯ä½ æƒ³è¦é”®è¡¨ç¤ºæ•°æ®æºæ–‡ä»¶çš„ä½ç½®ã€‚</p><p>ä¾‹å¦‚:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap game-config-3 --from-file=game-special-key=configure-pod-container/configmap/game.properties</span><br></pre></td></tr></table></figure><p>å°†äº§ç”Ÿä»¥ä¸‹ ConfigMap:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get configmaps game-config-3 -o yaml</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç±»ä¼¼ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="number">2016-02-18T18:54:22Z</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">game-config-3</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;530&quot;</span></span><br><span class="line">  <span class="attr">selfLink:</span> <span class="string">/api/v1/namespaces/default/configmaps/game-config-3</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">05f8da22-d671-11e5-8cd0-68f728db1985</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">game-special-key:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">enemies=aliens</span></span><br><span class="line">    <span class="string">lives=3</span></span><br><span class="line">    <span class="string">enemies.cheat=true</span></span><br><span class="line">    <span class="string">enemies.cheat.level=noGoodRotten</span></span><br><span class="line">    <span class="string">secret.code.passphrase=UUDDLRLRBABAS</span></span><br><span class="line">    <span class="string">secret.code.allowed=true</span></span><br><span class="line">    <span class="string">secret.code.lives=30</span></span><br></pre></td></tr></table></figure><h4 id="åŸºäºç”Ÿæˆå™¨åˆ›å»º-ConfigMap"><a href="#åŸºäºç”Ÿæˆå™¨åˆ›å»º-ConfigMap" class="headerlink" title="åŸºäºç”Ÿæˆå™¨åˆ›å»º ConfigMap"></a>åŸºäºç”Ÿæˆå™¨åˆ›å»º ConfigMap</h4><p>è‡ª 1.14 å¼€å§‹ï¼Œ<code>kubectl</code> å¼€å§‹æ”¯æŒ <code>kustomization.yaml</code>ã€‚ ä½ è¿˜å¯ä»¥åŸºäºç”Ÿæˆå™¨åˆ›å»º ConfigMapï¼Œç„¶åå°†å…¶åº”ç”¨äº API æœåŠ¡å™¨ä¸Šåˆ›å»ºå¯¹è±¡ã€‚ ç”Ÿæˆå™¨åº”åœ¨ç›®å½•å†…çš„ <code>kustomization.yaml</code> ä¸­æŒ‡å®š</p><p>ä¾‹å¦‚ï¼Œè¦ä» <code>configure-pod-container/configmap/kubectl/game.properties</code> æ–‡ä»¶ç”Ÿæˆä¸€ä¸ª ConfigMapï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> åˆ›å»ºåŒ…å« ConfigMapGenerator çš„ kustomization.yaml æ–‡ä»¶</span></span><br><span class="line">cat &lt;&lt;EOF &gt;./kustomization.yaml</span><br><span class="line">configMapGenerator:</span><br><span class="line">- name: game-config-4</span><br><span class="line">  files:</span><br><span class="line">  - configure-pod-container/configmap/kubectl/game.properties</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ kustomization ç›®å½•åˆ›å»º ConfigMap å¯¹è±¡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -k .</span><br><span class="line">configmap/game-config-4-m9dm2f92bt created</span><br></pre></td></tr></table></figure><p>ä½ å¯ä»¥æ£€æŸ¥ ConfigMap æ˜¯è¿™æ ·åˆ›å»ºçš„:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">kubectl get configmap</span><br><span class="line">NAME                       DATA   AGE</span><br><span class="line">game-config-4-m9dm2f92bt   1      37s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl describe configmaps/game-config-4-m9dm2f92bt</span><br><span class="line">Name:         game-config-4-m9dm2f92bt</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubectl.kubernetes.io/last-applied-configuration:</span><br><span class="line">                &#123;&quot;apiVersion&quot;:&quot;v1&quot;,&quot;data&quot;:&#123;&quot;game.properties&quot;:&quot;enemies=aliens\nlives=3\nenemies.cheat=true\nenemies.cheat.level=noGoodRotten\nsecret.code.p...</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">game.properties:</span><br><span class="line">----</span><br><span class="line">enemies=aliens</span><br><span class="line">lives=3</span><br><span class="line">enemies.cheat=true</span><br><span class="line">enemies.cheat.level=noGoodRotten</span><br><span class="line">secret.code.passphrase=UUDDLRLRBABAS</span><br><span class="line">secret.code.allowed=true</span><br><span class="line">secret.code.lives=30</span><br><span class="line">Events:  &lt;none&gt;</span><br></pre></td></tr></table></figure><p>è¯·æ³¨æ„ï¼Œç”Ÿæˆçš„ ConfigMap åç§°å…·æœ‰é€šè¿‡å¯¹å†…å®¹è¿›è¡Œæ•£åˆ—è€Œé™„åŠ çš„åç¼€ï¼Œ è¿™æ ·å¯ä»¥ç¡®ä¿æ¯æ¬¡ä¿®æ”¹å†…å®¹æ—¶éƒ½ä¼šç”Ÿæˆæ–°çš„ ConfigMapã€‚</p><hr><p>åœ¨ ConfigMap ç”Ÿæˆå™¨ï¼Œä½ å¯ä»¥å®šä¹‰ä¸€ä¸ªéæ–‡ä»¶åçš„é”®åã€‚ ä¾‹å¦‚ï¼Œä» <code>configure-pod-container/configmap/game.properties</code> æ–‡ä»¶ç”Ÿæˆ ConfigMapï¼Œ ä½†ä½¿ç”¨ <code>game-special-key</code> ä½œä¸ºé”®åï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> åˆ›å»ºåŒ…å« ConfigMapGenerator çš„ kustomization.yaml æ–‡ä»¶</span></span><br><span class="line">cat &lt;&lt;EOF &gt;./kustomization.yaml</span><br><span class="line">configMapGenerator:</span><br><span class="line">- name: game-config-5</span><br><span class="line">  files:</span><br><span class="line">  - game-special-key=configure-pod-container/configmap/kubectl/game.properties</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ Kustomization ç›®å½•åˆ›å»º ConfigMap å¯¹è±¡ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -k .</span><br><span class="line">configmap/game-config-5-m67dt67794 created</span><br></pre></td></tr></table></figure><hr><blockquote><p>å¦‚åŸºäºæ–‡ä»¶åˆ›å»º <a href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-pod-configmap/#create-configmaps-from-files">ConfigMap</a> ä¸­æ‰€è¿°ï¼Œå½“ä½ ä½¿ç”¨ <code>--from-file</code> åˆ›å»º ConfigMap æ—¶ï¼Œï¼ˆé»˜è®¤ï¼‰æ–‡ä»¶åæˆä¸ºå­˜å‚¨åœ¨ ConfigMap çš„ <code>data</code> éƒ¨åˆ†ä¸­çš„é”®ï¼Œ æ–‡ä»¶å†…å®¹æˆä¸ºé”®å¯¹åº”çš„å€¼ã€‚</p><p>æ‰€ä»¥è¿™ç§åˆ›å»ºæ–¹å¼ï¼Œåªæœ‰ä¸€ä¸ªk-vã€‚ä½¿ç”¨ä¸‹è¿°yamlåˆ›å»ºçš„è¯ä¸€ä¸ªConfigMaoå¤šä¸ªKV</p></blockquote><h3 id="æ³¨å…¥åˆ°å®¹å™¨-1"><a href="#æ³¨å…¥åˆ°å®¹å™¨-1" class="headerlink" title="æ³¨å…¥åˆ°å®¹å™¨"></a>æ³¨å…¥åˆ°å®¹å™¨</h3><h4 id="ç¯å¢ƒå˜é‡-1"><a href="#ç¯å¢ƒå˜é‡-1" class="headerlink" title="ç¯å¢ƒå˜é‡"></a>ç¯å¢ƒå˜é‡</h4><ul><li><p>åˆ›å»ºä¸€ä¸ªåŒ…å«å¤šä¸ªé”®å€¼å¯¹çš„ ConfigMapã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">special-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">SPECIAL_LEVEL:</span> <span class="string">very</span></span><br><span class="line">  <span class="attr">SPECIAL_TYPE:</span> <span class="string">charm</span></span><br></pre></td></tr></table></figure><p>åˆ›å»º ConfigMap:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f https://kubernetes.io/examples/configmap/configmap-multikeys.yaml</span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨ <code>envFrom</code> å°†æ‰€æœ‰ ConfigMap çš„æ•°æ®å®šä¹‰ä¸ºå®¹å™¨ç¯å¢ƒå˜é‡ï¼ŒConfigMap ä¸­çš„é”®æˆä¸º Pod ä¸­çš„ç¯å¢ƒå˜é‡åç§°ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dapi-test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">k8s.gcr.io/busybox</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;env&quot;</span> ]</span><br><span class="line">      <span class="attr">envFrom:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">special-config</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure><p>åˆ›å»º Pod:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f https://kubernetes.io/examples/pods/pod-configmap-envFrom.yaml</span><br></pre></td></tr></table></figure><p>ç°åœ¨ï¼ŒPod çš„è¾“å‡ºåŒ…å«ç¯å¢ƒå˜é‡ <code>SPECIAL_LEVEL=very</code> å’Œ <code>SPECIAL_TYPE=charm</code>ã€‚</p></li></ul><h4 id="æ•°æ®å·"><a href="#æ•°æ®å·" class="headerlink" title="æ•°æ®å·"></a>æ•°æ®å·</h4><p>å¦‚åŸºäºæ–‡ä»¶åˆ›å»º ConfigMap ä¸­æ‰€è¿°ï¼Œå½“ä½ ä½¿ç”¨ â€“from-file åˆ›å»º ConfigMap æ—¶ï¼Œæ–‡ä»¶åæˆä¸ºå­˜å‚¨åœ¨ ConfigMap çš„ data éƒ¨åˆ†ä¸­çš„é”®ï¼Œ æ–‡ä»¶å†…å®¹æˆä¸ºé”®å¯¹åº”çš„å€¼ã€‚</p><p>æœ¬èŠ‚ä¸­çš„ç¤ºä¾‹å¼•ç”¨äº†ä¸€ä¸ªåä¸º special-config çš„ ConfigMapï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">special-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">SPECIAL_LEVEL:</span> <span class="string">very</span></span><br><span class="line">  <span class="attr">SPECIAL_TYPE:</span> <span class="string">charm</span></span><br></pre></td></tr></table></figure><p>åˆ›å»º ConfigMap:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f https://kubernetes.io/examples/configmap/configmap-multikeys.yaml</span><br></pre></td></tr></table></figure><p>åœ¨ Pod è§„çº¦çš„ <code>volumes</code> éƒ¨åˆ†ä¸‹æ·»åŠ  ConfigMap åç§°ã€‚ è¿™ä¼šå°† ConfigMap æ•°æ®æ·»åŠ åˆ°æŒ‡å®šä¸º <code>volumeMounts.mountPath</code> çš„ç›®å½•ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸º <code>/etc/config</code>ï¼‰ã€‚ <code>command</code> éƒ¨åˆ†å¼•ç”¨å­˜å‚¨åœ¨ ConfigMap ä¸­çš„ <code>special.level</code>ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dapi-test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">k8s.gcr.io/busybox</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;ls /etc/config/&quot;</span> ]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">        <span class="attr">mountPath:</span> <span class="string">/etc/config</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">      <span class="attr">configMap:</span></span><br><span class="line">        <span class="comment"># Provide the name of the ConfigMap containing the files you want</span></span><br><span class="line">        <span class="comment"># to add to the container</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">special-config</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure><p><img src="E:%5CProjects%5Csync%5Cmd%5Ck8s%5Cimage-20201204100337839.png" alt="image-20201204100337839"></p><p>åˆ›å»º Pod:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f https://kubernetes.io/examples/pods/pod-configmap-volume.yaml</span><br></pre></td></tr></table></figure><p>Pod è¿è¡Œæ—¶ï¼Œå‘½ä»¤ <code>ls /etc/config/</code> äº§ç”Ÿä¸‹é¢çš„è¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SPECIAL_LEVEL</span><br><span class="line">SPECIAL_TYPE</span><br></pre></td></tr></table></figure><blockquote><p><strong>æ³¨æ„ï¼š</strong> å¦‚æœåœ¨ <code>/etc/config/</code> ç›®å½•ä¸­æœ‰ä¸€äº›æ–‡ä»¶ï¼Œå®ƒä»¬å°†è¢«åˆ é™¤ã€‚</p></blockquote><blockquote><p><strong>è¯´æ˜ï¼š</strong> æ–‡æœ¬æ•°æ®ä¼šä½¿ç”¨ UTF-8 å­—ç¬¦ç¼–ç çš„å½¢å¼å±•ç°ä¸ºæ–‡ä»¶ã€‚å¦‚æœä½¿ç”¨å…¶ä»–å­—ç¬¦ç¼–ç ï¼Œ å¯ä»¥ä½¿ç”¨ <code>binaryData</code>ã€‚</p></blockquote><h1 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h1><h2 id="Ingressçš„åŠŸèƒ½"><a href="#Ingressçš„åŠŸèƒ½" class="headerlink" title="Ingressçš„åŠŸèƒ½"></a>Ingressçš„åŠŸèƒ½</h2><p>ä¹‹å‰åˆ›å»ºçš„Nginx Deploymentèµ„æºä¸ºäº†èƒ½è®©å¤–éƒ¨è®¿é—®ï¼Œé‡‡ç”¨<code>kubectl expose</code>æ“ä½œåˆ›å»ºäº†ä¸€ä¸ªtype=NodePortçš„Serviceï¼Œç„¶åå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¥è®¿é—®åˆ°å†…éƒ¨çš„Nginxèµ„æºï¼š</p><ul><li>Service IP:PORT</li><li>é›†ç¾¤å†…ä»»ä¸€èŠ‚ç‚¹IP:Port</li></ul><p>é‚£è¿™æ ·æœ‰ç‚¹ä¸æ–¹ä¾¿ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è®¿é—®ä¸€ä¸ªåº”ç”¨è¦å…ˆæŸ¥çœ‹ä»–å¼€æ”¾çš„ç«¯å£ï¼Œé€šè¿‡IPç«¯å£å½¢å¼è®¿é—®ï¼Œä½†åœ¨å®é™…çš„ä½¿ç”¨å½“ä¸­æ˜¯å¸Œæœ›é€šè¿‡ä¸åŒåŸŸåè®¿é—®åˆ°ä¸åŒçš„æœåŠ¡ï¼ŒåŸŸååº”è¯¥æŒ‡å‘çš„IPæ˜¯åŒä¸€ä¸ªã€‚Ingresså°±å®ç°äº†è¿™ä¸ª</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201204142357121.png" alt="image-20201204142357121"></p><blockquote><p>å¤§å®¶å¯èƒ½æƒ³Ingresså®ç°çš„å†…å®¹ä¸å°±å’ŒNginxä¸€è‡´å—ã€‚å…¶å®å®˜æ–¹æä¾›çš„IngressåŸç†å°±æ˜¯Nginxï¼Œåšäº†æ­¥å°è£…ã€‚</p></blockquote><p>é€šè¿‡ä¸Šå›¾å¾—çŸ¥ï¼ŒIngresså¯¹è®¿é—®çš„åŸŸåè¿›è¡Œäº†è§„åˆ™çš„è½¬å‘ï¼Œè½¬å‘è‡³å¯¹è±¡çš„ServiceIPå’Œç«¯å£ï¼Œè€ŒServcieæ˜¯ä¸€ç»„Podçš„è®¿é—®è§„åˆ™ï¼Œè¿™æ ·å°±å¯ä»¥æ ¹æ®ä¸åŒçš„åŸŸåè®¿é—®åˆ°ä¸åŒçš„æœåŠ¡äº†ã€‚</p><h2 id="Ingressçš„ä½¿ç”¨"><a href="#Ingressçš„ä½¿ç”¨" class="headerlink" title="Ingressçš„ä½¿ç”¨"></a>Ingressçš„ä½¿ç”¨</h2><p>Ingressä¸æ˜¯k8sé›†ç¾¤è‡ªå¸¦çš„åŠŸèƒ½ï¼Œéœ€è¦é€‰æ‹©Ingressçš„æ§åˆ¶å™¨å®‰è£…ï¼Œæˆ‘ä»¬é€‰æ‹©å®˜æ–¹ç»´æŠ¤nginxæ§åˆ¶å™¨ï¼Œå®ç°éƒ¨ç½²</p><blockquote><p>æ­¥éª¤ï¼š</p><ol><li>éƒ¨ç½²ingress Controller</li><li>åˆ›å»ºingressè§„åˆ™</li></ol></blockquote><p><strong>1. åˆ›å»ºåº•å±‚è¢«è®¿é—®åº”ç”¨ï¼Œå¹¶æš´éœ²</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl create deployment web --image=nginx</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl expose deployment web --port=80 --target-port=80 --<span class="built_in">type</span>=NodePort</span></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201204143724336.png" alt="image-20201204143724336"></p><blockquote><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬é€šè¿‡Serivceçš„10.106.99.78:80è½¬å‘åˆ°é›†ç¾¤ä»»ä¸€å‡ ç‚¹çš„ip:32402å°±èƒ½è®¿é—®åˆ°deploymentèµ„æº</p></blockquote><p><strong>2. éƒ¨ç½²Ingress Controller</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-configuration</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tcp-services</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">udp-services</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-serviceaccount</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-clusterrole</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">events</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;extensions&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;networking.k8s.io&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;extensions&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;networking.k8s.io&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingresses/status</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-role</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">    <span class="attr">resourceNames:</span></span><br><span class="line">      <span class="comment"># Defaults to &quot;&lt;election-id&gt;-&lt;ingress-class&gt;&quot;</span></span><br><span class="line">      <span class="comment"># Here: &quot;&lt;ingress-controller-leader&gt;-&lt;nginx&gt;&quot;</span></span><br><span class="line">      <span class="comment"># This has to be adapted if you change either parameter</span></span><br><span class="line">      <span class="comment"># when launching the nginx-ingress-controller.</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;ingress-controller-leader-nginx&quot;</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-role-nisa-binding</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-role</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx-ingress-serviceaccount</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-clusterrole-nisa-binding</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-clusterrole</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx-ingress-serviceaccount</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-controller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">prometheus.io/port:</span> <span class="string">&quot;10254&quot;</span></span><br><span class="line">        <span class="attr">prometheus.io/scrape:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment"># wait up to five minutes for the drain of connections</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">300</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nginx-ingress-serviceaccount</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-ingress-controller</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">lizhenliang/nginx-ingress-controller:0.30.0</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/nginx-ingress-controller</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--configmap=$(POD_NAMESPACE)/nginx-configuration</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--tcp-services-configmap=$(POD_NAMESPACE)/tcp-services</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--udp-services-configmap=$(POD_NAMESPACE)/udp-services</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--publish-service=$(POD_NAMESPACE)/ingress-nginx</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--annotations-prefix=nginx.ingress.kubernetes.io</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">capabilities:</span></span><br><span class="line">              <span class="attr">drop:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">              <span class="attr">add:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">NET_BIND_SERVICE</span></span><br><span class="line">            <span class="comment"># www-data -&gt; 101</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">101</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">              <span class="attr">containerPort:</span> <span class="number">443</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">10254</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">10254</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">lifecycle:</span></span><br><span class="line">            <span class="attr">preStop:</span></span><br><span class="line">              <span class="attr">exec:</span></span><br><span class="line">                <span class="attr">command:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="string">/wait-shutdown</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">min:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">90Mi</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Container</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201204145037259.png" alt="image-20201204145037259"></p><p><strong>3. åˆ›å»ºingressè§„åˆ™</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># http</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">example.ingredemo.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">web</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># https</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tls-example-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sslexample.ctnrs.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">secret-tls</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">sslexample.ctnrs.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">          <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">web</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201204145348232.png" alt="image-20201204145348232"></p><p><strong>4. æ·»åŠ æœ¬åœ°åŸŸåè§£æ</strong></p><p>å› ä¸ºIngress-Controllerè¿è¡Œåœ¨masterä¸­ï¼Œæ‰€ä»¥å°†è¦ä½¿ç”¨çš„åŸŸåè§£æåˆ°masterçš„IPã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201204145635739.png" alt="image-20201204145635739"></p><p><strong>5. è®¿é—®</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201204145720268.png" alt="image-20201204145720268"></p><h1 id="æ ¸å¿ƒæŠ€æœ¯Helm"><a href="#æ ¸å¿ƒæŠ€æœ¯Helm" class="headerlink" title="æ ¸å¿ƒæŠ€æœ¯Helm"></a>æ ¸å¿ƒæŠ€æœ¯Helm</h1><h2 id="Helmçš„å¼•å…¥"><a href="#Helmçš„å¼•å…¥" class="headerlink" title="Helmçš„å¼•å…¥"></a>Helmçš„å¼•å…¥</h2><p>ä¹‹å‰æˆ‘ä»¬åˆ›å»ºæœåŠ¡æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨ç¼–å†™å•ä¸ªæœåŠ¡çš„Deploymentã€Serviceã€Ingressçš„é…ç½®æ–‡ä»¶ï¼Œ<strong>å¹¶å¤šæ¬¡é€šè¿‡<code>kubectl apply</code>å¯åŠ¨ã€‚</strong>è¿™æ ·å•ä¸ªæœåŠ¡æ²¡é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœéƒ¨ç½²å¾®æœåŠ¡æ—¶ï¼Œä¸€ä¸ªé¡¹ç›®æœ‰å¾ˆå¤šæœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡éƒ½éœ€è¦æ‰‹åŠ¨å¯åŠ¨å¤šä¸ªèµ„æºæ‰å¯ä»¥å¼€å¯ï¼Œè¿™æ ·å¾ˆéº»çƒ¦ï¼Œæ‰€ä»¥Helmè¯ç”Ÿäº†ã€‚</p><p>K8S ä¸Šçš„åº”ç”¨å¯¹è±¡ï¼Œéƒ½æ˜¯ç”±ç‰¹å®šçš„èµ„æºæè¿°ç»„æˆï¼ŒåŒ…æ‹¬ deploymentã€service ç­‰ã€‚éƒ½ä¿å­˜å„è‡ªæ–‡ä»¶ä¸­æˆ–è€…é›†ä¸­å†™åˆ°ä¸€ä¸ªé…ç½®æ–‡ä»¶ã€‚ç„¶å kubectl apply â€“f éƒ¨ç½²ã€‚å¦‚æœåº”ç”¨åªç”±ä¸€ä¸ªæˆ–å‡ ä¸ªè¿™æ ·çš„æœåŠ¡ç»„æˆï¼Œä¸Šé¢éƒ¨ç½²æ–¹å¼è¶³å¤Ÿäº†ã€‚è€Œå¯¹äºä¸€ä¸ªå¤æ‚çš„åº”ç”¨ï¼Œä¼šæœ‰å¾ˆå¤šç±»ä¼¼ä¸Šé¢çš„èµ„æºæè¿°æ–‡ä»¶ï¼Œä¾‹å¦‚å¾®æœåŠ¡æ¶æ„åº”ç”¨ï¼Œç»„æˆåº”ç”¨çš„æœåŠ¡å¯èƒ½å¤šè¾¾åä¸ªï¼Œå‡ åä¸ªã€‚å¦‚æœæœ‰æ›´æ–°æˆ–å›æ»šåº”ç”¨çš„éœ€æ±‚ï¼Œå¯èƒ½è¦ä¿®æ”¹å’Œç»´æŠ¤æ‰€æ¶‰åŠçš„å¤§é‡èµ„æºæ–‡ä»¶ï¼Œè€Œè¿™ç§ç»„ç»‡å’Œç®¡ç†åº”ç”¨çš„æ–¹å¼å°±æ˜¾å¾—åŠ›ä¸ä»å¿ƒäº†ã€‚ä¸”ç”±äºç¼ºå°‘å¯¹å‘å¸ƒè¿‡çš„åº”ç”¨ç‰ˆæœ¬ç®¡ç†å’Œæ§åˆ¶ï¼Œä½¿Kubernetes ä¸Šçš„åº”ç”¨ç»´æŠ¤å’Œæ›´æ–°ç­‰é¢ä¸´è¯¸å¤šçš„æŒ‘æˆ˜ï¼Œä¸»è¦é¢ä¸´ä»¥ä¸‹é—®é¢˜ï¼š</p><ol><li>å¦‚ä½•å°†è¿™äº›æœåŠ¡ä½œä¸ºä¸€ä¸ªæ•´ä½“ç®¡ç† </li><li>è¿™äº›èµ„æºæ–‡ä»¶å¦‚ä½•é«˜æ•ˆå¤ç”¨</li><li>ä¸æ”¯æŒåº”ç”¨çº§åˆ«çš„ç‰ˆæœ¬ç®¡ç†</li></ol><h2 id="Helmä»‹ç»"><a href="#Helmä»‹ç»" class="headerlink" title="Helmä»‹ç»"></a>Helmä»‹ç»</h2><p>Helm æ˜¯ä¸€ä¸ª Kubernetes çš„åŒ…ç®¡ç†å·¥å…·ï¼Œå°±åƒ Linux ä¸‹çš„åŒ…ç®¡ç†å™¨ï¼Œå¦‚ yum/apt ç­‰ï¼Œå¯ä»¥ å¾ˆæ–¹ä¾¿çš„å°†ä¹‹å‰æ‰“åŒ…å¥½çš„ yaml æ–‡ä»¶éƒ¨ç½²åˆ° kubernetes ä¸Šã€‚ </p><p><strong>Helm æœ‰ 3 ä¸ªé‡è¦æ¦‚å¿µï¼š</strong> </p><ol><li>helmï¼šä¸€ä¸ªå‘½ä»¤è¡Œå®¢æˆ·ç«¯å·¥å…·ï¼Œä¸»è¦ç”¨äº Kubernetes åº”ç”¨ chart çš„åˆ›å»ºã€æ‰“åŒ…ã€å‘ å¸ƒå’Œç®¡ç†ã€‚ </li><li>Chartï¼šåº”ç”¨æè¿°ï¼Œä¸€ç³»åˆ—ç”¨äºæè¿° k8s èµ„æºç›¸å…³æ–‡ä»¶(yamlé…ç½®æ–‡ä»¶)çš„é›†åˆã€‚</li><li>Releaseï¼šåŸºäº Chart çš„éƒ¨ç½²å®ä½“ï¼Œä¸€ä¸ª chart è¢« Helm è¿è¡Œåå°†ä¼šç”Ÿæˆå¯¹åº”çš„ä¸€ä¸ª releaseï¼›å°†åœ¨ k8s ä¸­åˆ›å»ºå‡ºçœŸå®è¿è¡Œçš„èµ„æºå¯¹è±¡ã€‚å³æ¯è¿è¡Œä¸€æ¬¡æœåŠ¡ï¼Œå°±ä¼šæœ‰ä¸€ä¸ªRelease</li></ol><p><strong>Helmå¯ä»¥è§£å†³çš„é—®é¢˜</strong></p><ol><li>å¯ä»¥æŠŠä¸€ä¸ªæœåŠ¡çš„æ‰€ä»¥é…ç½®æ–‡ä»¶yamlç»Ÿä¸€ç®¡ç†ï¼Œé€šè¿‡Chartã€‚</li><li>å®ç°yamlé«˜æ ¡å¤ç”¨ï¼Œé€šè¿‡ä¼ é€’å‚æ•°åŠ¨æ€æ¸²æŸ“æ¨¡æ¿åšåˆ°ã€‚</li><li>ä½¿ç”¨helmåº”ç”¨ç•Œåˆ«çš„ç‰ˆæœ¬ç®¡ç†ã€‚</li></ol><blockquote><p> æ€»ç»“æ¥è¯´é€šè¿‡Helmæ¥ç®¡ç†æœåŠ¡ï¼Œè™½ç„¶é…ç½®æ–‡ä»¶ä¹Ÿæ˜¯ä¸€ä¸ªä¹Ÿæ²¡æœ‰å‡å°‘ï¼Œä½†æ˜¯é€šè¿‡å®ƒæ¥ç®¡ç†æœåŠ¡ï¼Œå‡çº§ï¼Œå¯åŠ¨ä¼šæå¤§çš„æ–¹ä¾¿</p></blockquote><h2 id="Helm-v3-å˜åŒ–"><a href="#Helm-v3-å˜åŒ–" class="headerlink" title="Helm v3 å˜åŒ–"></a>Helm v3 å˜åŒ–</h2><p>2019 å¹´ 11 æœˆ 13 æ—¥ï¼Œ Helm å›¢é˜Ÿå‘å¸ƒ Helm v3 çš„ç¬¬ä¸€ä¸ªç¨³å®šç‰ˆæœ¬ã€‚ è¯¥ç‰ˆæœ¬ä¸»è¦å˜åŒ–å¦‚ä¸‹ï¼š </p><ol><li>æœ€æ˜æ˜¾çš„å˜åŒ–æ˜¯ Tiller çš„åˆ é™¤<img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-05_13-15-22.png" alt="Snipaste_2020-12-05_13-15-22"></li><li>Release åç§°å¯ä»¥åœ¨ä¸åŒå‘½åç©ºé—´é‡ç”¨</li><li>æ”¯æŒå°† Chart æ¨é€è‡³ Docker é•œåƒä»“åº“ä¸­</li><li>ä½¿ç”¨ JSONSchema éªŒè¯ chart values</li></ol><h2 id="Helmå®¢æˆ·ç«¯"><a href="#Helmå®¢æˆ·ç«¯" class="headerlink" title="Helmå®¢æˆ·ç«¯"></a>Helmå®¢æˆ·ç«¯</h2><h3 id="å®‰è£…å’Œé…ç½®æº"><a href="#å®‰è£…å’Œé…ç½®æº" class="headerlink" title="å®‰è£…å’Œé…ç½®æº"></a>å®‰è£…å’Œé…ç½®æº</h3><p>å› ä¸ºå®ƒç±»ä¼¼äºaptã€yumï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦é…ç½®æºï¼Œç„¶åå°±å¯ä»¥ä»ç½‘ä¸Šä¸‹è½½é…ç½®å¥½çš„å„ä¸ªAPPçš„Chartçš„é…ç½®æ–‡ä»¶ï¼Œç›´æ¥é…ç½®ç½‘ä¸Šçš„åº”ç”¨ã€‚ä½†æ˜¯å¤šæ•°æ¥è¯´è¿˜æ˜¯ä¼šè‡ªå®šä¹‰Charté…ç½®ï¼Œæ¥éƒ¨ç½²è‡ªå·±çš„åº”ç”¨ï¼Œä¸æ˜¯å…¬å…±çš„åº”ç”¨ã€‚</p><p><strong>å®‰è£…</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://get.helm.sh/helm-v3.4.1-linux-amd64.tar.gz</span><br><span class="line">$ tar -zxvf helm-v3.4.1-linux-amd64.tar.gz</span><br><span class="line">$ cp linux-amd64/helm /usr/bin/</span><br><span class="line"><span class="comment"># éªŒè¯</span></span><br><span class="line">$ helm</span><br></pre></td></tr></table></figure><p><strong>é…ç½®å›½å†… chart ä»“åº“</strong></p><ul><li>å¾®è½¯ä»“åº“ï¼ˆ<a href="http://mirror.azure.cn/kubernetes/charts/%EF%BC%89%E8%BF%99%E4%B8%AA%E4%BB%93%E5%BA%93%E6%8E%A8%E8%8D%90%EF%BC%8C%E5%9F%BA%E6%9C%AC">http://mirror.azure.cn/kubernetes/charts/ï¼‰è¿™ä¸ªä»“åº“æ¨èï¼ŒåŸºæœ¬</a> ä¸Šå®˜ç½‘æœ‰çš„ chart è¿™é‡Œéƒ½æœ‰ã€‚ </li><li> é˜¿é‡Œäº‘ä»“åº“ï¼ˆ<a href="https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts">https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</a> ï¼‰</li><li>å®˜æ–¹ä»“åº“ï¼ˆ<a href="https://hub.kubeapps.com/charts/incubator%EF%BC%89%E5%AE%98%E6%96%B9">https://hub.kubeapps.com/charts/incubatorï¼‰å®˜æ–¹</a> chart ä»“åº“ï¼Œå›½ å†…æœ‰ç‚¹ä¸å¥½ä½¿ã€‚</li></ul><p>æ·»åŠ å­˜å‚¨åº“ï¼š<code>helm repo add éšä¾¿èµ·Name url</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm repo add stable http://mirror.azure.cn/kubernetes/charts </span><br><span class="line">helm repo add aliyun https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts </span><br><span class="line">helm repo update</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹é…ç½®çš„å­˜å‚¨åº“</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo list</span><br></pre></td></tr></table></figure><p>åˆ é™¤å­˜å‚¨åº“</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo remove aliyun</span><br></pre></td></tr></table></figure><h2 id="éƒ¨ç½²åº”ç”¨"><a href="#éƒ¨ç½²åº”ç”¨" class="headerlink" title="éƒ¨ç½²åº”ç”¨"></a>éƒ¨ç½²åº”ç”¨</h2><h3 id="Chartåˆ›å»º"><a href="#Chartåˆ›å»º" class="headerlink" title="Chartåˆ›å»º"></a>Chartåˆ›å»º</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm create mychart</span><br><span class="line">ls mycharts/</span><br></pre></td></tr></table></figure><ul><li>Chart.yamlæ˜¯å½“å‰Chartå±æ€§é…ç½®ä¿¡æ¯</li><li>templatesæ˜¯å­˜æ”¾æœåŠ¡é…ç½®æ–‡ä»¶çš„æ–‡ä»¶å¤¹</li><li>values.yamlæ˜¯å®šä¹‰å…¨å±€å˜é‡çš„æ–‡ä»¶</li></ul><h3 id="yamlé«˜æ•ˆå¤ç”¨"><a href="#yamlé«˜æ•ˆå¤ç”¨" class="headerlink" title="yamlé«˜æ•ˆå¤ç”¨"></a>yamlé«˜æ•ˆå¤ç”¨</h3><p>åˆ›å»ºæœåŠ¡yamlé€šè¿‡value.yamlé‡Œçš„å‚æ•°åŠ¨æ€ç»‘å®šæ¨¡æ¿ï¼Œè¿™æ ·è¾ƒå°‘Yamlç¼–å†™æ—¶é—´ã€‚å› ä¸ºæœåŠ¡èµ„æºyamlæ¨¡æ¿å¤§ä½“ä¿¡æ¯ä¸€è‡´ï¼Œåªéœ€è¦æ”¹éƒ¨é—¨å‚æ•°å†…å®¹å³å¯ã€‚</p><p>ä¸‹é¢å¼€å§‹å®šä¹‰å…¨å±€å˜é‡ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> mychart</span><br><span class="line">vim values.yaml</span><br><span class="line">replicas: 1</span><br><span class="line">image: nginx</span><br><span class="line">tag: 1.16</span><br><span class="line">label: nginx</span><br><span class="line">port: 80</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨templatesæ–‡ä»¶å¤¹ä¸­çš„å¯¹åº”çš„é…ç½®æ–‡ä»¶ä¸­é€šè¿‡å˜é‡å¼•å…¥ï¼š<code>&#123;&#123; .Values.xxx&#125;&#125;</code>ã€‚æ³¨æ„ ç‚¹ä¸å¤§æ‹¬å·ä¹‹é—´çš„ç©ºæ ¼ã€‚ç„¶åæˆ‘ä»¬ä¸€èˆ¬åœ¨nameçš„å€¼é‡‡ç”¨<code>&#123;&#123; .Release.Name&#125;&#125;</code>æ·»åŠ åç§°ï¼Œä»–çš„å€¼å°±æ˜¯<code>helm install xxx chartçš„ä½ç½®</code>ä¸­çš„xxxï¼Œé¿å…å¤šæ¬¡åˆ›å»ºnameç›¸åŒã€‚</p><p>ä¿®æ”¹éƒ¨åˆ†é…ç½®æ–‡ä»¶ï¼Œå‚è€ƒä¸‹é¢ï¼Œè¯·ç»“åˆè‡ªå·±å®é™…ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-05_14-25-07.png" alt="Snipaste_2020-12-05_14-25-07"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-05_14-24-57.png" alt="Snipaste_2020-12-05_14-24-57"></p><h3 id="å¯åŠ¨"><a href="#å¯åŠ¨" class="headerlink" title="å¯åŠ¨"></a>å¯åŠ¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install myweb ./mychart</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-12-05_14-28-42.png" alt="Snipaste_2020-12-05_14-28-42"></p><h3 id="å‡çº§"><a href="#å‡çº§" class="headerlink" title="å‡çº§"></a>å‡çº§</h3><p><code>helm upgrade myweb ./mychart/</code></p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://jkzhao.github.io/2019/08/26/Kubernetes%E5%AD%98%E5%82%A8%E5%8D%B7/">https://jkzhao.github.io/2019/08/26/Kubernetes%E5%AD%98%E5%82%A8%E5%8D%B7/</a></p><p><a href="https://www.qikqiak.com/post/understand-kubernetes-affinity/">https://www.qikqiak.com/post/understand-kubernetes-affinity/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;æ ¸å¿ƒæŠ€æœ¯Pod&quot;&gt;&lt;a href=&quot;#æ ¸å¿ƒæŠ€æœ¯Pod&quot; class=&quot;headerlink&quot; title=&quot;æ ¸å¿ƒæŠ€æœ¯Pod&quot;&gt;&lt;/a&gt;æ ¸å¿ƒæŠ€æœ¯Pod&lt;/h1&gt;&lt;h2 id=&quot;æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;æ¦‚</summary>
      
    
    
    
    <category term="Kubernetes" scheme="https://awslzhang.top/categories/Kubernetes/"/>
    
    
    <category term="Docker" scheme="https://awslzhang.top/tags/Docker/"/>
    
    <category term="Kubernetes" scheme="https://awslzhang.top/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kuberneteså­¦ä¹ </title>
    <link href="https://awslzhang.top/2020/11/15/Kubernetes%E5%AD%A6%E4%B9%A0/"/>
    <id>https://awslzhang.top/2020/11/15/Kubernetes%E5%AD%A6%E4%B9%A0/</id>
    <published>2020-11-15T11:50:36.000Z</published>
    <updated>2021-01-01T05:49:59.957Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h1><h2 id="Kubernetesæ¦‚è¿°"><a href="#Kubernetesæ¦‚è¿°" class="headerlink" title="Kubernetesæ¦‚è¿°"></a>Kubernetesæ¦‚è¿°</h2><p>kubernetesï¼Œç®€ç§° K8sï¼Œæ˜¯ç”¨ 8 ä»£æ›¿ 8 ä¸ªå­—ç¬¦â€œuberneteâ€è€Œæˆçš„ç¼©å†™ã€‚æ˜¯ä¸€ä¸ªå¼€æº çš„ï¼Œç”¨äºç®¡ç†äº‘å¹³å°ä¸­å¤šä¸ªä¸»æœºä¸Šçš„å®¹å™¨åŒ–çš„åº”ç”¨ï¼ŒKubernetes çš„ç›®æ ‡æ˜¯è®©éƒ¨ç½²å®¹å™¨åŒ–çš„ åº”ç”¨ç®€å•å¹¶ä¸”é«˜æ•ˆï¼ˆpowerfulï¼‰,Kubernetes æä¾›äº†åº”ç”¨éƒ¨ç½²ï¼Œè§„åˆ’ï¼Œæ›´æ–°ï¼Œç»´æŠ¤çš„ä¸€ç§ æœºåˆ¶ã€‚</p><p>Kubernetes æ˜¯ Google å¼€æºçš„ä¸€ä¸ªå®¹å™¨ç¼–æ’å¼•æ“ï¼Œ<font color="red">å®ƒæ”¯æŒè‡ªåŠ¨åŒ–éƒ¨ç½²ã€å¤§è§„æ¨¡å¯ä¼¸ç¼©ã€ åº”ç”¨å®¹å™¨åŒ–ç®¡ç†ã€‚</font>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­éƒ¨ç½²ä¸€ä¸ªåº”ç”¨ç¨‹åºæ—¶ï¼Œ<font color="red">é€šå¸¸è¦éƒ¨ç½²è¯¥åº”ç”¨çš„å¤šä¸ªå®ä¾‹ä»¥ä¾¿ å¯¹åº”ç”¨è¯·æ±‚è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚</font></p><blockquote><p>Kubernetesæ˜¯å®¹å™¨åŒ–é›†ç¾¤ç®¡ç†ç³»ç»Ÿã€‚å®ƒè®©éƒ¨ç½²å®¹å™¨åŒ–åº”ç”¨æ›´åŠ ç®€æ´å’Œé«˜æ•ˆã€‚</p></blockquote><blockquote><p>Kuberneteså¯ä»¥è®¤ä¸ºæ˜¯å®¹å™¨çš„èµ„æºç®¡ç†å™¨ï¼Œå…¶ä»–çš„èµ„æºç®¡ç†å™¨è¿˜æœ‰ï¼š</p><ul><li><code>Apache MESOS</code>ï¼šåˆ†å¸ƒå¼èµ„æºç®¡ç†æ¡†æ¶ï¼Œåœ¨2019-5ï¼ŒTwitterå®£å¸ƒç”±MESOSè½¬ä¸ºKubernetes</li><li><code>Docker Swarm</code>ï¼šè½»é‡ã€åŠŸèƒ½å°‘ï¼Œåœ¨2019-7ï¼Œé˜¿é‡Œäº‘å®£å¸ƒä¸æ”¯æŒDocker Swarm</li><li><font color="red"><code>Kubernetes</code></font>ï¼šGoogleå…¬å¸å‘å¸ƒï¼Œé‡‡ç”¨GOè¯­è¨€å¼€å‘<ul><li>ç‰¹ç‚¹ï¼šè½»é‡çº§ã€å¼€æºã€å¼¹æ€§ä¼¸ç¼©ã€è´Ÿè½½å‡è¡¡(IPVS)</li></ul></li></ul></blockquote><h2 id="ä¸ºä»€ä¹ˆéœ€è¦-Kubernetesï¼Œå®ƒèƒ½åšä»€ä¹ˆ"><a href="#ä¸ºä»€ä¹ˆéœ€è¦-Kubernetesï¼Œå®ƒèƒ½åšä»€ä¹ˆ" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦ Kubernetesï¼Œå®ƒèƒ½åšä»€ä¹ˆ?"></a>ä¸ºä»€ä¹ˆéœ€è¦ Kubernetesï¼Œå®ƒèƒ½åšä»€ä¹ˆ?</h2><p><font color="red">å®¹å™¨æ˜¯æ‰“åŒ…å’Œè¿è¡Œåº”ç”¨ç¨‹åºçš„å¥½æ–¹å¼ã€‚</font>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ‚¨éœ€è¦ç®¡ç†è¿è¡Œåº”ç”¨ç¨‹åºçš„å®¹å™¨ï¼Œ<strong>å¹¶ç¡®ä¿ä¸ä¼šåœæœº</strong>ã€‚ä¾‹å¦‚ï¼Œ<font color="red">å¦‚æœä¸€ä¸ªå®¹å™¨å‘ç”Ÿæ•…éšœï¼Œåˆ™éœ€è¦å¯åŠ¨å¦ä¸€ä¸ªå®¹å™¨ã€‚å¦‚æœç³»ç»Ÿå¤„ç†æ­¤è¡Œä¸ºï¼Œä¼šä¸ä¼šæ›´å®¹æ˜“ï¼Ÿ</font></p><p><strong>è¿™å°±æ˜¯ Kubernetes çš„æ•‘æ´æ–¹æ³•ï¼</strong>Kubernetes ä¸ºæ‚¨æä¾›äº†ä¸€ä¸ª<font color="red"><strong>å¯å¼¹æ€§è¿è¡Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„æ¡†æ¶</strong></font>ã€‚Kubernetes ä¼šæ»¡è¶³æ‚¨çš„æ‰©å±•è¦æ±‚ã€æ•…éšœè½¬ç§»ã€éƒ¨ç½²æ¨¡å¼ç­‰ã€‚ä¾‹å¦‚ï¼ŒKubernetes å¯ä»¥è½»æ¾ç®¡ç†ç³»ç»Ÿçš„ Canary éƒ¨ç½²ã€‚</p><hr><p><strong>Kubernetes ä¸ºæ‚¨æä¾›ï¼š</strong></p><ul><li><p><strong>æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡</strong><br>Kubernetes å¯ä»¥ä½¿ç”¨ DNS åç§°æˆ–è‡ªå·±çš„ IP åœ°å€å…¬å¼€å®¹å™¨ï¼Œå¦‚æœåˆ°å®¹å™¨çš„æµé‡å¾ˆå¤§ï¼ŒKubernetes å¯ä»¥è´Ÿè½½å‡è¡¡å¹¶åˆ†é…ç½‘ç»œæµé‡ï¼Œä»è€Œä½¿éƒ¨ç½²ç¨³å®šã€‚</p></li><li><p><strong>å­˜å‚¨ç¼–æ’</strong><br>Kubernetes å…è®¸æ‚¨è‡ªåŠ¨æŒ‚è½½æ‚¨é€‰æ‹©çš„å­˜å‚¨ç³»ç»Ÿï¼Œä¾‹å¦‚æœ¬åœ°å­˜å‚¨ã€å…¬å…±äº‘æä¾›å•†ç­‰ã€‚</p></li><li><p><strong>è‡ªåŠ¨éƒ¨ç½²å’Œå›æ»š</strong><br>æ‚¨å¯ä»¥ä½¿ç”¨ Kubernetes æè¿°å·²éƒ¨ç½²å®¹å™¨çš„æ‰€éœ€çŠ¶æ€ï¼Œå®ƒå¯ä»¥ä»¥å—æ§çš„é€Ÿç‡å°†å®é™…çŠ¶æ€æ›´æ”¹ä¸ºæ‰€éœ€çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥è‡ªåŠ¨åŒ– Kubernetes æ¥ä¸ºæ‚¨çš„éƒ¨ç½²åˆ›å»ºæ–°å®¹å™¨ï¼Œåˆ é™¤ç°æœ‰å®¹å™¨å¹¶å°†å®ƒä»¬çš„æ‰€æœ‰èµ„æºç”¨äºæ–°å®¹å™¨ã€‚</p></li><li><p><strong>è‡ªåŠ¨äºŒè¿›åˆ¶æ‰“åŒ…</strong><br>Kubernetes å…è®¸æ‚¨æŒ‡å®šæ¯ä¸ªå®¹å™¨æ‰€éœ€ CPU å’Œå†…å­˜ï¼ˆRAMï¼‰ã€‚å½“å®¹å™¨æŒ‡å®šäº†èµ„æºè¯·æ±‚æ—¶ï¼ŒKubernetes å¯ä»¥åšå‡ºæ›´å¥½çš„å†³ç­–æ¥ç®¡ç†å®¹å™¨çš„èµ„æºã€‚</p></li><li><p><strong>è‡ªæˆ‘ä¿®å¤</strong><br>Kubernetes é‡æ–°å¯åŠ¨å¤±è´¥çš„å®¹å™¨ã€æ›¿æ¢å®¹å™¨ã€æ€æ­»ä¸å“åº”ç”¨æˆ·å®šä¹‰çš„è¿è¡ŒçŠ¶å†µæ£€æŸ¥çš„å®¹å™¨ï¼Œå¹¶ä¸”åœ¨å‡†å¤‡å¥½æœåŠ¡ä¹‹å‰ä¸å°†å…¶é€šå‘Šç»™å®¢æˆ·ç«¯ã€‚</p></li><li><p><strong>å¯†é’¥ä¸é…ç½®ç®¡ç†</strong><br>Kubernetes å…è®¸æ‚¨å­˜å‚¨å’Œç®¡ç†æ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚å¯†ç ã€OAuth ä»¤ç‰Œå’Œ ssh å¯†é’¥ã€‚æ‚¨å¯ä»¥åœ¨ä¸é‡å»ºå®¹å™¨é•œåƒçš„æƒ…å†µä¸‹éƒ¨ç½²å’Œæ›´æ–°å¯†é’¥å’Œåº”ç”¨ç¨‹åºé…ç½®ï¼Œä¹Ÿæ— éœ€åœ¨å †æ ˆé…ç½®ä¸­æš´éœ²å¯†é’¥ã€‚</p></li></ul><h2 id="Kubernetesæ¶æ„ç»„ä»¶"><a href="#Kubernetesæ¶æ„ç»„ä»¶" class="headerlink" title="Kubernetesæ¶æ„ç»„ä»¶"></a>Kubernetesæ¶æ„ç»„ä»¶</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-11-15_16-52-10.png" alt="Snipaste_2020-11-15_16-52-10"></p><p><font color="red"><strong>k8s é›†ç¾¤çš„èŠ‚ç‚¹æœ‰ä¸¤ä¸ªè§’è‰²ï¼Œåˆ†åˆ«ä¸º Master èŠ‚ç‚¹å’Œ Node èŠ‚ç‚¹ï¼Œæ•´ä¸ª K8s é›†ç¾¤Master å’Œ Node èŠ‚ç‚¹å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</strong></font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/20200823181812.png"></p><h3 id="MasterèŠ‚ç‚¹ç»„ä»¶"><a href="#MasterèŠ‚ç‚¹ç»„ä»¶" class="headerlink" title="MasterèŠ‚ç‚¹ç»„ä»¶"></a>MasterèŠ‚ç‚¹ç»„ä»¶</h3><p>Master èŠ‚ç‚¹ä¹Ÿç§°ä¸ºæ§åˆ¶èŠ‚ç‚¹ï¼Œæ¯ä¸ª k8s é›†ç¾¤éƒ½æœ‰ä¸€ä¸ª Master èŠ‚ç‚¹è´Ÿè´£æ•´ä¸ªé›†ç¾¤çš„ç®¡ç†æ§åˆ¶ï¼Œæˆ‘ä»¬ä¸Šé¢ä»‹ç»çš„ k8s ä¸‰å¤§èƒ½åŠ›éƒ½æ˜¯ç»è¿‡ Master èŠ‚ç‚¹å‘èµ·çš„ï¼ŒMaster èŠ‚ç‚¹åŒ…å«äº†ä»¥ä¸‹å‡ ä¸ªç»„ä»¶ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/20200823181408.png"></p><ul><li><code>API server</code>ï¼šé›†ç¾¤ç»Ÿä¸€å…¥å£ï¼Œæä¾›äº† HTTP Rest æ¥å£çš„æœåŠ¡è¿›ç¨‹ï¼Œæ‰€æœ‰èµ„æºå¯¹è±¡çš„å¢ã€åˆ ã€æ”¹ã€æŸ¥ç­‰æ“ä½œçš„å”¯ä¸€å…¥å£ï¼›</li><li><code>controller-manager</code>ï¼šk8s é›†ç¾¤æ‰€æœ‰èµ„æºå¯¹è±¡çš„è‡ªåŠ¨åŒ–æ§åˆ¶ä¸­å¿ƒï¼›<strong>ä¸€ä¸ªèµ„æºå¯¹åº”ä¸€ä¸ªæ§åˆ¶å™¨</strong>ã€‚</li><li><code>scheduler</code>ï¼šä¸»èŠ‚ç‚¹ä¸Šçš„ç»„ä»¶ï¼Œè¯¥ç»„ä»¶ç›‘è§†é‚£äº›æ–°åˆ›å»ºçš„æœªæŒ‡å®šè¿è¡ŒèŠ‚ç‚¹çš„ Podï¼Œå¹¶é€‰æ‹©èŠ‚ç‚¹è®© Pod åœ¨ä¸Šé¢è¿è¡Œã€‚</li><li><code>etcd</code>ï¼šæ˜¯å…¼å…·ä¸€è‡´æ€§å’Œé«˜å¯ç”¨æ€§çš„é”®å€¼æ•°æ®åº“ï¼Œå¯ä»¥ä½œä¸ºä¿å­˜ Kubernetes æ‰€æœ‰é›†ç¾¤æ•°æ®çš„åå°æ•°æ®åº“ã€‚</li></ul><h3 id="WorkerèŠ‚ç‚¹ç»„ä»¶"><a href="#WorkerèŠ‚ç‚¹ç»„ä»¶" class="headerlink" title="WorkerèŠ‚ç‚¹ç»„ä»¶"></a>WorkerèŠ‚ç‚¹ç»„ä»¶</h3><p>Node èŠ‚ç‚¹çš„ä½œç”¨æ˜¯æ‰¿æ¥ Master åˆ†é…çš„å·¥ä½œè´Ÿè½½ï¼Œå®ƒä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªå…³é”®ç»„ä»¶ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/20200823184119.png"></p><ul><li><code>Kubelet</code>ï¼šè´Ÿè´£ Pod å¯¹åº”å®¹å™¨çš„åˆ›å»ºã€å¯åœç­‰æ“ä½œï¼Œä¸ Master èŠ‚ç‚¹ç´§å¯†åä½œï¼›</li><li><code>kube-proxy</code>ï¼šæä¾›ç½‘ç»œä»£ç†ï¼Œå®ç° k8s é›†ç¾¤é€šä¿¡ä¸è´Ÿè½½å‡è¡¡çš„ç»„ä»¶ã€‚</li></ul><h2 id="Kubernetesæ ¸å¿ƒæ¦‚å¿µ"><a href="#Kubernetesæ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="Kubernetesæ ¸å¿ƒæ¦‚å¿µ"></a>Kubernetesæ ¸å¿ƒæ¦‚å¿µ</h2><h3 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h3><p>Pod æ˜¯ k8s æœ€é‡è¦è€Œä¸”æ˜¯æœ€åŸºæœ¬çš„ä¸€ä¸ªèµ„æºå¯¹è±¡ï¼Œå®ƒçš„ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/20200821153531.png"></p><p>ä»ä»¥ä¸Š Pod çš„ç»“æ„å›¾å¯ä»¥çœ‹å‡ºï¼Œå®ƒå…¶å®æ˜¯å®¹å™¨çš„ä¸€ä¸ªä¸Šå±‚åŒ…è£…ç»“æ„ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ K8s å¯ä»¥æ”¯æŒå¤šç§å®¹å™¨ç±»å‹çš„åŸå› ï¼ŒåŸºäºè¿™æ–¹é¢ï¼Œæˆ‘ç†è§£ k8s çš„å®šä½å°±æ˜¯ä¸€ä¸ªç¼–æ’ä¸è°ƒåº¦å·¥å…·ï¼Œè€Œå®¹å™¨åªæ˜¯å®ƒè°ƒåº¦çš„ä¸€ä¸ªèµ„æºå¯¹è±¡è€Œå·²ã€‚</p><p>Pod å¯åŒ…å«å¤šä¸ªå®¹å™¨åœ¨é‡Œé¢ï¼Œæ¯ä¸ª Pod è‡³å°‘ä¼šæœ‰ä¸€ä¸ª Pause å®¹å™¨ï¼Œå…¶å®ƒç”¨æˆ·å®šä¹‰çš„å®¹å™¨éƒ½å…±äº«è¯¥ Pause å®¹å™¨ï¼ŒPause å®¹å™¨çš„ä¸»è¦ä½œç”¨æ˜¯ç”¨äºå®šä¹‰ Pod çš„ ip å’Œ volumeã€‚</p><p>Pod åœ¨ k8s é›†ç¾¤ä¸­çš„ä½ç½®å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/20200823185441.png"></p><p><strong>Podç‰¹ç‚¹ï¼š</strong></p><ul><li>k8sä¸­çš„æœ€å°éƒ¨ç½²å•å…ƒã€‚</li><li>æ˜¯ä¸€ç»„å®¹å™¨çš„é›†åˆã€‚</li><li>Podä¸­çš„æ‰€æœ‰å®¹å™¨æ˜¯å…±äº«ç½‘ç»œçš„</li><li>Podçš„ç”Ÿå‘½å‘¨æœŸå¾ˆçŸ­æš‚</li></ul><h3 id="Label"><a href="#Label" class="headerlink" title="Label"></a>Label</h3><p>Label åœ¨ k8s ä¸­æ˜¯ä¸€ä¸ªéå¸¸æ ¸å¿ƒçš„æ¦‚å¿µï¼Œæˆ‘ä»¬å¯ä»¥å°† Label æŒ‡å®šåˆ°å¯¹åº”çš„èµ„æºå¯¹è±¡ä¸­ï¼Œä¾‹å¦‚ Nodeã€Podã€Replica Setã€Service ç­‰ï¼Œä¸€ä¸ªèµ„æºå¯ä»¥ç»‘å®šä»»æ„ä¸ª Labelï¼Œ<font color="red">k8s é€šè¿‡ Label å¯å®ç°å¤šç»´åº¦çš„èµ„æºåˆ†ç»„ç®¡ç†</font>ï¼Œåç»­å¯é€šè¿‡ <font color="red">Label Selector æŸ¥è¯¢å’Œç­›é€‰æ‹¥æœ‰æŸäº› Label çš„èµ„æºå¯¹è±¡</font>ï¼Œä¾‹å¦‚åˆ›å»ºä¸€ä¸ª Podï¼Œç»™å®šä¸€ä¸ª Labelï¼Œworkerid=123ï¼Œåç»­å¯é€šè¿‡ workerid=123 åˆ é™¤æ‹¥æœ‰è¯¥æ ‡ç­¾çš„ Pod èµ„æºã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/20200823192435.png"></p><h3 id="Replica-Set"><a href="#Replica-Set" class="headerlink" title="Replica Set"></a>Replica Set</h3><p><font color="red"><strong>Replica Set ç›®çš„æ˜¯ä¸ºäº†å®šä¹‰ä¸€ä¸ªæœŸæœ›çš„åœºæ™¯</strong></font>ï¼Œæ¯”å¦‚å®šä¹‰æŸç§ <strong>Pod çš„å‰¯æœ¬æ•°é‡</strong>åœ¨ä»»æ„æ—¶åˆ»éƒ½å¤„äº Peplica Set æœŸæœ›çš„å€¼ï¼Œå‡è®¾ Replica Set å®šä¹‰ Pod çš„å‰¯æœ¬æ•°ç›®ä¸ºï¼šreplicas=2ï¼Œå½“è¯¥ Replica Set æäº¤ç»™ Master åï¼ŒMaster ä¼šå®šæœŸå·¡æ£€è¯¥ Pod åœ¨é›†ç¾¤ä¸­çš„æ•°ç›®ï¼Œå¦‚æœå‘ç°è¯¥ Pod æŒ‚æ‰äº†ä¸€ä¸ªï¼ŒMaster å°±ä¼šå°è¯•ä¾æ® Replica Set è®¾ç½®çš„ Pod æ¨¡ç‰ˆåˆ›å»º Podï¼Œä»¥ç»´æŒ Pod çš„æ•°é‡ä¸ Replica Set é¢„æœŸçš„ Pod æ•°é‡ç›¸åŒã€‚</p><p>é€šè¿‡ Replica Setï¼Œk8s é›†ç¾¤å®ç°äº†ç”¨æˆ·åº”ç”¨çš„é«˜å¯ç”¨æ€§ï¼Œè€Œä¸”å¤§å¤§å‡å°‘äº†è¿ç»´å·¥ä½œé‡ã€‚<font color="red"><strong>å› æ­¤ç”Ÿäº§ç¯å¢ƒä¸€èˆ¬ç”¨ Deployment æˆ–è€… Replica Set å»æ§åˆ¶ Pod çš„ç”Ÿå‘½å‘¨æœŸå’ŒæœŸæœ›å€¼ï¼Œè€Œä¸æ˜¯ç›´æ¥å•ç‹¬åˆ›å»º Podã€‚</strong></font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/20200823193118.png"></p><p>ç±»ä¼¼ Replica Set çš„è¿˜æœ‰ <code>Deployment</code>ï¼Œå®ƒçš„å†…éƒ¨å®ç°ä¹Ÿæ˜¯é€šè¿‡ Replica Set å®ç°çš„ï¼Œå¯ä»¥è¯´ Deployment æ˜¯ Replica Set çš„å‡çº§ç‰ˆï¼Œå®ƒä»¬ä¹‹é—´çš„ yaml é…ç½®æ–‡ä»¶æ ¼å¼å¤§éƒ¨åˆ†éƒ½ç›¸åŒã€‚</p><h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>Service æ˜¯ k8s èƒ½å¤Ÿå®ç°å¾®æœåŠ¡é›†ç¾¤çš„ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œé¡¾åæ€ä¹‰ï¼Œk8s çš„ Service å°±æ˜¯æˆ‘ä»¬å¹³æ—¶æ‰€æåŠçš„å¾®æœåŠ¡æ¶æ„ä¸­çš„â€œå¾®æœåŠ¡â€ï¼Œæœ¬æ–‡ä¸Šé¢æåŠçš„ Podã€Replica Set ç­‰éƒ½æ˜¯ä¸º Service æœåŠ¡çš„èµ„æºï¼Œ å¦‚ä¸‹å›¾è¡¨ç¤º Serviceã€Podã€Replica Set çš„å…³ç³»ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/20200823200632.png"></p><p>ä»ä¸Šå›¾å¯çœ‹å‡ºï¼ŒService å®šä¹‰äº†ä¸€ä¸ªæœåŠ¡è®¿é—®çš„å…¥å£ï¼Œå®¢æˆ·ç«¯é€šè¿‡è¿™ä¸ªå…¥å£å³å¯è®¿é—®æœåŠ¡èƒŒåçš„åº”ç”¨é›†ç¾¤å®ä¾‹ï¼Œ<font color="red">è€Œ Service åˆ™æ˜¯é€šè¿‡ Label Selector å®ç°å…³è”ä¸å¯¹æ¥çš„ï¼ŒReplica Set ä¿è¯æœåŠ¡é›†ç¾¤èµ„æºå§‹ç»ˆå¤„äºæœŸæœ›å€¼ã€‚</font></p><p>ä»¥ä¸Šåªæ˜¯ä¸€ä¸ªå¾®æœåŠ¡ï¼Œé€šå¸¸æ¥è¯´ä¸€ä¸ªåº”ç”¨é¡¹ç›®ä¼šç”±å¤šä¸ªä¸åŒä¸šåŠ¡èƒ½åŠ›è€Œåˆå½¼æ­¤ç‹¬ç«‹çš„å¾®æœåŠ¡ç»„æˆï¼Œå¤šä¸ªå¾®æœåŠ¡é—´ç»„æˆäº†ä¸€ä¸ªå¼ºå¤§è€Œåˆé«˜å¯ç”¨çš„åº”ç”¨æœåŠ¡é›†ç¾¤ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/20200823220527.png"></p><h3 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h3><p>Namespace é¡¾åæ€ä¹‰æ˜¯å‘½åç©ºé—´çš„æ„æ€ï¼Œåœ¨ k8s ä¸­ä¸»è¦ç”¨äºå®ç°èµ„æºéš”ç¦»çš„ç›®çš„ï¼Œç”¨æˆ·å¯æ ¹æ®ä¸åŒé¡¹ç›®åˆ›å»ºä¸åŒçš„ Namespaceï¼Œé€šè¿‡ k8s å°†èµ„æºåˆ†é…åˆ°ä¸åŒ Namespace ä¸­ï¼Œå³å¯å®ç°ä¸åŒé¡¹ç›®çš„èµ„æºéš”ç¦»ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/20200823214534.png" alt="img"></p><h1 id="Kubernetesçš„æ­å»º"><a href="#Kubernetesçš„æ­å»º" class="headerlink" title="Kubernetesçš„æ­å»º"></a>Kubernetesçš„æ­å»º</h1><p><strong>å‰ç½®çŸ¥è¯†ç‚¹</strong> </p><p>ç›®å‰ç”Ÿäº§éƒ¨ç½²Kubernetes é›†ç¾¤ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š </p><blockquote><p><strong>kubeadm</strong> </p><p>Kubeadm æ˜¯ä¸€ä¸ª K8s éƒ¨ç½²å·¥å…·ï¼Œæä¾› kubeadm init å’Œ kubeadm joinï¼Œç”¨äºå¿«é€Ÿéƒ¨ç½² Kubernetes é›†ç¾¤ã€‚ </p><p>å®˜æ–¹åœ°å€ï¼š<a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/">https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/</a> </p></blockquote><blockquote><p><strong>äºŒè¿›åˆ¶åŒ…</strong> </p><p>ä» github ä¸‹è½½å‘è¡Œç‰ˆçš„äºŒè¿›åˆ¶åŒ…ï¼Œæ‰‹åŠ¨éƒ¨ç½²æ¯ä¸ªç»„ä»¶ï¼Œç»„æˆ Kubernetes é›†ç¾¤ã€‚Kubeadm é™ä½éƒ¨ç½²é—¨æ§›ï¼Œä½†å±è”½äº†å¾ˆå¤šç»†èŠ‚ï¼Œé‡åˆ°é—®é¢˜å¾ˆéš¾æ’æŸ¥ã€‚å¦‚æœæƒ³æ›´å®¹æ˜“å¯æ§ï¼Œæ¨èä½¿ç”¨äºŒè¿›åˆ¶åŒ…éƒ¨ç½² Kubernetes é›†ç¾¤ï¼Œè™½ç„¶æ‰‹åŠ¨éƒ¨ç½²éº»çƒ¦ç‚¹ï¼ŒæœŸé—´å¯ä»¥å­¦ä¹ å¾ˆå¤šå·¥ä½œåŸç†ï¼Œä¹Ÿåˆ©äºåæœŸç»´æŠ¤ã€‚ </p></blockquote><hr><p><strong>é›†ç¾¤æœºå™¨é¡»çŸ¥</strong></p><ul><li>é›†ç¾¤é—´æœºå™¨ç½‘ç»œäº’é€š</li><li>ç¦æ­¢Swapäº¤æ¢</li></ul><h2 id="kubeadméƒ¨ç½²"><a href="#kubeadméƒ¨ç½²" class="headerlink" title="kubeadméƒ¨ç½²"></a>kubeadméƒ¨ç½²</h2><p><code>kubeadm</code>æ˜¯å®˜æ–¹ç¤¾åŒºæ¨å‡ºçš„ä¸€ä¸ªç”¨äºå¿«é€Ÿéƒ¨ç½² kubernetes é›†ç¾¤çš„å·¥å…·ï¼Œè¿™ä¸ªå·¥å…·èƒ½é€šè¿‡ä¸¤æ¡æŒ‡ä»¤å®Œæˆä¸€ä¸ªkubernetesé›†ç¾¤çš„éƒ¨ç½²ï¼š</p><ol><li>åˆ›å»ºä¸€ä¸ªMasterèŠ‚ç‚¹<code>kubeadm init</code></li><li>å°†NodeèŠ‚ç‚¹åŠ å…¥åˆ°å½“å‰é›†ç¾¤ä¸­<code>kubeadm join &lt;Master èŠ‚ç‚¹çš„ IP å’Œç«¯å£ &gt;</code></li></ol><blockquote><p>è¯¦ç»†æ­¥éª¤ï¼š</p></blockquote><h3 id="å‡†å¤‡ç¯å¢ƒ"><a href="#å‡†å¤‡ç¯å¢ƒ" class="headerlink" title="å‡†å¤‡ç¯å¢ƒ"></a>å‡†å¤‡ç¯å¢ƒ</h3><table><thead><tr><th>è§’è‰²</th><th>IP</th></tr></thead><tbody><tr><td>master</td><td>192.168.58.11</td></tr><tr><td>node1</td><td>192.168.58.12</td></tr><tr><td>node2</td><td>192.168.58.13</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…³é—­é˜²ç«å¢™</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­selinux</span></span><br><span class="line">sed -i <span class="string">&#x27;s/enforcing/disabled/&#x27;</span> /etc/selinux/config  <span class="comment"># æ°¸ä¹…</span></span><br><span class="line">setenforce 0  <span class="comment"># ä¸´æ—¶</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­swap</span></span><br><span class="line">swapoff -a  <span class="comment"># ä¸´æ—¶</span></span><br><span class="line">sed -ri <span class="string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab    <span class="comment"># æ°¸ä¹…</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ¹æ®è§„åˆ’è®¾ç½®ä¸»æœºå</span></span><br><span class="line">hostnamectl set-hostname &lt;hostname&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨masteræ·»åŠ hosts</span></span><br><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">192.168.58.11 k8smaster</span></span><br><span class="line"><span class="string">192.168.58.12 k8snode1</span></span><br><span class="line"><span class="string">192.168.58.13 k8snode2</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†æ¡¥æ¥çš„IPv4æµé‡ä¼ é€’åˆ°iptablesçš„é“¾</span></span><br><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">sysctl --system  <span class="comment"># ç”Ÿæ•ˆ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ—¶é—´åŒæ­¥</span></span><br><span class="line">yum install ntpdate -y</span><br><span class="line">ntpdate time.windows.com</span><br></pre></td></tr></table></figure><h3 id="æ‰€æœ‰èŠ‚ç‚¹å®‰è£…Docker-kubeadm-kubelet"><a href="#æ‰€æœ‰èŠ‚ç‚¹å®‰è£…Docker-kubeadm-kubelet" class="headerlink" title="æ‰€æœ‰èŠ‚ç‚¹å®‰è£…Docker/kubeadm/kubelet"></a>æ‰€æœ‰èŠ‚ç‚¹å®‰è£…Docker/kubeadm/kubelet</h3><blockquote><p>Kubernetesé»˜è®¤CRIï¼ˆå®¹å™¨è¿è¡Œæ—¶ï¼‰ä¸ºDockerï¼Œå› æ­¤å…ˆå®‰è£…Dockerã€‚</p></blockquote><h4 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">$ yum -y install docker-ce-18.06.1.ce-3.el7</span><br><span class="line">$ systemctl <span class="built_in">enable</span> docker &amp;&amp; systemctl start docker</span><br><span class="line">$ docker --version</span><br><span class="line">Docker version 18.06.1-ce, build e68fc7a</span><br></pre></td></tr></table></figure><p>é•œåƒåŠ é€Ÿ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; /etc/docker/daemon.json &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;registry-mirrors&quot;: [&quot;https://reg-mirror.qiniu.com&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h4 id="kubeadm-kubelet-kubectl"><a href="#kubeadm-kubelet-kubectl" class="headerlink" title="kubeadm,kubelet,kubectl"></a>kubeadm,kubelet,kubectl</h4><p>å›½å†…é•œåƒä¸‹è½½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">repo_gpgcheck=0</span></span><br><span class="line"><span class="string">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>å®‰è£…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y kubelet-1.18.0 kubeadm-1.18.0 kubectl-1.18.0</span><br><span class="line">$ systemctl <span class="built_in">enable</span> kubelet</span><br></pre></td></tr></table></figure><h3 id="éƒ¨ç½²Kubernetes-Master"><a href="#éƒ¨ç½²Kubernetes-Master" class="headerlink" title="éƒ¨ç½²Kubernetes Master"></a>éƒ¨ç½²Kubernetes Master</h3><p>åœ¨192.168.58.11ï¼ˆMasterï¼‰æ‰§è¡Œã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm init \</span><br><span class="line">  --apiserver-advertise-address=192.168.58.11 \</span><br><span class="line">  --image-repository registry.aliyuncs.com/google_containers \</span><br><span class="line">  --kubernetes-version v1.18.0 \</span><br><span class="line">  --service-cidr=10.96.0.0/12 \</span><br><span class="line">  --pod-network-cidr=10.244.0.0/16</span><br></pre></td></tr></table></figure><blockquote><p>ç”±äºé»˜è®¤æ‹‰å–é•œåƒåœ°å€k8s.gcr.ioå›½å†…æ— æ³•è®¿é—®ï¼Œè¿™é‡ŒæŒ‡å®šé˜¿é‡Œäº‘é•œåƒä»“åº“åœ°å€ã€‚</p><p>pod-network-cidrä¸service-cidrè®¾ç½®ä¸åŒçš„ç½‘æ®µå³å¯ï¼Œä¸å¯ä¸æœ¬æœºç›¸å†²çªã€‚</p><p><font color="red"><strong>æ³¨æ„</strong>ï¼Œåªæœ‰ä¸€ä¸ªæ ¸å¿ƒæ˜¯ä¸èƒ½åˆå§‹åŒ–çš„ï¼ï¼ï¼</font></p></blockquote><p>è¿™æ¡å‘½ä»¤å°±æ˜¯æ‹‰å–kubernetesçš„å„ä¸ªç»„ä»¶çš„é•œåƒï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-11-16_21-08-35.png" alt="Snipaste_2020-11-16_21-08-35"></p><p><strong>Masteråˆå§‹åŒ–å®Œæˆåç”±æ­¤æç¤º</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-11-16_21-09-38.png" alt="Snipaste_2020-11-16_21-09-38"></p><p><strong>æ­¤æ—¶ï¼Œä½ çš„é›†ç¾¤è¿˜ä¸èƒ½ä½¿ç”¨ï¼Œä¸Šå›¾ä¸­è¿˜æœ‰æç¤ºä¿¡æ¯</strong></p><blockquote><p>To start using your cluster, you need to run the following as a regular user:</p></blockquote><p>ä½ éœ€è¦åœ¨Masteræ‰§è¡Œä¸€ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">$ sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">$ sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure><h3 id="åŠ å…¥Kubernetes-Node"><a href="#åŠ å…¥Kubernetes-Node" class="headerlink" title="åŠ å…¥Kubernetes Node"></a>åŠ å…¥Kubernetes Node</h3><p>ç”±Masteråˆå§‹åŒ–çš„ä¿¡æ¯å¯å¾—çŸ¥ï¼ŒNodeåŠ å…¥Masteré›†ç¾¤éœ€è¦æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.58.11:6443 --token bpx0wc.r7m0c9sp15cfu81r \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:3dd5733fa6ed0394a98b67c57fc512d6fe6776c7cb954a96673b24c8276cb885</span><br></pre></td></tr></table></figure><blockquote><p><font color="red">æ³¨æ„ï¼šä¸è¦å¤åˆ¶æˆ‘çš„tokenï¼Œä»ä½ çš„å‘½ä»¤è¡Œä¸­å¯»æ‰¾ï¼</font></p></blockquote><p><strong>ä¸¤ä¸ªnodeèŠ‚ç‚¹åŠ å…¥å®Œæˆä¹‹åï¼Œåœ¨MasteræŸ¥çœ‹èŠ‚ç‚¹</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-11-16_21-17-38.png" alt="Snipaste_2020-11-16_21-17-38"></p><p>å‘ç°ï¼Œä»–ä»¬çŠ¶æ€éƒ½æ˜¯<code>NotReady</code>ã€‚æ˜¯å› ä¸ºè¿˜æ²¡æœ‰é…ç½®æœ€åä¸€æ­¥ï¼šç½‘ç»œï¼</p><h3 id="éƒ¨ç½²CNIç½‘ç»œæ’ä»¶"><a href="#éƒ¨ç½²CNIç½‘ç»œæ’ä»¶" class="headerlink" title="éƒ¨ç½²CNIç½‘ç»œæ’ä»¶"></a>éƒ¨ç½²CNIç½‘ç»œæ’ä»¶</h3><p>MasterèŠ‚ç‚¹è¿è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure><p>é»˜è®¤é•œåƒåœ°å€æ— æ³•è®¿é—®ï¼Œsedå‘½ä»¤ä¿®æ”¹ä¸ºdocker hubé•œåƒä»“åº“ã€‚</p><p><strong>æŸ¥çœ‹æ˜¯å¦å®Œæˆ</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-11-16_21-25-16.png" alt="Snipaste_2020-11-16_21-25-16"></p><h3 id="æµ‹è¯•kubernetesé›†ç¾¤"><a href="#æµ‹è¯•kubernetesé›†ç¾¤" class="headerlink" title="æµ‹è¯•kubernetesé›†ç¾¤"></a>æµ‹è¯•kubernetesé›†ç¾¤</h3><p>åœ¨Kubernetesé›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ªpodï¼ŒéªŒè¯æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create deployment nginx --image=nginx</span><br><span class="line">$ kubectl expose deployment nginx --port=80 --<span class="built_in">type</span>=NodePort</span><br><span class="line">$ kubectl get pod,svc</span><br></pre></td></tr></table></figure><p>è®¿é—®ip:portï¼Œæˆ‘ä»¬å‘ç°ä¸‰å°æœºå™¨çš„è¿™ä¸ªç«¯å£éƒ½å¯ä»¥è®¿é—®åˆ°nginxã€‚</p><h2 id="äºŒè¿›åˆ¶éƒ¨ç½²"><a href="#äºŒè¿›åˆ¶éƒ¨ç½²" class="headerlink" title="äºŒè¿›åˆ¶éƒ¨ç½²"></a>äºŒè¿›åˆ¶éƒ¨ç½²</h2><p>ç•¥â€¦</p><h1 id="kubectlå‘½ä»¤è¡Œå·¥å…·"><a href="#kubectlå‘½ä»¤è¡Œå·¥å…·" class="headerlink" title="kubectlå‘½ä»¤è¡Œå·¥å…·"></a><code>kubectl</code>å‘½ä»¤è¡Œå·¥å…·</h1><p>kubectl æ˜¯ Kubernetes é›†ç¾¤çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œé€šè¿‡ kubectl èƒ½å¤Ÿ<font color="red">å¯¹é›†ç¾¤æœ¬èº«è¿›è¡Œç®¡ç†ï¼Œå¹¶èƒ½å¤Ÿåœ¨é›†ç¾¤ä¸Šè¿›è¡Œå®¹å™¨åŒ–åº”ç”¨çš„å®‰è£…éƒ¨ç½²ã€‚</font></p><blockquote><p><strong><code>kubectl </code>å‘½ä»¤çš„è¯­æ³•</strong></p><p><code>kubectl [command] [type] [name] [flag]</code></p><ul><li><p><strong>comand</strong>ï¼šæŒ‡å®šè¦å¯¹èµ„æºæ‰§è¡Œçš„æ“ä½œï¼Œä¾‹å¦‚ createã€getã€describe å’Œ delete</p></li><li><p><strong>TYPE</strong>ï¼šæŒ‡å®šèµ„æºç±»å‹ï¼Œèµ„æºç±»å‹æ˜¯å¤§å°å†™æ•æ„Ÿçš„ï¼Œå¼€å‘è€…èƒ½å¤Ÿä»¥å•æ•°ã€å¤æ•°å’Œç¼©ç•¥çš„å½¢å¼ã€‚ä¾‹å¦‚ï¼š</p><ul><li><code>kubectl get pod</code></li><li><code>kubectl get pods</code></li><li><code>kubectl get po</code></li></ul></li><li><p><strong>NAME</strong>ï¼šæŒ‡å®šèµ„æºçš„åç§°ï¼Œåç§°ä¹Ÿå¤§å°å†™æ•æ„Ÿçš„ã€‚å¦‚æœçœç•¥åç§°ï¼Œåˆ™ä¼šæ˜¾ç¤ºæ‰€æœ‰çš„èµ„æºï¼Œ ä¾‹å¦‚: <code>kubectl get pods</code></p></li><li><p><strong>flags</strong>ï¼šæŒ‡å®šå¯é€‰çš„å‚æ•°ã€‚ä¾‹å¦‚ï¼Œå¯ç”¨-s æˆ–è€…â€“server å‚æ•°æŒ‡å®š Kubernetes API </p><p>server çš„åœ°å€å’Œç«¯å£ã€‚ </p></li></ul></blockquote><p><strong>åŸºç¡€å‘½ä»¤</strong></p><table><thead><tr><th>å‘½ä»¤</th><th>æè¿°</th></tr></thead><tbody><tr><td>create</td><td>é€šè¿‡æ–‡ä»¶åæˆ–æ ‡å‡†è¾“å…¥åˆ›å»ºèµ„æº</td></tr><tr><td>expose</td><td>å°†ä¸€ä¸ªèµ„æºå…¬å¼€ä¸ºä¸€ä¸ªæ–°çš„Service</td></tr><tr><td>run</td><td>åœ¨é›†ç¾¤ä¸­è¿è¡Œä¸€ä¸ªç‰¹å®šçš„é•œåƒ</td></tr><tr><td>set</td><td>åœ¨å¯¹è±¡ä¸Šè®¾ç½®ç‰¹å®šçš„åŠŸèƒ½</td></tr><tr><td>get</td><td>æ˜¾ç¤ºä¸€ä¸ª/å¤šä¸ªèµ„æº</td></tr><tr><td>explain</td><td>æ–‡æ¡£å‚è€ƒèµ„æ–™</td></tr><tr><td>edit</td><td>ä½¿ç”¨é»˜è®¤çš„ç¼–è¾‘å™¨ç¼–è¾‘ä¸€ä¸ªèµ„æº</td></tr><tr><td>delete</td><td>é€šè¿‡æ–‡ä»¶åã€æ ‡å‡†è¾“å…¥ã€èµ„æºåç§°æˆ–æ ‡ç­¾é€‰æ‹©å™¨åˆ é™¤èµ„æº</td></tr></tbody></table><p><strong>éƒ¨ç½²å’Œé›†ç¾¤ç®¡ç†å‘½ä»¤</strong></p><table><thead><tr><th>å‘½ä»¤</th><th>æè¿°</th></tr></thead><tbody><tr><td>rollout</td><td>ç®¡ç†èµ„æºçš„å‘å¸ƒ</td></tr><tr><td>rolling-update</td><td>å¯¹ç»™å®šçš„å¤åˆ¶æ§åˆ¶å™¨æ»šåŠ¨æ›´æ–°</td></tr><tr><td>scale</td><td>æ‰©å®¹æˆ–ç¼©å®¹Podæ•°é‡ï¼ŒDeploymentã€ReplicaSetã€RCæˆ–Job</td></tr><tr><td>autoscale</td><td>åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨é€‰æ‹©æ‰©å®¹æˆ–ç¼©å®¹å¹¶è®¾ç½®Podæ•°é‡</td></tr><tr><td>certificate</td><td>ä¿®æ”¹è¯ä¹¦èµ„æº</td></tr><tr><td>cluster-info</td><td>æ˜¾ç¤ºé›†ç¾¤ä¿¡æ¯</td></tr><tr><td>top</td><td>æ˜¾ç¤ºèµ„æºä½¿ç”¨</td></tr><tr><td>cordon</td><td>æ ‡è®°èŠ‚ç‚¹ä¸å¯è°ƒåº¦</td></tr><tr><td>uncordon</td><td>æ ‡è®°èŠ‚ç‚¹å¯è°ƒåº¦</td></tr><tr><td>drain</td><td>é©±é€èŠ‚ç‚¹ä¸Šçš„åº”ç”¨ï¼Œå‡†å¤‡ä¸‹çº¿ç»´æŠ¤</td></tr><tr><td>taint</td><td>ä¿®æ”¹èŠ‚ç‚¹taintæ ‡è®°</td></tr></tbody></table><p><strong>æ•…éšœå’Œè°ƒè¯•å‘½ä»¤</strong></p><table><thead><tr><th>å‘½ä»¤</th><th>æè¿°</th></tr></thead><tbody><tr><td>exec</td><td>æ‰§è¡Œå‘½ä»¤åˆ°å®¹å™¨</td></tr></tbody></table><h1 id="kubernetes-é›†ç¾¤YAMLæ–‡ä»¶è¯¦è§£"><a href="#kubernetes-é›†ç¾¤YAMLæ–‡ä»¶è¯¦è§£" class="headerlink" title="kubernetes é›†ç¾¤YAMLæ–‡ä»¶è¯¦è§£"></a>kubernetes é›†ç¾¤YAMLæ–‡ä»¶è¯¦è§£</h1><p>k8såœ¨å¯åŠ¨èµ„æºæ—¶æœ‰è¯¸å¤šé…ç½®ï¼Œå…¨å†™åœ¨å‘½ä»¤è¡Œé‡Œå¾ˆä¸æ–¹ä¾¿ã€‚æ‰€ä»¥å¯ä»¥é€šè¿‡yamlæ–‡ä»¶é…ç½®ï¼Œåœ¨è¿è¡Œæ—¶åªç”¨æŒ‡å®šä¸€ä¸ªyamlæ–‡ä»¶å³å¯</p><blockquote><p>yamlä¹¦å†™æ ¼å¼</p><ul><li>ä½¿ç”¨ç©ºæ ¼åšä¸ºç¼©è¿›</li><li>ç¼©è¿›çš„ç©ºæ ¼æ•°ç›®ä¸é‡è¦ï¼Œåªè¦ç›¸åŒå±‚çº§çš„å…ƒç´ å·¦ä¾§å¯¹é½å³å¯</li><li>ä½ç‰ˆæœ¬ç¼©è¿›æ—¶ä¸å…è®¸ä½¿ç”¨ Tab é”®ï¼Œåªå…è®¸ä½¿ç”¨ç©ºæ ¼ </li><li>ä½¿ç”¨#æ ‡è¯†æ³¨é‡Šï¼Œä»è¿™ä¸ªå­—ç¬¦ä¸€ç›´åˆ°è¡Œå°¾ï¼Œéƒ½ä¼šè¢«è§£é‡Šå™¨å¿½ç•¥</li></ul></blockquote><hr><p>åœ¨ k8s ä¸­ï¼Œä¸€èˆ¬ä½¿ç”¨ YAML æ ¼å¼çš„æ–‡ä»¶æ¥åˆ›å»ºç¬¦åˆæˆ‘ä»¬é¢„æœŸæœŸæœ›çš„ pod,è¿™æ ·çš„ YAML æ–‡ä»¶ç§°ä¸º<strong>èµ„æºæ¸…å•</strong></p><h2 id="å¸¸ç”¨å­—æ®µ"><a href="#å¸¸ç”¨å­—æ®µ" class="headerlink" title="å¸¸ç”¨å­—æ®µ"></a>å¸¸ç”¨å­—æ®µ</h2><p><font color="red"><strong>å¿…é¡»å­˜åœ¨çš„å±æ€§</strong></font></p><table><thead><tr><th>å‚æ•°å</th><th>å­—æ®µç±»å‹</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>version</td><td>String</td><td>k8sçš„APIç‰ˆæœ¬ï¼Œé€šè¿‡<code>kubectl api-version</code>æŸ¥è¯¢</td></tr><tr><td>kind</td><td>String</td><td>æ–‡ä»¶å®šä¹‰çš„èµ„æºç±»å‹å’Œè§’è‰²ï¼Œæ¯”å¦‚ï¼šPod</td></tr><tr><td>metadata</td><td>Object</td><td>å…ƒæ•°æ®å¯¹è±¡ï¼Œå›ºå®šå€¼ä¸º<code>metadata</code></td></tr><tr><td>metadata.name</td><td>String</td><td>å…ƒæ•°æ®å¯¹è±¡çš„åå­—ï¼Œæœ‰æˆ‘ä»¬ç¼–å†™ï¼Œæ¯”å¦‚å‘½åPodçš„åå­—</td></tr><tr><td>metadata.namespace</td><td>String</td><td>å…ƒæ•°æ®å¯¹è±¡çš„å‘½åç©ºé—´ï¼Œè‡ªå®šä¹‰</td></tr><tr><td>Spec</td><td>Object</td><td>è¯¦ç»†å®šä¹‰å¯¹è±¡ï¼Œå›ºå®šå€¼å†™Spec</td></tr><tr><td>spec.container[]</td><td>list</td><td>å®¹å™¨åˆ—è¡¨å®šä¹‰ï¼Œå¤šä¸ªå®¹å™¨</td></tr><tr><td>spec.container[].name</td><td>String</td><td>å®¹å™¨å</td></tr><tr><td>spec.container[].image</td><td>String</td><td>å®¹å™¨ä½¿ç”¨çš„é•œåƒ</td></tr></tbody></table><p><strong>åˆ›å»ºNameSpace</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test</span></span><br></pre></td></tr></table></figure><p><strong>åˆ›å»ºPod</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-containers</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br></pre></td></tr></table></figure><h2 id="å¿«é€Ÿç¼–å†™yamlğŸ”º"><a href="#å¿«é€Ÿç¼–å†™yamlğŸ”º" class="headerlink" title="å¿«é€Ÿç¼–å†™yamlğŸ”º"></a>å¿«é€Ÿç¼–å†™yamlğŸ”º</h2><h3 id="ä»å¯åŠ¨èµ„æºå‘½ä»¤ä¸­å¯¼å‡ºyaml"><a href="#ä»å¯åŠ¨èµ„æºå‘½ä»¤ä¸­å¯¼å‡ºyaml" class="headerlink" title="ä»å¯åŠ¨èµ„æºå‘½ä»¤ä¸­å¯¼å‡ºyaml"></a>ä»å¯åŠ¨èµ„æºå‘½ä»¤ä¸­å¯¼å‡ºyaml</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create deployment web --image=nginx -o yaml --dry-run &gt; xxx.yaml</span><br></pre></td></tr></table></figure><blockquote><p>å¦‚æœä¸å†™<code>--dry-run</code>ï¼ŒPodçœŸä¼šè¿è¡Œã€‚å†™äº†åˆ™ä¸ä¼šè¿è¡Œï¼Œåªæ˜¯å¯¼å‡ºæ¨¡æ¿</p></blockquote><h3 id="ä»æ­£åœ¨è¿è¡Œçš„èµ„æºä¸­å¯¼å‡ºyaml"><a href="#ä»æ­£åœ¨è¿è¡Œçš„èµ„æºä¸­å¯¼å‡ºyaml" class="headerlink" title="ä»æ­£åœ¨è¿è¡Œçš„èµ„æºä¸­å¯¼å‡ºyaml"></a>ä»æ­£åœ¨è¿è¡Œçš„èµ„æºä¸­å¯¼å‡ºyaml</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get deploy xxx -o=yaml --<span class="built_in">export</span> &gt; xxx.yaml</span><br></pre></td></tr></table></figure><blockquote><p>æ­¤æ–¹å¼å¯¼å‡ºçš„yamlä¼šå¾ˆè¯¦ç»†ï¼Œå› ä¸ºæ˜¯å·²ç»éƒ¨ç½²å¥½çš„ç‰ˆæœ¬çš„yaml</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Kubernetes&quot;&gt;&lt;a href=&quot;#Kubernetes&quot; class=&quot;headerlink&quot; title=&quot;Kubernetes&quot;&gt;&lt;/a&gt;Kubernetes&lt;/h1&gt;&lt;h2 id=&quot;Kubernetesæ¦‚è¿°&quot;&gt;&lt;a href=&quot;#Kubernete</summary>
      
    
    
    
    <category term="Kubernetes" scheme="https://awslzhang.top/categories/Kubernetes/"/>
    
    
    <category term="Docker" scheme="https://awslzhang.top/tags/Docker/"/>
    
    <category term="Kubernetes" scheme="https://awslzhang.top/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Compose</title>
    <link href="https://awslzhang.top/2020/11/14/Compose/"/>
    <id>https://awslzhang.top/2020/11/14/Compose/</id>
    <published>2020-11-14T15:27:41.000Z</published>
    <updated>2021-01-01T05:49:59.916Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h1><p><code>Compose</code> é¡¹ç›®æ˜¯ <strong>Docker å®˜æ–¹çš„å¼€æºé¡¹ç›®</strong>ï¼Œè´Ÿè´£å®ç°<font color="red">å¯¹Docker å®¹å™¨é›†ç¾¤çš„å¿«é€Ÿç¼–æ’</font>ï¼Œéœ€è¦é¢å¤–å®‰è£…ã€‚ä»åŠŸèƒ½ä¸Šçœ‹ï¼Œè·Ÿ <code>OpenStack</code> ä¸­çš„ <code>Heat</code> ååˆ†ç±»ä¼¼ã€‚</p><p>å…¶ä»£ç ç›®å‰åœ¨ <a href="https://github.com/docker/compose">https://github.com/docker/compose</a> ä¸Šå¼€æºã€‚</p><p><code>Compose</code> å®šä½æ˜¯ ã€Œå®šä¹‰å’Œè¿è¡Œå¤šä¸ª Docker å®¹å™¨çš„åº”ç”¨ï¼ˆDefining and running multi-container Docker applicationsï¼‰ã€ï¼Œå…¶å‰èº«æ˜¯å¼€æºé¡¹ç›® Figã€‚</p><blockquote><p>å®˜æ–¹ä»‹ç»ï¼š</p><p>Compose is a tool for defining and running multi-container Docker applications. With Compose, you use a YAML file to configure your applicationâ€™s services. Then, with a single command, you create and start all the services from your configuration. To learn more about all the features of Compose, see <a href="https://docs.docker.com/compose/#features">the list of features</a>.</p><p>Compose works in all environments: production, staging, development, testing, as well as CI workflows. You can learn more about each case in <a href="https://docs.docker.com/compose/#common-use-cases">Common Use Cases</a>.</p><p>Using Compose is basically a three-step process:</p><ol><li>Define your appâ€™s environment with a <code>Dockerfile</code> so it can be reproduced anywhere.</li><li>Define the services that make up your app in <code>docker-compose.yml</code> so they can be run together in an isolated environment.</li><li>Run <code>docker-compose up</code> and Compose starts and runs your entire app.</li></ol><p>ç¿»è¯‘ï¼š</p><p>Composeæ˜¯ç”¨äºå®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨Dockeråº”ç”¨ç¨‹åºçš„å·¥å…·ã€‚é€šè¿‡Composeï¼Œæ‚¨å¯ä»¥<font color="red">ä½¿ç”¨YAMLæ–‡ä»¶æ¥é…ç½®åº”ç”¨ç¨‹åºçš„æœåŠ¡</font>ã€‚ç„¶åï¼Œä½¿ç”¨ä¸€ä¸ªå‘½ä»¤ï¼Œå°±å¯ä»¥<font color="red">ä»é…ç½®ä¸­åˆ›å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡</font>ã€‚è¦äº†è§£æœ‰å…³Composeçš„æ‰€æœ‰åŠŸèƒ½çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…<a href="https://docs.docker.com/compose/#features">åŠŸèƒ½åˆ—è¡¨</a>ã€‚</p><p>Composeå¯åœ¨æ‰€æœ‰ç¯å¢ƒä¸­å·¥ä½œï¼šç”Ÿäº§ï¼Œç™»å°ï¼Œå¼€å‘ï¼Œæµ‹è¯•ä»¥åŠCIå·¥ä½œæµã€‚æ‚¨å¯ä»¥åœ¨â€œ<a href="https://docs.docker.com/compose/#common-use-cases">å¸¸è§ç”¨ä¾‹â€ä¸­</a>äº†è§£æœ‰å…³æ¯ç§æƒ…å†µçš„æ›´å¤šä¿¡æ¯ã€‚</p><p><strong>ä½¿ç”¨ComposeåŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªä¸‰æ­¥è¿‡ç¨‹</strong>ï¼š</p><ol><li>ä½¿ç”¨å®šä¹‰æ‚¨çš„åº”ç”¨ç¯å¢ƒï¼Œ<font color="red"><code>Dockerfile</code></font>ä»¥ä¾¿å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹å¤åˆ¶ã€‚</li><li>å®šä¹‰ç»„æˆåº”ç”¨ç¨‹åºçš„æœåŠ¡ï¼Œ<font color="red"><code>docker-compose.yml</code></font> ä»¥ä¾¿å®ƒä»¬å¯ä»¥åœ¨éš”ç¦»çš„ç¯å¢ƒä¸­ä¸€èµ·è¿è¡Œã€‚<ol><li>é…ç½®æ–‡ä»¶ä¸­é…ç½®å¤šä¸ªæœåŠ¡(<code>Services</code>)</li></ol></li><li>Run <font color="red"><code>docker-compose up</code></font>and Composeå¯åŠ¨å¹¶è¿è¡Œæ‚¨çš„æ•´ä¸ªåº”ç”¨ç¨‹åºã€‚</li></ol></blockquote><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>æˆ‘ä»¬çŸ¥é“ä½¿ç”¨ä¸€ä¸ª <code>Dockerfile</code> æ¨¡æ¿æ–‡ä»¶ï¼Œå¯ä»¥è®©ç”¨æˆ·å¾ˆæ–¹ä¾¿çš„å®šä¹‰ä¸€ä¸ªå•ç‹¬çš„åº”ç”¨å®¹å™¨ã€‚ç„¶è€Œï¼Œåœ¨æ—¥å¸¸å·¥ä½œä¸­ï¼Œç»å¸¸ä¼šç¢°åˆ°éœ€è¦å¤šä¸ªå®¹å™¨ç›¸äº’é…åˆæ¥å®ŒæˆæŸé¡¹ä»»åŠ¡çš„æƒ…å†µã€‚ä¾‹å¦‚è¦å®ç°ä¸€ä¸ª Web é¡¹ç›®ï¼Œé™¤äº† Web æœåŠ¡å®¹å™¨æœ¬èº«ï¼Œå¾€å¾€è¿˜éœ€è¦å†åŠ ä¸Šåç«¯çš„æ•°æ®åº“æœåŠ¡å®¹å™¨ï¼Œç”šè‡³è¿˜åŒ…æ‹¬è´Ÿè½½å‡è¡¡å®¹å™¨ç­‰ã€‚</p><p><code>Compose</code> æ°å¥½æ»¡è¶³äº†è¿™æ ·çš„éœ€æ±‚ã€‚å®ƒå…è®¸ç”¨æˆ·é€šè¿‡ä¸€ä¸ªå•ç‹¬çš„ <code>docker-compose.yml</code> æ¨¡æ¿æ–‡ä»¶ï¼ˆYAML æ ¼å¼ï¼‰æ¥å®šä¹‰ä¸€ç»„ç›¸å…³è”çš„åº”ç”¨å®¹å™¨ä¸ºä¸€ä¸ªé¡¹ç›®ï¼ˆprojectï¼‰ã€‚</p><p><code>Compose</code> ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼š</p><ul><li>æœåŠ¡ (<code>service</code>)ï¼šä¸€ä¸ªåº”ç”¨çš„å®¹å™¨ï¼Œå®é™…ä¸Šå¯ä»¥åŒ…æ‹¬è‹¥å¹²è¿è¡Œç›¸åŒé•œåƒçš„å®¹å™¨å®ä¾‹ã€‚</li><li>é¡¹ç›® (<code>project</code>)ï¼šç”±ä¸€ç»„å…³è”çš„åº”ç”¨å®¹å™¨ç»„æˆçš„ä¸€ä¸ªå®Œæ•´ä¸šåŠ¡å•å…ƒï¼Œåœ¨ <code>docker-compose.yml</code> æ–‡ä»¶ä¸­å®šä¹‰ã€‚</li></ul><p><code>Compose</code> çš„é»˜è®¤ç®¡ç†å¯¹è±¡æ˜¯é¡¹ç›®ï¼Œé€šè¿‡å­å‘½ä»¤å¯¹é¡¹ç›®ä¸­çš„ä¸€ç»„å®¹å™¨è¿›è¡Œä¾¿æ·åœ°ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚</p><p><code>Compose</code> é¡¹ç›®ç”± Python ç¼–å†™ï¼Œå®ç°ä¸Šè°ƒç”¨äº† Docker æœåŠ¡æä¾›çš„ API æ¥å¯¹å®¹å™¨è¿›è¡Œç®¡ç†ã€‚å› æ­¤ï¼Œåªè¦æ‰€æ“ä½œçš„å¹³å°æ”¯æŒ Docker APIï¼Œå°±å¯ä»¥åœ¨å…¶ä¸Šåˆ©ç”¨ <code>Compose</code> æ¥è¿›è¡Œç¼–æ’ç®¡ç†ã€‚</p><p>ä½¿ç”¨<code>DockerCompose</code>å¯ä»¥ç®€åŒ–æˆ‘ä»¬çš„æ“ä½œï¼Œä¾‹å¦‚ï¼š</p><p>ä¸€ä¸ª<code>docker-compose.yml</code>çœ‹èµ·æ¥åƒè¿™æ ·ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;5000:5000&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">.:/code</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">logvolume01:/var/log</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">logvolume01:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>åŒæ—¶éƒ¨ç½²äº†<code>web</code>å’Œ<code>redis</code>æœåŠ¡ï¼</p><blockquote><p>å®é™…ç”Ÿäº§ç¯å¢ƒä¸ä¼šç›´æ¥é‡‡ç”¨dockerçš„ï¼Œéœ€è¦é‡‡ç”¨docker-composeï¼›å¦‚æœæ˜¯åˆ†å¸ƒå¼å¤šå°æœåŠ¡å™¨å¯èƒ½éœ€è¦k8sã€‚</p></blockquote><h2 id="å®‰è£…ä¸å¸è½½"><a href="#å®‰è£…ä¸å¸è½½" class="headerlink" title="å®‰è£…ä¸å¸è½½"></a>å®‰è£…ä¸å¸è½½</h2><p><code>Compose</code> æ”¯æŒ Linuxã€macOSã€Windows 10 ä¸‰å¤§å¹³å°ã€‚</p><p><code>Compose</code> å¯ä»¥é€šè¿‡ Python çš„åŒ…ç®¡ç†å·¥å…· <code>pip</code> è¿›è¡Œå®‰è£…ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä¸‹è½½ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ä½¿ç”¨ï¼Œç”šè‡³èƒ½å¤Ÿç›´æ¥åœ¨ Docker å®¹å™¨ä¸­è¿è¡Œã€‚</p><p><code>Docker Desktop for Mac/Windows</code> è‡ªå¸¦ <code>docker-compose</code> äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå®‰è£… Docker ä¹‹åå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚</p><p><strong>éªŒè¯å®‰è£…</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose version</span><br><span class="line">docker-compose version 1.25.5, build 8a1c60f6</span><br><span class="line">docker-py version: 4.1.0</span><br><span class="line">CPython version: 3.7.5</span><br><span class="line">OpenSSL version: OpenSSL 1.1.0l  10 Sep 2019</span><br></pre></td></tr></table></figure><h3 id="äºŒè¿›åˆ¶åŒ…å®‰è£…"><a href="#äºŒè¿›åˆ¶åŒ…å®‰è£…" class="headerlink" title="äºŒè¿›åˆ¶åŒ…å®‰è£…"></a>äºŒè¿›åˆ¶åŒ…å®‰è£…</h3><p>åœ¨ Linux ä¸Šçš„ä¹Ÿå®‰è£…ååˆ†ç®€å•ï¼Œä» <a href="https://github.com/docker/compose/releases">å®˜æ–¹ GitHub Release</a> å¤„ç›´æ¥ä¸‹è½½ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶å³å¯ã€‚</p><p>ä¾‹å¦‚ï¼Œåœ¨ Linux 64 ä½ç³»ç»Ÿä¸Šç›´æ¥ä¸‹è½½å¯¹åº”çš„äºŒè¿›åˆ¶åŒ…ã€‚</p><ol><li>ä¸‹è½½äºŒè¿›åˆ¶åŒ…</li><li>èµ‹äºˆäºŒè¿›åˆ¶åŒ…çš„æ‰§è¡Œæƒé™</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo curl -L https://github.com/docker/compose/releases/download/1.25.5/docker-compose-`uname -s`-`uname -m` &gt; /usr/<span class="built_in">local</span>/bin/docker-compose</span><br><span class="line"></span><br><span class="line">$ sudo chmod +x /usr/<span class="built_in">local</span>/bin/docker-compose</span><br></pre></td></tr></table></figure><h3 id="PIPå®‰è£…"><a href="#PIPå®‰è£…" class="headerlink" title="PIPå®‰è£…"></a>PIPå®‰è£…</h3><blockquote><p><em>æ³¨ï¼š</em> <code>x86_64</code> æ¶æ„çš„ Linux å»ºè®®æŒ‰ç…§ä¸Šè¾¹çš„æ–¹æ³•ä¸‹è½½äºŒè¿›åˆ¶åŒ…è¿›è¡Œå®‰è£…ï¼Œå¦‚æœæ‚¨è®¡ç®—æœºçš„æ¶æ„æ˜¯ <code>ARM</code> (ä¾‹å¦‚ï¼Œæ ‘è“æ´¾)ï¼Œå†ä½¿ç”¨ <code>pip</code> å®‰è£…ã€‚</p></blockquote><blockquote><p>æ—¢ç„¶è¯´åˆ°æ¶æ„ï¼Œè¿™é‡Œæ™®åŠä¸€ä¸‹ï¼š</p><ul><li><code>X86</code>æ˜¯Intelå¼€å‘çš„ä¸€ç§32ä½æŒ‡ä»¤é›†ï¼Œæ—©æœŸIntelå’Œamdçš„cpuéƒ½æ”¯æŒè¿™ç§æŒ‡ä»¤é›†</li><li><code>amd64</code>æ˜¯CPUè¿ˆå‘64ä½çš„æ—¶å€™ï¼Œç”±ADMç‡å…ˆåˆ¶é€ å‡ºäº†å…¼å®¹X86çš„CPUï¼ŒAMDç§°ä¹‹ä¸ºamd64</li><li><code>x64</code>ï¼šå½“æ—¶å› ä¸ºå…¼å®¹x86çš„CPUæ¶æ„è¢«amdç‡å…ˆå¼€å‘ï¼Œæ‰€ä»¥intelé€‰æ‹©äº†è®¾è®¡ä¸€ç§å…¨æ–°çš„æŒ‡ä»¤é›†x64ï¼Œä½†æ˜¯å¥½åƒè¢«å‘äº†ï¼Œåæ¥åœ¨ä¸å¾—ä¸åœ¨æ—¶æœºè½åçš„æƒ…å†µä¸‹ä¹Ÿå¼€å§‹æ”¯æŒäº†amd64æŒ‡ä»¤é›†ï¼Œä½†æ˜¯æ¢äº†ä¸ªåå­—å«<code>X86_64</code>ï¼›</li><li><code>arm</code>ï¼šè¿‡å»ç§°ä½œ<strong>é«˜çº§ç²¾ç®€æŒ‡ä»¤é›†æœºå™¨</strong>ï¼ŒARMå¤„ç†å™¨éå¸¸é€‚ç”¨äº<a href="https://zh.wikipedia.org/wiki/%E8%A1%8C%E5%8B%95%E9%80%9A%E8%A8%8A">ç§»åŠ¨é€šä¿¡</a>é¢†åŸŸï¼Œç¬¦åˆå…¶ä¸»è¦è®¾è®¡ç›®æ ‡ä¸ºä½æˆæœ¬ã€é«˜æ€§èƒ½ã€ä½è€—ç”µçš„ç‰¹æ€§ã€‚æ‰€ä»¥å¸¸ç”¨äºæ‰‹æœºï¼Œæ½œå…¥è®¾å¤‡(æ ‘è“æ´¾)ã€‚</li></ul><p>æ‰€ä»¥ï¼Œ<code>amd64</code>ã€<code>x64</code>ã€<code>X86_64</code>æ˜¯ä¸€ç§ä¸œè¥¿ã€‚</p></blockquote><p>è¿™ç§æ–¹å¼æ˜¯å°† Compose å½“ä½œä¸€ä¸ª Python åº”ç”¨æ¥ä» pip æºä¸­å®‰è£…ã€‚</p><p>æ‰§è¡Œå®‰è£…å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo pip install -U docker-compose</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹è¾“å‡ºï¼Œè¯´æ˜å®‰è£…æˆåŠŸã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Collecting docker-compose</span><br><span class="line">  Downloading docker-compose-1.25.5.tar.gz (149kB): 149kB downloaded</span><br><span class="line">...</span><br><span class="line">Successfully installed docker-compose cached-property requests texttable websocket-client docker-py dockerpty six enum34 backports.ssl-match-hostname ipaddress</span><br></pre></td></tr></table></figure><h3 id="å¸è½½"><a href="#å¸è½½" class="headerlink" title="å¸è½½"></a>å¸è½½</h3><p>å¦‚æœæ˜¯äºŒè¿›åˆ¶åŒ…æ–¹å¼å®‰è£…çš„ï¼Œåˆ é™¤äºŒè¿›åˆ¶æ–‡ä»¶å³å¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo rm /usr/<span class="built_in">local</span>/bin/docker-compose</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯é€šè¿‡ <code>pip</code> å®‰è£…çš„ï¼Œåˆ™æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å³å¯åˆ é™¤ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo pip uninstall docker-compose</span><br></pre></td></tr></table></figure><h2 id="å‘½ä»¤è¯´æ˜"><a href="#å‘½ä»¤è¯´æ˜" class="headerlink" title="å‘½ä»¤è¯´æ˜"></a>å‘½ä»¤è¯´æ˜</h2><h3 id="å‘½ä»¤å¯¹è±¡ä¸æ ¼å¼"><a href="#å‘½ä»¤å¯¹è±¡ä¸æ ¼å¼" class="headerlink" title="å‘½ä»¤å¯¹è±¡ä¸æ ¼å¼"></a>å‘½ä»¤å¯¹è±¡ä¸æ ¼å¼</h3><p>å¯¹äº Compose æ¥è¯´ï¼Œå¤§éƒ¨åˆ†å‘½ä»¤çš„å¯¹è±¡æ—¢å¯ä»¥æ˜¯é¡¹ç›®æœ¬èº«ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šä¸ºé¡¹ç›®ä¸­çš„æœåŠ¡æˆ–è€…å®¹å™¨ã€‚å¦‚æœæ²¡æœ‰ç‰¹åˆ«çš„è¯´æ˜ï¼Œå‘½ä»¤å¯¹è±¡å°†æ˜¯é¡¹ç›®ï¼Œè¿™æ„å‘³ç€é¡¹ç›®ä¸­æ‰€æœ‰çš„æœåŠ¡éƒ½ä¼šå—åˆ°å‘½ä»¤å½±å“ã€‚</p><p>æ‰§è¡Œ <code>docker-compose [COMMAND] --help</code> æˆ–è€… <code>docker-compose help [COMMAND]</code> å¯ä»¥æŸ¥çœ‹å…·ä½“æŸä¸ªå‘½ä»¤çš„ä½¿ç”¨æ ¼å¼ã€‚</p><p><code>docker-compose</code> å‘½ä»¤çš„åŸºæœ¬çš„ä½¿ç”¨æ ¼å¼æ˜¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose [-f&#x3D;&lt;arg&gt;...] [options] [COMMAND] [ARGS...]</span><br></pre></td></tr></table></figure><h3 id="å‘½ä»¤é€‰é¡¹"><a href="#å‘½ä»¤é€‰é¡¹" class="headerlink" title="å‘½ä»¤é€‰é¡¹"></a>å‘½ä»¤é€‰é¡¹</h3><ul><li><code>-f, --file FILE</code> æŒ‡å®šä½¿ç”¨çš„ Compose æ¨¡æ¿æ–‡ä»¶ï¼Œé»˜è®¤ä¸º <code>docker-compose.yml</code>ï¼Œå¯ä»¥å¤šæ¬¡æŒ‡å®šã€‚</li><li><code>-p, --project-name NAME</code> æŒ‡å®šé¡¹ç›®åç§°ï¼Œé»˜è®¤å°†ä½¿ç”¨æ‰€åœ¨ç›®å½•åç§°ä½œä¸ºé¡¹ç›®åã€‚</li><li><code>--verbose</code> è¾“å‡ºæ›´å¤šè°ƒè¯•ä¿¡æ¯ã€‚</li><li><code>-v, --version</code> æ‰“å°ç‰ˆæœ¬å¹¶é€€å‡ºã€‚</li></ul><h3 id="å‘½ä»¤ä½¿ç”¨è¯´æ˜"><a href="#å‘½ä»¤ä½¿ç”¨è¯´æ˜" class="headerlink" title="å‘½ä»¤ä½¿ç”¨è¯´æ˜"></a>å‘½ä»¤ä½¿ç”¨è¯´æ˜</h3><h4 id="build"><a href="#build" class="headerlink" title="build"></a><code>build</code></h4><p>æ ¼å¼ä¸º <code>docker-compose build [options] [SERVICE...]</code>ã€‚</p><p>æ„å»ºï¼ˆé‡æ–°æ„å»ºï¼‰é¡¹ç›®ä¸­çš„æœåŠ¡å®¹å™¨ã€‚</p><p>æœåŠ¡å®¹å™¨ä¸€æ—¦æ„å»ºåï¼Œå°†ä¼šå¸¦ä¸Šä¸€ä¸ªæ ‡è®°åï¼Œä¾‹å¦‚å¯¹äº web é¡¹ç›®ä¸­çš„ä¸€ä¸ª db å®¹å™¨ï¼Œå¯èƒ½æ˜¯ web_dbã€‚</p><p>å¯ä»¥éšæ—¶åœ¨é¡¹ç›®ç›®å½•ä¸‹è¿è¡Œ <code>docker-compose build</code> æ¥é‡æ–°æ„å»ºæœåŠ¡ã€‚</p><p>é€‰é¡¹åŒ…æ‹¬ï¼š</p><ul><li><code>--force-rm</code> åˆ é™¤æ„å»ºè¿‡ç¨‹ä¸­çš„ä¸´æ—¶å®¹å™¨ã€‚</li><li><code>--no-cache</code> æ„å»ºé•œåƒè¿‡ç¨‹ä¸­ä¸ä½¿ç”¨ cacheï¼ˆè¿™å°†åŠ é•¿æ„å»ºè¿‡ç¨‹ï¼‰ã€‚</li><li><code>--pull</code> å§‹ç»ˆå°è¯•é€šè¿‡ pull æ¥è·å–æ›´æ–°ç‰ˆæœ¬çš„é•œåƒã€‚</li></ul><h4 id="config"><a href="#config" class="headerlink" title="config"></a><code>config</code></h4><p>éªŒè¯ Compose æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œè‹¥æ­£ç¡®åˆ™æ˜¾ç¤ºé…ç½®ï¼Œè‹¥æ ¼å¼é”™è¯¯æ˜¾ç¤ºé”™è¯¯åŸå› ã€‚</p><h4 id="down"><a href="#down" class="headerlink" title="down"></a><code>down</code></h4><p>æ­¤å‘½ä»¤å°†ä¼šåœæ­¢ <code>up</code> å‘½ä»¤æ‰€å¯åŠ¨çš„å®¹å™¨ï¼Œå¹¶ç§»é™¤ç½‘ç»œ</p><h4 id="exec"><a href="#exec" class="headerlink" title="exec"></a><code>exec</code></h4><p>è¿›å…¥æŒ‡å®šçš„å®¹å™¨ã€‚</p><h4 id="help"><a href="#help" class="headerlink" title="help"></a><code>help</code></h4><p>è·å¾—ä¸€ä¸ªå‘½ä»¤çš„å¸®åŠ©ã€‚</p><h4 id="images"><a href="#images" class="headerlink" title="images"></a><code>images</code></h4><p>åˆ—å‡º Compose æ–‡ä»¶ä¸­åŒ…å«çš„é•œåƒã€‚</p><h4 id="logs"><a href="#logs" class="headerlink" title="logs"></a><code>logs</code></h4><p>æ ¼å¼ä¸º <code>docker-compose logs [options] [SERVICE...]</code>ã€‚</p><p>æŸ¥çœ‹æœåŠ¡å®¹å™¨çš„è¾“å‡ºã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œdocker-compose å°†å¯¹ä¸åŒçš„æœåŠ¡è¾“å‡ºä½¿ç”¨ä¸åŒçš„é¢œè‰²æ¥åŒºåˆ†ã€‚å¯ä»¥é€šè¿‡ <code>--no-color</code> æ¥å…³é—­é¢œè‰²ã€‚</p><p>è¯¥å‘½ä»¤åœ¨è°ƒè¯•é—®é¢˜çš„æ—¶å€™ååˆ†æœ‰ç”¨ã€‚</p><h4 id="ps"><a href="#ps" class="headerlink" title="ps"></a><code>ps</code></h4><p>æ ¼å¼ä¸º <code>docker-compose ps [options] [SERVICE...]</code>ã€‚</p><p>åˆ—å‡ºé¡¹ç›®ä¸­ç›®å‰çš„æ‰€æœ‰å®¹å™¨ã€‚</p><p>é€‰é¡¹ï¼š</p><ul><li><code>-q</code> åªæ‰“å°å®¹å™¨çš„ ID ä¿¡æ¯ã€‚</li></ul><h4 id="restart"><a href="#restart" class="headerlink" title="restart"></a><code>restart</code></h4><p>æ ¼å¼ä¸º <code>docker-compose restart [options] [SERVICE...]</code>ã€‚</p><p>é‡å¯é¡¹ç›®ä¸­çš„æœåŠ¡ã€‚</p><p>é€‰é¡¹ï¼š</p><ul><li><code>-t, --timeout TIMEOUT</code> æŒ‡å®šé‡å¯å‰åœæ­¢å®¹å™¨çš„è¶…æ—¶ï¼ˆé»˜è®¤ä¸º 10 ç§’ï¼‰ã€‚</li></ul><h4 id="rm"><a href="#rm" class="headerlink" title="rm"></a><code>rm</code></h4><p>æ ¼å¼ä¸º <code>docker-compose rm [options] [SERVICE...]</code>ã€‚</p><p>åˆ é™¤æ‰€æœ‰ï¼ˆåœæ­¢çŠ¶æ€çš„ï¼‰æœåŠ¡å®¹å™¨ã€‚æ¨èå…ˆæ‰§è¡Œ <code>docker-compose stop</code> å‘½ä»¤æ¥åœæ­¢å®¹å™¨ã€‚</p><p>é€‰é¡¹ï¼š</p><ul><li><code>-f, --force</code> å¼ºåˆ¶ç›´æ¥åˆ é™¤ï¼ŒåŒ…æ‹¬éåœæ­¢çŠ¶æ€çš„å®¹å™¨ã€‚ä¸€èˆ¬å°½é‡ä¸è¦ä½¿ç”¨è¯¥é€‰é¡¹ã€‚</li><li><code>-v</code> åˆ é™¤å®¹å™¨æ‰€æŒ‚è½½çš„æ•°æ®å·ã€‚</li></ul><h4 id="start"><a href="#start" class="headerlink" title="start"></a><code>start</code></h4><p>æ ¼å¼ä¸º <code>docker-compose start [SERVICE...]</code>ã€‚</p><p>å¯åŠ¨å·²ç»å­˜åœ¨çš„æœåŠ¡å®¹å™¨ã€‚</p><h4 id="stop"><a href="#stop" class="headerlink" title="stop"></a><code>stop</code></h4><p>æ ¼å¼ä¸º <code>docker-compose stop [options] [SERVICE...]</code>ã€‚</p><p>åœæ­¢å·²ç»å¤„äºè¿è¡ŒçŠ¶æ€çš„å®¹å™¨ï¼Œä½†ä¸åˆ é™¤å®ƒã€‚é€šè¿‡ <code>docker-compose start</code> å¯ä»¥å†æ¬¡å¯åŠ¨è¿™äº›å®¹å™¨ã€‚</p><p>é€‰é¡¹ï¼š</p><ul><li><code>-t, --timeout TIMEOUT</code> åœæ­¢å®¹å™¨æ—¶å€™çš„è¶…æ—¶ï¼ˆé»˜è®¤ä¸º 10 ç§’ï¼‰ã€‚</li></ul><h4 id="top"><a href="#top" class="headerlink" title="top"></a><code>top</code></h4><p>æŸ¥çœ‹å„ä¸ªæœåŠ¡å®¹å™¨å†…è¿è¡Œçš„è¿›ç¨‹ã€‚</p><h4 id="upğŸ”º"><a href="#upğŸ”º" class="headerlink" title="upğŸ”º"></a><code>up</code>ğŸ”º</h4><p>æ ¼å¼ä¸º <code>docker-compose up [options] [SERVICE...]</code>ã€‚</p><p>è¯¥å‘½ä»¤ååˆ†å¼ºå¤§ï¼Œå®ƒå°†å°è¯•è‡ªåŠ¨å®ŒæˆåŒ…æ‹¬æ„å»ºé•œåƒï¼Œï¼ˆé‡æ–°ï¼‰åˆ›å»ºæœåŠ¡ï¼Œå¯åŠ¨æœåŠ¡ï¼Œå¹¶å…³è”æœåŠ¡ç›¸å…³å®¹å™¨çš„ä¸€ç³»åˆ—æ“ä½œã€‚</p><p>é“¾æ¥çš„æœåŠ¡éƒ½å°†ä¼šè¢«è‡ªåŠ¨å¯åŠ¨ï¼Œé™¤éå·²ç»å¤„äºè¿è¡ŒçŠ¶æ€ã€‚</p><p>å¯ä»¥è¯´ï¼Œå¤§éƒ¨åˆ†æ—¶å€™éƒ½å¯ä»¥ç›´æ¥é€šè¿‡è¯¥å‘½ä»¤æ¥å¯åŠ¨ä¸€ä¸ªé¡¹ç›®ã€‚</p><p>é»˜è®¤æƒ…å†µï¼Œ<code>docker-compose up</code> å¯åŠ¨çš„å®¹å™¨éƒ½åœ¨å‰å°ï¼Œæ§åˆ¶å°å°†ä¼šåŒæ—¶æ‰“å°æ‰€æœ‰å®¹å™¨çš„è¾“å‡ºä¿¡æ¯ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿è¿›è¡Œè°ƒè¯•ã€‚</p><p>å½“é€šè¿‡ <code>Ctrl-C</code> åœæ­¢å‘½ä»¤æ—¶ï¼Œæ‰€æœ‰å®¹å™¨å°†ä¼šåœæ­¢ã€‚</p><p>å¦‚æœä½¿ç”¨ <code>docker-compose up -d</code>ï¼Œå°†ä¼šåœ¨åå°å¯åŠ¨å¹¶è¿è¡Œæ‰€æœ‰çš„å®¹å™¨ã€‚ä¸€èˆ¬æ¨èç”Ÿäº§ç¯å¢ƒä¸‹ä½¿ç”¨è¯¥é€‰é¡¹ã€‚</p><p>é»˜è®¤æƒ…å†µï¼Œå¦‚æœæœåŠ¡å®¹å™¨å·²ç»å­˜åœ¨ï¼Œ<code>docker-compose up</code> å°†ä¼šå°è¯•åœæ­¢å®¹å™¨ï¼Œç„¶åé‡æ–°åˆ›å»ºï¼ˆä¿æŒä½¿ç”¨ <code>volumes-from</code> æŒ‚è½½çš„å·ï¼‰ï¼Œä»¥ä¿è¯æ–°å¯åŠ¨çš„æœåŠ¡åŒ¹é… <code>docker-compose.yml</code> æ–‡ä»¶çš„æœ€æ–°å†…å®¹ã€‚å¦‚æœç”¨æˆ·ä¸å¸Œæœ›å®¹å™¨è¢«åœæ­¢å¹¶é‡æ–°åˆ›å»ºï¼Œå¯ä»¥ä½¿ç”¨ <code>docker-compose up --no-recreate</code>ã€‚è¿™æ ·å°†åªä¼šå¯åŠ¨å¤„äºåœæ­¢çŠ¶æ€çš„å®¹å™¨ï¼Œè€Œå¿½ç•¥å·²ç»è¿è¡Œçš„æœåŠ¡ã€‚å¦‚æœç”¨æˆ·åªæƒ³é‡æ–°éƒ¨ç½²æŸä¸ªæœåŠ¡ï¼Œå¯ä»¥ä½¿ç”¨ <code>docker-compose up --no-deps -d &lt;SERVICE_NAME&gt;</code> æ¥é‡æ–°åˆ›å»ºæœåŠ¡å¹¶åå°åœæ­¢æ—§æœåŠ¡ï¼Œå¯åŠ¨æ–°æœåŠ¡ï¼Œå¹¶ä¸ä¼šå½±å“åˆ°å…¶æ‰€ä¾èµ–çš„æœåŠ¡ã€‚</p><p>é€‰é¡¹ï¼š</p><ul><li><code>-d</code> åœ¨åå°è¿è¡ŒæœåŠ¡å®¹å™¨ã€‚</li><li><code>--no-color</code> ä¸ä½¿ç”¨é¢œè‰²æ¥åŒºåˆ†ä¸åŒçš„æœåŠ¡çš„æ§åˆ¶å°è¾“å‡ºã€‚</li><li><code>--no-deps</code> ä¸å¯åŠ¨æœåŠ¡æ‰€é“¾æ¥çš„å®¹å™¨ã€‚</li><li><code>--force-recreate</code> å¼ºåˆ¶é‡æ–°åˆ›å»ºå®¹å™¨ï¼Œä¸èƒ½ä¸ <code>--no-recreate</code> åŒæ—¶ä½¿ç”¨ã€‚</li><li><code>--no-recreate</code> å¦‚æœå®¹å™¨å·²ç»å­˜åœ¨äº†ï¼Œåˆ™ä¸é‡æ–°åˆ›å»ºï¼Œä¸èƒ½ä¸ <code>--force-recreate</code> åŒæ—¶ä½¿ç”¨ã€‚</li><li><code>--no-build</code> ä¸è‡ªåŠ¨æ„å»ºç¼ºå¤±çš„æœåŠ¡é•œåƒã€‚</li><li><code>-t, --timeout TIMEOUT</code> åœæ­¢å®¹å™¨æ—¶å€™çš„è¶…æ—¶ï¼ˆé»˜è®¤ä¸º 10 ç§’ï¼‰ã€‚</li></ul><h2 id="æ¨¡æ¿æ–‡ä»¶"><a href="#æ¨¡æ¿æ–‡ä»¶" class="headerlink" title="æ¨¡æ¿æ–‡ä»¶"></a>æ¨¡æ¿æ–‡ä»¶</h2><p>æ¨¡æ¿æ–‡ä»¶æ˜¯ä½¿ç”¨ <code>Compose</code> çš„æ ¸å¿ƒï¼Œæ¶‰åŠåˆ°çš„æŒ‡ä»¤å…³é”®å­—ä¹Ÿæ¯”è¾ƒå¤šã€‚ä½†å¤§å®¶ä¸ç”¨æ‹…å¿ƒï¼Œè¿™é‡Œé¢å¤§éƒ¨åˆ†æŒ‡ä»¤è·Ÿ <code>docker run</code> ç›¸å…³å‚æ•°çš„å«ä¹‰éƒ½æ˜¯ç±»ä¼¼çš„ã€‚</p><p>é»˜è®¤çš„æ¨¡æ¿æ–‡ä»¶åç§°ä¸º <code>docker-compose.yml</code>ï¼Œæ ¼å¼ä¸º YAML æ ¼å¼ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">webapp:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">examples/web</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">myweb</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/data&quot;</span></span><br></pre></td></tr></table></figure><p><font color="red">æ³¨æ„æ¯ä¸ªæœåŠ¡éƒ½å¿…é¡»é€šè¿‡ <code>image</code> æŒ‡ä»¤æŒ‡å®šé•œåƒæˆ– <code>build</code> æŒ‡ä»¤ï¼ˆéœ€è¦ Dockerfileï¼‰ç­‰æ¥è‡ªåŠ¨æ„å»ºç”Ÿæˆé•œåƒã€‚</font></p><p>å¦‚æœä½¿ç”¨ <code>build</code> æŒ‡ä»¤ï¼Œåœ¨ <code>Dockerfile</code> ä¸­è®¾ç½®çš„é€‰é¡¹(ä¾‹å¦‚ï¼š<code>CMD</code>, <code>EXPOSE</code>, <code>VOLUME</code>, <code>ENV</code> ç­‰) å°†ä¼šè‡ªåŠ¨è¢«è·å–ï¼Œæ— éœ€åœ¨ <code>docker-compose.yml</code> ä¸­é‡å¤è®¾ç½®ã€‚</p><p>æ¯ä¸ªæŒ‡ä»¤çš„ç”¨æ³•ï¼š<a href="https://yeasy.gitbook.io/docker_practice/compose/compose_file">https://yeasy.gitbook.io/docker_practice/compose/compose_file</a></p><ul><li><code>depends_on</code>ï¼š<a href="https://docs.docker.com/compose/compose-file/#depends_on">https://docs.docker.com/compose/compose-file/#depends_on</a></li></ul><h2 id="Composeä¸­çš„ç¯å¢ƒå˜é‡"><a href="#Composeä¸­çš„ç¯å¢ƒå˜é‡" class="headerlink" title="Composeä¸­çš„ç¯å¢ƒå˜é‡"></a>Composeä¸­çš„ç¯å¢ƒå˜é‡</h2><h3 id="åœ¨æ’°å†™æ–‡ä»¶æ›¿æ¢ç¯å¢ƒå˜é‡"><a href="#åœ¨æ’°å†™æ–‡ä»¶æ›¿æ¢ç¯å¢ƒå˜é‡" class="headerlink" title="åœ¨æ’°å†™æ–‡ä»¶æ›¿æ¢ç¯å¢ƒå˜é‡"></a>åœ¨æ’°å†™æ–‡ä»¶æ›¿æ¢ç¯å¢ƒå˜é‡</h3><p>å¯ä»¥åœ¨å¤–å£³ä¸­ä½¿ç”¨ç¯å¢ƒå˜é‡æ¥å¡«å……Composeæ–‡ä»¶ä¸­çš„å€¼ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">web:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">&quot;webapp:$&#123;TAG&#125;&quot;</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæ‚¨æœ‰å¤šä¸ªç¯å¢ƒå˜é‡ï¼Œåˆ™å¯ä»¥é€šè¿‡æä¾›ç¯å¢ƒå˜é‡æ–‡ä»¶çš„è·¯å¾„æ¥æ›¿æ¢å®ƒä»¬ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥<code>docker-compose</code> å‘½ä»¤å°†<code>.env</code>åœ¨æ‚¨è¿è¡Œè¯¥å‘½ä»¤çš„ç›®å½•ä¸­æŸ¥æ‰¾ä¸€ä¸ªåä¸ºçš„æ–‡ä»¶ã€‚é€šè¿‡å°†æ–‡ä»¶ä½œä¸ºå‚æ•°ï¼Œä½ å¯ä»¥å­˜å‚¨åœ¨ä»»ä½•åœ°æ–¹ï¼Œå¹¶é€‚å½“å‘½åï¼Œä¾‹å¦‚<code>.env.ci</code>ï¼Œ<code>.env.dev</code>ï¼Œ<code>.env.prod</code>ã€‚ä½¿ç”¨ä»¥ä¸‹<code>--env-file</code>é€‰é¡¹å®Œæˆæ–‡ä»¶è·¯å¾„çš„ä¼ é€’ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose --env-file ./config/.env.dev up </span><br></pre></td></tr></table></figure><h3 id="åœ¨å®¹å™¨ä¸­è®¾ç½®ç¯å¢ƒå˜é‡"><a href="#åœ¨å®¹å™¨ä¸­è®¾ç½®ç¯å¢ƒå˜é‡" class="headerlink" title="åœ¨å®¹å™¨ä¸­è®¾ç½®ç¯å¢ƒå˜é‡"></a>åœ¨å®¹å™¨ä¸­è®¾ç½®ç¯å¢ƒå˜é‡</h3><p>æ‚¨å¯ä»¥ä½¿ç”¨environmenté”®åœ¨æœåŠ¡çš„å®¹å™¨ä¸­è®¾ç½®ç¯å¢ƒå˜é‡ ï¼Œå°±åƒ <code>docker run -e VARIABLE=VALUE ...</code>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">web:</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">DEBUG=1</span></span><br></pre></td></tr></table></figure><h2 id="Composeç½‘ç»œ"><a href="#Composeç½‘ç»œ" class="headerlink" title="Composeç½‘ç»œ"></a>Composeç½‘ç»œ</h2><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒComposeä¸ºæ‚¨çš„åº”ç”¨è®¾ç½®å•ä¸ªç½‘ç»œã€‚ä¸ºæœåŠ¡æ¯ä¸ªå®¹å™¨åŠ å…¥é»˜è®¤ç½‘ç»œã€‚</p><blockquote><p><strong>æ³¨æ„</strong></p><p>ä¸ºåº”ç”¨ç¨‹åºçš„ç½‘ç»œæä¾›ä¸€ä¸ªåŸºäºâ€œé¡¹ç›®åç§°â€çš„åç§°ï¼Œè¯¥åç§°åŸºäºå…¶æ‰€åœ¨ç›®å½•çš„åç§°ã€‚æ‚¨å¯ä»¥ä½¿ç”¨<code>--project-name  flag</code>è¦†ç›–é¡¹ç›®åç§°ã€‚</p></blockquote><p>ä¾‹å¦‚ï¼Œå‡è®¾æ‚¨çš„åº”ç”¨ç¨‹åºä½äºåä¸ºçš„ç›®å½•ä¸­<code>myapp</code>ï¼Œå¹¶ä¸”æ‚¨çš„<code>docker-compose.yml</code>å¤–è§‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8000:8000&quot;</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8001:5432&quot;</span></span><br></pre></td></tr></table></figure><p>è¿è¡Œæ—¶<code>docker-compose up</code>ï¼Œå°†å‘ç”Ÿä»¥ä¸‹æƒ…å†µï¼š</p><ol><li><code>myapp_default</code>åˆ›å»ºä¸€ä¸ªåä¸ºçš„ç½‘ç»œã€‚</li><li>å®¹å™¨æ˜¯ä½¿ç”¨<code>web</code>çš„é…ç½®åˆ›å»ºçš„ã€‚å®ƒ<code>myapp_default</code>ä»¥åç§°<code>web</code>åŠ å…¥ç½‘ç»œ ã€‚</li><li>å®¹å™¨æ˜¯ä½¿ç”¨<code>db</code>çš„é…ç½®åˆ›å»ºçš„ã€‚å®ƒ<code>myapp_default</code>ä»¥åç§°<code>db</code>åŠ å…¥ç½‘ç»œ ã€‚</li></ol><p>ç°åœ¨ï¼Œæ¯ä¸ªå®¹å™¨éƒ½å¯ä»¥æŸ¥æ‰¾ä¸»æœºå<code>web</code>æˆ–<code>db</code>è·å–ç›¸åº”å®¹å™¨çš„IPåœ°å€ã€‚ä¾‹å¦‚ï¼Œ<code>web</code>çš„åº”ç”¨ç¨‹åºä»£ç å¯ä»¥è¿æ¥åˆ°URL<code>postgres://db:5432</code>å¹¶å¼€å§‹ä½¿ç”¨Postgresæ•°æ®åº“ã€‚</p><p>è¦æ³¨æ„åŒºåˆ†æ˜¯å¾ˆé‡è¦çš„<code>HOST_PORT</code>å’Œ<code>CONTAINER_PORT</code>ã€‚åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œå¯¹äº<code>db</code>ï¼Œ<code>HOST_PORT</code>isæ˜¯<code>8001</code>ï¼Œå®¹å™¨ç«¯å£ä¸º <code>5432</code>ï¼ˆpostgresé»˜è®¤ï¼‰ã€‚è”ç½‘çš„æœåŠ¡åˆ°æœåŠ¡é€šä¿¡ä½¿ç”¨<code>CONTAINER_PORT</code>ã€‚å½“<code>HOST_PORT</code>å®šä¹‰ï¼ŒæœåŠ¡ä»¥åŠè™«ç¾¤å¤–éƒ¨è®¿é—®ã€‚</p><p>åœ¨<code>web</code>å®¹å™¨å†…ï¼Œæ‚¨çš„è¿æ¥å­—ç¬¦ä¸²<code>db</code>å°†çœ‹èµ·æ¥åƒ <code>postgres://db:5432</code>ï¼Œè€Œåœ¨ä¸»æœºä¸Šï¼Œè¿æ¥å­—ç¬¦ä¸²å°†çœ‹èµ·æ¥åƒ<code>postgres://&#123;DOCKER_IP&#125;:8001</code>ã€‚</p><h3 id="è‡ªå®šä¹‰ç½‘ç»œ"><a href="#è‡ªå®šä¹‰ç½‘ç»œ" class="headerlink" title="è‡ªå®šä¹‰ç½‘ç»œ"></a>è‡ªå®šä¹‰ç½‘ç»œ</h3><h4 id="é…ç½®é»˜è®¤ç½‘ç»œ"><a href="#é…ç½®é»˜è®¤ç½‘ç»œ" class="headerlink" title="é…ç½®é»˜è®¤ç½‘ç»œ"></a>é…ç½®é»˜è®¤ç½‘ç»œ</h4><p>é™¤äº†ï¼ˆæˆ–åŒæ—¶ï¼‰æŒ‡å®šè‡ªå·±çš„ç½‘ç»œï¼Œæ‚¨è¿˜å¯ä»¥é€šè¿‡åœ¨<code>networks</code>namedä¸‹å®šä¹‰ä¸€ä¸ªæ¡ç›®æ¥æ›´æ”¹åº”ç”¨ç¨‹åºèŒƒå›´çš„é»˜è®¤ç½‘ç»œçš„è®¾ç½®<code>default</code>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8000:8000&quot;</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">default:</span></span><br><span class="line">    <span class="comment"># Use a custom driver</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">custom-driver-1</span></span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨ç°æœ‰ç½‘ç»œ"><a href="#ä½¿ç”¨ç°æœ‰ç½‘ç»œ" class="headerlink" title="ä½¿ç”¨ç°æœ‰ç½‘ç»œ"></a>ä½¿ç”¨ç°æœ‰ç½‘ç»œ</h4><p>å¦‚æœæ‚¨å¸Œæœ›å®¹å™¨åŠ å…¥ç°æœ‰ç½‘ç»œï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹<a href="https://docs.docker.com/compose/compose-file/compose-file-v2/#network-configuration-reference"><code>external</code>é€‰é¡¹</a>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">default:</span></span><br><span class="line">    <span class="attr">external:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">my-pre-existing-network</span></span><br></pre></td></tr></table></figure><p><code>[projectname]_default</code>Composeä¸ä¼šå°è¯•åˆ›å»ºä¸€ä¸ªåä¸ºçš„ç½‘ç»œï¼Œè€Œæ˜¯æŸ¥æ‰¾ä¸€ä¸ªåä¸ºçš„ç½‘ç»œ<code>my-pre-existing-network</code>å¹¶å°†æ‚¨çš„åº”ç”¨ç¨‹åºçš„å®¹å™¨è¿æ¥åˆ°è¯¥ç½‘ç»œã€‚</p><h2 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h2><h3 id="WordPress"><a href="#WordPress" class="headerlink" title="WordPress"></a>WordPress</h3><p><code>Compose</code> å¯ä»¥å¾ˆä¾¿æ·çš„è®© <code>Wordpress</code> è¿è¡Œåœ¨ä¸€ä¸ªç‹¬ç«‹çš„ç¯å¢ƒä¸­ã€‚</p><h3 id="åˆ›å»ºç©ºæ–‡ä»¶å¤¹"><a href="#åˆ›å»ºç©ºæ–‡ä»¶å¤¹" class="headerlink" title="åˆ›å»ºç©ºæ–‡ä»¶å¤¹"></a>åˆ›å»ºç©ºæ–‡ä»¶å¤¹</h3><p>å‡è®¾æ–°å»ºä¸€ä¸ªåä¸º <code>wordpress</code> çš„æ–‡ä»¶å¤¹ï¼Œç„¶åè¿›å…¥è¿™ä¸ªæ–‡ä»¶å¤¹ã€‚</p><h3 id="åˆ›å»º-docker-compose-yml-æ–‡ä»¶"><a href="#åˆ›å»º-docker-compose-yml-æ–‡ä»¶" class="headerlink" title="åˆ›å»º docker-compose.yml æ–‡ä»¶"></a>åˆ›å»º <code>docker-compose.yml</code> æ–‡ä»¶</h3><p><a href="https://github.com/yeasy/docker_practice/blob/master/compose/demo/wordpress/docker-compose.yml"><code>docker-compose.yml</code></a> æ–‡ä»¶å°†å¼€å¯ä¸€ä¸ª <code>wordpress</code> æœåŠ¡å’Œä¸€ä¸ªç‹¬ç«‹çš„ <code>MySQL</code> å®ä¾‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line">   <span class="attr">db:</span></span><br><span class="line">     <span class="attr">image:</span> <span class="string">mysql:8.0</span></span><br><span class="line">     <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--default_authentication_plugin=mysql_native_password</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--character-set-server=utf8mb4</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--collation-server=utf8mb4_unicode_ci</span>     </span><br><span class="line">     <span class="attr">volumes:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">db_data:/var/lib/mysql</span></span><br><span class="line">     <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">     <span class="attr">environment:</span></span><br><span class="line">       <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">somewordpress</span></span><br><span class="line">       <span class="attr">MYSQL_DATABASE:</span> <span class="string">wordpress</span></span><br><span class="line">       <span class="attr">MYSQL_USER:</span> <span class="string">wordpress</span></span><br><span class="line">       <span class="attr">MYSQL_PASSWORD:</span> <span class="string">wordpress</span></span><br><span class="line"></span><br><span class="line">   <span class="attr">wordpress:</span></span><br><span class="line">     <span class="attr">depends_on:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">     <span class="attr">image:</span> <span class="string">wordpress:latest</span></span><br><span class="line">     <span class="attr">ports:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">&quot;8000:80&quot;</span></span><br><span class="line">     <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">     <span class="attr">environment:</span></span><br><span class="line">       <span class="attr">WORDPRESS_DB_HOST:</span> <span class="string">db:3306</span></span><br><span class="line">       <span class="attr">WORDPRESS_DB_USER:</span> <span class="string">wordpress</span></span><br><span class="line">       <span class="attr">WORDPRESS_DB_PASSWORD:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">db_data:</span></span><br></pre></td></tr></table></figure><h3 id="æ„å»ºå¹¶è¿è¡Œé¡¹ç›®"><a href="#æ„å»ºå¹¶è¿è¡Œé¡¹ç›®" class="headerlink" title="æ„å»ºå¹¶è¿è¡Œé¡¹ç›®"></a>æ„å»ºå¹¶è¿è¡Œé¡¹ç›®</h3><p>è¿è¡Œ <code>docker-compose up -d</code> Compose å°±ä¼šæ‹‰å–é•œåƒå†åˆ›å»ºæˆ‘ä»¬æ‰€éœ€è¦çš„é•œåƒï¼Œç„¶åå¯åŠ¨ <code>wordpress</code> å’Œæ•°æ®åº“å®¹å™¨ã€‚ æ¥ç€æµè§ˆå™¨è®¿é—® <code>127.0.0.1:8000</code> ç«¯å£å°±èƒ½çœ‹åˆ° <code>WordPress</code> å®‰è£…ç•Œé¢äº†ã€‚</p><p><font color="red"></font></p><h1 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h1><p><a href="https://yeasy.gitbook.io/docker_practice/">https://yeasy.gitbook.io/docker_practice/</a></p><p><a href="https://docs.docker.com/compose/">https://docs.docker.com/compose/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Docker-Compose&quot;&gt;&lt;a href=&quot;#Docker-Compose&quot; class=&quot;headerlink&quot; title=&quot;Docker Compose&quot;&gt;&lt;/a&gt;Docker Compose&lt;/h1&gt;&lt;p&gt;&lt;code&gt;Compose&lt;/code&gt; é¡¹</summary>
      
    
    
    
    <category term="Docker" scheme="https://awslzhang.top/categories/Docker/"/>
    
    
    <category term="Docker" scheme="https://awslzhang.top/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>Dockerç½‘ç»œ</title>
    <link href="https://awslzhang.top/2020/11/13/Docker%E7%BD%91%E7%BB%9C/"/>
    <id>https://awslzhang.top/2020/11/13/Docker%E7%BD%91%E7%BB%9C/</id>
    <published>2020-11-13T11:35:04.000Z</published>
    <updated>2021-01-01T05:49:59.917Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Dockerç½‘ç»œ"><a href="#Dockerç½‘ç»œ" class="headerlink" title="Dockerç½‘ç»œ"></a>Dockerç½‘ç»œ</h1><blockquote><p>Docker å…è®¸é€šè¿‡å¤–éƒ¨è®¿é—®å®¹å™¨æˆ–å®¹å™¨äº’è”çš„æ–¹å¼æ¥æä¾›ç½‘ç»œæœåŠ¡ã€‚</p></blockquote><h2 id="å¤–éƒ¨è®¿é—®å®¹å™¨"><a href="#å¤–éƒ¨è®¿é—®å®¹å™¨" class="headerlink" title="å¤–éƒ¨è®¿é—®å®¹å™¨"></a>å¤–éƒ¨è®¿é—®å®¹å™¨</h2><p>å®¹å™¨ä¸­å¯ä»¥è¿è¡Œä¸€äº›ç½‘ç»œåº”ç”¨ï¼Œè¦è®©å¤–éƒ¨ä¹Ÿå¯ä»¥è®¿é—®è¿™äº›åº”ç”¨ï¼Œå¯ä»¥é€šè¿‡ <code>-P</code> æˆ– <code>-p</code> å‚æ•°æ¥æŒ‡å®šç«¯å£æ˜ å°„ã€‚</p><ul><li>å½“ä½¿ç”¨ <code>-P</code> æ ‡è®°æ—¶ï¼ŒDocker ä¼šéšæœºæ˜ å°„ä¸€ä¸ªç«¯å£åˆ°<font color="red">**å†…éƒ¨å®¹å™¨å¼€æ”¾çš„ç½‘ç»œç«¯å£(EXPOSEçš„ç«¯å£)**ã€‚</font></li><li>å½“ä½¿ç”¨<code>-p</code>æ ‡è®°æ—¶ï¼Œéœ€è¦åŒæ—¶æŒ‡å®šå®¿ä¸»æœºç«¯å£ä¸å®¹å™¨ç«¯å£ä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -P nginx</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>docker container ls</code> å¯ä»¥çœ‹åˆ°ï¼Œæœ¬åœ°ä¸»æœºçš„ 32769è¢«æ˜ å°„åˆ°äº†å®¹å™¨çš„ 80 ç«¯å£ã€‚æ­¤æ—¶è®¿é—®æœ¬æœºçš„ 32769ç«¯å£å³å¯è®¿é—®å®¹å™¨å†… NGINX é»˜è®¤é¡µé¢ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker container ls</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                   NAMES</span><br><span class="line">3dda28d1a931        nginx               <span class="string">&quot;/docker-entrypoint.â€¦&quot;</span>   24 seconds ago      Up 23 seconds       0.0.0.0:32769-&gt;80/tcp   romantic_volhard</span><br></pre></td></tr></table></figure><blockquote><p><code>-p</code> åˆ™å¯ä»¥æŒ‡å®šè¦æ˜ å°„çš„ç«¯å£ï¼Œå¹¶ä¸”ï¼Œåœ¨ä¸€ä¸ªæŒ‡å®šç«¯å£ä¸Šåªå¯ä»¥ç»‘å®šä¸€ä¸ªå®¹å™¨ã€‚æ”¯æŒçš„æ ¼å¼æœ‰ :</p></blockquote><ul><li><code>ip:hostPort:containerPort </code>ï¼šæ˜ å°„åˆ°æŒ‡å®šåœ°å€çš„æŒ‡å®šç«¯å£</li><li><code>ip::containerPort</code>ï¼šæ˜ å°„æ‰€æœ‰æ¥å£åœ°å€</li><li><code>hostPort:containerPort</code>ï¼šæ˜ å°„åˆ°æŒ‡å®šåœ°å€çš„ä»»æ„ç«¯å£</li></ul><h3 id="æŒ‡å®šæ˜ å°„åˆ†ç±»"><a href="#æŒ‡å®šæ˜ å°„åˆ†ç±»" class="headerlink" title="æŒ‡å®šæ˜ å°„åˆ†ç±»"></a>æŒ‡å®šæ˜ å°„åˆ†ç±»</h3><h4 id="æ˜ å°„æ‰€æœ‰æ¥å£åœ°å€"><a href="#æ˜ å°„æ‰€æœ‰æ¥å£åœ°å€" class="headerlink" title="æ˜ å°„æ‰€æœ‰æ¥å£åœ°å€"></a>æ˜ å°„æ‰€æœ‰æ¥å£åœ°å€</h4><p>ä½¿ç”¨ <code>hostPort:containerPort</code> æ ¼å¼æœ¬åœ°çš„ 80 ç«¯å£æ˜ å°„åˆ°å®¹å™¨çš„ 80 ç«¯å£ï¼Œå¯ä»¥æ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -p 80:80 nginx:alpine</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶é»˜è®¤ä¼šç»‘å®šæœ¬åœ°æ‰€æœ‰æ¥å£ä¸Šçš„æ‰€æœ‰åœ°å€ã€‚</p><h4 id="æ˜ å°„åˆ°æŒ‡å®šåœ°å€çš„æŒ‡å®šç«¯å£"><a href="#æ˜ å°„åˆ°æŒ‡å®šåœ°å€çš„æŒ‡å®šç«¯å£" class="headerlink" title="æ˜ å°„åˆ°æŒ‡å®šåœ°å€çš„æŒ‡å®šç«¯å£"></a>æ˜ å°„åˆ°æŒ‡å®šåœ°å€çš„æŒ‡å®šç«¯å£</h4><p>å¯ä»¥ä½¿ç”¨ <code>ip:hostPort:containerPort</code> æ ¼å¼æŒ‡å®šæ˜ å°„ä½¿ç”¨ä¸€ä¸ªç‰¹å®šåœ°å€ï¼Œæ¯”å¦‚ localhost åœ°å€ 127.0.0.1</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -p 127.0.0.1:80:80 nginx:alpine</span><br></pre></td></tr></table></figure><h4 id="æ˜ å°„åˆ°æŒ‡å®šåœ°å€çš„ä»»æ„ç«¯å£"><a href="#æ˜ å°„åˆ°æŒ‡å®šåœ°å€çš„ä»»æ„ç«¯å£" class="headerlink" title="æ˜ å°„åˆ°æŒ‡å®šåœ°å€çš„ä»»æ„ç«¯å£"></a>æ˜ å°„åˆ°æŒ‡å®šåœ°å€çš„ä»»æ„ç«¯å£</h4><p>ä½¿ç”¨ <code>ip::containerPort</code> ç»‘å®š localhost çš„ä»»æ„ç«¯å£åˆ°å®¹å™¨çš„ 80 ç«¯å£ï¼Œæœ¬åœ°ä¸»æœºä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ªç«¯å£ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -p 127.0.0.1::80 nginx:alpine</span><br></pre></td></tr></table></figure><p>è¿˜å¯ä»¥ä½¿ç”¨ <code>udp</code> æ ‡è®°æ¥æŒ‡å®š <code>udp</code> ç«¯å£</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -p 127.0.0.1:80:80/udp nginx:alpine</span><br></pre></td></tr></table></figure><p><strong>è¿™é‡Œæåˆ°äº†UDPç«¯å£å·ï¼Œç‰¹æ­¤è¯´æ˜TCPã€UDPéƒ½æœ‰ç«¯å£å·å¹¶äº’ä¸å½±å“ã€‚</strong></p><blockquote><p> é¡ºä¾¿æå‡ºç«¯å£å·çš„èŒƒå›´å¯åˆ†ä¸ºä¸‰ç§ï¼š</p><ul><li>Well-Known Portsï¼ˆå³å…¬è®¤ç«¯å£å·ï¼‰ï¼šçŸ¥åç«¯å£å·çš„èŒƒå›´æ˜¯ï¼š0-1023</li><li>Registered Portsï¼ˆå³æ³¨å†Œç«¯å£ï¼‰ï¼šæ³¨å†Œç«¯å£å·çš„èŒƒå›´æ˜¯ï¼š1024-49151</li><li>Dynamic, private or ephemeral portsï¼ˆå³åŠ¨æ€ã€ç§æœ‰æˆ–ä¸´æ—¶ç«¯å£å·ï¼‰ï¼šè¿™ä¸€æ®µçš„èŒƒå›´æ˜¯ï¼š49152â€“65535</li></ul></blockquote><h3 id="æŸ¥çœ‹æ˜ å°„ç«¯å£é…ç½®"><a href="#æŸ¥çœ‹æ˜ å°„ç«¯å£é…ç½®" class="headerlink" title="æŸ¥çœ‹æ˜ å°„ç«¯å£é…ç½®"></a>æŸ¥çœ‹æ˜ å°„ç«¯å£é…ç½®</h3><p>ä½¿ç”¨ <code>docker port</code> æ¥æŸ¥çœ‹å½“å‰æ˜ å°„çš„ç«¯å£é…ç½®ï¼Œä¹Ÿå¯ä»¥æŸ¥çœ‹åˆ°ç»‘å®šçš„åœ°å€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker port containerId</span><br><span class="line">80/tcp -&gt; 0.0.0.0:80</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼š</p><ul><li>å®¹å™¨æœ‰è‡ªå·±çš„å†…éƒ¨ç½‘ç»œå’Œ ip åœ°å€ï¼ˆä½¿ç”¨ <code>docker inspect</code> æŸ¥çœ‹ï¼ŒDocker è¿˜å¯ä»¥æœ‰ä¸€ä¸ªå¯å˜çš„ç½‘ç»œé…ç½®ã€‚ï¼‰</li><li><code>-p</code> æ ‡è®°å¯ä»¥å¤šæ¬¡ä½¿ç”¨æ¥ç»‘å®šå¤šä¸ªç«¯å£</li></ul></blockquote><p>ä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d \</span><br><span class="line">-p 80:80 \</span><br><span class="line">-p 443:443 \</span><br><span class="line">nginx:alpine</span><br></pre></td></tr></table></figure><h2 id="å®¹å™¨äº’è”"><a href="#å®¹å™¨äº’è”" class="headerlink" title="å®¹å™¨äº’è”"></a>å®¹å™¨äº’è”</h2><p>å¦‚æœä½ ä¹‹å‰æœ‰ <code>Docker</code> ä½¿ç”¨ç»éªŒï¼Œä½ å¯èƒ½å·²ç»ä¹ æƒ¯äº†ä½¿ç”¨ <code>--link</code> å‚æ•°æ¥ä½¿å®¹å™¨äº’è”ã€‚</p><p><code>--link</code>æ–¹å¼ä½¿å®¹å™¨äº’è”éœ€è¦å¯¹åŒæ–¹å®¹å™¨éƒ½åšå‡ºé™åˆ¶ï¼Œä¸å¥½æ“ä½œã€‚</p><p>éšç€ Docker ç½‘ç»œçš„å®Œå–„ï¼Œå¼ºçƒˆå»ºè®®å¤§å®¶å°†å®¹å™¨åŠ å…¥<font color="red"><strong>è‡ªå®šä¹‰çš„ Docker ç½‘ç»œæ¥è¿æ¥å¤šä¸ªå®¹å™¨</strong></font>ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ <code>--link</code> å‚æ•°ã€‚</p><h3 id="æ–°å»ºç½‘ç»œ"><a href="#æ–°å»ºç½‘ç»œ" class="headerlink" title="æ–°å»ºç½‘ç»œ"></a>æ–°å»ºç½‘ç»œ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker network create -d bridge my-net</span><br></pre></td></tr></table></figure><p><code>-d</code> å‚æ•°æŒ‡å®š Docker ç½‘ç»œç±»å‹ï¼Œæœ‰ <code>bridge</code> <code>overlay</code>ã€‚å…¶ä¸­ <code>overlay</code> ç½‘ç»œç±»å‹ç”¨äº <a href="">Swarm mode</a>ï¼Œåœ¨æœ¬å°èŠ‚ä¸­ä½ å¯ä»¥å¿½ç•¥å®ƒã€‚</p><h3 id="è¿æ¥å®¹å™¨"><a href="#è¿æ¥å®¹å™¨" class="headerlink" title="è¿æ¥å®¹å™¨"></a>è¿æ¥å®¹å™¨</h3><p>è¿è¡Œä¸€ä¸ªå®¹å™¨å¹¶è¿æ¥åˆ°æ–°å»ºçš„ <code>my-net</code> ç½‘ç»œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -it --rm --name busybox1 --network my-net busybox sh</span><br></pre></td></tr></table></figure><p>æ‰“å¼€æ–°çš„ç»ˆç«¯ï¼Œå†è¿è¡Œä¸€ä¸ªå®¹å™¨å¹¶åŠ å…¥åˆ° <code>my-net</code> ç½‘ç»œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -it --rm --name busybox2 --network my-net busybox sh</span><br></pre></td></tr></table></figure><p>å†æ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯æŸ¥çœ‹å®¹å™¨ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker container ls</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMESb47060aca56b        busybox             <span class="string">&quot;sh&quot;</span>                11 minutes ago      Up 11 minutes                           busybox28720575823ec        busybox             <span class="string">&quot;sh&quot;</span>                16 minutes ago      Up 16 minutes                           busybox1</span><br></pre></td></tr></table></figure><p>ä¸‹é¢é€šè¿‡ <code>ping</code> æ¥è¯æ˜ <code>busybox1</code> å®¹å™¨å’Œ <code>busybox2</code> å®¹å™¨å»ºç«‹äº†äº’è”å…³ç³»ã€‚</p><p>åœ¨ <code>busybox1</code> å®¹å™¨è¾“å…¥ä»¥ä¸‹å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># ping busybox2</span></span><br><span class="line">PING busybox2 (172.19.0.3): 56 data bytes</span><br><span class="line">64 bytes from 172.19.0.3: seq=0 ttl=64 time=0.072 ms</span><br><span class="line">64 bytes from 172.19.0.3: seq=1 ttl=64 time=0.118 ms</span><br></pre></td></tr></table></figure><p>ç”¨ ping æ¥æµ‹è¯•è¿æ¥ <code>busybox2</code> å®¹å™¨ï¼Œå®ƒä¼šè§£ææˆ <code>172.19.0.3</code>ã€‚</p><p>åŒç†åœ¨ <code>busybox2</code> å®¹å™¨æ‰§è¡Œ <code>ping busybox1</code>ï¼Œä¹Ÿä¼šæˆåŠŸè¿æ¥åˆ°ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># ping busybox1</span></span><br><span class="line">PING busybox1 (172.19.0.2): 56 data bytes</span><br><span class="line">64 bytes from 172.19.0.2: seq=0 ttl=64 time=0.064 ms</span><br><span class="line">64 bytes from 172.19.0.2: seq=1 ttl=64 time=0.143 ms</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œ<code>busybox1</code> å®¹å™¨å’Œ <code>busybox2</code> å®¹å™¨å»ºç«‹äº†äº’è”å…³ç³»ã€‚</p><h2 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h2><p>å¦‚æœä½ æœ‰å¤šä¸ªå®¹å™¨ä¹‹é—´éœ€è¦äº’ç›¸è¿æ¥ï¼Œæ¨èä½¿ç”¨Docker Compose</p><hr><h1 id="é«˜çº§ç½‘ç»œé…ç½®"><a href="#é«˜çº§ç½‘ç»œé…ç½®" class="headerlink" title="é«˜çº§ç½‘ç»œé…ç½®"></a>é«˜çº§ç½‘ç»œé…ç½®</h1><p>å½“ Docker å¯åŠ¨æ—¶ï¼Œä¼šè‡ªåŠ¨åœ¨ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ª <code>docker0</code> è™šæ‹Ÿç½‘æ¡¥ï¼Œå®é™…ä¸Šæ˜¯ Linux çš„ä¸€ä¸ª bridgeï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªè½¯ä»¶äº¤æ¢æœºï¼Œ<font color="red">æ‰€æœ‰ä¸æŒ‡å®šç½‘ç»œçš„å®¹å™¨éƒ½ä¼šä½¿ç”¨æ­¤ç½‘å¡ï¼ˆé»˜è®¤ç½‘å¡ï¼‰</font>ã€‚å®ƒä¼šåœ¨æŒ‚è½½åˆ°å®ƒçš„ç½‘å£ä¹‹é—´è¿›è¡Œè½¬å‘ã€‚</p><p>åŒæ—¶ï¼ŒDocker éšæœºåˆ†é…ä¸€ä¸ªæœ¬åœ°æœªå ç”¨çš„ç§æœ‰ç½‘æ®µï¼ˆåœ¨ <a href="https://tools.ietf.org/html/rfc1918">RFC1918</a> ä¸­å®šä¹‰ï¼‰ä¸­çš„ä¸€ä¸ªåœ°å€ç»™ <code>docker0</code> æ¥å£ã€‚æ¯”å¦‚å…¸å‹çš„ <code>172.17.42.1/16</code>ï¼Œæ©ç ä¸º <code>255.255.0.0</code>ã€‚æ­¤åå¯åŠ¨çš„å®¹å™¨å†…çš„ç½‘å£ä¹Ÿä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ªåŒä¸€ç½‘æ®µï¼ˆ<code>172.17.0.0/16</code>ï¼‰çš„åœ°å€ã€‚</p><blockquote><p><strong>æ³¨æ„</strong>ï¼šé»˜è®¤çš„<code>docker0</code>ç½‘ç»œå’Œè‡ªå®šä¹‰ç½‘ç»œæœ‰ä¸€ç‚¹ä¸åŒï¼Œä½¿ç”¨<code>docker0</code>ç½‘å¡çš„å®¹å™¨ä¸èƒ½å®ç°äº’è”ã€‚</p></blockquote><p>å½“åˆ›å»ºä¸€ä¸ª Docker å®¹å™¨çš„æ—¶å€™ï¼ŒåŒæ—¶ä¼šåˆ›å»ºäº†ä¸€å¯¹ <code>veth pair</code> æ¥å£ï¼ˆå½“æ•°æ®åŒ…å‘é€åˆ°ä¸€ä¸ªæ¥å£æ—¶ï¼Œå¦å¤–ä¸€ä¸ªæ¥å£ä¹Ÿå¯ä»¥æ”¶åˆ°ç›¸åŒçš„æ•°æ®åŒ…ï¼‰ã€‚è¿™å¯¹æ¥å£ä¸€ç«¯åœ¨å®¹å™¨å†…ï¼Œå³ <code>eth0</code>ï¼›å¦ä¸€ç«¯åœ¨æœ¬åœ°å¹¶è¢«æŒ‚è½½åˆ° <code>docker0</code> ç½‘æ¡¥ï¼Œåç§°ä»¥ <code>veth</code> å¼€å¤´ï¼ˆä¾‹å¦‚ <code>vethAQI2QT</code>ï¼‰ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä¸»æœºå¯ä»¥è·Ÿå®¹å™¨é€šä¿¡ï¼Œå®¹å™¨ä¹‹é—´ä¹Ÿå¯ä»¥ç›¸äº’é€šä¿¡ã€‚Docker å°±åˆ›å»ºäº†åœ¨ä¸»æœºå’Œæ‰€æœ‰å®¹å™¨ä¹‹é—´ä¸€ä¸ªè™šæ‹Ÿå…±äº«ç½‘ç»œã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/hostos.png"></p><p>æ¥ä¸‹æ¥çš„éƒ¨åˆ†å°†ä»‹ç»åœ¨ä¸€äº›åœºæ™¯ä¸­ï¼ŒDocker æ‰€æœ‰çš„ç½‘ç»œå®šåˆ¶é…ç½®ã€‚ä»¥åŠé€šè¿‡ Linux å‘½ä»¤æ¥è°ƒæ•´ã€è¡¥å……ã€ç”šè‡³æ›¿æ¢ Docker é»˜è®¤çš„ç½‘ç»œé…ç½®ã€‚</p><h2 id="å¿«é€Ÿé…ç½®æŒ‡å—"><a href="#å¿«é€Ÿé…ç½®æŒ‡å—" class="headerlink" title="å¿«é€Ÿé…ç½®æŒ‡å—"></a>å¿«é€Ÿé…ç½®æŒ‡å—</h2><p>æœ€åè¿™äº›é€‰é¡¹åªæœ‰åœ¨ <code>docker run</code> æ‰§è¡Œæ—¶ä½¿ç”¨ï¼Œå› ä¸ºå®ƒæ˜¯é’ˆå¯¹å®¹å™¨çš„ç‰¹æ€§å†…å®¹ã€‚</p><ul><li><code>-h HOSTNAME</code> æˆ– <code>--hostname=HOSTNAME</code> é…ç½®å®¹å™¨ä¸»æœºå</li><li><del><code>--link=CONTAINER_NAME:ALIAS</code> æ·»åŠ åˆ°å¦ä¸€ä¸ªå®¹å™¨çš„è¿æ¥</del></li><li><code>--net=bridge|none|container:NAME_or_ID|host</code> é…ç½®å®¹å™¨çš„æ¡¥æ¥æ¨¡å¼</li><li><code>-p SPEC</code> æˆ– <code>--publish=SPEC</code> æ˜ å°„å®¹å™¨ç«¯å£åˆ°å®¿ä¸»ä¸»æœº</li><li><code>-P or --publish-all=true|false</code> æ˜ å°„å®¹å™¨æ‰€æœ‰ç«¯å£åˆ°å®¿ä¸»ä¸»æœº</li></ul><h2 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h2><p><strong>åˆ›å»ºç½‘ç»œ</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker network create -d bridge --subnet 172.11.0.0/16 --gateway 172.11.0.1 mynet</span><br><span class="line">6ca441ff474f979f493774cf0c3c7379d5da03655e4da14bb8b5d80fe3e98d37</span><br></pre></td></tr></table></figure><p><strong>åˆ›å»º2ä¸ªä½¿ç”¨<code>mynet</code>çš„å®¹å™¨</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d --name tomcat-mynet-1 --network=mynet tomcat</span><br><span class="line">89a4b49863d4bcd4468a32105df3f8e6f0cec529bcad12264b17a18e636dc8ed</span><br><span class="line">$ docker run -d --name tomcat-mynet-2 --network=mynet tomcat</span><br><span class="line">e594cdd21b422b85306cca3389ca56610dd812a78f02b9977e6d022fcfd792e2</span><br></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹<code>mynet</code>ç½‘ç»œçš„ä½¿ç”¨æƒ…å†µ</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker network inspect mynet</span><br></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&quot;Containers&quot;: &#123;</span><br><span class="line">    &quot;39483e5272d244662e19aab9a5acaf4f935de7d4e123295c1a114629fbc2837b&quot;: &#123;</span><br><span class="line">        &quot;Name&quot;: &quot;tomcat-mynet-2&quot;,</span><br><span class="line">        &quot;EndpointID&quot;: &quot;868c73cf8b7b734a65837bf6eb6ed197c98a68b416f91ce7c2e7ea8f24cbba8d&quot;,</span><br><span class="line">        &quot;MacAddress&quot;: &quot;02:42:ac:0b:00:02&quot;,</span><br><span class="line">        &quot;IPv4Address&quot;: &quot;172.11.0.2/16&quot;,</span><br><span class="line">        &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;97cf9d5c3505d68546db70b67c65923103a05818243b00b6409f462515200136&quot;: &#123;</span><br><span class="line">        &quot;Name&quot;: &quot;tomcat-mynet-1&quot;,</span><br><span class="line">        &quot;EndpointID&quot;: &quot;bf315a5c26ab09131c88acefb291652c507b8c04d51e678d7370e108771eec55&quot;,</span><br><span class="line">        &quot;MacAddress&quot;: &quot;02:42:ac:0b:00:03&quot;,</span><br><span class="line">        &quot;IPv4Address&quot;: &quot;172.11.0.3/16&quot;,</span><br><span class="line">        &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æµ‹è¯•è‡ªå®šä¹‰ç½‘ç»œçš„å®¹å™¨äº’è”</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it tomcat-mynet-1 ping tomcat-mynet-2</span><br><span class="line">PING tomcat-mynet-2 (172.11.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from tomcat-mynet-2.mynet (172.11.0.2): icmp_seq=1 ttl=64 time=0.096 ms</span><br><span class="line">64 bytes from tomcat-mynet-2.mynet (172.11.0.2): icmp_seq=2 ttl=64 time=0.094 ms</span><br><span class="line">64 bytes from tomcat-mynet-2.mynet (172.11.0.2): icmp_seq=3 ttl=64 time=0.077 ms</span><br><span class="line">^C</span><br><span class="line">--- tomcat-mynet-2 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 31ms</span><br><span class="line">rtt min/avg/max/mdev = 0.077/0.089/0.096/0.008 ms</span><br><span class="line">$ docker <span class="built_in">exec</span> -it tomcat-mynet-2 ping tomcat-mynet-1</span><br><span class="line">PING tomcat-mynet-1 (172.11.0.3) 56(84) bytes of data.</span><br><span class="line">64 bytes from tomcat-mynet-1.mynet (172.11.0.3): icmp_seq=1 ttl=64 time=0.092 ms</span><br><span class="line">64 bytes from tomcat-mynet-1.mynet (172.11.0.3): icmp_seq=2 ttl=64 time=0.080 ms</span><br><span class="line">64 bytes from tomcat-mynet-1.mynet (172.11.0.3): icmp_seq=3 ttl=64 time=0.072 ms</span><br><span class="line">^C</span><br><span class="line">--- tomcat-mynet-1 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 38ms</span><br><span class="line">rtt min/avg/max/mdev = 0.072/0.081/0.092/0.011 ms</span><br></pre></td></tr></table></figure><p><strong>åˆ›å»ºä½¿ç”¨é»˜è®¤ç½‘ç»œçš„å®¹å™¨</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d --name tomcat-docker0 tomcat</span><br><span class="line">e8408dbf5c1e3ddbe0adfee16ab9c8965f9889c55299e50ce1db381401f26c2a</span><br></pre></td></tr></table></figure><p><strong>æµ‹è¯•ä¸åŒç½‘ç»œçš„å®¹å™¨çš„è¿é€šæ€§</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it tomcat-mynet-1 ping tomcat-docker0</span><br><span class="line">ping: tomcat-docker0: Name or service not known</span><br></pre></td></tr></table></figure><p>å‘ç°ä¸åŒç½‘ç»œå†…çš„å®¹å™¨å¹¶ä¸ç›¸é€šã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Œçœ‹ä¸‹å›¾ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-11-08_16-39-40.png" alt="Snipaste_2020-11-08_16-39-40"></p><h3 id="ç½‘ç»œæ‰“é€š"><a href="#ç½‘ç»œæ‰“é€š" class="headerlink" title="ç½‘ç»œæ‰“é€š"></a>ç½‘ç»œæ‰“é€š</h3><p>è§£å†³åŠæ³•ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-11-08_16-41-09.png" alt="Snipaste_2020-11-08_16-41-09"></p><p>åŸç†ï¼šå‡å¦‚ä½¿<code>tomcat-mynet-1</code>è¿æ¥åˆ°<code>tomcat-docker0</code>ï¼Œåˆ™åœ¨<code>tomcat-mynet-1</code>å·²æœ‰ç½‘ç»œçš„åŸºç¡€ä¸Šå†æ¬¡æ·»åŠ ä¸€ä¸ªdocker0ç½‘ç»œçš„IPã€‚<font color="red"><strong>å³ä¸€ä¸ªå®¹å™¨å¤šä¸ªIP</strong></font></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker network  connect bridge tomcat-mynet-1</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æˆ‘ä»¬æŸ¥çœ‹<code>tomcat-mynet-1</code>çš„ç½‘ç»œä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker inspect tomcat-mynet-1</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&quot;Networks&quot;: &#123;</span><br><span class="line">               &quot;bridge&quot;: &#123;</span><br><span class="line">                   &quot;IPAMConfig&quot;: &#123;&#125;,</span><br><span class="line">                   &quot;Links&quot;: null,</span><br><span class="line">                   &quot;Aliases&quot;: [],</span><br><span class="line">                   &quot;NetworkID&quot;: &quot;fe5399aad1b445bf0dce36a7ed705e597714226a4872986a49a70aea9443e795&quot;,</span><br><span class="line">                   &quot;EndpointID&quot;: &quot;4781b0bb8330308ba0c4d2e64c11edd29ab03cc8d0afadcca0ae3279af7b95a3&quot;,</span><br><span class="line">                   &quot;Gateway&quot;: &quot;172.17.0.1&quot;,</span><br><span class="line">                   &quot;IPAddress&quot;: &quot;172.17.0.3&quot;,</span><br><span class="line">                   &quot;IPPrefixLen&quot;: 16,</span><br><span class="line">                   &quot;IPv6Gateway&quot;: &quot;&quot;,</span><br><span class="line">                   &quot;GlobalIPv6Address&quot;: &quot;&quot;,</span><br><span class="line">                   &quot;GlobalIPv6PrefixLen&quot;: 0,</span><br><span class="line">                   &quot;MacAddress&quot;: &quot;02:42:ac:11:00:03&quot;,</span><br><span class="line">                   &quot;DriverOpts&quot;: &#123;&#125;</span><br><span class="line">               &#125;,</span><br><span class="line">               &quot;mynet&quot;: &#123;</span><br><span class="line">                   &quot;IPAMConfig&quot;: null,</span><br><span class="line">                   &quot;Links&quot;: null,</span><br><span class="line">                   &quot;Aliases&quot;: [</span><br><span class="line">                       &quot;97cf9d5c3505&quot;</span><br><span class="line">                   ],</span><br><span class="line">                   &quot;NetworkID&quot;: &quot;b2c091bf96ebf3ea4ff0ed3427d36b83c31632d8b52aaf2b67afda26b2c54a5f&quot;,</span><br><span class="line">                   &quot;EndpointID&quot;: &quot;bf315a5c26ab09131c88acefb291652c507b8c04d51e678d7370e108771eec55&quot;,</span><br><span class="line">                   &quot;Gateway&quot;: &quot;172.11.0.1&quot;,</span><br><span class="line">                   &quot;IPAddress&quot;: &quot;172.11.0.3&quot;,</span><br><span class="line">                   &quot;IPPrefixLen&quot;: 16,</span><br><span class="line">                   &quot;IPv6Gateway&quot;: &quot;&quot;,</span><br><span class="line">                   &quot;GlobalIPv6Address&quot;: &quot;&quot;,</span><br><span class="line">                   &quot;GlobalIPv6PrefixLen&quot;: 0,</span><br><span class="line">                   &quot;MacAddress&quot;: &quot;02:42:ac:0b:00:03&quot;,</span><br><span class="line">                   &quot;DriverOpts&quot;: null</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å‘ç°æ­¤å®¹å™¨åŒæ—¶æœ‰2ä¸ªIPï¼š</p><ul><li>172.11.0.3</li><li>172.17.0.3</li></ul><p><del>æ­£å› ä¸ºå®ƒä¹Ÿåœ¨ç½‘ç»œ<code>bridge</code>ä¸­ï¼Œæ‰€ä»¥å®ƒèƒ½è¿é€š<code>tomcat-docker0</code></del>ï¼Œå‘ç°ä¹Ÿè¿ä¸é€šï¼Œæ‰æƒ³åˆ°é»˜è®¤ç½‘å¡docker0==bridgeæ˜¯å®¹å™¨äº’è”ä¸æ”¯æŒçš„ã€‚</p><p>ä»¥ä¸‹æ–°å»ºä¸€ä¸ªç½‘ç»œ<code>mynet1</code>ï¼Œåˆ›å»ºå®¹å™¨<code>tomcat-mynet1-1</code>ï¼Œå¹¶å°†å®¹å™¨<code>tomcat-mynet-1</code>åŠ å…¥ç½‘ç»œ<code>mynet1</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker network create --subnet 172.13.0.0 --gateway 172.13.0.1 mynet1</span><br><span class="line">invalid subnet: invalid CIDR address: 172.13.0.0</span><br><span class="line">$ docker network create --subnet 172.13.0.0/16 --gateway 172.13.0.1 mynet1</span><br><span class="line">00e7d460e27849646a4be5fe5f2773ac698f014377391ccb3a8ea637f09c3e49</span><br><span class="line">$ docker run --name tomcat-mynet1-1 -d --network=mynet1 tomcat</span><br><span class="line">219598c82425458a509294e3efdc5d4f1ac8088ae8edbcc67297da641cfe138e</span><br><span class="line">$ docker network connect mynet1 tomcat-mynet-1</span><br></pre></td></tr></table></figure><p><font color="red"><strong>æµ‹è¯•ç½‘ç»œæ‰“é€š</strong></font></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it tomcat-mynet-1 ping tomcat-mynet1-1</span><br><span class="line">PING tomcat-mynet1-1 (172.13.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from tomcat-mynet1-1.mynet1 (172.13.0.2): icmp_seq=1 ttl=64 time=0.140 ms</span><br><span class="line">64 bytes from tomcat-mynet1-1.mynet1 (172.13.0.2): icmp_seq=2 ttl=64 time=0.081 ms</span><br><span class="line">^C</span><br><span class="line">--- tomcat-mynet1-1 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 5ms</span><br><span class="line">rtt min/avg/max/mdev = 0.081/0.110/0.140/0.031 ms</span><br><span class="line">$ docker <span class="built_in">exec</span> -it tomcat-mynet-2 ping tomcat-mynet1-1</span><br><span class="line">ping: tomcat-mynet1-1: Name or service not known</span><br></pre></td></tr></table></figure><blockquote><p>ç»“è®ºï¼šå‘ç°é…ç½®äº†ç½‘ç»œ<code>mynet1</code>çš„å®¹å™¨<code>tomcat-mynet-1</code>èƒ½è¿é€š<code>tomcat-mynet1-1</code>ï¼Œè€Œæ²¡æœ‰æ‰“é€šç½‘ç»œçš„å®¹å™¨<code>tomcat-mynet-2</code>åˆ™ä¸è¡Œã€‚<font color="red">è¿™è¯æ˜äº†æˆ‘ä»¬çš„é…ç½®æ˜¯æ­£ç¡®çš„ã€‚åŸç†ï¼šä¸€ä¸ªå®¹å™¨å¤šä¸ªIP</font></p></blockquote><blockquote><p>æ³¨æ„ï¼šå¦å¤–ä¸ä½¿ç”¨çš„ç½‘ç»œä¹Ÿå¯ä»¥é€šè¿‡<code>docker network prune</code>æ¥æ¸…é™¤ã€‚å®ƒä¸åƒæ•°æ®å·å ç”¨å¤§é‡ç©ºé—´ï¼Œä¹Ÿä¸ç”¨ç»å¸¸åœ¨æ„ã€‚</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Dockerç½‘ç»œ&quot;&gt;&lt;a href=&quot;#Dockerç½‘ç»œ&quot; class=&quot;headerlink&quot; title=&quot;Dockerç½‘ç»œ&quot;&gt;&lt;/a&gt;Dockerç½‘ç»œ&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;Docker å…è®¸é€šè¿‡å¤–éƒ¨è®¿é—®å®¹å™¨æˆ–å®¹å™¨äº’è”çš„æ–¹å¼æ¥æä¾›ç½‘ç»œæœåŠ¡ã€‚</summary>
      
    
    
    
    <category term="Docker" scheme="https://awslzhang.top/categories/Docker/"/>
    
    
    <category term="Docker" scheme="https://awslzhang.top/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>Dockeræ•°æ®å·</title>
    <link href="https://awslzhang.top/2020/11/13/Docker%E6%95%B0%E6%8D%AE%E5%8D%B7/"/>
    <id>https://awslzhang.top/2020/11/13/Docker%E6%95%B0%E6%8D%AE%E5%8D%B7/</id>
    <published>2020-11-13T11:33:38.000Z</published>
    <updated>2021-01-01T05:49:59.916Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®å·"><a href="#ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®å·" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®å·"></a>ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®å·</h1><p>è¿™å¾—ä» docker å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿè¯´èµ·ã€‚å‡ºäºæ•ˆç‡ç­‰ä¸€ç³»åˆ—åŸå› ï¼Œdocker å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿåœ¨å®¿ä¸»æœºä¸Šå­˜åœ¨çš„æ–¹å¼å¾ˆå¤æ‚ï¼Œè¿™ä¼šå¸¦æ¥ä¸‹é¢å‡ ä¸ªé—®é¢˜ï¼š</p><ul><li>ä¸èƒ½åœ¨å®¿ä¸»æœºä¸Šå¾ˆæ–¹ä¾¿åœ°è®¿é—®å®¹å™¨ä¸­çš„æ–‡ä»¶ã€‚</li><li>æ— æ³•åœ¨å¤šä¸ªå®¹å™¨ä¹‹é—´å…±äº«æ•°æ®ã€‚</li><li><font color="red">å½“å®¹å™¨åˆ é™¤æ—¶ï¼Œå®¹å™¨ä¸­äº§ç”Ÿçš„æ•°æ®å°†ä¸¢å¤±ã€‚</font></li></ul><p>è¿™æ ·æ¯”å¦‚è¯´ä½ å¯åŠ¨äº†ä¸€ä¸ªMySQLå®¹å™¨ï¼Œä¹‹åæ·»åŠ çš„æ•°æ®å…¨åœ¨å®¹å™¨ä¸­ï¼Œå½“æŸå¤©å®¹å™¨è¢«åˆ é™¤æ•°æ®éšä¹‹åˆ é™¤ï¼Œå¹¶ä¸èƒ½åšåˆ°æ•°æ®çš„æŒä¹…åŒ–ã€‚</p><hr><p>ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œdocker å¼•å…¥äº†<strong>æ•°æ®å·(volume) æœºåˆ¶</strong>ã€‚æ•°æ®å·æ˜¯å­˜åœ¨äºä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ä¸­çš„ç‰¹å®š<font color="red"><strong>æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹</strong></font>ï¼Œè¿™ä¸ªæ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ä»¥ç‹¬ç«‹äº docker æ–‡ä»¶ç³»ç»Ÿçš„å½¢å¼å­˜åœ¨äºå®¿ä¸»æœºä¸­ã€‚æ•°æ®å·çš„æœ€å¤§ç‰¹å®šæ˜¯ï¼š<font color="red"><strong>å…¶ç”Ÿå­˜å‘¨æœŸç‹¬ç«‹äºå®¹å™¨çš„ç”Ÿå­˜å‘¨æœŸ</strong></font></p><h1 id="æ•°æ®å·"><a href="#æ•°æ®å·" class="headerlink" title="æ•°æ®å·"></a>æ•°æ®å·</h1><p><code>æ•°æ®å·</code> æ˜¯ä¸€ä¸ªå¯ä¾›ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ä½¿ç”¨çš„ç‰¹æ®Šç›®å½•ï¼Œå®ƒç»•è¿‡ UFSï¼Œå¯ä»¥æä¾›å¾ˆå¤šæœ‰ç”¨çš„ç‰¹æ€§ï¼š</p><ul><li><code>æ•°æ®å·</code> å¯ä»¥åœ¨å®¹å™¨ä¹‹é—´å…±äº«å’Œé‡ç”¨</li><li>å¯¹ <code>æ•°æ®å·</code> çš„ä¿®æ”¹ä¼šç«‹é©¬ç”Ÿæ•ˆ</li><li>å¯¹ <code>æ•°æ®å·</code> çš„æ›´æ–°ï¼Œä¸ä¼šå½±å“é•œåƒ</li><li><code>æ•°æ®å·</code> é»˜è®¤ä¼šä¸€ç›´å­˜åœ¨ï¼Œå³ä½¿å®¹å™¨è¢«åˆ é™¤</li></ul><blockquote><p>æ³¨æ„ï¼š<code>æ•°æ®å·</code> çš„ä½¿ç”¨ï¼Œç±»ä¼¼äº Linux ä¸‹å¯¹ç›®å½•æˆ–æ–‡ä»¶è¿›è¡Œ mountï¼Œé•œåƒä¸­çš„è¢«æŒ‡å®šä¸ºæŒ‚è½½ç‚¹çš„ç›®å½•ä¸­çš„æ–‡ä»¶ä¼šå¤åˆ¶åˆ°æ•°æ®å·ä¸­ï¼ˆä»…æ•°æ®å·ä¸ºç©ºæ—¶ä¼šå¤åˆ¶ï¼‰ã€‚</p></blockquote><blockquote><p>æ³¨æ„ï¼šæŒ‚è½½æ•°æ®å·æ—¶ï¼Œåˆ†åˆ«å¯ä»¥æ˜¯ç›®å½•æˆ–æ–‡ä»¶ï¼Œå®ƒåªèƒ½åŒ…å«ä¸¤ç§å¯èƒ½ï¼šç›®å½•:ç›®å½•ï¼›æ–‡ä»¶:æ–‡ä»¶</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-11-12_15-10-00.png" alt="s"></p><h2 id="åˆ›å»ºä¸€ä¸ªæ•°æ®å·"><a href="#åˆ›å»ºä¸€ä¸ªæ•°æ®å·" class="headerlink" title="åˆ›å»ºä¸€ä¸ªæ•°æ®å·"></a>åˆ›å»ºä¸€ä¸ªæ•°æ®å·</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume create my-vol</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æ‰€æœ‰çš„ <code>æ•°æ®å·</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker volume ls</span><br><span class="line">DRIVER              VOLUME NAMElocal               my-vol</span><br></pre></td></tr></table></figure><p>åœ¨ä¸»æœºé‡Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹æŒ‡å®š <code>æ•°æ®å·</code> çš„ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ docker volume inspect my-vol</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&quot;Mountpoint&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/my-vol/_data&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;my-vol&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h2 id="å¯åŠ¨ä¸€ä¸ªæŒ‚è½½æ•°æ®å·çš„å®¹å™¨"><a href="#å¯åŠ¨ä¸€ä¸ªæŒ‚è½½æ•°æ®å·çš„å®¹å™¨" class="headerlink" title="å¯åŠ¨ä¸€ä¸ªæŒ‚è½½æ•°æ®å·çš„å®¹å™¨"></a>å¯åŠ¨ä¸€ä¸ªæŒ‚è½½æ•°æ®å·çš„å®¹å™¨</h2><p>æˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªæŒ‚åœ¨æ•°æ®å·çš„å®¹å™¨æ—¶ä¸€å®šè¦å‚ç…§å®˜æ–¹æ–‡æ¡£ï¼Œä»¥å®ç°MySQLçš„æŒä¹…åŒ–æ•°æ®ä¸ºç›®çš„æ¥å®ç°å¯åŠ¨ä¸€ä¸ªæŒ‚è½½æ•°æ®å·çš„å®¹å™¨ã€‚</p><p>é€šè¿‡è¿æ¥ï¼š<a href="https://hub.docker.com/_/mysql%E4%B8%AD%E7%9A%84%E5%86%85%E5%AE%B9%EF%BC%9A">https://hub.docker.com/_/mysqlä¸­çš„å†…å®¹ï¼š</a></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/mysql.png"></p><p>ä»¥ä¸Šå¾—çŸ¥MySQLçš„æ•°æ®å­˜æ”¾åœ¨å®¹å™¨ä¸­çš„<code>/var/lib/mysql</code>ç›®å½•ä¸­ï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥å°†å®¿ä¸»æœºçš„ä¸€ä¸ªç›®å½•å’Œå…¶ç»‘å®šã€‚å…·ä½“æœ‰å¤šç§æŒ‚è½½æ–¹å¼ï¼š</p><ul><li>åŒ¿åæŒ‚è½½</li><li>å…·åæŒ‚è½½</li><li>æŒ‡å®šç›®å½•æŒ‚è½½</li></ul><p>ä»¥æŒ‡å®šç›®å½•æŒ‚è½½ä¸ºä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --name some-mysql -v /my/own/datadir:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7</span><br></pre></td></tr></table></figure><h2 id="æŸ¥çœ‹æ•°æ®å·çš„å…·ä½“ä¿¡æ¯"><a href="#æŸ¥çœ‹æ•°æ®å·çš„å…·ä½“ä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹æ•°æ®å·çš„å…·ä½“ä¿¡æ¯"></a>æŸ¥çœ‹æ•°æ®å·çš„å…·ä½“ä¿¡æ¯</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker inspect some-mysql</span><br></pre></td></tr></table></figure><p>æˆªå–åˆ°æ•°æ®å·çš„ä¿¡æ¯ï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&quot;Mounts&quot;: [</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;bind&quot;</span>,</span><br><span class="line">               <span class="attr">&quot;Source&quot;</span>: <span class="string">&quot;/my/own/datadir&quot;</span>,</span><br><span class="line">               <span class="attr">&quot;Destination&quot;</span>: <span class="string">&quot;/var/lib/mysql&quot;</span>,</span><br><span class="line">               <span class="attr">&quot;Mode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">               <span class="attr">&quot;RW&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">               <span class="attr">&quot;Propagation&quot;</span>: <span class="string">&quot;rprivate&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       ]</span><br></pre></td></tr></table></figure><h2 id="åˆ é™¤æ•°æ®å·"><a href="#åˆ é™¤æ•°æ®å·" class="headerlink" title="åˆ é™¤æ•°æ®å·"></a>åˆ é™¤æ•°æ®å·</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker volume rm my-vol</span><br></pre></td></tr></table></figure><p><code>æ•°æ®å·</code> æ˜¯è¢«è®¾è®¡ç”¨æ¥æŒä¹…åŒ–æ•°æ®çš„ï¼Œ<font color="red">å®ƒçš„ç”Ÿå‘½å‘¨æœŸç‹¬ç«‹äºå®¹å™¨ï¼ŒDocker ä¸ä¼šåœ¨å®¹å™¨è¢«åˆ é™¤åè‡ªåŠ¨åˆ é™¤ <code>æ•°æ®å·</code>ï¼Œå¹¶ä¸”ä¹Ÿä¸å­˜åœ¨åƒåœ¾å›æ”¶è¿™æ ·çš„æœºåˆ¶æ¥å¤„ç†æ²¡æœ‰ä»»ä½•å®¹å™¨å¼•ç”¨çš„ <code>æ•°æ®å·</code>ã€‚</font>å¦‚æœéœ€è¦åœ¨åˆ é™¤å®¹å™¨çš„åŒæ—¶ç§»é™¤æ•°æ®å·ã€‚å¯ä»¥åœ¨åˆ é™¤å®¹å™¨çš„æ—¶å€™ä½¿ç”¨ <code>docker rm -v</code> è¿™ä¸ªå‘½ä»¤ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/volume.png"></p><hr><p><font color="red"><strong>æ— ä¸»çš„æ•°æ®å·å¯èƒ½ä¼šå æ®å¾ˆå¤šç©ºé—´ï¼Œè¦æ¸…ç†è¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤</strong></font></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker volume prune</span><br></pre></td></tr></table></figure><h1 id="æ•°æ®å·æŒ‚è½½ç§ç±»"><a href="#æ•°æ®å·æŒ‚è½½ç§ç±»" class="headerlink" title="æ•°æ®å·æŒ‚è½½ç§ç±»"></a>æ•°æ®å·æŒ‚è½½ç§ç±»</h1><h2 id="åŒ¿åæŒ‚è½½"><a href="#åŒ¿åæŒ‚è½½" class="headerlink" title="åŒ¿åæŒ‚è½½"></a>åŒ¿åæŒ‚è½½</h2><p>åŒ¿åæŒ‚è½½å°±æ˜¯åœ¨æ•°æ®å·æŒ‚è½½æ—¶ä¸æŒ‡å®šåç§°ï¼Œç›´æ¥è¾“å…¥è¦æŒ‚è½½çš„å®¹å™¨å†…çš„è·¯å¾„å³å¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --name some-mysql1 -v /var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7</span><br></pre></td></tr></table></figure><p><strong>é‚£ä¹ˆæ­¤å®¹å™¨çš„æ•°æ®å·æŒ‚è½½åˆ°å®¿ä¸»æœºçš„å“ªäº†ï¼Ÿ</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker inspect some-mysql1</span><br></pre></td></tr></table></figure><p>æˆªå–åˆ°æ•°æ®å·çš„ä¿¡æ¯ï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&quot;Mounts&quot;: [</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="attr">&quot;Type&quot;</span>: <span class="string">&quot;volume&quot;</span>,</span><br><span class="line">               <span class="attr">&quot;Name&quot;</span>: <span class="string">&quot;8ca6908c31d8fdfe15bd9b2abad40e602d567980501cef921ea5437ae3df7bd6&quot;</span>,</span><br><span class="line">               <span class="attr">&quot;Source&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/8ca6908c31d8fdfe15bd9b2abad40e602d567980501cef921ea5437ae3df7bd6/_data&quot;</span>,</span><br><span class="line">               <span class="attr">&quot;Destination&quot;</span>: <span class="string">&quot;/var/lib/mysql&quot;</span>,</span><br><span class="line">               <span class="attr">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">               <span class="attr">&quot;Mode&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">               <span class="attr">&quot;RW&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">               <span class="attr">&quot;Propagation&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">           &#125;</span><br><span class="line">       ]</span><br></pre></td></tr></table></figure><p>å‘ç°æ•°æ®å·åä¸ºï¼š<code>8ca6908c31d8fdfe15bd9b2abad40e602d567980501cef921ea5437ae3df7bd6</code>ï¼ŒæŒ‚è½½åˆ°äº†<code>/var/lib/docker/volumes/8ca6908c31d8fdfe15bd9b2abad40e602d567980501cef921ea5437ae3df7bd6/_data</code></p><h2 id="å…·åæŒ‚è½½"><a href="#å…·åæŒ‚è½½" class="headerlink" title="å…·åæŒ‚è½½"></a>å…·åæŒ‚è½½</h2><p>åŒ¿åæŒ‚è½½å°±æ˜¯åœ¨æ•°æ®å·æŒ‚è½½æ—¶æŒ‡å®šæ•°æ®å·åç§°(<strong>é‚£ä¹ˆæ­¤æ—¶å°±ä¸èƒ½è¾“å…¥å®¿ä¸»æœºè·¯å¾„äº†</strong>)ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --name some-mysql2 -v mydata:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7</span><br></pre></td></tr></table></figure><p><strong>é€šè¿‡æ•°æ®å·æŸ¥çœ‹å‘½ä»¤å¾—åˆ°æœ‰åç§°çš„æ•°æ®å·</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker volume ls</span><br><span class="line">DRIVER              VOLUME NAME</span><br><span class="line"><span class="built_in">local</span>               8ca6908c31d8fdfe15bd9b2abad40e602d567980501cef921ea5437ae3df7bd6</span><br><span class="line"><span class="built_in">local</span>               mydata</span><br></pre></td></tr></table></figure><h2 id="æŒ‡å®šç›®å½•æŒ‚è½½"><a href="#æŒ‡å®šç›®å½•æŒ‚è½½" class="headerlink" title="æŒ‡å®šç›®å½•æŒ‚è½½"></a>æŒ‡å®šç›®å½•æŒ‚è½½</h2><p>æ‰‹åŠ¨æŒ‡å®šå®¿ä¸»æœºçš„ç›®å½•/æ–‡ä»¶å’Œå®¹å™¨çš„ç›®å½•/æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --name some-mysql -v /my/own/datadir:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7</span><br></pre></td></tr></table></figure><hr><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æˆ‘ä»¬é€šè¿‡å…·åæŒ‚è½½å¯ä»¥æ–¹ä¾¿çš„æ‰¾åˆ°æˆ‘ä»¬çš„ä¸€ä¸ªå·ï¼Œå¤§å¤šæ•°æƒ…å†µåœ¨ä½¿ç”¨çš„ï¼Œä¸å»ºè®®å¤§å®¶ä½¿ç”¨åŒ¿åæŒ‚è½½</p><p>å¦‚ä½•ç¡®å®šæ˜¯åŒ¿åæŒ‚è½½è¿˜æ˜¯å…·åæŒ‚è½½å‘¢ï¼Ÿ</p><ul><li>-v å®¹å™¨å†…è·¯å¾„         #åŒ¿åæŒ‚è½½</li><li>-v å·åï¼šå®¹å™¨å†…è·¯å¾„      #å…·åæŒ‚è½½</li><li>-v /å®¿ä¸»æœºè·¯å¾„ï¼šå®¹å™¨å†…è·¯å¾„   #æŒ‡å®šè·¯å¾„æŒ‚è½½</li></ul><h1 id="æ•°æ®å·æƒé™"><a href="#æ•°æ®å·æƒé™" class="headerlink" title="æ•°æ®å·æƒé™"></a>æ•°æ®å·æƒé™</h1><p><strong>é€šè¿‡ <code>-v </code>å®¹å™¨å†…è·¯å¾„:ro rw æ”¹å˜è¯»å†™æƒé™</strong></p><ul><li><code>ro</code>ï¼šreadonly  #åªè¯»</li><li><code>rw</code>ï¼šreadwrite #å¯è¯»å¯å†™</li></ul><p>ä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -P --name nginx02 -v juming-nginx:/etc/nginx:ro  nginx</span><br></pre></td></tr></table></figure><blockquote><p>åªè¦çœ‹åˆ°roå°±è¯´æ˜è¿™ä¸ªè·¯å¾„åªèƒ½é€šè¿‡å®¿ä¸»æœºæ¥æ”¹å˜ï¼Œ<font color="red">å®¹å™¨å†…éƒ¨æ˜¯æ— æ³•æ“ä½œçš„</font></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®å·&quot;&gt;&lt;a href=&quot;#ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®å·&quot; class=&quot;headerlink&quot; title=&quot;ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®å·&quot;&gt;&lt;/a&gt;ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®å·&lt;/h1&gt;&lt;p&gt;è¿™å¾—ä» docker å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿè¯´èµ·ã€‚å‡ºäºæ•ˆç‡ç­‰ä¸€ç³»åˆ—åŸå› ï¼Œdocker å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿ</summary>
      
    
    
    
    <category term="Docker" scheme="https://awslzhang.top/categories/Docker/"/>
    
    
    <category term="Docker" scheme="https://awslzhang.top/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>æ„å»ºé•œåƒä¹‹Dockerfile</title>
    <link href="https://awslzhang.top/2020/11/07/%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F%E4%B9%8BDockerfile/"/>
    <id>https://awslzhang.top/2020/11/07/%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F%E4%B9%8BDockerfile/</id>
    <published>2020-11-07T03:27:38.000Z</published>
    <updated>2021-01-01T05:50:00.099Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h1><p>Dockeré€šè¿‡ä»ä¸€ä¸ª<code>Dockerfile</code>æ–‡æœ¬æ–‡ä»¶ä¸­è¯»å–æŒ‡ä»¤æ¥è‡ªåŠ¨æ„å»ºæ˜ åƒï¼Œè¯¥ æ–‡æœ¬æ–‡ä»¶æŒ‰é¡ºåºåŒ…å«æ„å»ºç»™å®šæ˜ åƒæ‰€éœ€çš„æ‰€æœ‰å‘½ä»¤ã€‚<code>Dockerfile</code>éµå¾ªç‰¹å®šçš„æ ¼å¼å’ŒæŒ‡ä»¤é›†ï¼Œæ‚¨å¯ä»¥åœ¨<a href="https://docs.docker.com/engine/reference/builder/">Dockerfileå‚è€ƒä¸­</a>æ‰¾åˆ°ã€‚</p><p>Dockeræ˜ åƒç”±åªè¯»å±‚ç»„æˆï¼Œæ¯ä¸ªåªè¯»å±‚ä»£è¡¨ä¸€ä¸ªDockerfileæŒ‡ä»¤ã€‚è¿™äº›å±‚æ˜¯å †å çš„ï¼Œæ¯ä¸ªå±‚éƒ½æ˜¯ä¸Šä¸€å±‚çš„å˜åŒ–çš„å¢é‡ã€‚è€ƒè™‘ä¸€ä¸‹<code>Dockerfile</code>ï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">18.04</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . /app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> make /app</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> python /app/app.py</span></span><br></pre></td></tr></table></figure><p>æ¯æ¡æŒ‡ä»¤åˆ›å»ºä¸€å±‚ï¼š</p><ul><li><code>FROM</code>ä»<code>ubuntu:18.04</code>Dockeræ˜ åƒåˆ›å»ºä¸€ä¸ªå›¾å±‚ã€‚</li><li><code>COPY</code> ä»Dockerå®¢æˆ·ç«¯çš„å½“å‰ç›®å½•æ·»åŠ æ–‡ä»¶ã€‚</li><li><code>RUN</code>ä½¿ç”¨æ„å»ºæ‚¨çš„åº”ç”¨ç¨‹åº<code>make</code>ã€‚</li><li><code>CMD</code> æŒ‡å®šè¦åœ¨å®¹å™¨ä¸­è¿è¡Œçš„å‘½ä»¤ã€‚</li></ul><p>è¿è¡Œå›¾åƒå¹¶ç”Ÿæˆå®¹å™¨æ—¶ï¼Œå¯ä»¥ åœ¨åŸºç¡€å±‚ä¹‹ä¸Šæ·»åŠ ä¸€ä¸ªæ–°çš„<em>å¯å†™å±‚</em>ï¼ˆâ€œå®¹å™¨å±‚â€ï¼‰ã€‚å¯¹è¿è¡Œä¸­çš„å®¹å™¨æ‰€åšçš„æ‰€æœ‰æ›´æ”¹ï¼ˆä¾‹å¦‚å†™å…¥æ–°æ–‡ä»¶ï¼Œä¿®æ”¹ç°æœ‰æ–‡ä»¶å’Œåˆ é™¤æ–‡ä»¶ï¼‰éƒ½å°†å†™å…¥æ­¤è–„å¯å†™å®¹å™¨å±‚ã€‚</p><h2 id="ç”¨æ³•"><a href="#ç”¨æ³•" class="headerlink" title="ç”¨æ³•"></a>ç”¨æ³•</h2><p><code>docker build</code>å‘½ä»¤ä»ä¸€ä¸ªæ„å»ºçš„å›¾åƒ<code>Dockerfile</code>å’Œä¸€ä¸ª<em>ä¸Šä¸‹æ–‡</em>ã€‚æ„å»ºçš„ä¸Šä¸‹æ–‡æ˜¯æŒ‡å®šä½ç½®<code>PATH</code>æˆ–çš„æ–‡ä»¶é›†<code>URL</code>ã€‚è¿™<code>PATH</code>æ˜¯æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸Šçš„ç›®å½•ã€‚è¯¥<code>URL</code>æ˜¯ä¸€ä¸ªGitä»“åº“çš„ä½ç½®ã€‚</p><p>ä¸Šä¸‹æ–‡æ˜¯é€’å½’å¤„ç†çš„ã€‚å› æ­¤ï¼Œ<code>PATH</code>åŒ…æ‹¬ä»»ä½•å­ç›®å½•ï¼Œå¹¶ä¸”<code>URL</code>åŒ…æ‹¬å­˜å‚¨åº“åŠå…¶å­æ¨¡å—ã€‚æ­¤ç¤ºä¾‹æ˜¾ç¤ºäº†ä¸€ä¸ªä½¿ç”¨å½“å‰ç›®å½•ä½œä¸ºä¸Šä¸‹æ–‡çš„æ„å»ºå‘½ä»¤ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker build .</span><br><span class="line"></span><br><span class="line">Sending build context to Docker daemon  6.51 MB</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>æ„å»ºæ˜¯ç”±Dockerå®ˆæŠ¤ç¨‹åºè€Œä¸æ˜¯CLIè¿è¡Œçš„ã€‚ç”Ÿæˆè¿‡ç¨‹è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯å°†æ•´ä¸ªä¸Šä¸‹æ–‡ï¼ˆé€’å½’ï¼‰å‘é€åˆ°å®ˆæŠ¤ç¨‹åºã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ<strong>æœ€å¥½ä»ç©ºç›®å½•å¼€å§‹ä½œä¸ºä¸Šä¸‹æ–‡ï¼Œå¹¶å°†Dockerfileä¿ç•™åœ¨è¯¥ç›®å½•ä¸­ã€‚ä»…æ·»åŠ æ„å»ºDockerfileæ‰€éœ€çš„æ–‡ä»¶ã€‚</strong></p><blockquote><p><strong>è­¦å‘Š</strong></p><p>ä¸è¦ç”¨ä½ çš„æ ¹ç›®å½•ä¸‹ï¼Œ<code>/</code>ä½œä¸º<code>PATH</code>å› ä¸ºå®ƒä¼šå¯¼è‡´ç”Ÿæˆåˆ°æ‚¨çš„ç¡¬ç›˜é©±åŠ¨å™¨çš„å…¨éƒ¨å†…å®¹ä¼ è¾“åˆ°ç å¤´å·¥äººå®ˆæŠ¤è¿›ç¨‹ã€‚</p></blockquote><p>è¦åœ¨æ„å»ºä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨æ–‡ä»¶ï¼Œ<code>Dockerfile</code>å¼•ç”¨æ˜¯æŒ‡æŒ‡ä»¤ï¼ˆä¾‹å¦‚ï¼Œ<code>COPY</code>æŒ‡ä»¤ï¼‰ä¸­æŒ‡å®šçš„æ–‡ä»¶ã€‚è¦æé«˜æ„å»ºçš„æ€§èƒ½ï¼Œè¯·é€šè¿‡å°†<code>.dockerignore</code>æ–‡ä»¶æ·»åŠ åˆ°ä¸Šä¸‹æ–‡ç›®å½•æ¥æ’é™¤æ–‡ä»¶å’Œç›®å½•ã€‚æœ‰å…³å¦‚ä½•<a href="https://docs.docker.com/engine/reference/builder/#dockerignore-file">åˆ›å»º<code>.dockerignore</code> æ–‡ä»¶çš„ä¿¡æ¯ï¼Œ</a>è¯·å‚é˜…æ­¤é¡µé¢ä¸Šçš„æ–‡æ¡£ã€‚</p><p>ä¼ ç»Ÿä¸Šï¼Œ<code>Dockerfile</code>ç§°ä¸ºï¼Œ<code>Dockerfile</code>å¹¶ä¸”ä½äºä¸Šä¸‹æ–‡çš„æ ¹ä¸­ã€‚æ‚¨å¯ä»¥ä½¿ç”¨<code>-f</code>æ ‡å¿—with<code>docker build</code>æŒ‡å‘æ–‡ä»¶ç³»ç»Ÿä¸­ä»»æ„ä½ç½®çš„Dockerfileã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -f &#x2F;path&#x2F;to&#x2F;a&#x2F;Dockerfile .</span><br></pre></td></tr></table></figure><p>å¦‚æœæ„å»ºæˆåŠŸï¼Œåˆ™å¯ä»¥æŒ‡å®šå­˜å‚¨æ–°æ˜ åƒçš„å­˜å‚¨åº“å’Œæ ‡è®°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t shykes&#x2F;myapp .</span><br></pre></td></tr></table></figure><p>è¦åœ¨æ„å»ºåå°†æ˜ åƒæ ‡è®°åˆ°å¤šä¸ªå­˜å‚¨åº“ä¸­ï¼Œè¯·åœ¨<code>-t</code>è¿è¡Œ<code>build</code>å‘½ä»¤æ—¶æ·»åŠ å¤šä¸ªå‚æ•°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t shykes&#x2F;myapp:1.0.2 -t shykes&#x2F;myapp:latest .</span><br></pre></td></tr></table></figure><p>åœ¨Dockerå®ˆæŠ¤ç¨‹åºè¿è¡Œä¸­çš„æŒ‡ä»¤ä¹‹å‰<code>Dockerfile</code>ï¼Œå®ƒä¼šå¯¹è¿›è¡Œåˆæ­¥éªŒè¯ï¼Œ<code>Dockerfile</code>å¦‚æœè¯­æ³•ä¸æ­£ç¡®ï¼Œåˆ™è¿”å›é”™è¯¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t test&#x2F;myapp .</span><br><span class="line"></span><br><span class="line">Sending build context to Docker daemon 2.048 kB</span><br><span class="line">Error response from daemon: Unknown instruction: RUNCMD</span><br></pre></td></tr></table></figure><p>Dockerå®ˆæŠ¤ç¨‹åºä»¥<code>Dockerfile</code>ä¸€å¯¹ä¸€çš„æ–¹å¼è¿è¡ŒæŒ‡ä»¤ï¼Œå¦‚æœ‰å¿…è¦ï¼Œå°†æ¯æ¡æŒ‡ä»¤çš„ç»“æœæäº¤åˆ°æ–°æ˜ åƒï¼Œç„¶åæœ€ç»ˆè¾“å‡ºæ–°æ˜ åƒçš„IDã€‚Dockerå®ˆæŠ¤ç¨‹åºå°†è‡ªåŠ¨æ¸…ç†æ‚¨å‘é€çš„ä¸Šä¸‹æ–‡ã€‚</p><p><strong>è¯·æ³¨æ„ï¼Œæ¯æ¡æŒ‡ä»¤éƒ½æ˜¯ç‹¬ç«‹è¿è¡Œçš„ï¼Œå¹¶ä¼šå¯¼è‡´åˆ›å»ºæ–°æ˜ åƒ-å› æ­¤<code>RUN cd /tmp</code>å¯¹ä¸‹ä¸€æ¡æŒ‡ä»¤ä¸ä¼šæœ‰ä»»ä½•å½±å“ã€‚</strong></p><p>Dockerå°†å°½å¯èƒ½é‡ç”¨ä¸­é—´æ˜ åƒï¼ˆç¼“å­˜ï¼‰ï¼Œä»¥<code>docker build</code>æ˜¾ç€åŠ é€Ÿè¯¥è¿‡ç¨‹ã€‚è¿™ç”±<code>Using cache</code>æ§åˆ¶å°è¾“å‡ºä¸­çš„æ¶ˆæ¯æŒ‡ç¤ºã€‚ï¼ˆæœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§<a href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/"><code>Dockerfile</code>æœ€ä½³åšæ³•æŒ‡å—</a>ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t svendowideit&#x2F;ambassador .</span><br><span class="line"></span><br><span class="line">Sending build context to Docker daemon 15.36 kB</span><br><span class="line">Step 1&#x2F;4 : FROM alpine:3.2</span><br><span class="line"> ---&gt; 31f630c65071</span><br><span class="line">Step 2&#x2F;4 : MAINTAINER SvenDowideit@home.org.au</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 2a1c91448f5f</span><br><span class="line">Step 3&#x2F;4 : RUN apk update &amp;&amp;      apk add socat &amp;&amp;        rm -r &#x2F;var&#x2F;cache&#x2F;</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 21ed6e7fbb73</span><br><span class="line">Step 4&#x2F;4 : CMD env | grep _TCP&#x3D; | (sed &#39;s&#x2F;.*_PORT_\([0-9]*\)_TCP&#x3D;tcp:\&#x2F;\&#x2F;\(.*\):\(.*\)&#x2F;socat -t 100000000 TCP4-LISTEN:\1,fork,reuseaddr TCP4:\2:\3 \&amp;&#x2F;&#39; &amp;&amp; echo wait) | sh</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 7ea8aef582cc</span><br><span class="line">Successfully built 7ea8aef582cc</span><br></pre></td></tr></table></figure><h2 id="è¯­æ³•"><a href="#è¯­æ³•" class="headerlink" title="è¯­æ³•"></a>è¯­æ³•</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/Snipaste_2020-11-07_11-36-19.png" alt="Snipaste_2020-11-07_11-36-19"></p><ul><li><code>CMD</code>ï¼šæŒ‡å®šå®¹å™¨å¯åŠ¨æ—¶è¦è¿è¡Œçš„å‘½ä»¤ï¼Œåªæœ‰æœ€åä¸€ä¸ªç”Ÿæ•ˆï¼Œå¯ä»¥è¢«æ›¿ä»£</li><li><code>ENTRYPOINT</code>ï¼šæŒ‡å®šå®¹å™¨å¯åŠ¨æ—¶è¦è¿è¡Œçš„å‘½ä»¤ï¼Œå¯ä»¥è¿½åŠ å‘½ä»¤</li><li><code>COPY</code>ï¼šæ‹·è´å®¿ä¸»æœºæ–‡ä»¶åˆ°é•œåƒ</li><li><code>ENV</code>ï¼šæ„å»ºæ—¶è®¾ç½®ç¯å¢ƒå˜é‡</li></ul><hr><blockquote><p><strong><code>ENTRYPOINT</code>ä¸<code>CMD</code></strong></p></blockquote><p><strong>CMD</strong></p><p>å½“Dockerfileä¸­ä½¿ç”¨CMDæ—¶ï¼Œé•œåƒåœ¨ï½’ï½•ï½æˆå®¹å™¨æ—¶ï¼Œcmdä¼šè¢«æ‰§è¡Œï¼Œä½†æ˜¯å½“ä½¿ç”¨docker runå‘½ä»¤æ‰§è¡Œé•œåƒæ—¶å¦‚æœæ‰‹åŠ¨åŠ å…¥æ‰§è¡Œå‘½ä»¤(docker run xxx ls -al)åˆ™CMDçš„å‘½ä»¤ä¼šè¢«è¦†ç›–ï¼Œä¸ä¼šæ‰§è¡Œã€‚</p><p>å½“Dockerfileä¸­ä½¿ç”¨ENTRYPOINTæ—¶ï¼Œé•œåƒåœ¨ï½’ï½•ï½æˆå®¹å™¨æ—¶ï¼ŒENTRYPOINTä¼šè¢«æ‰§è¡Œï¼Œä½†æ˜¯å½“ä½¿ç”¨docker runå‘½ä»¤æ‰§è¡Œé•œåƒæ—¶å¦‚æœæ‰‹åŠ¨åŠ å…¥æ‰§è¡Œå‘½ä»¤(docker run xxx -l)åˆ™æ–°å†™çš„å‘½ä»¤ä¼šè¢«è¿½åŠ åˆ°ENTRYPOINTå‘½ä»¤ä¹‹åã€‚</p><table><thead><tr><th>Dockerfile/(CMD/ENTRYPOINT)</th><th>docker run xxx -l</th><th>docker run xxx ls -al</th></tr></thead><tbody><tr><td>CMD [â€œlsâ€,â€-aâ€]</td><td>é”™è¯¯</td><td>ls -al</td></tr><tr><td>ENTRYPOINT [â€œlsâ€,â€-aâ€]</td><td>ls -al</td><td>ls -a -alï¼ˆé”™è¯¯ï¼‰</td></tr></tbody></table><h2 id="æ„å»ºæ­¥éª¤"><a href="#æ„å»ºæ­¥éª¤" class="headerlink" title="æ„å»ºæ­¥éª¤"></a>æ„å»ºæ­¥éª¤</h2><ol><li>ç¼–å†™<code>Dockerfile</code></li><li>docker buildæ„å»ºé•œåƒ</li><li>docker runè¿è¡Œ</li><li>docker pushåˆ°xxx</li></ol><h2 id="æ ·ä¾‹"><a href="#æ ·ä¾‹" class="headerlink" title="æ ·ä¾‹"></a>æ ·ä¾‹</h2><h3 id="jdké•œåƒ"><a href="#jdké•œåƒ" class="headerlink" title="jdké•œåƒ"></a>jdké•œåƒ</h3><p>è™½ç„¶æœ‰å®˜æ–¹çš„jdkï¼Œä½†æ˜¯ä¸ºäº†å±•ç¤ºæ„å»ºï¼Œè¿™é‡Œåœ¨centosçš„åŸºç¡€ä¸Šæ„å»ºjdkï¼š</p><p><strong>1. åˆ›å»º<code>Dockerfile</code>ï¼Œå†…å®¹ä¸ºï¼š</strong></p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"><span class="keyword">MAINTAINER</span> xxx&lt;xxx@xxx.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum -y install wget</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir /usr/<span class="built_in">local</span>/java &amp;&amp; <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/java &amp;&amp; wget -P /usr/<span class="built_in">local</span>/java https://repo.huaweicloud.com/java/jdk/11.0.2+9/jdk-11.0.2_linux-x64_bin.tar.gz &amp;&amp; tar -zxvf *.gz</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME /usr/local/java/jdk-<span class="number">11.0</span>.<span class="number">2</span></span><br><span class="line"><span class="keyword">ENV</span> PATH $JAVA_HOME/bin:$PATH</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">source</span> /etc/profile</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">&quot;/bin/bash&quot;</span>]</span></span><br></pre></td></tr></table></figure><p><strong>2. æ„å»º-</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t myjdk:1.0 .</span><br></pre></td></tr></table></figure><p><strong>3. è¿è¡Œ</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it myjdk:1.0</span><br></pre></td></tr></table></figure><h2 id="Push-Docker-Hub"><a href="#Push-Docker-Hub" class="headerlink" title="Push Docker Hub"></a>Push Docker Hub</h2><ol><li>åˆ›å»ºè´¦å·</li><li><code>dockr login -u xxx</code></li><li><code>docker push [OPTIONS] NAME[:TAG]  </code></li></ol><hr>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Dockerfile&quot;&gt;&lt;a href=&quot;#Dockerfile&quot; class=&quot;headerlink&quot; title=&quot;Dockerfile&quot;&gt;&lt;/a&gt;Dockerfile&lt;/h1&gt;&lt;p&gt;Dockeré€šè¿‡ä»ä¸€ä¸ª&lt;code&gt;Dockerfile&lt;/code&gt;æ–‡æœ¬æ–‡ä»¶</summary>
      
    
    
    
    <category term="Docker" scheme="https://awslzhang.top/categories/Docker/"/>
    
    
    <category term="Docker" scheme="https://awslzhang.top/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•è®©åˆ«äººè®¿é—®åˆ°ä½ çš„æœ¬åœ°é¡¹ç›®-å†…ç½‘ç©¿é€</title>
    <link href="https://awslzhang.top/2020/10/21/%E5%A6%82%E4%BD%95%E8%AE%A9%E5%88%AB%E4%BA%BA%E8%AE%BF%E9%97%AE%E5%88%B0%E4%BD%A0%E7%9A%84%E6%9C%AC%E5%9C%B0%E9%A1%B9%E7%9B%AE-%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/"/>
    <id>https://awslzhang.top/2020/10/21/%E5%A6%82%E4%BD%95%E8%AE%A9%E5%88%AB%E4%BA%BA%E8%AE%BF%E9%97%AE%E5%88%B0%E4%BD%A0%E7%9A%84%E6%9C%AC%E5%9C%B0%E9%A1%B9%E7%9B%AE-%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/</id>
    <published>2020-10-21T13:28:55.000Z</published>
    <updated>2021-01-01T05:50:00.077Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>é¦–å…ˆè¯´ä¸‹åŸå§‹éœ€æ±‚ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼ŒIPv4 ç½‘ç»œåœ°å€æ•°é‡éå¸¸æœ‰é™ï¼Œå¤§çº¦åªæœ‰ 43 äº¿ä¸ªåœ°å€ï¼Œå…¨çƒäº’è”ç½‘å‘å±•åˆ°å¦‚ä»Šçš„ç¨‹åº¦ï¼Œæ˜¾ç„¶ä¸å¯èƒ½æ¯å°è®¾å¤‡éƒ½åˆ†é…åˆ° IPv4 åœ°å€ã€‚</p><p>é‚£ç°åœ¨å®¶åº­å®½å¸¦æ˜¯æ€ä¹ˆè¿æ¥ç½‘ç»œçš„å‘¢ï¼Ÿè¿™é‡Œä¸€èˆ¬ä¼šä½¿ç”¨ NATï¼ˆNetwork Address Translationï¼Œç½‘ç»œåœ°å€è½¬æ¢ï¼‰åœ¨ä¸€ä¸ª IPv4 åœ°å€å†…éƒ¨æ‰©å±•å‡ºä¸€ä¸ªå†…éƒ¨ç½‘ç»œï¼Œä½¿è¿™ä¸ªå†…éƒ¨ç½‘ç»œå¯ä»¥æ­£å¸¸è¿æ¥åˆ°äº’è”ç½‘ã€‚æ­¤æ—¶å†…éƒ¨è®¾å¤‡å¯ä»¥æ­£å¸¸è®¿é—®å…¨çƒ IPv4 åœ°å€ï¼ˆå³å…¬ç½‘åœ°å€ï¼‰ï¼Œä½†æ˜¯å¤–éƒ¨çš„è®¾å¤‡åªèƒ½æ‰¾åˆ°è¿™ä¸ªå†…éƒ¨ç½‘ç»œå…±ç”¨çš„å…¨çƒ IPv4 åœ°å€ï¼Œè€Œæ²¡æ³•æ‰¾åˆ°ç»è¿‡ NAT ä¹‹åçš„å†…éƒ¨è®¾å¤‡åœ°å€ã€‚</p><p>è€ƒè™‘åˆ°å¤§éƒ¨åˆ†ç”¨æˆ·çš„ä¸»è¦éœ€æ±‚æ˜¯è·å–äº’è”ç½‘ä¸Šçš„å„ç§èµ„æºï¼Œå¹¶æ²¡æœ‰å¯¹å¤–æä¾›æœåŠ¡çš„éœ€æ±‚ï¼Œç°åœ¨å›½å†…è¿è¥å•†åœ¨å¤§éƒ¨åˆ†åŸå¸‚é»˜è®¤å·²ç»ä¸ä¼šç»™å®¶åº­å®½å¸¦ç”¨æˆ·åŠ¨æ€åˆ†é…å…¬ç½‘åœ°å€ï¼Œè€Œæ˜¯æ¢æˆäº†ä¸€å±‚æˆ–å¤šå±‚ NAT åçš„å†…ç½‘åœ°å€ã€‚å¹¶ä¸”ä¸€èˆ¬ç”¨æˆ·å‘é€æ•°æ®çš„éœ€æ±‚è¿œå°äºè·å–æ•°æ®çš„éœ€æ±‚ï¼Œæ‰€ä»¥å®¶åº­å®½å¸¦çš„ä¸Šä¸‹è¡Œå¸¦å®½ä¸€èˆ¬æ˜¯ä¸å¯¹ç­‰çš„ï¼Œä¾‹å¦‚æŸåœ°ç”µä¿¡å®½å¸¦ 500M ä¸‹è¡Œå¸¦å®½å¯¹åº”çš„ä¸Šè¡Œå¸¦å®½åªæœ‰ 30Mã€‚</p><p>æ­¤æ—¶ï¼Œå¯¹äº==ä¸€äº›æœ‰è¿œç¨‹è¿æ¥ã€è·å– NAS æ–‡ä»¶==ï¼Œæˆ–è€…ä¸´æ—¶è°ƒè¯•æœåŠ¡éœ€æ±‚çš„ç”¨æˆ·å°±ä¸å¤ªå‹å¥½äº†ã€‚</p><p>æœ‰çš„ç”µä¿¡ç½‘ç»œæ˜¯å¯ä»¥æ‰“å®¢æœç”³è¯·å…¬ç½‘IPçš„ï¼Œä½†æ˜¯å®¶åº­å®½å¸¦å®ƒé™åˆ¶äº†å¤§éƒ¨åˆ†å¸¸ç”¨çš„ç«¯å£ã€‚</p><p>å†…ç½‘ç©¿é€å·¥å…·å°±æ˜¯ä¸ºäº†è§£å†³ä¸Šè¿°çš„æ²¡æœ‰å…¬ç½‘ IP çš„é—®é¢˜çš„ã€‚</p><p>é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯è®©ä½ åœ¨å…¬ç½‘ç¯å¢ƒä¸‹èƒ½è®¿é—®åˆ°ä½ çš„æœ¬åœ°ç½‘ç»œ(æœ¬åœ°éœ€è”ç½‘)ã€‚</p><h1 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h1><p>å®¶é‡Œéƒ¨ç½²äº†ä¸€ä¸ªåšå®¢åœ°å€ï¼Œæƒ³ä»å¤–é¢çš„ç½‘ç»œç›´æ¥è®¿é—®åˆ°åšå®¢ï¼Œä½†æ˜¯ç”±äºæ²¡æœ‰å…¬ç½‘IPï¼Œæ‰€ä»¥å¾—å¦å¯»ä»–è·¯-å†…ç½‘ç©¿é€ã€‚è™½è¯´æ˜¯å†…ç½‘ï¼Œä½†æ˜¯ä½ å®¶çš„ç½‘ç»œä¹Ÿå¿…é¡»è”ç½‘çš„ã€‚</p><h1 id="frpç®€ä»‹"><a href="#frpç®€ä»‹" class="headerlink" title="frpç®€ä»‹"></a>frpç®€ä»‹</h1><p>frp æ˜¯ä¸€ä¸ªå¯ç”¨äºå†…ç½‘ç©¿é€çš„é«˜æ€§èƒ½çš„åå‘ä»£ç†åº”ç”¨ï¼Œæ”¯æŒ tcp, udp, http, https åè®®</p><p>åç§°å…¶å®å°±æ˜¯ä½¿ç”¨äº† Fast Reverse Proxy çš„é¦–å­—æ¯ç¼©å†™ã€‚</p><p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å¯ä»¥éšæ—¶éšåœ°é€šè¿‡<strong>æœ‰å…¬ç½‘ IP çš„æœåŠ¡å™¨</strong>ä¸­è½¬è¿æ¥åˆ°<strong>è¿è¡Œ frpc ç¨‹åºçš„ä»»æ„æœºå™¨çš„ä»»æ„ç«¯å£</strong>ã€‚</p><p><a href="https://gofrp.org/docs/">frpå®˜ç½‘ä¸­æ–‡æ–‡æ¡£åœ°å€</a></p><h2 id="å‰ç½®æ¡ä»¶ğŸ”º"><a href="#å‰ç½®æ¡ä»¶ğŸ”º" class="headerlink" title="å‰ç½®æ¡ä»¶ğŸ”º"></a>å‰ç½®æ¡ä»¶ğŸ”º</h2><ul><li>å…·æœ‰å…¬ç½‘IPçš„äº‘æœåŠ¡å™¨</li><li>å®¶åº­ç½‘ç»œï¼Œèƒ½è”ç½‘</li><li><a href="https://github.com/fatedier/frp/releases">é¡¹ç›®frp</a></li><li>ä¸€ä¸ªè§£æåˆ°äº‘æœåŠ¡å™¨çš„åŸŸå(==è®¿é—®webæœåŠ¡éœ€è¦==ï¼Œå…¶ä½™ä¸éœ€è¦)</li></ul><h2 id="frpå®‰è£…"><a href="#frpå®‰è£…" class="headerlink" title="frpå®‰è£…"></a>frpå®‰è£…</h2><p><a href="https://gofrp.org/docs/setup/">https://gofrp.org/docs/setup/</a></p><h3 id="å®ç°åŠŸèƒ½"><a href="#å®ç°åŠŸèƒ½" class="headerlink" title="å®ç°åŠŸèƒ½"></a>å®ç°åŠŸèƒ½</h3><h5 id="é€šè¿‡-SSH-è®¿é—®å†…ç½‘æœºå™¨"><a href="#é€šè¿‡-SSH-è®¿é—®å†…ç½‘æœºå™¨" class="headerlink" title="é€šè¿‡ SSH è®¿é—®å†…ç½‘æœºå™¨"></a><a href="https://gofrp.org/docs/examples/ssh/">é€šè¿‡ SSH è®¿é—®å†…ç½‘æœºå™¨</a></h5><h5 id="é€šè¿‡è‡ªå®šä¹‰åŸŸåè®¿é—®å†…ç½‘çš„-Web-æœåŠ¡"><a href="#é€šè¿‡è‡ªå®šä¹‰åŸŸåè®¿é—®å†…ç½‘çš„-Web-æœåŠ¡" class="headerlink" title="é€šè¿‡è‡ªå®šä¹‰åŸŸåè®¿é—®å†…ç½‘çš„ Web æœåŠ¡"></a><a href="https://gofrp.org/docs/examples/vhost-http/">é€šè¿‡è‡ªå®šä¹‰åŸŸåè®¿é—®å†…ç½‘çš„ Web æœåŠ¡</a></h5><h1 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h1><p>å…¶ä»–çš„å†…ç½‘ç©¿é€è¿˜æœ‰ä¸€å†™ï¼š</p><ul><li><a href="https://github.com/ehang-io/nps">nps</a>ï¼šGithubå¼€æº</li><li><a href="http://www.ngrok.cc/">Ngfork</a>ï¼šä»˜è´¹ï¼Œæœ‰å…è´¹ç‰ˆæœ¬</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;é¦–å…ˆè¯´ä¸‹åŸå§‹éœ€æ±‚ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼ŒIPv4 ç½‘ç»œåœ°å€æ•°é‡éå¸¸æœ‰é™ï¼Œå¤§çº¦åªæœ‰ 43 äº¿ä¸ªåœ°å€ï¼Œå…¨çƒäº’è”ç½‘å‘å±•åˆ°å¦‚ä»Šçš„ç¨‹åº¦ï¼Œæ˜¾ç„¶ä¸å¯èƒ½æ¯å°è®¾å¤‡éƒ½åˆ†é…åˆ°</summary>
      
    
    
    
    <category term="ç½‘ç»œ" scheme="https://awslzhang.top/categories/%E7%BD%91%E7%BB%9C/"/>
    
    
    <category term="frp" scheme="https://awslzhang.top/tags/frp/"/>
    
  </entry>
  
  <entry>
    <title>ç‹‚ç¥è¯´ElasticSearch 7.xç¬”è®°ï¼ˆçº¯æ‰‹æ•²ï¼‰</title>
    <link href="https://awslzhang.top/2020/10/18/%E7%8B%82%E7%A5%9E%E8%AF%B4ElasticSearch-7-x%E7%AC%94%E8%AE%B0%EF%BC%88%E7%BA%AF%E6%89%8B%E6%95%B2%EF%BC%89/"/>
    <id>https://awslzhang.top/2020/10/18/%E7%8B%82%E7%A5%9E%E8%AF%B4ElasticSearch-7-x%E7%AC%94%E8%AE%B0%EF%BC%88%E7%BA%AF%E6%89%8B%E6%95%B2%EF%BC%89/</id>
    <published>2020-10-18T08:14:03.000Z</published>
    <updated>2021-01-01T05:50:00.104Z</updated>
    
    <content type="html"><![CDATA[<p><img src="" alt="ä¸‹è½½"></p><h1 id="å£°æ˜"><a href="#å£°æ˜" class="headerlink" title="å£°æ˜"></a>å£°æ˜</h1><p>æ­¤æ–‡ç« æ˜¯upä¸»-<strong>é‡è§ç‹‚ç¥è¯´</strong>çš„èµ„æ–™ï¼Œå°†ä»–çš„èµ„æ–™æ‹‰å–åœ¨è¿™æ˜¯ä¸ºäº†æ›´å¥½çš„æŸ¥æ‰¾èµ„æ–™ã€‚</p><p>è¿™æ˜¯å¤§ç¥çš„è®²è§£è§†é¢‘ï¼š<a href="https://www.bilibili.com/video/BV17a4y1x7zq?p=1">https://www.bilibili.com/video/BV17a4y1x7zq?p=1</a></p><h1 id="ç‹‚ç¥èŠElasticSearch-åˆçº§é˜¶æ®µ"><a href="#ç‹‚ç¥èŠElasticSearch-åˆçº§é˜¶æ®µ" class="headerlink" title="ç‹‚ç¥èŠElasticSearch(åˆçº§é˜¶æ®µ)"></a>ç‹‚ç¥èŠElasticSearch(åˆçº§é˜¶æ®µ)</h1><p>E L K</p><p>ç‰ˆæœ¬:Elasticsearch7.6.1 (å…¨ç½‘æœ€æ–°çš„)</p><p>6.X å’Œ 7.X åŒºåˆ«ååˆ†å¤§(åŸç”ŸAPI,RestFulé«˜çº§)</p><blockquote><p>æˆ‘ä»¬è¦è®²è§£ä»€ä¹ˆ?</p></blockquote><p>SQL: likeæŸ¥è¯¢%ç‹‚ç¥è¯´%,å¦‚æœæ˜¯å¤§æ•°æ®,å°±ååˆ†æ…¢!ç´¢å¼•!</p><p>Elasticsearch:æœç´¢(ç™¾åº¦,github,æ·˜å®ç”µå•†!)</p><ol><li>èŠä¸€ä¸ªäºº</li><li>è´§æ¯”ä¸‰å®¶</li><li>å®‰è£…</li><li>ç”Ÿæ€åœˆ</li><li>åˆ†è¯å™¨ ik</li><li>RestFulæ“ä½œ ES</li><li>CRUD</li><li>SpringBoot é›†æˆ ElasticSearch(ä»åŸç†åˆ†æ!)</li><li>çˆ¬è™«çˆ¬å–æ•°æ®(äº¬ä¸œ)</li><li>å®æˆ˜,æ¨¡æ‹Ÿå…¨æ–‡æ£€ç´¢!</li></ol><blockquote><p>ä»¥åä½ åªè¦éœ€è¦ç”¨åˆ°æœç´¢,å°±å¯ä»¥ç”¨ES!(å¤§æ•°æ®é‡çš„æƒ…å†µä¸‹ä½¿ç”¨!)</p></blockquote><p>å­¦äº†è¿™ä¸ªå°±ä¸éœ€è¦ç”¨MySQLæ¥æŸ¥äº†</p><h1 id="èŠèŠDougCutting"><a href="#èŠèŠDougCutting" class="headerlink" title="èŠèŠDougCutting"></a>èŠèŠDougCutting</h1><p>ä¸ºä»€ä¹ˆè¦è®²è¿™ä¸ªäºº,åé¢è¦èŠå¤§æ•°æ®</p><blockquote><p>æœ¬æ•…äº‹å†…å®¹æ¥è‡ªå…¬ä¼—å·ï¼šæ–°æ£è¯¾å ‚</p></blockquote><p>1998å¹´9æœˆ4å·,googleå…¬å¸åœ¨ç¾å›½ç¡…è°·æˆç«‹.æ­£å¦‚å¤§å®¶æ‰€çŸ¥,å®ƒæ˜¯ä¸€å®¶<strong>æœç´¢</strong>å¼•æ“èµ·å®¶çš„å…¬å¸</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596610550313.png" alt="1596610550313"></p><p>æ— ç‹¬æœ‰å¶,ä¸€ä½åå«DougCuttingçš„ç¾å›½å·¥ç¨‹å¸ˆ,ä¹Ÿè¿·ä¸Šäº†æœç´¢å¼•æ“.ä»–åšäº†ä¸€ä¸ªç”¨äºæ–‡æœ¬æœç´¢çš„å‡½æ•°åº“(å§‘ä¸”ç†è§£ä¸ºè½¯ä»¶çš„åŠŸèƒ½ç»„ä»¶),å‘½åä¸ºLucene.</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596610568104.png" alt="1596610568104"></p><p>Luceneä½¿ç”¨Javaå†™çš„,ç›®æ ‡æ˜¯ä¸ºå„ç§ä¸­å°å‹åº”ç”¨è½¯ä»¶åŠ å…¥å…¨æ–‡æ£€ç´¢åŠŸèƒ½.å› ä¸ºå¥½ç”¨è€Œä¸”å¼€æº(ä»£ç å…¬å¼€),éå¸¸å—ç¨‹åºå‘˜ä»¬ç¨€ç½•)</p><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­,googleç¡®å®æ‰¾åˆ°äº†ä¸å°‘å¥½çš„åŠæ³•,å¹¶ä¸”æ— ç§åœ°åˆ†äº«äº†å‡ºæ¥.</p><p>å¼€æºæ˜¯ä¸€ç§ç²¾ç¥!</p><p>2003å¹´,googleå‘è¡¨äº†ä¸€ç¯‡æŠ€æœ¯å­¦æœ¯è®ºæ–‡,å…¬å¼€ä»‹ç»äº†è‡ªå·±çš„è°·æ­Œæ–‡ä»¶ç³»ç»ŸGFS(google File System).è¿™æ˜¯googleå…¬å¸ä¸ºäº†å­˜å‚¨æµ·é‡æœç´ æ•°æ®è€Œè®¾è®¡çš„ä¸“ç”¨æ–‡ä»¶ç³»ç»Ÿ</p><p>ç¬¬äºŒå¹´,2004å¹´,Doug CuttingåŸºäºgoogleçš„GFSè®ºæ–‡,å®ç°äº†åˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨ç³»ç»Ÿ,å¹¶å°†å®ƒå‘½åä¸ºNDFS(Nutch Distributed File System)</p><p>è¿˜æ˜¯2004å¹´,googleåˆå‘è¡¨äº†ä¸€ç¯‡æŠ€æœ¯å­¦æœ¯è®ºæ–‡,ä»‹ç»è‡ªå·±çš„MapReduceç¼–ç¨‹æ¨¡å‹.è¿™ä¸ªç¼–ç¨‹æ¨¡å‹,ç”¨äºå¤§è§„æ¨¡æ•°æ®é›†(å¤§äº1TB)çš„å¹¶è¡Œåˆ†æè¿ç®—.</p><p>2005å¹´,Doug Cutting åˆåŸºäºMapReduce,åœ¨Nutchæœç´¢å¼•æ“å®ç°äº†è¯¥åŠŸèƒ½.</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596610581999.png" alt="1596610581999"></p><p>2006å¹´,å½“æ—¶ä¾ç„¶å¾ˆå‰å®³çš„Yahoo(é›…è™)å…¬å¸,æ‹›å®‰äº†Doug Cutting</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596610607769.png" alt="1596610607769"></p><p>æˆªå›¾</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596610720399.png" alt="1596610720399"></p><p>æˆ‘ä»¬ç»§ç»­å¾€ä¸‹è¯´.</p><p>è¿˜æ˜¯2006å¹´,googleæœ‰å‘è¡¨è®ºæ–‡äº†</p><p>è¿™æ¬¡,ä»–ä»¬ä»‹ç»è‡ªå·±çš„BigTable,è¿™æ˜¯ä¸€ç§åˆ†å¸ƒå¼çš„æ•°æ®å­˜å‚¨ç³»ç»Ÿ,ä¸€ç§ç”¨æ¥å¤„ç†æµ·é‡æ•°æ®çš„éå…³ç³»å‹æ•°æ®åº“.</p><p>Doug Cutting å½“ç„¶æ²¡æœ‰æ”¾è¿‡,åœ¨è‡ªå·±çš„hadoopç³»ç»Ÿé‡Œé¢,å¼•å…¥äº†BigTable,å¹¶å‘½åä¸ºHBase.</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596610829469.png" alt="1596610829469"></p><p>å¥½å§,åæ­£å°±æ˜¯ç´§è·ŸGoogleæ—¶ä»£æ­¥ä¼,ä½ å‡ºä»€ä¹ˆ,æˆ‘å­¦ä»€ä¹ˆ</p><p>æ‰€æœ‰,Hadoopçš„æ ¸å¿ƒéƒ¨åˆ†,åŸºæœ¬ä¸Šéƒ½æœ‰Googleçš„å½±å­.</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596610891867.png" alt="1596610891867"></p><p>2008å¹´1æœˆ,HadoopæˆåŠŸä¸Šä½,æˆä¸ºApacheåŸºé‡‘ä¼šçš„é¡¶çº§é¡¹ç›®.</p><p>åŒå¹´2æœˆ,Yahooå®£å¸ƒå»ºæˆäº†ä¸€ä¸ªæ‹¥æœ‰1Wä¸ªå†…æ ¸çš„Hadoopé›†ç¾¤,å¹¶å°†è‡ªå·±çš„æœç´¢å¼•æ“äº§å“éƒ¨ç½²åœ¨ä¸Šé¢.</p><p>7æœˆ,Hadoopæ‰“ç ´ä¸–ç•Œçºªå½•,æˆä¸ºæœ€å¿«æ’åº1TBæ•°æ®çš„ç³»ç»Ÿ,ç”¨æ—¶209ç§’.</p><h1 id="Elasticsearchæ¦‚è¿°"><a href="#Elasticsearchæ¦‚è¿°" class="headerlink" title="Elasticsearchæ¦‚è¿°"></a>Elasticsearchæ¦‚è¿°</h1><p>elasticsearch,ç®€ç§°ä¸ºes,esæ˜¯ä¸€ä¸ªå¼€æºçš„æ‰©å±•çš„åˆ†å¸ƒå¼å…¨æ–‡æ£€ç´¢å¼•æ“,ä»–å¯ä»¥è¿‘ä¹å®æ—¶çš„å­˜å‚¨,æ£€ç´¢æ•°æ®;æœ¬èº«æ‰©å±•æ€§å¾ˆå¥½,å¯ä»¥æ‰©å±•åˆ°ä¸Šç™¾å°æœåŠ¡å™¨,å¤„ç†PBçº§åˆ«(å¤§æ•°æ®æ—¶ä»£)çš„æ•°æ®.esä¹Ÿä½¿ç”¨Javaå¹¶å‘ä½¿ç”¨Luceneä½œä¸ºå…¶æ ¸å¿ƒæ¥å®ç°æ‰€æœ‰ç´¢å¼•å’Œæœç´¢çš„åŠŸèƒ½,ä½†æ˜¯å®ƒçš„ç›®çš„æ˜¯é€šè¿‡ç®€å•çš„RESTful API æ¥éšè—Luceneçš„å¤æ‚æ€§,ä»è€Œè®©å…¨æ–‡æœç´¢å˜å¾—ç®€å•.</p><p>æ®å›½é™…æƒå¨çš„æ•°æ®åº“äº§å“è¯„æµ‹æœºæ„DB Enginesçš„ç»Ÿè®¡,åœ¨2016å¹´1æœˆ,ElasticSearchå·²è¶…è¿‡Solrç­‰,æˆä¸ºæ’åç¬¬ä¸€çš„æœç´¢å¼•æ“ç±»åº”ç”¨</p><blockquote><p>å†å²</p></blockquote><p>å¤šå¹´å‰,ä¸€ä¸ªå«åšshay banonçš„åˆšç»“å©šä¸ä¹…çš„å¤±ä¸šå¼€å‘è€…,ç”±äºå¦»å­è¦å»ä¼¦æ•¦å­¦ä¹ å¨å¸ˆ,ä»–ä¾¿è·Ÿç€å»äº†.åœ¨ä»–æ‰¾å·¥ä½œçš„è¿‡ç¨‹ä¸­,ä¸ºäº†ç»™å¦»å­æ„å»ºä¸€ä¸ªé£Ÿè°±çš„æœç´¢å¼•æ“,ä»–å¼€å§‹æ„å»ºä¸€ä¸ªæ—©æœŸç‰ˆæœ¬çš„Lucene</p><p>ç›´æ¥ åŸºäºLuceneå·¥ä½œä¼šæ¯”è¾ƒå›°éš¾,æ‰€ä»¥Shayå¼€å§‹æŠ½è±¡Luceneä»£ç ä»¥ä¾¿Javaç¨‹åºå‘˜å¯ä»¥åœ¨åº”ç”¨ä¸­æ·»åŠ æœç´¢åŠŸèƒ½.ä»–å‘å¸ƒäº†ä»–çš„ç¬¬ä¸€ä¸ªå¼€æºé¡¹ç›®,å«åšâ€compassâ€ åæ¥Shayæ‰¾åˆ°ä¸€ä»½å·¥ä½œ,è¿™ä¸ªå·¥ä½œå¤„åœ¨é«˜æ€§èƒ½å’Œå†…å­˜æ•°æ®ç½‘ç»œçš„åˆ†å¸ƒå¼ç¯å¢ƒä¸­,å› æ­¤é«˜æ€§èƒ½çš„,å®æ—¶çš„,åˆ†å¸ƒå¼çš„æœç´¢å¼•æ“ä¹Ÿæ˜¯ç†æ‰€å½“ç„¶éœ€è¦çš„.ç„¶åä»–å†³å®šé‡å†™Compassåº“,ä½¿å…¶æˆä¸ºä¸€ä¸ªç‹¬ç«‹çš„æœåŠ¡å«åšElasticsearch.ç¬¬ä¸€ä¸ªå…¬å¼€ç‰ˆæœ¬å‡ºç°åœ¨2010å¹´2æœˆ,åœ¨é‚£ä¹‹åElasticsearchå·²ç»æˆä¸ºGithubä¸Šæœ€å—æ¬¢è¿çš„é¡¹ç›®ä¹‹ä¸€,ä»£ç è´¡çŒ®è€…è¶…è¿‡300äºº.ä¸€å®¶ä¸»è¥Elasticsearchçš„å…¬å¸å°±æ­¤æˆç«‹,ä»–ä»¬ä¸€è¾¹æä¾›å•†ä¸šæ”¯æŒ,ä¸€è¾¹å¼€å‘æ–°åŠŸèƒ½,ä¸è¿‡Elasticsearchå°†æ°¸è¿œå¼€æºä¸”å¯¹æ‰€æœ‰äººå¯ç”¨ Shayçš„å¦»å­ä¾ç„¶ç­‰å¾…ç€ä»–çš„é£Ÿè°±æœç´¢â€¦â€¦.</p><p><img src="http://victorfengming.gitee.io/course/elasticsearch/base/03-elasticsearch-%E6%A6%82%E8%BF%B0.assets/1597974189393.png" alt="1597974189393"></p><p>è°åœ¨ä½¿ç”¨</p><ol><li>ç»´åŸºç™¾ç§‘(ç™¾åº¦ç™¾ç§‘,å…¨æ–‡é«˜äº®,æ’åºæœç´ æ¨è,æƒé‡,ç™¾åº¦!)</li><li>The Guardian</li><li>Stack Overflow(å›½å¤–çš„ç¨‹åºå¼‚å¸¸å¤„ç†ç½‘ç«™)IT é—®é¢˜,ç¨‹åºçš„æŠ¥é”™,æäº¤ä¸Šå»,æœ‰äººä¼šè·Ÿä½ è®¨è®ºå’Œå›ç­”</li><li>Github</li><li>ç”µå•†ç½‘ç«™ æ·˜å®äº¬ä¸œ</li><li>æ—¥å¿—æ•°æ®åˆ†æ,logstashé‡‡é›†æ—¥å¿—,ESè¿›è¡Œå¤æ‚çš„æ•°æ®åˆ†æ,ELKæŠ€æœ¯,elasticsearch+logstach+kibana</li><li>å•†å“ä»·æ ¼ç›‘æ§ç½‘ç«™,ç”¨æˆ·è®¾å®š</li></ol><h1 id="Elasticsearchå’ŒSolrå·®åˆ«"><a href="#Elasticsearchå’ŒSolrå·®åˆ«" class="headerlink" title="Elasticsearchå’ŒSolrå·®åˆ«"></a>Elasticsearchå’ŒSolrå·®åˆ«</h1><p>Elasticsearchæ˜¯ä¸€ä¸ªå®æ—¶åˆ†å¸ƒå¼æœç´¢å’Œåˆ†æå¼•æ“.å®ƒè®©ä½ ä»¥å‰æ‰€æœªæœ‰çš„é€Ÿåº¦å¤„ç†å¤§æ•°æ®æˆä¸ºå¯èƒ½. ç»´åŸºç™¾ç§‘ä½¿ç”¨å®ƒæä¾›å…¨æ–‡æœç´¢å¹¶é«˜äº®å…³é”®å­—,ä»¥åŠè¾“å…¥å®æ—¶æœç´¢</p><p>Solrç®€ä»‹ Solræ˜¯Apacheä¸‹çš„ä¸€ä¸ªé¡¶çº§å¼€æºé¡¹ç›®,é‡‡ç”¨Javaå¼€å‘,å®ƒæ˜¯åŸºäºLuceneçš„å…¨æ–‡æœç´¢æœåŠ¡å™¨.solræä¾›äº†æ¯”Luceneæ›´ä¸ºä¸°å¯Œçš„æŸ¥è¯¢è¯­è¨€,åŒæ—¶å®ç°äº†å¯é…ç½®,å¯æ‰©å±•,å¹¶å¯¹ç´¢å¼•,æœç´¢æ€§èƒ½è¿›è¡Œä¼˜åŒ– ä»–å¯ä»¥ç‹¬ç«‹è¿è¡Œ,è¿è¡Œåœ¨tomcat ,jetyç­‰è¿™äº›Servletå®¹å™¨ä¸­ solrå¯¹å¤–æä¾›ç±»ä¼¼äºWeb-serverçš„APIæ¥å£</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596613190316.png" alt="1596613190316"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596613206055.png" alt="1596613206055"></p><p>éšç€æ•°æ®é‡çš„å¢åŠ ,solrçš„æœç´¢</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596613233807.png" alt="1596613233807"></p><p>50å€çš„æ•ˆç‡</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596613255957.png" alt="1596613255957"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597974203192.png" alt="1597974203192"></p><h2 id="ElasticSearch-vs-Solr-æ€»ç»“"><a href="#ElasticSearch-vs-Solr-æ€»ç»“" class="headerlink" title="ElasticSearch vs Solr æ€»ç»“"></a>ElasticSearch vs Solr æ€»ç»“</h2><ol><li>esåŸºæœ¬æ˜¯==å¼€ç®±å³ç”¨==(è§£å‹å°±å¯ä»¥ç”¨äº†!),éå¸¸ç®€å•.solrå®‰è£…ç•¥å¾®å¤æ‚ä¸€ä¸¢ä¸¢!</li><li>Solråˆ©ç”¨Zookeeperè¿›è¡Œåˆ†å¸ƒå¼ç®¡ç†,è€Œ==Elasticsearchè‡ªèº«å¸¦æœ‰åˆ†å¸ƒå¼åè°ƒç®¡ç†åŠŸèƒ½==.</li><li>solræ”¯æŒæ›´å¤šæ ¼å¼çš„æ•°æ®,æ¯”å¦‚JSON,XML,CSV, è€Œelasticsearchä»…ä»…æ”¯æŒjsonæ–‡ä»¶æ ¼å¼</li><li>Solrå®˜ç½‘æä¾›çš„åŠŸèƒ½å¾ˆå¤š,è€Œelasticsearchæœ¬èº«æ›´æ³¨é‡æ ¸å¿ƒåŠŸèƒ½,é«˜çº§åŠŸèƒ½å¤šæœ‰ç¬¬ä¸‰æ–¹æ’ä»¶æä¾›,ä¾‹å¦‚å›¾å½¢åŒ–ç•Œé¢éœ€è¦kibanaå‹å¥½è´¨å±‚æ”¯æ’‘</li><li>SolræŸ¥è¯¢å—,ä½†æ›´æ–°ç´¢å¼•æ—¶æ…¢(å³æ’å…¥åˆ é™¤æ…¢),ç”¨äºç”µå•†ç­‰æŸ¥è¯¢å¤šçš„åº”ç”¨;<ul><li>ESå»ºç«‹ç´¢å¼•å—(å³æŸ¥è¯¢æ…¢),å³==å®æ—¶æ€§æŸ¥è¯¢å¿«==,ç”¨äºfacebookæ–°æµªç­‰æœç´¢.</li><li>Solræ˜¯ä¼ ç»Ÿæœç´¢åº”ç”¨çš„æœ‰åŠ›è§£å†³æ–¹æ¡ˆ,ä½†Elasticsearchæ›´é€‚ç”¨äºæ–°å…´çš„å®æ—¶æœç´¢åº”ç”¨.</li></ul></li><li>Solræ¯”è¾ƒæˆç†Ÿ,æœ‰ä¸€ä¸ªæ›´å¤§,æ›´æˆç†Ÿçš„ç”¨æˆ·,å¼€å‘å¥½è´¡çŒ®è€…ç¤¾åŒº,è€ŒElasticsearchç›¸å¯¹å¼€å‘ç»´æŠ¤è€…è¾ƒå°‘,æ›´æ–°å¤ªå¿«,==å­¦ä¹ ä½¿ç”¨æˆæœ¬è¾ƒé«˜==.</li></ol><h1 id="Elasticsearchå®‰è£…"><a href="#Elasticsearchå®‰è£…" class="headerlink" title="Elasticsearchå®‰è£…"></a>Elasticsearchå®‰è£…</h1><blockquote><p>å£°æ˜:JDK1.8, æœ€ä½è¦æ±‚ , Elasticsearchå®¢æˆ·ç«¯,ç•Œé¢å·¥å…·!</p></blockquote><p><strong>Javaå¼€å‘,elasticsearchçš„ç‰ˆæœ¬å’Œæˆ‘ä»¬ä¹‹åå¯¹åº”çš„Javaçš„æ ¸å¿ƒjaråŒ…! ç‰ˆæœ¬å¯¹åº”! JDKç¯å¢ƒæ˜¯æ­£å¸¸çš„</strong></p><p><strong>è¿™é‡Œä¸€å®šè¦ä¿è¯</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596614089583.png" alt="1596614089583"></p><p>ä¸‹è½½</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596614104028.png" alt="1596614104028"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596614119890.png" alt="1596614119890"></p><p>ä¸€å®šè¦åœ¨æœåŠ¡å™¨ä¸Šé¢æ­å»º</p><p>ä¸‹è½½åœ°å€:<a href="https://www.elastic.co/cn/downloads/elasticsearch">https://www.elastic.co/cn/downloads/elasticsearch</a></p><p>å®˜ç½‘ä¸‹è½½å·¨æ…¢,ç¿»å¢™,ç½‘ç›˜ä¸­ä¸‹è½½å³å¯</p><p>åä¸ºäº‘: <a href="https://mirrors.huaweicloud.com/elasticsearch/7.6.2/">https://mirrors.huaweicloud.com/elasticsearch/7.6.2/</a></p><p>æˆ‘ä»¬å­¦ä¹ çš„è¯Windowå’ŒLinuxéƒ½å¯ä»¥å­¦ä¹  ==æˆ‘ä»¬è¿™é‡Œç°åœ¨windowä¸‹å­¦ä¹ ==</p><p>ELKä¸‰å‰‘å®¢,è§£å‹å³ç”¨!(webé¡¹ç›®! å‰ç«¯ç¯å¢ƒ! npm ä¸‹è½½ä¾èµ–)</p><p>Node.js python2</p><blockquote><p>windowä¸‹å®‰è£…!</p></blockquote><ol><li>elasticSearch</li><li>elasticSearch Headï¼šä¸€ä¸ªå‰ç«¯é¡¹ç›®</li><li>kibana</li></ol><p>è¿‡ç¨‹ï¼šç•¥</p><h1 id="ESæ ¸å¿ƒæ¦‚å¿µç†è§£"><a href="#ESæ ¸å¿ƒæ¦‚å¿µç†è§£" class="headerlink" title="ESæ ¸å¿ƒæ¦‚å¿µç†è§£"></a>ESæ ¸å¿ƒæ¦‚å¿µç†è§£</h1><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>åœ¨å‰é¢çš„å­¦ä¹ ä¸­,æˆ‘ä»¬æŒæ¡äº†esæ˜¯ä»€ä¹ˆ,åŒæ—¶ä¹ŸæŠŠesçš„æœåŠ¡å·²ç»å®‰è£…å¯åŠ¨,é‚£ä¹ˆesæ˜¯å¦‚ä½•å»å­˜å‚¨æ•°æ®,æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆ,åˆæ˜¯å¦‚ä½•å®ç°æœç´¢çš„å‘¢?æˆ‘ä»¬å…ˆæ¥èŠèŠElasticsearchçš„ç›¸å…³æ¦‚å¿µå§!</p><p><strong>é›†ç¾¤,èŠ‚ç‚¹,ç´¢å¼•,ç±»å‹,æ–‡æ¡£,åˆ†ç‰‡,æ˜ å°„</strong>æ˜¯ä»€ä¹ˆ</p><blockquote><p>elasticsearchæ˜¯é¢å‘æ–‡æ¡£çš„,å…³ç³»è¡Œæ•°æ®åº“å’Œelasticsearchå®¢è§‚çš„å¯¹æ¯”! ä¸€åˆ‡éƒ½æ˜¯json</p></blockquote><table><thead><tr><th>RelationalDB</th><th>Elasticsearch</th></tr></thead><tbody><tr><td>æ•°æ®åº“(database)</td><td>ç´¢å¼•(indices)</td></tr><tr><td>è¡¨(tables)</td><td>types(7ç‰ˆæœ¬ä»¥åŠä¹‹åä¼šè¢«æŠ›å¼ƒï¼Œé»˜è®¤_doc)</td></tr><tr><td>è¡Œ(rows)</td><td>documents</td></tr><tr><td>å­—æ®µ(columns)</td><td>fields</td></tr></tbody></table><p>é¢å‘æ–‡æ¡£ é¢å‘æ–‡æ¡£ é¢å‘æ–‡æ¡£ <del>~</del></p><p>elasticsearch(é›†ç¾¤)ä¸­å¯ä»¥åŒ…å«å¤šä¸ªç´¢å¼•(æ•°æ®åº“),æ¯ä¸ªç´¢å¼•ä¸­å¯ä»¥åŒ…å«å¤šä¸ªç±»å‹(è¡¨),æ¯ä¸ªç±»å‹å…ˆåˆåŒ…å«å¤šä¸ªæ–‡æ¡£(è¡Œ),æ¯ä¸ªæ–‡æ¡£ä¸­åˆåŒ…å«å¤šä¸ªå­—æ®µ(åˆ—).</p><h2 id="ç‰©ç†è®¾è®¡"><a href="#ç‰©ç†è®¾è®¡" class="headerlink" title="ç‰©ç†è®¾è®¡"></a>ç‰©ç†è®¾è®¡</h2><p>elasticsearchåœ¨åå°å§æ¯ä¸ª<strong>ç´¢å¼•åˆ’åˆ†æˆå¤šä¸ªåˆ†ç‰‡</strong>,æ¯ä¸ªåˆ†ç‰‡å¯ä»¥åœ¨é›†ç¾¤ä¸­çš„ä¸åŒæœåŠ¡å™¨é—´è¿ç§»</p><p><img src="http://victorfengming.gitee.io/course/elasticsearch/base/07-elasticsearch-es%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E7%90%86%E8%A7%A3.assets/1596629957996.png" alt="1596629957996"></p><h2 id="é€»è¾‘è®¾è®¡"><a href="#é€»è¾‘è®¾è®¡" class="headerlink" title="é€»è¾‘è®¾è®¡"></a>é€»è¾‘è®¾è®¡</h2><p>ä¸€ä¸ªç´¢å¼•ç±»å‹ä¸­,åŒ…å«å¤šä¸ªæ–‡æ¡£,æ¯”å¦‚æ‰€æ–‡æ¡£1,æ–‡æ¡£2.å½“æˆ‘ä»¬ç´¢å¼•ä¸€ç¯‡æ–‡ç« æ—¶,å¯ä»¥é€šè¿‡è¿™æ ·çš„ä¸€å„é¡ºåºæ‰¾åˆ°å®ƒ:ç´¢å¼•&gt;ç±»å‹</p><p><code>&gt;</code>æ–‡æ¡£id,é€šè¿‡è¿™ä¸ªç»„åˆæˆ‘ä»¬å°±èƒ½ç´¢å¼•åˆ°æŸä¸ªå…·ä½“çš„æ–‡æ¡£. æ³¨æ„: idä¸å¿…æ˜¯æ•´æ•°,å®é™…ä¸Šä»–æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸².</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æ–‡æ¡£</span><br></pre></td></tr></table></figure><table><thead><tr><th>user</th><th>name</th><th>age</th></tr></thead><tbody><tr><td>1</td><td>zhasna</td><td>18</td></tr><tr><td>2</td><td>kaugshen</td><td>23</td></tr><tr><td>3</td><td></td><td></td></tr></tbody></table><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597974203192.png" alt="1597974203192"></p><p>ä¹‹å‰è¯´elasticsearchæ˜¯é¢å‘æ–‡æ¡£çš„,nameå°±ä¹Ÿä¸ºè¿™ç´¢å¼•å’Œæœç´¢æ•°æ®çš„æœ€å°å•ä½æ˜¯æ–‡æ¡£,elasticsearchä¸­,æ–‡æ¡£æœ‰å‡ ä¸ªé‡è¦å±æ€§:</p><ul><li><p>è‡ªæˆ‘åŒ…å«,ä¸€ç¯‡æ–‡æ¡£åŒæ—¶åŒ…å«å­—æ®µå’Œå¯¹åº”å€¼,ä¹Ÿå°±æ˜¯åŒæ—¶åŒ…å«key:value!</p></li><li><p>å¯ä»¥æ˜¯å±‚æ¬¡å‹çš„,ä¸€ä¸ªæ–‡æ¡£ä¸­åŒ…å«æ–‡æ¡£,å¤æ‚çš„é€»è¾‘å®ä½“å°±æ˜¯è¿™ä¹ˆæ¥çš„!</p></li><li><p>çµæ´»çš„ç»“æ„,æ–‡æ¡£ä¸ä¾èµ–é¢„å…ˆå®šä¹‰çš„æ¨¡å¼,æˆ‘ä»¬çŸ¥é“å…³ç³»å‹æ•°æ®åº“ä¸­,è¦æå‰å®šä¹‰å­—æ®µæ‰èƒ½ä½¿ç”¨,åœ¨elasticsearchä¸­,å¯¹äºå­—æ®µæ˜¯éå¸¸çµæ´»çš„,æœ‰æ—¶å€™,æˆ‘ä»¬å¯ä»¥å¿½ç•¥è¯¥å­—æ®µ,æˆ–è€…åŠ¨æ€çš„æ·»åŠ ä¸€ä¸ªæ–°çš„å­—æ®µ.</p><p>å°½ç®¡æˆ‘ä»¬å¯ä»¥éšæ„çš„æ–°å¢æˆ–è€…å¿½ç•¥æŸä¸ªå­—æ®µ,ä½†æ˜¯,æ¯ä¸ªå­—æ®µçš„ç±»å‹éå¸¸é‡è¦,æ¯”å¦‚ä¸€ä¸ªå¹´é¾„å­—æ®µç±»å‹,å¯ä»¥æ˜¯å­—ç¬¦ä¸²ä¹Ÿå¯ä»¥æ˜¯æ•´å‹.å› ä¸ºelasticsearchä¼šä¿å­˜å­—æ®µå’Œç±»å‹ä¹‹é—´çš„æ˜ å°„åŠå…¶ä»–çš„è®¾ç½®.è¿™ç§æ˜ å°„å…·ä½“åˆ°æ¯ä¸ªæ˜ å°„çš„æ¯ç§ç±»å‹,è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨elasticsearchä¸­,ç±»å‹æœ‰æ—¶å€™ä¹Ÿç§°ä¸ºæ˜ å°„ç±»å‹.</p></li></ul><blockquote><p>ç±»å‹</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596630612189.png" alt="1596630612189"></p><p>ç±»å‹æ˜¯æ–‡æ¡£çš„é€»è¾‘å®¹å™¨,å°±åƒå…³ç³»å‹æ•°æ®åº“ä¸€æ ·,è¡¨æ ¼æ˜¯è¡Œçš„å®¹å™¨.ç±»å‹ä¸­å¯¹äºå­—æ®µçš„å®šä¹‰ç§°ä¸ºæ˜ å°„,æ¯”å¦‚nameæ˜ å°„ä¸ºå­—ç¬¦ä¸²ç±»å‹.æˆ‘ä»¬è¯´æ–‡æ¡£æ˜¯æ— æ¨¡å¼çš„,ä»–ä»¬ä¸éœ€è¦æ‹¥æœ‰æ˜ å°„ä¸­æ‰€å®šä¹‰çš„æ‰€æœ‰å­—æ®µ,æ¯”å¦‚æ–°å¢ä¸€ä¸ªå­—æ®µ,é‚£ä¹ˆelasticsearchæ˜¯æ€ä¹ˆåšçš„å‘¢?</p><p>elasticsearchä¼šè‡ªåŠ¨çš„å°†æ–°çš„å­—æ®µåŠ å…¥æ˜ å°„,ä½†æ˜¯è¿™ä¸ªå­—æ®µçš„ä¸ç¡®å®šå®ƒæ˜¯ä»€ä¹ˆç±»å‹,elasticsearchå°±å¼€å§‹çŒœ,å¦‚æœè¿™ä¸ªå€¼æ˜¯18,é‚£ä¹ˆelasticsearchä¼šè®¤ä¸ºä»–æ˜¯æ•´å‹.ä½†æ˜¯elasticsearchä¹Ÿå¯èƒ½çŒœä¸å¯¹,æ‰€æœ‰æœ€å®‰å…¨çš„æ–¹å¼å°±æ˜¯æå‰å®šä¹‰å¥½æ‰€éœ€è¦çš„æ˜ å°„,è¿™ç‚¹è·Ÿå…³ç³»å‹æ•°æ®åº“æ®Šé€”åŒå½’äº†,å…ˆå®šä¹‰å¥½å­—æ®µ,ç„¶ååœ¨ä½¿ç”¨,åˆ«æ•´ä»€ä¹ˆå¹ºè›¾å­.</p><blockquote><p>ç´¢å¼•</p></blockquote><p><strong>å°±æ˜¯æ•°æ®åº“</strong></p><p>ç´¢å¼•æ˜¯æ˜ å°„ç±»å‹çš„å®¹å™¨,elasticsearchä¸­çš„ç´¢å¼•æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„æ–‡æ¡£é›†åˆ.ç´¢å¼•å­˜å‚¨äº†æ˜ å°„ç±»å‹å­—æ®µå’Œå…¶ä»–è®¾ç½®,ç„¶åä»–ä»¬å‘—å­˜å‚¨åˆ°äº†å„ä¸ªåˆ†ç‰‡ä¸Šäº†.æˆ‘ä»¬æ¥ç ”ç©¶ä¸‹åˆ†ç‰‡æ˜¯å¦‚ä½•å·¥ä½œçš„.</p><h3 id="ç‰©ç†è®¾è®¡-èŠ‚ç‚¹å’Œåˆ†ç‰‡-å¦‚ä½•å·¥ä½œ"><a href="#ç‰©ç†è®¾è®¡-èŠ‚ç‚¹å’Œåˆ†ç‰‡-å¦‚ä½•å·¥ä½œ" class="headerlink" title="ç‰©ç†è®¾è®¡: èŠ‚ç‚¹å’Œåˆ†ç‰‡ å¦‚ä½•å·¥ä½œ"></a>ç‰©ç†è®¾è®¡: èŠ‚ç‚¹å’Œåˆ†ç‰‡ å¦‚ä½•å·¥ä½œ</h3><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596630840364.png" alt="1596630840364"></p><p>ä¸€ä¸ªé›†ç¾¤è‡³å°‘è¦æœ‰ä¸€ä¸ªèŠ‚ç‚¹,å„¿ä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯ä¸€ä¸ªelasticsearchè¿›ç¨‹,èŠ‚ç‚¹å¯ä»¥æœ‰å¤šä¸ªç´¢å¼•é»˜è®¤çš„,å¦‚æœä½ åˆ›å»ºç´¢å¼•,é‚£ä¹ˆç´¢å¼•å°†ä¼šæœ‰5ä¸ªåˆ†ç‰‡(primary shard,åˆç§°ä¸»åˆ†ç‰‡) æ„æˆçš„,æ¯ä¸ªä¸»åˆ†ç‰‡ä¼šæœ‰ä¸€ä¸ªå‰¯æœ¬(replica shard,åˆç§°å¤åˆ¶åˆ†ç‰‡)</p><p><img src="http://victorfengming.gitee.io/course/elasticsearch/base/07-elasticsearch-es%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E7%90%86%E8%A7%A3.assets/1596630793639.png" alt="1596630793639"></p><p><img src="http://victorfengming.gitee.io/course/elasticsearch/base/07-elasticsearch-es%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E7%90%86%E8%A7%A3.assets/1596630870602.png" alt="1596630870602"></p><blockquote><p>å€’æ’ç´¢å¼•</p></blockquote><p>elasticsearchä½¿ç”¨çš„æ˜¯ä¸€ç§ç§°ä¸ºå€’æ’ç´¢å¼•çš„ç»“æ„,é‡‡ç”¨Luceneå€’æ’ç´¢å¼•ä½œä¸ºåº•å±‚.è¿™ç§ç»“æ„é€‚ç”¨äºå¿«é€Ÿçš„å…¨æ–‡æœç´¢,ä¸€ä¸ªç´¢å¼•ç”±æ–‡æ¡£ä¸­æ‰€æœ‰ä¸é‡å¤çš„åˆ—è¡¨æ„æˆ,å¯¹äºæ¯ä¸€ä¸ªè¯,éƒ½æœ‰ä¸€ä¸ªåŒ…å«å®ƒçš„æ–‡æ¡£åˆ—è¡¨.ä¾‹å¦‚,ç°åœ¨æœ‰ä¸¤ä¸ªæ–‡æ¡£,æ¯ä¸ªæ–‡æ¡£åŒ…å«å¦‚ä¸‹å†…å®¹.</p><p><img src="http://victorfengming.gitee.io/course/elasticsearch/base/07-elasticsearch-es%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E7%90%86%E8%A7%A3.assets/1596631073200.png" alt="1596631073200"></p><p>ä¸ºäº†åˆ›å»ºå€’æ’ç´¢å¼•,æˆ‘ä»¬é¦–å…ˆè¦å°†æ¯ä¸ªæ–‡æ¡£æ‹†åˆ†æˆç‹¬ç«‹çš„è¯(æˆ–ç§°ä¸ºè¯æ¡æˆ–è€…tokens),ç„¶ååˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰ä¸é‡å¤çš„è¯æ¡çš„æ’åºåˆ—è¡¨,ç„¶ååˆ—å‡ºæ¯ä¸ªè¯æ¡å‡ºç°åœ¨å“ªä¸ªæ–‡æ¡£:</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596631181270.png" alt="1596631181270"></p><p>ä¸¤ä¸ªæ–‡æ¡£éƒ½åŒ¹é…,ä½†æ˜¯ç¬¬ä¸€ä¸ªæ–‡æ¡£æ¯”ç¬¬äºŒä¸ªåŒ¹é…ç¨‹åº¦æ›´é«˜.å¦‚æœæ²¡æœ‰åˆ«çš„æ¡ä»¶,ç°åœ¨,è¿™ä¸¤ä¸ªåŒ…å«å…³é”®å­—çš„æ–‡æ¡£éƒ½å°†è¿”å›.</p><p>å†æ¥çœ‹ä¸€ä¸ªç¤ºä¾‹,æ¯”å¦‚æˆ‘ä»¬é€šè¿‡åšå®¢æ ‡ç­¾æ¥æœç´¢åšå®¢æ–‡ç« .é‚£ä¹ˆå€’æ’ç´¢å¼•åˆ—è¡¨å°±æ˜¯è¿™æ ·çš„ä¸€ä¸ªç»“æ„:</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596631425757.png" alt="1596631425757"></p><p>å¦‚æœè¦æœç´¢å«æœ‰pythonæ ‡ç­¾çš„æ–‡ç« ,é‚£ç›¸å¯¹æŸ¥æ‰¾æ‰€æœ‰åŸå§‹æ•°æ®è€Œè¨€,æŸ¥æ‰¾å€’æ’ç´¢å¼•åçš„æ•°æ®å°†ä¼šå¿«çš„å¤š.åªéœ€è¦æŸ¥çœ‹æ ‡ç­¾è¿™ä¸€æ ,ç„¶åè·å–ç›¸å…³æ–‡ç« idå³å¯.</p><h1 id="IKåˆ†è¯å™¨æ’ä»¶"><a href="#IKåˆ†è¯å™¨æ’ä»¶" class="headerlink" title="IKåˆ†è¯å™¨æ’ä»¶"></a>IKåˆ†è¯å™¨æ’ä»¶</h1><h2 id="ä»€ä¹ˆæ˜¯åˆ†è¯å™¨"><a href="#ä»€ä¹ˆæ˜¯åˆ†è¯å™¨" class="headerlink" title="ä»€ä¹ˆæ˜¯åˆ†è¯å™¨"></a><strong>ä»€ä¹ˆæ˜¯åˆ†è¯å™¨</strong></h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596637415868.png" alt="1596637415868"></p><p>==å¦‚æœä½¿ç”¨ä¸­æ–‡,å»ºè®®ä½¿ç”¨ikåˆ†è¯å™¨==</p><p>IKä½“ç”¨äº†ä¸¤ä¸ªåˆ†è¯ç®—æ³•:<code>ik_smart</code>å’Œ,å…¶ä¸­ik_smartä¸ºæœ€å°‘(Ë‰â–½ï¿£ï½) åˆ‡~~åˆ†,ik_max_wordä¸ºæœ€ç»†ç²’åº¦åˆ’åˆ†! ä¸€ä¼šæˆ‘ä»¬æµ‹è¯•</p><blockquote><p>å®‰è£…</p></blockquote><ol><li><p><a href="https://github.com/medcl/elasticsearch-analysis-ik%EF%BC%8C%E7%89%88%E6%9C%AC%E9%9C%80%E8%A6%81%E5%92%8CElasticSearch%E7%89%88%E6%9C%AC%E5%AF%B9%E5%BA%94">https://github.com/medcl/elasticsearch-analysis-ikï¼Œç‰ˆæœ¬éœ€è¦å’ŒElasticSearchç‰ˆæœ¬å¯¹åº”</a></p></li><li><p>ä¸‹è½½å®Œæ¯•ä¹‹å,æ”¾å…¥åˆ°æˆ‘ä»¬çš„elasticsearchæ’ä»¶å³å¯</p><p><img src="http://victorfengming.gitee.io/course/elasticsearch/base/08-elasticsearch-IK%E5%88%86%E8%AF%8D%E5%99%A8%E6%8F%92%E4%BB%B6.assets/1596637767841.png" alt="1596637767841"></p><ol><li><p>é‡å¯è§‚å¯ŸES</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596674648793.png" alt="1596674648793"></p></li><li><p>elasticsearch-plugin å¯ä»¥é€šè¿‡è¿™ä¸ªå‘½ä»¤æ¥æŸ¥çœ‹åŠ è½½çš„æ’ä»¶</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596674703775.png" alt="1596674703775"></p></li><li><p>ä½¿ç”¨kibanaæµ‹è¯•!</p><p>æŸ¥çœ‹ä¸åŒçš„åˆ†è¯å™¨æ•ˆæœ</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596674979545.png" alt="1596674979545"></p></li></ol></li></ol><h2 id="ikåˆ†è¯å™¨å¢åŠ æˆ‘ä»¬è‡ªå·±çš„é…ç½®"><a href="#ikåˆ†è¯å™¨å¢åŠ æˆ‘ä»¬è‡ªå·±çš„é…ç½®" class="headerlink" title="ikåˆ†è¯å™¨å¢åŠ æˆ‘ä»¬è‡ªå·±çš„é…ç½®"></a>ikåˆ†è¯å™¨å¢åŠ æˆ‘ä»¬è‡ªå·±çš„é…ç½®</h2><p>è¿™ç§è‡ªå·±éœ€è¦çš„è¯,éœ€è¦è‡ªå·±åŠ åˆ°æˆ‘ä»¬çš„åˆ†è¯å™¨å­—å…¸ä¸­!</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596675349989.png" alt="1596675349989"></p><p>é‡å¯ES,çœ‹ç»†èŠ‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596675426305.png" alt="1596675426305"></p><p>å†æ¬¡æµ‹è¯•ä¸€ä¸‹ç‹‚ç¥è¯´,</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1596675486318.png" alt="1596675486318"></p><p>ä»¥åçš„è¯æˆ‘ä»¬éœ€è¦è‡ªå·±é…ç½®è‡ªå·±çš„è¯,åªéœ€è¦åœ¨è‡ªå®šä¹‰çš„dicæ–‡ä»¶ä¸­è¿›è¡Œé…ç½®å³å¯!</p><h1 id="Resté£æ ¼è¯´æ˜"><a href="#Resté£æ ¼è¯´æ˜" class="headerlink" title="Resté£æ ¼è¯´æ˜"></a>Resté£æ ¼è¯´æ˜</h1><p>ä¸€ç§è½¯ä»¶æ¶æ„é£æ ¼,è€Œä¸æ˜¯æ ‡å‡†,åªæ˜¯æä¾›äº†ä¸€ç»„è®¾è®¡åŸåˆ™å’Œçº¦æŸæ¡ä»¶.å®ƒä¸»è¦ç”¨äºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº¤äº’ç±»çš„è½¯ä»¶.åŸºäºè¿™ä¸ªé£æ ¼è®¾è®¡çš„è½¯ä»¶å¯ä»¥æ›´ç®€æ´,æ›´æœ‰å±‚æ¬¡,æ›´æ˜“äºå®ç°ç¼“å­˜ç­‰æœºåˆ¶.</p><p>åŸºæœ¬Resté£æ ¼å‘½ä»¤è¯´æ˜</p><table><thead><tr><th>method</th><th>urlåœ°å€</th><th>æè¿°</th></tr></thead><tbody><tr><td>PUT</td><td>127.0.01:9200/ç´¢å¼•åç§°/_create/æ–‡æ¡£id</td><td>åˆ›å»ºæ–‡æ¡£ï¼ˆæŒ‡å®šidï¼‰</td></tr><tr><td>POST</td><td>127.0.01:9200/ç´¢å¼•åç§°/_doc</td><td>åˆ›å»ºæ–‡æ¡£</td></tr><tr><td>POST</td><td>127.0.01:9200/ç´¢å¼•åç§°/_update/æ–‡æ¡£id</td><td>ä¿®æ”¹æ–‡æ¡£</td></tr><tr><td>DELETE</td><td>127.0.01:9200/ç´¢å¼•åç§°</td><td>åˆ é™¤ç´¢å¼•</td></tr><tr><td>DELETE</td><td>127.0.01:9200/ç´¢å¼•åç§°/_doc/æ–‡æ¡£id</td><td>åˆ é™¤æ–‡æ¡£</td></tr></tbody></table><blockquote><p>åŸºç¡€æµ‹è¯•</p></blockquote><h2 id="å…³äºç´¢å¼•çš„åŸºæœ¬æ“ä½œ"><a href="#å…³äºç´¢å¼•çš„åŸºæœ¬æ“ä½œ" class="headerlink" title="å…³äºç´¢å¼•çš„åŸºæœ¬æ“ä½œ"></a>å…³äºç´¢å¼•çš„åŸºæœ¬æ“ä½œ</h2><h3 id="ç´¢å¼•indices"><a href="#ç´¢å¼•indices" class="headerlink" title="ç´¢å¼•indices"></a>ç´¢å¼•indices</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># id</span><br><span class="line">PUT &#x2F;test&#x2F;_create&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;zxj1&quot;,</span><br><span class="line">  &quot;age&quot;:18</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># wu id</span><br><span class="line">POST &#x2F;test&#x2F;_doc</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;zxj1&quot;,</span><br><span class="line">  &quot;age&quot;:18</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201018173524585.png" alt="image-20201018173524585"></p><h3 id="æ˜ å°„mapping"><a href="#æ˜ å°„mapping" class="headerlink" title="æ˜ å°„mapping"></a>æ˜ å°„mapping</h3><p>é‚£ä¹ˆnameè¿™ä¸ªå­—æ®µç”¨ä¸ç”¨æŒ‡å®šç±»å‹å‘¢,æ¯•ç«Ÿæˆ‘ä»¬å…³ç³»å‹æ•°æ®åº“ æ˜¯éœ€è¦æŒ‡å®šç±»å‹æ˜ å°„çš„å•Š</p><p><img src="http://victorfengming.gitee.io/course/elasticsearch/base/09-elasticsearch-Rest%E9%A3%8E%E6%A0%BC.assets/1596676128844.png" alt="1596676128844"></p><ol><li><p>æŒ‡å®šå­—æ®µçš„ç±»å‹</p><p>è·å¾—è¿™ä¸ªè§„åˆ™! å¯é€šè¿‡GETè¯·æ±‚è·å–å…·ä½“çš„ä¿¡æ¯</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201018174140347.png" alt="image-20201018174140347"></p></li><li><p>ä¸ç»™ç´¢å¼•è®¾ç½®mappingçš„è¯ï¼ŒElasticSearchä¼šé»˜è®¤åŒ¹é…ï¼›å¦‚æœè‡ªå·±çš„æ–‡æ¡£å­—æ®µæ²¡æœ‰æŒ‡å®š,é‚£ä¹ˆESå°±ä¼šç»™æˆ‘ä»¬é…ç½®å­—æ®µç±»å‹</p></li></ol><h1 id="å…³äºæ–‡æ¡£çš„åŸºæœ¬æ“ä½œ"><a href="#å…³äºæ–‡æ¡£çš„åŸºæœ¬æ“ä½œ" class="headerlink" title="å…³äºæ–‡æ¡£çš„åŸºæœ¬æ“ä½œ"></a>å…³äºæ–‡æ¡£çš„åŸºæœ¬æ“ä½œ</h1><p><a href="https://www.bilibili.com/video/BV17a4y1x7zq?p=10">https://www.bilibili.com/video/BV17a4y1x7zq?p=10</a></p><h2 id="åŸºæœ¬æ“ä½œ"><a href="#åŸºæœ¬æ“ä½œ" class="headerlink" title="åŸºæœ¬æ“ä½œ"></a><strong>åŸºæœ¬æ“ä½œ</strong></h2><ol><li><p>æ·»åŠ æ•°æ®</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201018173524585.png" alt="image-20201018173524585"></p></li><li><p>è·å–æ•°æ®</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597891281730.png" alt="1597891281730"></p></li><li><p>æ›´æ–°æ•°æ® PUTï¼Œæ›´æ–°æ—¶æ˜¯è¦†ç›–æ›´æ–°ï¼Œæ²¡æœ‰æ›´æ–°çš„å­—æ®µä¼šè¢«è¦†ç›–ä¸ºç©ºï¼</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597891378076.png" alt="1597891378076"></p></li><li><p>Post _update,==æ¨èä½¿ç”¨è¿™ç§æ›´æ–°æ–¹å¼!==</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597891620183.png" alt="1597891620183"></p></li></ol><h2 id="ç®€å•åœ°æœç´¢"><a href="#ç®€å•åœ°æœç´¢" class="headerlink" title="ç®€å•åœ°æœç´¢!"></a>ç®€å•åœ°æœç´¢!</h2>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET test&#x2F;_doc&#x2F;2</span><br></pre></td></tr></table></figure><p>   ç®€å•çš„æ¡ä»¶æŸ¥è¯¢,å¯ä»¥æ ¹æ®é»˜è®¤çš„æ˜ å°„è§„åˆ™,äº§ç”ŸåŸºæœ¬çš„æŸ¥è¯¢</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201018175222885.png" alt="image-20201018175222885">   <img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597892169142.png" alt="1597892169142"></p><blockquote></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597974203192.png" alt="1597974203192"></p><h2 id="å¤æ‚æ“ä½œæœç´¢"><a href="#å¤æ‚æ“ä½œæœç´¢" class="headerlink" title="å¤æ‚æ“ä½œæœç´¢"></a>å¤æ‚æ“ä½œæœç´¢</h2><blockquote><p>select(æ’åº,åˆ†é¡µ,é«˜äº®,æ¨¡ç³ŠæŸ¥è¯¢,ç²¾å‡†æŸ¥è¯¢! )</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597892352276.png" alt="1597892352276"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597892367286.png" alt="1597892367286"></p><p>è¾“å‡ºç»“æœä¸æƒ³è¦é‚£ä¹ˆå¤š,select *</p><p>ç°åœ¨æ˜¯select name,age</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597892385326.png" alt="1597892385326"></p><p>å¯ä»¥æŒ‡å®šå­—æ®µ</p><p>ç»“æœçš„è¿‡æ»¤</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597892451582.png" alt="1597892451582"></p><p>æˆ‘ä»¬ä¹‹åä½¿ç”¨Javaæ“ä½œES,æ‰€æœ‰çš„æ–¹æ³•å’Œå¯¹è±¡å°±æ˜¯è¿™é‡Œé¢çš„key!</p><blockquote><p>æ’åº</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597892561417.png" alt="1597892561417"></p><blockquote><p>åˆ†é¡µæŸ¥è¯¢</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597892615017.png" alt="1597892615017"></p><p>æ•°æ®ä¸‹æ ‡è¿˜æ˜¯ä»0å¼€å§‹,å’Œä¹‹å‰æ‰€å­¦çš„æ•°æ®ç»“æ„éƒ½æ˜¯ä¸€æ ·çš„!</p><blockquote><p>å¸ƒå°”å€¼æŸ¥è¯¢</p></blockquote><p>must(and) ,æ‰€æœ‰æ¡ä»¶éƒ½è¦ç¬¦åˆ where id=1 and name=xxx</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597892730673.png" alt="1597892730673"></p><p>should (or) ,æ‰€æœ‰æ¡ä»¶éƒ½è¦ç¬¦åˆ where id=1 or name = xxx</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597892885428.png" alt="1597892885428"></p><p>must not (not)</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597892928930.png" alt="1597892928930"></p><p>è¿‡æ»¤å™¨ filter</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597892996458.png" alt="1597892996458"></p><ul><li>gt å¤§äº</li><li>gte å¤§äºç­‰äº</li><li>lt å°äº</li><li>lte å°äºç­‰äº</li></ul><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597893039013.png" alt="1597893039013"></p><p>åŒ¹é…å¤šä¸ªæ¡ä»¶</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597893096034.png" alt="1597893096034"></p><p>ç”¨ç©ºæ ¼åˆ†éš”ä¹Ÿè¡Œ</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597893131147.png" alt="1597893131147"></p><blockquote><p>ç²¾ç¡®æŸ¥è¯¢</p></blockquote><p>term æŸ¥è¯¢æ—¶ç›´æ¥é€šè¿‡å€’æ’ç´¢å¼•æŒ‡å®šçš„è¯æ¡è¿›ç¨‹ç²¾ç¡®æŸ¥æ‰¾çš„!</p><p>å…³äºåˆ†è¯:</p><p>term,ç›´æ¥æŸ¥è¯¢ç²¾ç¡®çš„</p><p>match,ä¼šä½¿ç”¨åˆ†è¯å™¨è§£æ! (å…ˆåˆ†æåˆ†æ¡£,ç„¶åå†é€šè¿‡åˆ†æçš„åˆ†æ¡£è¿›è¡ŒæŸ¥è¯¢! )</p><p><strong>ä¸¤ä¸ªç±»å‹ text keyword</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597893556500.png" alt="1597893556500"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597893572562.png" alt="1597893572562"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597893648565.png" alt="1597893648565"></p><blockquote><p>å¤šä¸ªå€¼åŒ¹é…ç²¾ç¡®æŸ¥è¯¢</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597900914957.png" alt="1597900914957"></p><blockquote><p>é«˜äº®æŸ¥è¯¢!</p></blockquote><p>æœç´¢çš„é«˜äº®æ¡ä»¶,ä¼šåœ¨HTMLé‡Œé¢è‡ªåŠ¨çš„åŠ ä¸Šæ ‡ç­¾</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597901143555.png" alt="1597901143555"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597905816361.png" alt="1597905816361"></p><h1 id="é›†æˆSpringBoot"><a href="#é›†æˆSpringBoot" class="headerlink" title="é›†æˆSpringBoot"></a>é›†æˆSpringBoot</h1><blockquote><p>æ‰¾æ–‡æ¡£!</p></blockquote><p><a href="https://proxies.app.aidoru.net/-----https://www.elastic.co/guide/index.html">https://proxies.app.aidoru.net/-----https://www.elastic.co/guide/index.html</a></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597906806327.png" alt="1597906806327"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597906105998.png" alt="1597906105998"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597906924635.png" alt="img"></p><ol><li><p>æ‰¾åˆ°åŸç”Ÿçš„ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ol><ol start="2"><li><p>æ‰¾å¯¹è±¡</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597907115554.png" alt="1597907115554"></p></li><li><p>åˆ†æè¿™ä¸ªç±»ä¸­çš„æ–¹æ³•å³å¯</p><blockquote><p>é…ç½®åŸºæœ¬çš„é¡¹ç›®</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597907258818.png" alt="1597907258818"></p><blockquote><p>é—®é¢˜:ä¸€å®šè¦ä¿è¯æˆ‘ä»¬å¯¼å…¥çš„ä¾èµ–å’Œæˆ‘ä»¬çš„ESç‰ˆæœ¬ä¸€è‡´</p></blockquote><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597907493787.png" alt="1597907493787"></p></li></ol><p>æŒ‰ç…§å®˜ç½‘çš„æ“ä½œæˆ‘ä»¬è¦æ„å»ºä¸€ä¸ªå¯¹è±¡</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597907737591.png" alt="1597907737591"></p><p>åˆ†ææºç </p><p>ç‹‚ç¥çš„Springæ­¥éª¤:</p><ol><li><p>æ‰¾å¯¹è±¡</p></li><li><p>æ”¾åˆ°springä¸­å¾…ç”¨</p></li><li><p>å¦‚æœæ˜¯springboot,é‚£å°±å…ˆåˆ†ææºç </p><p>xxxAutoConfiguration,xxxProperties</p></li></ol><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/1597908504743.png" alt="1597908504743"></p><p>æºç ä¸­æä¾›çš„å¯¹è±¡</p><p>è™½ç„¶è¿™é‡Œå¯¼å…¥äº†3ä¸ªç±»,é™æ€å†…éƒ¨ç±»,æ ¸å¿ƒç±»å°±ä¸€ä¸ª</p><h2 id="å…³äºç´¢å¼•çš„APIæ“ä½œè¯¦è§£"><a href="#å…³äºç´¢å¼•çš„APIæ“ä½œè¯¦è§£" class="headerlink" title="å…³äºç´¢å¼•çš„APIæ“ä½œè¯¦è§£"></a>å…³äºç´¢å¼•çš„APIæ“ä½œè¯¦è§£</h2><blockquote><p>å…·ä½“çš„Apiæµ‹è¯•!</p></blockquote><p><code>restHighLevelClient.indices().xxx()</code></p><ol><li><p>åˆ›å»ºç´¢å¼•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index create</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 1. æ„å»ºç´¢å¼•è¯·æ±‚å®ä½“ç±» å°±æ˜¯åˆ›å»ºç´¢å¼•æ—¶çš„&#123;&#125;</span></span><br><span class="line">    CreateIndexRequest springboot_index = <span class="keyword">new</span> CreateIndexRequest(<span class="string">&quot;springboot_index&quot;</span>);</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 2.æ‰§è¡Œåˆ›å»ºç´¢å¼•è¯·æ±‚,è¿”å›å“åº”</span></span><br><span class="line">    CreateIndexResponse createIndexResponse =</span><br><span class="line">            restHighLevelClient.indices().create(springboot_index, RequestOptions.DEFAULT);</span><br><span class="line">   </span><br><span class="line">    System.out.println(createIndexResponse);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åˆ¤æ–­ç´¢å¼•æ˜¯å¦å­˜åœ¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">getIndices</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">     <span class="comment">// 1. åˆ›å»ºè¯·æ±‚ä½“å†…å®¹å¯¹è±¡</span></span><br><span class="line">     GetIndexRequest srpingboot_index = <span class="keyword">new</span> GetIndexRequest(<span class="string">&quot;springboot_index&quot;</span>);</span><br><span class="line">   </span><br><span class="line">     <span class="comment">// 2. action</span></span><br><span class="line">     <span class="keyword">boolean</span> exists = restHighLevelClient.indices().exists(srpingboot_index,</span><br><span class="line">             RequestOptions.DEFAULT);</span><br><span class="line">     System.out.println(exists);</span><br><span class="line">     GetIndexResponse getIndexResponse = restHighLevelClient.indices().get(srpingboot_index,</span><br><span class="line">             RequestOptions.DEFAULT);</span><br><span class="line">     System.out.println(getIndexResponse);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li><li><p>åˆ é™¤ç´¢å¼•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">deleteIndices</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 1. åˆ›å»ºè¯·æ±‚ä½“å†…å®¹å¯¹è±¡,åˆ é™¤æ—¶ç´¢å¼•éœ€å­˜åœ¨ï¼</span></span><br><span class="line">    DeleteIndexRequest springboot_index = <span class="keyword">new</span> DeleteIndexRequest(<span class="string">&quot;springboot_index&quot;</span>);</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 2. action</span></span><br><span class="line">    AcknowledgedResponse delete = restHighLevelClient.indices().delete(springboot_index,</span><br><span class="line">            RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(delete.isAcknowledged());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºæ–‡æ¡£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">createDocument</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// put /index/_create/id &#123;...&#125;</span></span><br><span class="line">    <span class="comment">// 1. æ„å»ºåˆ›å»ºçš„æ–‡æ¡£çš„å†…å®¹</span></span><br><span class="line">    IndexRequest indexRequest = <span class="keyword">new</span> IndexRequest(<span class="string">&quot;springboot_index&quot;</span>);</span><br><span class="line">    indexRequest.timeout(<span class="string">&quot;1s&quot;</span>);</span><br><span class="line">    indexRequest.id(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="comment">// public IndexRequest source(String source, XContentType xContentType)</span></span><br><span class="line">    indexRequest.source(JSON.toJSONString(<span class="keyword">new</span> User(<span class="string">&quot;zxj&quot;</span>, <span class="number">18</span>)), XContentType.JSON);</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 2. å¼€å§‹è¯·æ±‚</span></span><br><span class="line">    IndexResponse index = restHighLevelClient.index(indexRequest, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(index.status());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>crudæ–‡æ¡£</p></li></ol><h2 id="å…³äºæ–‡æ¡£çš„APIæ“ä½œè¯¦è§£"><a href="#å…³äºæ–‡æ¡£çš„APIæ“ä½œè¯¦è§£" class="headerlink" title="å…³äºæ–‡æ¡£çš„APIæ“ä½œè¯¦è§£"></a>å…³äºæ–‡æ¡£çš„APIæ“ä½œè¯¦è§£</h2><blockquote><p>åˆ›å»ºæ–‡æ¡£</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">createDocument</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// put /index/_create/id &#123;...&#125;</span></span><br><span class="line">    <span class="comment">// 1. æ„å»ºåˆ›å»ºçš„æ–‡æ¡£çš„å†…å®¹</span></span><br><span class="line">    IndexRequest indexRequest = <span class="keyword">new</span> IndexRequest(<span class="string">&quot;springboot_index&quot;</span>);</span><br><span class="line">    indexRequest.timeout(<span class="string">&quot;1s&quot;</span>);</span><br><span class="line">    indexRequest.id(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="comment">// public IndexRequest source(String source, XContentType xContentType)</span></span><br><span class="line">    indexRequest.source(JSON.toJSONString(<span class="keyword">new</span> User(<span class="string">&quot;zxj&quot;</span>, <span class="number">18</span>)), XContentType.JSON);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. å¼€å§‹è¯·æ±‚</span></span><br><span class="line">    IndexResponse index = restHighLevelClient.index(indexRequest, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(index.status());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœ</p><p>è¿™é‡Œçš„è¿”å›çš„å…¨éƒ¨å†…å®¹å’Œæˆ‘ä»¬çš„å‘½ä»¤æ˜¯ä¸€æ ·çš„</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201018194243887.png" alt="image-20201018194243887"></p><blockquote><p>æ›´æ–°æ–‡æ¡£ä¿¡æ¯</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">updateDocument</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">       <span class="comment">// post /index/_update/id &#123;&quot;doc&quot;:&#123;...&#125;&#125;</span></span><br><span class="line">       <span class="comment">// 1. æ„å»ºä¿®æ”¹çš„æ–‡æ¡£çš„å†…å®¹,String index, String id</span></span><br><span class="line">       UpdateRequest updateRequest = <span class="keyword">new</span> UpdateRequest(<span class="string">&quot;springboot_index&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">       updateRequest.timeout(<span class="string">&quot;1s&quot;</span>);</span><br><span class="line">       updateRequest.doc(JSON.toJSONString(<span class="keyword">new</span> User(<span class="string">&quot;new Name&quot;</span>, <span class="number">18</span>)), XContentType.JSON);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 2. å¼€å§‹è¯·æ±‚</span></span><br><span class="line">       UpdateResponse updateResponse = restHighLevelClient.update(updateRequest, RequestOptions.DEFAULT);</span><br><span class="line">       System.out.println(updateResponse.status());</span><br><span class="line">       System.out.println(updateResponse.toString());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201018194653575.png" alt="image-20201018194653575"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201018194726197.png" alt="image-20201018194726197"></p><blockquote><p>åˆ é™¤æ–‡æ¡£è®°å½•</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">dropDocument</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">       <span class="comment">// delete /index/_doc/id</span></span><br><span class="line">       <span class="comment">// 1. æ„å»ºåˆ é™¤æ–‡æ¡£çš„å¯¹è±¡,String index, String id</span></span><br><span class="line">       DeleteRequest deleteRequest = <span class="keyword">new</span> DeleteRequest(<span class="string">&quot;springboot_index&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">       deleteRequest.timeout(<span class="string">&quot;1s&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 2. å¼€å§‹è¯·æ±‚</span></span><br><span class="line">       DeleteResponse delete = restHighLevelClient.delete(deleteRequest, RequestOptions.DEFAULT);</span><br><span class="line">       System.out.println(delete.status());</span><br><span class="line">       System.out.println(delete.toString());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201018195024638.png" alt="image-20201018195024638"></p><h3 id="æ‰¹é‡æ“ä½œ"><a href="#æ‰¹é‡æ“ä½œ" class="headerlink" title="æ‰¹é‡æ“ä½œ"></a>æ‰¹é‡æ“ä½œ</h3><blockquote><p>ç‰¹æ®Šçš„,çœŸçš„é¡¹ç›®ä¸€èˆ¬éƒ½ä¼šæ‰¹é‡æ’å…¥æ•°æ®</p></blockquote><p>æ‰¹é‡æ“ä½œbulkRequestæœ‰å¾ˆå¤šç±»å‹ï¼šä¾‹å¦‚ä¸‹è¿°ã€‚è¿™é‡Œåªå±•ç¤ºæ‰¹é‡å¢åŠ </p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201018195851648.png" alt="image-20201018195851648"></p><p>æ‰¹é‡æ·»åŠ æ–‡æ¡£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bulgRequest</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 1. æ„å»ºæ‰¹é‡è¯·æ±‚ä½“</span></span><br><span class="line">    BulkRequest bulkRequest = <span class="keyword">new</span> BulkRequest();</span><br><span class="line">    bulkRequest.timeout(<span class="string">&quot;10s&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        IndexRequest indexRequest = <span class="keyword">new</span> IndexRequest(<span class="string">&quot;springboot_index&quot;</span>);</span><br><span class="line">        indexRequest.source(JSON.toJSONString(<span class="keyword">new</span> User(<span class="string">&quot;zxj&quot;</span>+i, <span class="number">18</span>)), XContentType.JSON);</span><br><span class="line">        bulkRequest.add(indexRequest);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BulkResponse bulk = restHighLevelClient.bulk(bulkRequest, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(!bulk.hasFailures());</span><br><span class="line">    System.out.println(bulk.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æŸ¥è¯¢æœç´¢ğŸ”º"><a href="#æŸ¥è¯¢æœç´¢ğŸ”º" class="headerlink" title="æŸ¥è¯¢æœç´¢ğŸ”º"></a>æŸ¥è¯¢æœç´¢ğŸ”º</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;search/&#123;key&#125;/&#123;page&#125;/&#123;size&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; searchLists(<span class="meta">@PathVariable(&quot;key&quot;)</span> String keyword,</span><br><span class="line">                                             <span class="meta">@PathVariable(&quot;page&quot;)</span> Long page, <span class="meta">@PathVariable(</span></span><br><span class="line"><span class="meta">                                                     &quot;size&quot;)</span> Long size) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// æ„å»ºæœç´¢å¯¹è±¡</span></span><br><span class="line">    SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">&quot;jd1&quot;</span>);</span><br><span class="line">    <span class="comment">// æœç´¢æ¡ä»¶æ„é€ </span></span><br><span class="line">    SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    searchSourceBuilder.timeout(<span class="keyword">new</span> TimeValue(<span class="number">2L</span>, TimeUnit.SECONDS));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒ¹é…æŸ¥è¯¢</span></span><br><span class="line">    MatchQueryBuilder title = QueryBuilders.matchQuery(<span class="string">&quot;title&quot;</span>, keyword);</span><br><span class="line">    searchSourceBuilder.query(title);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// page</span></span><br><span class="line">    <span class="keyword">if</span> (page&lt;=<span class="number">1L</span>)&#123;</span><br><span class="line">        page = <span class="number">1L</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    searchSourceBuilder.from((<span class="keyword">int</span>) (page * size));</span><br><span class="line">    searchSourceBuilder.size(Math.toIntExact(size));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// highlight</span></span><br><span class="line">    HighlightBuilder highlightBuilder = <span class="keyword">new</span> HighlightBuilder();</span><br><span class="line">    highlightBuilder.field(<span class="string">&quot;title&quot;</span>); <span class="comment">// titleå­—æ®µé«˜äº®</span></span><br><span class="line">    highlightBuilder.requireFieldMatch(<span class="keyword">false</span>); <span class="comment">// å…³é”®å­—é«˜äº®ä¸€æ¬¡</span></span><br><span class="line">    highlightBuilder.preTags(<span class="string">&quot;&lt;span style=&#x27;color:red&#x27;&gt;&quot;</span>);</span><br><span class="line">    highlightBuilder.postTags(<span class="string">&quot;&lt;/span&gt;&quot;</span>);</span><br><span class="line">    searchSourceBuilder.highlighter(highlightBuilder);</span><br><span class="line"></span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">    ArrayList&lt;Map&lt;String, Object&gt;&gt; objects = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    SearchResponse searchResponse = restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : searchResponse.getHits().getHits()) &#123;</span><br><span class="line">        <span class="comment">// æŸ¥è¯¢ç»“æœ</span></span><br><span class="line">        Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†é«˜äº®çš„å­—æ®µè¦†ç›–æŸ¥è¯¢ç»“æœçš„è¯¥å­—æ®µ</span></span><br><span class="line">        HighlightField highlightField = hit.getHighlightFields().get(<span class="string">&quot;title&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (highlightField != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Text[] fragments = highlightField.fragments();</span><br><span class="line">            StringBuilder s = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="keyword">for</span> (Text fragment : fragments) &#123;</span><br><span class="line">                s.append(fragment);</span><br><span class="line">            &#125;</span><br><span class="line">            sourceAsMap.put(<span class="string">&quot;title&quot;</span>, s.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        objects.add(sourceAsMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> objects;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20201020213945227.png" alt="image-20201020213945227"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;img src=&quot;&quot; alt=&quot;ä¸‹è½½&quot;&gt;&lt;/p&gt;
&lt;h1 id=&quot;å£°æ˜&quot;&gt;&lt;a href=&quot;#å£°æ˜&quot; class=&quot;headerlink&quot; title=&quot;å£°æ˜&quot;&gt;&lt;/a&gt;å£°æ˜&lt;/h1&gt;&lt;p&gt;æ­¤æ–‡ç« æ˜¯upä¸»-&lt;strong&gt;é‡è§ç‹‚ç¥è¯´&lt;/strong&gt;çš„èµ„æ–™ï¼Œå°†ä»–çš„èµ„æ–™æ‹‰å–</summary>
      
    
    
    
    <category term="å…¨æ–‡æœç´¢" scheme="https://awslzhang.top/categories/%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2/"/>
    
    
    <category term="ElasticSearch" scheme="https://awslzhang.top/tags/ElasticSearch/"/>
    
  </entry>
  
  <entry>
    <title>IDEAæ‰“åŒ…è„šæœ¬é—®é¢˜</title>
    <link href="https://awslzhang.top/2020/09/21/IDEA%E6%89%93%E5%8C%85%E8%84%9A%E6%9C%AC%E9%97%AE%E9%A2%98/"/>
    <id>https://awslzhang.top/2020/09/21/IDEA%E6%89%93%E5%8C%85%E8%84%9A%E6%9C%AC%E9%97%AE%E9%A2%98/</id>
    <published>2020-09-21T13:34:43.000Z</published>
    <updated>2021-01-01T05:49:59.943Z</updated>
    
    <content type="html"><![CDATA[<h1 id="é—®é¢˜æè¿°"><a href="#é—®é¢˜æè¿°" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h1><p><strong>shellè„šæœ¬æ‰§è¡Œé”™è¯¯ $â€™\râ€™:command not found</strong></p><p>è¿™æ˜¯åœ¨IDEAæ‰“åŒ…çš„è„šæœ¬ä¸­ï¼Œç§»åŠ¨åˆ°Linuxï¼Œè§£å‹ï¼Œæ‰§è¡Œè„šæœ¬æ—¶å‡ºç°çš„é”™è¯¯</p><h1 id="å‡ºç°åŸå› ä»¥åŠè§£å†³"><a href="#å‡ºç°åŸå› ä»¥åŠè§£å†³" class="headerlink" title="å‡ºç°åŸå› ä»¥åŠè§£å†³"></a>å‡ºç°åŸå› ä»¥åŠè§£å†³</h1><p>åœ¨æ–‡ä»¶ä¸­ä»»ä½•æ ·å¼éƒ½æ˜¯ç”¨å­—èŠ‚ä½“ç°çš„ï¼Œä¾‹å¦‚æ¢è¡Œï¼š</p><ul><li>åœ¨windowä¸­ï¼šå›è½¦+æ¢è¡Œ CRLF</li><li>åœ¨Linuxä¸­ï¼šæ¢è¡Œï¼šLF</li><li>è€ç‰ˆMacä¸­ï¼šå›è½¦ï¼šCRï¼Œä¹‹åä¹Ÿæ˜¯LF</li></ul><p>windowä¸‹å¼€å‘æœ‰ä¸€ä¸ªå¤§å‘ï¼Œå°±æ˜¯æ¢è¡Œé»˜è®¤æ˜¯<code>CRLF</code>ï¼Œä¹Ÿå°±æ˜¯å›è½¦æ¢è¡Œï¼Œä½†æ˜¯Linuxä¸‹åªæœ‰æ¢è¡Œ<code>LF</code>ï¼Œè¿™æ ·ä»£ç æäº¤åï¼Œä¼šå‡ºç°ç¼–è¯‘é—®é¢˜ï¼Œ<strong>æ‰€ä»¥æœ€å¥½çš„åŠæ³•æ˜¯åœ¨IntelliJä¸‹è®¾ç½®é»˜è®¤ä¸ºLF</strong>ã€‚é¦–å…ˆæˆ‘ä»¬å…ˆä»‹ç»CRLFï¼ŒLFå’ŒCRè¿™ä¸‰ç§ä¸œè¥¿ï¼ŒCRæ˜¯MACè€ç‰ˆæœ¬çš„åšæ³•ï¼Œå°±æ˜¯å›è½¦ï¼Œä½†æ˜¯åæ¥çš„MACç³»ç»Ÿç»Ÿä¸€æ¢æˆLFäº†ï¼ŒLFæ˜¯Linuxä¸‹çš„åšæ³•ï¼Œå°±æ˜¯æ¢è¡Œï¼Œè¿™ä¸ªåšæ³•æ¯”è¾ƒè‡ªç„¶ï¼Œä¸ºä»€ä¹ˆè¦å›è½¦æ¢è¡Œå‘¢ï¼Œ<strong>æ˜¯å§ã€‚å¾®è½¯é‡‡ç”¨çš„æ˜¯CRLFï¼Œçœ‹ä¸Šå»å¥½åƒæ˜¯å…¼å®¹äº†CRå’ŒLFï¼Œä½†æ˜¯å®é™…å®Œå…¨ä¸æ˜¯é‚£ä¹ˆå›äº‹ï¼Œå°±æ˜¯å›è½¦å¹¶æ¢è¡Œï¼Œå¥½é¸¡è‚‹å•Šï¼Œå¾®è½¯ä¸€ç›´ä¿æŒè¿™ç§åšæ³•</strong>ï¼Œå¼€å‘äººå‘˜å¤§å¤šåœ¨Linuxä¸‹ï¼Œæ‰€ä»¥å¯¹äºå¼€å‘äººå‘˜æ¥è¯´è¿˜æ˜¯æ¯”è¾ƒå‘çš„ã€‚ä¸‹é¢ä»‹ç»è®¾ç½®è¯¦è§£ï¼š</p><h2 id="File-gt-Settingsâ€¦"><a href="#File-gt-Settingsâ€¦" class="headerlink" title="File-&gt;Settingsâ€¦"></a>File-&gt;Settingsâ€¦</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/AGPaNgg.png" alt="AGPaNgg"></p><h2 id="Editor-gt-Code-Style"><a href="#Editor-gt-Code-Style" class="headerlink" title="Editor-&gt;Code Style"></a>Editor-&gt;Code Style</h2><p>å¯ä»¥çœ‹åˆ°ï¼Œé»˜è®¤æ˜¯System-Dependentï¼Œè¿™ä¸ªå…¶å®è¿˜æ˜¯å¾ˆç‰›å‰çš„ï¼Œæ ¹æ®ç³»ç»Ÿè‡ªåŠ¨é…ç½®ï¼Œä½†æ˜¯ä½ æ˜¯windowsç³»ç»Ÿï¼Œé»˜è®¤æ˜¯CRLFï¼ŒæœåŠ¡å™¨æ˜¯Linuxï¼Œä½ å°±å¾—è‡ªå·±æ¢äº†ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/JOQ6jZ4.png" alt="JOQ6jZ4"></p><p>æˆ‘ä»¬è®¾ç½®æˆä¸‹é¢è¿™æ ·ï¼Œä¿å­˜å°±å¥½äº†</p><p><strong>è¿™æ ·è®¾ç½®æ˜¯ä¹‹åæ–°å»ºçš„æ–‡ä»¶æœ‰æ•ˆæœ</strong></p><h2 id="ä¹‹å‰æ–‡ä»¶æœ‰æ•ˆ"><a href="#ä¹‹å‰æ–‡ä»¶æœ‰æ•ˆ" class="headerlink" title="ä¹‹å‰æ–‡ä»¶æœ‰æ•ˆ"></a>ä¹‹å‰æ–‡ä»¶æœ‰æ•ˆ</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/826328-20200409110931988-1979119311.png" alt="826328-20200409110931988-1979119311"></p><p><strong>File -&gt; Line Separators -&gt; LF</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/826328-20200409110953545-1889327721.png" alt="826328-20200409110953545-1889327721"></p><h1 id="å¤„ç†æ–¹å¼äºŒ"><a href="#å¤„ç†æ–¹å¼äºŒ" class="headerlink" title="å¤„ç†æ–¹å¼äºŒ"></a>å¤„ç†æ–¹å¼äºŒ</h1><p>é€šè¿‡ä¸€ä¸ªLinuxå‘½ä»¤ï¼Œå°†windowæ¢è¡Œç¬¦å˜ä¸ºLinuxæ¢è¡Œç¬¦</p><p><code>dos2unix  è„šæœ¬å</code></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;é—®é¢˜æè¿°&quot;&gt;&lt;a href=&quot;#é—®é¢˜æè¿°&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜æè¿°&quot;&gt;&lt;/a&gt;é—®é¢˜æè¿°&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;shellè„šæœ¬æ‰§è¡Œé”™è¯¯ $â€™\râ€™:command not found&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;è¿™æ˜¯</summary>
      
    
    
    
    
    <category term="IDEA" scheme="https://awslzhang.top/tags/IDEA/"/>
    
  </entry>
  
  <entry>
    <title>sparkå­¦ä¹ ç¬”è®°-SparkCoreè§£æ</title>
    <link href="https://awslzhang.top/2020/08/29/spark%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-SparkCore%E8%A7%A3%E6%9E%90/"/>
    <id>https://awslzhang.top/2020/08/29/spark%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-SparkCore%E8%A7%A3%E6%9E%90/</id>
    <published>2020-08-29T13:41:20.000Z</published>
    <updated>2021-01-01T05:50:00.043Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Spark-å†…æ ¸æ¦‚è¿°"><a href="#Spark-å†…æ ¸æ¦‚è¿°" class="headerlink" title="Spark å†…æ ¸æ¦‚è¿°"></a>Spark å†…æ ¸æ¦‚è¿°</h1><p>Sparkå†…æ ¸æ³›æŒ‡Sparkçš„æ ¸å¿ƒè¿è¡Œæœºåˆ¶ï¼ŒåŒ…æ‹¬<strong>Sparkæ ¸å¿ƒç»„ä»¶çš„è¿è¡Œæœºåˆ¶ã€Sparkä»»åŠ¡è°ƒåº¦æœºåˆ¶ã€Sparkå†…å­˜ç®¡ç†æœºåˆ¶ã€Sparkæ ¸å¿ƒåŠŸèƒ½çš„è¿è¡ŒåŸç†</strong>ç­‰ï¼Œç†Ÿç»ƒæŒæ¡Sparkå†…æ ¸åŸç†ï¼Œèƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°å®ŒæˆSparkä»£ç è®¾è®¡ï¼Œå¹¶èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å‡†ç¡®é”å®šé¡¹ç›®è¿è¡Œè¿‡ç¨‹ä¸­å‡ºç°çš„é—®é¢˜çš„ç—‡ç»“æ‰€åœ¨ã€‚</p><h2 id="Sparkæ ¸å¿ƒç»„ä»¶å›é¡¾"><a href="#Sparkæ ¸å¿ƒç»„ä»¶å›é¡¾" class="headerlink" title="Sparkæ ¸å¿ƒç»„ä»¶å›é¡¾"></a>Sparkæ ¸å¿ƒç»„ä»¶å›é¡¾</h2><h3 id="Driver"><a href="#Driver" class="headerlink" title="Driver"></a>Driver</h3><p><strong>Sparké©±åŠ¨å™¨èŠ‚ç‚¹</strong>ï¼Œç”¨äºæ‰§è¡ŒSparkä»»åŠ¡ä¸­çš„<strong>main</strong>æ–¹æ³•ï¼Œè´Ÿè´£å®é™…ä»£ç çš„æ‰§è¡Œå·¥ä½œã€‚Driveråœ¨Sparkä½œä¸šæ‰§è¡Œæ—¶ä¸»è¦è´Ÿè´£ï¼š</p><ol><li>å°†ç”¨æˆ·ç¨‹åºè½¬åŒ–ä¸ºä½œä¸šï¼ˆjobï¼‰ï¼›</li><li>åœ¨Executorä¹‹é—´è°ƒåº¦ä»»åŠ¡(task)ï¼›</li><li>è·Ÿè¸ªExecutorçš„æ‰§è¡Œæƒ…å†µï¼›</li><li>é€šè¿‡UIå±•ç¤ºæŸ¥è¯¢è¿è¡Œæƒ…å†µï¼›</li></ol><h3 id="Executor"><a href="#Executor" class="headerlink" title="Executor"></a>Executor</h3><p>Spark ExecutorèŠ‚ç‚¹æ˜¯ä¸€ä¸ªJVMè¿›ç¨‹ï¼Œè´Ÿè´£åœ¨ Spark ä½œä¸šä¸­è¿è¡Œå…·ä½“ä»»åŠ¡ï¼Œä»»åŠ¡å½¼æ­¤ä¹‹é—´ç›¸äº’ç‹¬ç«‹ã€‚Spark åº”ç”¨å¯åŠ¨æ—¶ï¼ŒExecutorèŠ‚ç‚¹è¢«åŒæ—¶å¯åŠ¨ï¼Œå¹¶ä¸”å§‹ç»ˆä¼´éšç€æ•´ä¸ª Spark åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸè€Œå­˜åœ¨ã€‚å¦‚æœæœ‰ExecutorèŠ‚ç‚¹å‘ç”Ÿäº†æ•…éšœæˆ–å´©æºƒï¼ŒSpark åº”ç”¨ä¹Ÿå¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œä¼šå°†å‡ºé”™èŠ‚ç‚¹ä¸Šçš„ä»»åŠ¡è°ƒåº¦åˆ°å…¶ä»–ExecutorèŠ‚ç‚¹ä¸Šç»§ç»­è¿è¡Œã€‚</p><p>Executoræœ‰ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š</p><ol><li>è´Ÿè´£<strong>è¿è¡Œç»„æˆSparkåº”ç”¨çš„ä»»åŠ¡</strong>ï¼Œå¹¶å°†ç»“æœè¿”å›ç»™é©±åŠ¨å™¨è¿›ç¨‹ï¼›</li><li>å®ƒä»¬é€šè¿‡è‡ªèº«çš„å—ç®¡ç†å™¨ï¼ˆBlock Managerï¼‰ä¸ºç”¨æˆ·ç¨‹åºä¸­è¦æ±‚ç¼“å­˜çš„ RDD æä¾›å†…å­˜å¼å­˜å‚¨ã€‚<strong>RDD æ˜¯ç›´æ¥ç¼“å­˜åœ¨Executorè¿›ç¨‹å†…çš„</strong>ï¼Œå› æ­¤ä»»åŠ¡å¯ä»¥åœ¨è¿è¡Œæ—¶å……åˆ†åˆ©ç”¨ç¼“å­˜æ•°æ®åŠ é€Ÿè¿ç®—ã€‚</li></ol><h2 id="Sparké€šç”¨è¿è¡Œæµç¨‹æ¦‚è¿°"><a href="#Sparké€šç”¨è¿è¡Œæµç¨‹æ¦‚è¿°" class="headerlink" title="Sparké€šç”¨è¿è¡Œæµç¨‹æ¦‚è¿°"></a>Sparké€šç”¨è¿è¡Œæµç¨‹æ¦‚è¿°</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830151813147.png" alt="image-20200830151813147"></p><p>å›¾1-1ä¸ºSparké€šç”¨è¿è¡Œæµç¨‹ï¼Œ<strong>ä¸è®ºSparkä»¥ä½•ç§æ¨¡å¼è¿›è¡Œéƒ¨ç½²ï¼Œä»»åŠ¡æäº¤åï¼Œéƒ½ä¼šå…ˆå¯åŠ¨Driverè¿›ç¨‹</strong>ï¼ŒéšåDriverè¿›ç¨‹å‘é›†ç¾¤ç®¡ç†å™¨æ³¨å†Œåº”ç”¨ç¨‹åºï¼Œä¹‹åé›†ç¾¤ç®¡ç†å™¨æ ¹æ®æ­¤ä»»åŠ¡çš„é…ç½®æ–‡ä»¶åˆ†é…Executorå¹¶å¯åŠ¨ï¼Œå½“Driveræ‰€éœ€çš„èµ„æºå…¨éƒ¨æ»¡è¶³åï¼Œ<strong>Driverå¼€å§‹æ‰§è¡Œmainå‡½æ•°ï¼ŒSparkæŸ¥è¯¢ä¸ºæ‡’æ‰§è¡Œï¼Œå½“æ‰§è¡Œåˆ°actionç®—å­æ—¶å¼€å§‹åå‘æ¨ç®—</strong>ï¼Œ<font color="red">æ ¹æ®å®½ä¾èµ–è¿›è¡Œstageçš„åˆ’åˆ†ï¼Œéšåæ¯ä¸€ä¸ªstageå¯¹åº”ä¸€ä¸ªtasksetï¼Œtasksetä¸­æœ‰å¤šä¸ªtaskï¼Œæ ¹æ®æœ¬åœ°åŒ–åŸåˆ™ï¼Œtaskä¼šè¢«åˆ†å‘åˆ°æŒ‡å®šçš„Executorå»æ‰§è¡Œ</font>ï¼Œåœ¨ä»»åŠ¡æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼ŒExecutorä¹Ÿä¼šä¸æ–­ä¸Driverè¿›è¡Œé€šä¿¡ï¼ŒæŠ¥å‘Šä»»åŠ¡è¿è¡Œæƒ…å†µã€‚</p><h1 id="Sparkéƒ¨ç½²æ¨¡å¼"><a href="#Sparkéƒ¨ç½²æ¨¡å¼" class="headerlink" title="Sparkéƒ¨ç½²æ¨¡å¼"></a>Sparkéƒ¨ç½²æ¨¡å¼</h1><p>Sparkæ”¯æŒ3ç§é›†ç¾¤ç®¡ç†å™¨ï¼ˆCluster Managerï¼‰ï¼Œåˆ†åˆ«ä¸ºï¼š</p><ol><li><code>Standaloneï¼š</code>ç‹¬ç«‹æ¨¡å¼ï¼ŒSparkåŸç”Ÿçš„ç®€å•é›†ç¾¤ç®¡ç†å™¨ï¼Œè‡ªå¸¦å®Œæ•´çš„æœåŠ¡ï¼Œå¯å•ç‹¬éƒ¨ç½²åˆ°ä¸€ä¸ªé›†ç¾¤ä¸­ï¼Œ<strong>æ— éœ€ä¾èµ–ä»»ä½•å…¶ä»–èµ„æºç®¡ç†ç³»ç»Ÿ</strong>ï¼Œä½¿ç”¨Standaloneå¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ­å»ºä¸€ä¸ªé›†ç¾¤ï¼›</li><li><code>Apache Mesosï¼š</code>ä¸€ä¸ªå¼ºå¤§çš„åˆ†å¸ƒå¼èµ„æºç®¡ç†æ¡†æ¶ï¼Œå®ƒå…è®¸å¤šç§ä¸åŒçš„æ¡†æ¶éƒ¨ç½²åœ¨å…¶ä¸Šï¼ŒåŒ…æ‹¬yarnï¼›</li><li><code>Hadoop YARNï¼š</code>ç»Ÿä¸€çš„èµ„æºç®¡ç†æœºåˆ¶ï¼Œåœ¨ä¸Šé¢å¯ä»¥è¿è¡Œå¤šå¥—è®¡ç®—æ¡†æ¶ï¼Œå¦‚map reduceã€stormç­‰ï¼Œ<font color="red">æ ¹æ®driveråœ¨é›†ç¾¤ä¸­çš„ä½ç½®ä¸åŒï¼Œåˆ†ä¸ºyarn clientå’Œyarn cluster</font>ã€‚</li></ol><p>å®é™…ä¸Šï¼Œé™¤äº†ä¸Šè¿°è¿™äº›é€šç”¨çš„é›†ç¾¤ç®¡ç†å™¨å¤–ï¼ŒSparkå†…éƒ¨ä¹Ÿæä¾›äº†ä¸€äº›æ–¹ä¾¿ç”¨æˆ·æµ‹è¯•å’Œå­¦ä¹ çš„ç®€å•é›†ç¾¤éƒ¨ç½²æ¨¡å¼ã€‚<font color="red"><strong>ç”±äºåœ¨å®é™…å·¥å‚ç¯å¢ƒä¸‹ä½¿ç”¨çš„ç»å¤§å¤šæ•°çš„é›†ç¾¤ç®¡ç†å™¨æ˜¯Hadoop YARNï¼Œå› æ­¤æˆ‘ä»¬å…³æ³¨çš„é‡ç‚¹æ˜¯Hadoop YARNæ¨¡å¼ä¸‹çš„Sparké›†ç¾¤éƒ¨ç½²ã€‚</strong></font></p><p>Sparkçš„è¿è¡Œæ¨¡å¼å–å†³äºä¼ é€’ç»™<code>SparkContext</code>çš„<font color="red"><code>MASTER</code>ç¯å¢ƒå˜é‡çš„å€¼</font>ï¼Œä¸ªåˆ«æ¨¡å¼è¿˜éœ€è¦è¾…åŠ©çš„ç¨‹åºæ¥å£æ¥é…åˆä½¿ç”¨ï¼Œç›®å‰æ”¯æŒçš„Masterå­—ç¬¦ä¸²åŠURLåŒ…æ‹¬ï¼š</p><table><thead><tr><th><strong>Master URL</strong></th><th><strong>Meaning</strong></th></tr></thead><tbody><tr><td><strong>local</strong></td><td>åœ¨æœ¬åœ°è¿è¡Œï¼Œåªæœ‰ä¸€ä¸ªå·¥ä½œè¿›ç¨‹ï¼Œæ— å¹¶è¡Œè®¡ç®—èƒ½åŠ›ã€‚</td></tr><tr><td><strong>local[K]</strong></td><td>åœ¨æœ¬åœ°è¿è¡Œï¼Œæœ‰Kä¸ªå·¥ä½œè¿›ç¨‹ï¼Œé€šå¸¸è®¾ç½®Kä¸ºæœºå™¨çš„CPUæ ¸å¿ƒæ•°é‡ã€‚</td></tr><tr><td><strong>local[*]</strong></td><td>åœ¨æœ¬åœ°è¿è¡Œï¼Œå·¥ä½œè¿›ç¨‹æ•°é‡ç­‰äºæœºå™¨çš„CPUæ ¸å¿ƒæ•°é‡ã€‚</td></tr><tr><td><strong>spark://HOST:PORT</strong></td><td>ä»¥Standaloneæ¨¡å¼è¿è¡Œï¼Œè¿™æ˜¯Sparkè‡ªèº«æä¾›çš„é›†ç¾¤è¿è¡Œæ¨¡å¼ï¼Œé»˜è®¤ç«¯å£å·: 7077ã€‚è¯¦ç»†æ–‡æ¡£è§:Spark  standalone clusterã€‚</td></tr><tr><td><strong>mesos://HOST:PORT</strong></td><td>åœ¨Mesosé›†ç¾¤ä¸Šè¿è¡Œï¼ŒDriverè¿›ç¨‹å’ŒWorkerè¿›ç¨‹è¿è¡Œåœ¨Mesosé›†ç¾¤ä¸Šï¼Œéƒ¨ç½²æ¨¡å¼å¿…é¡»ä½¿ç”¨å›ºå®šå€¼:â€“deploy-mode clusterã€‚è¯¦ç»†æ–‡æ¡£è§:MesosClusterDispatcher.</td></tr><tr><td><strong>yarn-client</strong></td><td>åœ¨Yarné›†ç¾¤ä¸Šè¿è¡Œï¼ŒDriverè¿›ç¨‹åœ¨æœ¬åœ°ï¼ŒExecutorè¿›ç¨‹åœ¨Yarné›†ç¾¤ä¸Šï¼Œéƒ¨ç½²æ¨¡å¼å¿…é¡»ä½¿ç”¨å›ºå®šå€¼:â€“deploy-mode  clientã€‚Yarné›†ç¾¤åœ°å€å¿…é¡»åœ¨HADOOP_CONF_DIR or YARN_CONF_DIRå˜é‡é‡Œå®šä¹‰ã€‚</td></tr><tr><td><strong>yarn-cluster</strong></td><td>åœ¨Yarné›†ç¾¤ä¸Šè¿è¡Œï¼ŒDriverè¿›ç¨‹åœ¨Yarné›†ç¾¤ä¸Šï¼ŒWorkè¿›ç¨‹ä¹Ÿåœ¨Yarné›†ç¾¤ä¸Šï¼Œéƒ¨ç½²æ¨¡å¼å¿…é¡»ä½¿ç”¨å›ºå®šå€¼:â€“deploy-mode clusterã€‚Yarné›†ç¾¤åœ°å€å¿…é¡»åœ¨HADOOP_CONF_DIR  or YARN_CONF_DIRå˜é‡é‡Œå®šä¹‰ã€‚</td></tr></tbody></table><p><strong>ç”¨æˆ·åœ¨æäº¤ä»»åŠ¡ç»™Sparkå¤„ç†æ—¶ï¼Œä»¥ä¸‹ä¸¤ä¸ªå‚æ•°å…±åŒå†³å®šäº†Sparkçš„è¿è¡Œæ–¹å¼ã€‚</strong></p><ul><li><code>master MASTER_URL</code> ï¼šå†³å®šäº†Sparkä»»åŠ¡æäº¤<font color="red">ç»™å“ªç§é›†ç¾¤å¤„ç†ã€‚</font></li><li><code>deploy-mode DEPLOY_MODE</code>ï¼šå†³å®šäº†Driverçš„è¿è¡Œæ–¹å¼ï¼Œ<font color="red">å¯é€‰å€¼ä¸ºClientæˆ–è€…Clusterã€‚</font></li></ul><h2 id="Standaloneæ¨¡å¼è¿è¡Œæœºåˆ¶"><a href="#Standaloneæ¨¡å¼è¿è¡Œæœºåˆ¶" class="headerlink" title="Standaloneæ¨¡å¼è¿è¡Œæœºåˆ¶"></a>Standaloneæ¨¡å¼è¿è¡Œæœºåˆ¶</h2><p>Standaloneé›†ç¾¤æœ‰<strong>å››ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†</strong>ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ol><li><code>Driver</code>ï¼šæ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œæˆ‘ä»¬<strong>ç¼–å†™çš„Sparkåº”ç”¨ç¨‹åºå°±è¿è¡Œåœ¨Driverä¸Š</strong>ï¼Œç”±Driverè¿›ç¨‹æ‰§è¡Œï¼›</li><li><code>Master(RM)</code>ï¼šæ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œ<strong>ä¸»è¦è´Ÿè´£èµ„æºçš„è°ƒåº¦å’Œåˆ†é…</strong>ï¼Œå¹¶è¿›è¡Œé›†ç¾¤çš„ç›‘æ§ç­‰èŒè´£ï¼›</li><li><code>Worker(NM)</code>ï¼šæ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œä¸€ä¸ªWorkerè¿è¡Œåœ¨é›†ç¾¤ä¸­çš„ä¸€å°æœåŠ¡å™¨ä¸Šï¼Œä¸»è¦è´Ÿè´£ä¸¤ä¸ªèŒè´£ï¼Œä¸€ä¸ªæ˜¯ç”¨è‡ªå·±çš„å†…å­˜å­˜å‚¨RDDçš„æŸä¸ªæˆ–æŸäº›partitionï¼›å¦ä¸€ä¸ªæ˜¯å¯åŠ¨å…¶ä»–è¿›ç¨‹å’Œçº¿ç¨‹ï¼ˆExecutorï¼‰ï¼Œå¯¹RDDä¸Šçš„partitionè¿›è¡Œå¹¶è¡Œçš„å¤„ç†å’Œè®¡ç®—ã€‚</li><li><code>Executor</code>ï¼šæ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œä¸€ä¸ªWorkerä¸Šå¯ä»¥è¿è¡Œå¤šä¸ªExecutorï¼ŒExecutoré€šè¿‡å¯åŠ¨å¤šä¸ªçº¿ç¨‹ï¼ˆtaskï¼‰æ¥æ‰§è¡Œå¯¹RDDçš„partitionè¿›è¡Œå¹¶è¡Œè®¡ç®—ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œæˆ‘ä»¬å¯¹RDDå®šä¹‰çš„ä¾‹å¦‚mapã€flatMapã€reduceç­‰ç®—å­æ“ä½œã€‚</li></ol><h3 id="Standalone-Clientæ¨¡å¼"><a href="#Standalone-Clientæ¨¡å¼" class="headerlink" title="Standalone Clientæ¨¡å¼"></a>Standalone Clientæ¨¡å¼</h3><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830152737351.png" alt="image-20200830152737351"></p><p>åœ¨Standalone Clientæ¨¡å¼ä¸‹ï¼Œ<font color="red"><strong>Driveråœ¨ä»»åŠ¡æäº¤çš„æœ¬åœ°æœºå™¨ä¸Šè¿è¡Œ</strong></font>ï¼š</p><ol><li>Driverå¯åŠ¨ä¼šå‘Masteræ³¨å†Œåº”ç”¨ç¨‹åº</li><li>Masteræ ¹æ®submitè„šæœ¬çš„èµ„æºéœ€æ±‚æ‰¾åˆ°å†…éƒ¨èµ„æºè‡³å°‘å¯ä»¥å¯åŠ¨ä¸€ä¸ªExecutorçš„æ‰€æœ‰Worker</li><li>Workerä¹‹é—´åˆ†é…Executor</li><li>Executorå¼€å¯å®Œæ¯•åå‘Driveråé¦ˆ</li><li><font color="red">Driverå¼€å§‹æ‰§è¡Œmainå‡½æ•°ï¼Œä¹‹åæ‰§è¡Œåˆ°Actionç®—å­æ—¶ï¼Œå¼€å§‹åˆ’åˆ†stageï¼Œæ¯ä¸ªstageç”Ÿæˆå¯¹åº”çš„taskSetï¼Œä¹‹åå°†taskåˆ†å‘åˆ°å„ä¸ªExecutorä¸Šæ‰§è¡Œã€‚</font></li></ol><h3 id="Standalone-Clusteræ¨¡å¼"><a href="#Standalone-Clusteræ¨¡å¼" class="headerlink" title="Standalone Clusteræ¨¡å¼"></a>Standalone Clusteræ¨¡å¼</h3><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830154509558.png" alt="image-20200830154509558"></p><p>åœ¨Standalone Clusteræ¨¡å¼ä¸‹ï¼Œ<font color="red"><strong>ä»»åŠ¡æäº¤åï¼ŒMasterä¼šæ‰¾åˆ°ä¸€ä¸ªWorkerå¯åŠ¨Driverè¿›ç¨‹</strong></font></p><ol><li>Driverå¯åŠ¨ä¼šå‘Masteræ³¨å†Œåº”ç”¨ç¨‹åº</li><li>Masteræ ¹æ®submitè„šæœ¬çš„èµ„æºéœ€æ±‚æ‰¾åˆ°å†…éƒ¨èµ„æºè‡³å°‘å¯ä»¥å¯åŠ¨ä¸€ä¸ªExecutorçš„æ‰€æœ‰Worker</li><li>Workerä¹‹é—´åˆ†é…Executor</li><li>Executorå¼€å¯å®Œæ¯•åå‘Driveråé¦ˆ</li><li><font color="red">Driverå¼€å§‹æ‰§è¡Œmainå‡½æ•°ï¼Œä¹‹åæ‰§è¡Œåˆ°Actionç®—å­æ—¶ï¼Œå¼€å§‹åˆ’åˆ†stageï¼Œæ¯ä¸ªstageç”Ÿæˆå¯¹åº”çš„taskSetï¼Œä¹‹åå°†taskåˆ†å‘åˆ°å„ä¸ªExecutorä¸Šæ‰§è¡Œã€‚</font></li></ol><h2 id="Yarnæ¨¡å¼è¿è¡Œæœºåˆ¶ğŸ”º"><a href="#Yarnæ¨¡å¼è¿è¡Œæœºåˆ¶ğŸ”º" class="headerlink" title="Yarnæ¨¡å¼è¿è¡Œæœºåˆ¶ğŸ”º"></a>Yarnæ¨¡å¼è¿è¡Œæœºåˆ¶ğŸ”º</h2><h3 id="YARN-Clientæ¨¡å¼"><a href="#YARN-Clientæ¨¡å¼" class="headerlink" title="YARN Clientæ¨¡å¼"></a>YARN Clientæ¨¡å¼</h3><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830155921502.png" alt="image-20200830155921502"></p><p>åœ¨YARN Clientæ¨¡å¼ä¸‹ï¼Œ<font color="red"><strong>Driveråœ¨ä»»åŠ¡æäº¤çš„æœ¬åœ°æœºå™¨ä¸Šè¿è¡Œ</strong></font></p><ol><li>Driverå¯åŠ¨åä¼šå’ŒResourceManageré€šè®¯ç”³è¯·å¯åŠ¨ApplicationMaster</li><li>ResourceManageråˆ†é…containerï¼Œåœ¨åˆé€‚çš„NodeManagerä¸Šå¯åŠ¨ApplicationMaster</li><li>ApplicationMasterçš„åŠŸèƒ½ç›¸å½“äºä¸€ä¸ª<font color="red"><code>ExecutorLaucher</code></font>ï¼Œåªè´Ÿè´£å‘ResourceManagerç”³è¯·Executorå†…å­˜ã€‚</li><li>ResourceManageræ¥åˆ°ApplicationMasterçš„èµ„æºç”³è¯·åä¼šåˆ†é…containerï¼Œç„¶åApplicationMasteråœ¨èµ„æºåˆ†é…æŒ‡å®šçš„NodeManagerä¸Šå¯åŠ¨Executorè¿›ç¨‹</li><li><font color="red">Executorè¿›ç¨‹å¯åŠ¨åä¼šå‘Driveråå‘æ³¨å†Œ</font></li><li>Driverå¼€å§‹æ‰§è¡Œmainå‡½æ•°ï¼Œä¹‹åæ‰§è¡Œåˆ°Actionç®—å­æ—¶ï¼Œè§¦å‘ä¸€ä¸ªjobï¼Œå¹¶æ ¹æ®å®½ä¾èµ–å¼€å§‹åˆ’åˆ†stageï¼Œæ¯ä¸ªstageç”Ÿæˆå¯¹åº”çš„taskSetï¼Œä¹‹åå°†taskåˆ†å‘åˆ°å„ä¸ªExecutorä¸Šæ‰§è¡Œã€‚</li></ol><h3 id="YARN-Clusteræ¨¡å¼ğŸ”º"><a href="#YARN-Clusteræ¨¡å¼ğŸ”º" class="headerlink" title="YARN Clusteræ¨¡å¼ğŸ”º"></a>YARN Clusteræ¨¡å¼ğŸ”º</h3><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830160157808.png" alt="image-20200830160157808"></p><p>åœ¨YARN Clusteræ¨¡å¼ä¸‹ï¼Œ<font color="red"><strong>ä»»åŠ¡æäº¤åä¼šå’ŒResourceManageré€šè®¯ç”³è¯·å¯åŠ¨ApplicationMaster</strong></font></p><ol><li>éšåResourceManageråˆ†é…containerï¼Œåœ¨åˆé€‚çš„NodeManagerä¸Šå¯åŠ¨ApplicationMasterï¼Œæ­¤æ—¶çš„ApplicationMasterå°±æ˜¯Driverã€‚</li><li>Driverå¯åŠ¨åå‘ResourceManagerç”³è¯·Executorå†…å­˜</li><li>ResourceManageræ¥åˆ°ApplicationMasterçš„èµ„æºç”³è¯·åä¼šåˆ†é…containerï¼Œç„¶ååœ¨åˆé€‚çš„NodeManagerä¸Šå¯åŠ¨Executorè¿›ç¨‹</li><li>Executorè¿›ç¨‹å¯åŠ¨åä¼šå‘Driveråå‘æ³¨å†Œ</li><li>Driverå¼€å§‹æ‰§è¡Œmainå‡½æ•°ï¼Œä¹‹åæ‰§è¡Œåˆ°Actionç®—å­æ—¶ï¼Œè§¦å‘ä¸€ä¸ªjobï¼Œå¹¶æ ¹æ®å®½ä¾èµ–å¼€å§‹åˆ’åˆ†stageï¼Œæ¯ä¸ªstageç”Ÿæˆå¯¹åº”çš„taskSetï¼Œä¹‹åå°†taskåˆ†å‘åˆ°å„ä¸ªExecutorä¸Šæ‰§è¡Œã€‚</li></ol><h1 id="YARN-Clusteræ¨¡å¼æºä»£ç è§£è¯»ğŸ”ºğŸ”º"><a href="#YARN-Clusteræ¨¡å¼æºä»£ç è§£è¯»ğŸ”ºğŸ”º" class="headerlink" title="YARN Clusteræ¨¡å¼æºä»£ç è§£è¯»ğŸ”ºğŸ”º"></a>YARN Clusteræ¨¡å¼æºä»£ç è§£è¯»ğŸ”ºğŸ”º</h1><h2 id="Spark-Submit"><a href="#Spark-Submit" class="headerlink" title="Spark Submit"></a>Spark Submit</h2><p><strong>1. YARN Clusterçš„è®¡ç®—ç”±å‘½ä»¤å¼€å§‹ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bin/spark-submit \</span><br><span class="line">--class org.apache.spark.examples.SparkPi \</span><br><span class="line">--executor-memory 1G \</span><br><span class="line">--total-executor-cores 2 \</span><br><span class="line">-- master MASTER_URL yarn\</span><br><span class="line">-- deploy-mode cluster \</span><br><span class="line">./examples/jars/spark-examples_2.11-2.1.1.jar \</span><br><span class="line">100</span><br></pre></td></tr></table></figure><p><em>è°ƒç”¨å‘½ä»¤çš„æœ¬è´¨å°±æ˜¯å¯åŠ¨äº†SparkSubmitçš„è¿›ç¨‹ï¼Œé€šè¿‡Javaå‘½ä»¤ï¼š</em></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830162407076.png" alt="image-20200830162407076"></p><p><font color="red"><em>æ‰€ä»¥ï¼Œå½“æ‰§è¡Œåï¼Œæ­¤èŠ‚ç‚¹ä¼šç«‹é©¬å¼€å¯äº†ä¸€ä¸ªè¿›ç¨‹ï¼š<code>SparkSubmit</code></em></font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830162517111.png" alt="image-20200830162517111"></p><h3 id="SparkSubmitArgumentså‚æ•°å°è£…"><a href="#SparkSubmitArgumentså‚æ•°å°è£…" class="headerlink" title="SparkSubmitArgumentså‚æ•°å°è£…"></a>SparkSubmitArgumentså‚æ•°å°è£…</h3><p>å› ä¸º<code>SparkSubmit</code>æ˜¯é€šè¿‡<code>java xxx</code>å‘½ä»¤æ‰§è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç›´æ¥æŸ¥çœ‹å®ƒçš„mainæ–¹æ³•ï¼š</p><p>å›¾ä¸­åœˆå‡ºçš„éƒ¨åˆ†æ˜¯ä»£ç çš„å‚æ•°éªŒè¯ï¼Œå®ƒé™åˆ¶äº†éƒ¨ç½²æ¨¡å¼å¿…é¡»æ˜¯<code>client</code>ã€<code>cluster</code>çš„ä¸€ç§</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830163439950.png" alt="image-20200830163439950"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830163544480.png" alt="image-20200830163544480"></p><h3 id="submitæäº¤"><a href="#submitæäº¤" class="headerlink" title="submitæäº¤"></a>submitæäº¤</h3><p>ä¹‹åå‚æ•°éªŒè¯å®Œæ¯•åï¼Œæ ¹æ®æäº¤çŠ¶æ€ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®šå®ƒæ‰§è¡Œäº†<code>case SparkSubmitAction.SUBMIT =&gt; submit(appArgs)</code></p><p>submitå‡½æ•°ä¸­åˆ†åˆ«è°ƒç”¨äº†ï¼š</p><ul><li><code>prepareSubmitEnvironment</code></li><li><code>doRunMain</code></li></ul><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830164234921.png" alt="image-20200830164234921"></p><h4 id="prepareSubmitEnvironmentæäº¤ç¯å¢ƒå‡†å¤‡"><a href="#prepareSubmitEnvironmentæäº¤ç¯å¢ƒå‡†å¤‡" class="headerlink" title="prepareSubmitEnvironmentæäº¤ç¯å¢ƒå‡†å¤‡"></a>prepareSubmitEnvironmentæäº¤ç¯å¢ƒå‡†å¤‡</h4><p>åœ¨<code>prepareSubmitEnvironment</code>æ–¹æ³•çš„æºä»£ç ä¸­æˆ‘ä»¬æ‰¾åˆ°äº†å…³é”®éƒ¨åˆ†</p><p>å‘ç°<code>prepareSubmitEnvironment</code>çš„è¿”å›å€¼<code>childMainClass</code>è¢«èµ‹å€¼ä¸ºäº†<font color="red">**<code>org.apache.spark.deploy.yarn.Client</code>**</font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830164713753.png" alt="image-20200830164713753"></p><h4 id="doRunMain"><a href="#doRunMain" class="headerlink" title="doRunMain"></a>doRunMain</h4><p>åœ¨è¿è¡Œ<code>doRunMain</code>æ–¹æ³•å†…éƒ¨æ—¶å°†<code>prepareSubmitEnvironment</code>æ–¹æ³•çš„è¿”å›å€¼<code>childMainClass</code>ä¼ å…¥äº†æ–°æ–¹æ³•<code>runMain</code>ï¼Œæ­¤æ—¶å®ƒçš„å€¼æ˜¯**<code>org.apache.spark.deploy.yarn.Client</code>**</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830165235145.png" alt="image-20200830165235145"></p><h5 id="runMain"><a href="#runMain" class="headerlink" title="runMain"></a>runMain</h5><p>å‘ç°æ­¤æ–¹æ³•å¯¹ä¼ å…¥çš„<code>childMainClass</code>å³ï¼š**<code>org.apache.spark.deploy.yarn.Client</code><strong>è¿›è¡Œäº†è¿”å›è·å–å®ä½“ç±»ï¼Œ<font color="red">**å¹¶ä¸”åˆ¤æ–­å®ƒçš„mainæ–¹æ³•ï¼Œå¹¶è°ƒç”¨ï¼ï¼ï¼</strong></font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830165939807.png" alt="image-20200830165939807"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830170053716.png" alt="image-20200830170053716"></p><h2 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h2><p>ä¸Šé¢è¯´åˆ°Spark Submitçš„mainæ–¹æ³•é‡Œé¢ä»¥åå°„è°ƒç”¨äº†<code>org.apache.spark.deploy.yarn.Client</code>çš„mainæ–¹æ³•ï¼Œä¸‹é¢å¼€å§‹æŸ¥çœ‹<code>org.apache.spark.deploy.yarn.Client</code>çš„mainæ–¹æ³•ã€‚</p><p>å‘ç°ï¼š</p><ol><li>æ‰§è¡Œäº†å‚æ•°å°è£…</li><li>å¼€å¯çº¿ç¨‹æ‰§è¡ŒClientçš„é€»è¾‘ï¼Œæ³¨æ„è¿™é‡Œä¸æ˜¯ä»¥javaå‘½ä»¤æ‰§è¡Œçš„ï¼Œæ‰€ä»¥ä¸ä¼šå¼€å¯è¿›ç¨‹ï¼Œè€Œæ˜¯ä»¥çº¿ç¨‹æ–¹å¼æ‰§è¡Œçš„ï¼Œåªä¼šå¼€å¯ä¸€ä¸ªçº¿ç¨‹ã€‚</li></ol><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830170750827.png" alt="image-20200830170750827"></p><h3 id="ClientArguments"><a href="#ClientArguments" class="headerlink" title="ClientArguments"></a>ClientArguments</h3><p>å‚æ•°å°è£…æ—¶ï¼Œå¯¹æˆ‘ä»¬æœ€å¼€å§‹sparksubmitæ—¶æŒ‡å®šçš„classè¿›è¡Œäº†å°è£…</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830170956395.png" alt="image-20200830170956395"></p><h3 id="run"><a href="#run" class="headerlink" title="run"></a>run</h3><p><code>new Client(args, sparkConf).run()</code>ï¼Œä»¥çº¿ç¨‹çš„æ–¹å¼è¿è¡Œäº†Clientçº¿ç¨‹çš„é€»è¾‘ã€‚</p><p>ä¸Šé¢å¯ä»¥åˆ†ä¸ºä¸¤ç§é€»è¾‘ï¼š</p><ol><li>new Client</li><li>client.run</li></ol><h4 id="new-Client"><a href="#new-Client" class="headerlink" title="new Client"></a>new Client</h4><p>æŸ¥çœ‹å®ƒçš„æ„é€ æ–¹æ³•ï¼Œå‘ç°å®ƒåˆ›å»ºäº†å¯¹è±¡<code>private val yarnClient = YarnClient.createYarnClient</code></p><p>å†æ¬¡æŸ¥çœ‹å¯¹è±¡<code>YarnClient</code>çš„å†…å®¹ï¼Œå‘ç°å®ƒæœ‰RMï¼ŒResourceManagerçš„åœ°å€ã€‚</p><p><font color="red"><strong>æ‰€ä»¥ï¼ŒClientç±»å¯ä»¥é€šè¿‡å¯¹è±¡<code>yarnClient </code>æ¥ä¸<code>ResourceManager</code>è¿›è¡Œäº¤äº’ã€‚</strong></font></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">ApplicationClientProtocol</span> rmClient;</span><br><span class="line">  <span class="keyword">protected</span> <span class="type">InetSocketAddress</span> rmAddress;</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830171947757.png" alt="image-20200830171947757"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830172001381.png" alt="image-20200830172001381"></p><h4 id="client-run"><a href="#client-run" class="headerlink" title="client.run"></a><strong>client.run</strong></h4><p>å‘ç°æ–¹æ³•<code>submitApplication</code>è¿”å›äº†appIdï¼ŒappIdæ˜¯Yarnä¸­çš„æ¦‚å¿µï¼Œæ˜¯ä¸€ä¸ªå”¯ä¸€IDï¼Œæ¯ä¸ªæ‰§è¡Œä»»åŠ¡å”¯ä¸€çš„å¯¹åº”ä¸€ä¸ªã€‚<font color="red">æ‰€ä»¥<code>submitApplication</code>æ˜¯ä¸€ä¸ªä¸Yarnäº¤äº’å¹¶è·å–åˆ°appIdçš„æ–¹æ³•ã€‚</font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830172804937.png" alt="image-20200830172804937"></p><p>ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»¥spark-shellçš„yarn clientæ¨¡å¼è¿è¡Œçš„å°±æœ‰appIdã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830173010937.png" alt="image-20200830173010937"></p><h5 id="submitApplicationğŸ”º"><a href="#submitApplicationğŸ”º" class="headerlink" title="submitApplicationğŸ”º"></a>submitApplicationğŸ”º</h5><p>[ä¸Šè¿°çš„yarnClient](#new Client)æ˜¯ä¸€ä¸ªä¿å­˜ç€RMåœ°å€çš„å¯¹è±¡ï¼Œå®ƒåœ¨submitApplicationæ–¹æ³•ä¸­å¼€å§‹å¯¹RMè¿›è¡Œäº†è¿æ¥ã€‚</p><ol><li>åŒæ—¶å‘RMè¿›è¡Œäº†èµ„æºçš„ç”³è¯·ï¼Œé€šè¿‡RMçš„åé¦ˆ<code>newAppResponse</code>å¾—åˆ°äº†Yarnçš„å”¯ä¸€id</li><li>æ„å»ºåº”ç”¨AMçš„æŒ‡ä»¤</li><li>ç”³è¯·RMæ‰§è¡Œåº”ç”¨ï¼ï¼ï¼</li></ol><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830173429640.png" alt="image-20200830173429640"></p><h6 id="createContainerLaunchContextğŸ”º"><a href="#createContainerLaunchContextğŸ”º" class="headerlink" title="createContainerLaunchContextğŸ”º"></a>createContainerLaunchContextğŸ”º</h6><p><font color="red"><strong>AMæ‰§è¡Œå°è£…æŒ‡ä»¤ï¼Œcommand</strong></font></p><p>æ­¤æ–¹æ³•æ˜¯<code>logInfo(&quot;Setting up container launch context for our AM&quot;)</code>ï¼Œå¯åŠ¨context for our AMçš„æŒ‡ä»¤å†…å®¹ã€‚</p><p>å‘ç°ï¼š</p><ol><li>clusteræ¨¡å¼æ„å»ºçš„Javaå‘½ä»¤å¯åŠ¨çš„æ˜¯<code>org.apache.spark.deploy.yarn.ApplicationMaster</code></li><li>clientæ¨¡å¼æ„å»ºçš„Javaå‘½ä»¤å¯åŠ¨çš„æ˜¯<code>org.apache.spark.deploy.yarn.ExecutorLauncher</code></li></ol><p><font color="red"><strong>æ³¨æ„ï¼šå› ä¸ºæ˜¯ä»¥Javaå‘½ä»¤é€šçŸ¥RMå¯åŠ¨çš„ï¼ŒRMä¼šå¯»æ‰¾ä¸€ä¸ªNMæ¥é€šè¿‡Javaå‘½ä»¤å¯åŠ¨ï¼Œæ‰€ä»¥ä»¥<code>ApplicationMaster</code>ä¸ºä¾‹ï¼Œå®ƒå¯åŠ¨çš„åº”è¯¥æ˜¯è¿›ç¨‹ã€‚</strong></font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830174128613.png" alt="image-20200830174128613"></p><p>ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»¥spark-shellçš„yarn clientæ¨¡å¼è¿è¡Œçš„å¯åŠ¨çš„æ˜¯<code>ExecutorLauncher</code>ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830174427258.png" alt="image-20200830174427258"></p><h2 id="ApplicationMasterğŸ”º"><a href="#ApplicationMasterğŸ”º" class="headerlink" title="ApplicationMasterğŸ”º"></a>ApplicationMasterğŸ”º</h2><p><font color="red"><strong>ApplicationMasteræ˜¯ä»¥è¿›ç¨‹å¯åŠ¨çš„</strong></font></p><p>ä¸Šé¢å¾—çŸ¥ï¼Œé€šè¿‡javaå‘½ä»¤çš„æ–¹æ³•å¼€å¯äº†ä¸€å°NMæ‰§è¡ŒAMï¼Œæ‰€ä»¥ä¸‹é¢æŸ¥çœ‹AMçš„mainï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830180331230.png" alt="image-20200830180331230"></p><h3 id="master-run"><a href="#master-run" class="headerlink" title="master.run"></a>master.run</h3><p>æ­¤æ–¹æ³•ä¸­çš„å…³é”®ç‚¹ï¼šåœ¨AMä¸­è¿è¡Œ</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830180521026.png" alt="image-20200830180521026"></p><h4 id="runDriver"><a href="#runDriver" class="headerlink" title="runDriver"></a>runDriver</h4><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830180708534.png" alt="image-20200830180708534"></p><h5 id="startUserApplicationï¼šå¯åŠ¨Driverç±»çš„main"><a href="#startUserApplicationï¼šå¯åŠ¨Driverç±»çš„main" class="headerlink" title="startUserApplicationï¼šå¯åŠ¨Driverç±»çš„main"></a>startUserApplicationï¼šå¯åŠ¨Driverç±»çš„main</h5><p>æ­¤æ–¹æ³•æ˜¯å¯åŠ¨Driverç±»ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è‡ªå·±ç¼–å†™çš„å¸¦æœ‰<code>sparkContext</code>çš„ç±»ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æœ€å¼€å§‹spark-submitæäº¤æ—¶classçš„å‚æ•°çš„ç±»ã€‚</p><ol><li>é€šè¿‡ä¸€ç›´ä¼ é€’çš„å‚æ•°ï¼Œå¼€å§‹è·å–æˆ‘ä»¬ç¼–å†™çš„ç±»</li><li>è·å–åˆ°ç±»åï¼Œé€šè¿‡åå°„è·å–åˆ°mainå‡½æ•°</li><li>ç„¶åé€šè¿‡åå°„è°ƒç”¨mainå‡½æ•°</li></ol><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830180856820.png" alt="image-20200830180856820"></p><h5 id="registerAM"><a href="#registerAM" class="headerlink" title="registerAM"></a>registerAM</h5><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830182105200.png" alt="image-20200830182105200"></p><h6 id="allocateResources"><a href="#allocateResources" class="headerlink" title="allocateResources"></a>allocateResources</h6><p>RMå‘AMç”³è¯·èµ„æºï¼š</p><p>ç”±ä¸Šé¢å¯çŸ¥amClientæ˜¯å­˜å‚¨äº†AMåœ°å€çš„å¯¹è±¡ï¼Œç”±æ­¤å¯¹è±¡è¿æ¥AMè·å–å¯åˆ†é…çš„èµ„æº</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830182245257.png" alt="image-20200830182245257"></p><h6 id="handleAllocatedContainersåˆ†é…å¼€å¯å®¹å™¨"><a href="#handleAllocatedContainersåˆ†é…å¼€å¯å®¹å™¨" class="headerlink" title="handleAllocatedContainersåˆ†é…å¼€å¯å®¹å™¨"></a>handleAllocatedContainersåˆ†é…å¼€å¯å®¹å™¨</h6><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830182438026.png" alt="image-20200830182438026"></p><h6 id="runAllocatedContainers"><a href="#runAllocatedContainers" class="headerlink" title="runAllocatedContainers"></a>runAllocatedContainers</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Launches executors in the allocated containers.</span><br></pre></td></tr></table></figure><p>åœ¨æ¯ä¸ªåˆ†é…çš„å®¹å™¨ä¸­å¯åŠ¨æ‰§è¡Œç¨‹åºã€‚çœ‹åˆ°å¯åŠ¨äº†ä¸€ä¸ªExecutorRunnableçš„çº¿ç¨‹åœ¨çº¿ç¨‹æ± é‡Œã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830182553599.png" alt="image-20200830182553599"></p><h6 id="ExecutorRunnable"><a href="#ExecutorRunnable" class="headerlink" title="ExecutorRunnable"></a>ExecutorRunnable</h6><p>çœ‹åˆ°æ­¤çº¿ç¨‹çš„é€»è¾‘å°±æ˜¯é€šè¿‡<code>nmClient</code>è¿æ¥NMèŠ‚ç‚¹å¼€å§‹<code>container</code></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830182659297.png" alt="image-20200830182659297"></p><p><font color="red"><strong>é‚£ä¹ˆï¼Œæ˜¯å¦‚ä½•å¼€å¯Containerå®¹å™¨å‘¢</strong></font></p><h6 id="startContainerğŸ”º"><a href="#startContainerğŸ”º" class="headerlink" title="startContainerğŸ”º"></a>startContainerğŸ”º</h6><p>å‘ç°æ­¤æ–¹æ³•ä¸­åˆè°ƒç”¨äº†æ–¹æ³•<code>val commands = prepareCommand()</code>æ¥<font color="red">ç”ŸæˆJavaå‘½ä»¤è¡Œå‘½ä»¤æ¥å¼€å¯<code>org.apache.spark.executor.CoarseGrainedExecutorBackend</code></font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830183133066.png" alt="image-20200830183133066"></p><p><font color="red"><strong>æ‰€ä»¥Containerå®¹å™¨ä¸­å¼€å¯äº†<code>CoarseGrainedExecutorBackend</code>ï¼Œå®ƒæ˜¯æ¥è®¡ç®—ä»»åŠ¡çš„ï¼Œå³Executorçš„åå°ã€‚</strong></font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830183322800.png" alt="image-20200830183322800"></p><h2 id="CoarseGrainedExecutorBackend"><a href="#CoarseGrainedExecutorBackend" class="headerlink" title="CoarseGrainedExecutorBackend"></a>CoarseGrainedExecutorBackend</h2><p><font color="red"><strong>CoarseGrainedExecutorBackendæ˜¯ä»¥è¿›ç¨‹å¯åŠ¨çš„</strong></font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830183429858.png" alt="image-20200830183429858"></p><h3 id="run-1"><a href="#run-1" class="headerlink" title="run"></a>run</h3><p>å‘ç°å®ƒæ–°å»ºäº†ä¸€ä¸ªè®¡ç®—<strong>ç»ˆç«¯</strong>ç¯å¢ƒï¼Œé€šè¿‡æŸ¥çœ‹å®ƒçš„ç±»æ—¶ï¼š<code>CoarseGrainedExecutorBackend</code></p><p>å‘ç°äº†æ–°çš„å±æ€§<code>var executor: Executor = null</code>ï¼Œè¿™æ—¶å‘ç°æ­¤å¯¹è±¡æ‰æ˜¯è®¡ç®—çš„æ ¹æœ¬ï¼ï¼ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830183711553.png" alt="image-20200830183711553"></p><p>å‘ç°å®ƒç»§æ‰¿äº†<code>ThreadSafeRpcEndpoint</code>ï¼Œè€Œ<code>ThreadSafeRpcEndpoint</code>ç»ˆç«¯æœ‰å››ä¸ªç”Ÿå‘½å‘¨æœŸï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830183921529.png" alt="image-20200830183921529"></p><p>å› ä¸ºCoarseGrainedExecutorBackendç»§æ‰¿äº†å®ƒï¼Œæ‰€ä»¥ä»–ä¹Ÿæ˜¯ä¸ªç»ˆç«¯ï¼Œä¸”CoarseGrainedExecutorBackendå¼€å¯åä¼šæ‰§è¡ŒonStartä¸­å®šä¹‰çš„äº‹æƒ…ï¼šåœ¨Containerçš„CoarseGrainedExecutorBackendåˆ›å»ºå®Œæ¯•åä¼šå‘Driveræ‰€åœ¨çš„ç»ˆç«¯å‘é€Executorå¯åŠ¨å®Œæ¯•çš„ä¿¡æ¯</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830184011123.png" alt="image-20200830184011123"></p><p>è€Œæˆ‘ä»¬Driverçš„æ”¶åˆ°ä¿¡æ¯åï¼Œä¼šåé¦ˆç»™CoarseGrainedExecutorBackendï¼ŒCoarseGrainedExecutorBackendæ”¶åˆ°ä¿¡æ¯åæ‰§è¡Œä»¥ä¸‹å†…å®¹ï¼Œåˆ›å»ºè®¡ç®—å¯¹è±¡ï¼Œä¸Šé¢è®²åˆ°CoarseGrainedExecutorBackendå¹¶ä¸æ˜¯ä¸€ä¸ªè®¡ç®—å¯¹è±¡ï¼Œæœ‰ç€è®¡ç®—ä½œç”¨çš„æ˜¯å®ƒçš„å±æ€§<code>executor</code>ï¼Œè¿™æ—¶åˆ›å»º<code>executor</code>å±æ€§</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830184231615.png" alt="image-20200830184231615"></p><p>ä»¥ä¸Šèµ„æºè°ƒåº¦å®Œäº‹ï¼ŒExecutorå·²ç»å¯åŠ¨</p><h2 id="æ€»ç»“ğŸ”º"><a href="#æ€»ç»“ğŸ”º" class="headerlink" title="æ€»ç»“ğŸ”º"></a>æ€»ç»“ğŸ”º</h2><p>ä¸Šé¢çš„æºç å·²ç»å®Œå…¨çš„è§£é‡Šäº†ä¸‹å›¾ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830185102697.png" alt="image-20200830185102697"></p><p>ç”±æºç çš„æµç¨‹å¯çœ‹å‡ºå…±å¯åŠ¨äº†ä»¥ä¸‹å‡ ç§è¿›ç¨‹ï¼š</p><ol><li>spark-submitï¼šå‘å¸ƒä»»åŠ¡çš„å®¢æˆ·ç«¯å¯åŠ¨</li><li>ApplicationMasterï¼šRMéšæœºæ‰¾ä¸€å°NMå¯åŠ¨</li><li>CoarseGrainedExecutorBackendï¼šAMç”³è¯·åˆ°çš„NMä¸­çš„Containerä¸­å¯åŠ¨ï¼Œæ­¤è¿›ç¨‹ä¸­çš„CoarseGrainedExecutorBackendå¯¹è±¡çš„Executorå±æ€§æ‰æ˜¯è®¡ç®—çš„å±æ€§</li></ol><hr><h1 id="Spark-ä»»åŠ¡è°ƒåº¦æœºåˆ¶"><a href="#Spark-ä»»åŠ¡è°ƒåº¦æœºåˆ¶" class="headerlink" title="Spark ä»»åŠ¡è°ƒåº¦æœºåˆ¶"></a>Spark ä»»åŠ¡è°ƒåº¦æœºåˆ¶</h1><p>åœ¨å·¥å‚ç¯å¢ƒä¸‹ï¼ŒSparké›†ç¾¤çš„éƒ¨ç½²æ–¹å¼ä¸€èˆ¬ä¸ºYARN-Clusteræ¨¡å¼ï¼Œä¹‹åçš„å†…æ ¸åˆ†æå†…å®¹ä¸­æˆ‘ä»¬é»˜è®¤é›†ç¾¤çš„éƒ¨ç½²æ–¹å¼ä¸ºYARN-Clusteræ¨¡å¼ã€‚</p><h2 id="Sparkä»»åŠ¡æäº¤æµç¨‹"><a href="#Sparkä»»åŠ¡æäº¤æµç¨‹" class="headerlink" title="Sparkä»»åŠ¡æäº¤æµç¨‹"></a>Sparkä»»åŠ¡æäº¤æµç¨‹</h2><p>åœ¨ä¸Šä¸€ç« ä¸­æˆ‘ä»¬è®²è§£äº†Spark YARN-Clusteræ¨¡å¼ä¸‹çš„ä»»åŠ¡æäº¤æµç¨‹</p><p>ä¸‹é¢çš„æ—¶åºå›¾æ¸…æ™°åœ°è¯´æ˜äº†ä¸€ä¸ªSparkåº”ç”¨ç¨‹åºä»æäº¤åˆ°è¿è¡Œçš„å®Œæ•´æµç¨‹ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830185555274.png" alt="image-20200830185555274"></p><p>æäº¤ä¸€ä¸ªSparkåº”ç”¨ç¨‹åºï¼Œé¦–å…ˆé€šè¿‡Clientå‘ResourceManagerè¯·æ±‚å¯åŠ¨ä¸€ä¸ªApplicationï¼ŒåŒæ—¶æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„èµ„æºæ»¡è¶³Applicationçš„éœ€æ±‚ï¼Œå¦‚æœèµ„æºæ¡ä»¶æ»¡è¶³ï¼Œåˆ™å‡†å¤‡ApplicationMasterçš„å¯åŠ¨ä¸Šä¸‹æ–‡ï¼Œäº¤ç»™ResourceManagerï¼Œå¹¶å¾ªç¯ç›‘æ§ApplicationçŠ¶æ€ã€‚</p><p>å½“æäº¤çš„èµ„æºé˜Ÿåˆ—ä¸­æœ‰èµ„æºæ—¶ï¼ŒResourceManagerä¼šåœ¨æŸä¸ªNodeManagerä¸Šå¯åŠ¨ApplicationMasterè¿›ç¨‹ï¼Œ<font color="red">ApplicationMasterä¼šå•ç‹¬å¯åŠ¨Driveråå°çº¿ç¨‹ï¼Œå½“Driverå¯åŠ¨åï¼ŒApplicationMasterä¼šé€šè¿‡æœ¬åœ°çš„RPCè¿æ¥Driver</font>ï¼Œå¹¶å¼€å§‹å‘ResourceManagerç”³è¯·Containerèµ„æºè¿è¡ŒExecutorè¿›ç¨‹ï¼ˆä¸€ä¸ªExecutorå¯¹åº”ä¸ä¸€ä¸ªContainerï¼‰ï¼Œå½“ResourceManagerè¿”å›Containerèµ„æºï¼ŒApplicationMasteråˆ™åœ¨å¯¹åº”çš„Containerä¸Šå¯åŠ¨Executorã€‚</p><p>Driverçº¿ç¨‹ä¸»è¦æ˜¯åˆå§‹åŒ–SparkContextå¯¹è±¡ï¼Œå‡†å¤‡è¿è¡Œæ‰€éœ€çš„ä¸Šä¸‹æ–‡ï¼Œç„¶åä¸€æ–¹é¢ä¿æŒä¸ApplicationMasterçš„RPCè¿æ¥ï¼Œé€šè¿‡ApplicationMasterç”³è¯·èµ„æºï¼Œå¦ä¸€æ–¹é¢æ ¹æ®ç”¨æˆ·ä¸šåŠ¡é€»è¾‘å¼€å§‹è°ƒåº¦ä»»åŠ¡ï¼Œå°†ä»»åŠ¡ä¸‹å‘åˆ°å·²æœ‰çš„ç©ºé—²Executorä¸Šã€‚</p><p>å½“ResourceManagerå‘ApplicationMasterè¿”å›Containerèµ„æºæ—¶ï¼ŒApplicationMasterå°±å°è¯•åœ¨å¯¹åº”çš„Containerä¸Šå¯åŠ¨Executorè¿›ç¨‹ï¼Œ<font color="red">Executorè¿›ç¨‹èµ·æ¥åï¼Œä¼šå‘Driveråå‘æ³¨å†Œï¼Œæ³¨å†ŒæˆåŠŸåä¿æŒä¸Driverçš„å¿ƒè·³ï¼ŒåŒæ—¶ç­‰å¾…Driveråˆ†å‘ä»»åŠ¡ï¼Œå½“åˆ†å‘çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå°†ä»»åŠ¡çŠ¶æ€ä¸ŠæŠ¥ç»™Driverã€‚</font></p><p>ä»ä¸Šè¿°æ—¶åºå›¾å¯çŸ¥ï¼ŒClientåªè´Ÿè´£æäº¤Applicationå¹¶ç›‘æ§Applicationçš„çŠ¶æ€ã€‚å¯¹äºSparkçš„ä»»åŠ¡è°ƒåº¦ä¸»è¦æ˜¯é›†ä¸­åœ¨ä¸¤ä¸ªæ–¹é¢: <strong>èµ„æºç”³è¯·å’Œä»»åŠ¡åˆ†å‘</strong>ï¼Œå…¶ä¸»è¦æ˜¯é€šè¿‡ApplicationMasterã€Driverä»¥åŠExecutorä¹‹é—´æ¥å®Œæˆã€‚</p><h2 id="Sparkä»»åŠ¡è°ƒåº¦æ¦‚è¿°ğŸ”º"><a href="#Sparkä»»åŠ¡è°ƒåº¦æ¦‚è¿°ğŸ”º" class="headerlink" title="Sparkä»»åŠ¡è°ƒåº¦æ¦‚è¿°ğŸ”º"></a>Sparkä»»åŠ¡è°ƒåº¦æ¦‚è¿°ğŸ”º</h2><p>å½“Driverèµ·æ¥åï¼ŒDriveråˆ™ä¼šæ ¹æ®ç”¨æˆ·ç¨‹åºé€»è¾‘å‡†å¤‡ä»»åŠ¡ï¼Œå¹¶æ ¹æ®Executorèµ„æºæƒ…å†µé€æ­¥åˆ†å‘ä»»åŠ¡ã€‚åœ¨è¯¦ç»†é˜è¿°ä»»åŠ¡è°ƒåº¦å‰ï¼Œé¦–å…ˆè¯´æ˜ä¸‹Sparké‡Œçš„å‡ ä¸ªæ¦‚å¿µã€‚ä¸€ä¸ªSparkåº”ç”¨ç¨‹åºåŒ…æ‹¬Jobã€Stageä»¥åŠTaskä¸‰ä¸ªæ¦‚å¿µï¼š</p><ul><li> Jobæ˜¯ä»¥Actionæ–¹æ³•ä¸ºç•Œï¼Œé‡åˆ°ä¸€ä¸ªActionæ–¹æ³•åˆ™è§¦å‘ä¸€ä¸ªJobï¼›</li><li>Stageæ˜¯Jobçš„å­é›†ï¼Œä»¥RDDå®½ä¾èµ–(å³Shuffle)ä¸ºç•Œï¼Œé‡åˆ°Shuffleåšä¸€æ¬¡åˆ’åˆ†ï¼›</li><li> Taskæ˜¯Stageçš„å­é›†ï¼Œä»¥å¹¶è¡Œåº¦(åˆ†åŒºæ•°)æ¥è¡¡é‡ï¼Œåˆ†åŒºæ•°æ˜¯å¤šå°‘ï¼Œåˆ™æœ‰å¤šå°‘ä¸ªtaskã€‚</li></ul><p>Sparkçš„ä»»åŠ¡è°ƒåº¦æ€»ä½“æ¥è¯´åˆ†ä¸¤è·¯è¿›è¡Œï¼Œ<font color="red"><strong>ä¸€è·¯æ˜¯Stageçº§çš„è°ƒåº¦ï¼Œä¸€è·¯æ˜¯Taskçº§çš„è°ƒåº¦</strong></font>ï¼Œæ€»ä½“è°ƒåº¦æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830190028855.png" alt="image-20200830190028855"></p><p>Spark RDDé€šè¿‡å…¶Transactionsæ“ä½œï¼Œå½¢æˆäº†RDDè¡€ç¼˜å…³ç³»å›¾ï¼Œå³DAGï¼Œæœ€åé€šè¿‡Actionçš„è°ƒç”¨ï¼Œè§¦å‘Jobå¹¶è°ƒåº¦æ‰§è¡Œã€‚</p><p><font color="red"><strong>DAGSchedulerè´Ÿè´£Stageçº§çš„è°ƒåº¦</strong></font>ï¼Œä¸»è¦æ˜¯å°†jobåˆ‡åˆ†æˆè‹¥å¹²Stagesï¼Œå¹¶å°†æ¯ä¸ªStageæ‰“åŒ…æˆTaskSetäº¤ç»™TaskSchedulerè°ƒåº¦ã€‚</p><p><font color="red"><strong>TaskSchedulerè´Ÿè´£Taskçº§çš„è°ƒåº¦</strong></font>ï¼Œå°†DAGSchedulerç»™è¿‡æ¥çš„TaskSetæŒ‰ç…§æŒ‡å®šçš„è°ƒåº¦ç­–ç•¥åˆ†å‘åˆ°Executorä¸Šæ‰§è¡Œï¼Œè°ƒåº¦è¿‡ç¨‹ä¸­SchedulerBackendè´Ÿè´£æä¾›å¯ç”¨èµ„æºï¼Œå…¶ä¸­<strong>SchedulerBackendæœ‰å¤šç§å®ç°ï¼Œåˆ†åˆ«å¯¹æ¥ä¸åŒçš„èµ„æºç®¡ç†ç³»ç»Ÿ</strong>ã€‚</p><p>ä¸‹é¢è¿™å¼ å›¾æè¿°äº†Spark-On-Yarnæ¨¡å¼ä¸‹åœ¨ä»»åŠ¡è°ƒåº¦æœŸé—´ï¼ŒApplicationMasterã€Driverä»¥åŠExecutorå†…éƒ¨æ¨¡å—çš„äº¤äº’è¿‡ç¨‹ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830190229195.png" alt="image-20200830190229195"></p><h2 id="Spark-Stageçº§è°ƒåº¦ğŸ”º"><a href="#Spark-Stageçº§è°ƒåº¦ğŸ”º" class="headerlink" title="Spark Stageçº§è°ƒåº¦ğŸ”º"></a>Spark Stageçº§è°ƒåº¦ğŸ”º</h2><p>Sparkçš„ä»»åŠ¡è°ƒåº¦æ˜¯ä»DAGåˆ‡å‰²å¼€å§‹ï¼Œä¸»è¦æ˜¯ç”±DAGScheduleræ¥å®Œæˆã€‚å½“é‡åˆ°ä¸€ä¸ªActionæ“ä½œåå°±ä¼šè§¦å‘ä¸€ä¸ªJobçš„è®¡ç®—ï¼Œå¹¶äº¤ç»™DAGScheduleræ¥æäº¤ï¼Œä¸‹å›¾æ˜¯æ¶‰åŠåˆ°Jobæäº¤çš„ç›¸å…³æ–¹æ³•è°ƒç”¨æµç¨‹å›¾ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830190303628.png" alt="image-20200830190303628"></p><p><font color="red">**<code>dag.submit</code>**æäº¤stageæ—¶å…ˆæäº¤ç¬¬ä¸€ä¸ªStageï¼Œåœ¨Stageåˆ‡åˆ†é˜¶æ®µé™¤äº†æœ€åä¸€ä¸ªStageå«<code>ResultStage</code>åªè¿›è¡ŒShuffle Readï¼Œå…¶ä½™Stageå‡ç§°ä¸º<code>ShuffleMapStage</code>å‡è¿›è¡ŒShuffle Readå’ŒWriteï¼Œé™¤äº†ç¬¬ä¸€ä¸ªä¸è¿›è¡ŒRead</font></p><p>Jobç”±æœ€ç»ˆçš„RDDå’ŒActionæ–¹æ³•å°è£…è€Œæˆï¼ŒSparkContextå°†Jobäº¤ç»™DAGScheduleræäº¤ï¼Œå®ƒä¼šæ ¹æ®RDDçš„è¡€ç¼˜å…³ç³»æ„æˆçš„DAGè¿›è¡Œåˆ‡åˆ†ï¼Œå°†ä¸€ä¸ªJobåˆ’åˆ†ä¸ºè‹¥å¹²Stagesï¼Œ<font color="red">å…·ä½“åˆ’åˆ†ç­–ç•¥æ˜¯ï¼Œç”±æœ€ç»ˆçš„RDDä¸æ–­é€šè¿‡ä¾èµ–å›æº¯åˆ¤æ–­çˆ¶ä¾èµ–æ˜¯å¦æ˜¯å®½ä¾èµ–ï¼Œå³ä»¥Shuffleä¸ºç•Œï¼Œåˆ’åˆ†Stageï¼Œçª„ä¾èµ–çš„RDDä¹‹é—´è¢«åˆ’åˆ†åˆ°åŒä¸€ä¸ªStageä¸­ï¼Œå¯ä»¥è¿›è¡Œpipelineå¼çš„è®¡ç®—</font></p><p>å¦‚å›¾ç´«è‰²æµç¨‹éƒ¨åˆ†ã€‚åˆ’åˆ†çš„Stagesåˆ†ä¸¤ç±»ï¼Œä¸€ç±»å«åšResultStageï¼Œ<strong>ä¸ºDAGæœ€ä¸‹æ¸¸çš„Stage</strong>ï¼Œç”±Actionæ–¹æ³•å†³å®šï¼Œ<strong>å¦ä¸€ç±»å«åšShuffleMapStageï¼Œä¸ºä¸‹æ¸¸Stageå‡†å¤‡æ•°æ®</strong>ï¼Œä¸‹é¢çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­WordCountã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830190837690.png" alt="image-20200830190837690"></p><p>Jobç”±saveAsTextFileè§¦å‘ï¼Œè¯¥Jobç”±RDD-3å’ŒsaveAsTextFileæ–¹æ³•ç»„æˆï¼Œæ ¹æ®RDDä¹‹é—´çš„ä¾èµ–å…³ç³»ä»RDD-3å¼€å§‹å›æº¯æœç´¢ï¼Œç›´åˆ°æ²¡æœ‰ä¾èµ–çš„RDD-0ï¼Œ<strong>åœ¨å›æº¯æœç´¢è¿‡ç¨‹ä¸­ï¼ŒRDD-3ä¾èµ–RDD-2ï¼Œå¹¶ä¸”æ˜¯å®½ä¾èµ–</strong>ï¼Œæ‰€ä»¥åœ¨RDD-2å’ŒRDD-3ä¹‹é—´åˆ’åˆ†Stageï¼ŒRDD-3è¢«åˆ’åˆ°æœ€åä¸€ä¸ªStageï¼Œå³ResultStageä¸­ï¼ŒRDD-2ä¾èµ–RDD-1ï¼ŒRDD-1ä¾èµ–RDD-0ï¼Œè¿™äº›ä¾èµ–éƒ½æ˜¯çª„ä¾èµ–ï¼Œæ‰€ä»¥å°†RDD-0ã€RDD-1å’ŒRDD-2åˆ’åˆ†åˆ°åŒä¸€ä¸ªStage<strong>ï¼Œå³ShuffleMapStageä¸­ï¼Œå®é™…æ‰§è¡Œçš„æ—¶å€™ï¼Œæ•°æ®è®°å½•ä¼šä¸€æ°”å‘µæˆåœ°æ‰§è¡ŒRDD-0åˆ°RDD-2çš„è½¬åŒ–</strong>ã€‚ä¸éš¾çœ‹å‡ºï¼Œå…¶æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ·±åº¦ä¼˜å…ˆæœç´¢ç®—æ³•ã€‚</p><p><font color="red">ä¸€ä¸ªStageæ˜¯å¦è¢«æäº¤ï¼Œéœ€è¦åˆ¤æ–­å®ƒçš„çˆ¶Stageæ˜¯å¦æ‰§è¡Œï¼Œåªæœ‰åœ¨çˆ¶Stageæ‰§è¡Œå®Œæ¯•æ‰èƒ½æäº¤å½“å‰Stageï¼Œå¦‚æœä¸€ä¸ªStageæ²¡æœ‰çˆ¶Stageï¼Œé‚£ä¹ˆä»è¯¥Stageå¼€å§‹æäº¤ã€‚Stageæäº¤æ—¶ä¼šå°†Taskä¿¡æ¯ï¼ˆåˆ†åŒºä¿¡æ¯ä»¥åŠæ–¹æ³•ç­‰ï¼‰åºåˆ—åŒ–å¹¶è¢«æ‰“åŒ…æˆTaskSetäº¤ç»™TaskScheduler</font>ï¼Œä¸€ä¸ªPartitionå¯¹åº”ä¸€ä¸ªTaskï¼Œå¦ä¸€æ–¹é¢TaskSchedulerä¼šç›‘æ§Stageçš„è¿è¡ŒçŠ¶æ€ï¼Œåªæœ‰Executorä¸¢å¤±æˆ–è€…Taskç”±äºFetchå¤±è´¥æ‰éœ€è¦é‡æ–°æäº¤å¤±è´¥çš„Stageä»¥è°ƒåº¦è¿è¡Œå¤±è´¥çš„ä»»åŠ¡ï¼Œå…¶ä»–ç±»å‹çš„Taskå¤±è´¥ä¼šåœ¨TaskSchedulerçš„è°ƒåº¦è¿‡ç¨‹ä¸­é‡è¯•ã€‚</p><p>ç›¸å¯¹æ¥è¯´DAGScheduleråšçš„äº‹æƒ…è¾ƒä¸ºç®€å•ï¼Œä»…ä»…æ˜¯åœ¨Stageå±‚é¢ä¸Šåˆ’åˆ†DAGï¼Œæäº¤Stageå¹¶ç›‘æ§ç›¸å…³çŠ¶æ€ä¿¡æ¯ã€‚TaskScheduleråˆ™ç›¸å¯¹è¾ƒä¸ºå¤æ‚ï¼Œä¸‹é¢è¯¦ç»†é˜è¿°å…¶ç»†èŠ‚ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>DAGSchedulerå°±æ˜¯å¯¹æ•´ä¸ªJobè¿›è¡Œäº†Stageçš„åˆ‡åˆ†ï¼Œå¹¶å¯¹æ¯ä¸ªStageçš„å¤šä¸ªTaskå°è£…ä¸ºTaskSetäº¤ç»™TaskSchedulerã€‚</p><p>DAGScheduleråœ¨æäº¤Stageæ—¶ï¼Œä»ç¬¬ä¸€ä¸ªå¾€åæäº¤ï¼Œå› ä¸ºæ¯ä¸ªStageä¹‹é—´éƒ½å­˜åœ¨Shuffleï¼Œéœ€è¦ä¸Šä¸ªStageçš„Shuffle Wrtireçš„æ•°æ®</p><h2 id="Spark-Taskçº§è°ƒåº¦"><a href="#Spark-Taskçº§è°ƒåº¦" class="headerlink" title="Spark Taskçº§è°ƒåº¦"></a>Spark Taskçº§è°ƒåº¦</h2><p>Spark Taskçš„è°ƒåº¦æ˜¯ç”±TaskScheduleræ¥å®Œæˆï¼Œç”±å‰æ–‡å¯çŸ¥ï¼ŒDAGSchedulerå°†Stageæ‰“åŒ…åˆ°TaskSetäº¤ç»™TaskSchedulerï¼ŒTaskSchedulerä¼šå°†TaskSetå°è£…ä¸ºTaskSetManageråˆ°è°ƒåº¦é˜Ÿåˆ—ä¸­ï¼ŒTaskSetManagerç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830191254343.png" alt="image-20200830191254343"></p><p><font color="red"><strong>TaskSetManagerè´Ÿè´£ç›‘æ§ç®¡ç†åŒä¸€ä¸ªStageä¸­çš„Tasksï¼ŒTaskSchedulerå°±æ˜¯ä»¥TaskSetManagerä¸ºå•å…ƒæ¥è°ƒåº¦ä»»åŠ¡ã€‚</strong></font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830191444090.png" alt="image-20200830191444090"></p><p>å‰é¢ä¹Ÿæåˆ°ï¼Œ<font color="red">TaskScheduleråˆå§‹åŒ–åä¼šå¯åŠ¨SchedulerBackendï¼Œå®ƒè´Ÿè´£è·Ÿå¤–ç•Œæ‰“äº¤é“ï¼Œæ¥æ”¶Executorçš„æ³¨å†Œä¿¡æ¯ï¼Œå¹¶ç»´æŠ¤Executorçš„çŠ¶æ€</font>ï¼Œæ‰€ä»¥è¯´SchedulerBackendæ˜¯ç®¡â€œè·å–ä»»åŠ¡â€çš„ï¼ŒåŒæ—¶å®ƒåœ¨å¯åŠ¨åä¼šå®šæœŸåœ°å»â€œè¯¢é—®â€TaskScheduleræœ‰æ²¡æœ‰ä»»åŠ¡è¦è¿è¡Œï¼ŒTaskScheduleråœ¨SchedulerBackendâ€œé—®â€å®ƒçš„æ—¶å€™ï¼Œä¼šä»è°ƒåº¦é˜Ÿåˆ—ä¸­æŒ‰ç…§æŒ‡å®šçš„è°ƒåº¦ç­–ç•¥é€‰æ‹©TaskSetManagerå»è°ƒåº¦è¿è¡Œï¼Œå¤§è‡´æ–¹æ³•è°ƒç”¨æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830191635299.png" alt="image-20200830191635299"></p><p>SchedulerBackEndæ”¶åˆ°å¾…æ‰§è¡Œçš„ä»»åŠ¡åä»TaskSetPoolï¼Œå¼€å§‹è”ç³»Executorå¼€å§‹æ‰§è¡Œ</p><h3 id="è°ƒåº¦ç­–ç•¥"><a href="#è°ƒåº¦ç­–ç•¥" class="headerlink" title="è°ƒåº¦ç­–ç•¥"></a>è°ƒåº¦ç­–ç•¥</h3><p>å‰é¢è®²åˆ°ï¼ŒTaskSchedulerä¼šå…ˆæŠŠDAGSchedulerç»™è¿‡æ¥çš„TaskSetå°è£…æˆTaskSetManageræ‰”åˆ°ä»»åŠ¡é˜Ÿåˆ—é‡Œï¼Œç„¶åå†ä»ä»»åŠ¡é˜Ÿåˆ—é‡ŒæŒ‰ç…§ä¸€å®šçš„è§„åˆ™æŠŠå®ƒä»¬å–å‡ºæ¥åœ¨SchedulerBackendç»™è¿‡æ¥çš„Executorä¸Šè¿è¡Œã€‚<font color="red">è¿™ä¸ªè°ƒåº¦è¿‡ç¨‹å®é™…ä¸Šè¿˜æ˜¯æ¯”è¾ƒç²—ç²’åº¦çš„ï¼Œæ˜¯é¢å‘TaskSetManagerçš„</font></p><p>TaskScheduleræ˜¯ä»¥æ ‘çš„æ–¹å¼æ¥ç®¡ç†ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ ‘ä¸­çš„èŠ‚ç‚¹ç±»å‹ä¸ºSchdulableï¼Œå¶å­èŠ‚ç‚¹ä¸ºTaskSetManagerï¼Œéå¶å­èŠ‚ç‚¹ä¸ºPoolï¼Œä¸‹å›¾æ˜¯å®ƒä»¬ä¹‹é—´çš„ç»§æ‰¿å…³ç³»ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200830192011398.png" alt="image-20200830192011398"></p><p>TaskScheduleræ”¯æŒä¸¤ç§è°ƒåº¦ç­–ç•¥ï¼Œ<strong>ä¸€ç§æ˜¯FIFOï¼Œä¹Ÿæ˜¯é»˜è®¤çš„è°ƒåº¦ç­–ç•¥ï¼Œå¦ä¸€ç§æ˜¯FAIR</strong>ã€‚åœ¨TaskScheduleråˆå§‹åŒ–è¿‡ç¨‹ä¸­ä¼šå®ä¾‹åŒ–rootPoolï¼Œè¡¨ç¤ºæ ‘çš„æ ¹èŠ‚ç‚¹ï¼Œæ˜¯Poolç±»å‹ã€‚</p><h3 id="å¤±è´¥é‡è¯•å’Œé»‘åå•"><a href="#å¤±è´¥é‡è¯•å’Œé»‘åå•" class="headerlink" title="å¤±è´¥é‡è¯•å’Œé»‘åå•"></a>å¤±è´¥é‡è¯•å’Œé»‘åå•</h3><p>é™¤äº†é€‰æ‹©åˆé€‚çš„Taskè°ƒåº¦è¿è¡Œå¤–ï¼Œè¿˜éœ€è¦ç›‘æ§Taskçš„æ‰§è¡ŒçŠ¶æ€ï¼Œå‰é¢ä¹Ÿæåˆ°ï¼Œä¸å¤–éƒ¨æ‰“äº¤é“çš„æ˜¯<code>SchedulerBackend</code>ï¼ŒTaskè¢«æäº¤åˆ°Executorå¯åŠ¨æ‰§è¡Œåï¼ŒExecutorä¼šå°†æ‰§è¡ŒçŠ¶æ€ä¸ŠæŠ¥ç»™SchedulerBackendï¼ŒSchedulerBackendåˆ™å‘Šè¯‰TaskSchedulerï¼ŒTaskScheduleræ‰¾åˆ°è¯¥Taskå¯¹åº”çš„TaskSetManagerï¼Œå¹¶é€šçŸ¥åˆ°è¯¥TaskSetManagerï¼Œè¿™æ ·TaskSetManagerå°±çŸ¥é“Taskçš„å¤±è´¥ä¸æˆåŠŸçŠ¶æ€ï¼Œ<font color="red">å¯¹äºå¤±è´¥çš„Taskï¼Œä¼šè®°å½•å®ƒå¤±è´¥çš„æ¬¡æ•°ï¼Œå¦‚æœå¤±è´¥æ¬¡æ•°è¿˜æ²¡æœ‰è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œé‚£ä¹ˆå°±æŠŠå®ƒæ”¾å›å¾…è°ƒåº¦çš„Taskæ± å­ä¸­ï¼Œå¦åˆ™æ•´ä¸ªApplicationå¤±è´¥ã€‚</font></p><p><font color="red">åœ¨è®°å½•Taskå¤±è´¥æ¬¡æ•°è¿‡ç¨‹ä¸­ï¼Œä¼šè®°å½•å®ƒä¸Šä¸€æ¬¡å¤±è´¥æ‰€åœ¨çš„Executor Idå’ŒHostï¼Œè¿™æ ·ä¸‹æ¬¡å†è°ƒåº¦è¿™ä¸ªTaskæ—¶ï¼Œä¼šä½¿ç”¨é»‘åå•æœºåˆ¶ï¼Œé¿å…å®ƒè¢«è°ƒåº¦åˆ°ä¸Šä¸€æ¬¡å¤±è´¥çš„èŠ‚ç‚¹ä¸Šï¼Œèµ·åˆ°ä¸€å®šçš„å®¹é”™ä½œç”¨ã€‚</font>é»‘åå•è®°å½•Taskä¸Šä¸€æ¬¡å¤±è´¥æ‰€åœ¨çš„Executor Idå’ŒHostï¼Œä»¥åŠå…¶å¯¹åº”çš„â€œæ‹‰é»‘â€æ—¶é—´ï¼Œâ€œæ‹‰é»‘â€æ—¶é—´æ˜¯æŒ‡è¿™æ®µæ—¶é—´å†…ä¸è¦å†å¾€è¿™ä¸ªèŠ‚ç‚¹ä¸Šè°ƒåº¦è¿™ä¸ªTaskäº†ã€‚</p><h1 id="Spark-Shuffleè§£æ"><a href="#Spark-Shuffleè§£æ" class="headerlink" title="Spark Shuffleè§£æ"></a>Spark Shuffleè§£æ</h1><h2 id="Shuffleè¦ç‚¹"><a href="#Shuffleè¦ç‚¹" class="headerlink" title="Shuffleè¦ç‚¹"></a>Shuffleè¦ç‚¹</h2><h3 id="ShuffleMapStageä¸ResultStage"><a href="#ShuffleMapStageä¸ResultStage" class="headerlink" title="ShuffleMapStageä¸ResultStage"></a>ShuffleMapStageä¸ResultStage</h3><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200831205831081.png" alt="image-20200831205831081"></p><p>åœ¨åˆ’åˆ†stageæ—¶ï¼Œæœ€åä¸€ä¸ªstageç§°ä¸ºfinalStageï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªResultStageå¯¹è±¡ï¼Œå‰é¢çš„æ‰€æœ‰stageè¢«ç§°ä¸ºShuffleMapStageã€‚</p><p>ShuffleMapStageçš„ç»“æŸä¼´éšç€shuffleæ–‡ä»¶çš„å†™ç£ç›˜ã€‚é™¤äº†ç¬¬ä¸€ä¸ªShuffleMapStageï¼Œå‰©ä½™çš„ä¹Ÿéƒ½ä¼šè¯»è¯»ç›˜ã€‚</p><p>ResultStageåŸºæœ¬ä¸Šå¯¹åº”ä»£ç ä¸­çš„actionç®—å­ï¼Œå³å°†ä¸€ä¸ªå‡½æ•°åº”ç”¨åœ¨RDDçš„å„ä¸ªpartitionçš„æ•°æ®é›†ä¸Šï¼Œæ„å‘³ç€ä¸€ä¸ªjobçš„è¿è¡Œç»“æŸã€‚</p><h3 id="Shuffleä¸­ä»»åŠ¡ä¸ªæ•°"><a href="#Shuffleä¸­ä»»åŠ¡ä¸ªæ•°" class="headerlink" title="Shuffleä¸­ä»»åŠ¡ä¸ªæ•°"></a>Shuffleä¸­ä»»åŠ¡ä¸ªæ•°</h3><p>æˆ‘ä»¬çŸ¥é“ï¼ŒSpark Shuffleåˆ†ä¸ºmapé˜¶æ®µå’Œreduceé˜¶æ®µï¼Œæˆ–è€…ç§°ä¹‹ä¸º<code>ShuffleRead</code>é˜¶æ®µå’Œ<code>ShuffleWrite</code>é˜¶æ®µï¼Œé‚£ä¹ˆå¯¹äºä¸€æ¬¡Shuffleï¼Œmapè¿‡ç¨‹å’Œreduceè¿‡ç¨‹éƒ½ä¼šç”±è‹¥å¹²ä¸ªtaskæ¥æ‰§è¡Œï¼Œé‚£ä¹ˆmap taskå’Œreduce taskçš„æ•°é‡æ˜¯å¦‚ä½•ç¡®å®šçš„å‘¢ï¼Ÿ</p><p>å‡è®¾Sparkä»»åŠ¡ä»HDFSä¸­è¯»å–æ•°æ®ï¼Œ<font color="red">é‚£ä¹ˆåˆå§‹RDDåˆ†åŒºä¸ªæ•°ç”±è¯¥æ–‡ä»¶çš„splitä¸ªæ•°å†³å®š</font>ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªsplitå¯¹åº”ç”Ÿæˆçš„RDDçš„ä¸€ä¸ªpartitionï¼Œæˆ‘ä»¬å‡è®¾åˆå§‹partitionä¸ªæ•°ä¸ºNã€‚</p><p>åˆå§‹RDDç»è¿‡ä¸€ç³»åˆ—ç®—å­è®¡ç®—åï¼ˆ<strong>å‡è®¾æ²¡æœ‰æ‰§è¡Œrepartitionå’Œcoalesceç®—å­è¿›è¡Œé‡åˆ†åŒº</strong>ï¼Œåˆ™åˆ†åŒºä¸ªæ•°ä¸å˜ï¼Œä»ä¸ºNï¼Œå¦‚æœç»è¿‡é‡åˆ†åŒºç®—å­ï¼Œé‚£ä¹ˆåˆ†åŒºä¸ªæ•°å˜ä¸ºMï¼‰ï¼Œæˆ‘ä»¬å‡è®¾åˆ†åŒºä¸ªæ•°ä¸å˜ï¼Œ<font color="red">å½“æ‰§è¡Œåˆ°Shuffleæ“ä½œæ—¶ï¼Œmapç«¯çš„taskä¸ªæ•°å’Œpartitionä¸ªæ•°ä¸€è‡´ï¼Œå³map taskä¸ºNä¸ªã€‚</font></p><p><font color="red"><strong>reduceç«¯çš„stageé»˜è®¤å–spark.default.parallelismè¿™ä¸ªé…ç½®é¡¹çš„å€¼ä½œä¸ºåˆ†åŒºæ•°ï¼Œå¦‚æœæ²¡æœ‰é…ç½®ï¼Œåˆ™ä»¥mapç«¯çš„æœ€åä¸€ä¸ªRDDçš„åˆ†åŒºæ•°ä½œä¸ºå…¶åˆ†åŒºæ•°ï¼ˆä¹Ÿå°±æ˜¯Nï¼‰ï¼Œé‚£ä¹ˆåˆ†åŒºæ•°å°±å†³å®šäº†reduceç«¯çš„taskçš„ä¸ªæ•°ã€‚</strong></font></p><h3 id="Reduceç«¯æ•°æ®çš„è¯»å–"><a href="#Reduceç«¯æ•°æ®çš„è¯»å–" class="headerlink" title="Reduceç«¯æ•°æ®çš„è¯»å–"></a>Reduceç«¯æ•°æ®çš„è¯»å–</h3><p>æ ¹æ®stageçš„åˆ’åˆ†æˆ‘ä»¬çŸ¥é“ï¼Œmapç«¯taskå’Œreduceç«¯taskä¸åœ¨ç›¸åŒçš„stageä¸­ï¼Œmap taskä½äºShuffleMapStageï¼Œreduce taskä½äºResultStageï¼Œmap taskä¼šå…ˆæ‰§è¡Œï¼Œé‚£ä¹ˆåæ‰§è¡Œçš„reduce taskå¦‚ä½•çŸ¥é“ä»å“ªé‡Œå»æ‹‰å–map taskè½ç›˜åçš„æ•°æ®å‘¢ï¼Ÿ</p><p>reduceç«¯çš„æ•°æ®æ‹‰å–è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li>map task æ‰§è¡Œå®Œæ¯•åä¼šå°†è®¡ç®—çŠ¶æ€ä»¥åŠç£ç›˜å°æ–‡ä»¶ä½ç½®ç­‰ä¿¡æ¯å°è£…åˆ°MapStatuså¯¹è±¡ä¸­ï¼Œç„¶åç”±æœ¬è¿›ç¨‹ä¸­çš„MapOutPutTrackerWorkerå¯¹è±¡å°†mapStatuså¯¹è±¡å‘é€ç»™Driverè¿›ç¨‹çš„MapOutPutTrackerMasterå¯¹è±¡ï¼›</li><li>åœ¨reduce taskå¼€å§‹æ‰§è¡Œä¹‹å‰ä¼šå…ˆè®©æœ¬è¿›ç¨‹ä¸­çš„MapOutputTrackerWorkerå‘Driverè¿›ç¨‹ä¸­çš„MapoutPutTrakcerMasterå‘åŠ¨è¯·æ±‚ï¼Œè¯·æ±‚ç£ç›˜å°æ–‡ä»¶ä½ç½®ä¿¡æ¯ï¼›</li><li> å½“æ‰€æœ‰çš„Map taskæ‰§è¡Œå®Œæ¯•åï¼ŒDriverè¿›ç¨‹ä¸­çš„MapOutPutTrackerMasterå°±æŒæ¡äº†æ‰€æœ‰çš„ç£ç›˜å°æ–‡ä»¶çš„ä½ç½®ä¿¡æ¯ã€‚æ­¤æ—¶MapOutPutTrackerMasterä¼šå‘Šè¯‰MapOutPutTrackerWorkerç£ç›˜å°æ–‡ä»¶çš„ä½ç½®ä¿¡æ¯ï¼›</li><li>å®Œæˆä¹‹å‰çš„æ“ä½œä¹‹åï¼Œç”±BlockTransforServiceå»Executor0æ‰€åœ¨çš„èŠ‚ç‚¹æ‹‰æ•°æ®ï¼Œé»˜è®¤ä¼šå¯åŠ¨äº”ä¸ªå­çº¿ç¨‹ã€‚æ¯æ¬¡æ‹‰å–çš„æ•°æ®é‡ä¸èƒ½è¶…è¿‡48Mï¼ˆreduce taskæ¯æ¬¡æœ€å¤šæ‹‰å–48Mæ•°æ®ï¼Œå°†æ‹‰æ¥çš„æ•°æ®å­˜å‚¨åˆ°Executorå†…å­˜çš„20%å†…å­˜ä¸­ï¼‰ã€‚</li></ol><h2 id="HashShuffle"><a href="#HashShuffle" class="headerlink" title="HashShuffle"></a>HashShuffle</h2><p>ä»¥ä¸‹çš„è®¨è®ºéƒ½å‡è®¾æ¯ä¸ªExecutoræœ‰1ä¸ªCPU coreã€‚</p><h3 id="æœªç»ä¼˜åŒ–çš„HashShuffleManager"><a href="#æœªç»ä¼˜åŒ–çš„HashShuffleManager" class="headerlink" title="æœªç»ä¼˜åŒ–çš„HashShuffleManager"></a>æœªç»ä¼˜åŒ–çš„HashShuffleManager</h3><p>é»˜è®¤shuffleå‰ååˆ†åŒºæ˜¯ä¸å˜çš„ï¼Œæ‰€ä»¥æ²¡æœ‰ä¼˜åŒ–åçš„HashShuffleManageræ¯ä¸ªTaskä»»åŠ¡éƒ½ä¼šç”Ÿæˆnä¸ªæ–‡ä»¶ï¼Œnæ˜¯åˆ†åŒºæ•°ï¼Œä½†æ˜¯è¿™æ ·ç”Ÿæˆçš„æ–‡ä»¶å¤ªå¤šï¼Œæ•ˆç‡å¤ªæ…¢</p><p>shuffle writeé˜¶æ®µï¼Œä¸»è¦å°±æ˜¯åœ¨ä¸€ä¸ªstageç»“æŸè®¡ç®—ä¹‹åï¼Œä¸ºäº†ä¸‹ä¸€ä¸ªstageå¯ä»¥æ‰§è¡Œshuffleç±»çš„ç®—å­ï¼ˆæ¯”å¦‚reduceByKeyï¼‰ï¼Œè€Œå°†æ¯ä¸ªtaskå¤„ç†çš„æ•°æ®æŒ‰keyè¿›è¡Œâ€œåˆ’åˆ†â€ã€‚<font color="red">æ‰€è°“â€œåˆ’åˆ†â€ï¼Œå°±æ˜¯å¯¹ç›¸åŒçš„keyæ‰§è¡Œhashç®—æ³•ï¼Œä»è€Œå°†ç›¸åŒkeyéƒ½å†™å…¥åŒä¸€ä¸ªç£ç›˜æ–‡ä»¶ä¸­ï¼Œè€Œæ¯ä¸€ä¸ªç£ç›˜æ–‡ä»¶éƒ½åªå±äºä¸‹æ¸¸stageçš„ä¸€ä¸ªtaskã€‚</font>åœ¨å°†æ•°æ®å†™å…¥ç£ç›˜ä¹‹å‰ï¼Œä¼šå…ˆå°†æ•°æ®å†™å…¥å†…å­˜ç¼“å†²ä¸­ï¼Œå½“å†…å­˜ç¼“å†²å¡«æ»¡ä¹‹åï¼Œæ‰ä¼šæº¢å†™åˆ°ç£ç›˜æ–‡ä»¶ä¸­å»ã€‚</p><p><font color="red"><strong>ä¸‹ä¸€ä¸ªstageçš„taskæœ‰å¤šå°‘ä¸ªï¼Œå½“å‰stageçš„æ¯ä¸ªtaskå°±è¦åˆ›å»ºå¤šå°‘ä»½ç£ç›˜æ–‡ä»¶ã€‚</strong></font>æ¯”å¦‚ä¸‹ä¸€ä¸ªstageæ€»å…±æœ‰100ä¸ªtaskï¼Œé‚£ä¹ˆå½“å‰stageçš„æ¯ä¸ªtaskéƒ½è¦åˆ›å»º100ä»½ç£ç›˜æ–‡ä»¶ã€‚å¦‚æœå½“å‰stageæœ‰50ä¸ªtaskï¼Œæ€»å…±æœ‰10ä¸ªExecutorï¼Œæ¯ä¸ªExecutoræ‰§è¡Œ5ä¸ªtaskï¼Œé‚£ä¹ˆæ¯ä¸ªExecutorä¸Šæ€»å…±å°±è¦åˆ›å»º500ä¸ªç£ç›˜æ–‡ä»¶ï¼Œæ‰€æœ‰Executorä¸Šä¼šåˆ›å»º5000ä¸ªç£ç›˜æ–‡ä»¶ã€‚ç”±æ­¤å¯è§ï¼Œæœªç»ä¼˜åŒ–çš„shuffle writeæ“ä½œæ‰€äº§ç”Ÿçš„ç£ç›˜æ–‡ä»¶çš„æ•°é‡æ˜¯æå…¶æƒŠäººçš„ã€‚</p><p>shuffle readé˜¶æ®µï¼Œé€šå¸¸å°±æ˜¯ä¸€ä¸ªstageåˆšå¼€å§‹æ—¶è¦åšçš„äº‹æƒ…ã€‚<font color="red">æ­¤æ—¶è¯¥stageçš„æ¯ä¸€ä¸ªtaskå°±éœ€è¦å°†ä¸Šä¸€ä¸ªstageçš„è®¡ç®—ç»“æœä¸­çš„æ‰€æœ‰ç›¸åŒkeyï¼Œä»å„ä¸ªèŠ‚ç‚¹ä¸Šé€šè¿‡ç½‘ç»œéƒ½æ‹‰å–åˆ°è‡ªå·±æ‰€åœ¨çš„èŠ‚ç‚¹ä¸Šï¼Œç„¶åè¿›è¡Œkeyçš„èšåˆæˆ–è¿æ¥ç­‰æ“ä½œã€‚</font>ç”±äºshuffle writeçš„è¿‡ç¨‹ä¸­ï¼Œmap taskç»™ä¸‹æ¸¸stageçš„æ¯ä¸ªreduce taskéƒ½åˆ›å»ºäº†ä¸€ä¸ªç£ç›˜æ–‡ä»¶ï¼Œå› æ­¤shuffle readçš„è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªreduce taskåªè¦ä»ä¸Šæ¸¸stageçš„æ‰€æœ‰map taskæ‰€åœ¨èŠ‚ç‚¹ä¸Šï¼Œæ‹‰å–å±äºè‡ªå·±çš„é‚£ä¸€ä¸ªç£ç›˜æ–‡ä»¶å³å¯ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200831213230836.png" alt="image-20200831213230836"></p><h3 id="ä¼˜åŒ–åçš„HashShuffleManager"><a href="#ä¼˜åŒ–åçš„HashShuffleManager" class="headerlink" title="ä¼˜åŒ–åçš„HashShuffleManager"></a>ä¼˜åŒ–åçš„HashShuffleManager</h3><p>ä¸ºäº†ä¼˜åŒ–HashShuffleManageræˆ‘ä»¬å¯ä»¥è®¾ç½®ä¸€ä¸ªå‚æ•°ï¼Œspark.shuffle. consolidateFilesï¼Œè¯¥å‚æ•°é»˜è®¤å€¼ä¸ºfalseï¼Œå°†å…¶è®¾ç½®ä¸ºtrueå³å¯å¼€å¯ä¼˜åŒ–æœºåˆ¶ï¼Œé€šå¸¸æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨HashShuffleManagerï¼Œé‚£ä¹ˆéƒ½å»ºè®®å¼€å¯è¿™ä¸ªé€‰é¡¹ã€‚</p><p>å¼€å¯consolidateæœºåˆ¶ä¹‹åï¼Œåœ¨shuffle writeè¿‡ç¨‹ä¸­ï¼Œtaskå°±ä¸æ˜¯ä¸ºä¸‹æ¸¸stageçš„æ¯ä¸ªtaskåˆ›å»ºä¸€ä¸ªç£ç›˜æ–‡ä»¶äº†ï¼Œæ­¤æ—¶ä¼šå‡ºç°<strong>shuffleFileGroup</strong>çš„æ¦‚å¿µï¼Œ<font color="red">æ¯ä¸ªshuffleFileGroupä¼šå¯¹åº”ä¸€æ‰¹ç£ç›˜æ–‡ä»¶ï¼Œç£ç›˜æ–‡ä»¶çš„æ•°é‡ä¸ä¸‹æ¸¸stageçš„taskæ•°é‡æ˜¯ç›¸åŒçš„ã€‚</font>ä¸€ä¸ªExecutorä¸Šæœ‰å¤šå°‘ä¸ªCPU coreï¼Œå°±å¯ä»¥å¹¶è¡Œæ‰§è¡Œå¤šå°‘ä¸ªtaskã€‚è€Œç¬¬ä¸€æ‰¹å¹¶è¡Œæ‰§è¡Œçš„æ¯ä¸ªtaskéƒ½ä¼šåˆ›å»ºä¸€ä¸ªshuffleFileGroupï¼Œå¹¶å°†æ•°æ®å†™å…¥å¯¹åº”çš„ç£ç›˜æ–‡ä»¶å†…ã€‚</p><p>å½“Executorçš„CPU coreæ‰§è¡Œå®Œä¸€æ‰¹taskï¼Œ<font color="red">æ¥ç€æ‰§è¡Œä¸‹ä¸€æ‰¹taskæ—¶ï¼Œä¸‹ä¸€æ‰¹taskå°±ä¼šå¤ç”¨ä¹‹å‰å·²æœ‰çš„shuffleFileGroupï¼ŒåŒ…æ‹¬å…¶ä¸­çš„ç£ç›˜æ–‡ä»¶ï¼Œ</font>ä¹Ÿå°±æ˜¯è¯´ï¼Œæ­¤æ—¶taskä¼šå°†æ•°æ®å†™å…¥å·²æœ‰çš„ç£ç›˜æ–‡ä»¶ä¸­ï¼Œè€Œä¸ä¼šå†™å…¥æ–°çš„ç£ç›˜æ–‡ä»¶ä¸­ã€‚å› æ­¤ï¼Œconsolidateæœºåˆ¶å…è®¸ä¸åŒçš„taskå¤ç”¨åŒä¸€æ‰¹ç£ç›˜æ–‡ä»¶ï¼Œè¿™æ ·å°±å¯ä»¥æœ‰æ•ˆå°†å¤šä¸ªtaskçš„ç£ç›˜æ–‡ä»¶è¿›è¡Œä¸€å®šç¨‹åº¦ä¸Šçš„åˆå¹¶ï¼Œä»è€Œå¤§å¹…åº¦å‡å°‘ç£ç›˜æ–‡ä»¶çš„æ•°é‡ï¼Œè¿›è€Œæå‡shuffle writeçš„æ€§èƒ½ã€‚</p><p>ä¹Ÿå°±æ˜¯Executorçš„æ¯ä¸ªæ ¸coreä¼šåˆ›å»ºnä¸ªæ–‡ä»¶ï¼Œnæ˜¯ä¸‹ä¸ªstageçš„å¹¶è¡Œåº¦ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200831213702651.png" alt="image-20200831213702651"></p><h2 id="SortShuffleè§£æğŸ”º"><a href="#SortShuffleè§£æğŸ”º" class="headerlink" title="SortShuffleè§£æğŸ”º"></a>SortShuffleè§£æğŸ”º</h2><p>SortShuffleManagerçš„è¿è¡Œæœºåˆ¶ä¸»è¦åˆ†æˆä¸¤ç§ï¼Œ<strong>ä¸€ç§æ˜¯æ™®é€šè¿è¡Œæœºåˆ¶ï¼Œå¦ä¸€ç§æ˜¯bypassè¿è¡Œæœºåˆ¶ã€‚</strong><font color="red">å½“shuffle read taskçš„æ•°é‡å°äºç­‰äºspark.shuffle.sort. bypassMergeThresholdå‚æ•°çš„å€¼æ—¶ï¼ˆé»˜è®¤ä¸º200ï¼‰ï¼Œå°±ä¼šå¯ç”¨bypassæœºåˆ¶ã€‚</font></p><h3 id="æ™®é€šè¿è¡Œæœºåˆ¶"><a href="#æ™®é€šè¿è¡Œæœºåˆ¶" class="headerlink" title="æ™®é€šè¿è¡Œæœºåˆ¶"></a>æ™®é€šè¿è¡Œæœºåˆ¶</h3><p>åœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œ<font color="red">æ•°æ®ä¼šå…ˆå†™å…¥ä¸€ä¸ªå†…å­˜æ•°æ®ç»“æ„ä¸­ï¼Œ</font>æ­¤æ—¶æ ¹æ®ä¸åŒçš„shuffleç®—å­ï¼Œå¯èƒ½é€‰ç”¨ä¸åŒçš„æ•°æ®ç»“æ„ã€‚<strong>å¦‚æœæ˜¯reduceByKeyè¿™ç§èšåˆç±»çš„shuffleç®—å­ï¼Œé‚£ä¹ˆä¼šé€‰ç”¨Mapæ•°æ®ç»“æ„</strong>ï¼Œä¸€è¾¹é€šè¿‡Mapè¿›è¡Œèšåˆï¼Œä¸€è¾¹å†™å…¥å†…å­˜ï¼›<strong>å¦‚æœæ˜¯joinè¿™ç§æ™®é€šçš„shuffleç®—å­ï¼Œé‚£ä¹ˆä¼šé€‰ç”¨Arrayæ•°æ®ç»“æ„</strong>ï¼Œç›´æ¥å†™å…¥å†…å­˜ã€‚æ¥ç€ï¼Œæ¯å†™ä¸€æ¡æ•°æ®è¿›å…¥å†…å­˜æ•°æ®ç»“æ„ä¹‹åï¼Œå°±ä¼šåˆ¤æ–­ä¸€ä¸‹ï¼Œæ˜¯å¦è¾¾åˆ°äº†æŸä¸ªä¸´ç•Œé˜ˆå€¼ã€‚<strong>å¦‚æœè¾¾åˆ°ä¸´ç•Œé˜ˆå€¼çš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šå°è¯•å°†å†…å­˜æ•°æ®ç»“æ„ä¸­çš„æ•°æ®æº¢å†™åˆ°ç£ç›˜ï¼Œç„¶åæ¸…ç©ºå†…å­˜æ•°æ®ç»“æ„ã€‚</strong></p><p><font color="red">åœ¨æº¢å†™åˆ°ç£ç›˜æ–‡ä»¶ä¹‹å‰ï¼Œä¼šå…ˆæ ¹æ®keyå¯¹å†…å­˜æ•°æ®ç»“æ„ä¸­å·²æœ‰çš„æ•°æ®è¿›è¡Œæ’åºã€‚æ’åºè¿‡åï¼Œä¼šåˆ†æ‰¹å°†æ•°æ®å†™å…¥ç£ç›˜æ–‡ä»¶ã€‚</font>é»˜è®¤çš„batchæ•°é‡æ˜¯10000æ¡ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ’åºå¥½çš„æ•°æ®ï¼Œä¼šä»¥æ¯æ‰¹1ä¸‡æ¡æ•°æ®çš„å½¢å¼åˆ†æ‰¹å†™å…¥ç£ç›˜æ–‡ä»¶ã€‚å†™å…¥ç£ç›˜æ–‡ä»¶æ˜¯é€šè¿‡Javaçš„BufferedOutputStreamå®ç°çš„ã€‚BufferedOutputStreamæ˜¯Javaçš„ç¼“å†²è¾“å‡ºæµï¼Œé¦–å…ˆä¼šå°†æ•°æ®ç¼“å†²åœ¨å†…å­˜ä¸­ï¼Œå½“å†…å­˜ç¼“å†²æ»¡æº¢ä¹‹åå†ä¸€æ¬¡å†™å…¥ç£ç›˜æ–‡ä»¶ä¸­ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ç£ç›˜IOæ¬¡æ•°ï¼Œæå‡æ€§èƒ½ã€‚</p><p><font color="red">ä¸€ä¸ªtaskå°†æ‰€æœ‰æ•°æ®å†™å…¥å†…å­˜æ•°æ®ç»“æ„çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå‘ç”Ÿå¤šæ¬¡ç£ç›˜æº¢å†™æ“ä½œï¼Œä¹Ÿå°±ä¼šäº§ç”Ÿå¤šä¸ªä¸´æ—¶æ–‡ä»¶ã€‚æœ€åä¼šå°†ä¹‹å‰æ‰€æœ‰çš„ä¸´æ—¶ç£ç›˜æ–‡ä»¶éƒ½è¿›è¡Œåˆå¹¶ï¼Œè¿™å°±æ˜¯mergeè¿‡ç¨‹ï¼Œæ­¤æ—¶ä¼šå°†ä¹‹å‰æ‰€æœ‰ä¸´æ—¶ç£ç›˜æ–‡ä»¶ä¸­çš„æ•°æ®è¯»å–å‡ºæ¥ï¼Œç„¶åä¾æ¬¡å†™å…¥æœ€ç»ˆçš„ç£ç›˜æ–‡ä»¶ä¹‹ä¸­ã€‚</font>æ­¤å¤–ï¼Œç”±äºä¸€ä¸ªtaskå°±åªå¯¹åº”ä¸€ä¸ªç£ç›˜æ–‡ä»¶ï¼Œ<strong>ä¹Ÿå°±æ„å‘³ç€è¯¥taskä¸ºä¸‹æ¸¸stageçš„taskå‡†å¤‡çš„æ•°æ®éƒ½åœ¨è¿™ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œå› æ­¤è¿˜ä¼šå•ç‹¬å†™ä¸€ä»½ç´¢å¼•æ–‡ä»¶</strong>ï¼Œå…¶ä¸­æ ‡è¯†äº†ä¸‹æ¸¸å„ä¸ªtaskçš„æ•°æ®åœ¨æ–‡ä»¶ä¸­çš„start offsetä¸end offsetã€‚</p><p>è¿™ä¸Kafkaä¸­çš„Partitionçš„ç´¢å¼•æ–‡ä»¶ã€æ—¥å¿—æ–‡ä»¶æ€æƒ³ç±»ä¼¼ï¼Œé€šè¿‡ç´¢å¼•æ¥ä½¿æ–‡ä»¶è¯»å–åŠ å¿«</p><p>æ™®é€šè¿è¡Œæœºåˆ¶çš„SortShuffleManagerå·¥ä½œåŸç†å¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200831214716757.png" alt="image-20200831214716757"></p><p><font color="red">*<em>æ€»ç»“æ¥è¯´ï¼Œæœ‰å‡ ä¸ªå¹¶è¡Œä»»åŠ¡å°±æœ‰å‡ ä¸ªæ–‡ä»¶ï¼Œç›¸å¯¹äºä¼˜åŒ–åçš„HashShuffleManagerï¼Œå®ƒæ˜¯æœ‰å‡ ä¸ªæ ¸å¿ƒï¼Œæ—¢æœ‰å‡ ä¸ªæ ¸å¿ƒ</em>å¹¶è¡Œåº¦ï¼ˆä¸»è¦å–å†³äºå¹¶è¡Œåº¦ï¼‰çš„æ–‡ä»¶ã€‚**</font></p><h3 id="ByPassæœºåˆ¶"><a href="#ByPassæœºåˆ¶" class="headerlink" title="ByPassæœºåˆ¶"></a>ByPassæœºåˆ¶</h3><p>bypassè¿è¡Œæœºåˆ¶çš„è§¦å‘æ¡ä»¶å¦‚ä¸‹ï¼š</p><ul><li>shuffle map taskæ•°é‡å°äºspark.shuffle.sort.bypassMergeThresholdå‚æ•°çš„å€¼ã€‚</li><li>ä¸æ˜¯èšåˆç±»çš„shuffleç®—å­ã€‚</li></ul><p>æ­¤æ—¶ï¼Œæ¯ä¸ªtaskä¼šä¸ºæ¯ä¸ªä¸‹æ¸¸taskéƒ½åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç£ç›˜æ–‡ä»¶ï¼Œå¹¶å°†æ•°æ®æŒ‰keyè¿›è¡Œhashç„¶åæ ¹æ®keyçš„hashå€¼ï¼Œå°†keyå†™å…¥å¯¹åº”çš„ç£ç›˜æ–‡ä»¶ä¹‹ä¸­ã€‚å½“ç„¶ï¼Œå†™å…¥ç£ç›˜æ–‡ä»¶æ—¶ä¹Ÿæ˜¯å…ˆå†™å…¥å†…å­˜ç¼“å†²ï¼Œç¼“å†²å†™æ»¡ä¹‹åå†æº¢å†™åˆ°ç£ç›˜æ–‡ä»¶çš„ã€‚æœ€åï¼ŒåŒæ ·ä¼šå°†æ‰€æœ‰ä¸´æ—¶ç£ç›˜æ–‡ä»¶éƒ½åˆå¹¶æˆä¸€ä¸ªç£ç›˜æ–‡ä»¶ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ç´¢å¼•æ–‡ä»¶ã€‚</p><p><font color="red">è¯¥è¿‡ç¨‹çš„ç£ç›˜å†™æœºåˆ¶å…¶å®è·Ÿæœªç»ä¼˜åŒ–çš„HashShuffleManageræ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œå› ä¸ºéƒ½è¦åˆ›å»ºæ•°é‡æƒŠäººçš„ç£ç›˜æ–‡ä»¶ï¼Œåªæ˜¯åœ¨æœ€åä¼šåšä¸€ä¸ªç£ç›˜æ–‡ä»¶çš„åˆå¹¶è€Œå·²ã€‚</font>å› æ­¤å°‘é‡çš„æœ€ç»ˆç£ç›˜æ–‡ä»¶ï¼Œä¹Ÿè®©è¯¥æœºåˆ¶ç›¸å¯¹æœªç»ä¼˜åŒ–çš„HashShuffleManageræ¥è¯´ï¼Œshuffle readçš„æ€§èƒ½ä¼šæ›´å¥½ã€‚</p><p>è€Œè¯¥æœºåˆ¶ä¸æ™®é€šSortShuffleManagerè¿è¡Œæœºåˆ¶çš„ä¸åŒåœ¨äºï¼š</p><ol><li>ç¬¬ä¸€ï¼Œ<strong>ç£ç›˜å†™æœºåˆ¶ä¸åŒï¼›</strong></li><li>ç¬¬äºŒï¼Œ<strong>ä¸ä¼šè¿›è¡Œæ’åºã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯ç”¨è¯¥æœºåˆ¶çš„æœ€å¤§å¥½å¤„åœ¨äºï¼Œshuffle writeè¿‡ç¨‹ä¸­ï¼Œä¸éœ€è¦è¿›è¡Œæ•°æ®çš„æ’åºæ“ä½œï¼Œä¹Ÿå°±èŠ‚çœæ‰äº†è¿™éƒ¨åˆ†çš„æ€§èƒ½å¼€é”€ã€‚</strong></li></ol><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200831214852355.png" alt="image-20200831214852355"></p><h1 id="Sparkå†…å­˜ç®¡ç†"><a href="#Sparkå†…å­˜ç®¡ç†" class="headerlink" title="Sparkå†…å­˜ç®¡ç†"></a>Sparkå†…å­˜ç®¡ç†</h1><p>åœ¨æ‰§è¡ŒSpark çš„åº”ç”¨ç¨‹åºæ—¶ï¼ŒSpark é›†ç¾¤ä¼šå¯åŠ¨ Driver å’Œ Executor ä¸¤ç§ JVM è¿›ç¨‹ï¼Œå‰è€…ä¸ºä¸»æ§è¿›ç¨‹ï¼Œè´Ÿè´£åˆ›å»º Spark ä¸Šä¸‹æ–‡ï¼Œæäº¤ Spark ä½œä¸šï¼ˆJobï¼‰ï¼Œå¹¶å°†ä½œä¸šè½¬åŒ–ä¸ºè®¡ç®—ä»»åŠ¡ï¼ˆTaskï¼‰ï¼Œåœ¨å„ä¸ª Executor è¿›ç¨‹é—´åè°ƒä»»åŠ¡çš„è°ƒåº¦ï¼Œåè€…è´Ÿè´£åœ¨å·¥ä½œèŠ‚ç‚¹ä¸Šæ‰§è¡Œå…·ä½“çš„è®¡ç®—ä»»åŠ¡ï¼Œå¹¶å°†ç»“æœè¿”å›ç»™ Driverï¼ŒåŒæ—¶ä¸ºéœ€è¦æŒä¹…åŒ–çš„ RDD æä¾›å­˜å‚¨åŠŸèƒ½ã€‚ç”±äº Driver çš„å†…å­˜ç®¡ç†ç›¸å¯¹æ¥è¯´è¾ƒä¸ºç®€å•ï¼Œæœ¬èŠ‚ä¸»è¦å¯¹ Executor çš„å†…å­˜ç®¡ç†è¿›è¡Œåˆ†æï¼Œä¸‹æ–‡ä¸­çš„ Spark å†…å­˜å‡ç‰¹æŒ‡ Executor çš„å†…å­˜ã€‚</p><h2 id="å†…å­˜ç©ºé—´åˆ†é…"><a href="#å†…å­˜ç©ºé—´åˆ†é…" class="headerlink" title="å†…å­˜ç©ºé—´åˆ†é…"></a>å†…å­˜ç©ºé—´åˆ†é…</h2><h3 id="ç»Ÿä¸€å†…å­˜ç®¡ç†"><a href="#ç»Ÿä¸€å†…å­˜ç®¡ç†" class="headerlink" title="ç»Ÿä¸€å†…å­˜ç®¡ç†"></a>ç»Ÿä¸€å†…å­˜ç®¡ç†</h3><p>Spark 1.6 ä¹‹åå¼•å…¥çš„ç»Ÿä¸€å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œå­˜å‚¨å†…å­˜å’Œæ‰§è¡Œå†…å­˜å…±äº«åŒä¸€å—ç©ºé—´ï¼Œå¯ä»¥åŠ¨æ€å ç”¨å¯¹æ–¹çš„ç©ºé—²åŒºåŸŸï¼Œç»Ÿä¸€å†…å­˜ç®¡ç†çš„å †å†…å†…å­˜ç»“æ„å¦‚å›¾æ‰€ç¤ºï¼š</p><p><strong>å †å¤–å†…å­˜</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200831215139324.png" alt="image-20200831215139324"></p><p><strong>å †å†…å†…å­˜</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200831215144277.png" alt="image-20200831215144277"></p><ul><li>storageï¼šå­˜å‚¨RDDç¼“å­˜</li><li>Executorï¼šè¿›è¡Œè®¡ç®—éœ€è¦çš„å†…å­˜</li><li>Otherï¼šç”¨æˆ·è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„å’Œæœªç¼“å­˜çš„RDD</li></ul><p><font color="red">å…¶ä¸­æœ€é‡è¦çš„ä¼˜åŒ–åœ¨äºåŠ¨æ€å ç”¨æœºåˆ¶ï¼Œå…¶è§„åˆ™å¦‚ä¸‹ï¼š</font></p><ol><li>   è®¾å®šåŸºæœ¬çš„å­˜å‚¨å†…å­˜å’Œæ‰§è¡Œå†…å­˜åŒºåŸŸï¼ˆspark.storage.storageFraction å‚æ•°ï¼‰ï¼Œè¯¥è®¾å®šç¡®å®šäº†åŒæ–¹å„è‡ªæ‹¥æœ‰çš„ç©ºé—´çš„èŒƒå›´ï¼›</li><li>   åŒæ–¹çš„ç©ºé—´éƒ½ä¸è¶³æ—¶ï¼Œåˆ™å­˜å‚¨åˆ°ç¡¬ç›˜ï¼›è‹¥å·±æ–¹ç©ºé—´ä¸è¶³è€Œå¯¹æ–¹ç©ºä½™æ—¶ï¼Œå¯å€Ÿç”¨å¯¹æ–¹çš„ç©ºé—´;ï¼ˆå­˜å‚¨ç©ºé—´ä¸è¶³æ˜¯æŒ‡ä¸è¶³ä»¥æ”¾ä¸‹ä¸€ä¸ªå®Œæ•´çš„ Blockï¼‰</li><li>   <strong>æ‰§è¡Œå†…å­˜çš„ç©ºé—´è¢«å¯¹æ–¹å ç”¨åï¼Œå¯è®©å¯¹æ–¹å°†å ç”¨çš„éƒ¨åˆ†è½¬å­˜åˆ°ç¡¬ç›˜ï¼Œç„¶åâ€å½’è¿˜â€å€Ÿç”¨çš„ç©ºé—´ï¼›</strong></li><li>   <strong>å­˜å‚¨å†…å­˜çš„ç©ºé—´è¢«å¯¹æ–¹å ç”¨åï¼Œæ— æ³•è®©å¯¹æ–¹â€å½’è¿˜â€ï¼Œå› ä¸ºéœ€è¦è€ƒè™‘ Shuffle è¿‡ç¨‹ä¸­çš„å¾ˆå¤šå› ç´ ï¼Œå®ç°èµ·æ¥è¾ƒä¸ºå¤æ‚ã€‚</strong></li></ol><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200831215719557.png" alt="image-20200831215719557"></p><p><font color="red"></font></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Spark-å†…æ ¸æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#Spark-å†…æ ¸æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;Spark å†…æ ¸æ¦‚è¿°&quot;&gt;&lt;/a&gt;Spark å†…æ ¸æ¦‚è¿°&lt;/h1&gt;&lt;p&gt;Sparkå†…æ ¸æ³›æŒ‡Sparkçš„æ ¸å¿ƒè¿è¡Œæœºåˆ¶ï¼ŒåŒ…æ‹¬&lt;strong&gt;Sparkæ ¸</summary>
      
    
    
    
    <category term="Spark" scheme="https://awslzhang.top/categories/Spark/"/>
    
    
    <category term="Spark" scheme="https://awslzhang.top/tags/Spark/"/>
    
  </entry>
  
  <entry>
    <title>sparkå­¦ä¹ ç¬”è®°-SparkStreaming</title>
    <link href="https://awslzhang.top/2020/08/26/spark%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-SparkStreaming/"/>
    <id>https://awslzhang.top/2020/08/26/spark%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-SparkStreaming/</id>
    <published>2020-08-26T14:09:19.000Z</published>
    <updated>2021-01-01T05:50:00.043Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Spark-Streamingæ¦‚è¿°"><a href="#Spark-Streamingæ¦‚è¿°" class="headerlink" title="Spark Streamingæ¦‚è¿°"></a>Spark Streamingæ¦‚è¿°</h1><h2 id="Spark-Streamingæ˜¯ä»€ä¹ˆ"><a href="#Spark-Streamingæ˜¯ä»€ä¹ˆ" class="headerlink" title="Spark Streamingæ˜¯ä»€ä¹ˆ"></a>Spark Streamingæ˜¯ä»€ä¹ˆ</h2><p>Spark Streamingç”¨äºæµå¼æ•°æ®çš„å¤„ç†ã€‚Spark Streamingæ”¯æŒçš„æ•°æ®è¾“å…¥æºå¾ˆå¤šï¼Œ<font color="red">ä¾‹å¦‚ï¼šKafkaã€Flumeã€Twitterã€ZeroMQå’Œç®€å•çš„TCPå¥—æ¥å­—ç­‰ç­‰</font>ã€‚æ•°æ®è¾“å…¥åå¯ä»¥ç”¨Sparkçš„é«˜åº¦æŠ½è±¡åŸè¯­å¦‚ï¼š<strong>mapã€reduceã€joinã€windowç­‰è¿›è¡Œè¿ç®—</strong>ã€‚è€Œç»“æœä¹Ÿèƒ½ä¿å­˜åœ¨å¾ˆå¤šåœ°æ–¹ï¼Œ<strong>å¦‚HDFSï¼Œæ•°æ®åº“</strong>ç­‰ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200828193447365.png" alt="image-20200828193447365"></p><p>å’ŒSparkåŸºäºRDDçš„æ¦‚å¿µå¾ˆç›¸ä¼¼ï¼ŒSpark Streamingä½¿ç”¨<font color="red">ç¦»æ•£åŒ–æµ(discretized stream)</font>ä½œä¸ºæŠ½è±¡è¡¨ç¤ºï¼Œå«ä½œDStreamã€‚DStream æ˜¯éšæ—¶é—´æ¨ç§»è€Œæ”¶åˆ°çš„æ•°æ®çš„åºåˆ—ã€‚åœ¨å†…éƒ¨ï¼Œ<strong>æ¯ä¸ªæ—¶é—´åŒºé—´æ”¶åˆ°çš„æ•°æ®éƒ½ä½œä¸º RDD å­˜åœ¨</strong>ï¼Œè€ŒDStreamæ˜¯ç”±è¿™äº›RDDæ‰€ç»„æˆçš„åºåˆ—(å› æ­¤å¾—åâ€œ<strong>ç¦»æ•£åŒ–</strong>â€)ã€‚</p><p><font color="red"><strong>æ³¨æ„</strong>ï¼šç¦»æ•£åŒ–çš„åä¹‰è¯å°±æ˜¯è¿ç»­ï¼Œè¿™è¯æ˜SparkStreamingå¹¶ä¸æ˜¯çœŸæ­£çš„å®æ—¶å¤„ç†(æ¥ä¸€æ¡è®¡ç®—ä¸€æ¡)ï¼Œè€Œæ˜¯æ¯æ¬¡è®¡ç®—å°æ‰¹é‡çš„æ•°æ®ï¼Œå°æ‰¹é‡çš„æ•°æ®å€¼å¾—å°±æ˜¯ä¸€å®šé‡‡é›†å‘¨æœŸä¹‹å†…çš„æ•°æ®ã€‚</font></p><h1 id="DStreamå…¥é—¨"><a href="#DStreamå…¥é—¨" class="headerlink" title="DStreamå…¥é—¨"></a>DStreamå…¥é—¨</h1><p><code>DStream</code>æ˜¯SparkStreamingè®¡ç®—çš„æŠ½è±¡ã€‚ä¾‹å¦‚ï¼šSpark Coreè®¡ç®—ä¸­çš„RDDï¼ŒSparkSQLä¸­çš„DSã€DFã€‚</p><h2 id="æ— çŠ¶æ€çš„WordCountæ¡ˆä¾‹å®æ“"><a href="#æ— çŠ¶æ€çš„WordCountæ¡ˆä¾‹å®æ“" class="headerlink" title="æ— çŠ¶æ€çš„WordCountæ¡ˆä¾‹å®æ“"></a>æ— çŠ¶æ€çš„WordCountæ¡ˆä¾‹å®æ“</h2><p>éœ€æ±‚ï¼šä½¿ç”¨netcatå·¥å…·å‘9999ç«¯å£ä¸æ–­çš„å‘é€æ•°æ®ï¼Œé€šè¿‡SparkStreamingè¯»å–ç«¯å£æ•°æ®å¹¶ç»Ÿè®¡ä¸åŒå•è¯å‡ºç°çš„æ¬¡æ•°</p><p><strong>pom</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-streaming_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>scala</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">WordCount</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.åˆ›å»ºSparkConfå¹¶è®¾ç½®Appåç§°</span></span><br><span class="line">    <span class="keyword">val</span> conf: <span class="type">SparkConf</span> = <span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">&quot;WC&quot;</span>).setMaster(<span class="string">&quot;local[*]&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.åˆå§‹åŒ–SparkStreamingContext</span></span><br><span class="line">    <span class="keyword">val</span> ssc = <span class="keyword">new</span> <span class="type">StreamingContext</span>(conf, <span class="type">Seconds</span>(<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.é€šè¿‡ç›‘æ§ç«¯å£åˆ›å»ºDStreamï¼Œè¯»è¿›æ¥çš„æ•°æ®ä¸ºä¸€è¡Œè¡Œ</span></span><br><span class="line">    <span class="keyword">val</span> lineStreams: <span class="type">ReceiverInputDStream</span>[<span class="type">String</span>] = ssc.socketTextStream(<span class="string">&quot;192.168.0.201&quot;</span>, <span class="number">9999</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†æ¯ä¸€è¡Œæ•°æ®åšåˆ‡åˆ†ï¼Œå½¢æˆä¸€ä¸ªä¸ªå•è¯</span></span><br><span class="line">    <span class="keyword">val</span> wordStreams: <span class="type">DStream</span>[<span class="type">String</span>] = lineStreams.flatMap(_.split(<span class="string">&quot; &quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†å•è¯æ˜ å°„æˆå…ƒç»„ï¼ˆword,1ï¼‰</span></span><br><span class="line">    <span class="keyword">val</span> wordAndOneStreams: <span class="type">DStream</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = wordStreams.map((_, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†ç›¸åŒçš„å•è¯æ¬¡æ•°åšç»Ÿè®¡</span></span><br><span class="line">    <span class="keyword">val</span> wordAndCountStreams: <span class="type">DStream</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = wordAndOneStreams.reduceByKey(_+_)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ‰“å°</span></span><br><span class="line">    wordAndCountStreams.print()</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯åŠ¨SparkStreamingContextçš„æ”¶é›†å™¨ï¼Œæ”¶é›†å™¨å¿…é¡»ä¸€ç›´å¼€å¯ï¼Œæ‰èƒ½æ”¶é›†åˆ°æ•°æ®</span></span><br><span class="line">    ssc.start()</span><br><span class="line">    <span class="comment">// ä¸»ç¨‹åºç­‰å¾…æ”¶é›†å™¨å…³é—­ï¼Œç„¶åä¸»ç¨‹åºå…³é—­</span></span><br><span class="line">    ssc.awaitTermination()</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200828195052616.png" alt="image-20200828195052616"></p><p><font color="red">æ³¨æ„ï¼šå¦‚æœç¨‹åºè¿è¡Œæ—¶ï¼Œlogæ—¥å¿—å¤ªå¤šï¼Œå¯ä»¥å°†spark confç›®å½•ä¸‹çš„log4jæ–‡ä»¶é‡Œé¢çš„æ—¥å¿—çº§åˆ«æ”¹æˆWARNã€‚å¹¶åŠ å…¥åˆ°é¡¹ç›®ä¸­</font></p><hr><p><strong>ç¨‹åºè§£æ</strong></p><p><code>Discretized Stream</code>æ˜¯Spark Streamingçš„åŸºç¡€æŠ½è±¡ï¼Œä»£è¡¨æŒç»­æ€§çš„æ•°æ®æµå’Œç»è¿‡å„ç§SparkåŸè¯­æ“ä½œåçš„ç»“æœæ•°æ®æµã€‚åœ¨å†…éƒ¨å®ç°ä¸Šï¼Œ<strong>DStreamæ˜¯ä¸€ç³»åˆ—è¿ç»­çš„RDDæ¥è¡¨ç¤º</strong>ã€‚æ¯ä¸ªRDDå«æœ‰ä¸€æ®µæ—¶é—´é—´éš”å†…çš„æ•°æ®ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200828195323123.png" alt="image-20200828195323123"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200828195402058.png" alt="image-20200828195402058"></p><h1 id="DStreamåˆ›å»º"><a href="#DStreamåˆ›å»º" class="headerlink" title="DStreamåˆ›å»º"></a>DStreamåˆ›å»º</h1><p>Spark StreamingåŸç”Ÿæ”¯æŒä¸€äº›ä¸åŒçš„æ•°æ®æºã€‚ä¸€äº›â€œæ ¸å¿ƒâ€æ•°æ®æºå·²ç»è¢«æ‰“åŒ…åˆ°<code>Spark Streaming </code>çš„ Maven å·¥ä»¶ä¸­ï¼Œè€Œå…¶ä»–çš„ä¸€äº›åˆ™å¯ä»¥é€šè¿‡<code>spark-streaming-kafka</code>ç­‰é™„åŠ å·¥ä»¶è·å–ã€‚æ¯ä¸ªæ¥æ”¶å™¨éƒ½ä»¥ Spark æ‰§è¡Œå™¨ç¨‹åºä¸­<font color="red"><strong>ä¸€ä¸ªé•¿æœŸè¿è¡Œçš„ä»»åŠ¡çš„å½¢å¼è¿è¡Œï¼Œå› æ­¤ä¼šå æ®åˆ†é…ç»™åº”ç”¨çš„ CPU æ ¸å¿ƒã€‚</strong>æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æœ‰å¯ç”¨çš„ CPU æ ¸å¿ƒæ¥å¤„ç†æ•°æ®ã€‚</font>è¿™æ„å‘³ç€å¦‚æœè¦è¿è¡Œå¤šä¸ªæ¥æ”¶å™¨ï¼Œ<strong>å°±å¿…é¡»è‡³å°‘æœ‰å’Œæ¥æ”¶å™¨æ•°ç›®ç›¸åŒçš„æ ¸å¿ƒæ•°</strong>ï¼Œè¿˜è¦åŠ ä¸Šç”¨æ¥å®Œæˆè®¡ç®—æ‰€éœ€è¦çš„æ ¸å¿ƒæ•°ã€‚</p><p><font color="bule">ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨æµè®¡ç®—åº”ç”¨ä¸­è¿è¡Œ 10 ä¸ªæ¥æ”¶å™¨ï¼Œé‚£ä¹ˆè‡³å°‘éœ€è¦ä¸ºåº”ç”¨åˆ†é… 11 ä¸ª CPU æ ¸å¿ƒã€‚æ‰€ä»¥å¦‚æœåœ¨æœ¬åœ°æ¨¡å¼è¿è¡Œï¼Œ**ä¸è¦ä½¿ç”¨local[1]**ã€‚</font>å› ä¸º1ä¸ªæ ¸å¿ƒæ— æ³•åŒæ—¶æ»¡è¶³æ¥æ”¶å™¨å’Œè®¡ç®—çš„ä»»åŠ¡ã€‚</p><h2 id="æ–‡ä»¶æ•°æ®æº"><a href="#æ–‡ä»¶æ•°æ®æº" class="headerlink" title="æ–‡ä»¶æ•°æ®æº"></a>æ–‡ä»¶æ•°æ®æº</h2><h3 id="ç”¨æ³•åŠè¯´æ˜"><a href="#ç”¨æ³•åŠè¯´æ˜" class="headerlink" title="ç”¨æ³•åŠè¯´æ˜"></a>ç”¨æ³•åŠè¯´æ˜</h3><p>æ–‡ä»¶æ•°æ®æµï¼šèƒ½å¤Ÿè¯»å–æ‰€æœ‰HDFS APIå…¼å®¹çš„æ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶ï¼Œé€šè¿‡fileStreamæ–¹æ³•è¿›è¡Œè¯»å–ï¼ŒSpark Streaming å°†ä¼šç›‘æ§ dataDirectory ç›®å½•å¹¶ä¸æ–­å¤„ç†ç§»åŠ¨è¿›æ¥çš„æ–‡ä»¶ï¼Œã€‚<font color="red"><strong>è®°ä½ç›®å‰ä¸æ”¯æŒåµŒå¥—ç›®å½•</strong></font></p><p>ä¸€èˆ¬ä¸ä¼šä½¿ç”¨ï¼Œå› ä¸ºFLumeæ˜¯ä¸€å¥—å¤„ç†æ–‡ä»¶æ—¥å¿—çš„æ”¶é›†ç³»ç»Ÿï¼Œç”¨å®ƒä¼šå¥½ï¼Œä½†æ˜¯å®ƒåˆæ²¡æœ‰Kafkaå¥½ï¼Œå› ä¸ºFlumeæ˜¯æ¨æ•°æ®ï¼Œä¸è€ƒè™‘è®¡ç®—èŠ‚ç‚¹çš„å¤„ç†èƒ½åŠ›ï¼Œæœ‰å¯èƒ½é€ æˆè®¡ç®—èŠ‚ç‚¹ä¸­æ•°æ®çš„å †ç§¯ï¼Œè€ŒKafkaä¸ä¼šï¼Œæ˜¯è®¡ç®—èŠ‚ç‚¹ä¸»åŠ¨è¯»å–Kafkaæ•°æ®ï¼Œè®¡ç®—èƒ½åŠ›å¤šå¤§ï¼Œè¯»å–å¤šå°‘æ•°æ®ã€‚</p><p><code>streamingContext.textFileStream(dataDirectory)</code></p><p><font color="red"><strong>æ³¨æ„äº‹é¡¹</strong></font></p><ol><li>æ–‡ä»¶éœ€è¦æœ‰ç›¸åŒçš„æ•°æ®æ ¼å¼ï¼›</li><li>æ–‡ä»¶è¿›å…¥ <code>dataDirectory</code>çš„æ–¹å¼éœ€è¦é€šè¿‡ç§»åŠ¨æˆ–è€…é‡å‘½åæ¥å®ç°ï¼›</li><li>ä¸€æ—¦æ–‡ä»¶ç§»åŠ¨è¿›ç›®å½•ï¼Œåˆ™ä¸èƒ½å†ä¿®æ”¹ï¼Œå³ä¾¿ä¿®æ”¹äº†ä¹Ÿä¸ä¼šè¯»å–æ–°æ•°æ®ï¼›</li></ol><h2 id="è‡ªå®šä¹‰æ•°æ®æº"><a href="#è‡ªå®šä¹‰æ•°æ®æº" class="headerlink" title="è‡ªå®šä¹‰æ•°æ®æº"></a>è‡ªå®šä¹‰æ•°æ®æº</h2><h3 id="ç”¨æ³•åŠè¯´æ˜-1"><a href="#ç”¨æ³•åŠè¯´æ˜-1" class="headerlink" title="ç”¨æ³•åŠè¯´æ˜"></a>ç”¨æ³•åŠè¯´æ˜</h3><p>éœ€è¦ç»§æ‰¿<code>Receiver</code>ï¼Œå¹¶å®ç°<code>onStart</code>ã€<code>onStop</code>æ–¹æ³•æ¥è‡ªå®šä¹‰æ•°æ®æºé‡‡é›†ã€‚</p><h3 id="æ¡ˆä¾‹å®æ“"><a href="#æ¡ˆä¾‹å®æ“" class="headerlink" title="æ¡ˆä¾‹å®æ“"></a>æ¡ˆä¾‹å®æ“</h3><p>æˆ‘ä»¬å·²ä¸Šé¢çš„è¯»å–æŸä¸ªå¥—æ¥å­—çš„æ•°æ®çš„æ•°æ®æºä¸ºä¾‹ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.&#123;<span class="type">BufferedReader</span>, <span class="type">InputStreamReader</span>&#125;</span><br><span class="line"><span class="keyword">import</span> java.net.<span class="type">Socket</span></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.<span class="type">StandardCharsets</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.storage.<span class="type">StorageLevel</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.receiver.<span class="type">Receiver</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomerReceiver</span>(<span class="params">host: <span class="type">String</span>, port: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">Receiver</span>[<span class="type">String</span>](<span class="params"><span class="type">StorageLevel</span>.<span class="type">MEMORY_ONLY</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//æœ€åˆå¯åŠ¨çš„æ—¶å€™ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ï¼Œä½œç”¨ä¸ºï¼šè¯»æ•°æ®å¹¶å°†æ•°æ®å‘é€ç»™Spark</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">onStart</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="type">Thread</span>(<span class="string">&quot;Socket Receiver&quot;</span>) &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>() &#123;</span><br><span class="line">        receive()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;.start()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//è¯»æ•°æ®å¹¶å°†æ•°æ®å‘é€ç»™Spark</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">receive</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªSocket</span></span><br><span class="line">    <span class="keyword">var</span> socket: <span class="type">Socket</span> = <span class="keyword">new</span> <span class="type">Socket</span>(host, port)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®šä¹‰ä¸€ä¸ªå˜é‡ï¼Œç”¨æ¥æ¥æ”¶ç«¯å£ä¼ è¿‡æ¥çš„æ•°æ®</span></span><br><span class="line">    <span class="keyword">var</span> input: <span class="type">String</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªBufferedReaderç”¨äºè¯»å–ç«¯å£ä¼ æ¥çš„æ•°æ®</span></span><br><span class="line">    <span class="keyword">val</span> reader = <span class="keyword">new</span> <span class="type">BufferedReader</span>(<span class="keyword">new</span> <span class="type">InputStreamReader</span>(socket.getInputStream, <span class="type">StandardCharsets</span>.<span class="type">UTF_8</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¯»å–æ•°æ®</span></span><br><span class="line">    input = reader.readLine()</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å½“receiveræ²¡æœ‰å…³é—­å¹¶ä¸”è¾“å…¥æ•°æ®ä¸ä¸ºç©ºï¼Œåˆ™å¾ªç¯å‘é€æ•°æ®ç»™Spark</span></span><br><span class="line">    <span class="keyword">while</span> (!isStopped() &amp;&amp; input != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å°†è¯»åˆ°çš„æ•°æ®åŠ å…¥æ•°æ®æºä¸­å­˜å‚¨</span></span><br><span class="line">      store(input)</span><br><span class="line">      input = reader.readLine()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·³å‡ºå¾ªç¯åˆ™å…³é—­èµ„æº</span></span><br><span class="line">    reader.close()</span><br><span class="line">    socket.close()</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é‡å¯ä»»åŠ¡</span></span><br><span class="line">    restart(<span class="string">&quot;restart&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">onStop</span></span>(): <span class="type">Unit</span> = &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨è‡ªå®šä¹‰çš„æ•°æ®æºé‡‡é›†æ•°æ®</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">SparkConf</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.&#123;<span class="type">Seconds</span>, <span class="type">StreamingContext</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.dstream.<span class="type">DStream</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">FileStream</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.åˆå§‹åŒ–Sparké…ç½®ä¿¡æ¯</span></span><br><span class="line"><span class="type">Val</span> sparkConf = <span class="keyword">new</span> <span class="type">SparkConf</span>().setMaster(<span class="string">&quot;local[*]&quot;</span>)</span><br><span class="line">.setAppName(<span class="string">&quot;StreamWordCount&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.åˆå§‹åŒ–SparkStreamingContext</span></span><br><span class="line">    <span class="keyword">val</span> ssc = <span class="keyword">new</span> <span class="type">StreamingContext</span>(sparkConf, <span class="type">Seconds</span>(<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">//3.åˆ›å»ºè‡ªå®šä¹‰receiverçš„Streaming</span></span><br><span class="line"><span class="keyword">val</span> lineStream = ssc.receiverStream(<span class="keyword">new</span> <span class="type">CustomerReceiver</span>(<span class="string">&quot;hadoop102&quot;</span>, <span class="number">9999</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4.å°†æ¯ä¸€è¡Œæ•°æ®åšåˆ‡åˆ†ï¼Œå½¢æˆä¸€ä¸ªä¸ªå•è¯</span></span><br><span class="line">    <span class="keyword">val</span> wordStreams = lineStream.flatMap(_.split(<span class="string">&quot;\t&quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.å°†å•è¯æ˜ å°„æˆå…ƒç»„ï¼ˆword,1ï¼‰</span></span><br><span class="line">    <span class="keyword">val</span> wordAndOneStreams = wordStreams.map((_, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6.å°†ç›¸åŒçš„å•è¯æ¬¡æ•°åšç»Ÿè®¡</span></span><br><span class="line">    <span class="keyword">val</span> wordAndCountStreams] = wordAndOneStreams.reduceByKey(_ + _)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//7.æ‰“å°</span></span><br><span class="line">    wordAndCountStreams.print()</span><br><span class="line"></span><br><span class="line">    <span class="comment">//8.å¯åŠ¨SparkStreamingContext</span></span><br><span class="line">    ssc.start()</span><br><span class="line">    ssc.awaitTermination()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Kafkaæ•°æ®æºğŸ”º"><a href="#Kafkaæ•°æ®æºğŸ”º" class="headerlink" title="Kafkaæ•°æ®æºğŸ”º"></a>Kafkaæ•°æ®æºğŸ”º</h2><h3 id="ç”¨æ³•åŠè¯´æ˜-2"><a href="#ç”¨æ³•åŠè¯´æ˜-2" class="headerlink" title="ç”¨æ³•åŠè¯´æ˜"></a>ç”¨æ³•åŠè¯´æ˜</h3><p><font color="red">åœ¨å·¥ç¨‹ä¸­éœ€è¦å¼•å…¥ Maven å·¥ä»¶Â· spark- streaming-kafka_2.10 Â·æ¥ä½¿ç”¨å®ƒ</font>ã€‚åŒ…å†…æä¾›çš„ <code>KafkaUtils </code>å¯¹è±¡å¯ä»¥åœ¨ <code>StreamingContext</code> å’Œ<code>JavaStreamingContext</code>ä¸­ä»¥ä½ çš„ Kafka æ¶ˆæ¯åˆ›å»ºå‡º DStreamã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-streaming-kafka-0-8_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç”±äº <code>KafkaUtils</code> å¯ä»¥è®¢é˜…å¤šä¸ªä¸»é¢˜ï¼Œå› æ­¤å®ƒåˆ›å»ºå‡ºçš„ DStream ç”±æˆå¯¹çš„ä¸»é¢˜å’Œæ¶ˆæ¯ç»„æˆã€‚è¦åˆ›å»ºå‡ºä¸€ä¸ªæµæ•°æ®ï¼Œéœ€è¦ä½¿ç”¨ ï¼š</p><ol><li><code>StreamingContext </code>å®ä¾‹</li><li>ä¸€ä¸ªç”±é€—å·éš”å¼€çš„<code>ZooKeeper</code>ä¸»æœºåˆ—è¡¨å­—ç¬¦ä¸²</li><li>æ¶ˆè´¹è€…ç»„çš„åå­—(å”¯ä¸€åå­—)</li><li>ä»¥åŠä¸€ä¸ªä»ä¸»é¢˜åˆ°é’ˆå¯¹è¿™ä¸ªä¸»é¢˜çš„æ¥æ”¶å™¨çº¿ç¨‹æ•°çš„æ˜ å°„è¡¨æ¥è°ƒç”¨<code>createStream()</code>æ–¹æ³•ã€‚</li></ol><p>å› ä¸ºKafkaçš„topicæœ‰åˆ†åŒºæ•°çš„æ¦‚å¿µï¼Œæ‰€æœ‰åˆ†åŒºçš„æ•°æ®åˆèµ·æ¥ä¾¿æ˜¯æ•´ä¸ªtopicçš„æ•°æ®ï¼Œè€Œtopicçš„åˆ†åŒºè‡³å¤šè¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹<font color="red">ï¼Œæ‰€ä»¥å¯åŠ¨çš„æ¶ˆè´¹è€…çš„çº¿ç¨‹åº”è¯¥&lt;=topicçš„åˆ†åŒºæ•°ã€‚</font></p><p><code>// Map of (topic_name to numPartitions) to consume. Each partition is consumed in its own thread   </code></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">//3.é€šè¿‡ç›‘æ§ç«¯å£åˆ›å»ºDStreamï¼Œè¯»è¿›æ¥çš„æ•°æ®ä¸ºä¸€è¡Œè¡Œ</span></span><br><span class="line"><span class="comment">//    lineStreams = k-v  valueæ‰æ˜¯kafkaè¾“å…¥çš„æ•°æ®</span></span><br><span class="line">    <span class="keyword">val</span> lineStreams: <span class="type">ReceiverInputDStream</span>[(<span class="type">String</span>, <span class="type">String</span>)] = <span class="type">KafkaUtils</span>.createStream(</span><br><span class="line">      ssc,</span><br><span class="line">      <span class="string">&quot;192.168.0.201:2181&quot;</span>,</span><br><span class="line">      <span class="string">&quot;group1&quot;</span>,</span><br><span class="line">      <span class="type">Map</span>((<span class="string">&quot;myTopic&quot;</span>, <span class="number">3</span>))</span><br><span class="line">    )</span><br><span class="line"><span class="comment">// Map of (topic_name to numPartitions) to consume. Each partition is consumed in its own thread              </span></span><br></pre></td></tr></table></figure><h3 id="WCæ— çŠ¶æ€çš„æ¡ˆä¾‹å®æ“"><a href="#WCæ— çŠ¶æ€çš„æ¡ˆä¾‹å®æ“" class="headerlink" title="WCæ— çŠ¶æ€çš„æ¡ˆä¾‹å®æ“"></a>WCæ— çŠ¶æ€çš„æ¡ˆä¾‹å®æ“</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Kafka</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="comment">//1.åˆ›å»ºSparkConfå¹¶è®¾ç½®Appåç§°</span></span><br><span class="line">    <span class="keyword">val</span> conf: <span class="type">SparkConf</span> = <span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">&quot;WC&quot;</span>).setMaster(<span class="string">&quot;local[*]&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.åˆå§‹åŒ–SparkStreamingContext</span></span><br><span class="line">    <span class="keyword">val</span> ssc = <span class="keyword">new</span> <span class="type">StreamingContext</span>(conf, <span class="type">Seconds</span>(<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.é€šè¿‡ç›‘æ§ç«¯å£åˆ›å»ºDStreamï¼Œè¯»è¿›æ¥çš„æ•°æ®ä¸ºä¸€è¡Œè¡Œ</span></span><br><span class="line"><span class="comment">//    lineStreams = k-v  valueæ‰æ˜¯kafkaè¾“å…¥çš„æ•°æ®</span></span><br><span class="line">    <span class="keyword">val</span> lineStreams: <span class="type">ReceiverInputDStream</span>[(<span class="type">String</span>, <span class="type">String</span>)] = <span class="type">KafkaUtils</span>.createStream(</span><br><span class="line">      ssc,</span><br><span class="line">      <span class="string">&quot;192.168.0.201:2181&quot;</span>,</span><br><span class="line">      <span class="string">&quot;group1&quot;</span>,</span><br><span class="line">      <span class="type">Map</span>((<span class="string">&quot;myTopic&quot;</span>, <span class="number">3</span>))</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†æ¯ä¸€è¡Œæ•°æ®åšåˆ‡åˆ†ï¼Œå½¢æˆä¸€ä¸ªä¸ªå•è¯</span></span><br><span class="line">    <span class="keyword">val</span> wordStreams: <span class="type">DStream</span>[<span class="type">String</span>] = lineStreams.flatMap(_._2.split(<span class="string">&quot; &quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†å•è¯æ˜ å°„æˆå…ƒç»„ï¼ˆword,1ï¼‰</span></span><br><span class="line">    <span class="keyword">val</span> wordAndOneStreams: <span class="type">DStream</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = wordStreams.map((_, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†ç›¸åŒçš„å•è¯æ¬¡æ•°åšç»Ÿè®¡</span></span><br><span class="line">    <span class="keyword">val</span> wordAndCountStreams: <span class="type">DStream</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = wordAndOneStreams.reduceByKey(_+_)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ‰“å°</span></span><br><span class="line">    wordAndCountStreams.print()</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯åŠ¨SparkStreamingContextçš„æ”¶é›†å™¨ï¼Œæ”¶é›†å™¨å¿…é¡»ä¸€ç›´å¼€å¯ï¼Œæ‰èƒ½æ”¶é›†åˆ°æ•°æ®</span></span><br><span class="line">    ssc.start()</span><br><span class="line">    <span class="comment">// ä¸»ç¨‹åºç­‰å¾…æ”¶é›†å™¨å…³é—­ï¼Œç„¶åä¸»ç¨‹åºå…³é—­</span></span><br><span class="line">    ssc.awaitTermination()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>Kafka</code>çš„æ“ä½œ</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop201 kafka]$ bin/kafka-topics.sh --zookeeper hadoop201:2181 --create --replication-factor 3 --partitions 3 --topic myTopic</span><br><span class="line"></span><br><span class="line">[hadoop@hadoop201 kafka]$ bin/kafka-console-producer.sh --broker-list hadoop202:9092 --topic myTopic</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>ideaç¨‹åºæ‰§è¡Œ</strong></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200828203819133.png" alt="image-20200828203819133"></p><p><font color="red"><strong>æ³¨æ„</strong>ï¼šä¸Šé¢æ‰€æœ‰çš„ç¨‹åºéƒ½æ˜¯æ— çŠ¶æ€çš„è®¡ç®—ï¼Œå³æ¯ä¸ªé‡‡é›†å‘¨æœŸä¹‹é—´çš„æ•°æ®äº’ä¸å½±å“ï¼Œä½†è¿™æ˜¯ä¸åˆç†çš„ï¼Œæµå¼å¤„ç†åº”è¯¥æ±‡æ€»æ‰€æœ‰çš„æ•°æ®è¿›è¡Œç»Ÿè®¡è®¡ç®—ã€‚è¿™ç§°ä¸º<strong>æœ‰çŠ¶æ€çš„è®¡ç®—</strong>ï¼Œä¸‹é¢å¼€å§‹æœ‰çŠ¶æ€çš„è®¡ç®—</font></p><h1 id="DStreamçš„è½¬æ¢"><a href="#DStreamçš„è½¬æ¢" class="headerlink" title="DStreamçš„è½¬æ¢"></a>DStreamçš„è½¬æ¢</h1><h2 id="æ— çŠ¶æ€çš„è½¬æ¢"><a href="#æ— çŠ¶æ€çš„è½¬æ¢" class="headerlink" title="æ— çŠ¶æ€çš„è½¬æ¢"></a>æ— çŠ¶æ€çš„è½¬æ¢</h2><p>æ— çŠ¶æ€è½¬åŒ–æ“ä½œå°±æ˜¯æŠŠç®€å•çš„RDDè½¬åŒ–æ“ä½œåº”ç”¨åˆ°æ¯ä¸ªæ‰¹æ¬¡ä¸Šï¼Œä¹Ÿå°±æ˜¯è½¬åŒ–DStreamä¸­çš„æ¯ä¸€ä¸ªRDDã€‚éƒ¨åˆ†æ— çŠ¶æ€è½¬åŒ–æ“ä½œåˆ—åœ¨äº†ä¸‹è¡¨ä¸­ã€‚</p><p><font color="red"><strong>æ³¨æ„</strong>ï¼Œé’ˆå¯¹é”®å€¼å¯¹çš„DStreamè½¬åŒ–æ“ä½œ(æ¯”å¦‚ reduceByKey())è¦æ·»åŠ import StreamingContext._æ‰èƒ½åœ¨Scalaä¸­ä½¿ç”¨ã€‚</font></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200829144132973.png" alt="image-20200829144132973"></p><p>éœ€è¦è®°ä½çš„æ˜¯ï¼Œå°½ç®¡è¿™äº›å‡½æ•°çœ‹èµ·æ¥åƒä½œç”¨åœ¨æ•´ä¸ªæµä¸Šä¸€æ ·ï¼Œä½†äº‹å®ä¸Šæ¯ä¸ªDStreamåœ¨å†…éƒ¨æ˜¯ç”±è®¸å¤šRDD(æ‰¹æ¬¡)ç»„æˆï¼Œä¸”æ— çŠ¶æ€è½¬åŒ–æ“ä½œæ˜¯åˆ†åˆ«<strong>åº”ç”¨åˆ°æ¯ä¸ªRDDä¸Šçš„</strong>ã€‚<strong>ä¾‹å¦‚ï¼ŒreduceByKey()ä¼šå½’çº¦æ¯ä¸ªæ—¶é—´åŒºé—´ä¸­çš„æ•°æ®ï¼Œ<font color="red">ä½†ä¸ä¼šå½’çº¦ä¸åŒåŒºé—´ä¹‹é—´çš„æ•°æ®</font>ã€‚</strong> </p><p>ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ä¹‹å‰çš„wordcountç¨‹åºä¸­ï¼Œæˆ‘ä»¬åªä¼šç»Ÿè®¡5ç§’å†…æ¥æ”¶åˆ°çš„æ•°æ®çš„å•è¯ä¸ªæ•°ï¼Œè€Œä¸ä¼šç´¯åŠ ã€‚ </p><h2 id="æœ‰çŠ¶æ€çš„è½¬æ¢ğŸ”º"><a href="#æœ‰çŠ¶æ€çš„è½¬æ¢ğŸ”º" class="headerlink" title="æœ‰çŠ¶æ€çš„è½¬æ¢ğŸ”º"></a>æœ‰çŠ¶æ€çš„è½¬æ¢ğŸ”º</h2><h3 id="UpdateStateByKey"><a href="#UpdateStateByKey" class="headerlink" title="UpdateStateByKey"></a>UpdateStateByKey</h3><p>UpdateStateByKeyåŸè¯­ç”¨äºè®°å½•å†å²è®°å½•ï¼Œ<font color="red">æœ‰æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ DStream ä¸­è·¨æ‰¹æ¬¡ç»´æŠ¤çŠ¶æ€(ä¾‹å¦‚æµè®¡ç®—ä¸­ç´¯åŠ wordcount)ã€‚</font>é’ˆå¯¹è¿™ç§æƒ…å†µï¼ŒupdateStateByKey() ä¸ºæˆ‘ä»¬æä¾›äº†å¯¹ä¸€ä¸ªçŠ¶æ€å˜é‡çš„è®¿é—®ï¼Œ<font color="red"><strong>ç”¨äºé”®å€¼å¯¹å½¢å¼çš„ DStreamã€‚</strong></font></p><p>updateStateByKey() çš„ç»“æœä¼šæ˜¯ä¸€ä¸ªæ–°çš„ DStreamï¼Œå…¶å†…éƒ¨çš„ RDD åºåˆ—æ˜¯ç”±æ¯ä¸ªæ—¶é—´åŒºé—´å¯¹åº”çš„(é”®ï¼ŒçŠ¶æ€)å¯¹ç»„æˆçš„ã€‚</p><p>updateStateByKeyæ“ä½œä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨ç”¨æ–°ä¿¡æ¯è¿›è¡Œæ›´æ–°æ—¶ä¿æŒä»»æ„çš„çŠ¶æ€ã€‚ä¸ºä½¿ç”¨è¿™ä¸ªåŠŸèƒ½ï¼Œä½ éœ€è¦ï¼š </p><ol><li>æŒ‡å®šæ£€æŸ¥ç‚¹ç›®å½•ï¼Œå› ä¸ºæ¯æ¬¡è®¡ç®—æ—¶ä¼šç”¨åˆ°ä¹‹å‰çš„æ•°æ®ï¼Œè€Œä¸æ–­ç´¯åŠ çš„ä¹‹å‰çš„æ•°æ®æ˜¯ä¸èƒ½æ”¾å…¥å†…å­˜çš„ï¼Œæ‰€ä»¥è¦è®¾ç½®ç›®å½•å­˜æ”¾è¿™äº›æ•°æ®ã€‚</li></ol><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">updateStateByKey</span></span>[<span class="type">S</span>: <span class="type">ClassTag</span>](updateFunc: (<span class="type">Seq</span>[<span class="type">V</span>], <span class="type">Option</span>[<span class="type">S</span>]) =&gt; <span class="type">Option</span>[<span class="type">S</span>])</span><br></pre></td></tr></table></figure><ol><li>å¯ä»¥çœ‹åˆ°æ³›å‹å’Œå‚æ•°ï¼Œå…¶ä¸­æ³›å‹æ˜¯ä¹‹å‰çš„æ•°æ®çš„æ­¤KEYçš„Valueçš„ç±»å‹</li><li>å‚æ•°ä¸­ï¼šSeqåºåˆ—æ˜¯æœ€æ–°çš„é‡‡é›†å‘¨æœŸçš„æ•°æ®ç›¸åŒkeyçš„é›†åˆ</li><li>Option{S}æ˜¯ä¹‹å‰è®¡ç®—å¥½çš„æ­¤KEYå¯¹åº”çš„æœ€åValueï¼Œä¸ºä»€ä¹ˆæ˜¯Optionï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è®¡ç®—ï¼Œåˆ™ä»–æ˜¯ç©º</li></ol><p><strong>æ”¹è‰¯çš„WC</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Kafka</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="comment">//1.åˆ›å»ºSparkConfå¹¶è®¾ç½®Appåç§°</span></span><br><span class="line">    <span class="keyword">val</span> conf: <span class="type">SparkConf</span> = <span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">&quot;WC&quot;</span>).setMaster(<span class="string">&quot;local[*]&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.åˆå§‹åŒ–SparkStreamingContext  Seconds(5)é‡‡é›†å‘¨æœŸï¼Œ5Sç”Ÿæˆä¸€ä¸ªDStreamå³RDD</span></span><br><span class="line">    <span class="keyword">val</span> ssc = <span class="keyword">new</span> <span class="type">StreamingContext</span>(conf, <span class="type">Seconds</span>(<span class="number">5</span>))</span><br><span class="line">    ssc.sparkContext.setCheckpointDir(<span class="string">&quot;test&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.é€šè¿‡ç›‘æ§ç«¯å£åˆ›å»ºDStreamï¼Œè¯»è¿›æ¥çš„æ•°æ®ä¸ºä¸€è¡Œè¡Œ</span></span><br><span class="line">    <span class="comment">//    lineStreams = k-v  valueæ‰æ˜¯kafkaè¾“å…¥çš„æ•°æ®</span></span><br><span class="line">    <span class="keyword">val</span> lineStreams: <span class="type">ReceiverInputDStream</span>[(<span class="type">String</span>, <span class="type">String</span>)] = <span class="type">KafkaUtils</span>.createStream(</span><br><span class="line">      ssc,</span><br><span class="line">      <span class="string">&quot;192.168.0.201:2181&quot;</span>,</span><br><span class="line">      <span class="string">&quot;group1&quot;</span>,</span><br><span class="line">      <span class="type">Map</span>((<span class="string">&quot;myTopic&quot;</span>, <span class="number">3</span>))</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†æ¯ä¸€è¡Œæ•°æ®åšåˆ‡åˆ†ï¼Œå½¢æˆä¸€ä¸ªä¸ªå•è¯</span></span><br><span class="line">    <span class="keyword">val</span> wordStreams: <span class="type">DStream</span>[<span class="type">String</span>] = lineStreams.flatMap(_._2.split(<span class="string">&quot; &quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†å•è¯æ˜ å°„æˆå…ƒç»„ï¼ˆword,1ï¼‰</span></span><br><span class="line">    <span class="keyword">val</span> wordAndOneStreams: <span class="type">DStream</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = wordStreams.map((_, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    def updateStateByKey[S: ClassTag](updateFunc: (Seq[V], Option[S]) =&gt; Option[S])</span></span><br><span class="line">    <span class="comment">//  å¯ä»¥çœ‹åˆ°æ³›å‹å’Œå‚æ•°ï¼Œå…¶ä¸­æ³›å‹æ˜¯ä¹‹å‰çš„æ•°æ®çš„æ­¤KEYçš„Valueçš„ç±»å‹ï¼Œå…¶ä¸­</span></span><br><span class="line">    <span class="comment">// å‚æ•°ä¸­ï¼šSeqåºåˆ—æ˜¯æœ€æ–°çš„é‡‡é›†å‘¨æœŸçš„æ•°æ®ç›¸åŒkeyçš„é›†åˆï¼ŒOption&#123;S&#125;æ˜¯ä¹‹å‰è®¡ç®—å¥½çš„æ­¤KEYå¯¹åº”çš„æœ€åValueï¼Œä¸ºä»€ä¹ˆæ˜¯Optionï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è®¡ç®—ï¼Œåˆ™ä»–æ˜¯ç©º</span></span><br><span class="line">    <span class="comment">// å®šä¹‰æ›´æ–°çŠ¶æ€æ–¹æ³•ï¼Œå‚æ•°valuesä¸ºå½“å‰æ‰¹æ¬¡å•è¯é¢‘åº¦ï¼Œstateä¸ºä»¥å¾€æ‰¹æ¬¡å•è¯é¢‘åº¦</span></span><br><span class="line">    <span class="keyword">val</span> value: <span class="type">DStream</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = wordAndOneStreams.updateStateByKey &#123;</span><br><span class="line">      <span class="keyword">case</span> (seq, buffer) =&gt;</span><br><span class="line">        <span class="type">Some</span>(seq.sum + buffer.getOrElse(<span class="number">0</span>))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    value.print()</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¯åŠ¨SparkStreamingContextçš„æ”¶é›†å™¨ï¼Œæ”¶é›†å™¨å¿…é¡»ä¸€ç›´å¼€å¯ï¼Œæ‰èƒ½æ”¶é›†åˆ°æ•°æ®</span></span><br><span class="line">    ssc.start()</span><br><span class="line">    <span class="comment">// ä¸»ç¨‹åºç­‰å¾…æ”¶é›†å™¨å…³é—­ï¼Œç„¶åä¸»ç¨‹åºå…³é—­</span></span><br><span class="line">    ssc.awaitTermination()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200829152850299.png" alt="image-20200829152850299"></p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200829153242722.png" alt="image-20200829153242722"></p><p>å¯ä»¥å‘ç°æ•°å€¼ä¸€ç›´åœ¨å˜å¤§</p><h3 id="Window-Operations"><a href="#Window-Operations" class="headerlink" title="Window Operations"></a>Window Operations</h3><p><code>Window Operations</code>å¯ä»¥è®¾<strong>ç½®çª—å£çš„å¤§å°</strong>å’Œ<strong>æ»‘åŠ¨çª—å£çš„é—´éš”</strong>æ¥åŠ¨æ€çš„è·å–å½“å‰Steamingçš„å…è®¸çŠ¶æ€ã€‚åŸºäºçª—å£çš„æ“ä½œä¼šåœ¨ä¸€ä¸ªæ¯” StreamingContext çš„æ‰¹æ¬¡é—´éš”æ›´é•¿çš„æ—¶é—´èŒƒå›´å†…ï¼Œé€šè¿‡æ•´åˆå¤šä¸ªæ‰¹æ¬¡çš„ç»“æœï¼Œè®¡ç®—å‡ºæ•´ä¸ªçª—å£çš„ç»“æœã€‚</p><p><strong>å…¶ä¸­ï¼š</strong></p><ol><li>çª—å£çš„å¤§å°å¿…é¡»æ˜¯é‡‡é›†å‘¨æœŸçš„æ•´æ•°å€</li><li>æ»‘åŠ¨çª—å£çš„é—´éš”å¿…é¡»æ˜¯é‡‡é›†å‘¨æœŸçš„æ•´æ•°å€</li></ol><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200829153601198.png" alt="image-20200829153601198"></p><p>ä¾‹å¦‚ï¼šä¸Šå›¾çª—å£å¤§å°å°±æ˜¯é‡‡é›†å‘¨æœŸçš„ä¸‰å€ï¼›æ»‘åŠ¨çª—å£çš„é—´éš”åˆ™æ˜¯é‡‡é›†å‘¨æœŸçš„ä¸¤å€</p><p><font color="red"><strong>æ³¨æ„ï¼šæ‰€æœ‰åŸºäºçª—å£çš„æ“ä½œéƒ½éœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«ä¸ºçª—å£æ—¶é•¿ä»¥åŠæ»‘åŠ¨æ­¥é•¿ï¼Œä¸¤è€…éƒ½å¿…é¡»æ˜¯ StreamContext çš„æ‰¹æ¬¡é—´éš”çš„æ•´æ•°å€</strong></font></p><p><code>window(windowLength, slideInterval)</code>: åŸºäºå¯¹æºDStreamçª—åŒ–çš„æ‰¹æ¬¡è¿›è¡Œè®¡ç®—è¿”å›ä¸€ä¸ªæ–°çš„Dstream</p><h2 id="å…¶ä»–é‡è¦æ“ä½œğŸ”º"><a href="#å…¶ä»–é‡è¦æ“ä½œğŸ”º" class="headerlink" title="å…¶ä»–é‡è¦æ“ä½œğŸ”º"></a>å…¶ä»–é‡è¦æ“ä½œğŸ”º</h2><h3 id="TransformğŸ”º"><a href="#TransformğŸ”º" class="headerlink" title="TransformğŸ”º"></a>TransformğŸ”º</h3><p>TransformåŸè¯­å…è®¸DStreamä¸Šæ‰§è¡Œä»»æ„çš„RDD-to-RDDå‡½æ•°ã€‚å³ä½¿è¿™äº›å‡½æ•°å¹¶æ²¡æœ‰åœ¨DStreamçš„APIä¸­æš´éœ²å‡ºæ¥ï¼Œé€šè¿‡è¯¥å‡½æ•°å¯ä»¥æ–¹ä¾¿çš„æ‰©å±•Spark APIã€‚<strong>è¯¥å‡½æ•°æ¯ä¸€æ‰¹æ¬¡è°ƒåº¦ä¸€æ¬¡</strong>ã€‚å…¶å®ä¹Ÿå°±æ˜¯å¯¹DStreamä¸­çš„RDDåº”ç”¨è½¬æ¢ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200829154426732.png" alt="image-20200829154426732"></p><h1 id="DStreamè¾“å‡º"><a href="#DStreamè¾“å‡º" class="headerlink" title="DStreamè¾“å‡º"></a>DStreamè¾“å‡º</h1><p>è¾“å‡ºæ“ä½œæŒ‡å®šäº†å¯¹æµæ•°æ®ç»è½¬åŒ–æ“ä½œå¾—åˆ°çš„æ•°æ®æ‰€è¦æ‰§è¡Œçš„æ“ä½œ(ä¾‹å¦‚æŠŠç»“æœæ¨å…¥å¤–éƒ¨æ•°æ®åº“æˆ–è¾“å‡ºåˆ°å±å¹•ä¸Š)ã€‚ä¸RDDä¸­çš„æƒ°æ€§æ±‚å€¼ç±»ä¼¼ï¼Œå¦‚æœä¸€ä¸ªDStreamåŠå…¶æ´¾ç”Ÿå‡ºçš„DStreaméƒ½æ²¡æœ‰è¢«æ‰§è¡Œè¾“å‡ºæ“ä½œï¼Œé‚£ä¹ˆè¿™äº›DStreamå°±éƒ½ä¸ä¼šè¢«æ±‚å€¼ã€‚ <font color="red">å¦‚æœStreamingContextä¸­æ²¡æœ‰è®¾å®šè¾“å‡ºæ“ä½œï¼Œæ•´ä¸ªcontextå°±éƒ½ä¸ä¼šå¯åŠ¨ã€‚</font></p><p>è¾“å‡ºæ“ä½œå¦‚ä¸‹ï¼š</p><ol><li>print()ï¼šåœ¨è¿è¡Œæµç¨‹åºçš„é©±åŠ¨ç»“ç‚¹ä¸Šæ‰“å°DStreamä¸­æ¯ä¸€æ‰¹æ¬¡æ•°æ®çš„æœ€å¼€å§‹10ä¸ªå…ƒç´ ã€‚è¿™ç”¨äºå¼€å‘å’Œè°ƒè¯•ã€‚åœ¨Python APIä¸­ï¼ŒåŒæ ·çš„æ“ä½œå«print()ã€‚</li><li>saveAsTextFiles(prefix, [suffix])ï¼šä»¥textæ–‡ä»¶å½¢å¼å­˜å‚¨è¿™ä¸ªDStreamçš„å†…å®¹ã€‚æ¯ä¸€æ‰¹æ¬¡çš„å­˜å‚¨æ–‡ä»¶ååŸºäºå‚æ•°ä¸­çš„prefixå’Œsuffixã€‚â€prefix-Time_IN_MS[.suffix]â€. </li><li>saveAsObjectFiles(prefix, [suffix])ï¼šä»¥Javaå¯¹è±¡åºåˆ—åŒ–çš„æ–¹å¼å°†Streamä¸­çš„æ•°æ®ä¿å­˜ä¸º SequenceFiles . æ¯ä¸€æ‰¹æ¬¡çš„å­˜å‚¨æ–‡ä»¶ååŸºäºå‚æ•°ä¸­çš„ä¸ºâ€prefix-TIME_IN_MS[.suffix]â€. Pythonä¸­ç›®å‰ä¸å¯ç”¨ã€‚</li><li>saveAsHadoopFiles(prefix, [suffix])ï¼šå°†Streamä¸­çš„æ•°æ®ä¿å­˜ä¸º Hadoop files. æ¯ä¸€æ‰¹æ¬¡çš„å­˜å‚¨æ–‡ä»¶ååŸºäºå‚æ•°ä¸­çš„ä¸ºâ€prefix-TIME_IN_MS[.suffix]â€ã€‚<br>Python API Pythonä¸­ç›®å‰ä¸å¯ç”¨ã€‚</li><li>foreachRDD(func)ï¼š<strong>è¿™æ˜¯æœ€é€šç”¨çš„è¾“å‡ºæ“ä½œ</strong>ï¼Œå³å°†å‡½æ•° func ç”¨äºäº§ç”Ÿäº streamçš„æ¯ä¸€ä¸ªRDDã€‚å…¶ä¸­å‚æ•°ä¼ å…¥çš„å‡½æ•°funcåº”è¯¥å®ç°å°†æ¯ä¸€ä¸ªRDDä¸­æ•°æ®æ¨é€åˆ°å¤–éƒ¨ç³»ç»Ÿï¼Œå¦‚å°†RDDå­˜å…¥æ–‡ä»¶æˆ–è€…é€šè¿‡ç½‘ç»œå°†å…¶å†™å…¥æ•°æ®åº“ã€‚æ³¨æ„ï¼šå‡½æ•°funcåœ¨è¿è¡Œæµåº”ç”¨çš„é©±åŠ¨ä¸­è¢«æ‰§è¡Œï¼ŒåŒæ—¶å…¶ä¸­ä¸€èˆ¬å‡½æ•°RDDæ“ä½œä»è€Œå¼ºåˆ¶å…¶å¯¹äºæµRDDçš„è¿ç®—ã€‚</li></ol><p><font color="red"></font></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Spark-Streamingæ¦‚è¿°&quot;&gt;&lt;a href=&quot;#Spark-Streamingæ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;Spark Streamingæ¦‚è¿°&quot;&gt;&lt;/a&gt;Spark Streamingæ¦‚è¿°&lt;/h1&gt;&lt;h2 id=&quot;Spark</summary>
      
    
    
    
    <category term="Spark" scheme="https://awslzhang.top/categories/Spark/"/>
    
    
    <category term="Spark" scheme="https://awslzhang.top/tags/Spark/"/>
    
  </entry>
  
  <entry>
    <title>sparkå­¦ä¹ ç¬”è®°-SparkSQL</title>
    <link href="https://awslzhang.top/2020/08/24/spark%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-SparkSQL/"/>
    <id>https://awslzhang.top/2020/08/24/spark%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-SparkSQL/</id>
    <published>2020-08-24T13:10:34.000Z</published>
    <updated>2021-01-01T05:50:00.043Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Spark-SQLæ¦‚è¿°"><a href="#Spark-SQLæ¦‚è¿°" class="headerlink" title="Spark SQLæ¦‚è¿°"></a>Spark SQLæ¦‚è¿°</h1><h2 id="ä»€ä¹ˆæ˜¯Spark-SQL"><a href="#ä»€ä¹ˆæ˜¯Spark-SQL" class="headerlink" title="ä»€ä¹ˆæ˜¯Spark SQL"></a>ä»€ä¹ˆæ˜¯Spark SQL</h2><p>park SQLæ˜¯Sparkç”¨æ¥å¤„ç†ç»“æ„åŒ–æ•°æ®çš„ä¸€ä¸ªæ¨¡å—ï¼Œå®ƒæä¾›äº†2ä¸ªç¼–ç¨‹æŠ½è±¡ï¼š<font color="red">DataFrameå’ŒDataSet</font>ï¼Œå¹¶ä¸”ä½œä¸ºåˆ†å¸ƒå¼SQLæŸ¥è¯¢å¼•æ“çš„ä½œç”¨ã€‚</p><p>å°†Spark SQLè½¬æ¢æˆRDDï¼Œç„¶åæäº¤åˆ°é›†ç¾¤æ‰§è¡Œï¼Œæ‰§è¡Œæ•ˆç‡éå¸¸å¿«ï¼</p><h2 id="Spark-SQLçš„ç‰¹ç‚¹"><a href="#Spark-SQLçš„ç‰¹ç‚¹" class="headerlink" title="Spark SQLçš„ç‰¹ç‚¹"></a>Spark SQLçš„ç‰¹ç‚¹</h2><ul><li>æ˜“æ•´åˆ</li><li>ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ–¹å¼</li><li>å…¼å®¹Hive</li><li>æ ‡å‡†çš„æ•°æ®è¿æ¥</li></ul><h2 id="ä»€ä¹ˆæ˜¯DataFrame"><a href="#ä»€ä¹ˆæ˜¯DataFrame" class="headerlink" title="ä»€ä¹ˆæ˜¯DataFrame"></a>ä»€ä¹ˆæ˜¯DataFrame</h2><p>ä¸RDDç±»ä¼¼ï¼ŒDataFrameä¹Ÿæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ•°æ®å®¹å™¨ã€‚ç„¶è€ŒDataFrameæ›´åƒä¼ ç»Ÿæ•°æ®åº“çš„äºŒç»´è¡¨æ ¼ï¼Œé™¤äº†æ•°æ®ä»¥å¤–ï¼Œ<strong>è¿˜è®°å½•æ•°æ®çš„ç»“æ„ä¿¡æ¯ï¼Œå³schema</strong>ã€‚åŒæ—¶ï¼Œä¸Hiveç±»ä¼¼ï¼ŒDataFrameä¹Ÿæ”¯æŒåµŒå¥—æ•°æ®ç±»å‹ï¼ˆstructã€arrayå’Œmapï¼‰ã€‚ä»APIæ˜“ç”¨æ€§çš„è§’åº¦ä¸Šçœ‹ï¼ŒDataFrame APIæä¾›çš„æ˜¯ä¸€å¥—é«˜å±‚çš„å…³ç³»æ“ä½œï¼Œæ¯”å‡½æ•°å¼çš„RDD APIè¦æ›´åŠ å‹å¥½ï¼Œé—¨æ§›æ›´ä½ã€‚</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200824211402757.png" alt="image-20200824211402757"></p><p>ä¸Šå›¾ç›´è§‚åœ°ä½“ç°äº†DataFrameå’ŒRDDçš„åŒºåˆ«ã€‚å·¦ä¾§çš„RDD[Person]è™½ç„¶ä»¥Personä¸ºç±»å‹å‚æ•°ï¼Œä½†Sparkæ¡†æ¶æœ¬èº«ä¸äº†è§£Personç±»çš„å†…éƒ¨ç»“æ„ã€‚è€Œå³ä¾§çš„DataFrameå´æä¾›äº†è¯¦ç»†çš„ç»“æ„ä¿¡æ¯ï¼Œä½¿å¾—Spark SQLå¯ä»¥æ¸…æ¥šåœ°çŸ¥é“è¯¥æ•°æ®é›†ä¸­åŒ…å«å“ªäº›åˆ—ï¼Œæ¯åˆ—çš„åç§°å’Œç±»å‹å„æ˜¯ä»€ä¹ˆã€‚DataFrameæ˜¯ä¸ºæ•°æ®æä¾›äº†Schemaçš„è§†å›¾ã€‚å¯ä»¥æŠŠå®ƒå½“åšæ•°æ®åº“ä¸­çš„ä¸€å¼ è¡¨æ¥å¯¹å¾…ï¼ŒDataFrameä¹Ÿæ˜¯æ‡’æ‰§è¡Œçš„ã€‚æ€§èƒ½ä¸Šæ¯”RDDè¦é«˜ï¼Œä¸»è¦åŸå› ï¼š</p><p><font color="red">ä¼˜åŒ–çš„æ‰§è¡Œè®¡åˆ’ï¼šæŸ¥è¯¢è®¡åˆ’é€šè¿‡Spark catalyst optimiserè¿›è¡Œä¼˜åŒ–ã€‚</font></p><p><font color="red">ä½†æ˜¯DataFrameåªå­˜å‚¨äº†ç»“æ„ä¿¡æ¯ï¼Œå³åœ¨æ¯ä¸€è¡Œä¸­ï¼Œåªèƒ½é€šè¿‡ç´¢å¼•æ¥è®¿é—®å…ƒç´ ï¼Œå¹¶ä¸èƒ½é€šè¿‡ç±»å‹è®¿é—®ã€‚å› ä¸ºDataFrameä¸ä¿å­˜ç±»å‹ä¿¡æ¯ã€‚</font></p><h2 id="ä»€ä¹ˆæ˜¯DataSet"><a href="#ä»€ä¹ˆæ˜¯DataSet" class="headerlink" title="ä»€ä¹ˆæ˜¯DataSet"></a>ä»€ä¹ˆæ˜¯DataSet</h2><ol><li>æ˜¯Dataframe APIçš„ä¸€ä¸ªæ‰©å±•ï¼Œæ˜¯Sparkæœ€æ–°çš„æ•°æ®æŠ½è±¡ã€‚</li><li>ç”¨æˆ·å‹å¥½çš„APIé£æ ¼ï¼Œæ—¢å…·æœ‰ç±»å‹å®‰å…¨æ£€æŸ¥ä¹Ÿå…·æœ‰Dataframeçš„æŸ¥è¯¢ä¼˜åŒ–ç‰¹æ€§ã€‚</li><li>Datasetæ”¯æŒç¼–è§£ç å™¨ï¼Œå½“éœ€è¦è®¿é—®éå †ä¸Šçš„æ•°æ®æ—¶å¯ä»¥é¿å…ååºåˆ—åŒ–æ•´ä¸ªå¯¹è±¡ï¼Œæé«˜äº†æ•ˆç‡ã€‚</li><li><font color="red">æ ·ä¾‹ç±»è¢«ç”¨æ¥åœ¨Datasetä¸­å®šä¹‰æ•°æ®çš„ç»“æ„ä¿¡æ¯ï¼Œæ ·ä¾‹ç±»ä¸­æ¯ä¸ªå±æ€§çš„åç§°ç›´æ¥æ˜ å°„åˆ°DataSetä¸­çš„å­—æ®µåç§°ã€‚</font></li><li>Dataframeæ˜¯Datasetçš„ç‰¹åˆ—ï¼ŒDataFrame=Dataset[Row] ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡asæ–¹æ³•å°†Dataframeè½¬æ¢ä¸ºDatasetã€‚Rowæ˜¯ä¸€ä¸ªç±»å‹ï¼Œè·ŸCarã€Personè¿™äº›çš„ç±»å‹ä¸€æ ·ï¼Œæ‰€æœ‰çš„è¡¨ç»“æ„ä¿¡æ¯æˆ‘éƒ½ç”¨Rowæ¥è¡¨ç¤ºã€‚</li><li><font color="red"><strong>DataSetæ˜¯å¼ºç±»å‹çš„</strong>ã€‚æ¯”å¦‚å¯ä»¥æœ‰Dataset[Car]ï¼ŒDataset[Person].</font></li><li><font color="red">DataFrameåªæ˜¯çŸ¥é“å­—æ®µï¼Œä½†æ˜¯ä¸çŸ¥é“å­—æ®µçš„ç±»å‹ï¼Œæ‰€ä»¥åœ¨æ‰§è¡Œè¿™äº›æ“ä½œçš„æ—¶å€™æ˜¯æ²¡åŠæ³•åœ¨ç¼–è¯‘çš„æ—¶å€™æ£€æŸ¥æ˜¯å¦ç±»å‹å¤±è´¥çš„ï¼Œæ¯”å¦‚ä½ å¯ä»¥å¯¹ä¸€ä¸ªStringè¿›è¡Œå‡æ³•æ“ä½œï¼Œåœ¨æ‰§è¡Œçš„æ—¶å€™æ‰æŠ¥é”™</font>ï¼Œè€ŒDataSetä¸ä»…ä»…çŸ¥é“å­—æ®µï¼Œ<strong>è€Œä¸”çŸ¥é“å­—æ®µç±»å‹ï¼Œæ‰€ä»¥æœ‰æ›´ä¸¥æ ¼çš„é”™è¯¯æ£€æŸ¥ã€‚å°±è·ŸJSONå¯¹è±¡å’Œç±»å¯¹è±¡ä¹‹é—´çš„ç±»æ¯”</strong>ã€‚</li></ol><h2 id="RDDã€DataFrameã€DataSetğŸ”º"><a href="#RDDã€DataFrameã€DataSetğŸ”º" class="headerlink" title="RDDã€DataFrameã€DataSetğŸ”º"></a>RDDã€DataFrameã€DataSetğŸ”º</h2><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200824213514197.png" alt="image-20200824213514197"></p><ul><li>RDDï¼šæ²¡æœ‰ç»“æ„å’Œç±»å‹</li><li>DataFrameï¼šæœ‰ç»“æ„æ²¡ç±»å‹ã€‚æ‰€ä»¥ç”±DFå˜ä¸ºRDDæ—¶ï¼ŒRDDå­˜å‚¨çš„æ˜¯ROWå¯¹è±¡ï¼Œæ­¤æ—¶åªèƒ½é€šè¿‡ç´¢å¼•è·å–å€¼ï¼Œå› ä¸ºå®ƒä¸å­˜å‚¨ç±»å‹</li><li>DataSetï¼šæœ‰ç»“æ„å’Œç±»å‹ã€‚æ‰€ä»¥DSå˜RDDæ—¶ï¼ŒRDDå­˜å‚¨çš„æ˜¯ç¡®å®šçš„ç±»ï¼Œå¯ä»¥é€šè¿‡ç±»è®¿é—®ç¡®å®šç±»å‹çš„å±æ€§</li></ul><p>ç”±äºä¸Šè¿°ä¸‰è€…çš„å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®šï¼š</p><ol><li>RDDè½¬æ¢DFæ—¶ï¼Œéœ€è¦è¯´æ˜ç»“æ„</li><li>RDDè½¬æ¢DSæ—¶ï¼Œéœ€è¦è¯´æ˜ç»“æ„å’Œç±»å‹ã€‚(ç±»åŒæ—¶åŒ…å«ç»“æ„å’Œç±»å‹)</li><li>DFè½¬RDDæ—¶ï¼Œç›´æ¥è½¬æ¢ï¼ŒRDDå­˜å‚¨ROW</li><li>DSè½¬RDDæ—¶ï¼Œç›´æ¥è½¬æ¢ï¼ŒRDDå­˜å‚¨å…·ä½“çš„ç±»</li></ol><h1 id="SparkSQLç¼–ç¨‹"><a href="#SparkSQLç¼–ç¨‹" class="headerlink" title="SparkSQLç¼–ç¨‹"></a>SparkSQLç¼–ç¨‹</h1><h2 id="SparkSessionæ–°çš„èµ·å§‹ç‚¹"><a href="#SparkSessionæ–°çš„èµ·å§‹ç‚¹" class="headerlink" title="SparkSessionæ–°çš„èµ·å§‹ç‚¹"></a>SparkSessionæ–°çš„èµ·å§‹ç‚¹</h2><p>åœ¨è€çš„ç‰ˆæœ¬ä¸­ï¼ŒSparkSQLæä¾›ä¸¤ç§SQLæŸ¥è¯¢èµ·å§‹ç‚¹ï¼šä¸€ä¸ªå«<code>SQLContext</code>ï¼Œç”¨äºSparkè‡ªå·±æä¾›çš„SQLæŸ¥è¯¢ï¼›ä¸€ä¸ªå«<code>HiveContext</code>ï¼Œç”¨äºè¿æ¥Hiveçš„æŸ¥è¯¢ã€‚</p><p>SparkSessionæ˜¯Sparkæœ€æ–°çš„SQLæŸ¥è¯¢èµ·å§‹ç‚¹ï¼Œå®è´¨ä¸Šæ˜¯SQLContextå’ŒHiveContextçš„ç»„åˆï¼Œæ‰€ä»¥åœ¨SQLContextå’ŒHiveContextä¸Šå¯ç”¨çš„APIåœ¨SparkSessionä¸ŠåŒæ ·æ˜¯å¯ä»¥ä½¿ç”¨çš„ã€‚<font color="red">**<code>SparkSession</code>å†…éƒ¨å°è£…äº†<code>sparkContext</code>ï¼Œæ‰€ä»¥è®¡ç®—å®é™…ä¸Šæ˜¯ç”±sparkContextå®Œæˆçš„ã€‚**</font></p><h2 id="DataFrame"><a href="#DataFrame" class="headerlink" title="DataFrame"></a>DataFrame</h2><p>DataFrameåªä¼šçŸ¥é“æ•°æ®çš„æ•´ä½“ç»“æ„ï¼Œå½“ä½ æŸ¥è¯¢ä¸€ä¸ªåˆ—å<code>name</code>æ—¶<strong>ï¼Œæ­¤æ—¶å®ƒå¹¶ä¸çŸ¥é“å®ƒçš„ç±»å‹ï¼Œå¦‚æœä½ è¿›è¡Œæ“ä½œç¼–è¯‘æ—¶ä¸ä¼šå‡ºé”™ï¼Œå½“è¿è¡Œæ—¶æ‰æœ‰å¯èƒ½å‡ºé”™ã€‚</strong></p><h3 id="åˆ›å»º"><a href="#åˆ›å»º" class="headerlink" title="åˆ›å»º"></a>åˆ›å»º</h3><p>åœ¨Spark SQLä¸­<code>SparkSession</code>æ˜¯åˆ›å»º<code>DataFrame</code>å’Œæ‰§è¡ŒSQL<strong>çš„å…¥å£</strong>ï¼Œåˆ›å»ºDataFrameæœ‰ä¸‰ç§æ–¹å¼ï¼š</p><ul><li>é€šè¿‡Sparkçš„æ•°æ®æºè¿›è¡Œåˆ›å»ºï¼›</li><li>ä»ä¸€ä¸ªå­˜åœ¨çš„RDDè¿›è¡Œè½¬æ¢ï¼›</li><li>è¿˜å¯ä»¥ä»Hive Tableè¿›è¡ŒæŸ¥è¯¢è¿”å›ã€‚</li></ul><h4 id="Sparkæ•°æ®æºåˆ›å»º"><a href="#Sparkæ•°æ®æºåˆ›å»º" class="headerlink" title="Sparkæ•°æ®æºåˆ›å»º"></a><strong>Sparkæ•°æ®æºåˆ›å»º</strong></h4><p>æŸ¥çœ‹Sparkæ•°æ®æºè¿›è¡Œåˆ›å»ºçš„æ–‡ä»¶æ ¼å¼</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; spark.read.</span><br><span class="line">csv   format   jdbc   json   load   option   options   orc   parquet   schema   table   text   textFile</span><br></pre></td></tr></table></figure><p><strong>è¯»å–jsonæ–‡ä»¶åˆ›å»ºDataFrame</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; <span class="keyword">val</span> df = spark.read.json(<span class="string">&quot;file:///home/hadoop/test.json&quot;</span>)</span><br><span class="line">df: org.apache.spark.sql.<span class="type">DataFrame</span> = [age: bigint, name: string]</span><br><span class="line"></span><br><span class="line">scala&gt; df.show</span><br><span class="line">+---+--------+</span><br><span class="line">|age|    name|</span><br><span class="line">+---+--------+</span><br><span class="line">| <span class="number">20</span>|zhangsan|</span><br><span class="line">| <span class="number">40</span>|    lisi|</span><br><span class="line">+---+--------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scala&gt;</span><br></pre></td></tr></table></figure><h4 id="RDDåˆ›å»º"><a href="#RDDåˆ›å»º" class="headerlink" title="RDDåˆ›å»º"></a>RDDåˆ›å»º</h4><p><a href="#RDD%E8%BD%ACDataFrame">ç‚¹å‡»è·³è½¬</a></p><h3 id="SQLé£æ ¼è¯­æ³•ğŸ”º"><a href="#SQLé£æ ¼è¯­æ³•ğŸ”º" class="headerlink" title="SQLé£æ ¼è¯­æ³•ğŸ”º"></a>SQLé£æ ¼è¯­æ³•ğŸ”º</h3><p>å¦‚æœæƒ³ä»¥SQLå½¢å¼è¯»å–æ•°æ®ï¼Œå°±å¿…é¡»æœ‰è¡¨ï¼Œä¸Šé¢æˆ‘ä»¬åˆ›å»ºçš„å¯¹è±¡<code>df</code>å¹¶ä¸æ˜¯è¡¨æ˜ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡è¿™ä¸ªå¯¹è±¡æ¥åˆ›å»ºä¸€ä¸ªä¸´æ—¶è§†å›¾<font color="red">ï¼Œæ—¢ç„¶æ˜¯è§†å›¾ï¼Œå¿…ç„¶åªå¯ä»¥æŸ¥è¯¢ã€‚</font>ç„¶åå°±å¯ä»¥é€šè¿‡è§†å›¾åæ¥ç¼–å†™SQLæ¥æŸ¥è¯¢äº†ï¼ï¼</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; df.create</span><br><span class="line">createGlobalTempView   createOrReplaceTempView   createTempView</span><br><span class="line"></span><br><span class="line">scala&gt; df.createTempView(<span class="string">&quot;table&quot;</span>)</span><br><span class="line"></span><br><span class="line">scala&gt; spark.sql(<span class="string">&quot;select * from table where age=40&quot;</span>).show</span><br><span class="line">+---+----+</span><br><span class="line">|age|name|</span><br><span class="line">+---+----+</span><br><span class="line">| <span class="number">40</span>|lisi|</span><br><span class="line">+---+----+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scala&gt;</span><br></pre></td></tr></table></figure><p><font color="red"><strong>æ³¨æ„</strong>ï¼šä¸´æ—¶è¡¨æ˜¯SessionèŒƒå›´å†…çš„ï¼ŒSessioné€€å‡ºåï¼Œè¡¨å°±å¤±æ•ˆäº†ã€‚</font>å¦‚æœæƒ³åº”ç”¨èŒƒå›´å†…æœ‰æ•ˆï¼Œå¯ä»¥ä½¿ç”¨å…¨å±€è¡¨ã€‚æ³¨æ„ä½¿ç”¨å…¨å±€è¡¨æ—¶éœ€è¦å…¨è·¯å¾„è®¿é—®ï¼Œå¦‚ï¼šglobal_temp.people</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; spark.newSession.sql(<span class="string">&quot;select * from table where age=40&quot;</span>).show <span class="comment">// é”™è¯¯</span></span><br><span class="line">scala&gt; df.createGlobalTempView(<span class="string">&quot;tmp&quot;</span>)</span><br><span class="line"></span><br><span class="line">scala&gt; spark.newSession.sql(<span class="string">&quot;select * from global_temp.tmp&quot;</span>).show</span><br><span class="line">+---+--------+</span><br><span class="line">|age|    name|</span><br><span class="line">+---+--------+</span><br><span class="line">| <span class="number">20</span>|zhangsan|</span><br><span class="line">| <span class="number">40</span>|    lisi|</span><br><span class="line">+---+--------+</span><br><span class="line"></span><br><span class="line">scala&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¦‚æœä½¿ç”¨å…¨å±€è¡¨çš„è¯ï¼Œæ— è®ºå“ªä¸ªSessionç¯å¢ƒéƒ½å¿…é¡»ä½¿ç”¨<code>global_temp.xxx</code>å½¢å¼è®¿é—®ã€‚</p><h3 id="DSLé£æ ¼è¯­æ³•"><a href="#DSLé£æ ¼è¯­æ³•" class="headerlink" title="DSLé£æ ¼è¯­æ³•"></a>DSLé£æ ¼è¯­æ³•</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; df.select(<span class="string">&quot;name&quot;</span>).show</span><br><span class="line">+--------+</span><br><span class="line">|    name|</span><br><span class="line">+--------+</span><br><span class="line">|zhangsan|</span><br><span class="line">|    lisi|</span><br><span class="line">+--------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scala&gt; df.select($<span class="string">&quot;age&quot;</span>+<span class="number">1</span>).show</span><br><span class="line">+---------+</span><br><span class="line">|(age + <span class="number">1</span>)|</span><br><span class="line">+---------+</span><br><span class="line">|       <span class="number">21</span>|</span><br><span class="line">|       <span class="number">41</span>|</span><br><span class="line">+---------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scala&gt;</span><br></pre></td></tr></table></figure><ul><li><code>select</code>ï¼šåªæŸ¥çœ‹æŒ‡å®šåˆ—æ•°æ®</li><li><code>select($&quot;&quot;)</code>ï¼šä»¥æ­¤åˆ—ä¸ºå˜é‡è¿›è¡Œå…¶ä»–è®¡ç®—</li></ul><h3 id="RDDè½¬DataFrame"><a href="#RDDè½¬DataFrame" class="headerlink" title="RDDè½¬DataFrame"></a>RDDè½¬DataFrame</h3><p>æ³¨æ„ï¼šå¦‚æœéœ€è¦RDDä¸DFæˆ–è€…DSä¹‹é—´æ“ä½œï¼Œ<font color="red">é‚£ä¹ˆéƒ½éœ€è¦å¼•å…¥<code> import spark.implicits._</code>Â <strong>ã€sparkä¸æ˜¯åŒ…åï¼Œè€Œæ˜¯sparkSessionå¯¹è±¡çš„åç§°ã€‘</strong></font></p><p><strong>å‰ç½®æ¡ä»¶ï¼š<font color="red">å¯¼å…¥éšå¼è½¬æ¢å¹¶åˆ›å»ºä¸€ä¸ªRDD</font></strong></p><p><strong>1. é€šè¿‡æ‰‹åŠ¨æŒ‡å®šç»“æ„</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; <span class="keyword">import</span> spark.implicits._</span><br><span class="line"><span class="keyword">import</span> spark.implicits._</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> rdd = sc.makeRDD(<span class="number">1</span> to <span class="number">10</span>)</span><br><span class="line">rdd: org.apache.spark.rdd.<span class="type">RDD</span>[<span class="type">Int</span>] = <span class="type">ParallelCollectionRDD</span>[<span class="number">20</span>] at makeRDD at &lt;console&gt;:<span class="number">27</span></span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> df = rdd.toDF(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">df: org.apache.spark.sql.<span class="type">DataFrame</span> = [id: int]</span><br><span class="line"></span><br><span class="line">scala&gt; df.show</span><br><span class="line">+---+</span><br><span class="line">| id|</span><br><span class="line">+---+</span><br><span class="line">|  <span class="number">1</span>|</span><br><span class="line">|  <span class="number">2</span>|</span><br><span class="line">|  <span class="number">3</span>|</span><br><span class="line">|  <span class="number">4</span>|</span><br><span class="line">|  <span class="number">5</span>|</span><br><span class="line">|  <span class="number">6</span>|</span><br><span class="line">|  <span class="number">7</span>|</span><br><span class="line">|  <span class="number">8</span>|</span><br><span class="line">|  <span class="number">9</span>|</span><br><span class="line">| <span class="number">10</span>|</span><br><span class="line">+---+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scala&gt;</span><br></pre></td></tr></table></figure><p><strong>2. é€šè¿‡æ ·ä¾‹ç±»æŒ‡å®šç»“æ„ï¼Œç±»åŒæ—¶åŒ…å«ç»“æ„å’Œç±»å‹</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; <span class="keyword">import</span> spark.implicits._</span><br><span class="line"><span class="keyword">import</span> spark.implicits._</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> rdd = sc.makeRDD(<span class="type">List</span>((<span class="string">&quot;zhangsan&quot;</span>,<span class="number">20</span>), (<span class="string">&quot;lisi&quot;</span>,<span class="number">20</span>)))</span><br><span class="line">rdd: org.apache.spark.rdd.<span class="type">RDD</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = <span class="type">ParallelCollectionRDD</span>[<span class="number">24</span>] at makeRDD at &lt;console&gt;:<span class="number">27</span></span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">user</span>(<span class="params">name:<span class="type">String</span>, age:<span class="type">Int</span></span>)</span></span><br><span class="line"><span class="class"><span class="title">defined</span> <span class="title">class</span> <span class="title">user</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">scala&gt;</span> <span class="title">val</span> <span class="title">mapRdd</span> </span>= rdd.map(x=&gt;&#123;user(x._1, x._2)&#125;)</span><br><span class="line">mapRdd: org.apache.spark.rdd.<span class="type">RDD</span>[user] = <span class="type">MapPartitionsRDD</span>[<span class="number">25</span>] at map at &lt;console&gt;:<span class="number">31</span></span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> df = mapRdd.toDF</span><br><span class="line">df: org.apache.spark.sql.<span class="type">DataFrame</span> = [name: string, age: int]</span><br><span class="line"></span><br><span class="line">scala&gt; df.show</span><br><span class="line">+--------+---+</span><br><span class="line">|    name|age|</span><br><span class="line">+--------+---+</span><br><span class="line">|zhangsan| <span class="number">20</span>|</span><br><span class="line">|    lisi| <span class="number">20</span>|</span><br><span class="line">+--------+---+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scala&gt;</span><br></pre></td></tr></table></figure><h3 id="DataFrameè½¬RDD"><a href="#DataFrameè½¬RDD" class="headerlink" title="DataFrameè½¬RDD"></a>DataFrameè½¬RDD</h3><p>DataFrameï¼šæœ‰ç»“æ„æ²¡ç±»å‹ã€‚æ‰€ä»¥ç”±DFå˜ä¸ºRDDæ—¶ï¼ŒRDDå­˜å‚¨çš„æ˜¯ROWå¯¹è±¡ï¼Œæ­¤æ—¶åªèƒ½é€šè¿‡ç´¢å¼•è·å–å€¼ï¼Œå› ä¸ºå®ƒä¸å­˜å‚¨ç±»å‹</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; <span class="keyword">val</span> dfToRDD = df.rdd</span><br><span class="line">dfToRDD: org.apache.spark.rdd.<span class="type">RDD</span>[org.apache.spark.sql.<span class="type">Row</span>] = <span class="type">MapPartitionsRDD</span>[<span class="number">35</span>] at rdd at &lt;console&gt;:<span class="number">35</span></span><br><span class="line"></span><br><span class="line">scala&gt; dfToRDD.collect</span><br><span class="line">res11: <span class="type">Array</span>[org.apache.spark.sql.<span class="type">Row</span>] = <span class="type">Array</span>([zhangsan,<span class="number">20</span>], [lisi,<span class="number">20</span>])</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¯·æ³¨æ„<code>Row</code>å¯¹è±¡ï¼Œå®ƒåªèƒ½ç´¢å¼•è®¿é—®å…ƒç´ ï¼Œè€Œä¸”å®ƒä¸çŸ¥é“å­—æ®µçš„ç±»å‹</p><h2 id="DataSet"><a href="#DataSet" class="headerlink" title="DataSet"></a>DataSet</h2><h3 id="åˆ›å»º-1"><a href="#åˆ›å»º-1" class="headerlink" title="åˆ›å»º"></a>åˆ›å»º</h3><p><font color="red">å› ä¸º<code>DataSet</code>åˆ›å»ºæ—¶åŒæ—¶éœ€è¦ç»“æ„å’Œç±»å‹ï¼Œè¿™æ—¶å°±éœ€è¦ä½¿ç”¨åˆ°æ ·ä¾‹ç±»äº†ï¼Œå› ä¸ºç±»æ—¢æœ‰ç»“æ„åˆæœ‰ç±»å‹ã€‚</font>é€šè¿‡ç±»åˆ›å»ºDataSetå¾ˆæ–¹ä¾¿ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; <span class="keyword">import</span> spark.implicits._</span><br><span class="line"><span class="keyword">import</span> spark.implicits._</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span>(<span class="params">name: <span class="type">String</span>, age: <span class="type">Long</span></span>)</span></span><br><span class="line"><span class="class"><span class="title">defined</span> <span class="title">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">scala&gt;</span>  <span class="title">val</span> <span class="title">caseClassDS</span> </span>= <span class="type">Seq</span>(<span class="type">Person</span>(<span class="string">&quot;Andy&quot;</span>, <span class="number">32</span>)).toDS()</span><br><span class="line">caseClassDS: org.apache.spark.sql.<span class="type">Dataset</span>[<span class="type">Person</span>] = [name: string, age: bigint]</span><br><span class="line"></span><br><span class="line">scala&gt;</span><br></pre></td></tr></table></figure><h3 id="RDDè½¬DataSet"><a href="#RDDè½¬DataSet" class="headerlink" title="RDDè½¬DataSet"></a>RDDè½¬DataSet</h3><p>SparkSQLèƒ½å¤Ÿè‡ªåŠ¨å°†åŒ…å«æœ‰<code>case</code>ç±»çš„RDDè½¬æ¢æˆDataFrameï¼Œ<code>case</code>ç±»å®šä¹‰äº†tableçš„ç»“æ„ï¼Œ<font color="red"><strong>caseç±»å±æ€§é€šè¿‡åå°„å˜æˆäº†è¡¨çš„åˆ—åã€‚</strong></font></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; <span class="keyword">import</span> spark.implicits._</span><br><span class="line"><span class="keyword">import</span> spark.implicits._</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> rdd = sc.makeRDD(<span class="type">List</span>((<span class="string">&quot;zhangsan&quot;</span>,<span class="number">20</span>), (<span class="string">&quot;lisi&quot;</span>,<span class="number">20</span>)))</span><br><span class="line">rdd: org.apache.spark.rdd.<span class="type">RDD</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = <span class="type">ParallelCollectionRDD</span>[<span class="number">24</span>] at makeRDD at &lt;console&gt;:<span class="number">27</span></span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">user</span>(<span class="params">name:<span class="type">String</span>, age:<span class="type">Int</span></span>)</span></span><br><span class="line"><span class="class"><span class="title">defined</span> <span class="title">class</span> <span class="title">user</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">scala&gt;</span> <span class="title">val</span> <span class="title">mapRdd</span> </span>= rdd.map(x=&gt;&#123;user(x._1, x._2)&#125;)</span><br><span class="line">mapRdd: org.apache.spark.rdd.<span class="type">RDD</span>[user] = <span class="type">MapPartitionsRDD</span>[<span class="number">25</span>] at map at &lt;console&gt;:<span class="number">31</span></span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> ds = mapRdd.toDS</span><br></pre></td></tr></table></figure><h3 id="DataSetè½¬RDD"><a href="#DataSetè½¬RDD" class="headerlink" title="DataSetè½¬RDD"></a>DataSetè½¬RDD</h3><p>è°ƒç”¨rddæ–¹æ³•å³å¯ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span>(<span class="params">name: <span class="type">String</span>, age: <span class="type">Long</span></span>)</span></span><br><span class="line"><span class="class"><span class="title">defined</span> <span class="title">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">scala&gt;</span>  <span class="title">val</span> <span class="title">caseClassDS</span> </span>= <span class="type">Seq</span>(<span class="type">Person</span>(<span class="string">&quot;Andy&quot;</span>, <span class="number">32</span>)).toDS()</span><br><span class="line">caseClassDS: org.apache.spark.sql.<span class="type">Dataset</span>[<span class="type">Person</span>] = [name: string, age: bigint]</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> rdd = caseClassDS.rdd</span><br><span class="line">rdd: org.apache.spark.rdd.<span class="type">RDD</span>[<span class="type">Person</span>] = <span class="type">MapPartitionsRDD</span>[<span class="number">39</span>] at rdd at &lt;console&gt;:<span class="number">30</span></span><br><span class="line"></span><br><span class="line">scala&gt;</span><br></pre></td></tr></table></figure><h2 id="DataSetä¸DataFrameçš„äº’æ“ä½œ"><a href="#DataSetä¸DataFrameçš„äº’æ“ä½œ" class="headerlink" title="DataSetä¸DataFrameçš„äº’æ“ä½œ"></a>DataSetä¸DataFrameçš„äº’æ“ä½œ</h2><ol><li>DataFrameä¸DataSetç›¸æ¯”çš„è¯å°‘äº†ç±»å‹ï¼Œæ‰€ä»¥å°†DFçš„ç»“æ„æ·»åŠ ç±»å‹å³å¯ï¼Œå¯ä»¥é€šè¿‡<font color="red"><strong>caseç±»å±æ€§é€šè¿‡åå°„å˜æˆäº†è¡¨çš„åˆ—åã€‚</strong></font>ä¸»è¦æ“ä½œ<code>df.as[ç±»]</code></li><li>DataSetä¸DataFrameç›¸æ¯”çš„è¯ï¼Œå•¥ä¹Ÿä¸ç¼ºï¼Œç›´æ¥è½¬æ¢å³å¯ï¼š<code>ds.toDF</code></li></ol><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span>(<span class="params">name: <span class="type">String</span>, age: <span class="type">Long</span></span>)</span></span><br><span class="line"><span class="class"><span class="title">defined</span> <span class="title">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">scala&gt;</span>  <span class="title">val</span> <span class="title">caseClassDS</span> </span>= <span class="type">Seq</span>(<span class="type">Person</span>(<span class="string">&quot;Andy&quot;</span>, <span class="number">32</span>)).toDS()</span><br><span class="line">caseClassDS: org.apache.spark.sql.<span class="type">Dataset</span>[<span class="type">Person</span>] = [name: string, age: bigint]</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> df = caseClassDS.toDF</span><br><span class="line">df: org.apache.spark.sql.<span class="type">DataFrame</span> = [name: string, age: bigint]</span><br><span class="line"></span><br><span class="line">scala&gt; <span class="keyword">val</span> ds = df.as[<span class="type">Person</span>]</span><br><span class="line">ds: org.apache.spark.sql.<span class="type">Dataset</span>[<span class="type">Person</span>] = [name: string, age: bigint]</span><br><span class="line"></span><br><span class="line">scala&gt;</span><br></pre></td></tr></table></figure><h1 id="Ideaåˆ›å»ºSpark-SQLç¨‹åº"><a href="#Ideaåˆ›å»ºSpark-SQLç¨‹åº" class="headerlink" title="Ideaåˆ›å»ºSpark SQLç¨‹åº"></a>Ideaåˆ›å»ºSpark SQLç¨‹åº</h1><p>IDEAä¸­ç¨‹åºçš„æ‰“åŒ…å’Œè¿è¡Œæ–¹å¼éƒ½å’Œ<code>SparkCore</code>ç±»ä¼¼ï¼Œéœ€è¦æ³¨æ„<code>Spark SQL</code>ç¨‹åºéœ€è¦å¼•å…¥ä»¥ä¸‹åŒ…ï¼Œ<font color="red"><code>SparkCore</code>çš„åŒ…ä¸­æ˜¯æ²¡æœ‰<code>SparkSQL</code>çš„å¼€å‘ç¯å¢ƒçš„</font></p><p><strong>Mavenä¾èµ–ä¸­éœ€è¦æ·»åŠ æ–°çš„ä¾èµ–é¡¹ï¼š</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-sql_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>ç¨‹åºç¯å¢ƒä¸‰éƒ¨æ›²</strong></p><ol><li>ç¯å¢ƒé…ç½®å¯¹è±¡<code>sparkConfig</code></li><li>SparkSQLç¯å¢ƒ<code>sparkSession</code></li><li>DFä¸DSçš„ç›¸äº’éšå¼è½¬æ¢å¯¼å…¥<code>import spark.implicits._</code></li></ol><p>æ³¨æ„ï¼šå¦‚æœéœ€è¦RDDä¸DFæˆ–è€…DSä¹‹é—´æ“ä½œï¼Œ<font color="red">é‚£ä¹ˆéƒ½éœ€è¦å¼•å…¥<code> import spark.implicits._</code> <strong>ã€sparkä¸æ˜¯åŒ…åï¼Œè€Œæ˜¯sparkSessionå¯¹è±¡çš„åç§°ã€‘</strong></font></p><p><strong>ç¨‹åºå¦‚ä¸‹</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">SparkSql</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºé…ç½®å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">val</span> config: <span class="type">SparkConf</span> = <span class="keyword">new</span> <span class="type">SparkConf</span>().setMaster(<span class="string">&quot;local[*]&quot;</span>).setAppName(<span class="string">&quot;sql&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºSparkSQLç¯å¢ƒ</span></span><br><span class="line">    <span class="keyword">val</span> spark: <span class="type">SparkSession</span> = <span class="type">SparkSession</span>.builder().config(config).getOrCreate()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éšå¼è½¬æ¢</span></span><br><span class="line">    <span class="keyword">import</span> spark.implicits._</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SparkSessionåŒ…å«äº†SparkContext</span></span><br><span class="line">    <span class="keyword">val</span> initRDD: <span class="type">RDD</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = spark.sparkContext.makeRDD(<span class="type">List</span>((<span class="string">&quot;zhangsan&quot;</span>, <span class="number">20</span>), (<span class="string">&quot;zhang&quot;</span>, <span class="number">30</span>)))</span><br><span class="line">    <span class="keyword">val</span> df: <span class="type">DataFrame</span> = initRDD.map(x =&gt; person(x._1, x._2)).toDF()</span><br><span class="line">    <span class="keyword">val</span> ds: <span class="type">Dataset</span>[person] = initRDD.map(x =&gt; person(x._1, x._2)).toDS()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> rdd: <span class="type">RDD</span>[<span class="type">Row</span>] = df.rdd</span><br><span class="line">    <span class="keyword">val</span> rdd1: <span class="type">RDD</span>[person] = ds.rdd</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">person</span>(<span class="params">name:<span class="type">String</span>, age:<span class="type">Int</span></span>)</span></span><br></pre></td></tr></table></figure><p><font color="red"></font></p><h1 id="ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°"><a href="#ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°" class="headerlink" title="ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°"></a>ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°</h1><h2 id="UDF"><a href="#UDF" class="headerlink" title="UDF"></a>UDF</h2><p>ä¸€å¯¹ä¸€ã€‚</p><p>å¾ˆç®€å•ï¼Œç›´æ¥é‡‡ç”¨åŒ¿åå‡½æ•°å³å¯ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">SparkSql</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºé…ç½®å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">val</span> config: <span class="type">SparkConf</span> = <span class="keyword">new</span> <span class="type">SparkConf</span>().setMaster(<span class="string">&quot;local[*]&quot;</span>).setAppName(<span class="string">&quot;udf&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºSparkSQLç¯å¢ƒ</span></span><br><span class="line">    <span class="keyword">val</span> spark: <span class="type">SparkSession</span> = <span class="type">SparkSession</span>.builder().config(config).getOrCreate()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éšå¼è½¬æ¢</span></span><br><span class="line">    <span class="keyword">import</span> spark.implicits._</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SparkSessionåŒ…å«äº†SparkContext</span></span><br><span class="line">    <span class="keyword">val</span> initRDD: <span class="type">RDD</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = spark.sparkContext.makeRDD(<span class="type">List</span>((<span class="string">&quot;zhangsan&quot;</span>, <span class="number">20</span>), (<span class="string">&quot;zhang&quot;</span>, <span class="number">30</span>)))</span><br><span class="line">    <span class="keyword">val</span> df: <span class="type">DataFrame</span> = initRDD.map(x =&gt; person(x._1, x._2)).toDF()</span><br><span class="line">    <span class="keyword">val</span> ds: <span class="type">Dataset</span>[person] = initRDD.map(x =&gt; person(x._1, x._2)).toDS()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --------dfä¸dsä½¿ç”¨æ–¹æ³•ä¸€è‡´ --------------</span></span><br><span class="line">    ds.createTempView(<span class="string">&quot;ds_table&quot;</span>)</span><br><span class="line">    spark.udf.register(<span class="string">&quot;addName&quot;</span>, (x:<span class="type">String</span>)=&gt; <span class="string">&quot;Name:&quot;</span>+x)</span><br><span class="line">    spark.sql(<span class="string">&quot;select addName(name) from ds_table&quot;</span>).show()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">person</span>(<span class="params">name:<span class="type">String</span>, age:<span class="type">Int</span></span>)</span></span><br></pre></td></tr></table></figure><h2 id="UDAF"><a href="#UDAF" class="headerlink" title="UDAF"></a>UDAF</h2><p>ç”¨æˆ·è‡ªå®šä¹‰èšåˆå‡½æ•°</p><p><code>å¼ºç±»å‹çš„Dataset</code>å’Œ<code>å¼±ç±»å‹çš„DataFrame</code>éƒ½æä¾›äº†ç›¸å…³çš„èšåˆå‡½æ•°ï¼Œ å¦‚ count()ï¼ŒcountDistinct()ï¼Œavg()ï¼Œmax()ï¼Œmin()ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œç”¨æˆ·å¯ä»¥è®¾å®š<strong>è‡ªå·±çš„è‡ªå®šä¹‰èšåˆå‡½æ•°</strong>ã€‚</p><h3 id="å¼±ç±»å‹è‡ªå®šä¹‰å‡½æ•°"><a href="#å¼±ç±»å‹è‡ªå®šä¹‰å‡½æ•°" class="headerlink" title="å¼±ç±»å‹è‡ªå®šä¹‰å‡½æ•°"></a>å¼±ç±»å‹è‡ªå®šä¹‰å‡½æ•°</h3><p>å¼±ç±»å‹ç”¨æˆ·è‡ªå®šä¹‰èšåˆå‡½æ•°ï¼šé€šè¿‡ç»§æ‰¿<code>UserDefinedAggregateFunction</code>æ¥å®ç°ç”¨æˆ·è‡ªå®šä¹‰èšåˆå‡½æ•°ã€‚ä¸‹é¢å±•ç¤ºä¸€ä¸ªæ±‚å¹³å‡å·¥èµ„çš„è‡ªå®šä¹‰èšåˆå‡½æ•°ã€‚</p><p>ç¼ºç‚¹ï¼šéœ€è¦è‡ªå·±æ‰‹åŠ¨è¾“å…¥å„ç§ç±»å‹ï¼Œåœ¨ç¼–å†™é€»è¾‘æ—¶åªèƒ½é€šè¿‡ç´¢å¼•æ‹¿åˆ°å€¼ï¼Œå¿…é¡»å’Œè®¾ç½®ç±»å‹æ—¶é¡ºåºä¸€è‡´ï¼Œå¦åˆ™è¿è¡Œæ—¶åå‡ºç°é—®é¢˜ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">SparkSql</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºé…ç½®å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">val</span> config: <span class="type">SparkConf</span> = <span class="keyword">new</span> <span class="type">SparkConf</span>().setMaster(<span class="string">&quot;local[*]&quot;</span>).setAppName(<span class="string">&quot;udf&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºSparkSQLç¯å¢ƒ</span></span><br><span class="line">    <span class="keyword">val</span> spark: <span class="type">SparkSession</span> = <span class="type">SparkSession</span>.builder().config(config).getOrCreate()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éšå¼è½¬æ¢</span></span><br><span class="line">    <span class="keyword">import</span> spark.implicits._</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SparkSessionåŒ…å«äº†SparkContext</span></span><br><span class="line">    <span class="keyword">val</span> initRDD: <span class="type">RDD</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = spark.sparkContext.makeRDD(<span class="type">List</span>((<span class="string">&quot;zhangsan&quot;</span>, <span class="number">20</span>), (<span class="string">&quot;zhang&quot;</span>, <span class="number">30</span>)))</span><br><span class="line">    <span class="keyword">val</span> df: <span class="type">DataFrame</span> = initRDD.map(x =&gt; person(x._1, x._2)).toDF()</span><br><span class="line">    <span class="keyword">val</span> ds: <span class="type">Dataset</span>[person] = initRDD.map(x =&gt; person(x._1, x._2)).toDS()</span><br><span class="line"></span><br><span class="line">    ds.createTempView(<span class="string">&quot;ds_table&quot;</span>)</span><br><span class="line">    <span class="comment">// æ³¨å†Œèšåˆå‡½æ•°</span></span><br><span class="line">    <span class="keyword">val</span> avg = <span class="keyword">new</span> myAvg</span><br><span class="line">    spark.udf.register(<span class="string">&quot;myavg&quot;</span>, avg)</span><br><span class="line">    <span class="comment">// å¼±ç±»å‹å¯ä»¥é€šè¿‡sqlæˆ–è€…DSLä¸¤ç§æ¨¡å¼æŸ¥è¯¢ï¼Œé€šè¿‡SQLå› ä¸ºå®ƒçš„è¾“å…¥åªæ˜¯ä¸€ä¸ªå€¼è€Œå·²</span></span><br><span class="line">    spark.sql(<span class="string">&quot;select myavg(age) from ds_table&quot;</span>).show()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">person</span>(<span class="params">name: <span class="type">String</span>, age: <span class="type">Int</span></span>)</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">myAvg</span> <span class="keyword">extends</span> <span class="title">UserDefinedAggregateFunction</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è¾“å…¥å€¼çš„ç±»å‹</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">inputSchema</span></span>: <span class="type">StructType</span> = &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="type">StructType</span>().add(<span class="string">&quot;age&quot;</span>, <span class="type">LongType</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç”¨æˆ·è‡ªå®šä¹‰å¤„ç†å‡½æ•°å†…éƒ¨ä½¿ç”¨çš„å˜é‡çš„ç±»å‹</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">bufferSchema</span></span>: <span class="type">StructType</span> = &#123;</span><br><span class="line">    <span class="comment">// è®°ä½é¡ºåºï¼Œåé¢çš„æ“ä½œå…¨æ˜¯æœ‰åºçš„</span></span><br><span class="line">    <span class="keyword">new</span> <span class="type">StructType</span>().add(<span class="string">&quot;sum&quot;</span>, <span class="type">LongType</span>).add(<span class="string">&quot;count&quot;</span>, <span class="type">LongType</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿”å›çš„ç±»å‹</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">dataType</span></span>: <span class="type">DataType</span> = <span class="type">DoubleType</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯¹äºç›¸åŒçš„è¾“å…¥æ˜¯å¦ä¸€ç›´è¿”å›ç›¸åŒçš„è¾“å‡ºï¼›å‡½æ•°çš„ç¨³å®šæ€§</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">deterministic</span></span>: <span class="type">Boolean</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// çœ‹åˆ°bufferå°±æ˜¯å·¥ä½œåŒºï¼Œå‡½æ•°å†…éƒ¨å˜é‡çš„åˆå§‹åŒ–</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span>(buffer: <span class="type">MutableAggregationBuffer</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    buffer(<span class="number">0</span>) = <span class="number">0</span>L <span class="comment">// sum</span></span><br><span class="line">    buffer(<span class="number">1</span>) = <span class="number">0</span>L <span class="comment">// count</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// bufferæ˜¯å·¥ä½œåŒºï¼Œinputæ˜¯å‡½æ•°çš„è¾“å…¥ã€‚è¿™ä¸ªå‡½æ•°å°±æ˜¯æ¯æ¬¡æ¥æ–°çš„è¾“å…¥å€¼æ—¶ï¼Œå‡½æ•°å†…éƒ¨å˜é‡çš„å˜åŒ–</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">update</span></span>(buffer: <span class="type">MutableAggregationBuffer</span>, input: <span class="type">Row</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    buffer(<span class="number">0</span>) = buffer.getLong(<span class="number">0</span>) + input.getLong(<span class="number">0</span>) <span class="comment">// sum</span></span><br><span class="line">    buffer(<span class="number">1</span>) = buffer.getLong(<span class="number">1</span>) + <span class="number">1</span> <span class="comment">// count</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤šä¸ªExecutoræ‰§è¡Œåï¼Œå½¢æˆå¤šä¸ªbuffer  æœ€ååˆå¹¶åˆ°ä¸€èµ·</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">merge</span></span>(buffer1: <span class="type">MutableAggregationBuffer</span>, buffer2: <span class="type">Row</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    buffer1(<span class="number">0</span>) = buffer1.getLong(<span class="number">0</span>) + buffer2.getLong(<span class="number">0</span>)</span><br><span class="line">    buffer1(<span class="number">1</span>) = buffer1.getLong(<span class="number">1</span>) + buffer2.getLong(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æœ€åçš„ç»“æœ</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">evaluate</span></span>(buffer: <span class="type">Row</span>): <span class="type">Any</span> = &#123;</span><br><span class="line">    buffer.getLong(<span class="number">0</span>).toDouble / buffer.getLong(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> <font color="red"><strong>å¼±ç±»å‹å¯ä»¥é€šè¿‡sqlæˆ–è€…DSLä¸¤ç§æ¨¡å¼æŸ¥è¯¢ï¼Œé€šè¿‡SQLå› ä¸ºå®ƒçš„è¾“å…¥åªæ˜¯ä¸€ä¸ªå€¼è€Œå·²</strong></font></p><h3 id="å¼ºç±»å‹è‡ªå®šä¹‰å‡½æ•°"><a href="#å¼ºç±»å‹è‡ªå®šä¹‰å‡½æ•°" class="headerlink" title="å¼ºç±»å‹è‡ªå®šä¹‰å‡½æ•°"></a>å¼ºç±»å‹è‡ªå®šä¹‰å‡½æ•°</h3><p>å¼ºç±»å‹ç”¨æˆ·è‡ªå®šä¹‰èšåˆå‡½æ•°ï¼šé€šè¿‡ç»§æ‰¿<code>Aggregator</code>æ¥å®ç°å¼ºç±»å‹è‡ªå®šä¹‰èšåˆå‡½æ•°ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">SparkSql</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºé…ç½®å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">val</span> config: <span class="type">SparkConf</span> = <span class="keyword">new</span> <span class="type">SparkConf</span>().setMaster(<span class="string">&quot;local[*]&quot;</span>).setAppName(<span class="string">&quot;udf&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºSparkSQLç¯å¢ƒ</span></span><br><span class="line">    <span class="keyword">val</span> spark: <span class="type">SparkSession</span> = <span class="type">SparkSession</span>.builder().config(config).getOrCreate()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éšå¼è½¬æ¢</span></span><br><span class="line">    <span class="keyword">import</span> spark.implicits._</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SparkSessionåŒ…å«äº†SparkContext</span></span><br><span class="line">    <span class="keyword">val</span> initRDD: <span class="type">RDD</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = spark.sparkContext.makeRDD(<span class="type">List</span>((<span class="string">&quot;zhangsan&quot;</span>, <span class="number">20</span>), (<span class="string">&quot;zhang&quot;</span>, <span class="number">30</span>)))</span><br><span class="line">    <span class="keyword">val</span> df: <span class="type">DataFrame</span> = initRDD.map(x =&gt; person(x._1, x._2)).toDF()</span><br><span class="line">    <span class="keyword">val</span> ds: <span class="type">Dataset</span>[person] = initRDD.map(x =&gt; person(x._1, x._2)).toDS()</span><br><span class="line"></span><br><span class="line">    ds.createTempView(<span class="string">&quot;ds_table&quot;</span>)</span><br><span class="line">    <span class="comment">// æ³¨å†Œèšåˆå‡½æ•°</span></span><br><span class="line">    <span class="keyword">val</span> avg = <span class="keyword">new</span> <span class="type">StrongAvg</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä½†æ˜¯ä¸èƒ½ä½¿ç”¨SQLå½¢å¼ï¼Œå› ä¸ºæˆ‘ä»¬å¼ºç±»å‹è¾“å…¥çš„å€¼æ˜¯ä¸€ä¸ªç±»ï¼Œç”¨sqlç¼–å†™å¦‚ä½•ä¼ é€ç»™å‡½æ•°ç»“æ„åŠ ç±»å‹ï¼Œé‚£ä¹ˆé€šè¿‡æœ‰ç»“æ„å’Œç±»å‹çš„åªæœ‰DS</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨DSçš„DSLæ–¹å¼æŸ¥è¯¢</span></span><br><span class="line">    <span class="comment">// å°†èšåˆå‡½æ•°è½¬æ¢ä¸ºæŸ¥è¯¢åˆ—</span></span><br><span class="line">    <span class="keyword">val</span> value: <span class="type">TypedColumn</span>[person, <span class="type">Double</span>] = avg.toColumn.name(<span class="string">&quot;avg&quot;</span>)</span><br><span class="line"></span><br><span class="line">    ds.select(value).show()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">person</span>(<span class="params">name: <span class="type">String</span>, age: <span class="type">Int</span></span>)</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="comment">// !!!å› ä¸ºæ ·ä¾‹ç±»å±æ€§é»˜è®¤valï¼Œéœ€è¦æ‰‹åŠ¨è®¾ç½®ä¸ºvar</span></span></span><br><span class="line"><span class="class"><span class="title">case</span> <span class="title">class</span> <span class="title">dealwith</span>(<span class="params">var sum: <span class="type">Long</span>, var count: <span class="type">Long</span></span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myAvg</span> <span class="keyword">extends</span> <span class="title">UserDefinedAggregateFunction</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è¾“å…¥å€¼çš„ç±»å‹</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">inputSchema</span></span>: <span class="type">StructType</span> = &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="type">StructType</span>().add(<span class="string">&quot;age&quot;</span>, <span class="type">LongType</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç”¨æˆ·è‡ªå®šä¹‰å¤„ç†å‡½æ•°å†…éƒ¨ä½¿ç”¨çš„å˜é‡çš„ç±»å‹</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">bufferSchema</span></span>: <span class="type">StructType</span> = &#123;</span><br><span class="line">    <span class="comment">// è®°ä½é¡ºåºï¼Œåé¢çš„æ“ä½œå…¨æ˜¯æœ‰åºçš„</span></span><br><span class="line">    <span class="keyword">new</span> <span class="type">StructType</span>().add(<span class="string">&quot;sum&quot;</span>, <span class="type">LongType</span>).add(<span class="string">&quot;count&quot;</span>, <span class="type">LongType</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿”å›çš„ç±»å‹</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">dataType</span></span>: <span class="type">DataType</span> = <span class="type">DoubleType</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯¹äºç›¸åŒçš„è¾“å…¥æ˜¯å¦ä¸€ç›´è¿”å›ç›¸åŒçš„è¾“å‡ºï¼›å‡½æ•°çš„ç¨³å®šæ€§</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">deterministic</span></span>: <span class="type">Boolean</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// çœ‹åˆ°bufferå°±æ˜¯å·¥ä½œåŒºï¼Œå‡½æ•°å†…éƒ¨å˜é‡çš„åˆå§‹åŒ–</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span>(buffer: <span class="type">MutableAggregationBuffer</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    buffer(<span class="number">0</span>) = <span class="number">0</span>L <span class="comment">// sum</span></span><br><span class="line">    buffer(<span class="number">1</span>) = <span class="number">0</span>L <span class="comment">// count</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// bufferæ˜¯å·¥ä½œåŒºï¼Œinputæ˜¯å‡½æ•°çš„è¾“å…¥ã€‚è¿™ä¸ªå‡½æ•°å°±æ˜¯æ¯æ¬¡æ¥æ–°çš„è¾“å…¥å€¼æ—¶ï¼Œå‡½æ•°å†…éƒ¨å˜é‡çš„å˜åŒ–</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">update</span></span>(buffer: <span class="type">MutableAggregationBuffer</span>, input: <span class="type">Row</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    buffer(<span class="number">0</span>) = buffer.getLong(<span class="number">0</span>) + input.getLong(<span class="number">0</span>) <span class="comment">// sum</span></span><br><span class="line">    buffer(<span class="number">1</span>) = buffer.getLong(<span class="number">1</span>) + <span class="number">1</span> <span class="comment">// count</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤šä¸ªExecutoræ‰§è¡Œåï¼Œå½¢æˆå¤šä¸ªbuffer  æœ€ååˆå¹¶åˆ°ä¸€èµ·</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">merge</span></span>(buffer1: <span class="type">MutableAggregationBuffer</span>, buffer2: <span class="type">Row</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    buffer1(<span class="number">0</span>) = buffer1.getLong(<span class="number">0</span>) + buffer2.getLong(<span class="number">0</span>)</span><br><span class="line">    buffer1(<span class="number">1</span>) = buffer1.getLong(<span class="number">1</span>) + buffer2.getLong(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æœ€åçš„ç»“æœ</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">evaluate</span></span>(buffer: <span class="type">Row</span>): <span class="type">Any</span> = &#123;</span><br><span class="line">    buffer.getLong(<span class="number">0</span>).toDouble / buffer.getLong(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Aggregator[-IN, BUF, OUT]</span></span><br><span class="line"><span class="comment">// æ³›å‹åˆ†åˆ«ä¸ºè¾“å…¥ç±»å‹ï¼Œå¤„ç†ç±»å‹ï¼Œè¾“å‡ºç±»å‹ã€‚å› ä¸ºå¼ºç±»å‹æ‰€ä»¥éœ€è¦æŒ‡å®šç±»å‹ï¼Œè¿™æ ·å°±èƒ½ç›´æ¥é€šè¿‡å¯¹è±¡è®¿é—®åˆ°æ¯ä¸ªå€¼ï¼Œä¸æ˜¯é€šè¿‡ç´¢å¼•</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StrongAvg</span> <span class="keyword">extends</span> <span class="title">Aggregator</span>[person, dealwith, <span class="type">Double</span>] </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆå§‹å€¼ï¼Œå› ä¸ºè¿”å›dealwithï¼Œæ‰€ä»¥æ˜¯å¤„ç†é€»è¾‘ç±»çš„åˆå§‹åŒ–</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">zero</span></span>: dealwith = dealwith(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿™ä¸ªå‡½æ•°å°±æ˜¯æ¯æ¬¡æ¥æ–°çš„è¾“å…¥å€¼æ—¶ï¼Œå‡½æ•°å†…éƒ¨å˜é‡çš„å˜åŒ–</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">reduce</span></span>(b: dealwith, a: person): dealwith = &#123;</span><br><span class="line">    b.sum = b.sum + a.age</span><br><span class="line">    b.count = b.count + <span class="number">1</span></span><br><span class="line">    b</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤šä¸ªExecutoræ‰§è¡Œåï¼Œå½¢æˆå¤šä¸ªdealwith  æœ€ååˆå¹¶åˆ°ä¸€èµ·</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">merge</span></span>(b1: dealwith, b2: dealwith): dealwith = &#123;</span><br><span class="line">    b1.sum = b1.sum + b2.sum</span><br><span class="line">    b1.count = b1.count + b2.count</span><br><span class="line">    b1</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">finish</span></span>(reduction: dealwith): <span class="type">Double</span> = &#123;</span><br><span class="line">    reduction.sum.toDouble / reduction.count</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è½¬ç å¯¹è±¡è®¾ç½®ï¼Œå›ºå®šå¥—è·¯ï¼Œç¬¬ä¸‰æ–¹ä½¿ç”¨ Encoders.product!!!</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">bufferEncoder</span></span>: <span class="type">Encoder</span>[dealwith] = <span class="type">Encoders</span>.product</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è½¬ç å¯¹è±¡è®¾ç½®</span></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">outputEncoder</span></span>: <span class="type">Encoder</span>[<span class="type">Double</span>] = <span class="type">Encoders</span>.scalaDouble</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Spark-SQLæ•°æ®æº"><a href="#Spark-SQLæ•°æ®æº" class="headerlink" title="Spark SQLæ•°æ®æº"></a>Spark SQLæ•°æ®æº</h1><h2 id="é€šç”¨åŠ è½½-ä¿å­˜æ–¹æ³•"><a href="#é€šç”¨åŠ è½½-ä¿å­˜æ–¹æ³•" class="headerlink" title="é€šç”¨åŠ è½½/ä¿å­˜æ–¹æ³•"></a>é€šç”¨åŠ è½½/ä¿å­˜æ–¹æ³•</h2><h3 id="æ‰‹åŠ¨æŒ‡å®šé€‰é¡¹"><a href="#æ‰‹åŠ¨æŒ‡å®šé€‰é¡¹" class="headerlink" title="æ‰‹åŠ¨æŒ‡å®šé€‰é¡¹"></a>æ‰‹åŠ¨æŒ‡å®šé€‰é¡¹</h3><p>park SQLçš„DataFrameæ¥å£æ”¯æŒå¤šç§æ•°æ®æºçš„æ“ä½œã€‚ä¸€ä¸ªDataFrameå¯ä»¥è¿›è¡ŒRDDsæ–¹å¼çš„æ“ä½œï¼Œä¹Ÿå¯ä»¥è¢«æ³¨å†Œä¸ºä¸´æ—¶è¡¨ã€‚<strong>æŠŠDataFrameæ³¨å†Œä¸ºä¸´æ—¶è¡¨ä¹‹åï¼Œå°±å¯ä»¥å¯¹è¯¥DataFrameæ‰§è¡ŒSQLæŸ¥è¯¢ã€‚</strong>\</p><p>Spark SQLçš„<font color="red"><strong>é»˜è®¤æ•°æ®æºä¸ºParquetæ ¼å¼</strong></font>ã€‚æ•°æ®æºä¸ºParquetæ–‡ä»¶æ—¶ï¼ŒSpark SQLå¯ä»¥æ–¹ä¾¿çš„æ‰§è¡Œæ‰€æœ‰çš„æ“ä½œã€‚ä¿®æ”¹é…ç½®é¡¹<code>spark.sql.sources.default</code>ï¼Œå¯ä¿®æ”¹é»˜è®¤æ•°æ®æºæ ¼å¼ã€‚</p><p><font color="red">å½“æ•°æ®æºæ ¼å¼ä¸æ˜¯<code>parquet</code>æ ¼å¼æ–‡ä»¶æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨æŒ‡å®šæ•°æ®æºçš„æ ¼å¼</font>ã€‚æ•°æ®æºæ ¼å¼éœ€è¦æŒ‡å®šå…¨åï¼ˆä¾‹å¦‚ï¼šorg.apache.spark.sql.parquetï¼‰ï¼Œå¦‚æœæ•°æ®æºæ ¼å¼ä¸ºå†…ç½®æ ¼å¼ï¼Œåˆ™åªéœ€è¦æŒ‡å®šç®€ç§°å®šjson, parquet, jdbc, orc, libsvm, csv, textæ¥æŒ‡å®šæ•°æ®çš„æ ¼å¼ã€‚</p><p><strong>ä¸¤ç§æ–¹å¼ï¼š</strong></p><ol><li>å¯ä»¥é€šè¿‡SparkSessionæä¾›çš„read.loadæ–¹æ³•ç”¨äºé€šç”¨åŠ è½½æ•°æ®ï¼Œä½¿ç”¨writeå’Œsaveä¿å­˜æ•°æ®</li><li>read.xxx()</li></ol><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//    spark.read.csv()</span></span><br><span class="line"><span class="comment">//    spark.read.json()</span></span><br><span class="line">    </span><br><span class="line">    spark.read.format(<span class="string">&quot;csv&quot;</span>).load()</span><br><span class="line">    spark.read.format(<span class="string">&quot;json&quot;</span>).load()</span><br></pre></td></tr></table></figure><h3 id="æ–‡ä»¶ä¿å­˜é€‰é¡¹"><a href="#æ–‡ä»¶ä¿å­˜é€‰é¡¹" class="headerlink" title="æ–‡ä»¶ä¿å­˜é€‰é¡¹"></a>æ–‡ä»¶ä¿å­˜é€‰é¡¹</h3><p>å¯ä»¥é‡‡ç”¨<code>SaveMode</code>æ‰§è¡Œå­˜å‚¨æ“ä½œï¼Œ<code>SaveMode</code>å®šä¹‰äº†å¯¹æ•°æ®çš„å¤„ç†æ¨¡å¼ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™äº›ä¿å­˜æ¨¡å¼ä¸ä½¿ç”¨ä»»ä½•é”å®šï¼Œä¸æ˜¯åŸå­æ“ä½œã€‚æ­¤å¤–ï¼Œå½“ä½¿ç”¨<code>Overwrite</code>æ–¹å¼æ‰§è¡Œæ—¶ï¼Œåœ¨è¾“å‡ºæ–°æ•°æ®ä¹‹å‰åŸæ•°æ®å°±å·²ç»è¢«åˆ é™¤ã€‚SaveModeè¯¦ç»†ä»‹ç»å¦‚ä¸‹è¡¨ï¼š</p><p><img src="https://zxj-typora.oss-cn-shanghai.aliyuncs.com/img/image-20200826201904989.png" alt="image-20200826201904989"></p><h2 id="JSONæ–‡ä»¶"><a href="#JSONæ–‡ä»¶" class="headerlink" title="JSONæ–‡ä»¶"></a>JSONæ–‡ä»¶</h2><p>Spark SQL èƒ½å¤Ÿè‡ªåŠ¨æ¨æµ‹ JSONæ•°æ®é›†çš„ç»“æ„ï¼Œå¹¶å°†å®ƒåŠ è½½ä¸ºä¸€ä¸ªDataset[Row]. å¯ä»¥é€šè¿‡SparkSession.read.json()å»åŠ è½½ä¸€ä¸ª ä¸€ä¸ªJSON æ–‡ä»¶ã€‚</p><p><font color="red"><strong>æ³¨æ„ï¼šè¿™ä¸ªJSONæ–‡ä»¶ä¸æ˜¯ä¸€ä¸ªä¼ ç»Ÿçš„JSONæ–‡ä»¶ï¼Œæ¯ä¸€è¡Œéƒ½å¾—æ˜¯ä¸€ä¸ªJSONä¸²ã€‚</strong></font></p><p><code>spark.read.format(&quot;json&quot;).load()</code></p><h2 id="Parquetæ–‡ä»¶"><a href="#Parquetæ–‡ä»¶" class="headerlink" title="Parquetæ–‡ä»¶"></a>Parquetæ–‡ä»¶</h2><p><code>Parquet</code>æ˜¯ä¸€ç§æµè¡Œçš„åˆ—å¼å­˜å‚¨æ ¼å¼ï¼Œå¯ä»¥é«˜æ•ˆåœ°å­˜å‚¨å…·æœ‰åµŒå¥—å­—æ®µçš„è®°å½•ã€‚Parquetæ ¼å¼ç»å¸¸åœ¨Hadoopç”Ÿæ€åœˆä¸­è¢«ä½¿ç”¨ï¼Œå®ƒä¹Ÿæ”¯æŒSpark SQLçš„å…¨éƒ¨æ•°æ®ç±»å‹ã€‚<font color="red">Spark SQL æä¾›äº†ç›´æ¥è¯»å–å’Œå­˜å‚¨ Parquet æ ¼å¼æ–‡ä»¶çš„æ–¹æ³•ã€‚ (é»˜è®¤)</font></p><p><code>spark.read.load(xxx)</code>ï¼Œä¸ç”¨æŒ‡å®šç±»å‹ï¼Œé»˜è®¤<code>Parquet</code></p><p><code>peopleDF.write.mode.parquet(&quot;hdfs://hadoop102:9000/people.parquet&quot;)</code></p><h2 id="JDBC"><a href="#JDBC" class="headerlink" title="JDBC"></a>JDBC</h2><p>Spark SQLå¯ä»¥é€šè¿‡JDBCä»å…³ç³»å‹æ•°æ®åº“ä¸­è¯»å–æ•°æ®çš„æ–¹å¼åˆ›å»ºDataFrameï¼Œé€šè¿‡å¯¹DataFrameä¸€ç³»åˆ—çš„è®¡ç®—åï¼Œè¿˜å¯ä»¥å°†æ•°æ®å†å†™å›å…³ç³»å‹æ•°æ®åº“ä¸­ã€‚</p><p><font color="red">æ³¨æ„:éœ€è¦å°†ç›¸å…³çš„æ•°æ®åº“é©±åŠ¨æ”¾åˆ°sparkçš„ç±»è·¯å¾„ä¸‹ã€‚å¦‚æœä½¿ç”¨Spark-Shellçš„è¯</font></p><h3 id="è¯»æ–¹å¼ä¸€"><a href="#è¯»æ–¹å¼ä¸€" class="headerlink" title="è¯»æ–¹å¼ä¸€"></a>è¯»æ–¹å¼ä¸€</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> jdbcDF = spark.read</span><br><span class="line">.format(<span class="string">&quot;jdbc&quot;</span>)</span><br><span class="line">.option(<span class="string">&quot;url&quot;</span>, <span class="string">&quot;jdbc:mysql://hadoop102:3306/rdd&quot;</span>)</span><br><span class="line">.option(<span class="string">&quot;dbtable&quot;</span>, <span class="string">&quot;rddtable&quot;</span>)</span><br><span class="line">.option(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;root&quot;</span>)</span><br><span class="line">.option(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;000000&quot;</span>)</span><br><span class="line">.load()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="è¯»æ–¹å¼äºŒ"><a href="#è¯»æ–¹å¼äºŒ" class="headerlink" title="è¯»æ–¹å¼äºŒ"></a>è¯»æ–¹å¼äºŒ</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> connectionProperties = <span class="keyword">new</span> <span class="type">Properties</span>()</span><br><span class="line">connectionProperties.put(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;root&quot;</span>)</span><br><span class="line">connectionProperties.put(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;000000&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> jdbcDF2 = spark.read.jdbc(<span class="string">&quot;jdbc:mysql://hadoop102:3306/rdd&quot;</span>, <span class="string">&quot;rddtable&quot;</span>,connectionProperties)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="å†™æ–¹å¼ä¸€"><a href="#å†™æ–¹å¼ä¸€" class="headerlink" title="å†™æ–¹å¼ä¸€"></a>å†™æ–¹å¼ä¸€</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">jdbcDF.write.mode(xxx)</span><br><span class="line">.format(<span class="string">&quot;jdbc&quot;</span>)</span><br><span class="line">.option(<span class="string">&quot;url&quot;</span>, <span class="string">&quot;jdbc:mysql://hadoop102:3306/rdd&quot;</span>)</span><br><span class="line">.option(<span class="string">&quot;dbtable&quot;</span>, <span class="string">&quot;dftable&quot;</span>)</span><br><span class="line">.option(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;root&quot;</span>)</span><br><span class="line">.option(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;000000&quot;</span>)</span><br><span class="line">.save()</span><br></pre></td></tr></table></figure><h3 id="å†™æ–¹å¼äºŒ"><a href="#å†™æ–¹å¼äºŒ" class="headerlink" title="å†™æ–¹å¼äºŒ"></a>å†™æ–¹å¼äºŒ</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbcDF2.write.jdbc(<span class="string">&quot;jdbc:mysql://hadoop102:3306/rdd&quot;</span>, <span class="string">&quot;db&quot;</span>, connectionProperties)</span><br></pre></td></tr></table></figure><h2 id="Hiveæ•°æ®ä»“åº“"><a href="#Hiveæ•°æ®ä»“åº“" class="headerlink" title="Hiveæ•°æ®ä»“åº“"></a>Hiveæ•°æ®ä»“åº“</h2><p>Apache Hiveæ˜¯Hadoopä¸Šçš„SQLå¼•æ“ï¼Œ<strong>Spark SQLç¼–è¯‘æ—¶å¯ä»¥åŒ…å«Hiveæ”¯æŒï¼Œä¹Ÿå¯ä»¥ä¸åŒ…å«</strong>ã€‚åŒ…å«Hiveæ”¯æŒçš„Spark SQLå¯ä»¥<strong>æ”¯æŒHiveè¡¨è®¿é—®ã€UDF(ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°)ä»¥åŠ Hive æŸ¥è¯¢è¯­è¨€(HiveQL/HQL)ç­‰</strong>ã€‚éœ€è¦å¼ºè°ƒçš„ä¸€ç‚¹æ˜¯ï¼Œå¦‚æœè¦åœ¨Spark SQLä¸­åŒ…å«Hiveçš„åº“ï¼Œå¹¶ä¸éœ€è¦äº‹å…ˆå®‰è£…Hiveã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæœ€å¥½è¿˜æ˜¯åœ¨ç¼–è¯‘Spark SQLæ—¶å¼•å…¥Hiveæ”¯æŒï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨è¿™äº›ç‰¹æ€§äº†ã€‚å¦‚æœä½ ä¸‹è½½çš„æ˜¯äºŒè¿›åˆ¶ç‰ˆæœ¬çš„ Sparkï¼Œå®ƒåº”è¯¥å·²ç»åœ¨ç¼–è¯‘æ—¶æ·»åŠ äº† Hive æ”¯æŒã€‚ </p><p><font color="red">è‹¥è¦æŠŠSpark SQLè¿æ¥åˆ°ä¸€ä¸ªéƒ¨ç½²å¥½çš„Hiveä¸Šï¼Œä½ å¿…é¡»æŠŠhive-site.xmlå¤åˆ¶åˆ° Sparkçš„é…ç½®æ–‡ä»¶ç›®å½•ä¸­($SPARK_HOME/conf)</font>ã€‚å³ä½¿æ²¡æœ‰éƒ¨ç½²å¥½Hiveï¼ŒSpark SQLä¹Ÿå¯ä»¥è¿è¡Œã€‚<font color="red"> éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä½ æ²¡æœ‰éƒ¨ç½²å¥½Hiveï¼ŒSpark SQLä¼šåœ¨å½“å‰çš„å·¥ä½œç›®å½•ä¸­åˆ›å»ºå‡ºè‡ªå·±çš„Hive å…ƒæ•°æ®ä»“åº“ï¼Œå«ä½œ metastore_dbã€‚</font>æ­¤å¤–ï¼Œå¦‚æœä½ å°è¯•ä½¿ç”¨ HiveQL ä¸­çš„ CREATE TABLE (å¹¶é CREATE EXTERNAL TABLE)è¯­å¥æ¥åˆ›å»ºè¡¨ï¼Œè¿™äº›è¡¨ä¼šè¢«æ”¾åœ¨ä½ é»˜è®¤çš„æ–‡ä»¶ç³»ç»Ÿä¸­çš„ /user/hive/warehouse ç›®å½•ä¸­(å¦‚æœä½ çš„ classpath ä¸­æœ‰é…å¥½çš„ hdfs-site.xmlï¼Œé»˜è®¤çš„æ–‡ä»¶ç³»ç»Ÿå°±æ˜¯ HDFSï¼Œå¦åˆ™å°±æ˜¯æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ)ã€‚</p><h3 id="å†…åµŒçš„Hiveåº”ç”¨"><a href="#å†…åµŒçš„Hiveåº”ç”¨" class="headerlink" title="å†…åµŒçš„Hiveåº”ç”¨"></a>å†…åµŒçš„Hiveåº”ç”¨</h3><p>å¦‚æœè¦ä½¿ç”¨å†…åµŒçš„Hiveï¼Œä»€ä¹ˆéƒ½ä¸ç”¨åšï¼Œç›´æ¥ç”¨å°±å¯ä»¥äº†ã€‚ </p><p>å¯ä»¥é€šè¿‡æ·»åŠ å‚æ•°åˆæ¬¡æŒ‡å®šæ•°æ®ä»“åº“åœ°å€ï¼šâ€“conf </p><p><font color="red"><strong>æ³¨æ„ï¼š</strong>å¦‚æœä½ ä½¿ç”¨çš„æ˜¯å†…éƒ¨çš„Hiveï¼Œåœ¨Spark2.0ä¹‹åï¼Œspark.sql.warehouse.dirç”¨äºæŒ‡å®šæ•°æ®ä»“åº“çš„åœ°å€ï¼Œå¦‚æœä½ éœ€è¦æ˜¯ç”¨HDFSä½œä¸ºè·¯å¾„ï¼Œé‚£ä¹ˆéœ€è¦å°†core-site.xmlå’Œhdfs-site.xml åŠ å…¥åˆ°Spark confç›®å½•ï¼Œå¦åˆ™åªä¼šåˆ›å»ºmasterèŠ‚ç‚¹ä¸Šçš„warehouseç›®å½•ï¼ŒæŸ¥è¯¢æ—¶ä¼šå‡ºç°æ–‡ä»¶æ‰¾ä¸åˆ°çš„é—®é¢˜ï¼Œè¿™æ˜¯éœ€è¦ä½¿ç”¨HDFSï¼Œåˆ™éœ€è¦å°†metastoreåˆ é™¤ï¼Œé‡å¯é›†ç¾¤ã€‚</font></p><h3 id="å¤–éƒ¨çš„Hiveåº”ç”¨"><a href="#å¤–éƒ¨çš„Hiveåº”ç”¨" class="headerlink" title="å¤–éƒ¨çš„Hiveåº”ç”¨"></a>å¤–éƒ¨çš„Hiveåº”ç”¨</h3><p>å¦‚æœæƒ³è¿æ¥å¤–éƒ¨å·²ç»éƒ¨ç½²å¥½çš„Hiveï¼Œéœ€è¦é€šè¿‡ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ã€‚</p><ol><li>å°†Hiveä¸­çš„hive-site.xmlæ‹·è´æˆ–è€…è½¯è¿æ¥åˆ°Sparkå®‰è£…ç›®å½•ä¸‹çš„confç›®å½•ä¸‹ã€‚</li><li>æ‰“å¼€spark shellï¼Œæ³¨æ„å¸¦ä¸Šè®¿é—®Hiveå…ƒæ•°æ®åº“çš„JDBCå®¢æˆ·ç«¯</li></ol><p><code>bin/spark-shell --jars mysql-connector-java-5.1.27-bin.jar</code></p><p>åˆæˆ–è€…å°†æ­¤jaråŒ…æ”¾å…¥sparkçš„ä¾èµ–ç›®å½•</p><h3 id="Spark-SQL-CLI"><a href="#Spark-SQL-CLI" class="headerlink" title="Spark SQL CLI"></a>Spark SQL CLI</h3><p>Spark SQL CLIå¯ä»¥å¾ˆæ–¹ä¾¿çš„åœ¨æœ¬åœ°è¿è¡ŒHiveå…ƒæ•°æ®æœåŠ¡ä»¥åŠä»å‘½ä»¤è¡Œæ‰§è¡ŒæŸ¥è¯¢ä»»åŠ¡ã€‚åœ¨Sparkç›®å½•ä¸‹æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å¯åŠ¨Spark SQL CLIï¼š</p><p><code>./bin/spark-sql</code></p><h3 id="ä»£ç ä¸­ä½¿ç”¨Hive"><a href="#ä»£ç ä¸­ä½¿ç”¨Hive" class="headerlink" title="ä»£ç ä¸­ä½¿ç”¨Hive"></a>ä»£ç ä¸­ä½¿ç”¨Hive</h3><p><strong>pom</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.spark/spark-hive --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-hive_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.hive/hive-exec --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hive<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hive-exec<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>åˆ›å»ºSparkSessionæ—¶éœ€è¦æ·»åŠ hiveæ”¯æŒ</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> warehouseLocation: <span class="type">String</span> = <span class="keyword">new</span> <span class="type">File</span>(<span class="string">&quot;spark-warehouse&quot;</span>).getAbsolutePath</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> spark = <span class="type">SparkSession</span></span><br><span class="line">.builder()</span><br><span class="line">.appName(<span class="string">&quot;Spark Hive Example&quot;</span>)</span><br><span class="line">.config(<span class="string">&quot;spark.sql.warehouse.dir&quot;</span>, warehouseLocation)</span><br><span class="line">.enableHiveSupport() <span class="comment">// æ·»åŠ hiveæ”¯æŒ</span></span><br><span class="line">.getOrCreate()</span><br></pre></td></tr></table></figure><p><font color="red"><strong>æ³¨æ„ï¼š</strong>è“è‰²éƒ¨åˆ†ä¸ºä½¿ç”¨å†…ç½®Hiveéœ€è¦æŒ‡å®šä¸€ä¸ªHiveä»“åº“åœ°å€ã€‚è‹¥ä½¿ç”¨çš„æ˜¯å¤–éƒ¨Hiveï¼Œåˆ™éœ€è¦<strong>å°†hive-site.xmlæ·»åŠ åˆ°ClassPathä¸‹</strong>ã€‚</font></p><p><font color="red"></font></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Spark-SQLæ¦‚è¿°&quot;&gt;&lt;a href=&quot;#Spark-SQLæ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;Spark SQLæ¦‚è¿°&quot;&gt;&lt;/a&gt;Spark SQLæ¦‚è¿°&lt;/h1&gt;&lt;h2 id=&quot;ä»€ä¹ˆæ˜¯Spark-SQL&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯Sp</summary>
      
    
    
    
    <category term="Spark" scheme="https://awslzhang.top/categories/Spark/"/>
    
    
    <category term="Spark" scheme="https://awslzhang.top/tags/Spark/"/>
    
  </entry>
  
</feed>
